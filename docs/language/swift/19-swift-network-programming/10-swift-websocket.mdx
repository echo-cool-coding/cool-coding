---
title: Swift WebSocket
description: "学习如何在 Swift 中使用 WebSocket 进行实时双向通信。本文将从基础概念讲起，逐步深入，并提供代码示例和实际应用场景。"
---

## 介绍

WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议。与传统的 HTTP 请求-响应模式不同，WebSocket 允许服务器和客户端之间进行实时、双向的数据传输。这使得 WebSocket 非常适合需要实时更新的应用场景，如聊天应用、实时游戏、股票行情等。

在 Swift 中，我们可以使用 `URLSessionWebSocketTask` 来处理 WebSocket 连接。本文将带你从零开始，学习如何在 Swift 中使用 WebSocket。

## 基础概念

### 什么是 WebSocket？

WebSocket 是一种网络协议，允许在客户端和服务器之间建立一个持久的连接。与 HTTP 不同，WebSocket 连接一旦建立，双方可以随时发送数据，而不需要等待请求-响应周期。

### WebSocket 的优势

- **实时性**：数据可以实时传输，无需等待客户端发起请求。
- **低延迟**：由于连接是持久的，减少了建立和关闭连接的开销。
- **双向通信**：服务器和客户端可以同时发送和接收数据。

## 在 Swift 中使用 WebSocket

### 创建 WebSocket 连接

在 Swift 中，我们可以使用 `URLSessionWebSocketTask` 来创建和管理 WebSocket 连接。以下是一个简单的示例：

```swift
import Foundation

let url = URL(string: "wss://example.com/socket")!
let webSocketTask = URLSession.shared.webSocketTask(with: url)
webSocketTask.resume()
```

### 发送消息

WebSocket 支持发送文本和二进制数据。以下是如何发送文本消息的示例：

```swift
let message = URLSessionWebSocketTask.Message.string("Hello, WebSocket!")
webSocketTask.send(message) { error in
    if let error = error {
        print("发送消息失败: \(error)")
    } else {
        print("消息发送成功")
    }
}
```

### 接收消息

接收消息是一个异步操作。我们可以使用 `receive` 方法来监听来自服务器的消息：

```swift
webSocketTask.receive { result in
    switch result {
    case .failure(let error):
        print("接收消息失败: \(error)")
    case .success(let message):
        switch message {
        case .string(let text):
            print("收到文本消息: \(text)")
        case .data(let data):
            print("收到二进制数据: \(data)")
        @unknown default:
            print("收到未知类型的消息")
        }
    }
}
```

### 关闭连接

当不再需要 WebSocket 连接时，可以调用 `cancel` 方法来关闭连接：

```swift
webSocketTask.cancel(with: .goingAway, reason: nil)
```

## 实际应用场景

### 实时聊天应用

WebSocket 非常适合用于实时聊天应用。以下是一个简单的聊天应用示例：

```swift
import Foundation

let url = URL(string: "wss://example.com/chat")!
let webSocketTask = URLSession.shared.webSocketTask(with: url)
webSocketTask.resume()

// 发送消息
func sendMessage(_ message: String) {
    let message = URLSessionWebSocketTask.Message.string(message)
    webSocketTask.send(message) { error in
        if let error = error {
            print("发送消息失败: \(error)")
        } else {
            print("消息发送成功")
        }
    }
}

// 接收消息
func receiveMessage() {
    webSocketTask.receive { result in
        switch result {
        case .failure(let error):
            print("接收消息失败: \(error)")
        case .success(let message):
            switch message {
            case .string(let text):
                print("收到消息: \(text)")
            case .data(let data):
                print("收到二进制数据: \(data)")
            @unknown default:
                print("收到未知类型的消息")
            }
            // 继续接收下一条消息
            self.receiveMessage()
        }
    }
}

// 启动消息接收
receiveMessage()

// 发送一条消息
sendMessage("Hello, WebSocket!")
```

### 实时股票行情

WebSocket 也可以用于实时股票行情应用。服务器可以实时推送股票价格变化，客户端可以立即更新显示。

```swift
import Foundation

let url = URL(string: "wss://example.com/stock")!
let webSocketTask = URLSession.shared.webSocketTask(with: url)
webSocketTask.resume()

// 接收股票价格更新
func receiveStockPrice() {
    webSocketTask.receive { result in
        switch result {
        case .failure(let error):
            print("接收股票价格失败: \(error)")
        case .success(let message):
            switch message {
            case .string(let text):
                print("收到股票价格更新: \(text)")
            case .data(let data):
                print("收到二进制数据: \(data)")
            @unknown default:
                print("收到未知类型的消息")
            }
            // 继续接收下一条消息
            self.receiveStockPrice()
        }
    }
}

// 启动股票价格接收
receiveStockPrice()
```

## 总结

WebSocket 是一种强大的协议，适用于需要实时、双向通信的应用场景。在 Swift 中，我们可以使用 `URLSessionWebSocketTask` 来轻松实现 WebSocket 连接。通过本文的学习，你应该已经掌握了如何在 Swift 中使用 WebSocket 进行实时通信。

## 附加资源与练习

- **练习**：尝试创建一个简单的聊天应用，使用 WebSocket 实现实时消息传输。
- **资源**：
  - [WebSocket 协议规范](https://tools.ietf.org/html/rfc6455)
  - [Apple 官方文档：URLSessionWebSocketTask](https://developer.apple.com/documentation/foundation/urlsessionwebsockettask)

:::tip
如果你在实现过程中遇到问题，可以参考 Apple 的官方文档或搜索相关的社区讨论。WebSocket 是一个广泛使用的技术，有很多资源可以帮助你解决问题。
:::