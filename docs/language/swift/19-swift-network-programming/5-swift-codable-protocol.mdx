---
title: Swift Codable协议
description: 了解Swift中的Codable协议，掌握如何将JSON数据与Swift对象相互转换。
---

# Swift Codable协议

在Swift中，`Codable`协议是一个强大的工具，用于将数据（如JSON）与Swift对象相互转换。它结合了`Encodable`和`Decodable`协议的功能，使得数据的序列化和反序列化变得非常简单。本文将带你深入了解`Codable`协议，并通过实际案例展示其应用。

## 什么是Codable协议？

`Codable`是Swift标准库中的一个协议，它实际上是`Encodable`和`Decodable`两个协议的组合。通过实现`Codable`，你可以轻松地将Swift对象编码为JSON、XML等格式，或者将JSON、XML等格式的数据解码为Swift对象。

- **Encodable**：用于将Swift对象编码为外部表示（如JSON）。
- **Decodable**：用于将外部表示（如JSON）解码为Swift对象。

## 基本用法

### 定义Codable结构体

假设我们有一个表示用户的结构体`User`，其中包含用户的姓名和年龄。我们可以通过实现`Codable`协议来使其支持编码和解码。

```swift
struct User: Codable {
    var name: String
    var age: Int
}
```

### 编码为JSON

要将`User`对象编码为JSON，我们可以使用`JSONEncoder`：

```swift
let user = User(name: "John Doe", age: 30)
let encoder = JSONEncoder()
encoder.outputFormatting = .prettyPrinted

if let jsonData = try? encoder.encode(user) {
    if let jsonString = String(data: jsonData, encoding: .utf8) {
        print(jsonString)
    }
}
```

**输出：**
```json
{
  "name" : "John Doe",
  "age" : 30
}
```

### 解码为Swift对象

要将JSON数据解码为`User`对象，我们可以使用`JSONDecoder`：

```swift
let jsonString = """
{
  "name" : "Jane Doe",
  "age" : 25
}
"""

if let jsonData = jsonString.data(using: .utf8) {
    let decoder = JSONDecoder()
    if let user = try? decoder.decode(User.self, from: jsonData) {
        print(user)
    }
}
```

**输出：**
```swift
User(name: "Jane Doe", age: 25)
```

## 处理嵌套对象

在实际应用中，数据通常是嵌套的。`Codable`协议同样支持嵌套对象的编码和解码。

### 定义嵌套结构体

假设我们有一个`Post`结构体，其中包含一个`User`对象：

```swift
struct Post: Codable {
    var title: String
    var content: String
    var author: User
}
```

### 编码和解码嵌套对象

```swift
let post = Post(title: Hello, World!, content: "This is a test post.", author: User(name: "John Doe", age: 30))

// 编码
if let jsonData = try? encoder.encode(post) {
    if let jsonString = String(data: jsonData, encoding: .utf8) {
        print(jsonString)
    }
}

// 解码
let jsonString = """
{
  "title" : "Hello, World!",
  "content" : "This is a test post.",
  "author" : {
    "name" : "John Doe",
    "age" : 30
  }
}
"""

if let jsonData = jsonString.data(using: .utf8) {
    if let post = try? decoder.decode(Post.self, from: jsonData) {
        print(post)
    }
}
```

**输出：**
```json
{
  "title" : "Hello, World!",
  "content" : "This is a test post.",
  "author" : {
    "name" : "John Doe",
    "age" : 30
  }
}
```

```swift
Post(title: Hello, World!, content: "This is a test post.", author: User(name: "John Doe", age: 30))
```

## 自定义编码和解码

有时，JSON数据的键名与Swift属性名不一致，或者我们需要对数据进行一些特殊处理。这时，我们可以通过自定义编码和解码过程来实现。

### 自定义键名

假设JSON数据中的键名与Swift属性名不一致，我们可以通过实现`CodingKeys`枚举来指定映射关系：

```swift
struct User: Codable {
    var name: String
    var age: Int

    enum CodingKeys: String, CodingKey {
        case name = "user_name"
        case age = "user_age"
    }
}
```

### 自定义编码和解码逻辑

如果需要对数据进行特殊处理，我们可以实现`encode(to:)`和`init(from:)`方法：

```swift
struct User: Codable {
    var name: String
    var age: Int

    enum CodingKeys: String, CodingKey {
        case name
        case age
    }

    func encode(to encoder: Encoder) throws {
        var container = encoder.container(keyedBy: CodingKeys.self)
        try container.encode(name.uppercased(), forKey: .name)
        try container.encode(age, forKey: .age)
    }

    init(from decoder: Decoder) throws {
        let container = try decoder.container(keyedBy: CodingKeys.self)
        name = try container.decode(String.self, forKey: .name)
        age = try container.decode(Int.self, forKey: .age)
    }
}
```

## 实际应用场景

`Codable`协议在实际开发中非常有用，特别是在处理网络请求和响应时。以下是一个常见的应用场景：

### 从API获取数据并解码

假设我们有一个API，返回用户信息的JSON数据。我们可以使用`Codable`协议将JSON数据解码为Swift对象：

```swift
struct User: Codable {
    var id: Int
    var name: String
    var email: String
}

func fetchUser(from url: URL, completion: @escaping (User?) -> Void) {
    URLSession.shared.dataTask(with: url) { data, response, error in
        if let data = data {
            let decoder = JSONDecoder()
            if let user = try? decoder.decode(User.self, from: data) {
                completion(user)
            } else {
                completion(nil)
            }
        } else {
            completion(nil)
        }
    }.resume()
}
```

## 总结

`Codable`协议是Swift中处理数据编码和解码的强大工具。通过实现`Codable`，你可以轻松地将Swift对象与JSON等格式相互转换。本文介绍了`Codable`的基本用法、处理嵌套对象、自定义编码和解码逻辑，以及实际应用场景。

:::tip
**练习：**
1. 创建一个包含多个嵌套对象的复杂结构体，并尝试将其编码为JSON。
2. 从API获取数据并解码为Swift对象，处理可能的错误情况。
:::

:::note
**附加资源：**
- [Swift官方文档 - Codable](https://developer.apple.com/documentation/swift/codable)
- [Swift编码和解码指南](https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types)
:::