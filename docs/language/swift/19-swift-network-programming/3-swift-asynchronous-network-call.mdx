---
title: Swift 异步网络调用
description: 学习如何在Swift中进行异步网络调用，掌握异步编程的核心概念和实际应用。
---

# Swift 异步网络调用

在现代移动应用开发中，网络请求是一个不可或缺的部分。为了确保应用的用户体验流畅，网络请求通常需要异步执行，以避免阻塞主线程。Swift提供了多种方式来实现异步网络调用，本文将详细介绍这些方法，并通过实际案例帮助你理解如何在实际项目中应用它们。

## 什么是异步网络调用？

异步网络调用是指在后台线程中执行网络请求，而不会阻塞主线程。这样，应用的用户界面可以保持响应，同时网络请求在后台进行。当请求完成时，结果会被返回到主线程，以便更新UI或处理数据。

## 使用URLSession进行异步网络调用

Swift中最常用的网络请求工具是`URLSession`。它提供了一个简单而强大的API来执行异步网络请求。

### 基本用法

以下是一个使用`URLSession`进行异步网络调用的基本示例：

```swift
import Foundation

func fetchData(from urlString: String, completion: @escaping (Data?, URLResponse?, Error?) -> Void) {
    guard let url = URL(string: urlString) else {
        print("Invalid URL")
        return
    }
    
    let task = URLSession.shared.dataTask(with: url) { data, response, error in
        completion(data, response, error)
    }
    
    task.resume()
}

// 使用示例
fetchData(from: "https://api.example.com/data") { data, response, error in
    if let error = error {
        print("Error: \(error)")
        return
    }
    
    if let data = data {
        print("Data received: \(data)")
    }
}
```

在这个示例中，`fetchData`函数接受一个URL字符串和一个完成处理程序（completion handler）。`URLSession.shared.dataTask(with:)`方法创建了一个网络任务，并在后台线程中执行。当任务完成时，结果会通过完成处理程序返回。

### 处理JSON数据

通常，网络请求返回的数据是JSON格式的。我们可以使用`JSONSerialization`或`Codable`来解析这些数据。

```swift
struct Post: Codable {
    let userId: Int
    let id: Int
    let title: String
    let body: String
}

func fetchPosts(completion: @escaping ([Post]?) -> Void) {
    fetchData(from: "https://jsonplaceholder.typicode.com/posts") { data, response, error in
        if let error = error {
            print("Error: \(error)")
            completion(nil)
            return
        }
        
        if let data = data {
            do {
                let posts = try JSONDecoder().decode([Post].self, from: data)
                completion(posts)
            } catch {
                print("Failed to decode JSON: \(error)")
                completion(nil)
            }
        }
    }
}

// 使用示例
fetchPosts { posts in
    if let posts = posts {
        print("Fetched posts: \(posts)")
    }
}
```

在这个示例中，我们定义了一个`Post`结构体，并使用`Codable`协议来解析JSON数据。`fetchPosts`函数调用`fetchData`来获取数据，并在完成处理程序中解析JSON。

## 使用async/await进行异步网络调用

在Swift 5.5中，引入了`async/await`语法，使得异步编程更加简洁和易读。

### 基本用法

以下是一个使用`async/await`进行异步网络调用的示例：

```swift
func fetchDataAsync(from urlString: String) async throws -> Data {
    guard let url = URL(string: urlString) else {
        throw URLError(.badURL)
    }
    
    let (data, _) = try await URLSession.shared.data(from: url)
    return data
}

// 使用示例
Task {
    do {
        let data = try await fetchDataAsync(from: "https://api.example.com/data")
        print("Data received: \(data)")
    } catch {
        print("Error: \(error)")
    }
}
```

在这个示例中，`fetchDataAsync`函数使用`async`关键字标记为异步函数，并使用`await`关键字来等待网络请求的结果。`Task`用于在异步上下文中调用异步函数。

### 处理JSON数据

同样，我们可以使用`async/await`来解析JSON数据：

```swift
func fetchPostsAsync() async throws -> [Post] {
    let data = try await fetchDataAsync(from: "https://jsonplaceholder.typicode.com/posts")
    return try JSONDecoder().decode([Post].self, from: data)
}

// 使用示例
Task {
    do {
        let posts = try await fetchPostsAsync()
        print("Fetched posts: \(posts)")
    } catch {
        print("Error: \(error)")
    }
}
```

这个示例与之前的`fetchPosts`函数类似，但使用了`async/await`语法，使得代码更加简洁和易读。

## 实际应用场景

异步网络调用在实际应用中有广泛的应用场景，例如：

- **获取远程数据**：从服务器获取用户信息、新闻、商品列表等。
- **提交表单数据**：将用户输入的数据发送到服务器进行处理。
- **文件上传和下载**：异步上传或下载文件，避免阻塞主线程。

### 示例：获取天气数据

假设我们正在开发一个天气应用，需要从远程API获取天气数据。我们可以使用异步网络调用来实现这一功能。

```swift
struct Weather: Codable {
    let temperature: Double
    let description: String
}

func fetchWeatherAsync(city: String) async throws -> Weather {
    let urlString = "https://api.weatherapi.com/v1/current.json?key=YOUR_API_KEY&q=\(city)"
    let data = try await fetchDataAsync(from: urlString)
    return try JSONDecoder().decode(Weather.self, from: data)
}

// 使用示例
Task {
    do {
        let weather = try await fetchWeatherAsync(city: "Beijing")
        print("Current weather in Beijing: \(weather)")
    } catch {
        print("Error: \(error)")
    }
}
```

在这个示例中，我们定义了一个`Weather`结构体，并使用异步网络调用来获取指定城市的天气数据。

## 总结

异步网络调用是现代应用开发中的核心技能之一。通过使用`URLSession`和`async/await`，我们可以在Swift中轻松实现异步网络请求，确保应用的用户界面保持流畅和响应。

### 附加资源

- [Swift官方文档 - URLSession](https://developer.apple.com/documentation/foundation/urlsession)
- [Swift官方文档 - async/await](https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html)
- [JSONPlaceholder - 免费的在线REST API](https://jsonplaceholder.typicode.com/)

### 练习

1. 修改`fetchPosts`函数，使其能够处理分页数据。
2. 尝试使用`async/await`实现一个文件下载功能。
3. 创建一个简单的天气应用，使用异步网络调用来获取并显示天气数据。

通过这些练习，你将更深入地理解Swift中的异步网络调用，并能够在实际项目中应用这些知识。