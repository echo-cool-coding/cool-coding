---
title: Swift 并发基础
description: 了解Swift中的并发编程基础，包括异步任务、任务组和结构化并发等核心概念，帮助初学者掌握现代Swift并发编程的核心思想。
---

# Swift 并发基础

在现代编程中，并发（Concurrency）是一个非常重要的概念。它允许我们同时执行多个任务，从而提高程序的效率和响应性。Swift 5.5 引入了全新的并发模型，使得编写并发代码变得更加简单和安全。本文将带你了解 Swift 并发编程的基础知识，并通过示例代码帮助你理解这些概念。

## 什么是并发？

并发是指在同一时间段内执行多个任务的能力。这些任务可以是同时运行的（并行），也可以是交替运行的（时间片轮转）。Swift 的并发模型基于 **异步任务** 和 **结构化并发**，旨在简化并发代码的编写，同时避免常见的并发问题，如数据竞争和死锁。

## 异步任务

在 Swift 中，异步任务通过 `async` 和 `await` 关键字来实现。`async` 用于标记一个函数是异步的，而 `await` 用于等待异步函数的执行结果。

### 示例：简单的异步函数

```swift
func fetchData() async -> String {
    // 模拟网络请求
    await Task.sleep(2_000_000_000) // 等待2秒
    return "数据加载完成"
}

func processData() async {
    let data = await fetchData()
    print(data)
}

Task {
    await processData()
}
```

**输出：**
```
数据加载完成
```

在这个例子中，`fetchData` 是一个异步函数，它模拟了一个网络请求，并在 2 秒后返回结果。`processData` 函数通过 `await` 关键字等待 `fetchData` 的结果，然后打印出来。

:::note
`Task.sleep` 是一个用于模拟延迟的异步函数，它的参数是以纳秒为单位的时间。
:::

## 结构化并发

结构化并发是 Swift 并发模型的核心思想之一。它通过将并发任务组织成层次结构，确保所有任务都能正确完成或被取消。Swift 提供了 `Task` 和 `TaskGroup` 来实现结构化并发。

### 示例：使用 `TaskGroup` 并发执行任务

```swift
func fetchMultipleData() async {
    let urls = [
        "https://example.com/data1",
        "https://example.com/data2",
        "https://example.com/data3"
    ]
    
    await withTaskGroup(of: String.self) { group in
        for url in urls {
            group.addTask {
                // 模拟从不同URL获取数据
                await Task.sleep(1_000_000_000) // 等待1秒
                return "数据来自 \(url)"
            }
        }
        
        for await result in group {
            print(result)
        }
    }
}

Task {
    await fetchMultipleData()
}
```

**输出：**
```
数据来自 https://example.com/data1
数据来自 https://example.com/data2
数据来自 https://example.com/data3
```

在这个例子中，`withTaskGroup` 创建了一个任务组，并发地从多个 URL 获取数据。每个任务都会在 1 秒后返回结果，任务组会等待所有任务完成并打印结果。

:::tip
使用 `TaskGroup` 可以轻松地并发执行多个任务，并确保它们都能正确完成。
:::

## 实际应用场景

### 场景：并发下载图片

假设你正在开发一个图片浏览应用，需要从多个 URL 并发下载图片。使用 Swift 的并发模型，你可以轻松实现这一功能。

```swift
func downloadImage(from url: String) async -> Data {
    // 模拟下载图片
    await Task.sleep(1_000_000_000) // 等待1秒
    return Data() // 返回图片数据
}

func downloadImages() async {
    let imageURLs = [
        "https://example.com/image1",
        "https://example.com/image2",
        "https://example.com/image3"
    ]
    
    await withTaskGroup(of: Data.self) { group in
        for url in imageURLs {
            group.addTask {
                await downloadImage(from: url)
            }
        }
        
        for await imageData in group {
            print("图片下载完成，大小为 \(imageData.count) 字节")
        }
    }
}

Task {
    await downloadImages()
}
```

**输出：**
```
图片下载完成，大小为 0 字节
图片下载完成，大小为 0 字节
图片下载完成，大小为 0 字节
```

在这个场景中，`downloadImages` 函数并发地从多个 URL 下载图片，并在所有图片下载完成后打印它们的大小。

## 总结

Swift 的并发编程模型通过 `async`、`await`、`Task` 和 `TaskGroup` 等关键字和工具，使得编写并发代码变得更加简单和安全。通过结构化并发，你可以轻松地组织和管理并发任务，避免常见的并发问题。

### 附加资源

- [Swift 官方文档 - 并发](https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html)
- [Swift 并发编程指南](https://developer.apple.com/videos/play/wwdc2021/10132/)

### 练习

1. 修改 `fetchMultipleData` 函数，使其在获取数据后对数据进行处理（例如，将数据转换为大写）。
2. 尝试使用 `TaskGroup` 实现一个并发计算斐波那契数列的程序。

通过本文的学习，你应该已经掌握了 Swift 并发编程的基础知识。继续练习和探索，你将能够编写更复杂的并发程序！