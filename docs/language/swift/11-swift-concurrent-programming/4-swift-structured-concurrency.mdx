---
title: Swift 结构化并发
description: 了解Swift中的结构化并发，掌握如何使用async/await和Task来编写高效且易于维护的并发代码。
---

# Swift 结构化并发

在现代编程中，并发是提高应用程序性能的关键技术之一。Swift 5.5引入了结构化并发（Structured Concurrency），这是一种新的并发模型，旨在简化并发代码的编写和管理。结构化并发通过提供一种清晰、安全的方式来处理并发任务，使得开发者能够更容易地编写高效且易于维护的代码。

## 什么是结构化并发？

结构化并发是一种编程范式，它通过将并发任务组织成层次结构来管理并发操作。与传统的并发模型（如线程和回调）不同，结构化并发通过使用`async/await`和`Task`等关键字，使得并发代码的编写更加直观和易于理解。

### 为什么需要结构化并发？

在传统的并发模型中，开发者需要手动管理线程、锁和回调，这往往会导致代码复杂且难以维护。结构化并发通过引入`async/await`和`Task`，使得并发代码的编写更加直观和易于理解。此外，结构化并发还提供了更好的错误处理和任务取消机制，使得并发代码更加健壮。

## `async/await` 基础

`async/await` 是 Swift 5.5 引入的关键字，用于简化异步代码的编写。`async` 关键字用于标记一个函数为异步函数，而 `await` 关键字用于等待异步函数的执行结果。

### 示例：简单的异步函数

```swift
func fetchData() async -> String {
    // 模拟网络请求
    await Task.sleep(2 * 1_000_000_000) // 等待2秒
    return "Data fetched"
}

func processData() async {
    let data = await fetchData()
    print(data)
}
```

在这个示例中，`fetchData` 是一个异步函数，它模拟了一个网络请求并返回一个字符串。`processData` 函数通过 `await` 关键字等待 `fetchData` 的执行结果，然后打印出返回的数据。

## `Task` 和任务层次结构

`Task` 是 Swift 中用于表示并发任务的基本单位。每个 `Task` 都可以包含子任务，从而形成一个任务层次结构。这种层次结构使得任务的取消和错误处理更加容易。

### 示例：创建任务

```swift
func performTask() async {
    let task = Task {
        await fetchData()
    }
    
    let result = await task.value
    print(result)
}
```

在这个示例中，我们创建了一个 `Task` 来执行 `fetchData` 函数。通过 `task.value`，我们可以获取任务的执行结果。

### 任务取消

结构化并发还提供了任务取消机制。通过调用 `Task.cancel()`，我们可以取消一个正在执行的任务。

```swift
func performTask() async {
    let task = Task {
        await fetchData()
    }
    
    task.cancel()
    
    do {
        let result = try await task.value
        print(result)
    } catch {
        print("Task was cancelled")
    }
}
```

在这个示例中，我们创建了一个任务并立即取消了它。由于任务被取消，`task.value` 会抛出一个错误。

## 实际应用场景

结构化并发在实际应用中有许多用途，例如：

1. **网络请求**：通过 `async/await`，我们可以轻松地编写异步网络请求代码，而不需要手动管理回调。
2. **文件操作**：异步文件读取和写入操作可以通过结构化并发来简化。
3. **并发数据处理**：在处理大量数据时，结构化并发可以帮助我们并行化数据处理任务，从而提高性能。

### 示例：并发数据处理

```swift
func processLargeData() async {
    let data = await fetchData()
    
    let task1 = Task {
        // 处理数据的一部分
    }
    
    let task2 = Task {
        // 处理数据的另一部分
    }
    
    await task1.value
    await task2.value
    
    print("Data processing completed")
}
```

在这个示例中，我们创建了两个任务来并行处理数据的不同部分。通过 `await` 关键字，我们等待这两个任务的完成。

## 总结

Swift 的结构化并发通过 `async/await` 和 `Task` 提供了一种清晰、安全的方式来编写并发代码。它不仅简化了并发代码的编写，还提供了更好的错误处理和任务取消机制。通过掌握结构化并发，你可以编写出更加高效且易于维护的并发代码。

## 附加资源

- [Swift官方文档 - 并发](https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html)
- [WWDC 2021 - Meet async/await in Swift](https://developer.apple.com/videos/play/wwdc2021/10132/)
- [Swift Concurrency by Example](https://www.hackingwithswift.com/quick-start/concurrency)

## 练习

1. 编写一个异步函数，模拟从多个URL并发下载数据。
2. 使用 `Task` 和 `async/await` 实现一个并发数据处理任务，并处理任务取消的情况。
3. 尝试在一个实际项目中使用结构化并发来优化性能。

通过完成这些练习，你将更好地理解并掌握 Swift 中的结构化并发。