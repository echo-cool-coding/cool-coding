---
title: Swift Core Data 迁移
description: 了解如何在 Swift 中使用 Core Data 进行数据模型迁移，确保应用程序在更新时能够正确处理数据变化。
---

# Swift Core Data 迁移

在开发 iOS 应用程序时，Core Data 是一个强大的工具，用于管理应用程序的数据模型和持久化存储。然而，随着应用程序的迭代，数据模型可能会发生变化。为了确保应用程序在更新时能够正确处理这些变化，我们需要进行 **Core Data 迁移**。本文将详细介绍 Core Data 迁移的概念、步骤以及如何在 Swift 中实现它。

## 什么是 Core Data 迁移？

Core Data 迁移是指在应用程序的数据模型发生变化时，将现有的数据存储迁移到新的数据模型的过程。这种变化可能包括添加、删除或修改实体、属性或关系。如果不进行迁移，应用程序在尝试加载与旧数据模型不兼容的新数据模型时可能会崩溃。

Core Data 提供了两种主要的迁移方式：
1. **轻量级迁移（Lightweight Migration）**：适用于简单的数据模型变化，Core Data 可以自动处理。
2. **手动迁移（Manual Migration）**：适用于复杂的数据模型变化，需要开发者编写自定义迁移逻辑。

## 轻量级迁移

轻量级迁移是 Core Data 中最简单的迁移方式，适用于以下情况：
- 添加新的实体或属性。
- 删除实体或属性。
- 重命名实体或属性。
- 修改属性的可选性。

### 实现轻量级迁移

要在 Swift 中实现轻量级迁移，我们需要在初始化 `NSPersistentContainer` 时设置一些选项。以下是一个示例：

```swift
let container = NSPersistentContainer(name: "MyDataModel")

container.loadPersistentStores { (storeDescription, error) in
    if let error = error as NSError? {
        fatalError("Unresolved error \(error), \(error.userInfo)")
    }
}

// 设置轻量级迁移选项
let options = [NSMigratePersistentStoresAutomaticallyOption: true,
               NSInferMappingModelAutomaticallyOption: true]

container.persistentStoreDescriptions.first?.options = options
```

在这个示例中，`NSMigratePersistentStoresAutomaticallyOption` 和 `NSInferMappingModelAutomaticallyOption` 选项被设置为 `true`，这告诉 Core Data 自动处理轻量级迁移。

## 手动迁移

当数据模型的变化较为复杂时，轻量级迁移可能无法满足需求。这时，我们需要进行手动迁移。手动迁移通常涉及以下步骤：
1. 创建新的数据模型版本。
2. 创建一个映射模型（Mapping Model），用于描述如何将旧数据模型映射到新数据模型。
3. 编写自定义迁移逻辑。

### 创建新的数据模型版本

首先，我们需要在 Xcode 中创建一个新的数据模型版本。右键点击现有的 `.xcdatamodeld` 文件，选择 **Add Model Version**，然后为新版本命名。

### 创建映射模型

接下来，我们需要创建一个映射模型。在 Xcode 中，选择 **File > New > File**，然后选择 **Mapping Model**。选择旧的数据模型版本作为源，新的数据模型版本作为目标。

### 编写自定义迁移逻辑

最后，我们需要编写自定义迁移逻辑。以下是一个简单的示例，展示了如何使用 `NSMigrationManager` 进行手动迁移：

```swift
let sourceURL = Bundle.main.url(forResource: "MyDataModel", withExtension: "momd")!
let destinationURL = Bundle.main.url(forResource: "MyDataModel_v2", withExtension: "momd")!

let sourceModel = NSManagedObjectModel(contentsOf: sourceURL)!
let destinationModel = NSManagedObjectModel(contentsOf: destinationURL)!

let mappingModel = NSMappingModel(from: [Bundle.main], forSourceModel: sourceModel, destinationModel: destinationModel)!

let migrationManager = NSMigrationManager(sourceModel: sourceModel, destinationModel: destinationModel)

do {
    try migrationManager.migrateStore(from: sourceURL, sourceType: NSSQLiteStoreType, options: nil, with: mappingModel, toDestinationURL: destinationURL, destinationType: NSSQLiteStoreType, destinationOptions: nil)
} catch {
    print("Migration failed: \(error)")
}
```

在这个示例中，我们首先加载了源和目标数据模型，然后创建了一个映射模型。最后，我们使用 `NSMigrationManager` 执行迁移。

## 实际案例

假设我们有一个应用程序，用于管理用户的待办事项。最初的数据模型包含一个 `Task` 实体，具有 `title` 和 `dueDate` 属性。随着应用程序的迭代，我们决定添加一个新的 `priority` 属性。

### 轻量级迁移案例

在这种情况下，我们可以使用轻量级迁移。只需在 Xcode 中添加 `priority` 属性，并确保在初始化 `NSPersistentContainer` 时启用了自动迁移选项。

### 手动迁移案例

如果我们需要将 `dueDate` 属性从 `Date` 类型更改为 `String` 类型，轻量级迁移将无法处理这种变化。这时，我们需要进行手动迁移，创建一个映射模型，并编写自定义迁移逻辑来转换 `dueDate` 的数据类型。

## 总结

Core Data 迁移是确保应用程序在数据模型变化时能够正确处理数据的关键步骤。轻量级迁移适用于简单的变化，而手动迁移则适用于复杂的变化。通过理解这两种迁移方式，开发者可以确保应用程序在迭代过程中保持数据的完整性和一致性。

## 附加资源

- [Apple 官方文档：Core Data Model Versioning and Data Migration](https://developer.apple.com/documentation/coredata/model_versioning_and_data_migration)
- [Ray Wenderlich：Core Data by Tutorials](https://www.raywenderlich.com/books/core-data-by-tutorials)

## 练习

1. 尝试在现有的 Core Data 项目中添加一个新的实体，并使用轻量级迁移进行数据迁移。
2. 创建一个新的数据模型版本，并尝试使用手动迁移将一个属性从 `Int` 类型更改为 `String` 类型。