---
title: Swift SQLite 使用
description: 学习如何在 Swift 中使用 SQLite 进行数据持久化。本文将从基础概念讲起，逐步引导你掌握 SQLite 的使用方法，并提供实际案例和代码示例。
---

# Swift SQLite 使用

在现代移动应用开发中，数据持久化是一个至关重要的部分。SQLite 是一个轻量级的嵌入式数据库引擎，广泛用于移动应用开发中。它不需要单独的服务器进程，而是将数据库存储在一个文件中，非常适合移动设备的存储需求。本文将介绍如何在 Swift 中使用 SQLite 进行数据持久化。

## 什么是 SQLite？

SQLite 是一个自包含、无服务器、零配置的 SQL 数据库引擎。它被设计为嵌入式数据库，适用于移动应用、桌面应用和小型设备。SQLite 数据库存储在一个单一的文件中，这使得它非常易于管理和移植。

## 在 Swift 中使用 SQLite

要在 Swift 中使用 SQLite，我们需要使用 SQLite 的 C API。Swift 提供了与 C 语言的良好互操作性，因此我们可以直接使用 SQLite 的 C API 来操作数据库。

### 1. 导入 SQLite3 库

首先，我们需要在项目中导入 SQLite3 库。在 Swift 中，可以通过以下方式导入：

```swift
import SQLite3
```

### 2. 打开数据库

在使用 SQLite 之前，我们需要打开一个数据库连接。如果数据库文件不存在，SQLite 会自动创建一个新的数据库文件。

```swift
var db: OpaquePointer?
let fileURL = try! FileManager.default.url(for: .documentDirectory, in: .userDomainMask, appropriateFor: nil, create: false).appendingPathComponent("mydatabase.sqlite")

if sqlite3_open(fileURL.path, &db) == SQLITE_OK {
    print("成功打开数据库")
} else {
    print("无法打开数据库")
}
```

### 3. 创建表

接下来，我们可以创建一个表来存储数据。以下是一个创建用户表的示例：

```swift
let createTableString = """
CREATE TABLE IF NOT EXISTS Users(
    Id INT PRIMARY KEY NOT NULL,
    Name CHAR(255),
    Email CHAR(255));
"""

var createTableStatement: OpaquePointer?
if sqlite3_prepare_v2(db, createTableString, -1, &createTableStatement, nil) == SQLITE_OK {
    if sqlite3_step(createTableStatement) == SQLITE_DONE {
        print("用户表创建成功")
    } else {
        print("用户表创建失败")
    }
} else {
    print("CREATE TABLE 语句无法准备")
}
sqlite3_finalize(createTableStatement)
```

### 4. 插入数据

创建表后，我们可以向表中插入数据。以下是一个插入用户数据的示例：

```swift
let insertStatementString = "INSERT INTO Users (Id, Name, Email) VALUES (?, ?, ?);"
var insertStatement: OpaquePointer?

if sqlite3_prepare_v2(db, insertStatementString, -1, &insertStatement, nil) == SQLITE_OK {
    let id: Int32 = 1
    let name = "John Doe"
    let email = "john.doe@example.com"
    
    sqlite3_bind_int(insertStatement, 1, id)
    sqlite3_bind_text(insertStatement, 2, name, -1, nil)
    sqlite3_bind_text(insertStatement, 3, email, -1, nil)
    
    if sqlite3_step(insertStatement) == SQLITE_DONE {
        print("成功插入数据")
    } else {
        print("插入数据失败")
    }
} else {
    print("INSERT 语句无法准备")
}
sqlite3_finalize(insertStatement)
```

### 5. 查询数据

插入数据后，我们可以查询表中的数据。以下是一个查询用户数据的示例：

```swift
let queryStatementString = "SELECT * FROM Users;"
var queryStatement: OpaquePointer?

if sqlite3_prepare_v2(db, queryStatementString, -1, &queryStatement, nil) == SQLITE_OK {
    while sqlite3_step(queryStatement) == SQLITE_ROW {
        let id = sqlite3_column_int(queryStatement, 0)
        let name = String(cString: sqlite3_column_text(queryStatement, 1))
        let email = String(cString: sqlite3_column_text(queryStatement, 2))
        
        print("用户 ID: \(id), 姓名: \(name), 邮箱: \(email)")
    }
} else {
    print("SELECT 语句无法准备")
}
sqlite3_finalize(queryStatement)
```

### 6. 关闭数据库

最后，当我们完成数据库操作后，应该关闭数据库连接以释放资源。

```swift
sqlite3_close(db)
```

## 实际案例：用户管理系统

假设我们正在开发一个简单的用户管理系统，我们需要存储用户的基本信息（如姓名和邮箱）。我们可以使用 SQLite 来实现这个功能。以下是一个完整的示例：

```swift
import SQLite3

var db: OpaquePointer?
let fileURL = try! FileManager.default.url(for: .documentDirectory, in: .userDomainMask, appropriateFor: nil, create: false).appendingPathComponent("users.sqlite")

if sqlite3_open(fileURL.path, &db) == SQLITE_OK {
    print("成功打开数据库")
} else {
    print("无法打开数据库")
}

let createTableString = """
CREATE TABLE IF NOT EXISTS Users(
    Id INT PRIMARY KEY NOT NULL,
    Name CHAR(255),
    Email CHAR(255));
"""

var createTableStatement: OpaquePointer?
if sqlite3_prepare_v2(db, createTableString, -1, &createTableStatement, nil) == SQLITE_OK {
    if sqlite3_step(createTableStatement) == SQLITE_DONE {
        print("用户表创建成功")
    } else {
        print("用户表创建失败")
    }
} else {
    print("CREATE TABLE 语句无法准备")
}
sqlite3_finalize(createTableStatement)

let insertStatementString = "INSERT INTO Users (Id, Name, Email) VALUES (?, ?, ?);"
var insertStatement: OpaquePointer?

if sqlite3_prepare_v2(db, insertStatementString, -1, &insertStatement, nil) == SQLITE_OK {
    let id: Int32 = 1
    let name = "John Doe"
    let email = "john.doe@example.com"
    
    sqlite3_bind_int(insertStatement, 1, id)
    sqlite3_bind_text(insertStatement, 2, name, -1, nil)
    sqlite3_bind_text(insertStatement, 3, email, -1, nil)
    
    if sqlite3_step(insertStatement) == SQLITE_DONE {
        print("成功插入数据")
    } else {
        print("插入数据失败")
    }
} else {
    print("INSERT 语句无法准备")
}
sqlite3_finalize(insertStatement)

let queryStatementString = "SELECT * FROM Users;"
var queryStatement: OpaquePointer?

if sqlite3_prepare_v2(db, queryStatementString, -1, &queryStatement, nil) == SQLITE_OK {
    while sqlite3_step(queryStatement) == SQLITE_ROW {
        let id = sqlite3_column_int(queryStatement, 0)
        let name = String(cString: sqlite3_column_text(queryStatement, 1))
        let email = String(cString: sqlite3_column_text(queryStatement, 2))
        
        print("用户 ID: \(id), 姓名: \(name), 邮箱: \(email)")
    }
} else {
    print("SELECT 语句无法准备")
}
sqlite3_finalize(queryStatement)

sqlite3_close(db)
```

## 总结

通过本文，我们学习了如何在 Swift 中使用 SQLite 进行数据持久化。我们从打开数据库、创建表、插入数据、查询数据到关闭数据库，逐步讲解了 SQLite 的基本操作。SQLite 是一个强大且轻量级的数据库引擎，非常适合移动应用开发。

## 附加资源

- [SQLite 官方文档](https://www.sqlite.org/docs.html)
- [Swift 官方文档](https://developer.apple.com/documentation/swift)

## 练习

1. 尝试创建一个新的表，存储用户的年龄和地址信息。
2. 编写代码查询所有年龄大于 18 岁的用户。
3. 尝试更新用户的邮箱信息，并查询更新后的数据。

通过完成这些练习，你将更深入地理解 SQLite 的使用方法，并能够在实际项目中应用这些知识。