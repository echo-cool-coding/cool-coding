---
title: Swift CompactMap 函数
description: 了解 Swift 中的 `compactMap` 函数，它是函数式编程中用于处理可选值的强大工具。本文将通过示例和实际应用场景，帮助初学者掌握如何使用 `compactMap`。
---

## 介绍

在 Swift 中，`compactMap` 是一个非常有用的高阶函数，它允许你在处理集合时过滤掉 `nil` 值，并将非 `nil` 的值转换为另一种类型。`compactMap` 是 `map` 和 `filter` 的结合体，特别适合处理包含可选值的集合。

### `compactMap` 的基本概念

`compactMap` 的工作原理是遍历集合中的每个元素，并对每个元素应用一个转换闭包。如果闭包返回 `nil`，则该元素会被过滤掉；如果闭包返回非 `nil` 的值，则该值会被添加到结果数组中。

### 语法

```swift
func compactMap<T>(_ transform: (Element) throws -> T?) rethrows -> [T]
```

- `transform`: 一个闭包，接受集合中的元素作为参数，并返回一个可选值。
- 返回值: 一个包含所有非 `nil` 转换结果的数组。

## 代码示例

### 示例 1: 过滤掉 `nil` 值

假设我们有一个包含可选整数的数组，我们想要过滤掉所有的 `nil` 值，并将剩下的整数转换为字符串。

```swift
let numbers: [Int?] = [1, 2, nil, 4, nil, 5]
let nonNilNumbers = numbers.compactMap { $0 }
print(nonNilNumbers) // 输出: [1, 2, 4, 5]
```

在这个例子中，`compactMap` 过滤掉了所有的 `nil` 值，并返回了一个只包含非 `nil` 整数的数组。

### 示例 2: 转换并过滤

假设我们有一个字符串数组，我们想要将每个字符串转换为整数，并过滤掉无法转换的字符串。

```swift
let strings = ["1", "2", "three", "4", "five"]
let numbers = strings.compactMap { Int($0) }
print(numbers) // 输出: [1, 2, 4]
```

在这个例子中，`compactMap` 尝试将每个字符串转换为整数。如果转换成功，则返回该整数；如果转换失败（即返回 `nil`），则该字符串被过滤掉。

## 实际应用场景

### 场景 1: 处理 API 响应

在从 API 获取数据时，通常会遇到一些可选值。使用 `compactMap` 可以轻松地过滤掉无效的数据。

```swift
struct User {
    let id: Int
    let name: String
}

let apiResponse: [String: Any] = [
    "users": [
        ["id": 1, "name": "Alice"],
        ["id": 2, "name": "Bob"],
        ["id": 3], // 缺少 name
        ["name": "Charlie"] // 缺少 id
    ]
]

let users = (apiResponse["users"] as? [[String: Any]])?.compactMap { dict in
    guard let id = dict["id"] as? Int, let name = dict["name"] as? String else {
        return nil
    }
    return User(id: id, name: name)
}

print(users ?? []) // 输出: [User(id: 1, name: "Alice"), User(id: 2, name: "Bob")]
```

在这个场景中，`compactMap` 帮助我们过滤掉了无效的用户数据，并创建了一个有效的 `User` 对象数组。

### 场景 2: 数据清洗

在处理数据时，可能需要清洗掉一些无效或不需要的数据。`compactMap` 可以帮助我们轻松完成这项任务。

```swift
let rawData = ["123", "456", "abc", "789", "def"]
let cleanedData = rawData.compactMap { Int($0) }
print(cleanedData) // 输出: [123, 456, 789]
```

在这个场景中，`compactMap` 过滤掉了无法转换为整数的字符串，只保留了有效的整数。

## 总结

`compactMap` 是 Swift 中一个非常强大的函数，特别适合处理包含可选值的集合。它不仅可以过滤掉 `nil` 值，还可以在过滤的同时进行类型转换。通过本文的示例和实际应用场景，你应该已经掌握了如何使用 `compactMap` 来处理各种数据。

:::tip 提示
在实际开发中，`compactMap` 可以帮助你编写更简洁、更安全的代码。尝试在你的项目中找到可以使用 `compactMap` 的场景，并实践一下吧！
:::

## 附加资源与练习

### 练习 1
给定一个包含可选字符串的数组 `["1", "2", nil, "4", nil, "5"]`，使用 `compactMap` 过滤掉所有的 `nil` 值，并将剩下的字符串转换为整数。

### 练习 2
假设你有一个包含字典的数组，每个字典代表一个商品，包含 `name` 和 `price` 两个键。使用 `compactMap` 过滤掉所有价格无效的商品，并返回一个只包含有效商品的数组。

### 附加资源
- [Swift 官方文档 - compactMap](https://developer.apple.com/documentation/swift/sequence/2950916-compactmap)
- [Swift 高阶函数指南](https://www.swiftbysundell.com/basics/higher-order-functions/)

通过练习和阅读更多资源，你将更深入地理解 `compactMap` 的强大功能。