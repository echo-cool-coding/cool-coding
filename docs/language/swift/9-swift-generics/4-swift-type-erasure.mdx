---
title: Swift 类型擦除
description: 了解 Swift 中的类型擦除概念，掌握如何通过类型擦除隐藏具体类型信息，实现更灵活的泛型编程。
---

# Swift 类型擦除

## 介绍

在 Swift 中，泛型是一种强大的工具，它允许我们编写灵活且可重用的代码。然而，有时我们需要隐藏具体的类型信息，以便在更广泛的上下文中使用泛型类型。这就是**类型擦除**的用武之地。

类型擦除是一种技术，它允许我们将具体的类型信息“擦除”，从而在更高层次的抽象中使用泛型类型。通过类型擦除，我们可以创建更通用的接口，而不必暴露底层的具体类型。

## 为什么需要类型擦除？

假设我们有一个协议 `Animal`，并且我们希望存储一组遵循该协议的不同类型的动物。由于 Swift 的协议不能直接作为类型使用（协议不能直接实例化），我们需要一种方法来隐藏具体的类型信息，以便将它们存储在同一个集合中。

```swift
protocol Animal {
    func makeSound()
}

struct Dog: Animal {
    func makeSound() {
        print("Woof!")
    }
}

struct Cat: Animal {
    func makeSound() {
        print("Meow!")
    }
}
```

如果我们尝试将 `Dog` 和 `Cat` 存储在同一个数组中，编译器会报错，因为 `Animal` 是一个协议，而不是一个具体的类型。

```swift
let animals: [Animal] = [Dog(), Cat()] // 错误：协议 'Animal' 不能用作类型
```

为了解决这个问题，我们需要使用类型擦除。

## 如何实现类型擦除？

在 Swift 中，类型擦除通常通过创建一个包装器类型来实现，该包装器类型隐藏了具体的类型信息。我们可以使用一个泛型类或结构体来包装具体的类型，并提供一个统一的接口。

### 使用类型擦除包装器

我们可以创建一个 `AnyAnimal` 类型，它将隐藏具体的 `Animal` 类型：

```swift
struct AnyAnimal: Animal {
    private let _makeSound: () -> Void

    init<T: Animal>(_ animal: T) {
        _makeSound = animal.makeSound
    }

    func makeSound() {
        _makeSound()
    }
}
```

现在，我们可以将 `Dog` 和 `Cat` 包装在 `AnyAnimal` 中，并将它们存储在同一个数组中：

```swift
let animals: [AnyAnimal] = [AnyAnimal(Dog()), AnyAnimal(Cat())]

for animal in animals {
    animal.makeSound()
}
// 输出:
// Woof!
// Meow!
```

### 类型擦除的工作原理

在上面的例子中，`AnyAnimal` 结构体通过将 `makeSound` 方法存储为一个闭包来实现类型擦除。这个闭包捕获了具体的 `Animal` 类型的 `makeSound` 方法，从而隐藏了具体的类型信息。

## 实际应用场景

类型擦除在许多实际场景中都非常有用，特别是在处理复杂的泛型类型时。以下是一些常见的应用场景：

1. **集合中的异构类型**：当我们需要在集合中存储不同类型的对象时，类型擦除可以帮助我们隐藏具体的类型信息。
2. **回调或委托**：当我们需要将回调或委托方法存储为闭包时，类型擦除可以帮助我们隐藏具体的类型信息。
3. **API 设计**：在设计 API 时，类型擦除可以帮助我们提供更通用的接口，而不必暴露底层的具体类型。

## 总结

类型擦除是 Swift 中一种强大的技术，它允许我们隐藏具体的类型信息，从而在更广泛的上下文中使用泛型类型。通过创建类型擦除包装器，我们可以将不同类型的对象存储在同一个集合中，或者提供更通用的接口。

## 附加资源

- [Swift 官方文档 - 泛型](https://docs.swift.org/swift-book/LanguageGuide/Generics.html)
- [Swift 类型擦除的深入解析](https://www.avanderlee.com/swift/type-erasure/)

## 练习

1. 创建一个 `AnyVehicle` 类型擦除包装器，用于存储不同类型的车辆（如 `Car` 和 `Bike`）。
2. 尝试在回调中使用类型擦除，隐藏具体的回调类型。

通过练习，你将更好地理解类型擦除的概念，并能够在实际项目中应用它。