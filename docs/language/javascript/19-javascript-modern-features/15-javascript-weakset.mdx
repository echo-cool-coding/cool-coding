---
title: JavaScript WeakSet
description: 深入了解JavaScript的WeakSet对象，学习其用途、特性和实际应用场景，掌握这一现代JavaScript特性。
---

# JavaScript WeakSet

## 什么是WeakSet？

WeakSet是ECMAScript 6（ES6）引入的一种新的集合类型，类似于Set，但它只能存储对象引用，而且是"弱引用"。这意味着当对象没有其他引用时，垃圾回收机制可以回收WeakSet中的对象，从而防止内存泄漏。

:::note
"弱引用"意味着对象仅被WeakSet引用时，不会阻止它被垃圾回收。
:::

## WeakSet vs Set

在深入了解WeakSet之前，让我们先了解它与普通Set的区别：

| 特点 | WeakSet | Set |
|------|---------|-----|
| 元素类型 | 只能是对象 | 任何类型 |
| 弱引用 | 是 | 否 |
| 可迭代 | 否 | 是 |
| 方法 | 只有add, delete, has | 有add, delete, has, clear, size等 |
| 垃圾回收行为 | 当没有其他引用指向WeakSet中的对象时，该对象可被垃圾回收 | 即使只有Set引用某个对象，该对象也不会被垃圾回收 |

## WeakSet的基本操作

### 创建WeakSet

```javascript
// 创建一个空的WeakSet
const weakSet = new WeakSet();

// 使用带有对象的数组创建WeakSet
const obj1 = {};
const obj2 = {};
const weakSet2 = new WeakSet([obj1, obj2]);
```

### WeakSet的方法

WeakSet对象有三个主要方法：

1. **add(value)**: 添加对象到WeakSet
2. **delete(value)**: 从WeakSet中删除指定对象
3. **has(value)**: 检查WeakSet是否包含指定对象

```javascript
const weakSet = new WeakSet();
const obj = {};

// 添加对象
weakSet.add(obj);
console.log(weakSet.has(obj)); // 输出: true

// 删除对象
weakSet.delete(obj);
console.log(weakSet.has(obj)); // 输出: false

// 尝试添加非对象值会报错
try {
  weakSet.add(42); // 抛出TypeError
} catch (e) {
  console.log("错误:", e.message); // 错误: Invalid value used in weak set
}
```

## WeakSet的限制

与Set相比，WeakSet有几个重要的限制：

1. **不可迭代**: WeakSet不提供遍历方法，没有for...of, forEach, keys(), values()等方法。

2. **没有size属性**: 无法直接获取WeakSet中的元素数量。

3. **没有clear()方法**: 无法一次性清空WeakSet，只能一个个删除元素。

4. **无法存储原始值**: 只能存储对象引用，不能存储数字、字符串等原始类型。

这些限制主要是由于WeakSet中对象的弱引用性质所导致的。

## WeakSet的垃圾回收行为

WeakSet的主要特点是它对对象的弱引用。当对象没有其他引用时，即使它存在于WeakSet中，它也会被垃圾回收。

```javascript
let obj = { name: "测试对象" };
const weakSet = new WeakSet([obj]);

console.log(weakSet.has(obj)); // 输出: true

// 移除强引用
obj = null;

// 在某个时间点后，垃圾回收机制会回收该对象
// weakSet.has(obj)将返回false，但我们无法演示这一点
// 因为垃圾回收的时机是不确定的
```

:::caution
无法直接观察到WeakSet中的对象被垃圾回收的过程，因为垃圾回收的时机是由JavaScript引擎决定的，且不可预测。
:::

## WeakSet的实际应用场景

虽然WeakSet的使用场景相对有限，但在某些特定情况下非常有用：

### 1. 存储DOM元素

当你需要跟踪一组DOM元素，但不想阻止它们被垃圾回收（比如当它们从文档中被移除时），WeakSet是理想的选择：

```javascript
const visitedElements = new WeakSet();

// 当用户与元素交互时
document.querySelectorAll('.interactive-element').forEach(element => {
  element.addEventListener('click', function() {
    if (!visitedElements.has(this)) {
      visitedElements.add(this);
      console.log('首次点击此元素!');
    } else {
      console.log('此元素已被点击过!');
    }
  });
});
```

### 2. 防止对象被重复处理

```javascript
const processedObjects = new WeakSet();

function processObject(obj) {
  // 避免重复处理
  if (processedObjects.has(obj)) {
    console.log('此对象已被处理，跳过');
    return;
  }
  
  // 处理对象
  console.log('处理对象:', obj);
  
  // 标记为已处理
  processedObjects.add(obj);
}

const obj = { data: 'some data' };
processObject(obj); // 输出: 处理对象: { data: 'some data' }
processObject(obj); // 输出: 此对象已被处理，跳过
```

### 3. 实现私有实例方法的检查

WeakSet可以用来确保某些方法只能被特定的实例调用：

```javascript
// 创建存储私有实例的WeakSet
const privateInstances = new WeakSet();

class MyClass {
  constructor() {
    privateInstances.add(this);
  }

  privateMethod() {
    if (!privateInstances.has(this)) {
      throw new TypeError("不允许调用私有方法!");
    }
    
    return "这是私有方法的结果";
  }
  
  publicMethod() {
    return this.privateMethod();
  }
}

const instance = new MyClass();
console.log(instance.publicMethod()); // 正常工作

// 尝试破解私有方法
try {
  const stolenMethod = instance.privateMethod;
  console.log(stolenMethod()); // 将抛出错误
} catch (e) {
  console.log(e.message); // 输出: 不允许调用私有方法!
}
```

## 为什么要使用WeakSet？

WeakSet提供了一种在不阻止垃圾回收的情况下，存储对象引用的方式。这在一些特定场景下非常有用：

1. **防止内存泄漏**: 当你需要将对象标记为"已处理"或"已访问"，但不想永久保持对它们的引用。

2. **临时对象追踪**: 对于生命周期有限的对象（如DOM元素），使用WeakSet可以避免手动清理引用。

3. **对象标记**: 在不修改对象本身的情况下，为对象添加状态标记。

## 总结

WeakSet是JavaScript中一种特殊的集合类型，专门用于存储对象的弱引用。它具有以下特点：

- 只能存储对象引用
- 持有对象的弱引用，不阻止垃圾回收
- 不可迭代，没有size属性
- 仅提供add、delete和has方法

虽然WeakSet的使用场景相对有限，但在需要临时存储对象引用且不阻止垃圾回收的场景下，它是一个理想的工具，可以帮助防止内存泄漏并简化代码逻辑。

## 练习题

1. 创建一个WeakSet，并尝试添加一个对象和一个数字，观察会发生什么。
2. 使用WeakSet实现一个跟踪函数调用次数的系统，但不阻止被跟踪的函数被垃圾回收。
3. 思考：为什么WeakSet不提供clear()方法和size属性？

## 进一步学习资源

- [MDN Web Docs: WeakSet](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakSet)
- [JavaScript.info: WeakMap and WeakSet](https://javascript.info/weakmap-weakset)
- [ES6标准入门](https://es6.ruanyifeng.com/#docs/set-map#WeakSet)

通过学习WeakSet，你已经掌握了JavaScript中一个相对高级但非常有用的特性，这将帮助你编写更高效、更安全的代码。