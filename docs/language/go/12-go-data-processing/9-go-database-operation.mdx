---
title: Go 数据库操作
description: 学习如何在Go语言中进行数据库操作，包括连接数据库、执行查询、插入数据等基本操作。本文适合初学者，提供清晰的代码示例和实际应用场景。
---

# Go 数据库操作

在现代应用程序开发中，数据库操作是不可或缺的一部分。Go语言提供了强大的标准库和第三方库，使得与数据库的交互变得简单而高效。本文将带你了解如何在Go中进行数据库操作，包括连接数据库、执行查询、插入数据等基本操作。

## 1. 数据库连接

在Go中，我们通常使用 `database/sql` 包来与数据库进行交互。首先，我们需要导入必要的包并建立数据库连接。

```go
import (
    "database/sql"
    _ "github.com/go-sql-driver/mysql" // MySQL驱动
    "log"
)

func main() {
    // 数据库连接字符串
    db, err := sql.Open("mysql", "user:password@tcp(127.0.0.1:3306)/dbname")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // 测试连接
    err = db.Ping()
    if err != nil {
        log.Fatal(err)
    }
    fmt.Println("Connected to the database!")
}
```

:::note
在上面的代码中，我们使用了MySQL数据库。如果你使用的是其他数据库（如PostgreSQL、SQLite等），只需替换驱动和连接字符串即可。
:::

## 2. 执行查询

一旦建立了数据库连接，我们就可以执行查询了。以下是一个简单的查询示例，从数据库中获取数据。

```go
type User struct {
    ID   int
    Name string
    Age  int
}

func queryUsers(db *sql.DB) ([]User, error) {
    rows, err := db.Query("SELECT id, name, age FROM users")
    if err != nil {
        return nil, err
    }
    defer rows.Close()

    var users []User
    for rows.Next() {
        var user User
        if err := rows.Scan(&user.ID, &user.Name, &user.Age); err != nil {
            return nil, err
        }
        users = append(users, user)
    }

    return users, nil
}
```

:::tip
`rows.Scan()` 方法用于将查询结果映射到结构体字段中。确保字段顺序与查询结果一致。
:::

## 3. 插入数据

插入数据是数据库操作的另一个常见任务。以下是一个插入数据的示例：

```go
func insertUser(db *sql.DB, name string, age int) (int64, error) {
    result, err := db.Exec("INSERT INTO users (name, age) VALUES (?, ?)", name, age)
    if err != nil {
        return 0, err
    }

    id, err := result.LastInsertId()
    if err != nil {
        return 0, err
    }

    return id, nil
}
```

:::caution
在执行插入操作时，确保传入的参数类型与数据库表中的字段类型匹配。
:::

## 4. 更新和删除数据

更新和删除数据的操作与插入类似。以下是一个更新数据的示例：

```go
func updateUserAge(db *sql.DB, id int, newAge int) error {
    _, err := db.Exec("UPDATE users SET age = ? WHERE id = ?", newAge, id)
    return err
}
```

删除数据的操作如下：

```go
func deleteUser(db *sql.DB, id int) error {
    _, err := db.Exec("DELETE FROM users WHERE id = ?", id)
    return err
}
```

## 5. 事务处理

在某些情况下，我们需要确保一系列操作要么全部成功，要么全部失败。这时可以使用事务。

```go
func transferMoney(db *sql.DB, fromID, toID int, amount float64) error {
    tx, err := db.Begin()
    if err != nil {
        return err
    }

    // 扣除转出账户的金额
    _, err = tx.Exec("UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, fromID)
    if err != nil {
        tx.Rollback()
        return err
    }

    // 增加转入账户的金额
    _, err = tx.Exec("UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, toID)
    if err != nil {
        tx.Rollback()
        return err
    }

    return tx.Commit()
}
```

:::warning
事务处理时，务必在发生错误时调用 `tx.Rollback()`，以确保数据的一致性。
:::

## 6. 实际应用场景

假设我们正在开发一个简单的用户管理系统，需要实现以下功能：

1. 添加新用户
2. 查询所有用户
3. 更新用户年龄
4. 删除用户

通过上述代码示例，我们可以轻松实现这些功能。

## 7. 总结

本文介绍了如何在Go语言中进行数据库操作，包括连接数据库、执行查询、插入数据、更新和删除数据以及事务处理。通过这些基本操作，你可以构建功能强大的数据库驱动应用程序。

## 8. 附加资源与练习

- **练习1**：尝试使用SQLite数据库替换MySQL，并实现相同的功能。
- **练习2**：扩展用户管理系统，添加用户登录和权限管理功能。
- **资源**：[Go database/sql 官方文档](https://golang.org/pkg/database/sql/)

通过不断练习和探索，你将能够熟练掌握Go语言中的数据库操作。祝你编程愉快！