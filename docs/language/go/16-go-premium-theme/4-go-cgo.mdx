---
title: Go CGO
description: "深入了解 Go 语言中的 CGO 技术，学习如何在 Go 中调用 C 代码，并通过实际案例掌握其应用场景。"
---

# Go CGO

## 介绍

在 Go 语言中，CGO 是一个强大的工具，它允许你在 Go 代码中直接调用 C 代码。CGO 是 Go 语言与 C 语言之间的桥梁，使得开发者可以利用现有的 C 库或编写高性能的 C 代码来扩展 Go 程序的功能。

CGO 的主要用途包括：
- 调用现有的 C 库。
- 在 Go 中编写高性能的代码。
- 与操作系统底层 API 进行交互。

## 基本用法

要在 Go 中使用 CGO，首先需要在 Go 文件中导入 `C` 包，并使用特殊的注释来嵌入 C 代码。以下是一个简单的示例：

```go
package main

/*
#include <stdio.h>

void sayHello() {
    printf("Hello from C!\n");
}
*/
import "C"

func main() {
    C.sayHello()
}
```

在这个示例中，我们定义了一个 C 函数 `sayHello`，然后在 Go 代码中通过 `C.sayHello()` 调用它。运行这个程序会输出：

```
Hello from C!
```

## 数据类型转换

在 Go 和 C 之间传递数据时，需要进行类型转换。CGO 提供了一些工具函数来简化这个过程。例如，`C.CString` 可以将 Go 的字符串转换为 C 的字符串，而 `C.GoString` 则可以将 C 的字符串转换回 Go 的字符串。

```go
package main

/*
#include <stdio.h>
#include <stdlib.h>

void printString(char* str) {
    printf("%s\n", str);
}
*/
import "C"
import "unsafe"

func main() {
    str := "Hello from Go!"
    cStr := C.CString(str)
    defer C.free(unsafe.Pointer(cStr)) // 释放 C 字符串的内存
    C.printString(cStr)
}
```

在这个示例中，我们使用 `C.CString` 将 Go 字符串转换为 C 字符串，并在使用完后通过 `C.free` 释放内存。

## 实际案例：调用 C 标准库

假设我们需要在 Go 中调用 C 标准库中的 `math.h` 来计算平方根。我们可以通过 CGO 来实现：

```go
package main

/*
#include <math.h>
*/
import "C"
import "fmt"

func main() {
    x := 16.0
    result := C.sqrt(C.double(x))
    fmt.Printf("The square root of %f is %f\n", x, result)
}
```

运行这个程序会输出：

```
The square root of 16.000000 is 4.000000
```

## 实际案例：与操作系统交互

CGO 还可以用于与操作系统底层 API 进行交互。例如，我们可以使用 CGO 调用 Linux 的系统调用 `getpid` 来获取当前进程的 ID：

```go
package main

/*
#include <unistd.h>
*/
import "C"
import "fmt"

func main() {
    pid := C.getpid()
    fmt.Printf("The process ID is %d\n", pid)
}
```

运行这个程序会输出当前进程的 ID。

## 总结

CGO 是 Go 语言中一个非常强大的工具，它允许你在 Go 代码中直接调用 C 代码。通过 CGO，你可以利用现有的 C 库、编写高性能的代码，并与操作系统底层 API 进行交互。然而，使用 CGO 也需要注意内存管理和类型转换等问题。

## 附加资源

- [Go CGO 官方文档](https://golang.org/cmd/cgo/)
- [Go 与 C 的交互](https://blog.golang.org/c-go-cgo)
- [CGO 实战](https://github.com/golang/go/wiki/cgo)

## 练习

1. 尝试在 Go 中调用 C 标准库中的 `time.h`，获取当前时间并打印出来。
2. 编写一个 Go 程序，使用 CGO 调用一个自定义的 C 函数，该函数接受两个整数并返回它们的和。
3. 研究如何在 Go 中使用 CGO 调用 Windows API，并尝试调用 `MessageBox` 函数显示一个消息框。

通过以上练习，你将更深入地理解 CGO 的使用场景和技巧。