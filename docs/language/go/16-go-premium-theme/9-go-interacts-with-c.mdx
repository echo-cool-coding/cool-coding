---
title: Go 与C交互
description: 了解如何在Go语言中与C语言进行交互，掌握cgo的基本用法和实际应用场景。
---

## 介绍

Go语言以其简洁、高效和并发友好的特性而闻名，但在某些场景下，我们可能需要与C语言进行交互。例如，当我们需要调用现有的C库，或者需要直接操作底层硬件时，Go与C的交互就显得尤为重要。Go语言通过`cgo`工具提供了与C语言的无缝集成能力，使得开发者可以在Go代码中直接调用C函数和使用C数据类型。

本文将逐步介绍如何在Go中使用`cgo`与C语言进行交互，并通过实际案例展示其应用场景。

## 1. 什么是cgo？

`cgo`是Go语言提供的一个工具，它允许Go代码调用C代码，并且可以在Go代码中嵌入C代码。通过`cgo`，我们可以轻松地在Go程序中调用C函数、使用C数据类型，甚至可以将C代码直接嵌入到Go源文件中。

## 2. 基本用法

### 2.1 在Go中调用C函数

要在Go中调用C函数，首先需要在Go代码中导入`C`包，并使用特殊的注释来声明C代码。以下是一个简单的示例：

```go
package main

/*
#include <stdio.h>

void sayHello() {
    printf("Hello from C!\n");
}
*/
import "C"

func main() {
    C.sayHello()
}
```

在这个示例中，我们通过`#include <stdio.h>`引入了C标准库，并定义了一个`sayHello`函数。然后在Go代码中，我们通过`C.sayHello()`调用了这个C函数。

**输出：**
```
Hello from C!
```

### 2.2 传递参数和返回值

我们还可以在Go和C之间传递参数和返回值。以下示例展示了如何传递一个整数参数并返回其平方：

```go
package main

/*
int square(int n) {
    return n * n;
}
*/
import "C"
import "fmt"

func main() {
    n := 5
    result := C.square(C.int(n))
    fmt.Printf("The square of %d is %d\n", n, result)
}
```

在这个示例中，我们定义了一个`square`函数，它接受一个`int`类型的参数并返回其平方。在Go代码中，我们通过`C.int(n)`将Go的`int`类型转换为C的`int`类型，并将结果打印出来。

**输出：**
```
The square of 5 is 25
```

## 3. 数据类型转换

在Go和C之间传递数据时，需要注意数据类型的转换。以下是一些常见的数据类型转换：

- `C.int`：C语言中的`int`类型。
- `C.char`：C语言中的`char`类型。
- `C.double`：C语言中的`double`类型。

以下示例展示了如何在Go和C之间传递字符串：

```go
package main

/*
#include <string.h>

void printString(char* str) {
    printf("%s\n", str);
}
*/
import "C"
import "unsafe"

func main() {
    str := "Hello from Go!"
    cStr := C.CString(str)
    defer C.free(unsafe.Pointer(cStr))
    C.printString(cStr)
}
```

在这个示例中，我们使用`C.CString`将Go的字符串转换为C的`char*`类型，并在使用完后通过`C.free`释放内存。

**输出：**
```
Hello from Go!
```

:::caution
在使用`C.CString`时，务必记得使用`C.free`释放内存，否则会导致内存泄漏。
:::

## 4. 实际应用场景

### 4.1 调用现有的C库

假设我们有一个用C编写的数学库`libmath`，其中包含一个计算斐波那契数列的函数`fibonacci`。我们可以通过`cgo`在Go中调用这个函数：

```go
package main

/*
#include "libmath.h"
*/
import "C"
import "fmt"

func main() {
    n := 10
    result := C.fibonacci(C.int(n))
    fmt.Printf("The %dth Fibonacci number is %d\n", n, result)
}
```

在这个示例中，我们假设`libmath.h`中定义了`fibonacci`函数。通过`cgo`，我们可以直接在Go代码中调用这个C函数。

### 4.2 与硬件交互

在某些嵌入式系统中，我们可能需要直接操作硬件寄存器。通过`cgo`，我们可以在Go中调用C代码来访问硬件寄存器：

```go
package main

/*
#define GPIO_BASE 0x20200000

void set_gpio(int pin, int value) {
    volatile unsigned int* gpio = (unsigned int*)GPIO_BASE;
    gpio[pin] = value;
}
*/
import "C"

func main() {
    pin := 17
    value := 1
    C.set_gpio(C.int(pin), C.int(value))
}
```

在这个示例中，我们通过`cgo`调用C代码来设置GPIO引脚的值。

## 5. 总结

通过`cgo`，Go语言可以轻松地与C语言进行交互，这使得我们能够在Go中调用现有的C库、操作硬件或执行其他底层操作。本文介绍了`cgo`的基本用法、数据类型转换以及实际应用场景，希望能够帮助初学者掌握Go与C交互的基本技能。

## 6. 附加资源与练习

- **官方文档**：阅读Go官方文档中关于`cgo`的部分，了解更多高级用法和注意事项。
- **练习**：尝试在Go中调用一个C库函数，例如`libcurl`，并实现一个简单的HTTP客户端。
- **深入阅读**：了解如何在Go中使用`cgo`调用C++代码，以及如何处理C++对象。

:::tip
在实际项目中，尽量避免过度依赖`cgo`，因为它可能会增加代码的复杂性和维护成本。在可能的情况下，优先使用纯Go实现。
:::