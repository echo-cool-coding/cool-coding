---
title: Java HttpURLConnection
description: 全面介绍Java中的HttpURLConnection类，包括基础概念、使用方法、实用案例以及最佳实践
---

# Java HttpURLConnection

## 介绍

在Java网络编程中，`HttpURLConnection`是一个用于发送HTTP请求和接收HTTP响应的核心类。它是`URLConnection`的子类，专门用于处理HTTP协议相关的连接。通过`HttpURLConnection`，开发人员可以轻松地与web服务器进行交互，执行诸如获取网页内容、提交表单数据、上传文件等操作。

对于Java初学者来说，掌握`HttpURLConnection`的使用对于开发网络应用程序、与RESTful API交互以及实现客户端-服务器通信至关重要。

## HttpURLConnection基础

`HttpURLConnection`类位于`java.net`包中，是Java标准库的一部分，无需引入第三方依赖即可使用。它提供了创建和管理HTTP连接的功能，支持所有标准的HTTP方法（GET、POST、PUT、DELETE等）。

### HttpURLConnection的主要特点

- 不需要额外依赖，Java标准库自带
- 支持所有HTTP方法
- 允许设置请求头和读取响应头
- 支持HTTP重定向处理
- 提供连接超时和读取超时设置
- 能够处理cookies（通过CookieManager）

## 创建HttpURLConnection

要创建一个`HttpURLConnection`对象，我们首先需要创建一个`URL`对象，然后调用其`openConnection()`方法，并将结果转换为`HttpURLConnection`：

```java
import java.net.HttpURLConnection;
import java.net.URL;
import java.io.IOException;

public class HttpURLConnectionExample {
    public static void main(String[] args) {
        try {
            // 创建URL对象
            URL url = new URL("https://www.example.com");
            
            // 打开连接并转换为HttpURLConnection
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            
            // 设置HTTP方法
            connection.setRequestMethod("GET");
            
            // 获取响应代码
            int responseCode = connection.getResponseCode();
            System.out.println("响应代码: " + responseCode);
            
            // 关闭连接
            connection.disconnect();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

输出：
```
响应代码: 200
```

## 发送GET请求

GET请求是最常见的HTTP请求类型，通常用于从服务器获取数据。以下是使用`HttpURLConnection`发送GET请求的完整示例：

```java
import java.net.HttpURLConnection;
import java.net.URL;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

public class HttpGetExample {
    public static void main(String[] args) {
        try {
            // 创建URL对象
            URL url = new URL("https://jsonplaceholder.typicode.com/posts/1");
            
            // 打开连接
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            
            // 设置请求方法
            connection.setRequestMethod("GET");
            
            // 设置连接和读取超时（毫秒）
            connection.setConnectTimeout(5000);
            connection.setReadTimeout(5000);
            
            // 获取响应代码
            int responseCode = connection.getResponseCode();
            System.out.println("GET 响应代码: " + responseCode);
            
            // 读取响应内容
            if (responseCode == HttpURLConnection.HTTP_OK) { // 200
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(connection.getInputStream()));
                String inputLine;
                StringBuilder response = new StringBuilder();
                
                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();
                
                // 打印响应
                System.out.println("响应内容: " + response.toString());
            } else {
                System.out.println("GET请求失败");
            }
            
            // 关闭连接
            connection.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

输出：
```
GET 响应代码: 200
响应内容: {"userId":1,"id":1,"title":"sunt aut facere repellat provident occaecati excepturi optio reprehenderit","body":"quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"}
```

## 发送POST请求

POST请求通常用于向服务器提交数据。以下是使用`HttpURLConnection`发送POST请求的示例：

```java
import java.net.HttpURLConnection;
import java.net.URL;
import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;

public class HttpPostExample {
    public static void main(String[] args) {
        try {
            URL url = new URL("https://jsonplaceholder.typicode.com/posts");
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            
            // 设置请求方法为POST
            connection.setRequestMethod("POST");
            
            // 启用输入/输出流
            connection.setDoOutput(true);
            connection.setDoInput(true);
            
            // 设置请求头
            connection.setRequestProperty("Content-Type", "application/json; charset=UTF-8");
            connection.setRequestProperty("Accept", "application/json");
            
            // 构建POST请求数据
            String jsonInputString = "{\"title\":\"测试文章\",\"body\":\"这是测试内容\",\"userId\":1}";
            
            // 发送POST数据
            try (DataOutputStream os = new DataOutputStream(connection.getOutputStream())) {
                byte[] input = jsonInputString.getBytes(StandardCharsets.UTF_8);
                os.write(input, 0, input.length);
            }
            
            // 获取响应代码
            int responseCode = connection.getResponseCode();
            System.out.println("POST 响应代码: " + responseCode);
            
            // 读取响应
            try (BufferedReader br = new BufferedReader(
                 new InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8))) {
                StringBuilder response = new StringBuilder();
                String responseLine;
                while ((responseLine = br.readLine()) != null) {
                    response.append(responseLine.trim());
                }
                System.out.println("响应内容: " + response.toString());
            }
            
            // 关闭连接
            connection.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

输出：
```
POST 响应代码: 201
响应内容: {"title":"测试文章","body":"这是测试内容","userId":1,"id":101}
```

## 设置请求头

在很多情况下，您需要设置HTTP请求头来传递额外信息，如认证凭据、内容类型等。以下是如何设置请求头的示例：

```java
// 创建连接后设置请求头
connection.setRequestProperty("User-Agent", "Mozilla/5.0");
connection.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
connection.setRequestProperty("Content-Type", "application/json");
connection.setRequestProperty("Authorization", "Bearer your_token_here");
```

## 读取响应头

同样，您可能需要读取服务器返回的响应头信息：

```java
// 获取单个响应头
String contentType = connection.getHeaderField("Content-Type");
System.out.println("Content-Type: " + contentType);

// 获取所有响应头
System.out.println("所有响应头:");
connection.getHeaderFields().forEach((key, value) -> {
    System.out.println(key + ": " + value);
});
```

## 处理Cookies

`HttpURLConnection`本身没有直接提供处理cookies的方法，但可以通过`CookieManager`和`CookieHandler`类来管理cookies：

```java
import java.net.*;
import java.io.*;
import java.util.*;

public class CookieExample {
    public static void main(String[] args) {
        try {
            // 创建CookieManager
            CookieManager cookieManager = new CookieManager();
            cookieManager.setCookiePolicy(CookiePolicy.ACCEPT_ALL);
            CookieHandler.setDefault(cookieManager);
            
            // 第一个请求 - 获取cookies
            URL url = new URL("https://www.example.com");
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.getResponseCode(); // 触发连接以获取cookies
            
            // 显示收到的cookies
            CookieStore cookieStore = cookieManager.getCookieStore();
            List<HttpCookie> cookies = cookieStore.getCookies();
            System.out.println("收到的cookies:");
            for (HttpCookie cookie : cookies) {
                System.out.println(cookie.getName() + ": " + cookie.getValue());
            }
            
            connection.disconnect();
            
            // 第二个请求 - 会自动带上之前的cookies
            URL url2 = new URL("https://www.example.com/another-page");
            HttpURLConnection connection2 = (HttpURLConnection) url2.openConnection();
            connection2.getResponseCode();
            connection2.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 设置连接和读取超时

在网络编程中，设置超时非常重要，可以避免程序因网络问题而无限期等待：

```java
// 设置连接超时（建立到服务器连接的最大时间，单位：毫秒）
connection.setConnectTimeout(5000);

// 设置读取超时（从服务器读取数据的最大时间，单位：毫秒）
connection.setReadTimeout(5000);
```

## 处理HTTP重定向

`HttpURLConnection`默认不会自动处理重定向（3xx响应码），您可以启用此功能：

```java
// 启用自动处理重定向
HttpURLConnection.setFollowRedirects(true); // 静态方法，全局设置

// 或者针对特定连接
connection.setInstanceFollowRedirects(true);
```

## 上传文件

以下是使用`HttpURLConnection`上传文件的示例，使用多部分表单数据（multipart/form-data）：

```java
import java.net.*;
import java.io.*;
import java.nio.file.*;

public class FileUploadExample {
    public static void main(String[] args) {
        try {
            String boundary = "----WebKitFormBoundary" + System.currentTimeMillis();
            String LINE_FEED = "\r\n";
            
            URL url = new URL("https://example.com/upload");
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("POST");
            connection.setDoOutput(true);
            connection.setRequestProperty("Content-Type", 
                    "multipart/form-data; boundary=" + boundary);
            
            try (OutputStream outputStream = connection.getOutputStream();
                 PrintWriter writer = new PrintWriter(new OutputStreamWriter(outputStream, "UTF-8"), true)) {
                
                // 添加普通表单字段
                writer.append("--" + boundary).append(LINE_FEED);
                writer.append("Content-Disposition: form-data; name=\"description\"").append(LINE_FEED);
                writer.append("Content-Type: text/plain; charset=UTF-8").append(LINE_FEED);
                writer.append(LINE_FEED);
                writer.append("文件描述").append(LINE_FEED);
                
                // 添加文件
                File fileToUpload = new File("example.txt");
                String fileName = fileToUpload.getName();
                
                writer.append("--" + boundary).append(LINE_FEED);
                writer.append("Content-Disposition: form-data; name=\"file\"; filename=\"" + fileName + "\"")
                      .append(LINE_FEED);
                writer.append("Content-Type: text/plain").append(LINE_FEED);
                writer.append(LINE_FEED);
                writer.flush();
                
                // 读取文件并写入输出流
                Files.copy(fileToUpload.toPath(), outputStream);
                outputStream.flush();
                
                // 结束
                writer.append(LINE_FEED);
                writer.append("--" + boundary + "--").append(LINE_FEED);
                writer.flush();
            }
            
            // 检查响应
            int responseCode = connection.getResponseCode();
            System.out.println("响应代码: " + responseCode);
            
            // 读取响应
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(connection.getInputStream()))) {
                String line;
                StringBuilder response = new StringBuilder();
                while ((line = reader.readLine()) != null) {
                    response.append(line);
                }
                System.out.println("响应内容: " + response.toString());
            }
            
            connection.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 实际应用场景：天气API客户端

下面是一个实际案例，使用`HttpURLConnection`创建一个简单的天气API客户端，从OpenWeatherMap获取天气数据：

```java
import java.net.*;
import java.io.*;
import java.util.*;

public class WeatherApiClient {
    private static final String API_KEY = "your_api_key"; // 替换为您的API密钥
    private static final String BASE_URL = "https://api.openweathermap.org/data/2.5/weather";
    
    public static void main(String[] args) {
        try {
            // 获取北京的天气数据
            String weatherData = getWeatherByCity("Beijing");
            System.out.println("北京天气数据:");
            System.out.println(weatherData);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public static String getWeatherByCity(String cityName) throws IOException {
        // 构建URL，添加查询参数
        StringBuilder urlBuilder = new StringBuilder(BASE_URL);
        urlBuilder.append("?q=").append(URLEncoder.encode(cityName, "UTF-8"));
        urlBuilder.append("&appid=").append(API_KEY);
        urlBuilder.append("&units=metric"); // 使用摄氏度
        
        URL url = new URL(urlBuilder.toString());
        HttpURLConnection connection = (HttpURLConnection) url.openConnection();
        
        // 设置请求方法和超时
        connection.setRequestMethod("GET");
        connection.setConnectTimeout(5000);
        connection.setReadTimeout(5000);
        
        // 获取响应
        int responseCode = connection.getResponseCode();
        
        if (responseCode == HttpURLConnection.HTTP_OK) {
            BufferedReader reader = new BufferedReader(
                new InputStreamReader(connection.getInputStream()));
            String line;
            StringBuilder response = new StringBuilder();
            
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            reader.close();
            
            return response.toString();
        } else {
            throw new IOException("HTTP请求失败，响应代码: " + responseCode);
        }
    }
}
```

:::note
上述示例需要注册OpenWeatherMap账号并获取API密钥才能运行。
:::

## HttpURLConnection的局限性

虽然`HttpURLConnection`是Java标准库的一部分，但它也有一些局限性：

1. API设计不够友好，使用时代码较为繁琐
2. 缺乏一些现代HTTP客户端的功能，如连接池
3. 错误处理不够优雅
4. 异步操作支持有限

对于更复杂的HTTP请求需求，可以考虑使用诸如Apache HttpClient、OkHttp或者Java 11新引入的`HttpClient`等第三方库。

## 使用HttpURLConnection的最佳实践

1. **始终关闭连接**：使用完`HttpURLConnection`后调用`disconnect()`方法释放资源
2. **设置合适的超时**：总是设置连接和读取超时，避免程序无限期等待
3. **正确处理异常**：网络操作容易失败，确保妥善处理可能的异常
4. **使用try-with-resources**：处理输入输出流时使用try-with-resources确保资源正确关闭
5. **避免重复创建相同URL的连接**：如需多次连接同一服务器，考虑重用URL对象

## 总结

`HttpURLConnection`是Java标准库提供的基本HTTP客户端实现，适合简单的HTTP请求处理。它支持所有常见的HTTP方法、请求/响应头处理、cookies管理和文件上传等功能。虽然对于复杂应用可能不及第三方库强大，但作为标准库的一部分，它无需额外依赖，适合初学者学习HTTP通信的基础知识。

通过本文的学习，您应该已经掌握了：
- 如何创建`HttpURLConnection`对象
- 如何发送GET和POST请求
- 如何设置和读取HTTP头信息
- 如何处理cookies和超时
- 如何上传文件
- 实际应用案例

## 练习与实践

为了巩固所学知识，建议尝试以下练习：

1. 创建一个简单的RESTful API客户端，连接到公开API（如GitHub API）并获取用户数据
2. 实现一个文件下载器，能够从网络下载大文件并显示进度
3. 创建一个简单的网页爬虫，使用`HttpURLConnection`获取网页内容并解析特定信息
4. 实现HTTP基本认证，使用`HttpURLConnection`访问需要用户名和密码的API

## 附加资源

- [Java官方文档 - HttpURLConnection](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/HttpURLConnection.html)
- [Java官方教程 - URLConnection类](https://docs.oracle.com/javase/tutorial/networking/urls/urlConnection.html)
- [RESTful APIs测试网站 - JSONPlaceholder](https://jsonplaceholder.typicode.com/)
- [HTTP状态码参考](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)

祝您在Java网络编程之旅中学习愉快！