---
title: PHP FFI 扩展
description: 了解 PHP FFI（Foreign Function Interface）扩展，掌握如何在 PHP 中调用 C 语言函数和操作 C 语言数据结构。
---

# PHP FFI 扩展

PHP FFI（Foreign Function Interface）扩展是 PHP 7.4 引入的一个强大特性，它允许 PHP 直接调用 C 语言函数和操作 C 语言数据结构。通过 FFI，PHP 开发者可以轻松地与 C 语言库进行交互，从而扩展 PHP 的功能。

## 什么是 PHP FFI？

FFI 是一种允许 PHP 代码直接调用 C 语言函数和操作 C 语言数据结构的机制。它通过定义一个接口，将 C 语言的头文件（`.h` 文件）中的函数和数据结构映射到 PHP 中。这使得 PHP 能够与现有的 C 语言库进行无缝集成，而无需编写复杂的扩展。

## 为什么使用 PHP FFI？

- **性能优化**：通过调用 C 语言函数，可以显著提高某些操作的性能。
- **代码复用**：可以直接使用现有的 C 语言库，避免重复造轮子。
- **灵活性**：FFI 提供了与 C 语言库交互的灵活性，使得 PHP 能够处理更复杂的任务。

## 如何使用 PHP FFI？

### 1. 安装 FFI 扩展

首先，确保你的 PHP 环境已经安装了 FFI 扩展。你可以通过以下命令检查：

```bash
php -m | grep ffi
```

如果输出中包含 `ffi`，则说明 FFI 扩展已安装。如果没有，你需要通过编译 PHP 时启用 FFI 扩展，或者在 `php.ini` 中启用 `ffi` 扩展。

### 2. 定义 C 语言接口

假设我们有一个简单的 C 语言库 `libmath.so`，其中包含一个计算两个整数和的函数 `add`。我们可以通过 FFI 在 PHP 中调用这个函数。

首先，创建一个 C 语言头文件 `math.h`：

```c
// math.h
int add(int a, int b);
```

然后，编译这个库：

```bash
gcc -shared -o libmath.so math.c
```

### 3. 在 PHP 中使用 FFI

接下来，我们可以在 PHP 中使用 FFI 来调用这个 C 语言函数：

```php
<?php
// 加载 C 语言库
$ffi = FFI::cdef("
    int add(int a, int b);
", "libmath.so");

// 调用 C 语言函数
$result = $ffi->add(3, 4);
echo "The result is: " . $result; // 输出: The result is: 7
?>
```

### 4. 操作 C 语言数据结构

FFI 不仅可以调用 C 语言函数，还可以操作 C 语言数据结构。例如，我们可以定义一个结构体并在 PHP 中操作它：

```c
// math.h
typedef struct {
    int x;
    int y;
} Point;

void move(Point *p, int dx, int dy);
```

在 PHP 中，我们可以这样使用：

```php
<?php
$ffi = FFI::cdef("
    typedef struct {
        int x;
        int y;
    } Point;

    void move(Point *p, int dx, int dy);
", "libmath.so");

// 创建一个 Point 结构体
$point = $ffi->new("Point");
$point->x = 10;
$point->y = 20;

// 调用 move 函数
$ffi->move(FFI::addr($point), 5, -5);

echo "New position: ({$point->x}, {$point->y})"; // 输出: New position: (15, 15)
?>
```

## 实际应用场景

### 1. 调用系统库

FFI 可以用来调用系统库中的函数。例如，在 Linux 系统上，你可以使用 FFI 调用 `libc` 中的函数：

```php
<?php
$ffi = FFI::cdef("
    int printf(const char *format, ...);
", "libc.so.6");

$ffi->printf("Hello, %s!\n", "World"); // 输出: Hello, World!
?>
```

### 2. 高性能计算

对于需要高性能计算的场景，FFI 可以用来调用 C 语言编写的数学库，如 `libm`：

```php
<?php
$ffi = FFI::cdef("
    double sin(double x);
", "libm.so.6");

$result = $ffi->sin(M_PI / 2);
echo "sin(π/2) = " . $result; // 输出: sin(π/2) = 1
?>
```

## 总结

PHP FFI 扩展为 PHP 开发者提供了一个强大的工具，使他们能够直接调用 C 语言函数和操作 C 语言数据结构。通过 FFI，PHP 可以轻松地与现有的 C 语言库进行集成，从而扩展 PHP 的功能并提高性能。

## 附加资源

- [PHP 官方文档：FFI](https://www.php.net/manual/en/book.ffi.php)
- [C 语言教程](https://www.learn-c.org/)
- [PHP FFI 示例代码](https://github.com/php/php-src/tree/master/ext/ffi/tests)

## 练习

1. 尝试使用 FFI 调用一个 C 语言库中的函数，并返回一个字符串。
2. 使用 FFI 操作一个包含数组的 C 语言结构体，并在 PHP 中打印数组内容。
3. 研究如何在 Windows 系统上使用 FFI 调用系统库。

:::tip
在使用 FFI 时，务必注意内存管理和类型安全，避免潜在的安全问题。
:::