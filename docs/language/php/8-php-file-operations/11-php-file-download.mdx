---
title: PHP 文件下载
description: 学习如何在PHP中实现文件下载功能，包括设置HTTP头、读取文件内容并输出到客户端。
---

# PHP 文件下载

在Web开发中，文件下载是一个常见的需求。无论是下载用户上传的文件，还是提供静态资源供用户下载，PHP都可以轻松实现这一功能。本文将详细介绍如何使用PHP实现文件下载，并通过实际案例帮助你理解其应用场景。

## 什么是PHP文件下载？

PHP文件下载是指通过PHP脚本将服务器上的文件发送到客户端（通常是浏览器），以便用户可以下载并保存到本地。与直接提供文件链接不同，PHP文件下载允许我们在发送文件之前执行一些逻辑操作，例如权限检查、文件处理或动态生成文件内容。

## 实现文件下载的基本步骤

要实现文件下载，通常需要以下几个步骤：

1. **设置HTTP头**：通过设置适当的HTTP头，告诉浏览器这是一个需要下载的文件，而不是直接在浏览器中显示。
2. **读取文件内容**：从服务器读取文件内容。
3. **输出文件内容**：将文件内容发送到客户端。

### 1. 设置HTTP头

在PHP中，我们可以使用 `header()` 函数来设置HTTP头。以下是一些常用的HTTP头设置：

- `Content-Type`：指定文件的MIME类型。
- `Content-Disposition`：指定文件的下载方式（通常是 `attachment`，表示文件应下载而不是在浏览器中显示）。
- `Content-Length`：指定文件的大小。

```php
header('Content-Type: application/octet-stream');
header('Content-Disposition: attachment; filename="example.txt"');
header('Content-Length: ' . filesize('example.txt'));
```

### 2. 读取文件内容

使用 `readfile()` 函数可以轻松读取文件内容并将其发送到客户端。`readfile()` 函数会自动处理文件的读取和输出。

```php
readfile('example.txt');
```

### 3. 输出文件内容

将文件内容输出到客户端后，PHP脚本的执行将结束。通常，我们会在输出文件内容后使用 `exit()` 或 `die()` 来确保脚本不会继续执行。

```php
exit();
```

## 完整示例

以下是一个完整的PHP文件下载示例：

```php
<?php
$file = 'example.txt';

if (file_exists($file)) {
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . basename($file) . '"');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit;
} else {
    echo "文件不存在！";
}
?>
```

### 输入和输出

- **输入**：服务器上存在一个名为 `example.txt` 的文件。
- **输出**：浏览器将提示用户下载 `example.txt` 文件。

## 实际应用场景

### 1. 权限控制

在某些情况下，你可能希望限制文件的下载权限。例如，只有登录用户才能下载某些文件。你可以在文件下载之前检查用户的权限：

```php
<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    die("请先登录！");
}

$file = 'example.txt';

if (file_exists($file)) {
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . basename($file) . '"');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit;
} else {
    echo "文件不存在！";
}
?>
```

### 2. 动态生成文件

有时你可能需要动态生成文件内容并提供下载。例如，生成一个CSV文件并允许用户下载：

```php
<?php
$data = [
    ['Name', 'Email', 'Phone'],
    ['John Doe', 'john@example.com', '123-456-7890'],
    ['Jane Doe', 'jane@example.com', '098-765-4321']
];

$filename = 'users.csv';
$file = fopen($filename, 'w');

foreach ($data as $row) {
    fputcsv($file, $row);
}

fclose($file);

header('Content-Type: application/csv');
header('Content-Disposition: attachment; filename="' . $filename . '"');
header('Content-Length: ' . filesize($filename));
readfile($filename);
unlink($filename); // 删除临时文件
exit;
?>
```

## 总结

通过本文，你已经学会了如何在PHP中实现文件下载功能。我们介绍了设置HTTP头、读取文件内容并输出到客户端的基本步骤，并通过实际案例展示了文件下载的应用场景。

:::tip
在实际开发中，务必确保文件下载功能的安全性，避免用户下载未经授权的文件或敏感数据。
:::

## 附加资源

- [PHP官方文档 - header()](https://www.php.net/manual/en/function.header.php)
- [PHP官方文档 - readfile()](https://www.php.net/manual/en/function.readfile.php)

## 练习

1. 修改文件下载脚本，使其只能下载特定目录下的文件，防止用户通过路径遍历下载其他文件。
2. 实现一个功能，允许用户选择多个文件并打包下载。