---
title: PHP 文件锁定
description: 了解 PHP 文件锁定的概念及其在文件操作中的应用，掌握如何使用文件锁定来避免并发访问冲突。
---

## 介绍

在 PHP 中，文件锁定是一种用于控制多个进程或线程同时访问同一文件的机制。当多个脚本或用户同时尝试读取或写入同一个文件时，可能会导致数据不一致或文件损坏。文件锁定可以确保在同一时间内只有一个进程可以对文件进行操作，从而避免这些问题。

PHP 提供了 `flock()` 函数来实现文件锁定。通过 `flock()`，你可以对文件进行共享锁（读锁）或独占锁（写锁），从而控制文件的访问权限。

## 文件锁定的类型

PHP 中的文件锁定主要有两种类型：

1. **共享锁（LOCK_SH）**：允许多个进程同时读取文件，但阻止任何进程写入文件。适用于多个进程需要同时读取文件内容的场景。
2. **独占锁（LOCK_EX）**：只允许一个进程写入文件，并阻止其他进程读取或写入文件。适用于需要独占访问文件的场景。

此外，`flock()` 还支持非阻塞模式（`LOCK_NB`），可以在尝试获取锁时立即返回，而不会阻塞当前进程。

## 使用 `flock()` 函数

`flock()` 函数的语法如下：

```php
bool flock(resource $handle, int $operation, int &$would_block = null): bool
```

- `$handle`：文件资源句柄，通常通过 `fopen()` 函数打开文件后获得。
- `$operation`：锁定类型，可以是 `LOCK_SH`、`LOCK_EX`、`LOCK_UN`（释放锁）或它们的组合（如 `LOCK_EX | LOCK_NB`）。
- `$would_block`：可选参数，如果设置为非阻塞模式且锁不可用，此参数将被设置为 `1`。

### 示例：使用共享锁读取文件

以下示例展示了如何使用共享锁读取文件内容：

```php
<?php
$file = fopen("example.txt", "r");

if (flock($file, LOCK_SH)) {
    // 获取共享锁成功
    echo "文件内容：\n";
    while (!feof($file)) {
        echo fgets($file);
    }
    flock($file, LOCK_UN); // 释放锁
} else {
    echo "无法获取文件锁。";
}

fclose($file);
?>
```

### 示例：使用独占锁写入文件

以下示例展示了如何使用独占锁写入文件内容：

```php
<?php
$file = fopen("example.txt", "a");

if (flock($file, LOCK_EX)) {
    // 获取独占锁成功
    fwrite($file, "新内容\n");
    flock($file, LOCK_UN); // 释放锁
} else {
    echo "无法获取文件锁。";
}

fclose($file);
?>
```

## 实际应用场景

### 场景 1：日志文件写入

在 Web 应用程序中，多个请求可能同时尝试写入日志文件。如果不使用文件锁定，可能会导致日志内容混乱或丢失。通过使用独占锁，可以确保每次只有一个请求能够写入日志文件。

```php
<?php
$logFile = fopen("app.log", "a");

if (flock($logFile, LOCK_EX)) {
    fwrite($logFile, date("Y-m-d H:i:s") . " - 用户登录\n");
    flock($logFile, LOCK_UN);
} else {
    echo "无法获取日志文件锁。";
}

fclose($logFile);
?>
```

### 场景 2：配置文件读取

在读取配置文件时，如果多个进程同时读取文件，可能会导致读取到不一致的数据。通过使用共享锁，可以确保在读取文件时不会被其他进程修改。

```php
<?php
$configFile = fopen("config.ini", "r");

if (flock($configFile, LOCK_SH)) {
    $config = parse_ini_file($configFile);
    flock($configFile, LOCK_UN);
} else {
    echo "无法获取配置文件锁。";
}

fclose($configFile);
?>
```

## 总结

文件锁定是 PHP 中处理并发文件访问的重要机制。通过使用 `flock()` 函数，你可以有效地控制多个进程对同一文件的访问，避免数据不一致或文件损坏的问题。在实际应用中，文件锁定常用于日志写入、配置文件读取等场景。

:::tip 提示
- 使用文件锁定时，务必在操作完成后释放锁，以避免死锁。
- 非阻塞模式（`LOCK_NB`）可以在锁不可用时立即返回，适用于需要快速响应的场景。
:::

## 附加资源与练习

1. **练习**：尝试编写一个 PHP 脚本，模拟多个进程同时写入同一个文件，观察文件锁定的效果。
2. **进一步学习**：阅读 PHP 官方文档中关于 `flock()` 函数的更多细节：[PHP: flock - Manual](https://www.php.net/manual/en/function.flock.php)
3. **扩展阅读**：了解其他文件操作函数，如 `fopen()`、`fwrite()`、`fread()` 等，以全面掌握 PHP 文件操作。