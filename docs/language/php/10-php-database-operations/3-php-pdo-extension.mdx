---
title: PHP PDO扩展
description: 了解如何使用PHP的PDO扩展进行数据库操作，包括连接数据库、执行查询、处理结果集等。适合初学者学习PHP数据库操作。
---

# PHP PDO扩展

PHP Data Objects（PDO）是PHP中用于访问数据库的轻量级、一致性的接口。无论你使用的是MySQL、PostgreSQL还是SQLite，PDO都提供了一种统一的方式来与数据库进行交互。本文将带你逐步了解如何使用PDO扩展进行数据库操作。

## 什么是PDO？

PDO是PHP的一个数据库访问抽象层，它提供了一个统一的API来访问不同类型的数据库。与传统的数据库扩展（如`mysql`或`mysqli`）不同，PDO支持多种数据库，并且提供了更好的安全性和错误处理机制。

:::note
PDO并不提供数据库特定的功能，而是提供了一个统一的接口。这意味着你可以使用相同的代码来操作不同的数据库，只需更改连接字符串即可。
:::

## 连接数据库

使用PDO连接数据库非常简单。你需要提供数据库的DSN（数据源名称）、用户名和密码。以下是一个连接MySQL数据库的示例：

```php
<?php
$dsn = 'mysql:host=localhost;dbname=testdb';
$username = 'root';
$password = 'password';

try {
    $pdo = new PDO($dsn, $username, $password);
    echo "连接成功！";
} catch (PDOException $e) {
    echo "连接失败: " . $e->getMessage();
}
?>
```

### 解释
- `$dsn`：数据源名称，指定数据库类型、主机和数据库名称。
- `$username`：数据库用户名。
- `$password`：数据库密码。
- `new PDO()`：创建一个PDO实例，连接到数据库。
- `PDOException`：如果连接失败，PDO会抛出`PDOException`异常。

## 执行查询

连接数据库后，你可以使用PDO执行SQL查询。PDO提供了几种方法来执行查询，包括`exec()`、`query()`和`prepare()`。

### 使用`query()`执行查询

`query()`方法用于执行不需要参数的SQL语句，并返回一个`PDOStatement`对象。

```php
<?php
$sql = "SELECT * FROM users";
$stmt = $pdo->query($sql);

while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    echo "ID: " . $row['id'] . " - Name: " . $row['name'] . "<br />";
}
?>
```

### 解释
- `$sql`：SQL查询语句。
- `$pdo->query($sql)`：执行查询并返回结果集。
- `$stmt->fetch(PDO::FETCH_ASSOC)`：以关联数组的形式获取一行数据。

### 使用`prepare()`和`execute()`执行带参数的查询

对于需要参数的查询，建议使用`prepare()`和`execute()`方法，以防止SQL注入攻击。

```php
<?php
$sql = "SELECT * FROM users WHERE id = :id";
$stmt = $pdo->prepare($sql);
$stmt->execute(['id' => 1]);

$user = $stmt->fetch(PDO::FETCH_ASSOC);
echo "Name: " . $user['name'];
?>
```

### 解释
- `:id`：命名占位符，用于绑定参数。
- `$stmt->execute(['id' => 1])`：执行查询，并将参数绑定到占位符。

## 处理结果集

PDO提供了多种方法来处理查询结果集。你可以使用`fetch()`、`fetchAll()`等方法来获取数据。

### 使用`fetchAll()`获取所有结果

```php
<?php
$sql = "SELECT * FROM users";
$stmt = $pdo->query($sql);
$users = $stmt->fetchAll(PDO::FETCH_ASSOC);

foreach ($users as $user) {
    echo "ID: " . $user['id'] . " - Name: " . $user['name'] . "<br />";
}
?>
```

### 解释
- `$stmt->fetchAll(PDO::FETCH_ASSOC)`：以关联数组的形式获取所有结果。

## 事务处理

PDO还支持事务处理，允许你将多个操作作为一个原子单元执行。如果其中一个操作失败，整个事务将回滚。

```php
<?php
try {
    $pdo->beginTransaction();

    $pdo->exec("UPDATE accounts SET balance = balance - 100 WHERE id = 1");
    $pdo->exec("UPDATE accounts SET balance = balance + 100 WHERE id = 2");

    $pdo->commit();
    echo "事务成功！";
} catch (Exception $e) {
    $pdo->rollBack();
    echo "事务失败: " . $e->getMessage();
}
?>
```

### 解释
- `$pdo->beginTransaction()`：开始一个新事务。
- `$pdo->commit()`：提交事务。
- `$pdo->rollBack()`：回滚事务。

## 实际案例：用户注册系统

假设你正在开发一个用户注册系统，你需要将用户信息插入到数据库中。以下是一个使用PDO的示例：

```php
<?php
$dsn = 'mysql:host=localhost;dbname=testdb';
$username = 'root';
$password = 'password';

try {
    $pdo = new PDO($dsn, $username, $password);

    $name = 'John Doe';
    $email = 'john@example.com';
    $password = password_hash('password123', PASSWORD_DEFAULT);

    $sql = "INSERT INTO users (name, email, password) VALUES (:name, :email, :password)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        'name' => $name,
        'email' => $email,
        'password' => $password
    ]);

    echo "用户注册成功！";
} catch (PDOException $e) {
    echo "注册失败: " . $e->getMessage();
}
?>
```

### 解释
- `password_hash()`：对密码进行哈希处理，确保安全性。
- `$stmt->execute()`：将用户信息插入到数据库中。

## 总结

PDO是PHP中用于数据库操作的强大工具，它提供了统一的接口来访问不同类型的数据库。通过使用PDO，你可以编写更安全、更灵活的数据库代码。本文介绍了如何连接数据库、执行查询、处理结果集以及使用事务处理。希望这些内容能帮助你更好地理解和使用PDO扩展。

## 附加资源

- [PHP官方文档 - PDO](https://www.php.net/manual/en/book.pdo.php)
- [PDO教程 - W3Schools](https://www.w3schools.com/php/php_mysql_pdo.asp)

## 练习

1. 尝试使用PDO连接到一个SQLite数据库，并执行一个简单的查询。
2. 编写一个PHP脚本，使用PDO插入多条记录到数据库中，并使用事务确保所有记录都成功插入。
3. 修改用户注册系统的代码，添加对用户输入数据的验证和过滤。

:::tip
在编写数据库操作代码时，始终考虑安全性，避免SQL注入攻击。使用预处理语句和参数绑定是防止SQL注入的最佳实践。
:::