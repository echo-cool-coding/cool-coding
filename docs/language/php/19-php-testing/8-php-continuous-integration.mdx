---
title: PHP 持续集成
description: 了解PHP持续集成的基本概念、工具和实践方法，帮助初学者掌握如何自动化PHP项目的测试和部署流程。
---

# PHP 持续集成

## 介绍

持续集成（Continuous Integration，简称CI）是一种软件开发实践，旨在通过频繁地将代码集成到共享仓库中，并自动运行测试和构建，来尽早发现和修复问题。对于PHP开发者来说，持续集成可以帮助确保代码质量，减少手动测试和部署的工作量。

在本教程中，我们将介绍PHP持续集成的基本概念，并通过实际案例展示如何使用常见的CI工具来自动化PHP项目的测试和部署流程。

## 什么是持续集成？

持续集成的核心思想是**频繁地将代码变更集成到主分支**，并通过自动化工具进行构建和测试。这样可以确保每次代码变更都能快速得到验证，从而减少集成问题和错误。

对于PHP项目，持续集成通常包括以下步骤：

1. **代码提交**：开发者将代码提交到版本控制系统（如Git）。
2. **自动构建**：CI工具检测到代码变更后，自动拉取最新代码并运行构建脚本。
3. **自动测试**：运行单元测试、集成测试等，确保代码变更没有引入新的问题。
4. **报告生成**：生成测试报告和代码覆盖率报告，供开发者参考。
5. **部署**：如果测试通过，CI工具可以自动将代码部署到测试环境或生产环境。

## 常见的PHP持续集成工具

以下是一些常见的PHP持续集成工具：

- **GitHub Actions**：GitHub提供的CI/CD工具，支持PHP项目。
- **Travis CI**：一个流行的CI工具，支持多种编程语言，包括PHP。
- **CircleCI**：另一个流行的CI工具，支持PHP项目。
- **Jenkins**：一个开源的自动化服务器，支持PHP项目。

在本教程中，我们将以**GitHub Actions**为例，展示如何为PHP项目设置持续集成。

## 使用GitHub Actions进行PHP持续集成

### 1. 创建GitHub仓库

首先，确保你的PHP项目已经托管在GitHub上。如果还没有，可以创建一个新的GitHub仓库，并将你的PHP代码推送到该仓库。

### 2. 创建GitHub Actions工作流

GitHub Actions使用YAML文件来定义工作流。在你的项目根目录下创建一个名为`.github/workflows/ci.yml`的文件，并添加以下内容：

```yaml
name: PHP CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Run tests
        run: vendor/bin/phpunit
```

### 3. 解释工作流文件

- **on**: 定义了触发工作流的事件。在这个例子中，工作流会在`main`分支的`push`和`pull_request`事件时触发。
- **jobs**: 定义了工作流中的任务。在这个例子中，我们只有一个任务`build`。
- **runs-on**: 指定了运行任务的操作系统环境。这里我们使用`ubuntu-latest`。
- **steps**: 定义了任务中的步骤。每个步骤都是一个独立的操作。

### 4. 运行工作流

将`.github/workflows/ci.yml`文件推送到GitHub仓库后，GitHub Actions会自动检测到该文件，并在每次代码变更时运行定义的工作流。

你可以在GitHub仓库的“Actions”选项卡中查看工作流的运行状态和结果。

## 实际案例

假设我们有一个简单的PHP项目，包含一个计算器类和一个单元测试。以下是项目的结构：

```
my-php-project/
├── src/
│   └── Calculator.php
├── tests/
│   └── CalculatorTest.php
├── composer.json
└── .github/
    └── workflows/
        └── ci.yml
```

`src/Calculator.php`文件内容如下：

```php
<?php

class Calculator
{
    public function add($a, $b)
    {
        return $a + $b;
    }
}
```

`tests/CalculatorTest.php`文件内容如下：

```php
<?php

use PHPUnit\Framework\TestCase;

class CalculatorTest extends TestCase
{
    public function testAdd()
    {
        $calculator = new Calculator();
        $this->assertEquals(4, $calculator->add(2, 2));
    }
}
```

`composer.json`文件内容如下：

```json
{
    "require-dev": {
        "phpunit/phpunit": "^9.5"
    },
    "autoload": {
        "psr-4": {
            "App\\": "src/"
        }
    }
}
```

当我们推送代码到GitHub仓库时，GitHub Actions会自动运行单元测试，并生成测试报告。

## 总结

持续集成是确保PHP项目代码质量的重要手段。通过自动化构建、测试和部署流程，开发者可以更早地发现和修复问题，从而提高开发效率和代码质量。

在本教程中，我们介绍了持续集成的基本概念，并通过GitHub Actions展示了如何为PHP项目设置持续集成。希望这些内容能帮助你更好地理解和应用持续集成。

## 附加资源

- [GitHub Actions 官方文档](https://docs.github.com/en/actions)
- [PHPUnit 官方文档](https://phpunit.de/documentation.html)
- [Composer 官方文档](https://getcomposer.org/doc/)

## 练习

1. 尝试为你的PHP项目设置GitHub Actions工作流，并运行单元测试。
2. 修改`Calculator.php`中的`add`方法，使其返回错误的结果，观察GitHub Actions的测试结果。
3. 探索其他CI工具（如Travis CI或CircleCI），并尝试为你的PHP项目设置持续集成。