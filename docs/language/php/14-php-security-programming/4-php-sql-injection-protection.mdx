---
title: PHP SQL注入防护
description: 了解什么是SQL注入攻击，以及如何在PHP中通过最佳实践防止SQL注入，保护你的应用程序安全。
---

# PHP SQL注入防护

SQL注入是一种常见的Web应用程序安全漏洞，攻击者可以通过恶意构造的SQL查询来操纵数据库，从而窃取、修改或删除数据。对于PHP开发者来说，理解并防范SQL注入是至关重要的。本文将详细介绍SQL注入的原理、危害以及如何在PHP中有效防护。

## 什么是SQL注入？

SQL注入（SQL Injection）是一种攻击技术，攻击者通过在应用程序的输入字段中插入恶意SQL代码，从而绕过应用程序的安全机制，直接与数据库交互。这种攻击可能导致数据泄露、数据篡改，甚至整个数据库的破坏。

### SQL注入示例

假设我们有一个简单的登录表单，用户输入用户名和密码后，PHP代码会生成以下SQL查询：

```php
$username = $_POST['username'];
$password = $_POST['password'];
$sql = "SELECT * FROM users WHERE username='$username' AND password='$password'";
```

如果用户输入的用户名是 `admin`，密码是 `' OR '1'='1`，那么生成的SQL查询将变为：

```sql
SELECT * FROM users WHERE username='admin' AND password='' OR '1'='1';
```

由于 `'1'='1'` 始终为真，攻击者可以绕过密码验证，直接登录系统。

## 如何防止SQL注入？

为了防止SQL注入，PHP开发者可以采用以下几种方法：

### 1. 使用预处理语句（Prepared Statements）

预处理语句是防止SQL注入的最有效方法之一。通过使用预处理语句，SQL查询的结构和参数被分开处理，从而防止恶意SQL代码的注入。

#### 使用PDO的预处理语句

```php
$pdo = new PDO('mysql:host=localhost;dbname=test', 'username', 'password');
$stmt = $pdo->prepare('SELECT * FROM users WHERE username = :username AND password = :password');
$stmt->execute(['username' => $username, 'password' => $password]);
$user = $stmt->fetch();
```

#### 使用MySQLi的预处理语句

```php
$mysqli = new mysqli('localhost', 'username', 'password', 'test');
$stmt = $mysqli->prepare('SELECT * FROM users WHERE username = ? AND password = ?');
$stmt->bind_param('ss', $username, $password);
$stmt->execute();
$result = $stmt->get_result();
$user = $result->fetch_assoc();
```

### 2. 使用参数化查询

参数化查询与预处理语句类似，都是将SQL查询与参数分开处理。参数化查询可以确保用户输入的数据不会被解释为SQL代码。

### 3. 输入验证和过滤

虽然预处理语句是防止SQL注入的最佳实践，但输入验证和过滤仍然是必要的。通过验证用户输入的数据类型、长度和格式，可以减少恶意输入的风险。

```php
if (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {
    die('Invalid username');
}
```

### 4. 使用ORM（对象关系映射）

ORM框架（如Doctrine、Eloquent）可以自动处理SQL查询的生成和执行，从而减少手动编写SQL代码的机会，降低SQL注入的风险。

```php
$user = User::where('username', $username)->where('password', $password)->first();
```

## 实际案例

假设我们有一个电子商务网站，用户可以通过搜索框查找商品。如果不对用户输入进行防护，攻击者可以通过输入恶意SQL代码来获取所有商品信息。

### 未防护的代码

```php
$search = $_GET['search'];
$sql = "SELECT * FROM products WHERE name LIKE '%$search%'";
$result = $mysqli->query($sql);
```

如果用户输入 `'; DROP TABLE products; --`，那么生成的SQL查询将变为：

```sql
SELECT * FROM products WHERE name LIKE '%'; DROP TABLE products; --%';
```

这将导致 `products` 表被删除。

### 防护后的代码

```php
$search = $_GET['search'];
$stmt = $mysqli->prepare('SELECT * FROM products WHERE name LIKE ?');
$search = "%$search%";
$stmt->bind_param('s', $search);
$stmt->execute();
$result = $stmt->get_result();
```

通过使用预处理语句，攻击者无法通过输入恶意SQL代码来操纵数据库。

## 总结

SQL注入是一种严重的安全威胁，但通过使用预处理语句、参数化查询、输入验证和ORM等技术，可以有效防止SQL注入攻击。作为PHP开发者，始终应该将安全性放在首位，确保应用程序的数据安全。

## 附加资源

- [OWASP SQL Injection Prevention Cheat Sheet](https://owasp.org/www-project-cheat-sheets/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [PHP Manual: PDO](https://www.php.net/manual/en/book.pdo.php)
- [PHP Manual: MySQLi](https://www.php.net/manual/en/book.mysqli.php)

## 练习

1. 修改以下代码，使用预处理语句防止SQL注入：

```php
$id = $_GET['id'];
$sql = "SELECT * FROM users WHERE id = $id";
$result = $mysqli->query($sql);
```

2. 编写一个PHP函数，验证用户输入的用户名是否符合以下要求：
   - 只包含字母、数字和下划线
   - 长度在3到20个字符之间

```php
function validateUsername($username) {
    // 你的代码
}
```

通过完成这些练习，你将更好地理解如何在实际项目中防止SQL注入。