---
title: PHP 目录遍历漏洞
description: 了解PHP目录遍历漏洞的原理、危害以及如何防范。本文适合初学者，包含代码示例和实际案例分析。
---

## 什么是PHP目录遍历漏洞？

PHP目录遍历漏洞（Directory Traversal Vulnerability）是一种常见的安全漏洞，攻击者通过操纵文件路径参数，访问服务器上本应受限的文件或目录。这种漏洞通常发生在应用程序未对用户输入进行严格验证或过滤的情况下。

### 漏洞原理

目录遍历漏洞的核心在于攻击者能够通过构造特殊的文件路径，绕过应用程序的正常文件访问逻辑。例如，如果应用程序允许用户通过URL参数指定文件路径，攻击者可能会通过输入类似 `../../../../etc/passwd` 的路径，访问服务器上的敏感文件。

## 代码示例

以下是一个简单的PHP代码示例，展示了目录遍历漏洞的产生：

```php
<?php
$file = $_GET['file'];
include('/var/www/html/' . $file);
?>
```

在这个例子中，`file` 参数直接从用户输入中获取，并直接拼接到文件路径中。如果用户输入 `../../../../etc/passwd`，那么服务器可能会返回 `/etc/passwd` 文件的内容。

### 输入与输出

**输入：**
```
http://example.com/script.php?file=../../../../etc/passwd
```

**输出：**
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

## 实际案例

### 案例1：文件泄露

假设一个网站允许用户下载文件，文件路径通过URL参数传递。如果未对路径进行验证，攻击者可以通过构造恶意路径，下载服务器上的任意文件。

**示例URL：**
```
http://example.com/download.php?file=../../../../etc/passwd
```

### 案例2：配置文件泄露

另一个常见的场景是配置文件泄露。许多应用程序将配置文件存储在服务器上，如果这些文件被泄露，攻击者可以获取数据库凭据、API密钥等敏感信息。

**示例URL：**
```
http://example.com/config.php?file=../../../../var/www/config/database.php
```

## 如何防范目录遍历漏洞

### 1. 输入验证

始终对用户输入进行严格的验证。确保文件路径参数只包含预期的字符，并限制路径的范围。

```php
<?php
$file = $_GET['file'];
if (preg_match('/^[a-zA-Z0-9_\-\.]+$/', $file)) {
    include('/var/www/html/' . $file);
} else {
    die('Invalid file name');
}
?>
```

### 2. 使用白名单

维护一个允许访问的文件白名单，确保用户只能访问这些文件。

```php
<?php
$allowed_files = ['file1.php', 'file2.php'];
$file = $_GET['file'];
if (in_array($file, $allowed_files)) {
    include('/var/www/html/' . $file);
} else {
    die('Access denied');
}
?>
```

### 3. 使用绝对路径

避免使用相对路径，始终使用绝对路径来引用文件。

```php
<?php
$base_dir = '/var/www/html/';
$file = $_GET['file'];
$real_path = realpath($base_dir . $file);
if (strpos($real_path, $base_dir) === 0) {
    include($real_path);
} else {
    die('Access denied');
}
?>
```

## 总结

PHP目录遍历漏洞是一种严重的安全问题，可能导致敏感文件泄露。通过严格的输入验证、使用白名单和绝对路径，可以有效防范此类漏洞。

:::tip
**附加资源：**
- [OWASP Directory Traversal](https://owasp.org/www-community/attacks/Path_Traversal)
- [PHP Security Best Practices](https://www.php.net/manual/en/security.php)
:::

:::caution
**练习：**
尝试在本地环境中模拟一个目录遍历漏洞，并使用上述方法进行修复。
:::