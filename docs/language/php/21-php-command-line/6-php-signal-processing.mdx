---
title: PHP 信号处理
description: 了解如何在PHP命令行脚本中处理信号，以实现优雅的进程控制和资源清理。
---

# PHP 信号处理

在编写PHP命令行脚本时，信号处理是一个重要的概念。信号是操作系统用来通知进程发生了某些事件的一种机制。例如，当用户按下 `Ctrl+C` 终止进程时，操作系统会向进程发送一个 `SIGINT` 信号。通过捕获和处理这些信号，你可以确保你的脚本在退出时能够优雅地关闭资源或执行其他必要的清理操作。

## 什么是信号？

信号是操作系统向进程发送的一种异步通知。它们通常用于通知进程发生了某些事件，例如：

- `SIGINT`：用户按下 `Ctrl+C` 终止进程。
- `SIGTERM`：请求进程终止。
- `SIGHUP`：终端挂起或控制进程终止。

在PHP中，你可以使用 `pcntl_signal` 函数来捕获这些信号并定义处理程序。

## 捕获信号

要在PHP中捕获信号，你需要使用 `pcntl_signal` 函数。这个函数允许你为特定的信号注册一个处理程序。以下是一个简单的示例，展示了如何捕获 `SIGINT` 信号：

```php
<?php
declare(ticks = 1);

function handleSignal($signal) {
    switch ($signal) {
        case SIGINT:
            echo "Caught SIGINT! Exiting gracefully...\n";
            exit(0);
        default:
            echo "Caught signal $signal\n";
    }
}

pcntl_signal(SIGINT, 'handleSignal');

echo "Running... Press Ctrl+C to exit.\n";

while (true) {
    // 模拟一些工作
    sleep(1);
}
```

在这个示例中，我们定义了一个 `handleSignal` 函数来处理信号。当用户按下 `Ctrl+C` 时，`SIGINT` 信号会被捕获，并调用 `handleSignal` 函数。函数会输出一条消息并优雅地退出脚本。

:::note
`declare(ticks = 1);` 是必要的，因为它允许PHP在每条语句执行后检查是否有信号到达。如果没有这个声明，信号处理程序可能不会立即被调用。
:::

## 实际应用场景

信号处理在实际应用中有很多用途。以下是一些常见的场景：

1. **优雅地关闭资源**：如果你的脚本打开了文件、数据库连接或其他资源，你可以在捕获信号时关闭这些资源，以避免资源泄漏。

2. **长时间运行的任务**：如果你的脚本执行长时间运行的任务，你可以捕获信号来中断任务并保存当前状态，以便稍后恢复。

3. **多进程管理**：在管理多个子进程时，信号处理可以帮助你控制子进程的生命周期，例如在父进程收到终止信号时终止所有子进程。

## 示例：优雅地关闭资源

以下是一个更复杂的示例，展示了如何在捕获信号时关闭文件资源：

```php
<?php
declare(ticks = 1);

$file = fopen('output.txt', 'w');

function handleSignal($signal) {
    global $file;
    switch ($signal) {
        case SIGINT:
            echo "Caught SIGINT! Closing file and exiting...\n";
            fclose($file);
            exit(0);
        default:
            echo "Caught signal $signal\n";
    }
}

pcntl_signal(SIGINT, 'handleSignal');

echo "Running... Press Ctrl+C to exit.\n";

while (true) {
    // 模拟一些工作
    fwrite($file, "Working...\n");
    sleep(1);
}
```

在这个示例中，当用户按下 `Ctrl+C` 时，脚本会捕获 `SIGINT` 信号，关闭打开的文件，并优雅地退出。

## 总结

信号处理是PHP命令行脚本中一个强大的工具，允许你捕获和处理操作系统发送的信号。通过使用 `pcntl_signal` 函数，你可以确保你的脚本在退出时能够优雅地关闭资源或执行其他必要的清理操作。

## 附加资源

- [PHP官方文档：pcntl_signal](https://www.php.net/manual/en/function.pcntl-signal.php)
- [Unix信号列表](https://en.wikipedia.org/wiki/Signal_(IPC))

## 练习

1. 修改上面的示例，使其捕获 `SIGTERM` 信号并输出不同的消息。
2. 编写一个脚本，在捕获信号时保存当前的工作状态到一个文件中，以便稍后恢复。

通过这些练习，你将更深入地理解PHP信号处理的概念和应用。