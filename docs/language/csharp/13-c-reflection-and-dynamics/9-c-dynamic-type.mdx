---
title: C# 动态类型
description: "了解 C# 中的动态类型（dynamic），探索其工作原理、使用场景以及如何在实际项目中应用动态类型。"
---

## 介绍

在 C# 中，`dynamic` 是一种特殊的类型，它允许你在编译时绕过类型检查，将类型检查推迟到运行时。这意味着你可以编写更灵活的代码，尤其是在处理未知类型或与动态语言（如 Python 或 JavaScript）交互时。

`dynamic` 类型的主要特点是：
- **运行时类型解析**：类型检查在运行时进行，而不是编译时。
- **灵活性**：可以调用任何方法或访问任何属性，即使它们在编译时不存在。
- **性能开销**：由于类型检查在运行时进行，可能会带来一定的性能开销。

:::note
`dynamic` 类型与 `var` 关键字不同。`var` 是隐式类型推断，类型在编译时确定；而 `dynamic` 的类型在运行时确定。
:::

## 基本用法

### 声明动态变量

你可以使用 `dynamic` 关键字声明一个动态变量：

```csharp
dynamic myDynamicVariable = 10;
Console.WriteLine(myDynamicVariable); // 输出: 10

myDynamicVariable = "Hello, World!";
Console.WriteLine(myDynamicVariable); // 输出: Hello, World!
```

在上面的例子中，`myDynamicVariable` 首先被赋值为整数 `10`，然后被赋值为字符串 `"Hello, World!"`。由于 `dynamic` 类型的灵活性，这种操作是完全合法的。

### 调用动态方法

`dynamic` 类型允许你在运行时调用方法，即使这些方法在编译时不存在：

```csharp
dynamic myObject = new ExpandoObject();
myObject.SayHello = new Action(() => Console.WriteLine("Hello from dynamic object!"));

myObject.SayHello(); // 输出: Hello from dynamic object!
```

在这个例子中，我们使用 `ExpandoObject` 创建了一个动态对象，并为其添加了一个 `SayHello` 方法。由于 `dynamic` 类型的特性，我们可以在运行时调用这个方法。

## 动态类型的实际应用

### 与动态语言交互

`dynamic` 类型在与动态语言（如 Python 或 JavaScript）交互时非常有用。例如，使用 `IronPython` 库在 C# 中调用 Python 代码：

```csharp
using IronPython.Hosting;

var engine = Python.CreateEngine();
dynamic py = engine.ExecuteFile("script.py");

py.SayHello(); // 假设 script.py 中定义了 SayHello 函数
```

在这个例子中，`dynamic` 类型允许我们调用 Python 脚本中的函数，而无需在编译时知道这些函数的存在。

### 处理 JSON 数据

在处理 JSON 数据时，`dynamic` 类型也非常有用。例如，使用 `Newtonsoft.Json` 库解析 JSON 字符串：

```csharp
using Newtonsoft.Json;

string json = "{\"name\":\"John\", \"age\":30}";
dynamic data = JsonConvert.DeserializeObject<dynamic>(json);

Console.WriteLine(data.name); // 输出: John
Console.WriteLine(data.age);  // 输出: 30
```

在这个例子中，`dynamic` 类型允许我们轻松访问 JSON 对象中的属性，而无需定义具体的类。

## 动态类型的注意事项

虽然 `dynamic` 类型提供了极大的灵活性，但在使用时需要注意以下几点：

1. **性能开销**：由于类型检查在运行时进行，`dynamic` 类型的性能通常不如静态类型。
2. **运行时错误**：如果调用的方法或属性不存在，程序将在运行时抛出异常。
3. **可读性和维护性**：过度使用 `dynamic` 类型可能会降低代码的可读性和维护性。

:::caution
在使用 `dynamic` 类型时，务必确保你了解其潜在的风险，并在必要时进行异常处理。
:::

## 总结

`dynamic` 类型是 C# 中一个强大的工具，它允许你在运行时处理未知类型或与动态语言交互。尽管它提供了极大的灵活性，但也带来了性能开销和运行时错误的风险。因此，在使用 `dynamic` 类型时，需要权衡其优缺点，并确保代码的可读性和可维护性。

## 附加资源与练习

### 练习

1. 创建一个动态对象，并为其添加多个属性和方法。尝试在运行时调用这些方法。
2. 使用 `Newtonsoft.Json` 解析一个复杂的 JSON 字符串，并尝试访问其中的嵌套属性。

### 进一步阅读

- [C# 官方文档：dynamic 类型](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/reference-types#the-dynamic-type)
- [Newtonsoft.Json 文档](https://www.newtonsoft.com/json)
- [IronPython 文档](https://ironpython.net/)

通过以上内容，你应该对 C# 中的 `dynamic` 类型有了更深入的理解。继续练习和探索，你将能够更好地掌握这一强大的特性。