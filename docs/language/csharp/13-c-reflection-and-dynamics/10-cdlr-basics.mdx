---
title: C# DLR 基础
description: 了解 C# 动态语言运行时（DLR）的基础知识，探索其工作原理、使用场景以及如何在实际项目中应用。
---

## 介绍

C# 动态语言运行时（Dynamic Language Runtime，简称 DLR）是 .NET 框架中的一个组件，它为动态语言（如 Python、Ruby 等）提供了运行时支持，同时也为 C# 提供了动态编程的能力。DLR 的核心目标是简化动态语言的实现，并允许静态语言（如 C#）与动态语言无缝交互。

DLR 的主要功能包括：
- 动态类型解析
- 动态方法调用
- 动态对象创建
- 与动态语言的互操作性

通过 DLR，C# 开发者可以在静态类型语言中享受动态语言的灵活性，同时保持类型安全和性能。

## DLR 的核心概念

### 动态类型

在 C# 中，`dynamic` 关键字用于声明动态类型。与 `var` 不同，`dynamic` 类型的变量在编译时不会进行类型检查，而是在运行时解析。

```csharp
dynamic myVar = 10;
Console.WriteLine(myVar); // 输出: 10

myVar = "Hello, DLR!";
Console.WriteLine(myVar); // 输出: Hello, DLR!
```

:::note
`dynamic` 类型的变量可以在运行时改变其类型，而不会引发编译错误。
:::

### ExpandoObject

`ExpandoObject` 是 DLR 提供的一个动态对象，允许在运行时动态添加属性和方法。

```csharp
dynamic person = new ExpandoObject();
person.Name = "John";
person.Age = 30;
person.SayHello = new Action(() => Console.WriteLine($"Hello, my name is {person.Name}"));

Console.WriteLine(person.Name); // 输出: John
person.SayHello(); // 输出: Hello, my name is John
```

:::tip
`ExpandoObject` 非常适合用于需要动态扩展对象的场景，例如处理 JSON 数据或与动态语言交互。
:::

### DynamicObject

`DynamicObject` 是一个基类，允许开发者创建自定义的动态对象。通过重写 `TryGetMember` 和 `TrySetMember` 等方法，可以实现自定义的动态行为。

```csharp
public class DynamicPerson : DynamicObject
{
    private Dictionary<string, object> _properties = new Dictionary<string, object>();

    public override bool TryGetMember(GetMemberBinder binder, out object result)
    {
        return _properties.TryGetValue(binder.Name, out result);
    }

    public override bool TrySetMember(SetMemberBinder binder, object value)
    {
        _properties[binder.Name] = value;
        return true;
    }
}

dynamic person = new DynamicPerson();
person.Name = "Jane";
person.Age = 25;

Console.WriteLine(person.Name); // 输出: Jane
Console.WriteLine(person.Age); // 输出: 25
```

:::caution
`DynamicObject` 提供了更高的灵活性，但也需要更多的代码来实现自定义行为。
:::

## 实际应用场景

### 与动态语言交互

DLR 使得 C# 可以轻松与动态语言（如 Python）交互。例如，使用 `IronPython` 库可以在 C# 中执行 Python 代码。

```csharp
using IronPython.Hosting;

var engine = Python.CreateEngine();
dynamic py = engine.Execute("2 + 3");
Console.WriteLine(py); // 输出: 5
```

### 动态数据处理

在处理 JSON 或 XML 数据时，DLR 可以简化数据的解析和操作。

```csharp
dynamic json = JsonConvert.DeserializeObject<ExpandoObject>("{\"name\":\"Alice\",\"age\":28}");
Console.WriteLine(json.name); // 输出: Alice
Console.WriteLine(json.age); // 输出: 28
```

## 总结

C# 动态语言运行时（DLR）为开发者提供了强大的动态编程能力，使得 C# 不仅可以与动态语言无缝交互，还能在静态类型语言中实现动态行为。通过 `dynamic` 关键字、`ExpandoObject` 和 `DynamicObject`，开发者可以灵活地处理动态数据、扩展对象行为，并在实际项目中应用这些技术。

## 附加资源与练习

- **练习 1**: 创建一个 `DynamicObject` 子类，实现动态添加和删除属性的功能。
- **练习 2**: 使用 `ExpandoObject` 解析一个复杂的 JSON 数据，并动态访问其中的字段。
- **资源**: 阅读 [DLR 官方文档](https://docs.microsoft.com/en-us/dotnet/framework/reflection-and-codedom/dynamic-language-runtime-overview) 以深入了解 DLR 的工作原理。

:::warning
动态编程虽然灵活，但也可能导致运行时错误。请确保在使用 `dynamic` 时进行充分的测试。
:::