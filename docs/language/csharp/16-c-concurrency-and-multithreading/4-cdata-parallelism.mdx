---
title: C# 数据并行
description: "学习如何在 C# 中使用数据并行技术来加速处理大量数据的任务。本文将从基础概念讲起，逐步深入，并通过代码示例和实际案例帮助你掌握数据并行的核心思想。"
---

## 介绍

在编程中，**数据并行**是一种并行计算技术，它通过将数据分割成多个部分，并在多个处理器或线程上同时处理这些部分来加速任务的执行。C# 提供了强大的工具来实现数据并行，其中最常用的是 `Parallel.For` 和 `Parallel.ForEach` 方法。

数据并行特别适用于处理大量数据的场景，例如图像处理、数据分析或科学计算。通过并行化这些任务，你可以显著减少处理时间，充分利用多核处理器的性能。

## 数据并行的基本概念

数据并行的核心思想是将数据分成多个独立的块，然后并行处理这些块。每个块可以由不同的线程或处理器处理，从而加快整体处理速度。

在 C# 中，`System.Threading.Tasks.Parallel` 类提供了实现数据并行的工具。以下是两个最常用的方法：

- `Parallel.For`：用于并行执行一个循环，其中每次迭代都是独立的。
- `Parallel.ForEach`：用于并行处理集合中的每个元素。

### Parallel.For 示例

以下是一个简单的 `Parallel.For` 示例，它并行计算一个数组中每个元素的平方：

```csharp
using System;
using System.Threading.Tasks;

class Program
{
    static void Main()
    {
        int[] numbers = { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };
        int[] squares = new int[numbers.Length];

        Parallel.For(0, numbers.Length, i =>
        {
            squares[i] = numbers[i] * numbers[i];
        });

        Console.WriteLine("Squares:");
        foreach (var square in squares)
        {
            Console.Write(square + " ");
        }
    }
}
```

**输出：**
```
Squares:
1 4 9 16 25 36 49 64 81 100
```

在这个示例中，`Parallel.For` 方法并行地计算了数组中每个元素的平方。由于每次迭代都是独立的，因此可以安全地并行执行。

### Parallel.ForEach 示例

`Parallel.ForEach` 方法用于并行处理集合中的每个元素。以下是一个示例，它并行计算一个列表中每个字符串的长度：

```csharp
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

class Program
{
    static void Main()
    {
        List<string> words = new List<string> { "apple", "banana", "cherry", "date", "elderberry" };
        int[] lengths = new int[words.Count];

        Parallel.ForEach(words, (word, state, index) =>
        {
            lengths[index] = word.Length;
        });

        Console.WriteLine("Word lengths:");
        foreach (var length in lengths)
        {
            Console.Write(length + " ");
        }
    }
}
```

**输出：**
```
Word lengths:
5 6 6 4 10
```

在这个示例中，`Parallel.ForEach` 方法并行地计算了列表中每个字符串的长度。

## 数据并行的实际应用

数据并行在许多实际场景中都非常有用。以下是一些常见的应用场景：

1. **图像处理**：在图像处理中，通常需要对每个像素进行相同的操作。通过数据并行，可以将图像分割成多个部分，并并行处理这些部分，从而加快处理速度。

2. **数据分析**：在数据分析中，通常需要对大量数据进行相同的计算。通过数据并行，可以将数据分割成多个块，并并行处理这些块，从而加快分析速度。

3. **科学计算**：在科学计算中，通常需要进行大量的数值计算。通过数据并行，可以将计算任务分配给多个处理器或线程，从而加快计算速度。

### 实际案例：并行图像处理

假设你有一个图像处理任务，需要对图像中的每个像素进行灰度化处理。以下是一个使用 `Parallel.For` 实现的简单示例：

```csharp
using System;
using System.Drawing;
using System.Threading.Tasks;

class Program
{
    static void Main()
    {
        Bitmap image = new Bitmap("input.jpg");
        Bitmap grayImage = new Bitmap(image.Width, image.Height);

        Parallel.For(0, image.Height, y =>
        {
            for (int x = 0; x < image.Width; x++)
            {
                Color pixel = image.GetPixel(x, y);
                int gray = (int)(pixel.R * 0.3 + pixel.G * 0.59 + pixel.B * 0.11);
                grayImage.SetPixel(x, y, Color.FromArgb(gray, gray, gray));
            }
        });

        grayImage.Save("output.jpg");
        Console.WriteLine("Image processing complete.");
    }
}
```

在这个示例中，`Parallel.For` 方法并行地处理了图像中的每一行像素，从而加快了灰度化处理的速度。

## 总结

数据并行是一种强大的技术，可以显著加速处理大量数据的任务。通过使用 C# 中的 `Parallel.For` 和 `Parallel.ForEach` 方法，你可以轻松地将任务并行化，从而充分利用多核处理器的性能。

在实际应用中，数据并行可以用于图像处理、数据分析、科学计算等场景。通过合理地分割数据和并行处理，你可以显著提高程序的性能。

## 附加资源与练习

- **练习 1**：修改 `Parallel.For` 示例，使其并行计算一个数组中每个元素的立方。
- **练习 2**：使用 `Parallel.ForEach` 方法并行处理一个包含 1000 个随机数的列表，计算每个数的平方根。
- **附加资源**：阅读 [Microsoft 官方文档](https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/data-parallelism-task-parallel-library) 以了解更多关于数据并行的内容。

:::tip
在并行化任务时，务必注意线程安全问题。确保每个线程或任务不会同时访问和修改共享资源，以避免竞态条件。
:::