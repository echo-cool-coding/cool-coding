---
title: C# 源代码生成
description: 了解 C# 源代码生成的概念、工作原理及其在实际开发中的应用场景。本文适合初学者，包含代码示例和实际案例。
---

## 介绍

C# 源代码生成（Source Generation）是 C# 9.0 引入的一项强大功能，它允许开发者在编译时动态生成代码。通过源代码生成，开发者可以减少重复代码、提高性能，并增强代码的可维护性。本文将逐步介绍 C# 源代码生成的基本概念、工作原理以及实际应用场景。

:::note
源代码生成在编译时运行，生成的代码会成为项目的一部分，但不会直接修改原始代码文件。
:::

## 源代码生成的工作原理

源代码生成器是一个特殊的类库，它在编译过程中被调用，并生成额外的 C# 代码。这些生成的代码会被编译到最终的程序集中。源代码生成器通常用于以下场景：

- 自动生成重复性代码（如数据模型、DTO 等）。
- 根据特定规则生成代码（如序列化、反序列化逻辑）。
- 优化性能（如减少运行时反射的使用）。

### 源代码生成器的基本结构

一个源代码生成器通常包含以下部分：

1. **生成器类**：继承自 `ISourceGenerator` 接口，负责生成代码。
2. **初始化方法**：用于注册生成器。
3. **执行方法**：在编译时被调用，生成代码。

以下是一个简单的源代码生成器示例：

```csharp
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System.Text;

[Generator]
public class HelloWorldGenerator : ISourceGenerator
{
    public void Initialize(GeneratorInitializationContext context)
    {
        // 初始化逻辑（可选）
    }

    public void Execute(GeneratorExecutionContext context)
    {
        // 生成代码
        string sourceCode = @"
namespace GeneratedCode
{
    public static class HelloWorld
    {
        public static void SayHello()
        {
            System.Console.WriteLine(""Hello, Generated World!"");
        }
    }
}";
        context.AddSource("HelloWorld.g.cs", SourceText.From(sourceCode, Encoding.UTF8));
    }
}
```

### 代码生成示例

假设我们有一个简单的控制台应用程序，引用上述源代码生成器。编译后，生成的代码会被添加到项目中，并可以通过以下方式调用：

```csharp
using GeneratedCode;

class Program
{
    static void Main(string[] args)
    {
        HelloWorld.SayHello(); // 输出: Hello, Generated World!
    }
}
```

:::tip
生成的代码文件通常以 `.g.cs` 结尾，以便与手写代码区分开。
:::

## 实际应用场景

### 1. 自动生成数据模型

在开发中，我们经常需要为数据库表或 API 响应创建数据模型。通过源代码生成器，可以根据数据库架构或 API 文档自动生成这些模型，从而减少手动编写的工作量。

```csharp
// 示例：根据数据库表生成数据模型
public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}
```

### 2. 优化序列化性能

在需要高性能序列化的场景中，源代码生成器可以生成专门的序列化代码，避免使用运行时反射，从而提高性能。

```csharp
// 示例：生成 JSON 序列化代码
public static string SerializeUser(User user)
{
    return $@"{{ ""Id"": {user.Id}, ""Name"": ""{user.Name}"", ""Email"": ""{user.Email}"" }}";
}
```

### 3. 生成测试代码

源代码生成器可以自动生成单元测试代码，减少开发者的工作量。

```csharp
// 示例：生成单元测试
[TestClass]
public class UserTests
{
    [TestMethod]
    public void TestUserProperties()
    {
        var user = new User { Id = 1, Name = "John", Email = "john@example.com" };
        Assert.AreEqual(1, user.Id);
        Assert.AreEqual("John", user.Name);
        Assert.AreEqual("john@example.com", user.Email);
    }
}
```

## 总结

C# 源代码生成是一项强大的功能，它可以帮助开发者减少重复代码、提高性能，并增强代码的可维护性。通过本文的介绍，你应该对源代码生成的基本概念、工作原理以及实际应用场景有了初步了解。

:::caution
源代码生成器虽然强大，但过度使用可能会导致代码难以理解和维护。建议在必要时使用，并确保生成的代码清晰易懂。
:::

## 附加资源与练习

- **官方文档**：[C# 源代码生成器](https://learn.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/source-generators-overview)
- **练习**：尝试创建一个源代码生成器，自动生成一个简单的 `ToString` 方法，用于打印类的所有属性。

```csharp
// 示例：生成 ToString 方法
public override string ToString()
{
    return $@"Id: {Id}, Name: {Name}, Email: {Email}";
}
```

希望本文能帮助你更好地理解 C# 源代码生成的概念和应用！如果你有任何问题，欢迎在评论区留言讨论。