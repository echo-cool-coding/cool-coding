---
title: C# 互操作性
description: 了解如何在 C# 中实现与外部代码（如非托管代码、COM 组件或其他语言编写的库）的互操作性，并通过实际案例掌握其应用场景。
---

## 介绍

C# 是一种强大的编程语言，广泛用于开发各种应用程序。然而，在某些情况下，我们可能需要与外部代码（如非托管代码、COM 组件或其他语言编写的库）进行交互。这就是 **C# 互操作性**（Interoperability）的用武之地。通过互操作性，C# 可以与其他语言或平台无缝协作，扩展其功能。

在本教程中，我们将逐步讲解 C# 互操作性的核心概念，并通过代码示例和实际案例帮助你理解其应用场景。

---

## 什么是 C# 互操作性？

C# 互操作性是指 C# 代码与其他编程语言或平台（如 C/C++、COM、Python 等）进行交互的能力。这种能力通常用于以下场景：

1. **调用非托管代码**：例如调用 C/C++ 编写的动态链接库（DLL）。
2. **与 COM 组件交互**：例如调用 Windows API 或 Office 应用程序。
3. **与其他语言编写的库交互**：例如通过 Python 或 Java 编写的库。

C# 提供了多种机制来实现互操作性，包括 **P/Invoke**、**COM Interop** 和 **动态语言运行时（DLR）**。

---

## 1. 使用 P/Invoke 调用非托管代码

**P/Invoke**（Platform Invocation Services）是 C# 调用非托管代码（如 C/C++ DLL）的主要方式。通过 P/Invoke，你可以声明外部方法并调用它们。

### 示例：调用 Windows API

以下示例展示了如何使用 P/Invoke 调用 Windows API 中的 `MessageBox` 函数：

```csharp
using System;
using System.Runtime.InteropServices;

class Program
{
    // 声明外部方法
    [DllImport("user32.dll", CharSet = CharSet.Unicode)]
    public static extern int MessageBox(IntPtr hWnd, string text, string caption, uint type);

    static void Main()
    {
        // 调用 MessageBox 函数
        MessageBox(IntPtr.Zero, "Hello, World!", "Message", 0);
    }
}
```

**输出**：  
弹出一个消息框，显示 "Hello, World!"。

### 解释

1. `[DllImport]` 属性用于声明外部方法。
2. `user32.dll` 是包含 `MessageBox` 函数的 DLL 文件。
3. `MessageBox` 方法的参数和返回值需要与 Windows API 中的定义一致。

:::tip
确保非托管函数的签名（参数类型和返回值）与 C# 中的声明完全匹配，否则可能导致运行时错误。
:::

---

## 2. 使用 COM Interop 与 COM 组件交互

**COM Interop** 是 C# 与 COM 组件（如 Office 应用程序）交互的机制。通过 COM Interop，你可以调用 COM 组件中的方法和属性。

### 示例：操作 Excel 文件

以下示例展示了如何使用 COM Interop 创建一个 Excel 文件并写入数据：

```csharp
using System;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // 创建 Excel 应用程序实例
        var excelApp = new Excel.Application();
        excelApp.Visible = true;

        // 添加工作簿
        Excel.Workbook workbook = excelApp.Workbooks.Add();
        Excel.Worksheet worksheet = workbook.ActiveSheet;

        // 写入数据
        worksheet.Cells[1, 1] = "Hello";
        worksheet.Cells[1, 2] = "World";

        // 保存文件
        workbook.SaveAs(@"C:\Temp\Test.xlsx");

        // 关闭 Excel
        workbook.Close();
        excelApp.Quit();
    }
}
```

**输出**：  
在 `C:\Temp` 目录下生成一个 Excel 文件，并在第一行写入 "Hello" 和 "World"。

### 解释

1. `Microsoft.Office.Interop.Excel` 是 Excel 的 COM 互操作库。
2. 通过 `Excel.Application` 创建 Excel 应用程序实例。
3. 使用 `Workbook` 和 `Worksheet` 对象操作 Excel 文件。

:::caution
使用 COM Interop 时，确保目标机器上已安装相应的 COM 组件（如 Excel）。
:::

---

## 3. 动态语言运行时（DLR）与其他语言交互

**动态语言运行时（DLR）** 是 .NET 框架的一部分，支持动态语言（如 Python 和 Ruby）与 C# 的交互。通过 DLR，你可以在 C# 中调用 Python 脚本或其他动态语言代码。

### 示例：调用 Python 脚本

以下示例展示了如何使用 `IronPython` 在 C# 中调用 Python 脚本：

```csharp
using System;
using IronPython.Hosting;

class Program
{
    static void Main()
    {
        // 创建 Python 引擎
        var engine = Python.CreateEngine();

        // 执行 Python 脚本
        engine.Execute("print('Hello from Python!')");
    }
}
```

**输出**：  
控制台输出 "Hello from Python!"。

### 解释

1. `IronPython` 是一个 .NET 实现的 Python 解释器。
2. 通过 `Python.CreateEngine()` 创建 Python 引擎。
3. 使用 `engine.Execute()` 执行 Python 代码。

:::note
DLR 提供了更大的灵活性，但性能可能不如静态类型语言。
:::

---

## 实际应用场景

1. **调用硬件驱动程序**：通过 P/Invoke 调用硬件供应商提供的非托管 DLL。
2. **自动化办公**：通过 COM Interop 操作 Word、Excel 等 Office 应用程序。
3. **数据科学**：通过 DLR 调用 Python 的机器学习库（如 TensorFlow 或 PyTorch）。

---

## 总结

C# 互操作性为开发者提供了强大的工具，使其能够与其他语言和平台无缝协作。无论是调用非托管代码、与 COM 组件交互，还是调用动态语言脚本，C# 都提供了灵活的解决方案。

通过本教程，你已经掌握了以下内容：
- 使用 P/Invoke 调用非托管代码。
- 使用 COM Interop 与 COM 组件交互。
- 使用 DLR 调用动态语言脚本。

---

## 附加资源与练习

1. **练习**：尝试使用 P/Invoke 调用其他 Windows API 函数，例如 `GetSystemTime`。
2. **资源**：
   - [P/Invoke 文档](https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke)
   - [COM Interop 文档](https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/interop/)
   - [IronPython 官网](https://ironpython.net/)

继续探索 C# 互操作性的更多可能性，并将其应用到你的项目中！