---
title: C# 不安全代码
description: "了解如何在 C# 中使用不安全代码，包括指针、内存管理和实际应用场景。"
---

## 介绍

在 C# 中，`不安全代码`是一种允许直接操作内存和指针的编程方式。通常情况下，C# 是一种安全的语言，因为它通过垃圾回收机制自动管理内存，并防止直接访问内存地址。然而，在某些情况下（如性能优化或与原生代码交互），你可能需要直接操作内存。这时，`不安全代码`就派上用场了。

:::note
不安全代码需要显式启用，并且只能在标记为 `unsafe` 的代码块或方法中使用。
:::

## 启用不安全代码

要在 C# 项目中使用不安全代码，首先需要在项目文件中启用不安全代码支持。在 `.csproj` 文件中添加以下配置：

```xml
<PropertyGroup>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
</PropertyGroup>
```

## 使用 `unsafe` 关键字

要在代码中使用不安全代码，需要使用 `unsafe` 关键字。它可以用于方法、代码块或类。

### 示例：在方法中使用不安全代码

```csharp
unsafe void ModifyValue(int* ptr)
{
    *ptr = 42;
}
```

### 示例：在代码块中使用不安全代码

```csharp
int value = 10;
unsafe
{
    int* ptr = &value;
    *ptr = 20;
}
Console.WriteLine(value); // 输出: 20
```

## 指针基础

指针是存储内存地址的变量。在 C# 中，指针的类型必须与它指向的数据类型匹配。

### 声明指针

```csharp
int* ptr; // 指向 int 类型的指针
```

### 获取变量的地址

使用 `&` 运算符可以获取变量的地址：

```csharp
int value = 10;
int* ptr = &value;
```

### 解引用指针

使用 `*` 运算符可以访问指针指向的值：

```csharp
int value = 10;
int* ptr = &value;
Console.WriteLine(*ptr); // 输出: 10
```

## 指针与数组

指针可以与数组一起使用，以直接访问数组元素的内存地址。

### 示例：使用指针遍历数组

```csharp
int[] numbers = { 1, 2, 3, 4, 5 };
unsafe
{
    fixed (int* ptr = numbers)
    {
        for (int i = 0; i < numbers.Length; i++)
        {
            Console.WriteLine(*(ptr + i));
        }
    }
}
```

:::tip
`fixed` 语句用于固定数组在内存中的位置，防止垃圾回收器移动它。
:::

## 实际应用场景

### 1. 性能优化

在某些高性能场景中，直接操作内存可以避免不必要的开销。例如，在处理大型数组时，使用指针可以显著提高性能。

### 2. 与原生代码交互

当与 C/C++ 等原生代码交互时，可能需要使用指针来传递数据或调用原生函数。

### 示例：调用原生函数

```csharp
[DllImport("NativeLibrary.dll")]
unsafe static extern void NativeFunction(int* ptr);

unsafe void CallNativeFunction()
{
    int value = 10;
    NativeFunction(&value);
}
```

## 总结

`不安全代码`是 C# 中一种强大的工具，允许你直接操作内存和指针。尽管它提供了更高的灵活性和性能，但也带来了更高的风险（如内存泄漏和访问冲突）。因此，在使用不安全代码时，务必小心谨慎。

:::caution
不安全代码应仅在必要时使用，并确保代码经过充分测试。
:::

## 附加资源

- [C# 官方文档：不安全代码](https://learn.microsoft.com/zh-cn/dotnet/csharp/language-reference/unsafe-code)
- [C# 指针和内存管理指南](https://www.c-sharpcorner.com/article/understanding-unsafe-code-and-pointers-in-C-Sharp/)

## 练习

1. 编写一个不安全方法，交换两个整数的值。
2. 使用指针遍历一个字符串数组，并打印每个字符串的第一个字符。
3. 尝试使用 `fixed` 语句固定一个二维数组，并使用指针访问其元素。