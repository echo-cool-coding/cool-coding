---
title: C# 不可变集合
description: 了解C#中的不可变集合，掌握其基本概念、使用场景以及如何在实际项目中应用。
---

# C# 不可变集合

在C#编程中，集合是存储和操作数据的重要工具。不可变集合（Immutable Collections）是一种特殊的集合类型，一旦创建，其内容就不能被修改。这种特性使得不可变集合在多线程环境或需要确保数据一致性的场景中非常有用。

## 什么是不可变集合？

不可变集合是指在创建后不能被修改的集合。任何尝试修改集合的操作都会返回一个新的集合实例，而不是修改原始集合。这种设计确保了集合的线程安全性，因为多个线程可以同时访问同一个集合而不会导致数据竞争。

## 不可变集合的类型

C#提供了多种不可变集合类型，包括：

- `ImmutableList<T>`：不可变列表
- `ImmutableDictionary<TKey, TValue>`：不可变字典
- `ImmutableHashSet<T>`：不可变哈希集
- `ImmutableSortedSet<T>`：不可变有序集
- `ImmutableQueue<T>`：不可变队列
- `ImmutableStack<T>`：不可变栈

## 使用不可变集合

### 创建不可变集合

要创建一个不可变集合，可以使用`ImmutableList.Create`、`ImmutableDictionary.Create`等方法。例如：

```csharp
var immutableList = ImmutableList.Create(1, 2, 3);
var immutableDictionary = ImmutableDictionary.CreateRange(new[]
{
    new KeyValuePair<string, int>("one", 1),
    new KeyValuePair<string, int>("two", 2),
});
```

### 修改不可变集合

虽然不可变集合本身不能被修改，但可以通过添加、删除或替换元素来创建新的集合实例。例如：

```csharp
var newList = immutableList.Add(4);
var newDictionary = immutableDictionary.Add("three", 3);
```

### 实际应用场景

不可变集合在多线程环境中非常有用，因为它们可以确保数据的一致性。例如，在一个多线程的Web服务器中，可以使用不可变集合来存储配置信息，确保所有线程都能安全地访问和读取配置。

```csharp
var config = ImmutableDictionary.CreateRange(new[]
{
    new KeyValuePair<string, string>("ServerName", "MyServer"),
    new KeyValuePair<string, string>("Port", "8080"),
});

// 多个线程可以安全地读取配置
var serverName = config["ServerName"];
var port = config["Port"];
```

## 总结

不可变集合是C#中一种强大的工具，特别适用于需要确保数据一致性和线程安全性的场景。通过使用不可变集合，你可以避免许多常见的并发问题，并编写出更加健壮和可靠的代码。

## 附加资源

- [官方文档：不可变集合](https://docs.microsoft.com/en-us/dotnet/api/system.collections.immutable)
- [C#不可变集合教程](https://www.tutorialsteacher.com/csharp/csharp-immutable-collections)
- [练习：创建一个不可变集合并尝试修改它](https://dotnetfiddle.net/)

:::tip
尝试在你的下一个项目中使用不可变集合，看看它们如何帮助你简化代码并提高安全性。
:::