---
title: C# async与await
description: "了解C#中的异步编程模型，掌握async与await关键字的使用方法，提升代码的响应性和性能。"
---

## 介绍

在现代编程中，异步编程是提高应用程序响应性和性能的关键技术之一。C# 提供了 `async` 和 `await` 关键字，使得异步编程变得更加简单和直观。通过使用这些关键字，开发者可以编写出非阻塞的代码，从而避免应用程序在等待耗时操作（如I/O操作或网络请求）时出现卡顿。

本文将详细介绍 `async` 和 `await` 的使用方法，并通过实际案例展示它们在真实场景中的应用。

## 什么是 `async` 和 `await`？

`async` 和 `await` 是C#中用于简化异步编程的关键字。它们允许开发者以同步的方式编写异步代码，从而避免复杂的回调或线程管理。

- `async`：用于标记一个方法为异步方法。异步方法可以包含 `await` 表达式。
- `await`：用于暂停异步方法的执行，直到等待的任务完成。在此期间，控制权会返回给调用者，使得应用程序可以继续执行其他任务。

## 基本用法

### 定义一个异步方法

要定义一个异步方法，需要在方法签名前加上 `async` 关键字，并返回 `Task` 或 `Task<T>` 类型。例如：

```csharp
public async Task<string> FetchDataAsync()
{
    // 模拟一个耗时的操作
    await Task.Delay(1000); // 等待1秒
    return "Data fetched!";
}
```

在这个例子中，`FetchDataAsync` 是一个异步方法，它模拟了一个耗时操作（通过 `Task.Delay`），并在操作完成后返回一个字符串。

### 调用异步方法

调用异步方法时，使用 `await` 关键字来等待方法的完成：

```csharp
public async Task UseFetchDataAsync()
{
    string result = await FetchDataAsync();
    Console.WriteLine(result); // 输出: Data fetched!
}
```

在这个例子中，`UseFetchDataAsync` 方法调用了 `FetchDataAsync`，并等待其完成。在等待期间，控制权会返回给调用者，使得应用程序可以继续执行其他任务。

## 异步方法的返回值

异步方法可以返回 `void`、`Task` 或 `Task<T>` 类型：

- `void`：通常用于事件处理程序，不推荐在其他场景中使用。
- `Task`：表示一个没有返回值的异步操作。
- `Task<T>`：表示一个返回类型为 `T` 的异步操作。

### 返回 `Task` 的示例

```csharp
public async Task DoSomethingAsync()
{
    await Task.Delay(1000);
    Console.WriteLine("Operation completed!");
}
```

### 返回 `Task<T>` 的示例

```csharp
public async Task<int> CalculateSumAsync(int a, int b)
{
    await Task.Delay(1000); // 模拟耗时操作
    return a + b;
}
```

## 实际应用场景

### 1. 文件读写

在文件读写操作中，使用异步编程可以避免阻塞主线程，从而提高应用程序的响应性。

```csharp
public async Task<string> ReadFileAsync(string filePath)
{
    using (StreamReader reader = new StreamReader(filePath))
    {
        return await reader.ReadToEndAsync();
    }
}
```

### 2. 网络请求

在进行网络请求时，使用异步编程可以避免阻塞UI线程，从而提升用户体验。

```csharp
public async Task<string> FetchWebPageAsync(string url)
{
    using (HttpClient client = new HttpClient())
    {
        return await client.GetStringAsync(url);
    }
}
```

## 注意事项

:::caution
- 避免在异步方法中使用 `Task.Wait()` 或 `Task.Result`，这会导致死锁。
- 异步方法中应尽量避免长时间运行的同步代码，否则会阻塞线程池线程。
:::

## 总结

`async` 和 `await` 是C#中简化异步编程的强大工具。通过使用它们，开发者可以编写出高效、响应性强的代码，同时避免复杂的线程管理和回调地狱。在实际开发中，合理使用异步编程可以显著提升应用程序的性能和用户体验。

## 附加资源与练习

- **练习**：尝试编写一个异步方法，模拟从多个URL并发下载数据，并在所有下载完成后合并结果。
- **资源**：
  - [Microsoft官方文档：异步编程](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/)
  - [C#异步编程最佳实践](https://devblogs.microsoft.com/dotnet/async-best-practices/)

通过不断练习和探索，你将能够熟练掌握C#中的异步编程技术，并应用于实际项目中。