---
title: C# 异步返回值
description: 了解如何在 C# 中使用异步方法返回值，掌握异步编程的核心概念和实践技巧。
---

# C# 异步返回值

在 C# 中，异步编程是现代应用程序开发的重要组成部分。通过异步编程，我们可以在不阻塞主线程的情况下执行耗时操作，从而提高应用程序的响应性和性能。本文将详细介绍如何在 C# 中使用异步方法返回值，并通过实际案例帮助你理解这一概念。

## 什么是异步返回值？

在同步编程中，方法通常会直接返回一个值。而在异步编程中，方法可能会在执行耗时操作（如网络请求或文件读写）时立即返回，但实际的返回值会在操作完成后通过 `Task<TResult>` 或 `ValueTask<TResult>` 提供。

`Task<TResult>` 是 C# 中表示异步操作返回值的类型，其中 `TResult` 是返回值的类型。通过 `await` 关键字，我们可以等待异步操作完成并获取其返回值。

## 基本语法

在 C# 中，定义一个返回值的异步方法时，需要使用 `async` 关键字，并返回 `Task<TResult>` 或 `ValueTask<TResult>`。以下是一个简单的示例：

```csharp
public async Task<int> GetNumberAsync()
{
    await Task.Delay(1000); // 模拟耗时操作
    return 42;
}
```

在这个示例中，`GetNumberAsync` 方法返回一个 `Task<int>`，表示它将异步返回一个整数。方法内部使用 `await Task.Delay(1000)` 模拟了一个耗时操作，并在操作完成后返回整数 `42`。

## 使用异步返回值

要使用异步方法的返回值，我们需要在调用方法时使用 `await` 关键字。以下是如何调用 `GetNumberAsync` 方法并获取其返回值的示例：

```csharp
public async Task PrintNumberAsync()
{
    int number = await GetNumberAsync();
    Console.WriteLine($"The number is: {number}");
}
```

在这个示例中，`PrintNumberAsync` 方法调用了 `GetNumberAsync` 并等待其返回值。一旦 `GetNumberAsync` 完成，`number` 变量将被赋值为 `42`，然后输出到控制台。

## 实际案例：异步获取网页内容

让我们通过一个实际案例来展示异步返回值的应用。假设我们需要从网络上获取一个网页的内容，并将其返回给调用者。以下是如何实现这一功能的示例：

```csharp
public async Task<string> GetWebPageContentAsync(string url)
{
    using (HttpClient client = new HttpClient())
    {
        string content = await client.GetStringAsync(url);
        return content;
    }
}
```

在这个示例中，`GetWebPageContentAsync` 方法使用 `HttpClient` 类异步获取指定 URL 的网页内容，并将其作为字符串返回。

### 调用示例

```csharp
public async Task DisplayWebPageContentAsync()
{
    string url = "https://example.com";
    string content = await GetWebPageContentAsync(url);
    Console.WriteLine(content);
}
```

在这个调用示例中，`DisplayWebPageContentAsync` 方法调用了 `GetWebPageContentAsync` 并等待其返回值。一旦获取到网页内容，它将输出到控制台。

## 处理异常

在异步编程中，异常处理同样重要。如果异步操作中发生异常，异常会被捕获并传递给调用者。以下是如何处理异步方法中的异常的示例：

```csharp
public async Task<string> SafeGetWebPageContentAsync(string url)
{
    try
    {
        using (HttpClient client = new HttpClient())
        {
            return await client.GetStringAsync(url);
        }
    }
    catch (HttpRequestException ex)
    {
        Console.WriteLine($"An error occurred: {ex.Message}");
        return null;
    }
}
```

在这个示例中，`SafeGetWebPageContentAsync` 方法尝试获取网页内容，并在发生 `HttpRequestException` 时捕获异常并输出错误信息。

## 总结

通过本文，我们学习了如何在 C# 中使用异步方法返回值。我们了解了 `Task<TResult>` 和 `ValueTask<TResult>` 的基本用法，并通过实际案例展示了如何在实际应用中使用异步返回值。我们还讨论了如何处理异步方法中的异常。

异步编程是 C# 中非常强大的工具，掌握它将帮助你编写更高效、更响应式的应用程序。

## 附加资源

- [C# 异步编程官方文档](https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/)
- [Task 和 ValueTask 的区别](https://devblogs.microsoft.com/dotnet/understanding-the-whys-whats-and-whens-of-valuetask/)
- [异步编程最佳实践](https://docs.microsoft.com/en-us/dotnet/csharp/async)

## 练习

1. 修改 `GetNumberAsync` 方法，使其返回一个随机数而不是固定的 `42`。
2. 创建一个异步方法，从多个 URL 获取网页内容，并返回所有内容的列表。
3. 尝试在异步方法中抛出异常，并在调用者中捕获并处理它。

通过完成这些练习，你将更深入地理解 C# 异步返回值的概念和应用。