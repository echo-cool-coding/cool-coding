---
title: C# 委托基础
description: 了解C#中的委托（Delegate）是什么，以及如何使用它们来创建灵活且可重用的代码。
---

## 介绍

在C#中，**委托（Delegate）**是一种类型安全的函数指针，它允许你将方法作为参数传递，或者将方法存储在变量中。委托是C#中实现事件驱动编程和回调机制的核心工具之一。通过委托，你可以编写更加灵活和可重用的代码。

委托的核心思想是：**它代表了对一个或多个方法的引用**。你可以将委托看作是一个“方法容器”，它能够存储和调用这些方法。

## 委托的定义与声明

在C#中，委托的声明类似于方法的声明，但它没有方法体，而是使用 `delegate` 关键字。委托的声明指定了它可以引用的方法的签名（即方法的返回类型和参数列表）。

```csharp
// 定义一个委托
public delegate void MyDelegate(string message);
```

在上面的代码中，`MyDelegate` 是一个委托类型，它可以引用任何返回类型为 `void` 并且接受一个 `string` 类型参数的方法。

## 委托的实例化与调用

一旦定义了委托类型，你就可以创建该委托的实例，并将其与具体的方法关联起来。然后，你可以通过委托实例来调用该方法。

```csharp
// 定义一个与委托签名匹配的方法
public void DisplayMessage(string message)
{
    Console.WriteLine(message);
}

// 创建委托实例并关联方法
MyDelegate handler = new MyDelegate(DisplayMessage);

// 通过委托调用方法
handler("Hello, World!");
```

**输出：**
```
Hello, World!
```

在这个例子中，`handler` 是一个 `MyDelegate` 类型的委托实例，它引用了 `DisplayMessage` 方法。通过调用 `handler("Hello, World!")`，实际上是在调用 `DisplayMessage` 方法。

## 多播委托

C#中的委托支持**多播（Multicast）**，这意味着一个委托实例可以引用多个方法。当你调用多播委托时，所有关联的方法都会按照它们被添加的顺序依次执行。

```csharp
// 定义另一个与委托签名匹配的方法
public void ShowMessage(string message)
{
    Console.WriteLine("Showing: " + message);
}

// 创建委托实例并关联多个方法
MyDelegate handler1 = new MyDelegate(DisplayMessage);
MyDelegate handler2 = new MyDelegate(ShowMessage);

// 使用 += 运算符将多个方法添加到委托中
MyDelegate multicastHandler = handler1 + handler2;

// 调用多播委托
multicastHandler("Multicast Delegate");
```

**输出：**
```
Hello, World!
Showing: Multicast Delegate
```

在这个例子中，`multicastHandler` 是一个多播委托，它同时引用了 `DisplayMessage` 和 `ShowMessage` 两个方法。调用 `multicastHandler` 时，两个方法都会被执行。

:::note
**注意：** 多播委托的返回值通常是最后一个方法的返回值。如果委托引用的方法有返回值，只有最后一个方法的返回值会被返回。
:::

## 委托的实际应用场景

委托在C#中有许多实际应用场景，以下是一些常见的例子：

### 1. 事件处理

委托广泛用于事件处理机制。例如，在Windows Forms或WPF应用程序中，按钮点击事件通常通过委托来处理。

```csharp
// 定义一个事件
public event MyDelegate OnMessageDisplayed;

// 触发事件
public void TriggerEvent(string message)
{
    if (OnMessageDisplayed != null)
    {
        OnMessageDisplayed(message);
    }
}

// 订阅事件
OnMessageDisplayed += DisplayMessage;
OnMessageDisplayed += ShowMessage;

// 触发事件
TriggerEvent("Event Triggered!");
```

**输出：**
```
Hello, World!
Showing: Event Triggered!
```

### 2. 回调机制

委托常用于实现回调机制。例如，在异步编程中，你可以使用委托来指定一个方法，当异步操作完成时调用该方法。

```csharp
public void LongRunningOperation(MyDelegate callback)
{
    // 模拟长时间运行的操作
    Thread.Sleep(2000);
    callback("Operation Complete!");
}

// 调用异步操作并传递回调方法
LongRunningOperation(DisplayMessage);
```

**输出：**
```
Operation Complete!
```

## 总结

委托是C#中一个强大的工具，它允许你将方法作为参数传递，或者将方法存储在变量中。通过委托，你可以编写更加灵活和可重用的代码。委托的核心概念包括：

- **委托的定义与声明**：使用 `delegate` 关键字定义委托类型。
- **委托的实例化与调用**：创建委托实例并关联方法，通过委托调用方法。
- **多播委托**：一个委托实例可以引用多个方法，调用时按顺序执行。

委托在事件处理、回调机制等场景中有着广泛的应用。掌握委托的使用，将帮助你更好地理解C#中的事件驱动编程和异步编程。

## 附加资源与练习

- **练习1**：定义一个委托类型 `MathOperation`，它可以引用任何接受两个 `int` 参数并返回 `int` 的方法。然后创建几个简单的数学运算方法（如加法、减法、乘法），并使用委托来调用它们。
- **练习2**：尝试创建一个多播委托，将多个数学运算方法添加到同一个委托实例中，并观察它们的执行顺序。

通过实践这些练习，你将更深入地理解委托的工作原理和应用场景。