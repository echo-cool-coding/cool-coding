---
title: TypeScript Promise组合
description: 了解如何在TypeScript中使用Promise组合来处理异步操作，提升代码的可读性和可维护性。
---

# TypeScript Promise组合

在现代JavaScript和TypeScript中，异步编程是不可或缺的一部分。`Promise`是处理异步操作的核心工具之一。然而，当我们需要处理多个异步操作时，如何有效地组合这些`Promise`就变得尤为重要。本文将详细介绍如何在TypeScript中使用`Promise`组合，并通过实际案例展示其应用场景。

## 什么是Promise组合？

`Promise`组合是指将多个`Promise`操作串联或并联起来，以便更高效地处理异步任务。通过组合`Promise`，我们可以避免回调地狱（Callback Hell），并编写出更具可读性和可维护性的代码。

### 常见的Promise组合方法

在TypeScript中，常见的`Promise`组合方法包括：

1. **`Promise.all`**: 并行执行多个`Promise`，并在所有`Promise`都完成后返回结果。
2. **`Promise.race`**: 并行执行多个`Promise`，并在第一个`Promise`完成后返回结果。
3. **`Promise.allSettled`**: 并行执行多个`Promise`，并在所有`Promise`都完成后返回结果，无论成功或失败。
4. **`Promise.any`**: 并行执行多个`Promise`，并在第一个`Promise`成功完成后返回结果。

## 使用`Promise.all`进行并行处理

`Promise.all`是最常用的`Promise`组合方法之一。它接受一个`Promise`数组作为参数，并返回一个新的`Promise`。这个新的`Promise`在所有输入的`Promise`都成功完成后才会被解决，并返回一个包含所有结果的数组。

```typescript
const promise1 = Promise.resolve(1);
const promise2 = Promise.resolve(2);
const promise3 = Promise.resolve(3);

Promise.all([promise1, promise2, promise3])
  .then((results) => {
    console.log(results); // 输出: [1, 2, 3]
  })
  .catch((error) => {
    console.error(error);
  });
```

:::note
如果`Promise.all`中的任何一个`Promise`被拒绝（rejected），整个`Promise.all`将立即被拒绝，并返回第一个被拒绝的`Promise`的错误。
:::

## 使用`Promise.race`进行竞争处理

`Promise.race`方法接受一个`Promise`数组，并返回一个新的`Promise`。这个新的`Promise`在第一个输入的`Promise`完成后就会被解决或拒绝。

```typescript
const promise1 = new Promise((resolve) => setTimeout(resolve, 500, 'one'));
const promise2 = new Promise((resolve) => setTimeout(resolve, 100, 'two'));

Promise.race([promise1, promise2])
  .then((result) => {
    console.log(result); // 输出: 'two'
  })
  .catch((error) => {
    console.error(error);
  });
```

:::caution
`Promise.race`只关心第一个完成的`Promise`，无论它是成功还是失败。因此，在使用`Promise.race`时，务必考虑所有可能的场景。
:::

## 使用`Promise.allSettled`处理所有结果

`Promise.allSettled`方法接受一个`Promise`数组，并返回一个新的`Promise`。这个新的`Promise`在所有输入的`Promise`都完成后才会被解决，无论它们是成功还是失败。返回的结果是一个包含每个`Promise`状态和值的数组。

```typescript
const promise1 = Promise.resolve(1);
const promise2 = Promise.reject('Error occurred');
const promise3 = Promise.resolve(3);

Promise.allSettled([promise1, promise2, promise3])
  .then((results) => {
    console.log(results);
    // 输出:
    // [
    //   { status: 'fulfilled', value: 1 },
    //   { status: 'rejected', reason: 'Error occurred' },
    //   { status: 'fulfilled', value: 3 }
    // ]
  });
```

:::tip
`Promise.allSettled`非常适合在需要处理多个异步操作，并且不希望其中一个操作的失败影响其他操作的场景。
:::

## 使用`Promise.any`获取第一个成功的结果

`Promise.any`方法接受一个`Promise`数组，并返回一个新的`Promise`。这个新的`Promise`在第一个输入的`Promise`成功完成后就会被解决。如果所有的`Promise`都被拒绝，`Promise.any`将返回一个`AggregateError`。

```typescript
const promise1 = Promise.reject('Error 1');
const promise2 = Promise.resolve('Success 2');
const promise3 = Promise.reject('Error 3');

Promise.any([promise1, promise2, promise3])
  .then((result) => {
    console.log(result); // 输出: 'Success 2'
  })
  .catch((error) => {
    console.error(error); // 如果所有Promise都被拒绝，将输出AggregateError
  });
```

:::warning
`Promise.any`只有在至少一个`Promise`成功时才会被解决。如果所有`Promise`都被拒绝，它将返回一个`AggregateError`，其中包含所有被拒绝的原因。
:::

## 实际案例：并行获取多个API数据

假设我们需要从多个API端点获取数据，并在所有数据都获取完成后进行处理。我们可以使用`Promise.all`来实现这一需求。

```typescript
const fetchUserData = fetch('https://api.example.com/user');
const fetchPostsData = fetch('https://api.example.com/posts');
const fetchCommentsData = fetch('https://api.example.com/comments');

Promise.all([fetchUserData, fetchPostsData, fetchCommentsData])
  .then((responses) => Promise.all(responses.map((response) => response.json())))
  .then((data) => {
    const [userData, postsData, commentsData] = data;
    console.log('User Data:', userData);
    console.log('Posts Data:', postsData);
    console.log('Comments Data:', commentsData);
  })
  .catch((error) => {
    console.error('Error fetching data:', error);
  });
```

在这个例子中，我们并行地获取了用户数据、帖子数据和评论数据，并在所有数据都获取完成后进行处理。

## 总结

`Promise`组合是处理多个异步操作的有力工具。通过使用`Promise.all`、`Promise.race`、`Promise.allSettled`和`Promise.any`，我们可以更高效地管理异步任务，并编写出更具可读性和可维护性的代码。

### 附加资源

- [MDN Web Docs: Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)
- [TypeScript Handbook: Asynchronous Programming](https://www.typescriptlang.org/docs/handbook/async.html)

### 练习

1. 使用`Promise.all`从多个API端点获取数据，并在所有数据都获取完成后进行处理。
2. 使用`Promise.race`实现一个超时机制，如果某个异步操作在指定时间内未完成，则返回超时错误。
3. 使用`Promise.allSettled`处理多个异步操作，并记录每个操作的结果，无论成功或失败。

通过实践这些练习，你将更深入地理解`Promise`组合的强大功能。