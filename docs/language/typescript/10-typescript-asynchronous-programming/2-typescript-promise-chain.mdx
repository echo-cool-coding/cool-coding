---
title: TypeScript Promise链
description: 了解如何在 TypeScript 中使用 Promise 链来管理异步操作，掌握链式调用的技巧和最佳实践。
---

# TypeScript Promise链

在现代 JavaScript 和 TypeScript 中，异步编程是不可或缺的一部分。`Promise` 是处理异步操作的核心工具之一，而 **Promise 链** 则是一种强大的模式，用于按顺序执行多个异步任务。本文将详细介绍 Promise 链的概念、用法以及实际应用场景。

## 什么是 Promise 链？

`Promise` 是 JavaScript 中表示异步操作的对象。它有三种状态：
- **Pending**：初始状态，表示操作尚未完成。
- **Fulfilled**：操作成功完成。
- **Rejected**：操作失败。

Promise 链是指通过 `.then()` 方法将多个 `Promise` 连接起来，使得一个异步操作完成后，可以继续执行下一个异步操作。这种方式避免了回调地狱（Callback Hell），使代码更具可读性和可维护性。

## 基本用法

以下是一个简单的 Promise 链示例：

```typescript
const promise = new Promise<string>((resolve, reject) => {
  setTimeout(() => resolve("第一步完成"), 1000);
});

promise
  .then((result) => {
    console.log(result); // 输出: 第一步完成
    return "第二步完成";
  })
  .then((result) => {
    console.log(result); // 输出: 第二步完成
    return "第三步完成";
  })
  .then((result) => {
    console.log(result); // 输出: 第三步完成
  })
  .catch((error) => {
    console.error("发生错误:", error);
  });
```

在这个例子中，每个 `.then()` 方法都会在前一个 `Promise` 完成后执行，并将结果传递给下一个 `.then()`。

:::note
`catch()` 方法用于捕获链中任何位置的错误。如果链中的任何一个 `Promise` 被拒绝（rejected），控制权将立即转移到最近的 `catch()` 方法。
:::

## 处理异步操作

Promise 链非常适合处理需要按顺序执行的异步操作。例如，假设我们需要依次完成以下任务：
1. 获取用户数据。
2. 根据用户数据获取订单信息。
3. 根据订单信息获取产品详情。

以下是实现代码：

```typescript
function getUserData(userId: number): Promise<string> {
  return new Promise((resolve) => {
    setTimeout(() => resolve(`用户 ${userId} 的数据`), 1000);
  });
}

function getOrderInfo(userData: string): Promise<string> {
  return new Promise((resolve) => {
    setTimeout(() => resolve(`${userData} 的订单信息`), 1000);
  });
}

function getProductDetails(orderInfo: string): Promise<string> {
  return new Promise((resolve) => {
    setTimeout(() => resolve(`${orderInfo} 的产品详情`), 1000);
  });
}

getUserData(1)
  .then((userData) => getOrderInfo(userData))
  .then((orderInfo) => getProductDetails(orderInfo))
  .then((productDetails) => {
    console.log(productDetails); // 输出: 用户 1 的数据 的订单信息 的产品详情
  })
  .catch((error) => {
    console.error("发生错误:", error);
  });
```

:::tip
在 Promise 链中，每个 `.then()` 方法可以返回一个新的 `Promise`，从而继续链式调用。
:::

## 错误处理

在 Promise 链中，错误处理非常重要。如果链中的任何一个 `Promise` 被拒绝，整个链将停止执行，并跳转到最近的 `catch()` 方法。

```typescript
function simulateError(): Promise<void> {
  return new Promise((_, reject) => {
    setTimeout(() => reject("模拟错误"), 1000);
  });
}

simulateError()
  .then(() => {
    console.log("这一步不会执行");
  })
  .catch((error) => {
    console.error("捕获到错误:", error); // 输出: 捕获到错误: 模拟错误
  });
```

:::caution
如果没有提供 `catch()` 方法，未处理的 Promise 拒绝可能会导致程序崩溃。因此，始终建议在 Promise 链中添加错误处理逻辑。
:::

## 实际应用场景

Promise 链在实际开发中非常常见，尤其是在需要按顺序执行多个异步操作的场景中。以下是一些典型的应用场景：

1. **API 调用**：在获取用户数据后，根据用户数据调用其他 API。
2. **文件处理**：在读取文件后，对文件内容进行处理并写入新文件。
3. **数据库操作**：在插入数据后，更新相关记录或执行其他查询。

## 总结

Promise 链是 TypeScript 和 JavaScript 中处理异步操作的重要工具。通过链式调用 `.then()` 方法，我们可以轻松地按顺序执行多个异步任务，同时保持代码的清晰和可维护性。记住以下几点：
- 每个 `.then()` 方法可以返回一个新的 `Promise`。
- 使用 `catch()` 方法处理链中的错误。
- Promise 链非常适合需要按顺序执行的异步操作。

## 附加资源与练习

- **练习**：尝试编写一个 Promise 链，模拟登录、获取用户信息和更新用户设置的过程。
- **资源**：
  - [MDN 文档：Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)
  - [TypeScript 官方文档](https://www.typescriptlang.org/docs/)

通过不断练习和探索，你将能够熟练使用 Promise 链来处理复杂的异步逻辑！