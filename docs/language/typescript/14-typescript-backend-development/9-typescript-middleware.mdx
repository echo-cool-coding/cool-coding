---
title: TypeScript 中间件
description: 了解如何在TypeScript后端开发中使用中间件，掌握其工作原理、实现方式以及实际应用场景。
---

# TypeScript 中间件

## 介绍

在TypeScript后端开发中，**中间件**是一个非常重要的概念。它允许你在请求到达路由处理程序之前或之后执行某些操作。中间件通常用于处理诸如身份验证、日志记录、错误处理等任务。通过使用中间件，你可以将代码模块化，使其更易于维护和扩展。

## 什么是中间件？

中间件是一个函数，它接收请求对象（`req`）、响应对象（`res`）和一个回调函数（`next`）。中间件可以在请求到达路由处理程序之前或之后执行某些操作。如果中间件调用了 `next()`，请求将继续传递到下一个中间件或路由处理程序；如果不调用 `next()`，请求将被终止。

## 中间件的基本结构

以下是一个简单的中间件示例：

```typescript
import { Request, Response, NextFunction } from 'express';

function loggerMiddleware(req: Request, res: Response, next: NextFunction) {
    console.log(`${req.method} ${req.url}`);
    next();
}
```

在这个例子中，`loggerMiddleware` 是一个中间件函数，它会在每个请求到达时打印请求的方法和URL，然后调用 `next()` 将请求传递给下一个中间件或路由处理程序。

## 中间件的使用

在Express.js中，你可以通过 `app.use()` 方法来使用中间件。以下是如何使用上面的 `loggerMiddleware` 的示例：

```typescript
import express from 'express';

const app = express();

app.use(loggerMiddleware);

app.get('/', (req, res) => {
    res.send('Hello, World!');
});

app.listen(3000, () => {
    console.log('Server is running on port 3000');
});
```

在这个例子中，`loggerMiddleware` 会在每个请求到达时被调用，无论请求的路径是什么。

## 中间件的顺序

中间件的顺序非常重要。Express.js会按照中间件被添加的顺序依次执行它们。例如：

```typescript
app.use(middleware1);
app.use(middleware2);
app.use(middleware3);
```

在这个例子中，`middleware1` 会首先执行，然后是 `middleware2`，最后是 `middleware3`。

## 实际应用场景

### 1. 身份验证中间件

身份验证是中间件的一个常见应用场景。以下是一个简单的身份验证中间件示例：

```typescript
function authMiddleware(req: Request, res: Response, next: NextFunction) {
    const token = req.headers['authorization'];
    if (token === 'valid-token') {
        next();
    } else {
        res.status(401).send('Unauthorized');
    }
}
```

你可以将这个中间件应用到需要身份验证的路由上：

```typescript
app.get('/protected', authMiddleware, (req, res) => {
    res.send('This is a protected route');
});
```

### 2. 错误处理中间件

错误处理中间件通常放在所有路由之后，用于捕获和处理应用程序中的错误。以下是一个简单的错误处理中间件示例：

```typescript
function errorHandler(err: Error, req: Request, res: Response, next: NextFunction) {
    console.error(err.stack);
    res.status(500).send('Something broke!');
}

app.use(errorHandler);
```

## 总结

中间件是TypeScript后端开发中一个非常强大的工具，它可以帮助你将代码模块化，并处理诸如身份验证、日志记录、错误处理等任务。通过理解中间件的工作原理和使用方法，你可以构建更健壮、更易于维护的后端应用程序。

## 附加资源

- [Express.js官方文档](https://expressjs.com/)
- [TypeScript官方文档](https://www.typescriptlang.org/)

## 练习

1. 创建一个日志记录中间件，记录每个请求的IP地址和请求时间。
2. 实现一个中间件，检查请求头中的 `Content-Type` 是否为 `application/json`，如果不是，则返回400状态码。
3. 将错误处理中间件应用到你的应用程序中，并测试它是否能够捕获和处理错误。

通过完成这些练习，你将更深入地理解中间件的工作原理和应用场景。