---
title: C 语言动态分配
description: 了解C语言中的动态内存分配，掌握如何使用malloc、calloc、realloc和free函数管理内存。
---

# C 语言动态分配

在C语言中，动态内存分配是一种在程序运行时分配内存的机制。与静态内存分配（如定义数组时指定固定大小）不同，动态内存分配允许程序根据需要分配和释放内存。这对于处理不确定大小的数据或需要在运行时调整内存使用的情况非常有用。

## 为什么需要动态内存分配？

在编写程序时，我们经常需要处理一些数据，但这些数据的大小在编译时可能无法确定。例如，用户输入的数据量可能不同，或者我们需要处理一个动态增长的数据结构（如链表或动态数组）。在这些情况下，静态内存分配无法满足需求，而动态内存分配则提供了灵活性。

## 动态内存分配的函数

C语言提供了几个标准库函数来实现动态内存分配：

1. **malloc**: 分配指定大小的内存块，但不初始化内存内容。
2. **calloc**: 分配指定数量的内存块，并将内存内容初始化为0。
3. **realloc**: 调整已分配内存块的大小。
4. **free**: 释放之前分配的内存块。

### 1. malloc 函数

`malloc` 函数用于分配指定字节数的内存。它的原型如下：

```c
void* malloc(size_t size);
```

- `size`: 需要分配的内存大小（以字节为单位）。
- 返回值：成功时返回指向分配内存的指针，失败时返回 `NULL`。

#### 示例

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *arr;
    int n = 5;

    // 分配内存
    arr = (int*)malloc(n * sizeof(int));
    if (arr == NULL) {
        printf("内存分配失败\n");
        return 1;
    }

    // 使用内存
    for (int i = 0; i < n; i++) {
        arr[i] = i + 1;
    }

    // 打印数组
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");

    // 释放内存
    free(arr);

    return 0;
}
```

**输出:**

```
1 2 3 4 5
```

:::note
在使用 `malloc` 分配内存后，务必检查返回的指针是否为 `NULL`，以确保内存分配成功。
:::

### 2. calloc 函数

`calloc` 函数用于分配内存并将其初始化为0。它的原型如下：

```c
void* calloc(size_t num, size_t size);
```

- `num`: 需要分配的元素数量。
- `size`: 每个元素的大小（以字节为单位）。
- 返回值：成功时返回指向分配内存的指针，失败时返回 `NULL`。

#### 示例

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *arr;
    int n = 5;

    // 分配并初始化内存
    arr = (int*)calloc(n, sizeof(int));
    if (arr == NULL) {
        printf("内存分配失败\n");
        return 1;
    }

    // 打印数组（所有元素应为0）
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");

    // 释放内存
    free(arr);

    return 0;
}
```

**输出:**

```
0 0 0 0 0
```

:::tip
`calloc` 适合用于需要初始化内存为零的场景，例如创建数组或结构体数组。
:::

### 3. realloc 函数

`realloc` 函数用于调整已分配内存块的大小。它的原型如下：

```c
void* realloc(void* ptr, size_t size);
```

- `ptr`: 指向之前分配的内存块的指针。
- `size`: 新的内存大小（以字节为单位）。
- 返回值：成功时返回指向新内存块的指针，失败时返回 `NULL`。

#### 示例

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *arr;
    int n = 5;

    // 初始分配内存
    arr = (int*)malloc(n * sizeof(int));
    if (arr == NULL) {
        printf("内存分配失败\n");
        return 1;
    }

    // 使用内存
    for (int i = 0; i < n; i++) {
        arr[i] = i + 1;
    }

    // 调整内存大小
    n = 10;
    arr = (int*)realloc(arr, n * sizeof(int));
    if (arr == NULL) {
        printf("内存重新分配失败\n");
        return 1;
    }

    // 初始化新增的内存
    for (int i = 5; i < n; i++) {
        arr[i] = i + 1;
    }

    // 打印数组
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");

    // 释放内存
    free(arr);

    return 0;
}
```

**输出:**

```
1 2 3 4 5 6 7 8 9 10
```

:::caution
使用 `realloc` 时，如果内存重新分配失败，原始内存块仍然有效。因此，建议将 `realloc` 的返回值赋给一个临时指针，并在成功后再更新原始指针。
:::

### 4. free 函数

`free` 函数用于释放之前通过 `malloc`、`calloc` 或 `realloc` 分配的内存。它的原型如下：

```c
void free(void* ptr);
```

- `ptr`: 指向需要释放的内存块的指针。

:::warning
释放内存后，指针仍然指向原来的内存地址，但该内存已经不再有效。为了避免悬空指针（dangling pointer），建议在释放后将指针设置为 `NULL`。
:::

## 实际应用场景

动态内存分配在许多实际场景中非常有用，例如：

1. **动态数组**: 当数组大小在编译时未知时，可以使用动态内存分配来创建数组。
2. **链表**: 链表中的每个节点通常是通过动态内存分配创建的。
3. **文件处理**: 当读取文件时，文件大小可能未知，可以使用动态内存分配来存储文件内容。

### 示例：动态数组

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *arr;
    int n;

    printf("请输入数组大小: ");
    scanf("%d", &n);

    // 分配内存
    arr = (int*)malloc(n * sizeof(int));
    if (arr == NULL) {
        printf("内存分配失败\n");
        return 1;
    }

    // 输入数组元素
    for (int i = 0; i < n; i++) {
        printf("请输入元素 %d: ", i + 1);
        scanf("%d", &arr[i]);
    }

    // 打印数组
    printf("数组元素为: ");
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");

    // 释放内存
    free(arr);

    return 0;
}
```

**输入:**

```
请输入数组大小: 3
请输入元素 1: 10
请输入元素 2: 20
请输入元素 3: 30
```

**输出:**

```
数组元素为: 10 20 30
```

## 总结

动态内存分配是C语言中一个强大的工具，允许程序在运行时根据需要分配和释放内存。通过使用 `malloc`、`calloc`、`realloc` 和 `free` 函数，我们可以灵活地管理内存，处理不确定大小的数据或动态数据结构。

:::tip
在使用动态内存分配时，务必确保每次分配的内存都被正确释放，以避免内存泄漏。
:::

## 附加资源与练习

1. **练习**: 编写一个程序，使用动态内存分配创建一个链表，并实现插入、删除和打印链表的功能。
2. **进一步阅读**: 了解C语言中的内存管理机制，包括栈和堆的区别。
3. **挑战**: 尝试实现一个简单的动态数组库，支持动态扩展和收缩数组大小。

通过掌握动态内存分配，你将能够编写更加灵活和高效的C语言程序。继续练习并探索更多高级内存管理技术！