---
title: C 语言内存布局
description: 了解C语言程序的内存布局，包括栈、堆、全局变量和代码段等关键部分。本文适合初学者，通过清晰的解释和代码示例帮助你掌握C语言内存管理的基础知识。
---

# C 语言内存布局

在C语言中，程序的内存布局是一个非常重要的概念。理解内存布局不仅有助于编写高效的程序，还能帮助你避免常见的内存错误，如内存泄漏和段错误。本文将详细介绍C语言程序的内存布局，并通过代码示例和实际案例帮助你更好地理解。

## 1. 内存布局概述

C语言程序在运行时，内存通常被划分为以下几个部分：

1. **栈（Stack）**：用于存储局部变量和函数调用的上下文。
2. **堆（Heap）**：用于动态内存分配，程序员可以手动管理这部分内存。
3. **全局/静态存储区（Global/Static Storage）**：用于存储全局变量和静态变量。
4. **代码段（Code Segment）**：用于存储程序的执行代码。

下面我们将逐一介绍这些部分。

## 2. 栈（Stack）

栈是一种后进先出（LIFO）的数据结构，用于存储局部变量和函数调用的上下文。每当一个函数被调用时，一个新的栈帧（stack frame）会被压入栈中，用于存储该函数的局部变量和返回地址。当函数执行完毕后，栈帧会被弹出，释放内存。

### 示例代码

```c
#include <stdio.h>

void function() {
    int localVar = 10; // 局部变量，存储在栈中
    printf("Local variable: %d\n", localVar);
}

int main() {
    function();
    return 0;
}
```

**输出：**
```
Local variable: 10
```

在这个例子中，`localVar` 是一个局部变量，存储在栈中。当 `function` 执行完毕后，`localVar` 的内存会被自动释放。

:::note
栈的大小是有限的，通常比堆小得多。如果栈空间耗尽，会导致栈溢出（stack overflow）。
:::

## 3. 堆（Heap）

堆是用于动态内存分配的区域。与栈不同，堆的内存分配和释放需要程序员手动管理。C语言提供了 `malloc`、`calloc`、`realloc` 和 `free` 等函数来操作堆内存。

### 示例代码

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *ptr = (int *)malloc(sizeof(int)); // 在堆中分配内存
    if (ptr == NULL) {
        printf("Memory allocation failed\n");
        return 1;
    }
    *ptr = 20;
    printf("Value: %d\n", *ptr);
    free(ptr); // 释放堆内存
    return 0;
}
```

**输出：**
```
Value: 20
```

在这个例子中，我们使用 `malloc` 在堆中分配了一块内存，并在使用完毕后使用 `free` 释放了这块内存。

:::caution
忘记释放堆内存会导致内存泄漏。确保在使用完动态分配的内存后调用 `free`。
:::

## 4. 全局/静态存储区（Global/Static Storage）

全局变量和静态变量存储在全局/静态存储区。全局变量在整个程序的生命周期内都存在，而静态变量的作用域仅限于定义它的文件或函数。

### 示例代码

```c
#include <stdio.h>

int globalVar = 30; // 全局变量，存储在全局/静态存储区

void function() {
    static int staticVar = 40; // 静态变量，存储在全局/静态存储区
    printf("Static variable: %d\n", staticVar);
    staticVar++;
}

int main() {
    printf("Global variable: %d\n", globalVar);
    function();
    function();
    return 0;
}
```

**输出：**
```
Global variable: 30
Static variable: 40
Static variable: 41
```

在这个例子中，`globalVar` 是一个全局变量，`staticVar` 是一个静态变量。静态变量在函数调用之间保持其值。

## 5. 代码段（Code Segment）

代码段用于存储程序的执行代码，包括函数和指令。这部分内存通常是只读的，以防止程序意外修改其自身的代码。

### 示例代码

```c
#include <stdio.h>

void printMessage() {
    printf("Hello, World!\n");
}

int main() {
    printMessage();
    return 0;
}
```

**输出：**
```
Hello, World!
```

在这个例子中，`printMessage` 函数的代码存储在代码段中。

## 6. 实际案例

假设我们正在编写一个程序，需要动态创建一个数组来存储用户输入的数据。我们可以使用堆来分配内存，并在使用完毕后释放它。

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int n;
    printf("Enter the number of elements: ");
    scanf("%d", &n);

    int *arr = (int *)malloc(n * sizeof(int)); // 在堆中分配内存
    if (arr == NULL) {
        printf("Memory allocation failed\n");
        return 1;
    }

    for (int i = 0; i < n; i++) {
        printf("Enter element %d: ", i + 1);
        scanf("%d", &arr[i]);
    }

    printf("You entered: ");
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");

    free(arr); // 释放堆内存
    return 0;
}
```

**输出：**
```
Enter the number of elements: 3
Enter element 1: 10
Enter element 2: 20
Enter element 3: 30
You entered: 10 20 30
```

在这个案例中，我们使用 `malloc` 动态分配了一个数组，并在使用完毕后使用 `free` 释放了内存。

## 7. 总结

C语言的内存布局包括栈、堆、全局/静态存储区和代码段。理解这些部分的作用和管理方式对于编写高效、安全的C程序至关重要。栈用于存储局部变量和函数调用的上下文，堆用于动态内存分配，全局/静态存储区用于存储全局和静态变量，代码段用于存储程序的执行代码。

:::tip
建议初学者多练习动态内存分配和释放，以避免常见的内存错误。
:::

## 8. 附加资源与练习

- **练习1**：编写一个程序，使用 `malloc` 分配一个字符串数组，并在使用完毕后释放内存。
- **练习2**：研究 `calloc` 和 `realloc` 的用法，并编写示例代码。
- **附加资源**：阅读C语言标准库中关于内存管理的文档，了解更多关于 `malloc`、`free`、`calloc` 和 `realloc` 的细节。

通过不断练习和学习，你将能够更好地掌握C语言的内存管理技巧。