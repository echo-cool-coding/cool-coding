---
title: Python 描述符
description: 深入了解Python描述符的概念、工作原理及实际应用场景，帮助你掌握这一Python高级特性
---

# Python 描述符

在进入Python高级编程的世界时，描述符(Descriptors)是一个需要理解的重要概念。虽然你可能在日常编程中没有直接使用它们，但许多Python内置功能（如属性、方法、类方法等）都是基于描述符机制实现的。掌握描述符将帮助你更深入地理解Python的工作原理，并能够构建更灵活、更强大的代码。

## 什么是描述符？

描述符是Python中一种特殊的对象，它定义了当另一个对象尝试访问或修改它时应该发生什么。简单来说，描述符允许你定制当你尝试获取(get)、设置(set)或删除(delete)一个类的属性时的行为。

:::info
描述符是实现了特定协议方法的对象，这些方法是：`__get__`、`__set__`和`__delete__`。
:::

一个对象要成为描述符，至少需要实现这三个方法中的一个。

## 描述符协议

描述符协议包含以下三个方法：

1. `__get__(self, obj, type=None)` - 当获取属性时调用
2. `__set__(self, obj, value)` - 当设置属性时调用
3. `__delete__(self, obj)` - 当删除属性时调用

根据实现的方法不同，描述符可以分为两种类型：

- **数据描述符**：实现了`__get__`和`__set__`方法
- **非数据描述符**：只实现了`__get__`方法

## 描述符的基本示例

让我们从一个简单的例子开始，创建一个温度转换描述符：

```python
class Celsius:
    def __init__(self, value=0.0):
        self.value = float(value)
        
    def __get__(self, obj, objtype=None):
        return self.value
        
    def __set__(self, obj, value):
        self.value = float(value)
        
class Temperature:
    celsius = Celsius()
    
temp = Temperature()
temp.celsius = 25  # 调用Celsius.__set__
print(temp.celsius)  # 调用Celsius.__get__，输出：25.0
```

输出：
```
25.0
```

在这个例子中，`Celsius`类是一个数据描述符，它定义了当我们访问或修改`Temperature.celsius`属性时应该发生什么。

## 描述符如何工作

当我们访问一个对象的属性时，Python会按照以下顺序查找属性：

1. 如果属性是一个数据描述符，则调用描述符的`__get__`方法
2. 如果属性在实例的`__dict__`中，则直接返回实例字典中的值
3. 如果属性是一个非数据描述符，则调用描述符的`__get__`方法
4. 从类字典中查找属性
5. 调用类的`__getattr__`方法（如果已定义）
6. 抛出`AttributeError`异常

这个查找顺序解释了为什么数据描述符能够覆盖实例属性，而非数据描述符会被实例属性覆盖。

## 实际应用案例

### 案例1：属性验证

描述符常用于验证属性值。下面是一个确保年龄在合理范围内的例子：

```python
class Age:
    def __init__(self):
        # 使用_name作为私有变量，避免与实例属性冲突
        self._name = '_age'
        
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        return getattr(obj, self._name, 0)
        
    def __set__(self, obj, value):
        if not isinstance(value, int):
            raise TypeError('年龄必须是整数')
        if value < 0 or value > 150:
            raise ValueError('年龄必须在0到150之间')
        setattr(obj, self._name, value)
        
class Person:
    age = Age()
    
    def __init__(self, name, age):
        self.name = name
        self.age = age  # 这里会调用Age.__set__
        
# 创建有效的Person对象
person = Person("张三", 25)
print(f"{person.name}的年龄是{person.age}岁")

# 尝试设置无效年龄
try:
    person.age = 200  # 会引发ValueError
except ValueError as e:
    print(f"错误: {e}")
    
try:
    person.age = "三十"  # 会引发TypeError
except TypeError as e:
    print(f"错误: {e}")
```

输出：
```
张三的年龄是25岁
错误: 年龄必须在0到150之间
错误: 年龄必须是整数
```

### 案例2：惰性计算属性

描述符可以用来实现只在需要时才计算属性值的功能：

```python
class LazyProperty:
    def __init__(self, func):
        self.func = func
        self.__name__ = func.__name__
        
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        value = self.func(obj)
        # 计算一次后，将值缓存在实例的__dict__中
        obj.__dict__[self.__name__] = value
        return value
        
class WebPage:
    def __init__(self, url):
        self.url = url
        
    @LazyProperty
    def content(self):
        print(f"正在从{self.url}加载内容...")
        # 模拟网络请求
        import time
        time.sleep(1)
        return f"来自 {self.url} 的页面内容"
        
# 创建WebPage实例
page = WebPage("https://example.com")

# 第一次访问content属性时会触发加载
print("第一次访问:")
print(page.content)

# 第二次访问会直接使用缓存值，不会再次加载
print("\n第二次访问:")
print(page.content)
```

输出：
```
第一次访问:
正在从https://example.com加载内容...
来自 https://example.com 的页面内容

第二次访问:
来自 https://example.com 的页面内容
```

### 案例3：属性类型检查

下面是一个使用描述符实现类型检查的例子：

```python
class Typed:
    def __init__(self, name, expected_type):
        self.name = name
        self.expected_type = expected_type
        
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        return obj.__dict__[self.name]
        
    def __set__(self, obj, value):
        if not isinstance(value, self.expected_type):
            raise TypeError(f"'{self.name}'属性必须是{self.expected_type.__name__}类型")
        obj.__dict__[self.name] = value
        
class Product:
    name = Typed('name', str)
    price = Typed('price', (int, float))
    quantity = Typed('quantity', int)
    
    def __init__(self, name, price, quantity):
        self.name = name
        self.price = price
        self.quantity = quantity
        
    def total_cost(self):
        return self.price * self.quantity
        
# 创建有效的Product对象
product = Product("笔记本电脑", 5999, 2)
print(f"产品: {product.name}, 单价: ¥{product.price}, 数量: {product.quantity}")
print(f"总价: ¥{product.total_cost()}")

# 尝试设置无效类型
try:
    product.quantity = "三" # 会引发TypeError
except TypeError as e:
    print(f"错误: {e}")
```

输出：
```
产品: 笔记本电脑, 单价: ¥5999, 数量: 2
总价: ¥11998
错误: 'quantity'属性必须是int类型
```

## 描述符在内建函数和标准库中的应用

Python中的许多内建功能都是基于描述符实现的：

1. **函数和方法**：当你在类中定义一个方法，Python会将其转换为描述符。
2. **`property()`**：Python的内建`property`函数是描述符的一种应用。
3. **`classmethod`和`staticmethod`**：这两个装饰器在内部使用描述符来改变方法的行为。

例如，当你使用`@property`装饰器时，实际上是在创建一个描述符：

```python
class Person:
    def __init__(self, name):
        self._name = name
        
    @property
    def name(self):
        return self._name
        
    @name.setter
    def name(self, value):
        if not isinstance(value, str):
            raise TypeError("名字必须是字符串")
        self._name = value
        
person = Person("李四")
print(person.name)  # 输出：李四
person.name = "王五"  # 调用setter
print(person.name)  # 输出：王五
```

输出：
```
李四
王五
```

## 描述符设计的最佳实践

在使用描述符时，有一些最佳实践可以遵循：

1. **避免命名冲突**：存储数据时，使用与属性名不同的名称（例如，通过添加前缀或使用实例的`__dict__`）。
2. **使用弱引用**：如果描述符需要保存对所属实例的引用，考虑使用`weakref`模块以避免循环引用。
3. **文档化**：清楚地记录描述符的行为，特别是它如何处理属性的获取和设置。
4. **优先使用高级API**：如果只是需要简单的属性验证或计算，优先考虑使用`@property`而不是自定义描述符。

```python
import weakref

class WeakRefDescriptor:
    def __init__(self):
        self.references = {}
        
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        if obj not in self.references:
            return None
        # 从弱引用中获取实际的对象
        return self.references[obj]()
        
    def __set__(self, obj, value):
        # 存储值的弱引用
        self.references[obj] = weakref.ref(value)
```

## 总结

描述符提供了一种强大的方式来控制属性的访问，使Python能够实现许多高级功能。主要要点包括：

1. 描述符是实现了`__get__`、`__set__`或`__delete__`方法的对象
2. 数据描述符（实现了`__get__`和`__set__`）优先级高于实例属性
3. 非数据描述符（只实现了`__get__`）优先级低于实例属性
4. 描述符广泛用于属性验证、惰性计算和类型检查等场景
5. Python的许多内建功能（如`property`、方法、类方法等）都是基于描述符实现的

虽然描述符对于初学者来说可能看起来比较复杂，但它们是Python元编程工具箱中的一个强大工具，能够帮助你编写更灵活、更可维护的代码。

## 练习

1. 创建一个`Range`描述符，确保某个属性的值始终在指定的范围内。
2. 实现一个`Password`描述符，存储加密后的密码，且不允许直接读取原始密码。
3. 使用描述符创建一个单位转换系统，可以自动在不同单位（如英尺/米、英镑/千克）之间转换。

## 附加资源

- [Python官方文档 - 描述符指南](https://docs.python.org/zh-cn/3/howto/descriptor.html)
- [Python数据模型 - 实现描述符](https://docs.python.org/zh-cn/3/reference/datamodel.html#implementing-descriptors)
- Raymond Hettinger的《Python描述符指南》文章

了解描述符可以帮助你更深入地理解Python的内部工作原理，并为你提供强大的工具来创建更灵活、更高级的Python代码。