---
title: Grafana链接配置
description: 学习如何在Grafana中配置Loki数据源，实现日志数据的可视化与分析。
---

# Grafana链接配置

## 介绍

Grafana是一个开源的监控与可视化平台，而Loki是专为日志聚合设计的系统。通过将Loki配置为Grafana的数据源，您可以轻松查询和分析日志数据。本章将指导您完成从基础配置到高级查询的全过程。

## 前置条件

在开始前，请确保：
- 已安装并运行Grafana实例（版本8.0+）
- 已部署Loki服务（版本2.0+）
- 拥有Grafana管理员权限

## 基础配置步骤

### 1. 添加Loki数据源

1. 登录Grafana控制台
2. 导航至 **Configuration > Data Sources**
3. 点击 **Add data source** 按钮
4. 从列表中选择 **Loki**

### 2. 配置连接参数

```yaml
# 典型配置示例
url: http://localhost:3100  # Loki 服务器地址
maxLines: 1000             # 单次查询返回的最大日志行数
```

:::note
如果Loki启用了认证，需在 **Auth** 选项卡中配置凭据。对于基础认证，格式为 `user:password`。
:::

### 3. 测试连接

点击 **Save & Test** 按钮，您应该看到绿色提示框显示：
```
Data source connected and labels found.
```

## 高级配置选项

### 派生字段配置

通过派生字段(derived fields)可以将日志内容中的特定值转换为可点击链接：

```json
{
  "derivedFields": [
    {
      "matcherRegex": "traceID=(\\w+)",
      "name": "traceID",
      "url": "http://jaeger.example.com/trace/${__value.raw}"
    }
  ]
}
```

### 变量与模板

在Dashboard中使用变量实现动态查询：

```sql
{cluster="$cluster", namespace="$namespace"} |= "error"
```

:::tip
变量可通过Dashboard设置中的 **Variables** 菜单定义，支持从Loki标签自动加载选项。
:::

## 实际案例：错误日志监控

### 场景描述
监控Kubernetes集群中`prod`命名空间的所有错误日志，并标注严重等级。

### 配置步骤

1. 创建新Dashboard
2. 添加 **Logs** 面板
3. 输入查询：
   ```sql
   {namespace="prod"} |~ "error|warning|critical"
   ```
4. 配置日志级别高亮：
   ```mermaid
   graph LR
   A[日志内容] --> B{包含"error"?}
   B -->|是| C[红色高亮]
   B -->|否| D{包含"warning"?}
   D -->|是| E[黄色高亮]
   ```

## 常见问题解决

:::caution 连接问题排查
- **错误**：`Failed to call resource`
  - 检查Loki服务是否运行
  - 验证网络连通性（如跨命名空间需配置Service）
- **错误**：`invalid credentials`
  - 确认认证配置（如Bearer Token或基本认证）
:::

## 总结与练习

### 关键知识点
- Loki数据源的基础配置方法
- 派生字段的应用场景
- 动态查询变量的使用技巧

### 实践练习
1. 创建一个显示最近1小时所有HTTP 500错误的Dashboard
2. 配置派生字段将用户ID链接到用户管理系统
3. 设置自动刷新间隔为30秒

### 扩展阅读
- [Grafana官方文档 - Loki数据源](https://grafana.com/docs/grafana/latest/datasources/loki/)
- [Loki日志查询语法详解](https://grafana.com/docs/loki/latest/logql/)