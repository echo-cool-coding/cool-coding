---
title: 存储迁移
description: 学习如何在Grafana Loki中进行存储迁移，包括基本概念、操作步骤和实际应用场景。
---

# 存储迁移

## 介绍

存储迁移是将Grafana Loki的数据从一个存储后端迁移到另一个存储后端的过程。随着业务需求的变化或存储技术的演进，你可能需要将Loki的数据从本地文件系统迁移到云存储（如S3、GCS），或者在不同云存储提供商之间切换。本指南将帮助你理解Loki存储迁移的核心概念和操作步骤。

## 为什么需要存储迁移

以下是一些常见的存储迁移场景：
- 从开发环境迁移到生产环境
- 从本地存储迁移到云存储以提高可扩展性
- 更换云存储提供商以降低成本
- 升级Loki版本时兼容性要求

:::note
存储迁移通常是一个离线操作，意味着在迁移过程中Loki服务可能需要暂停。
:::

## 迁移前准备

1. **备份数据**：确保你有当前存储的完整备份
2. **评估数据量**：了解需要迁移的数据量以预估时间
3. **检查兼容性**：确认目标存储支持所需的Loki版本
4. **准备目标存储**：配置好目标存储的访问权限

## 存储迁移方法

### 方法一：使用Loki的boltdb-shipper

如果你使用的是`boltdb-shipper`模式（单存储模式），迁移相对简单：

```bash
# 1. 停止Loki服务
sudo systemctl stop loki

# 2. 将索引文件复制到新存储
aws s3 sync s3://old-bucket/path/to/index s3://new-bucket/path/to/index

# 3. 将块文件复制到新存储
aws s3 sync s3://old-bucket/path/to/chunks s3://new-bucket/path/to/chunks

# 4. 更新Loki配置文件中的存储路径
# storage_config:
#   aws:
#     s3: s3://new-bucket/path

# 5. 重启Loki服务
sudo systemctl start loki
```

### 方法二：使用LogCLI工具

对于更复杂的迁移，可以使用Loki的`logcli`工具：

```bash
# 从旧存储查询所有流
logcli series --from=168h --output=json > all_series.json

# 使用查询结果从旧存储读取数据并写入新存储
cat all_series.json | jq -r '.[]' | while read stream; do
  logcli query "$stream" --from=168h --quiet > temp.log
  logcli push --quiet -t "$stream" < temp.log
done
```

## 实际案例：从本地文件系统迁移到S3

假设我们有一个本地运行的Loki实例，使用文件系统存储，现在要迁移到AWS S3：

1. **当前配置**（部分）：
```yaml
storage_config:
  filesystem:
    directory: /loki/storage
```

2. **目标配置**：
```yaml
storage_config:
  aws:
    s3: s3://my-loki-bucket/prefix
    region: us-east-1
```

3. **迁移步骤**：
```bash
# 安装AWS CLI并配置凭证
aws configure

# 使用sync命令迁移数据
aws s3 sync /loki/storage/chunks s3://my-loki-bucket/prefix/chunks
aws s3 sync /loki/storage/index s3://my-loki-bucket/prefix/index
```

## 验证迁移

迁移完成后，验证数据完整性：

```bash
# 检查新存储中的文件数量
aws s3 ls s3://my-loki-bucket/prefix/chunks/ --recursive | wc -l

# 查询一些已知日志流确认数据存在
logcli query '{job="varlogs"}' --limit=10
```

## 迁移后清理

确认新存储工作正常后，可以清理旧存储：

```bash
# 保留备份一段时间后再清理
rm -rf /loki/storage/*
```

## 总结

存储迁移是Loki运维中的重要操作，需要谨慎规划。关键步骤包括：

1. 准备目标存储环境
2. 选择合适的迁移方法
3. 执行数据迁移
4. 验证数据完整性
5. 切换配置并清理旧存储

:::caution
大型Loki部署的迁移可能需要数小时甚至数天，请确保预留足够的维护窗口。
:::

## 附加资源

1. [Loki官方文档 - 存储配置](https://grafana.com/docs/loki/latest/configuration/storage/)
2. [AWS CLI S3文档](https://docs.aws.amazon.com/cli/latest/reference/s3/)
3. [LogCLI使用指南](https://grafana.com/docs/loki/latest/getting-started/logcli/)

## 练习

1. 在测试环境中设置一个本地文件系统存储的Loki实例
2. 生成一些测试日志数据
3. 练习将数据迁移到MinIO（S3兼容存储）
4. 验证迁移后的查询功能是否正常