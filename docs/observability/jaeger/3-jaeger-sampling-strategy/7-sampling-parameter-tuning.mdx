---
title: 采样参数调优
description: 学习如何通过调整Jaeger的采样参数来优化分布式追踪系统的性能和资源消耗。
---

# 采样参数调优

## 介绍

在分布式系统中，Jaeger作为一款流行的追踪工具，通过采样策略（Sampling Strategy）控制哪些请求的追踪数据会被收集和分析。采样参数调优是平衡系统性能与数据完整性的关键步骤——采样率过高可能导致存储压力，而采样率过低可能丢失重要信息。本文将介绍Jaeger的采样参数类型、调优方法及实际案例。

---

## 采样策略类型

Jaeger支持以下采样策略：
1. **固定采样（Probabilistic）**：按固定概率采样（如 `0.1` 表示10%的请求被采样）。
2. **速率限制采样（Rate Limiting）**：限制每秒最多采样的请求数（如 `100`/秒）。
3. **动态采样（Adaptive）**：根据系统负载自动调整采样率（需配合Jaeger后端配置）。

---

## 关键参数与调优方法

### 1. 固定采样参数
通过 `sampling.strategies.json` 文件配置：
```json
{
  "default_strategy": {
    "type": "probabilistic",
    "param": 0.1
  }
}
```
- **调优建议**：
  - 高流量系统：降低 `param`（如 `0.01`-`0.05`）。
  - 调试阶段：临时提高 `param`（如 `1.0`）。

### 2. 速率限制采样参数
```json
{
  "default_strategy": {
    "type": "rateLimiting",
    "param": 100
  }
}
```
- **调优建议**：
  - 根据后端存储能力调整 `param`。例如，ES集群性能较弱时，降低为 `50`/秒。

### 3. 动态采样
需在Jaeger Collector中启用自适应采样：
```yaml
# Jaeger Collector配置示例
adaptive_sampling:
  memory_target: 0.5  # 内存使用率目标（50%）
```
---

## 实际案例

### 案例：电商大促期间的采样调优
**场景**：某电商在双11期间流量增长10倍，需避免Jaeger存储过载。
1. **初始配置**：固定采样 `param=0.1`，导致ES集群负载过高。
2. **调优步骤**：
   - 改为速率限制采样 `param=200`/秒。
   - 对关键支付服务单独配置固定采样 `param=1.0`（全采样）。
3. **结果**：存储压力下降60%，关键链路数据完整保留。

---

## 总结

采样参数调优需要结合业务场景和系统资源：
1. **监控先行**：观察存储负载和链路完整性。
2. **渐进调整**：从保守值开始，逐步优化。
3. **差异化采样**：关键服务优先保障。

:::tip 练习
1. 在本地Jaeger中，尝试将固定采样从 `0.1` 调整为 `0.01`，观察追踪数据变化。
2. 使用速率限制采样时，如何计算适合的 `param`？（提示：根据QPS估算）
:::

---

## 扩展资源
- [Jaeger官方文档：采样策略](https://www.jaegertracing.io/docs/latest/sampling/)
- 《分布式追踪：原理与实践》第5章
``` 

注意：实际使用时需移除外层的 `