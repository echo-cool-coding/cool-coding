---
title: 插件与扩展
description: 了解Jaeger生态系统中插件与扩展的工作原理，学习如何通过自定义组件增强分布式追踪功能。
---

# 插件与扩展

## 介绍

在Jaeger生态系统中，**插件与扩展**是增强其核心功能的关键机制。它们允许开发者在不修改Jaeger源代码的情况下，集成自定义存储后端、采样策略、认证方式等组件。本指南将帮助你理解插件与扩展的设计理念、实现方式，并通过实际案例展示它们的应用场景。

:::note 核心概念
- **插件**：动态加载的模块，通常以共享库（如`.so`或`.dll`文件）形式存在，实现Jaeger定义的接口。
- **扩展**：通过配置文件或API集成的功能，可能依赖插件或独立运行。
:::

---

## 插件的工作原理

Jaeger通过Go的插件系统（`plugin.Handler`接口）加载外部组件。以下是一个简单的插件生命周期：

```mermaid
graph LR
  A[开发者实现接口] --> B[编译为共享库]
  B --> C[Jaeger配置文件中声明]
  C --> D[运行时动态加载]
```

### 示例：自定义存储插件

假设我们需要将追踪数据存储到自定义的数据库中：

1. **实现接口**：
   ```go
   package main

   import (
     "github.com/jaegertracing/jaeger/storage/spanstore"
   )

   type MyStoragePlugin struct{}

   func (p *MyStoragePlugin) WriteSpan(span *model.Span) error {
     // 自定义写入逻辑
     return nil
   }

   func (p *MyStoragePlugin) GetTrace(traceID model.TraceID) (*model.Trace, error) {
     // 自定义查询逻辑
     return nil, nil
   }
   ```

2. **编译插件**：
   ```bash
   go build -buildmode=plugin -o myplugin.so myplugin.go
   ```

3. **配置Jaeger**（`jaeger-config.yaml`）：
   ```yaml
   storage:
     type: grpc-plugin
     grpc-plugin:
       binary: /path/to/myplugin.so
   ```

---

## 扩展机制

Jaeger支持通过以下方式扩展功能：

### 1. 采样策略扩展
通过实现`sampling.Sampler`接口，可以自定义采样逻辑。例如，根据请求头决定采样率：

```go
type HeaderSampler struct {
  HeaderName string
}

func (s *HeaderSampler) IsSampled(traceID model.TraceID, operation string) bool {
  // 从上下文中读取Header并决策
  return true
}
```

### 2. 认证扩展
通过gRPC拦截器添加认证层：
```go
func AuthInterceptor(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (resp interface{}, err error) {
  if !isAuthorized(ctx) {
    return nil, status.Error(codes.PermissionDenied, "unauthorized")
  }
  return handler(ctx, req)
}
```

---

## 实际案例

### 案例：集成AWS X-Ray存储
1. **场景**：需要将Jaeger数据同步到AWS X-Ray
2. **解决方案**：
   - 实现`spanstore.Writer`接口的X-Ray适配器
   - 通过插件机制加载
3. **优势**：
   - 保留Jaeger的UI和查询能力
   - 同时利用X-Ray的分析功能

---

## 总结与练习

### 关键点总结
1. 插件需实现Jaeger定义的接口并编译为共享库
2. 扩展可通过配置或代码集成，灵活性更高
3. 官方提供[插件SDK](https://github.com/jaegertracing/jaeger/tree/main/plugin)简化开发

### 练习建议
1. 尝试编写一个将Span数据输出到控制台的简单插件
2. 修改采样策略，对特定操作名的请求100%采样
3. 阅读Jaeger官方插件源码（如`badger`存储插件）

:::tip 进阶资源
- [Jaeger插件开发指南](https://jaegertracing.io/docs/latest/spi/)
- [Go插件系统文档](https://golang.org/pkg/plugin/)
:::