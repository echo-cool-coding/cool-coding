---
title: Jaeger 采样策略
description: 了解Jaeger中的采样策略及其在分布式追踪中的应用，帮助开发者优化性能与数据收集的平衡。
---

# Jaeger 采样策略

## 介绍

Jaeger是一个开源的分布式追踪系统，用于监控和排查微服务架构中的问题。在分布式系统中，每个请求可能会经过多个服务，产生大量的追踪数据。如果记录所有请求的追踪数据，可能会导致存储和性能问题。因此，**采样策略**成为平衡数据收集与系统开销的关键机制。

采样策略决定了哪些请求的追踪数据会被记录和存储。Jaeger提供了多种采样策略，开发者可以根据实际需求选择合适的策略。

## 为什么需要采样策略？

在高流量的生产环境中，记录每个请求的追踪数据会带来以下问题：
1. **存储成本高**：大量追踪数据会占用大量存储空间。
2. **性能开销**：收集和处理追踪数据会增加系统负载。
3. **数据冗余**：许多请求的追踪数据可能重复或无关紧要。

采样策略通过选择性地记录请求，帮助解决这些问题。

---

## Jaeger 的采样策略类型

Jaeger支持以下几种采样策略：

### 1. 恒定采样（Constant Sampling）
恒定采样是最简单的策略，它以一个固定的概率决定是否采样。例如：
- 采样概率为1.0（100%）：记录所有请求。
- 采样概率为0.1（10%）：随机记录10%的请求。

**配置示例**：
```json
{
  "sampler": {
    "type": "const",
    "param": 1
  }
}
```

**适用场景**：
- 开发和测试环境，需要完整追踪数据。
- 低流量生产环境。

:::note
恒定采样在高流量环境中可能导致存储压力过大。
:::

### 2. 概率采样（Probabilistic Sampling）
概率采样与恒定采样类似，但更灵活，允许设置一个介于0和1之间的采样概率。

**配置示例**：
```json
{
  "sampler": {
    "type": "probabilistic",
    "param": 0.5
  }
}
```

**适用场景**：
- 需要平衡数据量和存储成本的中等流量环境。

### 3. 速率限制采样（Rate Limiting Sampling）
速率限制采样通过限制每秒采样的请求数来控制数据量。例如，每秒最多采样5个请求。

**配置示例**：
```json
{
  "sampler": {
    "type": "rateLimiting",
    "param": 5
  }
}
```

**适用场景**：
- 高流量环境，需要严格控制数据量。
- 需要避免突发流量导致存储压力。

### 4. 动态采样（Dynamic Sampling）
动态采样根据请求的属性（如HTTP方法、路径等）动态调整采样率。例如，对关键路径（如支付接口）提高采样率，对其他路径降低采样率。

**配置示例**：
```json
{
  "sampler": {
    "type": "dynamic",
    "param": {
      "defaultSamplingProbability": 0.1,
      "perOperationSampling": {
        "/api/payment": 0.5,
        "/api/login": 0.2
      }
    }
  }
}
```

**适用场景**：
- 需要根据业务重要性调整采样率的场景。
- 混合了关键和非关键路径的系统。

---

## 实际案例

### 案例1：电商平台的采样策略
假设一个电商平台的流量分布如下：
- 首页：高流量，低重要性。
- 支付接口：中等流量，高重要性。

**采样策略设计**：
1. 对首页使用概率采样，采样率为0.1。
2. 对支付接口使用动态采样，采样率为0.5。

**配置**：
```json
{
  "sampler": {
    "type": "dynamic",
    "param": {
      "defaultSamplingProbability": 0.1,
      "perOperationSampling": {
        "/api/payment": 0.5
      }
    }
  }
}
```

### 案例2：微服务架构的全局采样
在一个由多个微服务组成的系统中，可以在入口服务（如API网关）设置采样策略，并将采样决策传递给下游服务。

**配置**：
```json
{
  "sampler": {
    "type": "probabilistic",
    "param": 0.2
  },
  "propagation": "jaeger"
}
```

---

## 总结

Jaeger的采样策略是分布式追踪中不可或缺的一部分，它帮助开发者在数据收集和系统性能之间找到平衡。以下是关键点：
1. **恒定采样**：简单直接，适合低流量环境。
2. **概率采样**：灵活，适合中等流量环境。
3. **速率限制采样**：严格控制数据量，适合高流量环境。
4. **动态采样**：根据业务需求调整采样率，适合复杂系统。

:::tip
在生产环境中，建议从低采样率开始，逐步调整以避免存储和性能问题。
:::

## 附加资源
1. [Jaeger官方文档](https://www.jaegertracing.io/docs/)
2. [分布式追踪最佳实践](https://opentracing.io/docs/best-practices/)

## 练习
1. 在本地Jaeger实例中配置不同的采样策略，观察追踪数据的变化。
2. 设计一个动态采样策略，为你的项目中的关键路径设置更高的采样率。