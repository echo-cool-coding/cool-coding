---
title: Node.js客户端集成
description: "学习如何在Node.js应用中集成Jaeger客户端，实现分布式追踪功能。本教程包含基础配置、代码示例和实际应用场景。"
---

# Node.js客户端集成

## 介绍

Jaeger 是一个开源的分布式追踪系统，用于监控和排查微服务架构中的问题。通过集成 Jaeger 客户端到你的 Node.js 应用中，你可以追踪请求在不同服务之间的流转情况，从而更好地理解系统行为并优化性能。

在本教程中，我们将逐步介绍如何在 Node.js 应用中集成 Jaeger 客户端，并通过实际案例展示其应用场景。

---

## 准备工作

在开始之前，确保你已经完成以下准备工作：
1. 安装 Node.js（推荐版本 14 或更高）。
2. 一个运行中的 Jaeger 服务（可以是本地实例或远程服务）。
3. 一个基础的 Node.js 应用（可以是 Express、Koa 或其他框架）。

---

## 安装 Jaeger 客户端库

首先，安装 Jaeger 客户端库及其依赖项：

```bash
npm install jaeger-client opentracing
```

- `jaeger-client`：Jaeger 的官方 Node.js 客户端库。
- `opentracing`：OpenTracing API 的实现，Jaeger 是基于 OpenTracing 规范的。

---

## 基础配置

以下是一个基础的 Jaeger 客户端配置示例：

```javascript
const { initTracer } = require('jaeger-client');
const opentracing = require('opentracing');

// 初始化 Jaeger Tracer
const config = {
  serviceName: 'my-nodejs-app',
  reporter: {
    agentHost: 'localhost', // Jaeger Agent 的主机地址
    agentPort: 6832, // Jaeger Agent 的 UDP 端口
  },
  sampler: {
    type: 'const',
    param: 1, // 采样率：1 表示全部采样
  },
};

const options = {
  logger: {
    info(msg) {
      console.log('INFO:', msg);
    },
    error(msg) {
      console.error('ERROR:', msg);
    },
  },
};

const tracer = initTracer(config, options);
```

### 配置说明：
1. `serviceName`：你的应用名称，会在 Jaeger UI 中显示。
2. `reporter`：配置 Jaeger Agent 的地址和端口。
3. `sampler`：配置采样策略，`const` 表示固定采样率。

---

## 创建和记录 Span

Span 是 Jaeger 中的基本追踪单元，代表一个操作或请求。以下是如何创建和记录 Span 的示例：

```javascript
// 创建一个根 Span
const rootSpan = tracer.startSpan('my-operation');

// 添加标签（Tags）到 Span
rootSpan.setTag('http.method', 'GET');
rootSpan.setTag('http.url', '/api/data');

// 模拟一个操作
setTimeout(() => {
  // 记录日志（Logs）
  rootSpan.log({ event: 'operation-completed', message: 'Operation finished successfully' });

  // 结束 Span
  rootSpan.finish();
}, 1000);
```

### 输出：
在 Jaeger UI 中，你将看到一个名为 `my-operation` 的 Span，包含标签和日志信息。

---

## 实际案例：Express 应用集成

以下是一个完整的 Express 应用集成 Jaeger 的示例：

```javascript
const express = require('express');
const { initTracer } = require('jaeger-client');
const opentracing = require('opentracing');

// 初始化 Jaeger Tracer
const tracer = initTracer({
  serviceName: 'express-app',
  reporter: {
    agentHost: 'localhost',
    agentPort: 6832,
  },
  sampler: {
    type: 'const',
    param: 1,
  },
}, {
  logger: console,
});

const app = express();

// 中间件：为每个请求创建 Span
app.use((req, res, next) => {
  const span = tracer.startSpan(req.path);
  span.setTag('http.method', req.method);
  span.setTag('http.url', req.url);

  // 将 Span 注入请求上下文
  req.span = span;

  // 请求完成后结束 Span
  res.on('finish', () => {
    span.setTag('http.status_code', res.statusCode);
    span.finish();
  });

  next();
});

app.get('/api/data', (req, res) => {
  const span = req.span;
  span.log({ event: 'data-fetch', message: 'Fetching data from database' });

  // 模拟数据库查询
  setTimeout(() => {
    res.json({ data: 'Hello, Jaeger!' });
  }, 500);
});

app.listen(3000, () => {
  console.log('Server running on http://localhost:3000');
});
```

### 测试：
1. 访问 `http://localhost:3000/api/data`。
2. 在 Jaeger UI 中查看追踪数据。

---

## 总结

通过本教程，你学会了：
1. 如何安装和配置 Jaeger 客户端库。
2. 如何创建和记录 Span。
3. 如何在 Express 应用中集成 Jaeger。

分布式追踪是微服务架构中不可或缺的工具，能够帮助你快速定位性能瓶颈和排查问题。

---

## 附加资源

1. [Jaeger 官方文档](https://www.jaegertracing.io/docs/)
2. [OpenTracing 规范](https://opentracing.io/)
3. 练习：尝试将 Jaeger 集成到你的其他 Node.js 项目中，并观察追踪数据。

:::tip
如果你遇到问题，可以查看 Jaeger 客户端的日志或调整采样率（`sampler.param`）来捕获更多数据。
:::