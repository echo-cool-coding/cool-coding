---
title: 时间序列分析
description: "学习如何在 Zipkin 中进行时间序列分析，理解分布式系统中的延迟模式与性能趋势"
---

## 介绍

时间序列分析是 Zipkin 数据查询与分析中的核心概念，它通过按时间顺序排列的数据点（如请求延迟、错误率等）来识别系统性能的趋势、周期性或异常。在分布式系统中，这种分析能帮助你快速定位延迟瓶颈或突发的性能退化。

:::note
**为什么重要？**  
时间序列数据可以揭示肉眼难以察觉的模式，例如：  
- 每日高峰时段的延迟上升  
- 新版本发布后的错误率波动  
- 微服务间调用的周期性超时  
:::

## 基础概念

### 1. 时间序列数据的特点
Zipkin 存储的追踪数据天然具备时间序列特性，例如：
- **时间戳**：每个 Span 的开始/结束时间  
- **数值指标**：延迟（duration）、状态码（status code）等  

```mermaid
graph LR
    A[请求进入] -->|时间戳: 12:00:00| B[服务A处理]
    B -->|时间戳: 12:00:02| C[数据库查询]
    C -->|时间戳: 12:00:03| D[返回响应]
```

### 2. Zipkin 中的时间序列查询
通过 Zipkin 的 API 或 UI 可以提取时间序列数据，例如查询过去1小时的服务延迟：

```bash
# 示例：查询服务"backend"的P99延迟
curl "http://zipkin/api/v2/dependencies?endTs=$(date +%s)000&lookback=3600000"
```

输出示例（JSON）：
```json
{
  "serviceName": "backend",
  "metrics": [
    {
      "timestamp": 1625097600000,
      "p99": 450,
      "p50": 120
    }
  ]
}
```

## 实际案例分析

### 场景：检测周期性延迟峰值
假设你的电商网站在每天上午10点出现响应变慢，通过 Zipkin 分析步骤：

1. **收集数据**：导出过去7天10:00-11:00的延迟数据  
2. **可视化趋势**：使用工具（如Grafana）绘制折线图  
3. **关联事件**：发现峰值与每日库存同步任务重合  

:::tip
使用 `zipkin-dependencies` 工具生成服务依赖图，结合时间序列数据定位上下游影响。
:::

## 代码示例：Python 分析脚本

以下脚本使用 Zipkin API 获取数据并绘制简单趋势图：

```python
import requests
import matplotlib.pyplot as plt

# 获取最近1小时的数据
response = requests.get(
    "http://zipkin/api/v2/traces?serviceName=frontend&lookback=3600000&limit=1000"
)
traces = response.json()

# 提取时间戳和延迟
timestamps = [span['timestamp'] for trace in traces for span in trace]
durations = [span['duration'] for trace in traces for span in trace]

# 绘制散点图
plt.scatter(timestamps, durations, alpha=0.5)
plt.title("Request Latency Over Time")
plt.xlabel("Timestamp (ms)")
plt.ylabel("Duration (μs)")
plt.show()
```

## 总结

- **核心价值**：时间序列分析将离散的追踪数据转化为可操作的性能洞察  
- **常用工具**：结合 Zipkin API + Pandas/Grafana 进行深度分析  
- **扩展场景**：  
  - 监控新版本发布的性能影响  
  - 自动化异常检测（如基于标准差告警）  

## 延伸资源

1. [Zipkin 官方文档 - 数据聚合](https://zipkin.io/pages/data_aggregation.html)  
2. 练习：导出你本地 Zipkin 实例的数据，尝试找出周末和工作日的延迟差异