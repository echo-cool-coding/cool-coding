---
title: 错误追踪分析
description: "学习如何使用Zipkin进行分布式系统中的错误追踪分析，识别异常并定位问题根源。"
---

# 错误追踪分析

## 介绍

在分布式系统中，错误可能发生在任何服务或组件中。Zipkin的错误追踪分析功能帮助开发者快速定位异常请求的源头，分析错误传播路径，并提供关键上下文信息（如错误类型、时间戳和关联服务）。本节将介绍如何通过Zipkin UI和API实现高效错误分析。

## 核心概念

### 1. 错误标识
Zipkin通过以下方式标记错误：
- `error` 标签（`error=true`）
- HTTP状态码（如 `500` 系列）
- 自定义错误注解（如 `error.message`）

```json
// Span中的错误标记示例
{
  "tags": {
    "error": "true",
    "error.message": "Database connection timeout",
    "http.status_code": "503"
  }
}
```

### 2. 错误传播路径
错误可能通过服务调用链传播。Zipkin的可视化追踪图展示错误如何从源头扩散：

```mermaid
graph LR
  A[前端服务] -->|HTTP| B[订单服务]
  B -->|RPC| C[支付服务]
  C -->|异常| D[数据库]
  style D stroke:#ff0000,stroke-width:2px
```

## 操作指南

### 步骤1：筛选错误追踪
在Zipkin UI中：
1. 点击「Search」标签页
2. 添加筛选条件：
   - `error=true`
   - 时间范围选择
3. 点击「Find Traces」按钮

:::tip
使用 `duration` 筛选可以快速定位高延迟的错误请求。
:::

### 步骤2：分析错误详情
点击具体追踪进入详情页，重点关注：
- **红色标记**的异常Span
- **错误堆栈信息**（如果有）
- **服务依赖路径**（通过「Dependencies」视图）

### 步骤3：API查询示例
通过Zipkin API直接获取错误数据：

```bash
curl -X GET "http://localhost:9411/api/v2/traces?limit=10&annotationQuery=error=true"
```

响应示例（片段）：
```json
{
  "traceId": "e3b0c44298fc1c14",
  "spans": [
    {
      "name": "get_user_data",
      "tags": {
        "error": "true",
        "error.object": "NullPointerException"
      }
    }
  ]
}
```

## 实际案例

### 电商系统超时故障
**场景**：用户支付时出现`504 Gateway Timeout`错误。

**分析过程**：
1. 在Zipkin中筛选 `http.status_code=504`
2. 发现错误源自支付服务调用风控服务超时
3. 检查风控服务Span发现数据库查询耗时超过3秒
4. 最终定位到未优化的SQL查询：

```sql
-- 问题查询
SELECT * FROM risk_rules WHERE user_id=123 
ORDER BY create_time DESC;
```

**解决方案**：添加索引并优化查询语句。

## 总结

通过Zipkin进行错误追踪分析的关键点：
- 善用标签筛选快速定位错误
- 通过可视化依赖图理解错误传播
- 结合业务日志综合分析根本原因

## 扩展资源
1. [Zipkin官方错误分析文档](https://zipkin.io/pages/data_model.html)
2. 练习：在本地环境中模拟以下错误场景并分析：
   - 服务间HTTP超时
   - 数据库连接池耗尽
   - 消息队列消费失败