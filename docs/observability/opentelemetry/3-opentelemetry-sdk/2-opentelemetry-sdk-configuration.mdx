---
title: OpenTelemetry SDK配置
description: 学习如何配置OpenTelemetry SDK来收集、处理和导出应用程序的遥测数据。适合初学者的完整指南。
---

## 介绍

OpenTelemetry SDK是OpenTelemetry项目的核心组件，它允许开发者在应用程序中生成、收集和导出遥测数据（如追踪、指标和日志）。配置SDK是使用OpenTelemetry的第一步，它决定了数据如何被采集、处理以及发送到何处。

在本指南中，我们将逐步介绍如何配置OpenTelemetry SDK，并提供实际示例帮助你快速上手。

## 基本配置步骤

### 1. 安装SDK

首先，你需要安装OpenTelemetry SDK。以下是一个Node.js项目的示例：

```bash
npm install @opentelemetry/sdk-node @opentelemetry/api
```

### 2. 初始化SDK

初始化SDK是配置的核心部分。以下是一个基本的初始化示例：

```javascript
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { ConsoleSpanExporter } = require('@opentelemetry/sdk-trace-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');

const sdk = new NodeSDK({
  traceExporter: new ConsoleSpanExporter(),
  instrumentations: [getNodeAutoInstrumentations()]
});

sdk.start();
```

### 3. 配置导出器（Exporter）

导出器决定了遥测数据发送到哪里。OpenTelemetry支持多种导出器，例如：

- `ConsoleSpanExporter`：将数据输出到控制台。
- `OTLPTraceExporter`：将数据发送到OpenTelemetry Collector或兼容的后端（如Jaeger、Prometheus）。

以下是一个使用`OTLPTraceExporter`的示例：

```javascript
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

const traceExporter = new OTLPTraceExporter({
  url: 'http://localhost:4318/v1/traces',
});
```

### 4. 配置处理器（Processor）

处理器用于在导出数据之前对数据进行处理。常见的处理器包括：

- `SimpleSpanProcessor`：立即导出数据。
- `BatchSpanProcessor`：批量导出数据以提高效率。

以下是使用`BatchSpanProcessor`的示例：

```javascript
const { BatchSpanProcessor } = require('@opentelemetry/sdk-trace-node');

const processor = new BatchSpanProcessor(traceExporter);
```

### 5. 配置资源（Resource）

资源用于标识遥测数据的来源，例如服务名称、版本等。以下是一个配置资源的示例：

```javascript
const { Resource } = require('@opentelemetry/resources');
const { SemanticResourceAttributes } = require('@opentelemetry/semantic-conventions');

const resource = new Resource({
  [SemanticResourceAttributes.SERVICE_NAME]: 'my-service',
  [SemanticResourceAttributes.SERVICE_VERSION]: '1.0.0',
});
```

## 完整配置示例

以下是一个完整的OpenTelemetry SDK配置示例，包括资源、处理器和导出器：

```javascript
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { Resource } = require('@opentelemetry/resources');
const { SemanticResourceAttributes } = require('@opentelemetry/semantic-conventions');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');
const { BatchSpanProcessor } = require('@opentelemetry/sdk-trace-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');

const traceExporter = new OTLPTraceExporter({
  url: 'http://localhost:4318/v1/traces',
});

const sdk = new NodeSDK({
  resource: new Resource({
    [SemanticResourceAttributes.SERVICE_NAME]: 'my-service',
    [SemanticResourceAttributes.SERVICE_VERSION]: '1.0.0',
  }),
  traceExporter: traceExporter,
  spanProcessor: new BatchSpanProcessor(traceExporter),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();
```

## 实际应用场景

假设你正在开发一个微服务架构的电子商务平台，你需要监控以下内容：

1. **订单服务**：跟踪用户下单的延迟和错误。
2. **支付服务**：监控支付成功率和响应时间。
3. **库存服务**：跟踪库存更新的性能。

通过配置OpenTelemetry SDK，你可以将所有这些服务的遥测数据发送到一个集中的后端（如Jaeger或Prometheus），从而实现端到端的监控和故障排查。

## 总结

配置OpenTelemetry SDK是使用OpenTelemetry的第一步，它决定了遥测数据如何被采集、处理和导出。通过本指南，你学会了如何：

1. 安装和初始化SDK。
2. 配置导出器、处理器和资源。
3. 在实际项目中应用OpenTelemetry SDK。

## 附加资源

1. [OpenTelemetry官方文档](https://opentelemetry.io/docs/)
2. [OpenTelemetry GitHub仓库](https://github.com/open-telemetry/opentelemetry-js)
3. [Jaeger官方文档](https://www.jaegertracing.io/docs/)

## 练习

1. 尝试在本地运行一个Node.js应用程序，并配置OpenTelemetry SDK将追踪数据输出到控制台。
2. 修改配置，将数据发送到OpenTelemetry Collector或Jaeger后端。
3. 为你的服务添加自定义属性（如环境变量）到资源中。