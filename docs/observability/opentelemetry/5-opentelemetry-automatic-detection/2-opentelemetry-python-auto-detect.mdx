---
title: OpenTelemetry Python自动检测
description: "学习如何使用OpenTelemetry的Python自动检测功能，无需手动插桩即可收集应用遥测数据。"
---

## 介绍

OpenTelemetry的**自动检测（Auto-instrumentation）**功能允许开发者无需手动修改代码，即可为Python应用添加分布式追踪、指标和日志的收集能力。它通过动态注入代码（如包装库函数）来实现，特别适合快速集成到现有项目中。

:::note 核心优势
- **零代码修改**：自动识别常见框架（如Flask、Django）和库（如requests、SQLAlchemy）。
- **标准化数据**：生成符合OpenTelemetry标准的遥测数据，兼容Jaeger、Prometheus等后端。
- **低开销**：通过采样控制减少性能影响。
:::

## 安装与配置

### 1. 安装依赖
首先安装OpenTelemetry的自动检测包和导出器（以控制台和Jaeger为例）：

```bash
pip install opentelemetry-distro opentelemetry-exporter-jaeger
```

### 2. 自动检测初始化
运行以下命令为你的Python应用生成自动检测脚本：

```bash
opentelemetry-bootstrap --action=install
```

这会自动检测环境中已安装的库（如`flask`、`requests`）并安装对应的检测插件。

## 示例：自动检测Flask应用

### 输入代码
假设有一个简单的Flask应用（`app.py`）：

```python
from flask import Flask
import requests

app = Flask(__name__)

@app.route("/")
def hello():
    response = requests.get("https://api.github.com")
    return f"GitHub API status: {response.status_code}"

if __name__ == "__main__":
    app.run(port=8080)
```

### 启用自动检测
通过环境变量启动自动检测：

```bash
export OTEL_SERVICE_NAME="flask-auto-instrumented"
opentelemetry-instrument --traces_exporter jaeger,console flask run --port=8080
```

### 输出结果
访问`http://localhost:8080`后，控制台会显示追踪数据：

```plaintext
{
  "name": "/",
  "context": {
    "trace_id": "7ba9...",
    "span_id": "a1f2..."
  },
  "attributes": {
    "http.method": "GET",
    "http.route": "/"
  }
}
```

同时，Jaeger UI中会看到完整的调用链（Flask → requests → GitHub API）。

## 实际案例：电商服务监控

### 场景描述
一个使用Django和PostgreSQL的电商服务，需要监控：
1. HTTP请求延迟
2. 数据库查询性能
3. 外部API调用（如支付网关）

### 配置步骤
1. 安装Django和PostgreSQL检测插件：
   ```bash
   pip install opentelemetry-instrumentation-django opentelemetry-instrumentation-psycopg2
   ```
2. 修改`manage.py`，在顶部添加：
   ```python
   from opentelemetry.instrumentation.django import DjangoInstrumentor
   DjangoInstrumentor().instrument()
   ```
3. 启动服务时指定指标导出器：
   ```bash
   export OTEL_METRICS_EXPORTER=prometheus
   opentelemetry-instrument python manage.py runserver
   ```

## 总结

OpenTelemetry的Python自动检测大幅降低了遥测数据的接入成本。关键要点：
- **快速集成**：适合已有项目，无需重构。
- **灵活扩展**：可通过手动插桩补充自动检测未覆盖的部分。
- **多后端支持**：数据可导出到Jaeger、Prometheus、Zipkin等。

## 延伸学习

1. **官方文档**：[OpenTelemetry Python自动检测指南](https://opentelemetry.io/docs/instrumentation/python/automatic/)
2. **练习**：
   - 尝试为FastAPI应用添加自动检测。
   - 比较自动检测与手动插桩的性能差异。
3. **进阶**：自定义采样规则，仅记录慢请求（>500ms）。