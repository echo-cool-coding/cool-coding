---
title: OpenTelemetry .NET自动检测
description: "学习如何使用OpenTelemetry的自动检测功能在.NET应用中轻松收集遥测数据，无需手动代码插桩。"
---

# OpenTelemetry .NET自动检测

## 介绍

OpenTelemetry是一个开源的观测性框架，用于生成、收集和管理遥测数据（如指标、日志和追踪）。**自动检测**（Auto-Instrumentation）是其核心功能之一，允许开发者无需修改代码即可为应用程序添加观测能力。对于.NET开发者，这尤其有用，因为它可以自动捕获ASP.NET Core、HTTP请求、数据库调用等常见操作的遥测数据。

:::note
自动检测通过预定义的库和适配器工作，动态注入观测代码，减少手动插桩的工作量。
:::

## 工作原理

OpenTelemetry .NET自动检测基于以下组件实现：

1. **Instrumentation Libraries**：预定义的库（如`OpenTelemetry.Instrumentation.AspNetCore`）负责拦截特定操作（如HTTP请求）。
2. **活动监听**：利用.NET的`Activity`和`DiagnosticSource`机制监听应用内部事件。
3. **导出器**：将收集的数据发送到后端系统（如Jaeger、Prometheus）。

```mermaid
flowchart LR
    A[应用程序] --> B[自动检测库]
    B --> C[OpenTelemetry SDK]
    C --> D[导出器 Jaeger/Prometheus]
```

## 配置步骤

### 1. 安装必要的NuGet包

在.NET项目中添加以下包：
```bash
dotnet add package OpenTelemetry
dotnet add package OpenTelemetry.Extensions.Hosting
dotnet add package OpenTelemetry.Instrumentation.AspNetCore
dotnet add package OpenTelemetry.Exporter.Console
```

### 2. 配置自动检测

在`Program.cs`中启用自动检测：
```csharp
using OpenTelemetry.Trace;
using OpenTelemetry.Resources;

var builder = WebApplication.CreateBuilder(args);

// 配置OpenTelemetry
builder.Services.AddOpenTelemetry()
    .WithTracing(tracerProviderBuilder =>
    {
        tracerProviderBuilder
            .AddSource("MyApplication")
            .SetResourceBuilder(ResourceBuilder.CreateDefault()
                .AddService("MyService"))
            .AddAspNetCoreInstrumentation() // ASP.NET Core自动检测
            .AddConsoleExporter(); // 输出到控制台
    });

var app = builder.Build();
app.MapGet("/", () => "Hello World!");
app.Run();
```

### 3. 验证输出

启动应用并访问`/`端点，控制台会显示类似以下的追踪数据：
```plaintext
Activity.TraceId:      abc123
Activity.SpanId:       def456
Activity.ParentSpanId: 000000
Activity.DisplayName:   /
Activity.Kind:         Server
```

## 实际案例

### 场景：监控电子商务API
假设你有一个处理订单的ASP.NET Core API，自动检测可以：
1. 追踪每个HTTP请求的延迟和状态码。
2. 记录数据库查询耗时（如果使用`OpenTelemetry.Instrumentation.SqlClient`）。
3. 将数据导出到Jaeger，生成依赖关系图。

:::tip
在开发环境中使用`ConsoleExporter`快速调试，生产环境切换为Jaeger或OTLP导出器。
:::

## 总结

OpenTelemetry的自动检测功能为.NET应用提供了开箱即用的观测能力，尤其适合初学者快速入门。通过简单的配置，你可以：
- 减少手动插桩代码。
- 统一收集指标、日志和追踪。
- 轻松集成多种后端分析工具。

## 下一步

1. **扩展阅读**：
   - [OpenTelemetry .NET官方文档](https://opentelemetry.io/docs/instrumentation/net/)
   - 尝试添加`SqlClient`或`HttpClient`的自动检测。
2. **练习**：
   - 创建一个ASP.NET Core API，启用自动检测并导出到Jaeger。
   - 比较自动检测与手动插桩（如`ActivitySource`）的差异。