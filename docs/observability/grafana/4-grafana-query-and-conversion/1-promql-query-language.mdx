---
title: PromQL查询语言
description: 了解PromQL查询语言的基础知识，掌握如何使用PromQL在Grafana中进行数据查询与转换。
---

# PromQL查询语言

PromQL（Prometheus Query Language）是Prometheus的查询语言，用于从时间序列数据库中提取和操作数据。它允许用户通过灵活的查询表达式来检索、聚合和转换监控数据。PromQL是Grafana中与Prometheus数据源交互的核心工具，掌握它对于监控和数据分析至关重要。

## 什么是PromQL？

PromQL是一种专门为时间序列数据设计的查询语言。它支持对时间序列数据进行实时查询、聚合和转换操作。PromQL的查询结果通常是时间序列数据，可以用于生成图表、告警或其他分析任务。

### 时间序列数据

时间序列数据是按时间顺序记录的数据点集合。例如，CPU使用率、内存使用量、网络流量等都可以表示为时间序列数据。Prometheus将这些数据存储为时间序列数据库，并通过PromQL进行查询。

## PromQL基础语法

PromQL的查询语法相对简单，但功能强大。以下是一些基本的查询语法：

### 1. 选择时间序列

要选择特定的时间序列，可以使用指标名称和标签过滤器。例如：

```promql
http_requests_total{job="api-server", status="200"}
```

这条查询语句会返回所有`job`标签为`api-server`且`status`标签为`200`的`http_requests_total`时间序列。

### 2. 范围查询

范围查询用于获取一段时间内的数据。例如：

```promql
http_requests_total{job="api-server"}[5m]
```

这条查询语句会返回过去5分钟内`job`标签为`api-server`的`http_requests_total`时间序列。

### 3. 聚合操作

PromQL支持多种聚合操作，如`sum`、`avg`、`min`、`max`等。例如：

```promql
sum(http_requests_total{job="api-server"})
```

这条查询语句会返回`job`标签为`api-server`的所有`http_requests_total`时间序列的总和。

### 4. 数学运算

PromQL支持对时间序列进行数学运算。例如：

```promql
rate(http_requests_total{job="api-server"}[5m]) * 60
```

这条查询语句会计算`http_requests_total`的速率，并将其乘以60，得到每分钟的请求数。

## 实际案例

### 案例1：监控API请求速率

假设我们有一个API服务器，我们想要监控其请求速率。我们可以使用以下PromQL查询：

```promql
rate(http_requests_total{job="api-server"}[5m])
```

这条查询语句会返回过去5分钟内`job`标签为`api-server`的`http_requests_total`时间序列的请求速率。

### 案例2：计算CPU使用率

假设我们想要计算某个服务的CPU使用率。我们可以使用以下PromQL查询：

```promql
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100
```

这条查询语句会计算每个实例的CPU空闲时间，并将其转换为CPU使用率。

## 总结

PromQL是Prometheus的核心查询语言，掌握它对于监控和数据分析至关重要。通过本文，我们学习了PromQL的基础语法、范围查询、聚合操作和数学运算，并通过实际案例展示了PromQL的应用场景。

## 附加资源

- [Prometheus官方文档](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Grafana官方文档](https://grafana.com/docs/grafana/latest/datasources/prometheus/)

## 练习

1. 编写一个PromQL查询，计算过去10分钟内某个服务的平均响应时间。
2. 使用PromQL查询某个服务的错误率，并设置告警规则。

:::tip
在编写PromQL查询时，建议使用Grafana的查询编辑器进行实时调试和验证。
:::