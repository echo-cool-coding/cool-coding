---
title: 黑名单与白名单
description: 了解如何在 Prometheus 中使用黑名单和白名单来过滤目标，确保监控系统的安全性和灵活性。
---

# 黑名单与白名单

在 Prometheus 中，黑名单（Blacklist）和白名单（Whitelist）是两种常见的配置方式，用于控制哪些目标（Targets）应该被监控，哪些应该被排除。通过合理使用黑名单和白名单，您可以确保监控系统的安全性和灵活性，同时避免不必要的资源消耗。

## 什么是黑名单与白名单？

- **黑名单**：黑名单是一种排除机制，用于指定哪些目标**不应该**被监控。任何出现在黑名单中的目标都会被 Prometheus 忽略。
- **白名单**：白名单是一种包含机制，用于指定哪些目标**应该**被监控。只有出现在白名单中的目标才会被 Prometheus 监控。

这两种机制可以单独使用，也可以结合使用，具体取决于您的需求。

## 如何在 Prometheus 中配置黑名单与白名单

Prometheus 提供了多种方式来配置黑名单和白名单，最常见的方式是通过 `relabel_configs` 和 `metric_relabel_configs` 来实现。

### 1. 使用 `relabel_configs` 配置黑名单

`relabel_configs` 允许您在抓取目标之前对目标进行重新标记。通过这种方式，您可以轻松地排除某些目标。

以下是一个配置黑名单的示例：

```yaml
scrape_configs:
  - job_name: 'example-job'
    static_configs:
      - targets: ['target1:9090', 'target2:9090', 'target3:9090']
    relabel_configs:
      - source_labels: [__address__]
        regex: 'target2:9090'
        action: drop
```

在这个示例中，`target2:9090` 被添加到黑名单中，Prometheus 将不会监控它。

### 2. 使用 `relabel_configs` 配置白名单

与黑名单类似，您也可以使用 `relabel_configs` 来配置白名单。以下是一个配置白名单的示例：

```yaml
scrape_configs:
  - job_name: 'example-job'
    static_configs:
      - targets: ['target1:9090', 'target2:9090', 'target3:9090']
    relabel_configs:
      - source_labels: [__address__]
        regex: 'target1:9090|target3:9090'
        action: keep
```

在这个示例中，只有 `target1:9090` 和 `target3:9090` 会被 Prometheus 监控，而 `target2:9090` 将被排除。

### 3. 结合使用黑名单与白名单

在某些情况下，您可能需要同时使用黑名单和白名单。例如，您可能希望监控所有目标，但排除某些特定的目标。以下是一个结合使用黑名单和白名单的示例：

```yaml
scrape_configs:
  - job_name: 'example-job'
    static_configs:
      - targets: ['target1:9090', 'target2:9090', 'target3:9090', 'target4:9090']
    relabel_configs:
      - source_labels: [__address__]
        regex: 'target1:9090|target3:9090'
        action: keep
      - source_labels: [__address__]
        regex: 'target3:9090'
        action: drop
```

在这个示例中，`target1:9090` 和 `target3:9090` 首先被保留，但随后 `target3:9090` 被排除。最终，只有 `target1:9090` 会被监控。

## 实际应用场景

### 场景 1：排除测试环境

假设您有一个生产环境和测试环境，您希望 Prometheus 只监控生产环境的目标。您可以使用白名单来确保只有生产环境的目标被监控。

```yaml
scrape_configs:
  - job_name: 'production-job'
    static_configs:
      - targets: ['prod-target1:9090', 'prod-target2:9090', 'test-target1:9090']
    relabel_configs:
      - source_labels: [__address__]
        regex: 'prod-target1:9090|prod-target2:9090'
        action: keep
```

### 场景 2：排除特定 IP 地址

假设您有一些特定的 IP 地址不希望被监控，您可以使用黑名单来排除这些目标。

```yaml
scrape_configs:
  - job_name: 'example-job'
    static_configs:
      - targets: ['192.168.1.1:9090', '192.168.1.2:9090', '192.168.1.3:9090']
    relabel_configs:
      - source_labels: [__address__]
        regex: '192.168.1.2:9090'
        action: drop
```

## 总结

黑名单和白名单是 Prometheus 中非常有用的配置工具，可以帮助您精确控制哪些目标应该被监控，哪些应该被排除。通过合理使用这两种机制，您可以确保监控系统的安全性和灵活性。

:::tip
在实际使用中，建议您根据具体需求灵活选择黑名单或白名单，或者结合使用两者，以达到最佳的监控效果。
:::

## 附加资源与练习

- **练习 1**：尝试在您的 Prometheus 配置中添加一个黑名单，排除某些特定的目标。
- **练习 2**：配置一个白名单，确保只有特定的目标被监控。
- **附加资源**：阅读 [Prometheus 官方文档](https://prometheus.io/docs/prometheus/latest/configuration/configuration/) 了解更多关于 `relabel_configs` 的详细信息。

通过以上内容，您应该已经掌握了如何在 Prometheus 中使用黑名单和白名单。希望这些知识对您的监控系统配置有所帮助！