---
title: Azure 服务发现
description: 了解如何在 Prometheus 中使用 Azure 服务发现来自动发现和监控 Azure 资源。
---

# Azure 服务发现

在现代云原生环境中，服务发现是一个关键功能，它允许系统自动检测和监控动态变化的资源。Prometheus 是一个流行的开源监控系统，支持多种服务发现机制，其中包括 Azure 服务发现。本文将详细介绍如何在 Prometheus 中配置和使用 Azure 服务发现，帮助初学者快速上手。

## 什么是 Azure 服务发现？

Azure 服务发现是 Prometheus 提供的一种机制，用于自动发现 Azure 云平台上的资源（如虚拟机、容器实例等），并将它们作为监控目标。通过 Azure 服务发现，Prometheus 可以动态地获取 Azure 资源的元数据，并根据这些元数据自动配置监控任务。

### 为什么需要 Azure 服务发现？

在云环境中，资源是动态变化的。虚拟机可能会被创建、销毁或迁移，容器实例可能会被扩展或缩减。手动配置这些资源的监控任务既繁琐又容易出错。Azure 服务发现通过自动发现这些资源，简化了监控配置，并确保了监控的实时性和准确性。

## 配置 Azure 服务发现

要在 Prometheus 中启用 Azure 服务发现，首先需要在 Prometheus 的配置文件中添加 Azure 相关的配置。以下是一个基本的配置示例：

```yaml
scrape_configs:
  - job_name: 'azure'
    azure_sd_configs:
      - subscription_id: 'your-subscription-id'
        tenant_id: 'your-tenant-id'
        client_id: 'your-client-id'
        client_secret: 'your-client-secret'
        port: 9100
```

### 配置参数说明

- `subscription_id`: Azure 订阅的唯一标识符。
- `tenant_id`: Azure Active Directory 租户的唯一标识符。
- `client_id`: Azure 应用程序的客户端 ID。
- `client_secret`: Azure 应用程序的客户端密钥。
- `port`: Prometheus 用于抓取指标的端口号。

:::note
确保在 Azure 门户中创建了一个应用程序，并为其分配了适当的权限，以便 Prometheus 可以访问 Azure 资源。
:::

## 实际案例

假设你有一个 Azure 订阅，其中运行了多个虚拟机。你希望 Prometheus 能够自动发现这些虚拟机，并监控它们的 CPU 使用率。以下是如何配置 Prometheus 来实现这一目标的步骤：

1. **创建 Azure 应用程序**：在 Azure 门户中创建一个应用程序，并为其分配适当的权限。
2. **获取凭据**：获取应用程序的 `client_id`、`client_secret`、`tenant_id` 和 `subscription_id`。
3. **配置 Prometheus**：将上述凭据添加到 Prometheus 的配置文件中，并指定抓取端口。
4. **启动 Prometheus**：启动 Prometheus，它将自动发现 Azure 中的虚拟机，并开始监控它们的 CPU 使用率。

### 示例输出

假设 Prometheus 成功发现了两个虚拟机，它们的 IP 地址分别为 `192.168.1.1` 和 `192.168.1.2`。Prometheus 将开始抓取这些虚拟机的指标，并生成类似以下的输出：

```plaintext
# HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.
# TYPE node_cpu_seconds_total counter
node_cpu_seconds_total{cpu="0",mode="idle"} 123456.789
node_cpu_seconds_total{cpu="0",mode="system"} 123.456
node_cpu_seconds_total{cpu="0",mode="user"} 456.789
```

## 总结

Azure 服务发现是 Prometheus 中一个强大的功能，它允许你自动发现和监控 Azure 云平台上的资源。通过本文的介绍，你应该已经了解了如何配置和使用 Azure 服务发现。希望这些内容能够帮助你在云原生环境中更高效地进行监控。

## 附加资源

- [Prometheus 官方文档](https://prometheus.io/docs/)
- [Azure 服务发现配置指南](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#azure_sd_config)
- [Azure 应用程序注册指南](https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app)

## 练习

1. 在 Azure 中创建一个虚拟机，并配置 Prometheus 使用 Azure 服务发现来监控它。
2. 尝试扩展 Prometheus 的配置，使其能够监控 Azure 中的其他资源类型，如容器实例。
3. 探索 Prometheus 的其他服务发现机制，如 Kubernetes 服务发现，并比较它们与 Azure 服务发现的异同。
