---
title: Relabel配置详解
description: 本文详细介绍了Prometheus中的Relabel配置，帮助初学者理解如何通过Relabel规则对目标标签进行动态修改和过滤。
---

# Relabel配置详解

在Prometheus中，**Relabel配置**是一种强大的工具，用于在服务发现过程中动态修改和过滤目标的标签。通过Relabel配置，你可以对从服务发现机制中获取的目标进行标签的添加、修改、删除或过滤，从而更好地控制监控目标的行为。

本文将逐步讲解Relabel配置的核心概念，并通过实际案例展示其应用场景。

## 什么是Relabel配置？

Relabel配置是Prometheus在服务发现过程中对目标标签进行动态处理的一种机制。它允许你在目标被添加到Prometheus的监控列表之前，对目标的标签进行修改或过滤。Relabel配置通常用于以下几种场景：

- **添加或修改标签**：为目标添加新的标签或修改现有标签的值。
- **过滤目标**：根据标签的值决定是否将目标纳入监控范围。
- **重命名标签**：将标签的名称更改为其他名称。

Relabel配置的核心是通过一系列规则（`relabel_configs`）来实现的，这些规则定义了如何处理目标的标签。

## Relabel配置的基本结构

Relabel配置通常定义在Prometheus的配置文件（`prometheus.yml`）中，作为`scrape_configs`的一部分。以下是一个简单的Relabel配置示例：

```yaml
scrape_configs:
  - job_name: 'example-job'
    static_configs:
      - targets: ['localhost:9090']
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod_name
```

在这个示例中，`relabel_configs`部分定义了一个规则，将从服务发现中获取的`__meta_kubernetes_pod_name`标签的值复制到一个新的标签`pod_name`中。

## Relabel配置的核心字段

Relabel配置中的每个规则都包含多个字段，以下是常用的字段及其含义：

- **source_labels**: 指定要从目标中提取的标签列表。这些标签的值将用于后续的处理。
- **separator**: 用于连接`source_labels`中多个标签值的分隔符，默认为`;`。
- **regex**: 用于匹配`source_labels`值的正则表达式。
- **modulus**: 用于对`source_labels`的值进行哈希取模操作。
- **target_label**: 指定要将处理后的值写入的目标标签。
- **replacement**: 指定替换字符串，用于替换匹配到的内容。
- **action**: 指定要执行的操作，常见的操作包括`replace`、`keep`、`drop`、`labelmap`等。

## Relabel配置的常见操作

### 1. 替换标签值（`replace`）

`replace`操作是最常用的Relabel操作，它允许你将`source_labels`的值替换为指定的内容。以下是一个示例：

```yaml
relabel_configs:
  - source_labels: [__meta_kubernetes_pod_name]
    regex: '(.*)'
    target_label: pod_name
    replacement: 'pod-$1'
```

在这个示例中，`__meta_kubernetes_pod_name`标签的值将被替换为`pod-<原始值>`，并写入到`pod_name`标签中。

### 2. 过滤目标（`keep` 和 `drop`）

`keep`和`drop`操作用于根据标签的值决定是否保留或丢弃目标。以下是一个使用`keep`操作的示例：

```yaml
relabel_configs:
  - source_labels: [__meta_kubernetes_namespace]
    regex: 'production'
    action: keep
```

在这个示例中，只有`__meta_kubernetes_namespace`标签的值为`production`的目标才会被保留，其他目标将被丢弃。

### 3. 重命名标签（`labelmap`）

`labelmap`操作用于将一组标签的名称重命名为其他名称。以下是一个示例：

```yaml
relabel_configs:
  - action: labelmap
    regex: '__meta_kubernetes_(.*)'
    replacement: 'k8s_$1'
```

在这个示例中，所有以`__meta_kubernetes_`开头的标签将被重命名为以`k8s_`开头的标签。

## 实际案例：Kubernetes中的Relabel配置

在Kubernetes环境中，Prometheus通常通过服务发现机制自动发现Pod和Service。以下是一个实际的Relabel配置示例，展示了如何将Kubernetes的元数据标签映射到Prometheus的监控目标中：

```yaml
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod_name
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        regex: 'true'
        action: keep
```

在这个配置中：

1. `__meta_kubernetes_pod_name`标签的值被映射到`pod_name`标签。
2. `__meta_kubernetes_namespace`标签的值被映射到`namespace`标签。
3. 只有带有`prometheus.io/scrape=true`注解的Pod才会被保留。

## 总结

Relabel配置是Prometheus中一个非常强大的功能，它允许你在服务发现过程中动态修改和过滤目标的标签。通过合理使用Relabel配置，你可以更好地控制监控目标的行为，并确保只有符合条件的目标被纳入监控范围。

### 附加资源

- [Prometheus官方文档：Relabeling](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config)
- [Prometheus Relabeling实战指南](https://www.robustperception.io/relabeling-in-prometheus)

### 练习

1. 尝试在本地Prometheus配置中添加一个Relabel规则，将`__meta_kubernetes_pod_name`标签的值映射到一个新的标签`custom_pod_name`。
2. 使用`keep`操作过滤掉所有`__meta_kubernetes_namespace`标签值不为`production`的目标。

通过实践这些练习，你将更深入地理解Relabel配置的工作原理和应用场景。