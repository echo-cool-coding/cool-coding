---
title: PromQL简介
description: 了解PromQL的基础知识，掌握如何使用PromQL查询语言从Prometheus中提取和分析监控数据。
---

# PromQL简介

PromQL（Prometheus Query Language）是Prometheus的查询语言，用于从Prometheus的时间序列数据库中提取和分析数据。Prometheus是一个开源的监控和警报工具，而PromQL则是其核心功能之一，允许用户以灵活的方式查询和聚合监控数据。

## 什么是PromQL？

PromQL是一种功能强大的查询语言，专门设计用于处理时间序列数据。时间序列数据是按时间顺序记录的数据点集合，通常用于监控系统性能、资源使用情况等。PromQL允许用户通过简单的表达式查询这些数据，并对其进行聚合、过滤和计算。

### PromQL的基本结构

PromQL查询通常由以下几个部分组成：

1. **指标名称（Metric Name）**：指定要查询的时间序列数据。
2. **标签（Labels）**：用于过滤和选择特定的时间序列。
3. **操作符（Operators）**：用于对时间序列数据进行计算和聚合。
4. **函数（Functions）**：用于对时间序列数据进行转换和处理。

## PromQL的基本查询

让我们从一个简单的PromQL查询开始。假设我们有一个名为`http_requests_total`的指标，它记录了HTTP请求的总数。我们可以使用以下查询来获取该指标的当前值：

```promql
http_requests_total
```

这个查询将返回所有`http_requests_total`时间序列的当前值。每个时间序列都由一组标签（如`method`、`status`等）唯一标识。

### 过滤标签

如果我们只想获取特定标签的时间序列，可以使用标签过滤器。例如，以下查询将返回所有`method`为`GET`的`http_requests_total`时间序列：

```promql
http_requests_total{method="GET"}
```

### 聚合操作

PromQL支持多种聚合操作，如`sum`、`avg`、`min`、`max`等。例如，以下查询将返回所有`http_requests_total`时间序列的总和：

```promql
sum(http_requests_total)
```

如果我们只想对特定标签的时间序列进行聚合，可以使用`by`子句。例如，以下查询将按`method`标签对`http_requests_total`进行求和：

```promql
sum(http_requests_total) by (method)
```

## PromQL的实际应用

让我们通过一个实际案例来展示PromQL的应用场景。假设我们有一个监控系统，记录了每个服务的HTTP请求总数和响应时间。我们可以使用PromQL来监控服务的性能，并设置警报。

### 监控HTTP请求速率

我们可以使用`rate`函数来计算HTTP请求的速率。以下查询将返回过去5分钟内`http_requests_total`的每秒请求速率：

```promql
rate(http_requests_total[5m])
```

### 监控响应时间

假设我们有一个名为`http_response_time_seconds`的指标，记录了每个HTTP请求的响应时间。我们可以使用`histogram_quantile`函数来计算响应时间的百分位数。例如，以下查询将返回过去5分钟内95%的响应时间：

```promql
histogram_quantile(0.95, rate(http_response_time_seconds_bucket[5m]))
```

### 设置警报

我们可以使用PromQL查询来设置警报。例如，以下查询将返回过去5分钟内HTTP请求速率超过100的实例：

```promql
rate(http_requests_total[5m]) > 100
```

如果该查询返回任何结果，Prometheus将触发警报。

## 总结

PromQL是Prometheus的核心查询语言，允许用户以灵活的方式查询和分析时间序列数据。通过掌握PromQL的基本查询、过滤、聚合和函数，用户可以有效地监控系统性能，并设置警报以应对潜在问题。

### 附加资源

- [Prometheus官方文档](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [PromQL Cheat Sheet](https://prometheus.io/docs/prometheus/latest/querying/examples/)

### 练习

1. 编写一个PromQL查询，返回过去10分钟内`http_requests_total`的每秒请求速率。
2. 编写一个PromQL查询，按`status`标签对`http_requests_total`进行求和。
3. 编写一个PromQL查询，返回过去5分钟内90%的响应时间。

通过完成这些练习，您将更好地理解PromQL的使用方法，并能够在实际项目中应用这些知识。