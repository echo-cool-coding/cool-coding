---
title: PromQL过滤器
description: 了解如何在PromQL中使用过滤器来精确筛选时间序列数据。本文适合初学者，包含代码示例和实际案例。
---

# PromQL过滤器

PromQL（Prometheus Query Language）是用于查询和操作时间序列数据的强大工具。在PromQL中，**过滤器**是一种重要的功能，它允许我们从大量的时间序列数据中筛选出符合特定条件的部分。本文将详细介绍PromQL过滤器的使用方法，并通过示例帮助您理解其实际应用。

## 什么是PromQL过滤器？

在Prometheus中，时间序列数据通常由指标名称（metric name）和一组标签（labels）组成。过滤器的作用是根据这些标签的值来筛选出符合条件的时间序列。通过使用过滤器，我们可以精确地获取所需的数据，而无需处理无关的时间序列。

PromQL过滤器通常用于以下场景：
- 筛选特定标签值的时间序列。
- 排除不符合条件的时间序列。
- 组合多个条件进行复杂筛选。

## 基本语法

PromQL过滤器的基本语法是通过在查询中使用大括号 `{}` 来指定标签条件。例如：

```promql
http_requests_total{job="api-server", status="200"}
```

在这个例子中，我们筛选了 `http_requests_total` 指标中，`job` 标签为 `api-server` 且 `status` 标签为 `200` 的时间序列。

### 标签匹配操作符

PromQL支持多种标签匹配操作符，用于更灵活的筛选：

- `=`：精确匹配标签值。
- `!=`：排除指定标签值。
- `=~`：正则表达式匹配标签值。
- `!~`：正则表达式排除标签值。

例如：

```promql
http_requests_total{job=~"api-server|web-server", status!~"5.."}
```

这个查询筛选了 `http_requests_total` 指标中，`job` 标签为 `api-server` 或 `web-server`，且 `status` 标签不以 `5` 开头的时间序列。

## 实际案例

### 案例1：筛选特定状态码的HTTP请求

假设我们有一个监控系统，记录了不同服务的HTTP请求总数。我们可以使用过滤器来筛选出状态码为 `200` 的请求：

```promql
http_requests_total{status="200"}
```

### 案例2：排除特定环境的指标

如果我们只想查看生产环境的指标，可以排除开发和测试环境的指标：

```promql
http_requests_total{environment!~"dev|test"}
```

### 案例3：组合多个条件

我们可以组合多个条件来筛选出特定服务在特定状态下的请求：

```promql
http_requests_total{job="api-server", status=~"2..", method="GET"}
```

这个查询筛选了 `api-server` 服务中，状态码以 `2` 开头且请求方法为 `GET` 的时间序列。

## 总结

PromQL过滤器是Prometheus查询语言中非常强大的功能，它允许我们根据标签条件精确筛选时间序列数据。通过掌握过滤器的基本语法和操作符，您可以更高效地查询和分析监控数据。

:::tip
在实际使用中，建议结合正则表达式和多个条件来构建更复杂的查询，以满足不同的监控需求。
:::

## 附加资源

- [Prometheus官方文档](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [PromQL Cheat Sheet](https://prometheus.io/docs/prometheus/latest/querying/examples/)

## 练习

1. 编写一个PromQL查询，筛选出 `cpu_usage` 指标中，`instance` 标签为 `web-01` 且 `mode` 标签为 `user` 的时间序列。
2. 使用正则表达式筛选出 `http_requests_total` 指标中，`job` 标签以 `api` 开头且 `status` 标签为 `4xx` 的时间序列。

通过完成这些练习，您将更好地掌握PromQL过滤器的使用方法。