---
title: 自定义度量创建
description: 了解如何在 Prometheus 中创建自定义度量，并通过实际案例掌握其应用场景。
---

# 自定义度量创建

Prometheus 是一个强大的监控和告警工具，它通过收集和存储时间序列数据来帮助用户监控系统的健康状况。默认情况下，Prometheus 提供了许多内置的度量指标，但在实际应用中，我们通常需要根据业务需求创建自定义度量。本文将详细介绍如何在 Prometheus 中创建自定义度量，并通过实际案例展示其应用场景。

## 什么是自定义度量？

自定义度量是指用户根据特定需求定义的度量指标。这些指标可以是业务相关的（如订单数量、用户活跃度等），也可以是系统相关的（如自定义的 CPU 使用率、内存占用等）。通过自定义度量，用户可以更灵活地监控和分析系统的运行状态。

## 创建自定义度量的步骤

### 1. 定义度量类型

Prometheus 支持四种主要的度量类型：

- **Counter**：用于累计值，如请求总数。
- **Gauge**：用于瞬时值，如当前内存使用量。
- **Histogram**：用于统计分布，如请求延迟。
- **Summary**：类似于 Histogram，但计算的是百分位数。

### 2. 使用客户端库创建度量

Prometheus 提供了多种语言的客户端库（如 Go、Python、Java 等），用于创建和暴露自定义度量。以下是一个使用 Python 客户端库创建自定义度量的示例：

```python
from prometheus_client import start_http_server, Counter

# 创建一个 Counter 类型的度量
REQUEST_COUNT = Counter('myapp_requests_total', 'Total number of requests')

def process_request():
    # 每次处理请求时增加计数
    REQUEST_COUNT.inc()

if __name__ == '__main__':
    # 启动 HTTP 服务器以暴露度量
    start_http_server(8000)
    while True:
        process_request()
```

### 3. 暴露度量

Prometheus 通过 HTTP 接口抓取度量数据。因此，我们需要将自定义度量暴露在一个 HTTP 端点上。在上面的示例中，`start_http_server(8000)` 启动了一个 HTTP 服务器，监听 8000 端口，Prometheus 可以通过该端口抓取度量数据。

### 4. 配置 Prometheus 抓取目标

在 Prometheus 的配置文件中，添加一个新的抓取目标，指向我们暴露度量的 HTTP 服务器：

```yaml
scrape_configs:
  - job_name: 'myapp'
    static_configs:
      - targets: ['localhost:8000']
```

## 实际案例

假设我们有一个电商网站，需要监控每分钟的订单数量。我们可以创建一个自定义的 Counter 度量来记录订单数量，并在每次有新订单时增加计数。

```python
from prometheus_client import start_http_server, Counter
import time

# 创建一个 Counter 类型的度量
ORDER_COUNT = Counter('ecommerce_orders_total', 'Total number of orders')

def process_order():
    # 模拟订单处理
    ORDER_COUNT.inc()

if __name__ == '__main__':
    # 启动 HTTP 服务器以暴露度量
    start_http_server(8000)
    while True:
        process_order()
        time.sleep(60)  # 每分钟处理一个订单
```

在这个案例中，Prometheus 会每分钟抓取一次订单数量，并将其存储在时间序列数据库中。我们可以通过 Prometheus 的查询语言（PromQL）来分析这些数据，例如计算每分钟的订单增长率。

## 总结

自定义度量是 Prometheus 监控系统中非常重要的一部分，它允许用户根据具体需求定义和监控特定的指标。通过本文的介绍，你应该已经掌握了如何在 Prometheus 中创建自定义度量，并通过实际案例了解了其应用场景。

## 附加资源

- [Prometheus 官方文档](https://prometheus.io/docs/)
- [Prometheus 客户端库](https://prometheus.io/docs/instrumenting/clientlibs/)
- [PromQL 查询语言指南](https://prometheus.io/docs/prometheus/latest/querying/basics/)

## 练习

1. 尝试使用你熟悉的编程语言（如 Go、Java 等）创建一个自定义的 Gauge 度量，用于监控系统的 CPU 使用率。
2. 配置 Prometheus 抓取你创建的度量，并使用 PromQL 查询语言分析数据。

通过完成这些练习，你将更深入地理解自定义度量的创建和应用。