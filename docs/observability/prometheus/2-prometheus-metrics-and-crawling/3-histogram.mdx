---
title: Histogram直方图
description: 了解Prometheus中的Histogram直方图，掌握其工作原理、使用场景以及如何在实际中应用。
---

# Histogram直方图

Histogram直方图是Prometheus中一种重要的指标类型，用于记录和统计数据的分布情况。它特别适用于测量请求延迟、响应时间等连续变量的分布情况。通过直方图，我们可以了解数据的分布特征，例如平均值、中位数、百分位数等。

## 什么是Histogram直方图？

Histogram直方图是一种将数据划分为多个区间的统计工具。每个区间称为一个“桶”（bucket），Prometheus会记录每个桶中数据的数量。通过这种方式，我们可以直观地看到数据的分布情况。

例如，假设我们有一个HTTP请求的延迟数据，我们可以将这些延迟时间划分为多个区间（如0-100ms、100-200ms、200-500ms等），然后统计每个区间内的请求数量。这样，我们就可以知道有多少请求的延迟在某个范围内。

## Histogram的工作原理

在Prometheus中，Histogram直方图通过定义一组桶（buckets）来工作。每个桶代表一个数值范围，Prometheus会记录落在每个桶中的观测值的数量。此外，Histogram还会记录所有观测值的总和（`_sum`）和观测值的总数（`_count`）。

### 示例：定义一个Histogram

假设我们想要测量HTTP请求的延迟时间，我们可以定义一个Histogram指标如下：

```prometheus
http_request_duration_seconds_bucket{le="0.1"} 10
http_request_duration_seconds_bucket{le="0.2"} 20
http_request_duration_seconds_bucket{le="0.5"} 30
http_request_duration_seconds_bucket{le="1"} 40
http_request_duration_seconds_bucket{le="+Inf"} 50
http_request_duration_seconds_sum 25.3
http_request_duration_seconds_count 50
```

在这个例子中，`http_request_duration_seconds_bucket`表示不同延迟区间的请求数量，`le`表示“小于或等于”某个值的请求数量。`http_request_duration_seconds_sum`是所有请求延迟的总和，`http_request_duration_seconds_count`是请求的总数。

### 计算百分位数

通过Histogram直方图，我们可以计算任意百分位数。例如，计算第90百分位数（即90%的请求延迟小于该值），可以使用PromQL查询：

```prometheus
histogram_quantile(0.90, rate(http_request_duration_seconds_bucket[1m]))
```

这个查询会返回过去1分钟内，90%的请求延迟小于的值。

## 实际应用场景

### 场景1：监控HTTP请求延迟

假设我们有一个Web服务，我们想要监控HTTP请求的延迟时间。我们可以使用Histogram直方图来记录每个请求的延迟时间，并统计不同延迟区间的请求数量。

```prometheus
http_request_duration_seconds_bucket{le="0.1"} 100
http_request_duration_seconds_bucket{le="0.2"} 200
http_request_duration_seconds_bucket{le="0.5"} 300
http_request_duration_seconds_bucket{le="1"} 400
http_request_duration_seconds_bucket{le="+Inf"} 500
http_request_duration_seconds_sum 250.5
http_request_duration_seconds_count 500
```

通过这个Histogram，我们可以计算出不同百分位数的延迟时间，例如第50百分位数（中位数）、第90百分位数等。

### 场景2：监控数据库查询时间

另一个常见的应用场景是监控数据库查询时间。我们可以使用Histogram直方图来记录每个查询的执行时间，并统计不同时间区间的查询数量。

```prometheus
db_query_duration_seconds_bucket{le="0.01"} 50
db_query_duration_seconds_bucket{le="0.05"} 100
db_query_duration_seconds_bucket{le="0.1"} 150
db_query_duration_seconds_bucket{le="0.5"} 200
db_query_duration_seconds_bucket{le="+Inf"} 250
db_query_duration_seconds_sum 12.5
db_query_duration_seconds_count 250
```

通过这个Histogram，我们可以了解数据库查询时间的分布情况，并识别出慢查询。

## 总结

Histogram直方图是Prometheus中一种强大的工具，用于记录和统计数据的分布情况。通过定义一组桶，我们可以直观地看到数据的分布特征，并计算出百分位数等统计指标。Histogram直方图特别适用于测量请求延迟、响应时间等连续变量的分布情况。

在实际应用中，Histogram直方图可以帮助我们监控HTTP请求延迟、数据库查询时间等关键指标，从而更好地理解系统的性能和行为。

## 附加资源与练习

- **练习1**：在你的Prometheus环境中定义一个Histogram直方图，用于监控某个服务的响应时间。尝试计算第50百分位数和第90百分位数。
- **练习2**：使用PromQL查询，计算过去5分钟内某个Histogram直方图的第95百分位数。
- **附加资源**：阅读Prometheus官方文档中关于Histogram直方图的更多细节和示例。

:::tip
Histogram直方图是理解数据分布的重要工具，掌握它的使用可以帮助你更好地监控和分析系统的性能。
:::