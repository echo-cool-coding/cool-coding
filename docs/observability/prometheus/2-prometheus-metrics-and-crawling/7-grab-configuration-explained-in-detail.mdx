---
title: 抓取配置详解
description: 了解 Prometheus 如何通过抓取配置从目标中收集指标数据，并掌握如何配置抓取任务。
---

# 抓取配置详解

Prometheus 是一个开源的监控和告警工具，它通过定期从目标（targets）中抓取指标数据来工作。抓取配置（Scrape Configuration）是 Prometheus 的核心功能之一，它定义了 Prometheus 如何发现目标、如何抓取数据以及如何处理抓取到的数据。本文将详细介绍 Prometheus 的抓取配置，帮助你理解并掌握如何配置抓取任务。

## 什么是抓取配置？

抓取配置是 Prometheus 配置文件（通常是 `prometheus.yml`）中的一个部分，它定义了 Prometheus 如何从目标中抓取指标数据。每个抓取配置通常包含以下内容：

- **job_name**: 抓取任务的名称，用于标识不同的抓取任务。
- **scrape_interval**: 抓取间隔，即 Prometheus 多久抓取一次数据。
- **scrape_timeout**: 抓取超时时间，即 Prometheus 等待目标响应的最长时间。
- **metrics_path**: 指标路径，即 Prometheus 从目标中抓取数据的路径。
- **scheme**: 抓取协议，通常是 `http` 或 `https`。
- **static_configs**: 静态配置，用于定义目标列表。
- **relabel_configs**: 重新标记配置，用于在抓取过程中对目标进行标记和过滤。

## 抓取配置的基本结构

以下是一个简单的抓取配置示例：

```yaml
scrape_configs:
  - job_name: 'example-job'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: '/metrics'
    scheme: 'http'
    static_configs:
      - targets: ['localhost:9090', 'localhost:9100']
```

在这个示例中，Prometheus 会每隔 15 秒从 `localhost:9090` 和 `localhost:9100` 这两个目标中抓取指标数据，抓取路径为 `/metrics`，使用 `http` 协议。

## 抓取配置的详细解析

### 1. job_name

`job_name` 是抓取任务的名称，用于标识不同的抓取任务。每个 `job_name` 必须是唯一的，Prometheus 会根据这个名称来区分不同的抓取任务。

```yaml
job_name: 'example-job'
```

### 2. scrape_interval

`scrape_interval` 定义了 Prometheus 抓取数据的间隔时间。默认情况下，Prometheus 会每隔 1 分钟抓取一次数据，但你可以根据需要进行调整。

```yaml
scrape_interval: 15s
```

### 3. scrape_timeout

`scrape_timeout` 定义了 Prometheus 等待目标响应的最长时间。如果目标在超时时间内没有响应，Prometheus 会放弃这次抓取。

```yaml
scrape_timeout: 10s
```

### 4. metrics_path

`metrics_path` 定义了 Prometheus 从目标中抓取数据的路径。默认情况下，Prometheus 会从 `/metrics` 路径抓取数据。

```yaml
metrics_path: '/metrics'
```

### 5. scheme

`scheme` 定义了 Prometheus 抓取数据时使用的协议。通常是 `http` 或 `https`。

```yaml
scheme: 'http'
```

### 6. static_configs

`static_configs` 用于定义目标列表。你可以在这里列出所有需要抓取的目标。

```yaml
static_configs:
  - targets: ['localhost:9090', 'localhost:9100']
```

### 7. relabel_configs

`relabel_configs` 用于在抓取过程中对目标进行标记和过滤。你可以使用重新标记来修改目标的标签，或者过滤掉不需要的目标。

```yaml
relabel_configs:
  - source_labels: [__meta_kubernetes_pod_name]
    action: keep
    regex: 'my-pod.*'
```

在这个示例中，Prometheus 只会抓取名称以 `my-pod` 开头的 Kubernetes Pod。

## 实际案例

假设你有一个 Kubernetes 集群，并且你想监控集群中的所有 Pod。你可以使用以下抓取配置：

```yaml
scrape_configs:
  - job_name: 'kubernetes-pods'
    scrape_interval: 30s
    scrape_timeout: 15s
    metrics_path: '/metrics'
    scheme: 'http'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
```

在这个配置中，Prometheus 会使用 Kubernetes 服务发现（`kubernetes_sd_configs`）来自动发现集群中的所有 Pod，并且只会抓取那些带有 `prometheus.io/scrape=true` 注解的 Pod。

## 总结

抓取配置是 Prometheus 监控系统的核心部分，它定义了 Prometheus 如何从目标中抓取指标数据。通过合理配置 `job_name`、`scrape_interval`、`scrape_timeout`、`metrics_path`、`scheme`、`static_configs` 和 `relabel_configs`，你可以灵活地控制 Prometheus 的抓取行为。

## 附加资源

- [Prometheus 官方文档](https://prometheus.io/docs/introduction/overview/)
- [Prometheus 配置指南](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)

## 练习

1. 创建一个简单的 Prometheus 抓取配置，监控本地的 `node_exporter`。
2. 修改抓取间隔为 10 秒，并观察 Prometheus 的行为变化。
3. 使用 `relabel_configs` 过滤掉不需要的目标，只抓取特定的目标。

通过以上练习，你将更深入地理解 Prometheus 的抓取配置，并能够灵活地应用到实际场景中。