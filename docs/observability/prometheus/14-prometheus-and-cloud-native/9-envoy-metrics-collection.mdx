---
title: Envoy指标收集
description: 了解如何使用Prometheus收集Envoy代理的指标，并探索其在云原生环境中的实际应用。
---

# Envoy指标收集

Envoy是一个高性能、开源的边缘和服务代理，专为云原生应用设计。它提供了丰富的指标（metrics），这些指标可以帮助我们监控和调试服务的运行状态。本文将介绍如何使用Prometheus收集Envoy的指标，并展示如何在实际场景中应用这些指标。

## 什么是Envoy指标？

Envoy在运行时会产生大量的指标数据，这些数据包括请求数量、响应时间、错误率等。这些指标可以帮助我们了解服务的健康状况、性能瓶颈以及潜在的问题。

Envoy的指标是通过HTTP端点暴露的，通常可以通过`/stats`路径访问。Prometheus是一个流行的监控工具，它可以定期抓取这些指标并存储起来，供后续分析和可视化使用。

## 配置Envoy以暴露指标

首先，我们需要配置Envoy以暴露指标。以下是一个简单的Envoy配置示例，展示了如何启用指标收集：

```yaml
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8080
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: backend_service
          http_filters:
          - name: envoy.filters.http.router
  clusters:
  - name: backend_service
    connect_timeout: 0.25s
    type: strict_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: backend_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: backend
                port_value: 80
admin:
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
```

在这个配置中，`admin`部分启用了Envoy的管理接口，默认情况下，Envoy会通过`/stats`路径暴露指标。

## 使用Prometheus收集Envoy指标

接下来，我们需要配置Prometheus来抓取Envoy的指标。以下是一个Prometheus配置示例：

```yaml
scrape_configs:
  - job_name: 'envoy'
    static_configs:
      - targets: ['envoy:9901']
```

在这个配置中，Prometheus会定期访问`envoy:9901/stats`路径，抓取Envoy的指标数据。

## 实际应用场景

假设我们有一个微服务架构的应用，其中Envoy作为服务网格的边车代理。我们可以通过Prometheus收集Envoy的指标，并使用Grafana进行可视化，从而监控服务的健康状况。

例如，我们可以创建一个Grafana仪表板，展示以下关键指标：

- 请求总数
- 请求成功率
- 平均响应时间
- 错误率

通过这些指标，我们可以快速识别出服务中的性能瓶颈或潜在问题。

## 总结

Envoy的指标收集是云原生应用监控的重要组成部分。通过Prometheus，我们可以轻松地收集和分析这些指标，从而更好地理解和优化我们的服务。

## 附加资源

- [Envoy官方文档](https://www.envoyproxy.io/docs/envoy/latest/)
- [Prometheus官方文档](https://prometheus.io/docs/)
- [Grafana官方文档](https://grafana.com/docs/)

## 练习

1. 配置一个简单的Envoy代理，并启用指标收集。
2. 使用Prometheus抓取Envoy的指标，并在Grafana中创建一个仪表板展示这些指标。
3. 尝试在微服务架构中部署Envoy，并监控多个服务的指标。

通过以上练习，你将更深入地理解Envoy指标收集的实际应用。