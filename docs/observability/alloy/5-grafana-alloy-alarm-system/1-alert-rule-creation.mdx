---
title: 告警规则创建
description: 学习如何在 Grafana Alloy 中创建告警规则，掌握告警规则的基本概念、语法和实际应用场景。
---

# 告警规则创建

告警规则是监控系统中的核心组件之一，它定义了在什么条件下触发告警以及如何通知相关人员。在 Grafana Alloy 中，告警规则通过 PromQL（Prometheus Query Language）表达式来定义，并结合告警策略和通知渠道，确保在系统出现异常时能够及时响应。

本文将逐步介绍如何在 Grafana Alloy 中创建告警规则，并通过实际案例帮助你理解其应用场景。

---

## 什么是告警规则？

告警规则是一种基于监控数据的逻辑表达式，用于判断系统是否处于异常状态。当监控数据满足告警规则中定义的条件时，系统会触发告警并通过配置的通知渠道（如邮件、Slack、PagerDuty 等）发送通知。

告警规则通常包括以下几个关键部分：
1. **规则名称**：唯一标识告警规则的名称。
2. **表达式**：基于 PromQL 的查询语句，用于定义触发告警的条件。
3. **持续时间**：表达式条件需要持续满足的时间长度。
4. **标签**：附加到告警中的元数据，用于分类和过滤。
5. **注释**：告警触发时附加的详细信息，帮助理解告警的原因。

---

## 创建告警规则的步骤

### 1. 定义规则名称
规则名称是告警规则的唯一标识符，建议使用简洁且具有描述性的名称。例如：
```yaml
groups:
  - name: example
    rules:
      - alert: HighCPUUsage
```

### 2. 编写 PromQL 表达式
PromQL 表达式用于定义触发告警的条件。例如，以下表达式表示 CPU 使用率超过 80%：
```yaml
expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100 > 80
```

### 3. 设置持续时间
持续时间定义了表达式条件需要持续满足的时间长度。例如，以下配置表示 CPU 使用率超过 80% 的情况需要持续 5 分钟才会触发告警：
```yaml
for: 5m
```

### 4. 添加标签和注释
标签和注释用于丰富告警信息。例如：
```yaml
labels:
  severity: critical
annotations:
  summary: "High CPU usage detected"
  description: "CPU usage on {{ $labels.instance }} is above 80% for 5 minutes."
```

### 5. 完整示例
以下是一个完整的告警规则示例：
```yaml
groups:
  - name: example
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100 > 80
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage on {{ $labels.instance }} is above 80% for 5 minutes."
```

---

## 实际应用场景

### 场景 1：监控服务器 CPU 使用率
假设你需要监控一组服务器的 CPU 使用率，并在使用率超过 80% 时触发告警。告警规则如下：
```yaml
groups:
  - name: server_monitoring
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100 > 80
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage on {{ $labels.instance }} is above 80% for 5 minutes."
```

### 场景 2：监控服务响应时间
假设你需要监控某个服务的响应时间，并在响应时间超过 1 秒时触发告警。告警规则如下：
```yaml
groups:
  - name: service_monitoring
    rules:
      - alert: HighResponseTime
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="my_service"}[5m])) by (le) > 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "Response time for {{ $labels.job }} is above 1 second for 2 minutes."
```

---

## 总结

告警规则是 Grafana Alloy 中实现监控告警的核心工具。通过定义 PromQL 表达式、设置持续时间和添加标签与注释，你可以创建灵活且强大的告警规则，确保在系统出现异常时能够及时响应。

:::tip 提示
- 在编写 PromQL 表达式时，建议先在 Grafana 的 Explore 界面中测试查询语句，确保其正确性。
- 使用标签和注释时，尽量提供详细的信息，以便快速定位问题。
:::

---

## 附加资源与练习

### 资源
- [Prometheus 官方文档](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Grafana Alloy 告警规则配置指南](https://grafana.com/docs/alloy/latest/alerting/rules/)

### 练习
1. 创建一个告警规则，监控内存使用率超过 90% 的情况。
2. 修改现有告警规则，增加一个新的标签 `environment: production`。
3. 尝试使用 `histogram_quantile` 函数监控某个服务的 95% 分位响应时间。

通过实践这些练习，你将更深入地理解告警规则的创建与应用。