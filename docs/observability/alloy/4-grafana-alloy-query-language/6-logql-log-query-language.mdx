---
title: LogQL日志查询语言
description: 了解LogQL日志查询语言的基础知识，掌握如何使用LogQL查询和分析日志数据。
---

# LogQL日志查询语言

LogQL是Grafana Loki中用于查询和分析日志数据的强大语言。它类似于PromQL（Prometheus查询语言），但专门用于处理日志数据。LogQL允许你通过灵活的查询语法从日志中提取有价值的信息，帮助你快速定位问题、分析趋势和监控系统状态。

## 什么是LogQL？

LogQL是一种声明式查询语言，用于从Loki中检索和过滤日志数据。Loki是一个水平可扩展、高可用的多租户日志聚合系统，专为云原生环境设计。LogQL的设计目标是简化日志查询，同时提供强大的过滤和聚合功能。

LogQL的核心思想是通过标签（labels）和日志行内容来过滤和聚合日志数据。标签是键值对，用于标识日志流的元数据，而日志行则是实际的日志内容。

## LogQL基础语法

LogQL的查询语法由两部分组成：**日志流选择器**和**日志管道**。

### 1. 日志流选择器

日志流选择器用于选择特定的日志流。它基于标签来过滤日志数据。例如：

```logql
{job="api-server", env="production"}
```

这条查询会选择所有标签为 `job="api-server"` 且 `env="production"` 的日志流。

### 2. 日志管道

日志管道用于对选中的日志流进行进一步的处理。常见的操作包括过滤、提取字段、聚合等。例如：

```logql
{job="api-server", env="production"} |= "error"
```

这条查询会选择所有标签为 `job="api-server"` 且 `env="production"` 的日志流，并且只保留包含 `"error"` 的日志行。

## LogQL常用操作符

LogQL提供了多种操作符，用于过滤和操作日志数据。以下是一些常用的操作符：

- **`|=`**: 匹配包含指定字符串的日志行。
- **`!=`**: 匹配不包含指定字符串的日志行。
- **`|~`**: 匹配符合正则表达式的日志行。
- **`!~`**: 匹配不符合正则表达式的日志行。

例如：

```logql
{job="api-server"} |= "error" |~ "timeout"
```

这条查询会选择所有标签为 `job="api-server"` 的日志流，并且只保留包含 `"error"` 且符合 `"timeout"` 正则表达式的日志行。

## LogQL聚合函数

LogQL还支持对日志数据进行聚合操作。常见的聚合函数包括：

- **`count_over_time`**: 计算指定时间范围内的日志行数。
- **`rate`**: 计算日志行的速率。
- **`sum`**: 对日志行中的数值字段求和。

例如：

```logql
sum(rate({job="api-server"}[5m]))
```

这条查询会计算 `job="api-server"` 日志流在过去5分钟内的日志行速率，并对其求和。

## 实际案例

假设你正在监控一个生产环境的API服务器，并且想要查找过去10分钟内所有包含 `"error"` 的日志行。你可以使用以下LogQL查询：

```logql
{job="api-server", env="production"} |= "error" [10m]
```

这条查询会选择所有标签为 `job="api-server"` 且 `env="production"` 的日志流，并且只保留过去10分钟内包含 `"error"` 的日志行。

## 总结

LogQL是一个功能强大的日志查询语言，专为Loki设计。通过灵活的日志流选择器和日志管道，你可以轻松地从海量日志数据中提取有价值的信息。LogQL的语法简单直观，适合初学者快速上手。

## 附加资源

- [Loki官方文档](https://grafana.com/docs/loki/latest/)
- [LogQL查询示例](https://grafana.com/docs/loki/latest/logql/)
- [PromQL与LogQL对比](https://grafana.com/docs/loki/latest/logql/#comparison-with-promql)

## 练习

1. 编写一个LogQL查询，选择所有标签为 `job="web-server"` 且 `env="staging"` 的日志流，并且只保留包含 `"warning"` 的日志行。
2. 使用 `rate` 函数计算 `job="api-server"` 日志流在过去5分钟内的日志行速率。

通过以上练习，你将更好地掌握LogQL的基本用法，并能够在实际项目中应用它。