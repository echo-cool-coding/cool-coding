---
title: PromQL基础查询
description: 了解PromQL的基础查询语法，掌握如何使用PromQL从Prometheus中提取和操作时间序列数据。
---

# PromQL基础查询

PromQL（Prometheus Query Language）是Prometheus的查询语言，用于从Prometheus中提取和操作时间序列数据。无论你是监控系统性能、分析应用程序行为，还是进行故障排查，PromQL都是一个强大的工具。本文将带你从基础开始，逐步掌握PromQL的核心概念和查询技巧。

## 什么是PromQL？

PromQL是一种专门为Prometheus设计的查询语言，用于查询和操作时间序列数据。时间序列数据是由时间戳和值组成的数据点集合，通常用于监控和记录系统或应用程序的状态。

PromQL允许你执行以下操作：
- 选择特定的时间序列
- 对时间序列进行聚合
- 计算新的时间序列
- 过滤和转换数据

## 基础查询语法

PromQL的查询语法非常简单直观。一个基本的查询通常由以下几个部分组成：

1. **指标名称（Metric Name）**：这是你要查询的时间序列的名称。例如，`http_requests_total`表示HTTP请求的总数。
2. **标签过滤器（Label Filters）**：用于筛选特定的时间序列。例如，`{job="api-server"}`表示只查询`job`标签为`api-server`的时间序列。
3. **时间范围（Time Range）**：指定查询的时间范围。例如，`[5m]`表示过去5分钟的数据。

### 示例：查询HTTP请求总数

假设我们有一个名为`http_requests_total`的指标，表示HTTP请求的总数。我们可以使用以下PromQL查询来获取过去5分钟内所有HTTP请求的总数：

```promql
http_requests_total{job="api-server"}[5m]
```

### 输出示例

```plaintext
http_requests_total{job="api-server", method="GET", status="200"} 12345
http_requests_total{job="api-server", method="POST", status="200"} 6789
```

在这个例子中，我们查询了`job`标签为`api-server`的所有HTTP请求，并返回了每个请求方法（`method`）和状态码（`status`）对应的请求总数。

## 聚合操作

PromQL提供了多种聚合操作符，允许你对时间序列进行聚合计算。常见的聚合操作符包括：

- `sum()`：计算所有时间序列的总和
- `avg()`：计算所有时间序列的平均值
- `min()`：计算所有时间序列的最小值
- `max()`：计算所有时间序列的最大值
- `count()`：计算时间序列的数量

### 示例：计算HTTP请求总数的平均值

假设我们想要计算过去5分钟内所有HTTP请求的平均值，可以使用以下PromQL查询：

```promql
avg(http_requests_total{job="api-server"}[5m])
```

### 输出示例

```plaintext
avg(http_requests_total{job="api-server"}) 9567
```

在这个例子中，我们计算了所有`job`标签为`api-server`的HTTP请求的平均值。

## 实际应用场景

### 场景1：监控API服务器的请求速率

假设我们想要监控API服务器的请求速率，可以使用以下PromQL查询来计算每秒的请求数：

```promql
rate(http_requests_total{job="api-server"}[1m])
```

### 输出示例

```plaintext
rate(http_requests_total{job="api-server", method="GET", status="200"}[1m]) 12.34
rate(http_requests_total{job="api-server", method="POST", status="200"}[1m]) 5.67
```

在这个例子中，我们使用了`rate()`函数来计算过去1分钟内每秒的请求数。

### 场景2：检测异常请求

假设我们想要检测异常请求（例如状态码为500的请求），可以使用以下PromQL查询：

```promql
http_requests_total{job="api-server", status="500"}
```

### 输出示例

```plaintext
http_requests_total{job="api-server", method="GET", status="500"} 10
http_requests_total{job="api-server", method="POST", status="500"} 5
```

在这个例子中，我们查询了所有状态码为500的HTTP请求。

## 总结

PromQL是Prometheus的核心查询语言，掌握它的基础查询语法和操作符对于监控和分析时间序列数据至关重要。通过本文的学习，你应该已经掌握了如何编写基本的PromQL查询，并了解了如何在实际场景中应用这些查询。

## 附加资源与练习

- **练习1**：尝试编写一个PromQL查询，计算过去10分钟内所有HTTP请求的总和。
- **练习2**：使用`rate()`函数计算过去5分钟内每秒的请求数，并过滤出状态码为200的请求。
- **附加资源**：阅读[Prometheus官方文档](https://prometheus.io/docs/prometheus/latest/querying/basics/)以深入了解PromQL的高级功能。

:::tip
提示：在实际使用中，PromQL查询通常与Grafana等可视化工具结合使用，以便更直观地展示监控数据。
:::