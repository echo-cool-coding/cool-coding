---
title: 状态持久化
description: 了解如何在 React 应用中实现状态持久化，确保应用状态在页面刷新或重新加载时不会丢失。
---

## 什么是状态持久化？

在 React 应用中，状态（state）是组件内部的数据存储机制。然而，当页面刷新或重新加载时，组件的状态通常会丢失。状态持久化是指将应用的状态保存在某个持久化存储中（如 `localStorage`、`sessionStorage` 或数据库），以便在页面刷新或重新加载后能够恢复状态。

状态持久化在以下场景中非常有用：
- 用户登录状态
- 表单数据
- 用户偏好设置
- 购物车内容

## 如何实现状态持久化？

### 使用 `localStorage` 实现状态持久化

`localStorage` 是浏览器提供的一种持久化存储机制，数据会一直保留在浏览器中，直到用户手动清除。我们可以利用 `localStorage` 来保存和恢复 React 组件的状态。

#### 示例：保存和恢复用户偏好设置

假设我们有一个简单的 React 组件，允许用户选择主题（深色或浅色）。我们希望即使用户刷新页面，主题设置也能保持不变。

```jsx
import React, { useState, useEffect } from 'react';

function ThemeSelector() {
  const [theme, setTheme] = useState(() => {
    // 从 localStorage 中获取初始主题
    const savedTheme = localStorage.getItem('theme');
    return savedTheme || 'light';
  });

  useEffect(() => {
    // 每当主题变化时，保存到 localStorage
    localStorage.setItem('theme', theme);
  }, [theme]);

  return (
    <div>
      <h2>选择主题</h2>
      <button onClick={() => setTheme('light')}>浅色主题</button>
      <button onClick={() => setTheme('dark')}>深色主题</button>
      <p>当前主题: {theme}</p>
    </div>
  );
}

export default ThemeSelector;
```

#### 代码解释：
1. **初始化状态**：我们使用 `useState` 初始化 `theme` 状态，并从 `localStorage` 中获取保存的主题。如果 `localStorage` 中没有保存的主题，则默认使用 `'light'`。
2. **保存状态**：使用 `useEffect` 监听 `theme` 的变化，并在每次变化时将新的主题保存到 `localStorage` 中。
3. **恢复状态**：当组件重新加载时，`useState` 会从 `localStorage` 中读取保存的主题，从而恢复用户的选择。

### 使用 `sessionStorage` 实现状态持久化

`sessionStorage` 与 `localStorage` 类似，但数据仅在当前会话期间有效。当用户关闭浏览器标签页时，`sessionStorage` 中的数据会被清除。

#### 示例：保存和恢复表单数据

假设我们有一个表单，用户输入的数据需要在页面刷新时保留，但不需要长期保存。

```jsx
import React, { useState, useEffect } from 'react';

function Form() {
  const [inputValue, setInputValue] = useState(() => {
    // 从 sessionStorage 中获取初始值
    const savedValue = sessionStorage.getItem('inputValue');
    return savedValue || '';
  });

  useEffect(() => {
    // 每当输入值变化时，保存到 sessionStorage
    sessionStorage.setItem('inputValue', inputValue);
  }, [inputValue]);

  return (
    <div>
      <h2>表单</h2>
      <input
        type="text"
        value={inputValue}
        onChange={(e) => setInputValue(e.target.value)}
      />
      <p>输入的值: {inputValue}</p>
    </div>
  );
}

export default Form;
```

#### 代码解释：
1. **初始化状态**：我们从 `sessionStorage` 中获取保存的输入值，并将其作为初始状态。
2. **保存状态**：每当输入值变化时，将其保存到 `sessionStorage` 中。
3. **恢复状态**：当页面刷新时，`useState` 会从 `sessionStorage` 中读取保存的值，从而恢复用户的输入。

### 使用第三方库实现状态持久化

除了手动使用 `localStorage` 或 `sessionStorage`，我们还可以使用一些第三方库来简化状态持久化的实现。例如，`redux-persist` 是一个流行的库，用于在 Redux 中实现状态持久化。

#### 示例：使用 `redux-persist` 持久化 Redux 状态

```jsx
import { createStore } from 'redux';
import { persistStore, persistReducer } from 'redux-persist';
import storage from 'redux-persist/lib/storage'; // 默认使用 localStorage
import { Provider } from 'react-redux';
import { PersistGate } from 'redux-persist/integration/react';

// 定义 Redux reducer
const rootReducer = (state = { count: 0 }, action) => {
  switch (action.type) {
    case 'INCREMENT':
      return { ...state, count: state.count + 1 };
    default:
      return state;
  }
};

// 配置持久化
const persistConfig = {
  key: 'root',
  storage,
};

const persistedReducer = persistReducer(persistConfig, rootReducer);

// 创建 store 和 persistor
const store = createStore(persistedReducer);
const persistor = persistStore(store);

function App() {
  return (
    <Provider store={store}>
      <PersistGate loading={null} persistor={persistor}>
        <Counter />
      </PersistGate>
    </Provider>
  );
}

function Counter() {
  const count = useSelector((state) => state.count);
  const dispatch = useDispatch();

  return (
    <div>
      <h2>计数器</h2>
      <p>当前计数: {count}</p>
      <button onClick={() => dispatch({ type: 'INCREMENT' })}>增加</button>
    </div>
  );
}

export default App;
```

#### 代码解释：
1. **配置持久化**：我们使用 `redux-persist` 配置持久化，并指定使用 `localStorage` 作为存储介质。
2. **创建 store 和 persistor**：我们创建了一个 Redux store，并使用 `persistStore` 创建一个 persistor 对象。
3. **使用 `PersistGate`**：`PersistGate` 是一个 React 组件，用于在 Redux 状态恢复完成之前显示加载状态。

## 实际应用场景

### 1. 用户登录状态持久化

在用户登录后，我们可以将用户的登录状态（如 token）保存到 `localStorage` 中。这样即使用户刷新页面，应用也能自动恢复登录状态。

### 2. 表单数据持久化

在填写长表单时，用户可能会不小心刷新页面。通过将表单数据保存到 `sessionStorage` 中，我们可以确保用户在刷新页面后不会丢失已填写的内容。

### 3. 用户偏好设置持久化

用户选择的主题、语言偏好等设置可以保存到 `localStorage` 中，以便在用户下次访问时自动应用这些设置。

## 总结

状态持久化是 React 应用开发中的一个重要概念，它可以帮助我们在页面刷新或重新加载时保留应用的状态。通过使用 `localStorage`、`sessionStorage` 或第三方库如 `redux-persist`，我们可以轻松实现状态持久化。

## 附加资源与练习

- **练习**：尝试在一个 React 应用中实现购物车的状态持久化，确保即使用户刷新页面，购物车中的商品也不会丢失。
- **资源**：
  - [MDN Web Docs: localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage)
  - [MDN Web Docs: sessionStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage)
  - [redux-persist 官方文档](https://github.com/rt2zz/redux-persist)