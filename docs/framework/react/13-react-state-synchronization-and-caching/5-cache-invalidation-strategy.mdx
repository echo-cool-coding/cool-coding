---
title: 缓存失效策略
description: 了解缓存失效策略的基本概念、常见方法及其在 React 状态同步与缓存中的应用场景。
---

# 缓存失效策略

在 React 应用中，缓存是提升性能的重要手段之一。然而，缓存的数据可能会过时或失效，因此需要一种机制来确保缓存数据的有效性。这就是**缓存失效策略**的核心目标。本文将详细介绍缓存失效策略的概念、常见方法以及实际应用场景。

## 什么是缓存失效策略？

缓存失效策略是指当缓存中的数据不再有效时，如何检测并更新这些数据的机制。缓存失效通常发生在以下情况：

1. **数据过期**：缓存数据有一个固定的生命周期，超过这个时间后数据被视为无效。
2. **数据更新**：源数据发生变化，缓存中的数据需要同步更新。
3. **手动失效**：开发者或用户主动触发缓存失效。

缓存失效策略的目标是确保缓存中的数据始终与源数据保持一致，同时尽量减少不必要的缓存更新操作。

## 常见的缓存失效策略

以下是几种常见的缓存失效策略：

### 1. 基于时间的失效（TTL）

基于时间的失效策略（Time-to-Live, TTL）是最简单的缓存失效方法。它为缓存数据设置一个固定的过期时间，当数据超过这个时间后，缓存会自动失效。

```javascript
const cache = new Map();

function setCache(key, value, ttl) {
  const expiresAt = Date.now() + ttl;
  cache.set(key, { value, expiresAt });
}

function getCache(key) {
  const item = cache.get(key);
  if (!item || Date.now() > item.expiresAt) {
    cache.delete(key);
    return null;
  }
  return item.value;
}
```

:::tip
TTL 适用于数据变化频率较低的场景，例如静态资源或配置数据。
:::

### 2. 基于事件的失效

基于事件的失效策略是指当源数据发生变化时，主动触发缓存失效。这种方法通常需要与后端服务或数据库进行集成。

```javascript
function updateDataSource(key, newValue) {
  // 更新源数据
  updateDatabase(key, newValue);

  // 触发缓存失效
  invalidateCache(key);
}

function invalidateCache(key) {
  cache.delete(key);
}
```

:::caution
基于事件的失效需要确保数据更新和缓存失效操作的原子性，否则可能导致缓存与源数据不一致。
:::

### 3. 手动失效

手动失效是指开发者或用户主动触发缓存失效。这种方法通常用于需要即时更新缓存的场景。

```javascript
function refreshCache(key) {
  const newValue = fetchDataFromSource(key);
  setCache(key, newValue, 60000); // 设置新的 TTL
}
```

:::note
手动失效适用于需要即时响应的场景，例如用户操作后的数据刷新。
:::

## 实际应用场景

### 场景 1：用户信息缓存

假设我们有一个 React 应用，需要缓存用户的个人信息。我们可以使用 TTL 策略来缓存用户数据，并在用户信息更新时手动触发缓存失效。

```javascript
function fetchUserInfo(userId) {
  const cachedUserInfo = getCache(`user-${userId}`);
  if (cachedUserInfo) {
    return cachedUserInfo;
  }

  const userInfo = fetchFromServer(`/api/users/${userId}`);
  setCache(`user-${userId}`, userInfo, 60000); // 缓存 1 分钟
  return userInfo;
}

function updateUserInfo(userId, newInfo) {
  updateUserOnServer(userId, newInfo);
  invalidateCache(`user-${userId}`);
}
```

### 场景 2：实时数据同步

在某些实时性要求较高的场景中，我们可以结合基于事件的失效和手动失效策略。例如，在聊天应用中，当新消息到达时，我们可以手动刷新缓存。

```javascript
function fetchMessages(chatId) {
  const cachedMessages = getCache(`messages-${chatId}`);
  if (cachedMessages) {
    return cachedMessages;
  }

  const messages = fetchFromServer(`/api/chats/${chatId}/messages`);
  setCache(`messages-${chatId}`, messages, 30000); // 缓存 30 秒
  return messages;
}

function onNewMessage(chatId, newMessage) {
  const messages = fetchMessages(chatId);
  messages.push(newMessage);
  setCache(`messages-${chatId}`, messages, 30000); // 更新缓存
}
```

## 总结

缓存失效策略是确保缓存数据有效性的关键机制。通过合理选择和使用 TTL、基于事件的失效和手动失效等策略，我们可以在 React 应用中实现高效的状态同步与缓存管理。

:::tip 附加资源
- [React 官方文档](https://reactjs.org/docs/state-and-lifecycle.html)
- [MDN Web Docs: Cache API](https://developer.mozilla.org/en-US/docs/Web/API/Cache)
- [Caching Strategies for Web Applications](https://web.dev/stale-while-revalidate/)
:::

:::warning 练习
1. 尝试在 React 应用中实现一个简单的 TTL 缓存机制。
2. 设计一个基于事件的缓存失效方案，并在实际项目中应用。
:::