---
title: 请求去重与合并
description: 了解如何在 React 应用中实现请求去重与合并，优化网络请求性能并减少重复请求。
---

在构建现代 Web 应用时，网络请求是不可或缺的一部分。然而，当多个组件或功能同时请求相同的数据时，可能会导致重复请求，浪费带宽并增加服务器负载。为了解决这个问题，我们可以使用 **请求去重与合并** 技术。

## 什么是请求去重与合并？

**请求去重** 是指在短时间内，如果多个请求的目标相同（例如请求同一个 API 端点），则只发送一个请求，并将结果共享给所有请求者。这样可以避免重复请求，减少不必要的网络流量。

**请求合并** 是指将多个相似的请求合并为一个请求，以减少请求次数。例如，如果多个组件需要获取同一类型的数据，可以将这些请求合并为一个批量请求，从而优化性能。

## 为什么需要请求去重与合并？

1. **减少网络流量**：避免重复请求，节省带宽。
2. **降低服务器负载**：减少不必要的请求，减轻服务器压力。
3. **提高性能**：通过合并请求，减少请求次数，加快数据获取速度。
4. **提升用户体验**：减少加载时间，提供更流畅的用户体验。

## 如何实现请求去重与合并？

### 1. 使用缓存机制

缓存是请求去重的核心。我们可以使用内存缓存（如 `Map`）来存储已经发送的请求及其结果。当新的请求到来时，首先检查缓存中是否已有相同请求的结果。如果有，则直接返回缓存的结果；如果没有，则发送请求并将结果缓存。

```javascript
const cache = new Map();

async function fetchData(url) {
  if (cache.has(url)) {
    return cache.get(url);
  }

  const response = await fetch(url);
  const data = await response.json();
  cache.set(url, data);
  return data;
}
```

### 2. 使用 Promise 共享

当多个组件同时请求相同的数据时，我们可以使用 `Promise` 来共享请求结果。具体做法是，将正在进行的请求存储在缓存中，后续请求可以直接使用这个 `Promise`，而不需要重新发送请求。

```javascript
const cache = new Map();

async function fetchData(url) {
  if (cache.has(url)) {
    return cache.get(url);
  }

  const promise = fetch(url).then(response => response.json());
  cache.set(url, promise);
  return promise;
}
```

### 3. 请求合并

在某些情况下，多个请求可以合并为一个批量请求。例如，如果多个组件需要获取不同用户的数据，我们可以将这些请求合并为一个批量请求。

```javascript
async function fetchUsers(userIds) {
  const response = await fetch(`/api/users?ids=${userIds.join(',')}`);
  return response.json();
}
```

## 实际案例

假设我们有一个社交网络应用，用户可以在主页和侧边栏同时查看自己的好友列表。如果不进行请求去重，主页和侧边栏可能会分别发送请求，导致重复请求。

通过使用请求去重与合并，我们可以确保只发送一个请求，并将结果共享给主页和侧边栏。

```javascript
const cache = new Map();

async function fetchFriends(userId) {
  const url = `/api/friends/${userId}`;
  if (cache.has(url)) {
    return cache.get(url);
  }

  const promise = fetch(url).then(response => response.json());
  cache.set(url, promise);
  return promise;
}

// 在主页和侧边栏中使用
const friends = await fetchFriends(123);
```

## 总结

请求去重与合并是优化网络请求性能的重要手段。通过缓存机制、`Promise` 共享和请求合并，我们可以减少重复请求，降低服务器负载，并提高应用性能。

在实际开发中，你可以根据具体需求选择合适的策略。例如，对于频繁请求的数据，可以使用缓存机制；对于批量请求，可以使用请求合并。

## 附加资源

- [MDN Web Docs: Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)
- [React Query: Data Fetching Library](https://react-query.tanstack.com/)
- [Axios: HTTP Client](https://axios-http.com/)

## 练习

1. 尝试在你的 React 项目中实现请求去重与合并。
2. 使用 `Promise` 共享机制，优化多个组件同时请求相同数据的场景。
3. 实现一个批量请求功能，将多个请求合并为一个请求。

通过实践，你将更好地理解请求去重与合并的概念，并能够在实际项目中应用这些技术。