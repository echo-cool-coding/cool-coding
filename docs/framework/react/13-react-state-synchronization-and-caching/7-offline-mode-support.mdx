---
title: 离线模式支持
description: 了解如何在 React 应用中实现离线模式支持，确保用户在网络不可用时仍能访问关键功能。
---

# 离线模式支持

在现代 Web 应用中，离线模式支持是一个重要的功能，尤其是在网络连接不稳定或完全不可用的情况下。通过实现离线模式，用户可以继续访问应用的核心功能，而不受网络状态的限制。本文将详细介绍如何在 React 应用中实现离线模式支持，并通过实际案例展示其应用场景。

## 什么是离线模式？

离线模式是指应用在没有网络连接的情况下，仍然能够正常运行并提供基本功能的能力。为了实现这一点，应用需要能够在本地存储数据，并在网络恢复时同步这些数据。

## 实现离线模式的基本步骤

### 1. 检测网络状态

首先，我们需要检测用户的网络状态。可以使用 `navigator.onLine` 属性来检查用户是否在线。

```javascript
const isOnline = navigator.onLine;
console.log(isOnline ? '在线' : '离线');
```

### 2. 使用 Service Worker 缓存资源

Service Worker 是一种运行在浏览器后台的脚本，它可以拦截网络请求并缓存资源。通过使用 Service Worker，我们可以在用户离线时提供缓存的资源。

```javascript
// service-worker.js
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open('my-cache').then((cache) => {
      return cache.addAll([
        '/',
        '/index.html',
        '/styles.css',
        '/app.js'
      ]);
    })
  );
});

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      return response || fetch(event.request);
    })
  );
});
```

### 3. 使用 IndexedDB 存储数据

IndexedDB 是一个低级的 API，用于在客户端存储大量结构化数据。我们可以使用 IndexedDB 来存储用户数据，以便在离线时访问。

```javascript
// 打开或创建数据库
const request = indexedDB.open('my-database', 1);

request.onupgradeneeded = (event) => {
  const db = event.target.result;
  const objectStore = db.createObjectStore('my-store', { keyPath: 'id' });
};

request.onsuccess = (event) => {
  const db = event.target.result;
  const transaction = db.transaction('my-store', 'readwrite');
  const store = transaction.objectStore('my-store');

  // 添加数据
  store.add({ id: 1, name: 'John Doe' });

  // 读取数据
  const getRequest = store.get(1);
  getRequest.onsuccess = () => {
    console.log(getRequest.result);
  };
};
```

### 4. 同步离线数据

当用户重新上线时，我们需要将离线时存储的数据同步到服务器。可以使用 `navigator.onLine` 事件监听器来检测网络状态的变化，并在网络恢复时触发同步操作。

```javascript
window.addEventListener('online', () => {
  // 同步数据到服务器
  syncData();
});

function syncData() {
  // 从 IndexedDB 读取数据并发送到服务器
  const request = indexedDB.open('my-database', 1);
  request.onsuccess = (event) => {
    const db = event.target.result;
    const transaction = db.transaction('my-store', 'readonly');
    const store = transaction.objectStore('my-store');
    const getAllRequest = store.getAll();

    getAllRequest.onsuccess = () => {
      const data = getAllRequest.result;
      // 发送数据到服务器
      fetch('/sync', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      });
    };
  };
}
```

## 实际案例

假设我们正在开发一个待办事项应用，用户可以在离线时添加任务，并在网络恢复时自动同步这些任务。

```javascript
// 添加任务
function addTask(task) {
  const request = indexedDB.open('todo-db', 1);

  request.onsuccess = (event) => {
    const db = event.target.result;
    const transaction = db.transaction('tasks', 'readwrite');
    const store = transaction.objectStore('tasks');
    store.add(task);
  };
}

// 同步任务
function syncTasks() {
  const request = indexedDB.open('todo-db', 1);
  request.onsuccess = (event) => {
    const db = event.target.result;
    const transaction = db.transaction('tasks', 'readonly');
    const store = transaction.objectStore('tasks');
    const getAllRequest = store.getAll();

    getAllRequest.onsuccess = () => {
      const tasks = getAllRequest.result;
      fetch('/sync-tasks', {
        method: 'POST',
        body: JSON.stringify(tasks),
        headers: {
          'Content-Type': 'application/json'
        }
      });
    };
  };
}

window.addEventListener('online', syncTasks);
```

## 总结

通过实现离线模式支持，我们可以显著提升用户体验，确保用户在网络不可用时仍能访问应用的核心功能。本文介绍了如何检测网络状态、使用 Service Worker 缓存资源、使用 IndexedDB 存储数据以及同步离线数据的基本步骤。希望这些内容能帮助你在 React 应用中实现离线模式支持。

## 附加资源

- [MDN Web Docs: Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [MDN Web Docs: IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
- [Google Developers: Offline Cookbook](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook)

## 练习

1. 尝试在你的 React 应用中实现一个简单的离线模式，允许用户在离线时添加数据，并在网络恢复时同步数据。
2. 使用 Service Worker 缓存应用的静态资源，并测试在离线时是否能够正常访问这些资源。