---
title: 跨层级组件通信
description: 了解如何在 React 中实现跨层级组件通信，掌握 Context API 和自定义事件机制的使用方法。
---

在 React 应用中，组件之间的通信是一个常见的需求。当组件层级较浅时，可以通过 `props` 将数据从父组件传递到子组件。然而，当组件层级较深时，单纯依赖 `props` 会导致代码冗长且难以维护。这时，跨层级组件通信就显得尤为重要。

本文将介绍两种常见的跨层级组件通信方式：**Context API** 和 **自定义事件机制**，并通过实际案例帮助你理解它们的应用场景。

---

## 1. 什么是跨层级组件通信？

跨层级组件通信是指在 React 应用中，组件之间无需通过逐层传递 `props` 即可实现数据共享或状态管理的机制。这种方式特别适用于以下场景：

- 组件层级较深，传递 `props` 会导致代码冗余。
- 多个组件需要共享同一份数据或状态。
- 需要在组件之间触发事件或更新状态。

接下来，我们将通过两种方法来实现跨层级组件通信。

---

## 2. 使用 Context API 实现跨层级通信

Context API 是 React 提供的一种内置机制，用于在组件树中共享数据。它允许你将数据传递给深层嵌套的组件，而无需手动逐层传递 `props`。

### 2.1 创建 Context

首先，我们需要创建一个 Context 对象：

```jsx
import React from 'react';

// 创建一个 Context 对象
const MyContext = React.createContext();
```

### 2.2 提供 Context 数据

接下来，使用 `MyContext.Provider` 将数据提供给子组件：

```jsx
function App() {
  const sharedData = "Hello from Context!";

  return (
    <MyContext.Provider value={sharedData}>
      <ChildComponent />
    </MyContext.Provider>
  );
}
```

### 2.3 消费 Context 数据

在子组件中，可以通过 `useContext` Hook 或 `MyContext.Consumer` 来获取 Context 数据：

```jsx
import React, { useContext } from 'react';

function ChildComponent() {
  const data = useContext(MyContext);

  return <div>{data}</div>;
}
```

:::tip
`useContext` 是 React 16.8 引入的 Hook，它简化了 Context 的使用方式，推荐优先使用。
:::

### 2.4 实际案例：主题切换

假设我们需要实现一个主题切换功能，用户可以在深层次组件中切换应用的主题颜色。以下是实现代码：

```jsx
import React, { useContext, useState } from 'react';

// 创建 Context
const ThemeContext = React.createContext();

function App() {
  const [theme, setTheme] = useState('light');

  const toggleTheme = () => {
    setTheme(theme === 'light' ? 'dark' : 'light');
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      <Toolbar />
    </ThemeContext.Provider>
  );
}

function Toolbar() {
  return (
    <div>
      <ThemedButton />
    </div>
  );
}

function ThemedButton() {
  const { theme, toggleTheme } = useContext(ThemeContext);

  return (
    <button
      onClick={toggleTheme}
      style={{
        backgroundColor: theme === 'light' ? '#fff' : '#333',
        color: theme === 'light' ? '#000' : '#fff',
      }}
    >
      Toggle Theme
    </button>
  );
}
```

在这个例子中，`ThemedButton` 组件无需通过 `props` 即可访问 `theme` 和 `toggleTheme`，实现了跨层级通信。

---

## 3. 使用自定义事件机制实现跨层级通信

除了 Context API，我们还可以通过自定义事件机制实现跨层级通信。这种方式适用于需要在组件之间触发事件或传递数据的场景。

### 3.1 创建事件总线

首先，我们需要创建一个事件总线（Event Bus），用于管理事件的发布和订阅：

```jsx
class EventBus {
  constructor() {
    this.events = {};
  }

  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  }

  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  }
}

const eventBus = new EventBus();
```

### 3.2 发布和订阅事件

在父组件中发布事件，在子组件中订阅事件：

```jsx
function ParentComponent() {
  const handleClick = () => {
    eventBus.emit('customEvent', 'Hello from Parent!');
  };

  return (
    <div>
      <button onClick={handleClick}>Send Message</button>
      <ChildComponent />
    </div>
  );
}

function ChildComponent() {
  const [message, setMessage] = React.useState('');

  React.useEffect(() => {
    const handleCustomEvent = (data) => {
      setMessage(data);
    };

    eventBus.on('customEvent', handleCustomEvent);

    return () => {
      eventBus.off('customEvent', handleCustomEvent);
    };
  }, []);

  return <div>{message}</div>;
}
```

### 3.3 实际案例：全局通知

假设我们需要在应用中实现一个全局通知功能，当用户点击按钮时，通知会显示在页面的任意位置。以下是实现代码：

```jsx
function App() {
  const showNotification = () => {
    eventBus.emit('showNotification', 'New Notification!');
  };

  return (
    <div>
      <button onClick={showNotification}>Show Notification</button>
      <Notification />
    </div>
  );
}

function Notification() {
  const [notification, setNotification] = React.useState('');

  React.useEffect(() => {
    const handleNotification = (message) => {
      setNotification(message);
      setTimeout(() => setNotification(''), 3000);
    };

    eventBus.on('showNotification', handleNotification);

    return () => {
      eventBus.off('showNotification', handleNotification);
    };
  }, []);

  return notification ? <div className="notification">{notification}</div> : null;
}
```

在这个例子中，`Notification` 组件通过事件总线接收通知消息，无需与父组件直接通信。

---

## 4. 总结

跨层级组件通信是 React 开发中的重要概念，能够有效解决深层嵌套组件之间的数据共享和状态管理问题。本文介绍了两种常见的实现方式：

1. **Context API**：适用于需要共享全局数据或状态的场景。
2. **自定义事件机制**：适用于需要在组件之间触发事件或传递数据的场景。

根据实际需求选择合适的通信方式，可以让你的代码更加简洁和高效。

---

## 5. 附加资源与练习

### 附加资源
- [React 官方文档 - Context](https://reactjs.org/docs/context.html)
- [React 官方文档 - Hooks](https://reactjs.org/docs/hooks-intro.html)

### 练习
1. 使用 Context API 实现一个多语言切换功能。
2. 使用自定义事件机制实现一个全局加载状态管理功能。

通过实践这些练习，你将更好地掌握跨层级组件通信的技巧！