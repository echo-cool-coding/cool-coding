---
title: Next.js 中间件
description: 了解 Next.js 中间件的工作原理、使用场景以及如何在实际项目中应用它。
---

## 介绍

Next.js 中间件是一种强大的工具，允许你在请求到达页面之前拦截并处理请求。它可以用于身份验证、重定向、修改请求头、日志记录等场景。中间件在 Next.js 12 中引入，为开发者提供了更大的灵活性和控制力。

中间件运行在 Edge Runtime 环境中，这意味着它可以在全球分布的边缘节点上执行，从而提供更快的响应时间。

## 中间件的基本概念

中间件是一个函数，它接收一个 `request` 对象，并返回一个 `response` 对象。你可以在中间件中执行各种操作，例如检查请求头、重定向请求、修改响应等。

### 中间件的生命周期

中间件在请求到达页面之前执行。它的生命周期如下：

1. **请求到达服务器**：客户端发送请求到服务器。
2. **中间件执行**：Next.js 调用中间件函数，处理请求。
3. **请求继续**：如果中间件没有返回响应，请求将继续到目标页面或 API 路由。

## 创建一个简单的中间件

让我们从一个简单的中间件示例开始。假设我们想要记录每个请求的路径。

1. 在项目的根目录下创建一个 `middleware.js` 文件。
2. 在 `middleware.js` 中编写以下代码：

```javascript
import { NextResponse } from 'next/server';

export function middleware(request) {
  console.log(`Request path: ${request.nextUrl.pathname}`);
  return NextResponse.next();
}
```

在这个示例中，我们使用 `NextResponse.next()` 来允许请求继续到目标页面。如果你想要阻止请求继续，可以返回一个 `NextResponse.redirect()` 或 `NextResponse.rewrite()`。

### 运行效果

当你访问任何页面时，控制台会输出请求的路径。例如，访问 `/about` 时，控制台会输出：

```
Request path: /about
```

## 中间件的实际应用场景

### 1. 身份验证

中间件非常适合用于身份验证。例如，你可以检查用户是否已登录，如果没有登录，则重定向到登录页面。

```javascript
import { NextResponse } from 'next/server';

export function middleware(request) {
  const token = request.cookies.get('authToken');
  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
  return NextResponse.next();
}
```

### 2. A/B 测试

你可以使用中间件来实现 A/B 测试。例如，随机将用户重定向到不同的页面版本。

```javascript
import { NextResponse } from 'next/server';

export function middleware(request) {
  const version = Math.random() > 0.5 ? 'a' : 'b';
  return NextResponse.rewrite(new URL(`/${version}${request.nextUrl.pathname}`, request.url));
}
```

### 3. 修改请求头

中间件还可以用于修改请求头。例如，你可以为所有请求添加一个自定义头。

```javascript
import { NextResponse } from 'next/server';

export function middleware(request) {
  const response = NextResponse.next();
  response.headers.set('x-custom-header', 'my-value');
  return response;
}
```

## 中间件的配置

你可以通过 `config` 对象来配置中间件的匹配规则。例如，你可以指定中间件只在特定路径下运行。

```javascript
import { NextResponse } from 'next/server';

export function middleware(request) {
  return NextResponse.next();
}

export const config = {
  matcher: '/about/:path*',
};
```

在这个示例中，中间件只会对 `/about` 路径及其子路径生效。

## 总结

Next.js 中间件是一个强大的工具，可以帮助你在请求到达页面之前进行各种操作。无论是身份验证、重定向、修改请求头，还是实现 A/B 测试，中间件都能为你提供灵活的控制。

通过本文，你已经了解了中间件的基本概念、如何创建和使用中间件，以及一些实际应用场景。希望这些知识能帮助你在实际项目中更好地利用 Next.js 中间件。

## 附加资源

- [Next.js 官方文档 - 中间件](https://nextjs.org/docs/middleware)
- [Next.js GitHub 仓库](https://github.com/vercel/next.js)

## 练习

1. 创建一个中间件，记录每个请求的 IP 地址。
2. 实现一个中间件，将未登录用户重定向到 `/login` 页面。
3. 使用中间件为所有请求添加一个自定义响应头 `x-request-id`，并为其生成一个唯一的 ID。

通过这些练习，你将更深入地理解 Next.js 中间件的使用和配置。