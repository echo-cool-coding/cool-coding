---
title: 路由守卫
description: 了解如何在 React 应用中实现路由守卫，以控制用户访问权限并保护特定路由。
---

在构建 React 应用时，路由是一个核心概念，它允许我们在不同的页面之间导航。然而，并非所有用户都应该能够访问应用中的每个页面。例如，某些页面可能只对已登录的用户开放，或者某些功能仅对管理员可见。这就是**路由守卫**的用武之地。

## 什么是路由守卫？

路由守卫是一种机制，用于在用户访问特定路由之前执行某些逻辑。这些逻辑通常用于验证用户权限、检查用户是否已登录，或者执行其他与路由相关的条件检查。如果条件不满足，路由守卫可以阻止用户访问该路由，并将其重定向到其他页面（例如登录页面）。

在 React 中，路由守卫通常通过高阶组件（HOC）或自定义钩子来实现。

## 实现路由守卫

### 1. 使用高阶组件（HOC）

高阶组件是一个函数，它接受一个组件并返回一个新的组件。我们可以利用高阶组件来包裹需要保护的路由组件。

以下是一个简单的路由守卫示例：

```jsx
import React from 'react';
import { Navigate } from 'react-router-dom';

const withAuth = (Component) => {
  const AuthComponent = (props) => {
    const isAuthenticated = checkAuth(); // 假设这是一个检查用户是否已登录的函数

    if (!isAuthenticated) {
      return <Navigate to="/login" />;
    }

    return <Component {...props} />;
  };

  return AuthComponent;
};

export default withAuth;
```

在这个例子中，`withAuth` 是一个高阶组件，它接受一个组件并返回一个新的组件。如果用户未通过身份验证，则重定向到登录页面。

### 2. 使用自定义钩子

另一种实现路由守卫的方法是使用自定义钩子。这种方法更加灵活，尤其是在函数组件中。

```jsx
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

const useAuthGuard = () => {
  const navigate = useNavigate();
  const isAuthenticated = checkAuth(); // 假设这是一个检查用户是否已登录的函数

  useEffect(() => {
    if (!isAuthenticated) {
      navigate('/login');
    }
  }, [isAuthenticated, navigate]);
};

export default useAuthGuard;
```

在需要保护的组件中，我们可以直接使用这个钩子：

```jsx
import React from 'react';
import useAuthGuard from './useAuthGuard';

const ProtectedComponent = () => {
  useAuthGuard();

  return <div>这是受保护的页面</div>;
};

export default ProtectedComponent;
```

### 3. 结合 React Router 使用

在实际应用中，我们通常会将路由守卫与 React Router 结合使用。以下是一个完整的示例：

```jsx
import React from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import withAuth from './withAuth';
import Home from './Home';
import Login from './Login';
import Dashboard from './Dashboard';

const App = () => {
  return (
    <Router>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/login" element={<Login />} />
        <Route path="/dashboard" element={withAuth(Dashboard)} />
      </Routes>
    </Router>
  );
};

export default App;
```

在这个例子中，`Dashboard` 组件被 `withAuth` 高阶组件包裹，因此只有已登录的用户才能访问它。

## 实际应用场景

### 1. 用户认证

最常见的路由守卫应用场景是用户认证。例如，在电子商务网站中，用户必须登录后才能访问购物车或结账页面。

### 2. 角色权限控制

在某些应用中，不同的用户角色可能具有不同的访问权限。例如，管理员可以访问管理面板，而普通用户则不能。我们可以通过路由守卫来实现这种权限控制。

```jsx
const withAdminAuth = (Component) => {
  const AdminAuthComponent = (props) => {
    const isAdmin = checkAdmin(); // 假设这是一个检查用户是否为管理员的函数

    if (!isAdmin) {
      return <Navigate to="/" />;
    }

    return <Component {...props} />;
  };

  return AdminAuthComponent;
};
```

### 3. 数据预加载

在某些情况下，我们可能希望在用户访问某个页面之前预加载一些数据。如果数据加载失败，我们可以阻止用户访问该页面。

```jsx
const withDataPreload = (Component, loadData) => {
  const DataPreloadComponent = (props) => {
    const [data, setData] = React.useState(null);
    const [error, setError] = React.useState(null);

    React.useEffect(() => {
      loadData()
        .then(setData)
        .catch(setError);
    }, []);

    if (error) {
      return <Navigate to="/error" />;
    }

    if (!data) {
      return <div>加载中...</div>;
    }

    return <Component {...props} data={data} />;
  };

  return DataPreloadComponent;
};
```

## 总结

路由守卫是 React 应用中保护路由和实现权限控制的重要工具。通过高阶组件或自定义钩子，我们可以轻松地实现路由守卫，并根据需要控制用户对特定页面的访问。

在实际开发中，路由守卫可以用于用户认证、角色权限控制、数据预加载等多种场景。掌握路由守卫的使用，将帮助你构建更加安全和灵活的 React 应用。

## 附加资源

- [React Router 官方文档](https://reactrouter.com/)
- [React 高阶组件指南](https://reactjs.org/docs/higher-order-components.html)
- [React 自定义钩子指南](https://reactjs.org/docs/hooks-custom.html)

## 练习

1. 尝试实现一个路由守卫，要求用户必须登录才能访问 `/profile` 页面。
2. 扩展路由守卫，使其支持不同的用户角色（例如管理员和普通用户）。
3. 实现一个数据预加载的路由守卫，确保在用户访问页面之前加载必要的数据。