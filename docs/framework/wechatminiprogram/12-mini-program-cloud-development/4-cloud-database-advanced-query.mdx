---
title: 云数据库高级查询
description: 学习如何在微信小程序云开发中使用云数据库的高级查询功能，包括条件查询、排序、分页和聚合操作。
---

# 云数据库高级查询

在小程序云开发中，云数据库是一个强大的工具，可以帮助开发者轻松管理和操作数据。在前面的学习中，我们已经了解了如何执行基本的增删改查操作。现在，我们将深入探讨云数据库的高级查询功能，这些功能可以帮助你更高效地处理复杂的数据需求。

## 1. 条件查询

条件查询是云数据库中最常用的功能之一。通过条件查询，你可以根据特定的条件筛选出符合要求的数据。

### 1.1 基本条件查询

假设我们有一个存储用户信息的集合 `users`，其中包含以下字段：`name`、`age`、`city`。我们可以使用 `where` 方法来查询符合条件的数据。

```javascript
const db = wx.cloud.database()
db.collection('users')
  .where({
    city: 'Beijing'
  })
  .get()
  .then(res => {
    console.log(res.data)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 查询条件：`city` 为 `Beijing`

**输出：**
- 返回所有 `city` 为 `Beijing` 的用户数据。

### 1.2 复合条件查询

你还可以使用复合条件查询来组合多个条件。例如，查询 `city` 为 `Beijing` 且 `age` 大于 `20` 的用户。

```javascript
db.collection('users')
  .where({
    city: 'Beijing',
    age: db.command.gt(20)
  })
  .get()
  .then(res => {
    console.log(res.data)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 查询条件：`city` 为 `Beijing` 且 `age` 大于 `20`

**输出：**
- 返回所有 `city` 为 `Beijing` 且 `age` 大于 `20` 的用户数据。

## 2. 排序

排序功能可以帮助你按照指定的字段对查询结果进行排序。你可以使用 `orderBy` 方法来指定排序的字段和顺序。

### 2.1 单字段排序

假设我们想按照用户的年龄从小到大排序：

```javascript
db.collection('users')
  .orderBy('age', 'asc')
  .get()
  .then(res => {
    console.log(res.data)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 排序字段：`age`
- 排序顺序：`asc`（升序）

**输出：**
- 返回所有用户数据，并按照 `age` 从小到大排序。

### 2.2 多字段排序

你还可以按照多个字段进行排序。例如，先按照 `city` 排序，再按照 `age` 排序：

```javascript
db.collection('users')
  .orderBy('city', 'asc')
  .orderBy('age', 'desc')
  .get()
  .then(res => {
    console.log(res.data)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 排序字段1：`city`，顺序：`asc`
- 排序字段2：`age`，顺序：`desc`

**输出：**
- 返回所有用户数据，先按照 `city` 升序排序，再按照 `age` 降序排序。

## 3. 分页

在处理大量数据时，分页是一个非常重要的功能。你可以使用 `skip` 和 `limit` 方法来实现分页查询。

### 3.1 基本分页查询

假设我们想查询第 2 页的数据，每页显示 10 条记录：

```javascript
const page = 2
const pageSize = 10
db.collection('users')
  .skip((page - 1) * pageSize)
  .limit(pageSize)
  .get()
  .then(res => {
    console.log(res.data)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 页码：`2`
- 每页记录数：`10`

**输出：**
- 返回第 2 页的 10 条用户数据。

## 4. 聚合操作

聚合操作可以帮助你对数据进行统计和分析。云数据库支持多种聚合操作，如 `count`、`sum`、`avg` 等。

### 4.1 计数操作

假设我们想统计 `city` 为 `Beijing` 的用户数量：

```javascript
db.collection('users')
  .where({
    city: 'Beijing'
  })
  .count()
  .then(res => {
    console.log(res.total)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 查询条件：`city` 为 `Beijing`

**输出：**
- 返回 `city` 为 `Beijing` 的用户数量。

### 4.2 求和操作

假设我们想计算所有用户的年龄总和：

```javascript
db.collection('users')
  .aggregate()
  .group({
    _id: null,
    totalAge: $.sum('$age')
  })
  .end()
  .then(res => {
    console.log(res.list[0].totalAge)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 聚合操作：`sum`

**输出：**
- 返回所有用户的年龄总和。

## 5. 实际案例

假设你正在开发一个电商小程序，你需要实现以下功能：

1. 查询所有订单中金额大于 100 元的订单。
2. 按照订单金额从高到低排序。
3. 分页显示订单数据，每页显示 5 条记录。

```javascript
const page = 1
const pageSize = 5
db.collection('orders')
  .where({
    amount: db.command.gt(100)
  })
  .orderBy('amount', 'desc')
  .skip((page - 1) * pageSize)
  .limit(pageSize)
  .get()
  .then(res => {
    console.log(res.data)
  })
  .catch(err => {
    console.error(err)
  })
```

**输入：**
- 查询条件：`amount` 大于 `100`
- 排序字段：`amount`，顺序：`desc`
- 页码：`1`
- 每页记录数：`5`

**输出：**
- 返回第 1 页的 5 条订单数据，金额大于 100 元，并按照金额从高到低排序。

## 6. 总结

通过本教程，你已经学习了如何在微信小程序云开发中使用云数据库的高级查询功能，包括条件查询、排序、分页和聚合操作。这些功能可以帮助你更高效地处理复杂的数据需求，提升小程序的性能和用户体验。

## 7. 附加资源与练习

- **练习 1**：尝试在你的小程序中实现一个分页查询功能，查询用户数据并按照年龄排序。
- **练习 2**：使用聚合操作统计某个集合中的数据总量，并计算某个字段的平均值。

:::tip
如果你在练习中遇到问题，可以参考微信小程序的官方文档，或者在我们的社区中寻求帮助。
:::