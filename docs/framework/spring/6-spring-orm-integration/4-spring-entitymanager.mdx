---
title: Spring EntityManager
description: 了解 Spring EntityManager 的核心概念、使用方法及其在 Spring ORM 整合中的实际应用场景。
---

# Spring EntityManager

## 介绍

在 Spring 框架中，`EntityManager` 是 Java Persistence API (JPA) 的核心接口之一，用于管理与数据库的交互。它提供了对实体（Entity）的 CRUD（创建、读取、更新、删除）操作的支持，并允许开发者执行查询和事务管理。Spring 通过 `EntityManager` 简化了与数据库的交互，使得开发者可以更专注于业务逻辑的实现。

`EntityManager` 是 JPA 的一部分，而 Spring 通过 `@PersistenceContext` 注解将其与 Spring 容器集成，从而实现了 ORM（对象关系映射）的无缝整合。

## 核心概念

### 1. 什么是 EntityManager？

`EntityManager` 是一个接口，用于管理实体对象的生命周期。它负责将 Java 对象映射到数据库表，并提供了以下功能：

- **持久化实体**：将实体对象保存到数据库中。
- **查询实体**：通过 JPQL（Java Persistence Query Language）或 Criteria API 查询数据库。
- **更新实体**：修改实体对象并将其同步到数据库。
- **删除实体**：从数据库中删除实体对象。
- **事务管理**：支持事务的提交和回滚。

### 2. EntityManager 的类型

在 JPA 中，`EntityManager` 有两种类型：

- **容器管理的 EntityManager**：由容器（如 Spring 或 Java EE 应用服务器）管理其生命周期。开发者只需通过 `@PersistenceContext` 注解注入即可。
- **应用管理的 EntityManager**：由开发者手动创建和管理其生命周期。

在 Spring 中，通常使用容器管理的 `EntityManager`，因为它更易于集成和管理。

## 使用 Spring EntityManager

### 1. 配置 EntityManager

在 Spring 中，`EntityManager` 的配置通常通过 `LocalContainerEntityManagerFactoryBean` 完成。以下是一个典型的配置示例：

```java
@Configuration
@EnableTransactionManagement
public class PersistenceConfig {

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory() {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource());
        em.setPackagesToScan("com.example.domain");
        em.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        em.setJpaProperties(additionalProperties());
        return em;
    }

    @Bean
    public DataSource dataSource() {
        return new DriverManagerDataSource("jdbc:h2:mem:testdb", "sa", "");
    }

    @Bean
    public PlatformTransactionManager transactionManager(EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }

    private Properties additionalProperties() {
        Properties properties = new Properties();
        properties.setProperty("hibernate.hbm2ddl.auto", "create-drop");
        properties.setProperty("hibernate.dialect", "org.hibernate.dialect.H2Dialect");
        return properties;
    }
}
```

### 2. 注入 EntityManager

在 Spring 中，可以通过 `@PersistenceContext` 注解将 `EntityManager` 注入到服务类或 DAO 类中：

```java
@Service
public class UserService {

    @PersistenceContext
    private EntityManager entityManager;

    public User saveUser(User user) {
        entityManager.persist(user);
        return user;
    }

    public User findUserById(Long id) {
        return entityManager.find(User.class, id);
    }
}
```

### 3. 使用 EntityManager 进行 CRUD 操作

以下是一些常见的 `EntityManager` 操作示例：

- **保存实体**：

```java
User user = new User();
user.setName("John Doe");
user.setEmail("john.doe@example.com");
entityManager.persist(user);
```

- **查询实体**：

```java
User user = entityManager.find(User.class, 1L);
```

- **更新实体**：

```java
User user = entityManager.find(User.class, 1L);
user.setName("Jane Doe");
entityManager.merge(user);
```

- **删除实体**：

```java
User user = entityManager.find(User.class, 1L);
entityManager.remove(user);
```

### 4. 使用 JPQL 查询

`EntityManager` 还支持通过 JPQL 执行复杂查询。以下是一个示例：

```java
public List<User> findUsersByName(String name) {
    return entityManager.createQuery("SELECT u FROM User u WHERE u.name = :name", User.class)
                        .setParameter("name", name)
                        .getResultList();
}
```

## 实际案例

假设我们正在开发一个简单的用户管理系统，需要实现以下功能：

1. 添加新用户。
2. 根据用户 ID 查找用户。
3. 更新用户信息。
4. 删除用户。

以下是一个完整的服务类实现：

```java
@Service
public class UserService {

    @PersistenceContext
    private EntityManager entityManager;

    public User addUser(User user) {
        entityManager.persist(user);
        return user;
    }

    public User getUserById(Long id) {
        return entityManager.find(User.class, id);
    }

    public User updateUser(Long id, String newName) {
        User user = entityManager.find(User.class, id);
        if (user != null) {
            user.setName(newName);
            entityManager.merge(user);
        }
        return user;
    }

    public void deleteUser(Long id) {
        User user = entityManager.find(User.class, id);
        if (user != null) {
            entityManager.remove(user);
        }
    }
}
```

## 总结

`EntityManager` 是 Spring ORM 整合中的核心组件，它简化了与数据库的交互，并提供了强大的 CRUD 操作和查询功能。通过 `@PersistenceContext` 注解，开发者可以轻松地将 `EntityManager` 注入到服务类中，从而实现高效的数据访问。

在实际开发中，`EntityManager` 通常与事务管理结合使用，以确保数据的一致性和完整性。通过掌握 `EntityManager` 的使用方法，开发者可以更高效地构建基于 Spring 的应用程序。

## 附加资源

- [Spring Data JPA 官方文档](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [Java Persistence API (JPA) 官方文档](https://jakarta.ee/specifications/persistence/3.0/)
- [Hibernate ORM 官方文档](https://hibernate.org/orm/documentation/)

## 练习

1. 创建一个简单的 Spring Boot 项目，并配置 `EntityManager`。
2. 实现一个服务类，使用 `EntityManager` 完成对用户实体的 CRUD 操作。
3. 尝试使用 JPQL 查询所有用户，并按姓名排序。