---
title: Spring 方法级安全
description: 了解如何在 Spring 应用程序中使用方法级安全来控制对特定方法的访问权限。
---

# Spring 方法级安全

在构建安全的 Spring 应用程序时，除了保护 URL 端点外，还需要确保某些方法只能由具有特定权限的用户调用。Spring Security 提供了**方法级安全**功能，允许开发者在方法级别上定义访问控制规则。本文将详细介绍如何在 Spring 应用程序中实现方法级安全。

## 什么是方法级安全？

方法级安全是 Spring Security 提供的一种机制，允许开发者通过注解或配置来限制对特定方法的访问。通过这种方式，您可以确保只有具有特定角色或权限的用户才能调用某些方法。

## 启用方法级安全

要在 Spring 应用程序中启用方法级安全，首先需要在配置类中添加 `@EnableMethodSecurity` 注解。这个注解会启用 Spring Security 的方法级安全功能。

```java
@Configuration
@EnableMethodSecurity
public class SecurityConfig {
    // 其他安全配置
}
```

:::note
在 Spring Security 5.7 及以上版本中，推荐使用 `@EnableMethodSecurity` 注解。如果您使用的是旧版本，可以使用 `@EnableGlobalMethodSecurity` 注解。
:::

## 使用 `@PreAuthorize` 注解

`@PreAuthorize` 是 Spring Security 提供的一个常用注解，用于在方法执行前检查用户的权限。您可以在方法上添加此注解，并指定一个 SpEL（Spring Expression Language）表达式来定义访问规则。

```java
@Service
public class UserService {

    @PreAuthorize("hasRole('ADMIN')")
    public void deleteUser(Long userId) {
        // 删除用户的逻辑
    }
}
```

在上面的示例中，`deleteUser` 方法只能由具有 `ADMIN` 角色的用户调用。如果当前用户没有 `ADMIN` 角色，Spring Security 将抛出 `AccessDeniedException`。

## 使用 `@PostAuthorize` 注解

`@PostAuthorize` 注解与 `@PreAuthorize` 类似，但它是在方法执行后检查权限。这在需要根据方法返回值来决定是否允许访问时非常有用。

```java
@Service
public class UserService {

    @PostAuthorize("returnObject.owner == authentication.name")
    public User getUser(Long userId) {
        // 获取用户的逻辑
        return userRepository.findById(userId).orElseThrow();
    }
}
```

在这个示例中，`getUser` 方法只有在返回的 `User` 对象的 `owner` 属性与当前认证用户的名称匹配时，才会允许访问。

## 使用 `@Secured` 注解

`@Secured` 是另一个常用的注解，它允许您指定一个角色列表，只有具有这些角色的用户才能调用该方法。

```java
@Service
public class UserService {

    @Secured("ROLE_ADMIN")
    public void updateUser(User user) {
        // 更新用户的逻辑
    }
}
```

:::caution
`@Secured` 注解只支持角色名称，不支持 SpEL 表达式。如果您需要更复杂的权限控制，建议使用 `@PreAuthorize` 或 `@PostAuthorize`。
:::

## 实际应用场景

假设您正在开发一个博客平台，其中包含以下功能：

1. **创建博客**：只有管理员可以创建博客。
2. **删除博客**：只有博客的作者或管理员可以删除博客。
3. **查看博客**：所有用户都可以查看博客，但只有博客的作者可以查看未发布的博客。

以下是实现这些功能的代码示例：

```java
@Service
public class BlogService {

    @PreAuthorize("hasRole('ADMIN')")
    public void createBlog(Blog blog) {
        // 创建博客的逻辑
    }

    @PreAuthorize("hasRole('ADMIN') or #blog.author == authentication.name")
    public void deleteBlog(Blog blog) {
        // 删除博客的逻辑
    }

    @PostAuthorize("returnObject.published or returnObject.author == authentication.name")
    public Blog getBlog(Long blogId) {
        // 获取博客的逻辑
        return blogRepository.findById(blogId).orElseThrow();
    }
}
```

在这个示例中，`createBlog` 方法只能由管理员调用，`deleteBlog` 方法可以由管理员或博客的作者调用，而 `getBlog` 方法允许所有用户查看已发布的博客，但只有博客的作者可以查看未发布的博客。

## 总结

Spring 方法级安全提供了一种灵活的方式来控制对应用程序中特定方法的访问。通过使用 `@PreAuthorize`、`@PostAuthorize` 和 `@Secured` 等注解，您可以轻松地定义复杂的权限规则，确保只有具有适当权限的用户才能调用某些方法。

## 附加资源

- [Spring Security 官方文档](https://docs.spring.io/spring-security/reference/index.html)
- [Spring Expression Language (SpEL) 参考](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#expressions)

## 练习

1. 在您的 Spring 应用程序中启用方法级安全，并尝试使用 `@PreAuthorize` 和 `@PostAuthorize` 注解。
2. 创建一个服务类，其中包含多个方法，并使用不同的注解来限制对这些方法的访问。
3. 尝试使用 SpEL 表达式来实现更复杂的权限控制。

通过完成这些练习，您将更好地理解 Spring 方法级安全的工作原理，并能够在实际项目中应用这些知识。