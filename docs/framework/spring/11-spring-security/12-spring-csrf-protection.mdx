---
title: Spring CSRF防护
description: 了解Spring Security中的CSRF防护机制，学习如何保护Web应用免受跨站请求伪造攻击。
---

# Spring CSRF防护

跨站请求伪造（CSRF）是一种常见的Web安全漏洞，攻击者通过伪造用户的请求来执行未经授权的操作。Spring Security提供了内置的CSRF防护机制，帮助开发者轻松保护Web应用免受此类攻击。

## 什么是CSRF攻击？

CSRF攻击利用了Web应用对用户浏览器的信任。攻击者通过诱使用户点击恶意链接或访问恶意网站，伪造用户的请求，从而在用户不知情的情况下执行某些操作。例如，攻击者可以伪造一个转账请求，导致用户在不知情的情况下将资金转移到攻击者的账户。

## Spring Security中的CSRF防护

Spring Security默认启用了CSRF防护机制。它通过在每个表单中添加一个CSRF令牌（token）来验证请求的合法性。只有携带有效CSRF令牌的请求才会被处理，否则请求将被拒绝。

### 如何启用CSRF防护

在Spring Security中，CSRF防护默认是启用的。如果你需要自定义CSRF防护，可以通过配置`HttpSecurity`来实现：

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
        .csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
        .and()
        .authorizeRequests()
        .anyRequest().authenticated();
}
```

在上面的代码中，我们使用了`CookieCsrfTokenRepository`来存储CSRF令牌，并将其设置为`HttpOnly`为`false`，以便前端JavaScript可以访问该令牌。

### CSRF令牌的工作原理

当用户访问一个受保护的页面时，Spring Security会生成一个唯一的CSRF令牌，并将其嵌入到表单中。当用户提交表单时，该令牌会随请求一起发送到服务器。服务器会验证该令牌的有效性，如果令牌无效或缺失，请求将被拒绝。

```html
<form action="/transfer" method="post">
    <input type="hidden" name="_csrf" value="your-csrf-token-here" />
    <input type="text" name="amount" />
    <button type="submit">Transfer</button>
</form>
```

在上面的HTML代码中，`_csrf`字段包含了CSRF令牌，该令牌由Spring Security自动生成并嵌入到表单中。

### 实际应用场景

假设你正在开发一个在线银行应用，用户可以通过该应用进行转账操作。为了防止CSRF攻击，你需要在每个转账表单中添加CSRF令牌。以下是一个简单的转账表单示例：

```html
<form action="/transfer" method="post">
    <input type="hidden" name="_csrf" value="your-csrf-token-here" />
    <label for="amount">Amount:</label>
    <input type="text" id="amount" name="amount" />
    <button type="submit">Transfer</button>
</form>
```

当用户提交表单时，Spring Security会验证`_csrf`字段中的令牌。如果令牌有效，请求将被处理；否则，请求将被拒绝。

### 禁用CSRF防护

在某些情况下，你可能需要禁用CSRF防护。例如，如果你正在开发一个无状态的REST API，CSRF防护可能不适用。你可以通过以下方式禁用CSRF防护：

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
        .csrf().disable()
        .authorizeRequests()
        .anyRequest().authenticated();
}
```

:::caution
禁用CSRF防护可能会使你的应用暴露于CSRF攻击的风险中。请确保在禁用CSRF防护之前，你已经采取了其他安全措施来保护你的应用。
:::

## 总结

CSRF防护是Web应用安全的重要组成部分。Spring Security提供了内置的CSRF防护机制，帮助开发者轻松保护应用免受CSRF攻击。通过理解CSRF攻击的原理以及Spring Security的CSRF防护机制，你可以更好地保护你的Web应用。

### 附加资源

- [Spring Security官方文档](https://docs.spring.io/spring-security/reference/features/exploits/csrf.html)
- [OWASP CSRF防护指南](https://owasp.org/www-community/attacks/csrf)

### 练习

1. 创建一个简单的Spring Boot应用，并启用CSRF防护。尝试提交一个不包含CSRF令牌的表单，观察Spring Security如何处理该请求。
2. 修改你的应用，禁用CSRF防护，并尝试模拟一个CSRF攻击。观察应用的行为。