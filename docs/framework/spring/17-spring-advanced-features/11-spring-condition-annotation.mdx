---
title: Spring 条件注解
description: 了解Spring条件注解的基本概念、使用场景以及如何通过条件注解实现动态Bean加载。
---

# Spring 条件注解

## 介绍

在Spring框架中，条件注解（Conditional Annotations）是一种强大的机制，允许开发者根据特定条件来决定是否加载某个Bean或配置类。通过条件注解，你可以根据环境变量、系统属性、类路径中的类是否存在等条件，动态地控制Spring容器的行为。

条件注解的核心是`@Conditional`注解，它可以与其他注解（如`@Bean`、`@Configuration`等）结合使用，以实现灵活的Bean加载策略。

## 基本用法

### 1. `@Conditional`注解

`@Conditional`注解是Spring条件注解的基础。它接受一个或多个实现了`Condition`接口的类作为参数。`Condition`接口定义了一个`matches`方法，用于判断是否满足条件。

```java
@Configuration
public class AppConfig {

    @Bean
    @Conditional(MyCondition.class)
    public MyBean myBean() {
        return new MyBean();
    }
}
```

在上面的代码中，`MyBean`只有在`MyCondition`的`matches`方法返回`true`时才会被加载。

### 2. 实现`Condition`接口

要实现一个自定义的条件类，你需要实现`Condition`接口，并重写`matches`方法。

```java
public class MyCondition implements Condition {

    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        // 判断条件是否满足
        return true; // 返回true表示条件满足，false表示不满足
    }
}
```

在`matches`方法中，你可以通过`ConditionContext`和`AnnotatedTypeMetadata`获取上下文信息，并根据这些信息来决定是否满足条件。

## 实际案例

### 案例1：根据环境变量加载Bean

假设你有一个应用，需要在不同的环境中加载不同的Bean。例如，在开发环境中加载`DevDataSource`，在生产环境中加载`ProdDataSource`。

```java
public class DevDataSourceCondition implements Condition {

    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        String env = System.getProperty("env");
        return "dev".equals(env);
    }
}

public class ProdDataSourceCondition implements Condition {

    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        String env = System.getProperty("env");
        return "prod".equals(env);
    }
}

@Configuration
public class DataSourceConfig {

    @Bean
    @Conditional(DevDataSourceCondition.class)
    public DataSource devDataSource() {
        return new DevDataSource();
    }

    @Bean
    @Conditional(ProdDataSourceCondition.class)
    public DataSource prodDataSource() {
        return new ProdDataSource();
    }
}
```

在这个例子中，`devDataSource`和`prodDataSource`会根据系统属性`env`的值来决定是否加载。

### 案例2：根据类路径中的类是否存在加载Bean

有时候，你可能需要根据类路径中是否存在某个类来决定是否加载某个Bean。例如，只有在类路径中存在`com.example.SpecialClass`时，才加载`SpecialBean`。

```java
public class SpecialClassCondition implements Condition {

    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return ClassUtils.isPresent("com.example.SpecialClass", context.getClassLoader());
    }
}

@Configuration
public class SpecialConfig {

    @Bean
    @Conditional(SpecialClassCondition.class)
    public SpecialBean specialBean() {
        return new SpecialBean();
    }
}
```

在这个例子中，`specialBean`只有在类路径中存在`com.example.SpecialClass`时才会被加载。

## 总结

Spring条件注解提供了一种灵活的方式来控制Bean的加载行为。通过`@Conditional`注解和自定义的`Condition`实现，你可以根据环境变量、系统属性、类路径中的类是否存在等条件，动态地决定是否加载某个Bean或配置类。

条件注解在复杂的应用场景中非常有用，尤其是在需要根据不同的环境或配置来加载不同的Bean时。

## 附加资源

- [Spring官方文档 - Conditional Beans](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-java-conditional)
- [Spring Boot Conditional Annotations](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.developing-auto-configuration.conditional-annotations)

## 练习

1. 尝试实现一个条件注解，根据系统属性`mode`的值（`test`或`production`）来决定加载不同的Bean。
2. 编写一个条件类，检查类路径中是否存在某个特定的类，并根据结果加载不同的Bean。

通过练习，你将更好地理解Spring条件注解的使用场景和实现方式。