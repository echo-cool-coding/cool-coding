---
title: Spring WebSocket
description: 了解如何使用 Spring WebSocket 实现实时双向通信，适合初学者入门。
---

# Spring WebSocket

在现代 Web 应用中，实时通信变得越来越重要。无论是聊天应用、实时通知还是在线游戏，都需要服务器和客户端之间能够实时交换数据。Spring WebSocket 是 Spring 框架提供的一种技术，用于实现基于 WebSocket 协议的双向通信。

## 什么是 WebSocket？

WebSocket 是一种网络通信协议，允许在单个 TCP 连接上进行全双工通信。与传统的 HTTP 请求-响应模式不同，WebSocket 允许服务器主动向客户端推送数据，从而实现实时通信。

## Spring WebSocket 的核心概念

在 Spring 中，WebSocket 的实现主要依赖于以下几个核心组件：

1. **WebSocketHandler**：处理 WebSocket 消息的核心接口。
2. **WebSocketConfigurer**：用于配置 WebSocket 端点。
3. **STOMP**：一种简单的消息传递协议，通常与 WebSocket 一起使用。

### 1. WebSocketHandler

`WebSocketHandler` 是 Spring WebSocket 的核心接口，用于处理 WebSocket 消息。你可以通过实现这个接口来处理连接、消息、错误和关闭事件。

```java
import org.springframework.web.socket.TextMessage;
import org.springframework.web.socket.WebSocketSession;
import org.springframework.web.socket.handler.TextWebSocketHandler;

public class MyWebSocketHandler extends TextWebSocketHandler {

    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        String payload = message.getPayload();
        session.sendMessage(new TextMessage("Echo: " + payload));
    }
}
```

### 2. WebSocketConfigurer

`WebSocketConfigurer` 用于配置 WebSocket 端点。你可以通过实现这个接口来注册 WebSocket 处理器。

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.socket.config.annotation.EnableWebSocket;
import org.springframework.web.socket.config.annotation.WebSocketConfigurer;
import org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;

@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(new MyWebSocketHandler(), "/ws");
    }
}
```

### 3. STOMP

STOMP（Simple Text Oriented Messaging Protocol）是一种简单的消息传递协议，通常与 WebSocket 一起使用。它定义了一种消息格式，使得客户端和服务器之间的通信更加简单。

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketStompConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic");
        config.setApplicationDestinationPrefixes("/app");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/stomp").withSockJS();
    }
}
```

## 实际案例：实时聊天应用

让我们通过一个简单的实时聊天应用来展示 Spring WebSocket 的实际应用场景。

### 1. 前端代码

```html
<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script>
        var stompClient = null;

        function connect() {
            var socket = new SockJS('/stomp');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/messages', function (message) {
                    showMessage(JSON.parse(message.body).content);
                });
            });
        }

        function sendMessage() {
            var message = document.getElementById('message').value;
            stompClient.send("/app/chat", {}, JSON.stringify({'content': message}));
        }

        function showMessage(message) {
            var chat = document.getElementById('chat');
            var p = document.createElement('p');
            p.appendChild(document.createTextNode(message));
            chat.appendChild(p);
        }
    </script>
</head>
<body onload="connect()">
    <div id="chat"></div>
    <input type="text" id="message" />
    <button onclick="sendMessage()">Send</button>
</body>
</html>
```

### 2. 后端代码

```java
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.SendTo;
import org.springframework.stereotype.Controller;

@Controller
public class ChatController {

    @MessageMapping("/chat")
    @SendTo("/topic/messages")
    public Message send(Message message) throws Exception {
        return new Message(message.getContent());
    }
}
```

```java
public class Message {
    private String content;

    public Message() {}

    public Message(String content) {
        this.content = content;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }
}
```

## 总结

Spring WebSocket 提供了一种简单而强大的方式来实现实时双向通信。通过 WebSocketHandler、WebSocketConfigurer 和 STOMP，你可以轻松构建实时应用，如聊天应用、实时通知等。

## 附加资源

- [Spring WebSocket 官方文档](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#websocket)
- [STOMP 协议规范](https://stomp.github.io/)

## 练习

1. 尝试扩展上述聊天应用，使其支持多个聊天室。
2. 实现一个简单的在线游戏，使用 WebSocket 进行实时通信。

通过以上内容，你应该对 Spring WebSocket 有了初步的了解。继续探索和实践，你将能够构建更加复杂和功能丰富的实时应用。