---
title: Spring STOMP
description: 了解 Spring STOMP，一种用于在 Spring 应用中实现 WebSocket 通信的协议。本文将从基础概念讲起，逐步深入，帮助初学者掌握 STOMP 的使用。
---

# Spring STOMP

## 介绍

STOMP（Simple Text Oriented Messaging Protocol）是一种简单的文本协议，用于在客户端和服务器之间进行消息传递。它通常与 WebSocket 结合使用，以实现实时、双向的通信。Spring 框架提供了对 STOMP 的支持，使得开发者可以轻松地在 Spring 应用中实现基于 WebSocket 的消息传递。

在本文中，我们将从基础概念讲起，逐步深入，帮助初学者掌握 Spring STOMP 的使用。

## STOMP 基础

STOMP 协议定义了一组简单的命令，如 `CONNECT`、`SEND`、`SUBSCRIBE` 和 `UNSUBSCRIBE`，用于在客户端和服务器之间进行消息传递。STOMP 消息由帧（frame）组成，每个帧包含一个命令、一组可选的头部（headers）和一个可选的正文（body）。

### STOMP 帧示例

以下是一个简单的 STOMP 帧示例：

```
SEND
destination:/app/chat
content-type:text/plain

Hello, World!
```

在这个示例中，`SEND` 是命令，`destination` 和 `content-type` 是头部，`Hello, World!` 是正文。

## Spring STOMP 配置

要在 Spring 应用中使用 STOMP，首先需要配置 WebSocket 和 STOMP。以下是一个简单的配置示例：

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic");
        config.setApplicationDestinationPrefixes("/app");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws").withSockJS();
    }
}
```

在这个配置中，我们启用了简单的消息代理（`/topic`），并设置了应用目的地前缀（`/app`）。我们还注册了一个 STOMP 端点（`/ws`），并启用了 SockJS 支持。

## 客户端连接

在客户端，我们可以使用 JavaScript 和 SockJS 来连接到 STOMP 端点。以下是一个简单的客户端连接示例：

```javascript
var socket = new SockJS('/ws');
var stompClient = Stomp.over(socket);

stompClient.connect({}, function(frame) {
    console.log('Connected: ' + frame);
    stompClient.subscribe('/topic/greetings', function(greeting) {
        console.log('Received: ' + greeting.body);
    });
});
```

在这个示例中，我们首先创建了一个 SockJS 连接，然后使用 STOMP 客户端连接到服务器。连接成功后，我们订阅了 `/topic/greetings` 主题，并定义了一个回调函数来处理接收到的消息。

## 发送消息

在客户端，我们可以使用 `stompClient.send` 方法来发送消息。以下是一个简单的发送消息示例：

```javascript
stompClient.send("/app/chat", {}, JSON.stringify({'name': 'Alice', 'content': 'Hello, World!'}));
```

在这个示例中，我们向 `/app/chat` 目的地发送了一条消息，消息内容是一个包含 `name` 和 `content` 字段的 JSON 对象。

## 服务器端处理

在服务器端，我们可以使用 `@MessageMapping` 注解来处理客户端发送的消息。以下是一个简单的消息处理示例：

```java
@Controller
public class ChatController {

    @MessageMapping("/chat")
    @SendTo("/topic/greetings")
    public Greeting greeting(Message message) throws Exception {
        return new Greeting("Hello, " + message.getName() + "!");
    }
}
```

在这个示例中，我们定义了一个 `ChatController` 类，并使用 `@MessageMapping` 注解来处理 `/chat` 目的地的消息。处理完成后，我们将结果发送到 `/topic/greetings` 主题。

## 实际应用场景

Spring STOMP 可以用于多种实时通信场景，例如：

- **聊天应用**：用户可以通过 WebSocket 实时发送和接收消息。
- **实时通知**：服务器可以向客户端推送实时通知，如新消息提醒、系统更新等。
- **在线协作**：多个用户可以实时协作编辑文档或进行其他协作任务。

## 总结

Spring STOMP 提供了一种简单而强大的方式来实现基于 WebSocket 的实时通信。通过本文的学习，你应该已经掌握了 Spring STOMP 的基础知识，并能够在自己的 Spring 应用中使用 STOMP 实现实时通信。

## 附加资源

- [Spring WebSocket 文档](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#websocket)
- [STOMP 协议规范](https://stomp.github.io/stomp-specification-1.2.html)
- [SockJS 文档](https://github.com/sockjs/sockjs-client)

## 练习

1. 尝试在 Spring 应用中配置一个 STOMP 端点，并使用 JavaScript 客户端连接到该端点。
2. 实现一个简单的聊天应用，用户可以通过 WebSocket 实时发送和接收消息。
3. 扩展聊天应用，使其支持多个聊天室，用户可以选择加入不同的聊天室。

通过完成这些练习，你将进一步巩固对 Spring STOMP 的理解和应用能力。