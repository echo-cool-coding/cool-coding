---
title: Spring 审计
description: 了解 Spring 审计的基本概念、实现方式及其在实际应用中的使用场景。本文适合初学者，包含代码示例和实际案例。
---

# Spring 审计

## 介绍

在开发企业级应用程序时，通常需要记录数据的变更历史，例如谁在什么时候修改了哪些数据。这种功能被称为**审计**（Auditing）。Spring 框架提供了强大的审计功能，帮助开发者轻松实现数据变更的跟踪和记录。

Spring 审计的核心思想是通过注解和接口，自动记录实体的创建时间、修改时间、创建者和修改者等信息。这些信息可以帮助开发者更好地理解数据的生命周期，并在需要时进行追溯。

## Spring 审计的实现

Spring 审计主要通过以下两种方式实现：

1. **基于注解的审计**：使用 `@CreatedDate`、`@LastModifiedDate` 等注解标记字段，Spring 会自动填充这些字段的值。
2. **基于接口的审计**：实现 `AuditorAware` 接口，提供当前用户信息，Spring 会自动将用户信息填充到审计字段中。

### 1. 基于注解的审计

首先，我们需要在实体类中添加审计字段，并使用相应的注解标记这些字段。以下是一个简单的示例：

```java
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import javax.persistence.*;
import java.util.Date;

@Entity
@EntityListeners(AuditingEntityListener.class)
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @CreatedDate
    @Column(name = "created_date")
    private Date createdDate;

    @LastModifiedDate
    @Column(name = "last_modified_date")
    private Date lastModifiedDate;

    // Getters and Setters
}
```

在上面的代码中，`@CreatedDate` 注解标记了 `createdDate` 字段，表示该字段将自动记录实体的创建时间。`@LastModifiedDate` 注解标记了 `lastModifiedDate` 字段，表示该字段将自动记录实体的最后修改时间。

### 2. 基于接口的审计

为了记录创建者和修改者信息，我们需要实现 `AuditorAware` 接口。以下是一个简单的示例：

```java
import org.springframework.data.domain.AuditorAware;
import java.util.Optional;

public class AuditorAwareImpl implements AuditorAware<String> {

    @Override
    public Optional<String> getCurrentAuditor() {
        // 在实际应用中，可以从安全上下文中获取当前用户
        return Optional.of("admin");
    }
}
```

接下来，我们需要在实体类中添加创建者和修改者字段，并使用 `@CreatedBy` 和 `@LastModifiedBy` 注解标记这些字段：

```java
import org.springframework.data.annotation.CreatedBy;
import org.springframework.data.annotation.LastModifiedBy;

@Entity
@EntityListeners(AuditingEntityListener.class)
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @CreatedDate
    @Column(name = "created_date")
    private Date createdDate;

    @LastModifiedDate
    @Column(name = "last_modified_date")
    private Date lastModifiedDate;

    @CreatedBy
    @Column(name = "created_by")
    private String createdBy;

    @LastModifiedBy
    @Column(name = "last_modified_by")
    private String lastModifiedBy;

    // Getters and Setters
}
```

### 启用审计功能

为了启用 Spring 审计功能，我们需要在配置类中添加 `@EnableJpaAuditing` 注解：

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;

@Configuration
@EnableJpaAuditing(auditorAwareRef = "auditorAwareImpl")
public class AuditConfig {
}
```

## 实际案例

假设我们有一个用户管理系统，需要记录用户的创建时间、修改时间、创建者和修改者信息。我们可以使用 Spring 审计功能来实现这一需求。

### 1. 创建用户

当创建一个新用户时，Spring 会自动填充 `createdDate` 和 `createdBy` 字段：

```java
User user = new User();
user.setName("John Doe");
userRepository.save(user);
```

保存后，`createdDate` 字段将自动设置为当前时间，`createdBy` 字段将自动设置为当前用户（例如 "admin"）。

### 2. 修改用户

当修改用户信息时，Spring 会自动更新 `lastModifiedDate` 和 `lastModifiedBy` 字段：

```java
User user = userRepository.findById(1L).orElseThrow();
user.setName("Jane Doe");
userRepository.save(user);
```

保存后，`lastModifiedDate` 字段将自动更新为当前时间，`lastModifiedBy` 字段将自动更新为当前用户。

## 总结

Spring 审计功能为开发者提供了一种简单而强大的方式来跟踪数据的变更历史。通过使用注解和接口，我们可以轻松记录实体的创建时间、修改时间、创建者和修改者等信息。这些信息不仅有助于理解数据的生命周期，还可以在需要时进行追溯。

在实际应用中，Spring 审计功能可以广泛应用于用户管理、订单管理、日志记录等场景。通过合理使用审计功能，我们可以提高应用程序的可维护性和可追溯性。

## 附加资源

- [Spring Data JPA 官方文档](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#auditing)
- [Spring 审计示例代码](https://github.com/spring-projects/spring-data-examples/tree/main/jpa/auditing)

## 练习

1. 在你的项目中实现 Spring 审计功能，记录用户的创建时间和修改时间。
2. 扩展审计功能，记录创建者和修改者信息。
3. 尝试在实际应用中使用审计功能，例如在订单管理系统中记录订单的创建和修改历史。