---
title: Spring 多数据源
description: 了解如何在Spring应用程序中配置和使用多个数据源，以实现对不同数据库的访问。
---

# Spring 多数据源

在现代应用程序中，通常需要同时访问多个数据库。例如，一个应用程序可能需要从一个数据库中读取用户数据，而从另一个数据库中读取产品数据。Spring框架提供了灵活的方式来配置和管理多个数据源，使得开发人员可以轻松地在应用程序中使用多个数据库。

## 什么是多数据源？

多数据源是指在同一个应用程序中配置和使用多个数据库连接。每个数据源都指向一个独立的数据库，应用程序可以根据需要选择使用哪个数据源来执行数据库操作。

## 为什么需要多数据源？

以下是一些常见的场景，可能需要使用多数据源：

1. **数据隔离**：将不同类型的数据存储在不同的数据库中，例如用户数据和日志数据。
2. **读写分离**：将读操作和写操作分配到不同的数据库，以提高性能。
3. **多租户架构**：为每个租户提供独立的数据库，以实现数据隔离和安全性。

## 配置多数据源

在Spring中配置多数据源通常涉及以下几个步骤：

1. **定义多个数据源**：在Spring配置文件中定义多个`DataSource` bean。
2. **配置事务管理器**：为每个数据源配置独立的事务管理器。
3. **使用`@Transactional`注解**：在服务层使用`@Transactional`注解来指定使用哪个数据源。

### 示例：配置两个数据源

以下是一个简单的示例，展示了如何在Spring Boot应用程序中配置两个数据源。

```java
@Configuration
public class DataSourceConfig {

    @Bean(name = "primaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }

    @Bean(name = "secondaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

在`application.properties`文件中，配置两个数据源的连接信息：

```properties
spring.datasource.primary.url=jdbc:mysql://localhost:3306/primary_db
spring.datasource.primary.username=root
spring.datasource.primary.password=root

spring.datasource.secondary.url=jdbc:mysql://localhost:3306/secondary_db
spring.datasource.secondary.username=root
spring.datasource.secondary.password=root
```

### 配置事务管理器

接下来，为每个数据源配置独立的事务管理器：

```java
@Configuration
public class TransactionManagerConfig {

    @Bean(name = "primaryTransactionManager")
    public PlatformTransactionManager primaryTransactionManager(@Qualifier("primaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }

    @Bean(name = "secondaryTransactionManager")
    public PlatformTransactionManager secondaryTransactionManager(@Qualifier("secondaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

### 使用`@Transactional`注解

在服务层，使用`@Transactional`注解来指定使用哪个数据源：

```java
@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional("primaryTransactionManager")
    public User getUserById(Long id) {
        return userRepository.findById(id).orElse(null);
    }
}

@Service
public class ProductService {

    @Autowired
    private ProductRepository productRepository;

    @Transactional("secondaryTransactionManager")
    public Product getProductById(Long id) {
        return productRepository.findById(id).orElse(null);
    }
}
```

## 实际应用场景

假设我们有一个电子商务应用程序，需要从两个不同的数据库中读取数据：一个存储用户信息，另一个存储产品信息。我们可以使用多数据源来实现这一需求。

1. **用户服务**：从`primary_db`数据库中读取用户信息。
2. **产品服务**：从`secondary_db`数据库中读取产品信息。

通过配置多数据源，我们可以轻松地在同一个应用程序中访问这两个数据库，而无需担心数据冲突或性能问题。

## 总结

Spring多数据源配置为开发人员提供了灵活的方式来管理和使用多个数据库。通过定义多个数据源、配置事务管理器以及使用`@Transactional`注解，我们可以轻松地在应用程序中实现多数据源访问。

## 附加资源

- [Spring Data Access Documentation](https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html)
- [Spring Boot Data Source Configuration](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto-data-access)

## 练习

1. 尝试在本地环境中配置两个不同的数据库，并在Spring Boot应用程序中实现多数据源访问。
2. 修改上面的示例代码，使其支持第三个数据源，并在服务层中使用它。