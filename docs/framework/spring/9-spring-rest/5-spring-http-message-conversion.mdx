---
title: Spring HTTP 消息转换
description: 了解 Spring 框架中的 HTTP 消息转换机制，掌握如何将请求和响应数据转换为 Java 对象，以及如何自定义消息转换器。
---

在构建 RESTful Web 服务时，Spring 框架提供了强大的 HTTP 消息转换机制，用于将 HTTP 请求和响应中的数据转换为 Java 对象，反之亦然。本文将详细介绍 Spring 中的 HTTP 消息转换机制，并通过实际案例帮助初学者理解其工作原理和应用场景。

## 什么是 HTTP 消息转换？

HTTP 消息转换是 Spring 框架中的一个核心功能，它负责将 HTTP 请求中的内容（如 JSON、XML 等）转换为 Java 对象，同时将 Java 对象转换为 HTTP 响应中的内容。Spring 通过 `HttpMessageConverter` 接口来实现这一功能，该接口定义了如何读取和写入 HTTP 消息体。

:::note
`HttpMessageConverter` 是 Spring 中用于处理 HTTP 消息转换的核心接口。它支持多种数据格式，如 JSON、XML、文本等。
:::

## Spring 中的默认消息转换器

Spring 提供了多种默认的 `HttpMessageConverter` 实现，用于处理常见的 HTTP 消息格式。以下是一些常用的默认转换器：

- `MappingJackson2HttpMessageConverter`：用于处理 JSON 格式的数据。
- `Jaxb2RootElementHttpMessageConverter`：用于处理 XML 格式的数据。
- `StringHttpMessageConverter`：用于处理纯文本数据。

这些转换器会根据请求的 `Content-Type` 和 `Accept` 头自动选择合适的转换器来处理数据。

## 如何使用 HTTP 消息转换器？

在 Spring 中，HTTP 消息转换器通常与 `@RequestBody` 和 `@ResponseBody` 注解一起使用。以下是一个简单的示例，展示了如何使用这些注解来处理 JSON 数据。

### 示例：处理 JSON 数据

假设我们有一个简单的 `User` 类：

```java
public class User {
    private String name;
    private int age;

    // 省略构造函数、getter 和 setter 方法
}
```

接下来，我们创建一个 REST 控制器来处理用户的创建和获取操作：

```java
@RestController
@RequestMapping("/users")
public class UserController {

    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody User user) {
        // 处理用户创建逻辑
        return ResponseEntity.ok(user);
    }

    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable int id) {
        // 模拟从数据库获取用户
        User user = new User("John Doe", 30);
        return ResponseEntity.ok(user);
    }
}
```

在这个示例中，`@RequestBody` 注解用于将 HTTP 请求体中的 JSON 数据转换为 `User` 对象，而 `@ResponseBody` 注解则用于将 `User` 对象转换为 JSON 数据并返回给客户端。

### 输入和输出示例

假设客户端发送以下 JSON 数据来创建用户：

```json
{
    "name": "Jane Doe",
    "age": 25
}
```

服务器将返回以下响应：

```json
{
    "name": "Jane Doe",
    "age": 25
}
```

## 自定义消息转换器

在某些情况下，默认的消息转换器可能无法满足需求。例如，你可能需要处理自定义的数据格式或对现有的转换器进行扩展。Spring 允许你通过实现 `HttpMessageConverter` 接口来自定义消息转换器。

### 示例：自定义 JSON 转换器

假设我们需要在 JSON 数据中添加一个额外的字段 `createdAt`，表示用户的创建时间。我们可以通过自定义 `MappingJackson2HttpMessageConverter` 来实现这一功能。

首先，创建一个自定义的 `ObjectMapper`：

```java
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.module.SimpleModule;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.databind.SerializerProvider;

import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class CustomObjectMapper extends ObjectMapper {

    public CustomObjectMapper() {
        SimpleModule module = new SimpleModule();
        module.addSerializer(LocalDateTime.class, new JsonSerializer<LocalDateTime>() {
            @Override
            public void serialize(LocalDateTime value, JsonGenerator gen, SerializerProvider serializers) throws IOException {
                gen.writeString(value.format(DateTimeFormatter.ISO_LOCAL_DATE_TIME));
            }
        });
        this.registerModule(module);
    }
}
```

接下来，创建一个自定义的 `MappingJackson2HttpMessageConverter`：

```java
import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;

public class CustomMappingJackson2HttpMessageConverter extends MappingJackson2HttpMessageConverter {

    public CustomMappingJackson2HttpMessageConverter() {
        super(new CustomObjectMapper());
    }
}
```

最后，在 Spring 配置中注册自定义的转换器：

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.http.converter.HttpMessageConverter;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import java.util.List;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
        converters.add(new CustomMappingJackson2HttpMessageConverter());
    }
}
```

现在，当服务器返回 `User` 对象时，JSON 数据中将包含 `createdAt` 字段。

## 实际应用场景

HTTP 消息转换在实际开发中有广泛的应用场景。以下是一些常见的应用场景：

1. **处理多种数据格式**：如果你的 REST API 需要支持多种数据格式（如 JSON、XML），可以通过配置多个消息转换器来实现。
2. **数据验证和转换**：在将 HTTP 请求数据转换为 Java 对象时，可以使用消息转换器对数据进行验证和转换。
3. **自定义数据格式**：如果你需要处理自定义的数据格式，可以通过实现自定义的消息转换器来实现。

## 总结

Spring 的 HTTP 消息转换机制为处理 RESTful Web 服务中的请求和响应数据提供了强大的支持。通过使用默认的消息转换器或自定义转换器，你可以轻松地将 HTTP 消息体转换为 Java 对象，反之亦然。本文通过示例和实际应用场景，帮助初学者理解并掌握这一重要概念。

## 附加资源

- [Spring 官方文档 - HTTP Message Conversion](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-message-converters)
- [Jackson JSON Processor](https://github.com/FasterXML/jackson)
- [Spring Boot REST API 教程](https://spring.io/guides/gs/rest-service/)

## 练习

1. 创建一个 Spring Boot 项目，并实现一个简单的 REST API，使用 `@RequestBody` 和 `@ResponseBody` 注解处理 JSON 数据。
2. 尝试自定义一个消息转换器，使其能够处理 XML 格式的数据。
3. 扩展 `User` 类，添加更多的字段，并确保这些字段能够正确地通过 HTTP 消息转换器进行序列化和反序列化。