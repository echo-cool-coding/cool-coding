---
title: Spring 消息转换
description: 了解 Spring MVC 中的消息转换机制，掌握如何将 HTTP 请求和响应数据转换为 Java 对象，以及如何自定义消息转换器。
---

# Spring 消息转换

在 Spring MVC 中，消息转换（Message Conversion）是一个核心概念，它负责将 HTTP 请求中的数据转换为 Java 对象，以及将 Java 对象转换为 HTTP 响应的数据。Spring 提供了多种内置的消息转换器，例如 `MappingJackson2HttpMessageConverter`、`StringHttpMessageConverter` 等，用于处理 JSON、XML、文本等格式的数据。

## 什么是消息转换？

消息转换是 Spring MVC 处理 HTTP 请求和响应时的一个重要步骤。当客户端发送一个 HTTP 请求时，Spring MVC 需要将请求体中的数据（如 JSON 或 XML）转换为 Java 对象，以便在控制器中进行处理。同样地，当控制器返回一个 Java 对象时，Spring MVC 需要将其转换为客户端期望的格式（如 JSON 或 XML）并发送回客户端。

Spring 通过 `HttpMessageConverter` 接口来实现这一功能。每个消息转换器都负责处理特定类型的数据格式。

## 内置消息转换器

Spring MVC 默认提供了多种消息转换器，以下是一些常用的内置转换器：

- `MappingJackson2HttpMessageConverter`：处理 JSON 格式的数据。
- `StringHttpMessageConverter`：处理纯文本格式的数据。
- `ByteArrayHttpMessageConverter`：处理字节数组格式的数据。
- `FormHttpMessageConverter`：处理表单数据。

这些转换器会根据请求的 `Content-Type` 和 `Accept` 头信息自动选择合适的转换器。

## 如何使用消息转换器？

在 Spring MVC 中，消息转换器通常与 `@RequestBody` 和 `@ResponseBody` 注解一起使用。以下是一个简单的示例：

```java
@RestController
public class UserController {

    @PostMapping("/users")
    public User createUser(@RequestBody User user) {
        // 处理用户创建逻辑
        return user;
    }

    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // 根据 ID 获取用户
        return new User(id, "John Doe");
    }
}
```

在这个示例中，`@RequestBody` 注解告诉 Spring MVC 将请求体中的 JSON 数据转换为 `User` 对象，而 `@ResponseBody` 注解则告诉 Spring MVC 将返回的 `User` 对象转换为 JSON 数据并发送回客户端。

## 自定义消息转换器

虽然 Spring 提供了多种内置的消息转换器，但在某些情况下，你可能需要自定义消息转换器。例如，你可能需要处理一种特殊的数据格式，或者对现有的转换器进行一些定制。

以下是一个自定义消息转换器的示例：

```java
public class CustomMessageConverter extends AbstractHttpMessageConverter<CustomData> {

    public CustomMessageConverter() {
        super(new MediaType("application", "custom"));
    }

    @Override
    protected boolean supports(Class<?> clazz) {
        return CustomData.class.isAssignableFrom(clazz);
    }

    @Override
    protected CustomData readInternal(Class<? extends CustomData> clazz, HttpInputMessage inputMessage)
            throws IOException, HttpMessageNotReadableException {
        // 实现自定义的读取逻辑
        return new CustomData();
    }

    @Override
    protected void writeInternal(CustomData customData, HttpOutputMessage outputMessage)
            throws IOException, HttpMessageNotWritableException {
        // 实现自定义的写入逻辑
    }
}
```

然后，你需要在 Spring 配置中注册这个自定义转换器：

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        converters.add(new CustomMessageConverter());
    }
}
```

## 实际应用场景

假设你正在开发一个 RESTful API，客户端需要发送和接收一种自定义的二进制数据格式。你可以通过自定义消息转换器来处理这种数据格式，而不需要修改现有的控制器逻辑。

```java
@RestController
public class DataController {

    @PostMapping("/data")
    public CustomData processData(@RequestBody CustomData data) {
        // 处理自定义数据
        return data;
    }
}
```

在这个示例中，`CustomData` 是一个自定义的 Java 对象，`CustomMessageConverter` 负责将其转换为二进制格式并返回给客户端。

## 总结

Spring MVC 的消息转换机制使得处理 HTTP 请求和响应变得非常简单和灵活。通过内置的消息转换器，你可以轻松地处理 JSON、XML、文本等格式的数据。如果需要处理特殊的数据格式，你还可以自定义消息转换器。

## 附加资源

- [Spring 官方文档 - HttpMessageConverter](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-message-converters)
- [Spring MVC 教程](https://www.baeldung.com/spring-mvc-tutorial)

## 练习

1. 创建一个简单的 Spring Boot 项目，并实现一个 RESTful API，使用 `@RequestBody` 和 `@ResponseBody` 注解处理 JSON 数据。
2. 尝试自定义一个消息转换器，用于处理 XML 格式的数据，并将其注册到 Spring 配置中。
