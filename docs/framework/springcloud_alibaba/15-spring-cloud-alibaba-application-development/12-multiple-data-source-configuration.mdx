---
title: 多数据源配置
description: 学习如何在 Spring Cloud Alibaba 应用中配置和管理多个数据源，以满足复杂业务场景的需求。
---

# 多数据源配置

在现代企业级应用中，单一数据源往往无法满足复杂的业务需求。例如，一个应用可能需要同时连接多个数据库，或者根据业务逻辑动态切换数据源。Spring Cloud Alibaba 提供了强大的支持，使得多数据源配置变得简单而高效。

## 什么是多数据源配置？

多数据源配置是指在同一个应用中，配置和管理多个数据库连接。每个数据源可以连接到不同的数据库实例，或者连接到同一个数据库的不同模式。通过多数据源配置，开发者可以根据业务需求灵活地切换数据源，从而实现更复杂的业务逻辑。

## 为什么需要多数据源配置？

1. **业务分离**：不同的业务模块可能需要访问不同的数据库。
2. **读写分离**：为了提高性能，可以将读操作和写操作分配到不同的数据库实例。
3. **数据隔离**：某些业务场景需要严格的数据隔离，多数据源配置可以满足这一需求。

## 多数据源配置的基本步骤

### 1. 添加依赖

首先，确保你的项目中已经添加了 Spring Boot 和 Spring Cloud Alibaba 的相关依赖。你需要在 `pom.xml` 中添加以下依赖：

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

### 2. 配置数据源

在 `application.yml` 中配置多个数据源。例如：

```yaml
spring:
  datasource:
    primary:
      url: jdbc:mysql://localhost:3306/primary_db
      username: root
      password: root
      driver-class-name: com.mysql.cj.jdbc.Driver
    secondary:
      url: jdbc:mysql://localhost:3306/secondary_db
      username: root
      password: root
      driver-class-name: com.mysql.cj.jdbc.Driver
```

### 3. 创建数据源配置类

接下来，创建两个数据源的配置类，分别用于配置主数据源和次数据源。

```java
@Configuration
public class DataSourceConfig {

    @Bean(name = "primaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }

    @Bean(name = "secondaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

### 4. 配置事务管理器

为了确保事务的正确管理，你需要为每个数据源配置一个事务管理器。

```java
@Configuration
@EnableTransactionManagement
public class TransactionManagerConfig {

    @Bean(name = "primaryTransactionManager")
    public PlatformTransactionManager primaryTransactionManager(@Qualifier("primaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }

    @Bean(name = "secondaryTransactionManager")
    public PlatformTransactionManager secondaryTransactionManager(@Qualifier("secondaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

### 5. 使用数据源

在服务层中，你可以通过 `@Qualifier` 注解来指定使用哪个数据源。

```java
@Service
public class UserService {

    @Autowired
    @Qualifier("primaryDataSource")
    private DataSource primaryDataSource;

    @Autowired
    @Qualifier("secondaryDataSource")
    private DataSource secondaryDataSource;

    public void saveUser(User user) {
        // 使用主数据源保存用户
        JdbcTemplate jdbcTemplate = new JdbcTemplate(primaryDataSource);
        jdbcTemplate.update("INSERT INTO users (name, email) VALUES (?, ?)", user.getName(), user.getEmail());
    }

    public void saveLog(Log log) {
        // 使用次数据源保存日志
        JdbcTemplate jdbcTemplate = new JdbcTemplate(secondaryDataSource);
        jdbcTemplate.update("INSERT INTO logs (message) VALUES (?)", log.getMessage());
    }
}
```

## 实际案例：电商系统中的多数据源配置

假设你正在开发一个电商系统，其中用户数据和订单数据存储在不同的数据库中。你可以通过多数据源配置来实现这一需求。

1. **用户数据**：存储在 `user_db` 中，使用主数据源。
2. **订单数据**：存储在 `order_db` 中，使用次数据源。

通过上述配置，你可以在用户服务中使用主数据源，而在订单服务中使用次数据源，从而实现数据的分离和管理。

## 总结

多数据源配置是 Spring Cloud Alibaba 应用开发中的一个重要概念，它允许你在同一个应用中连接和管理多个数据库。通过合理的配置，你可以实现业务分离、读写分离和数据隔离等复杂需求。

## 附加资源

- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)
- [Spring Cloud Alibaba 官方文档](https://github.com/alibaba/spring-cloud-alibaba)
- [MySQL 官方文档](https://dev.mysql.com/doc/)

## 练习

1. 尝试在你的项目中配置两个数据源，并分别进行读写操作。
2. 思考如何在多数据源配置中实现动态数据源切换。

:::tip
在实际开发中，多数据源配置可能会带来一些复杂性，因此在设计系统时要充分考虑业务需求和性能要求。
:::