---
title: Stream消息转换器
description: 了解如何在Spring Cloud Stream中使用消息转换器，将消息从一种格式转换为另一种格式，以满足不同系统的需求。
---

# Stream消息转换器

在Spring Cloud Stream中，消息转换器（Message Converter）是一个非常重要的组件，它负责将消息从一种格式转换为另一种格式。例如，你可能需要将JSON格式的消息转换为Java对象，或者将Java对象转换为XML格式的消息。消息转换器使得不同系统之间的通信更加灵活和高效。

## 什么是消息转换器？

消息转换器是Spring Cloud Stream中的一个核心概念，它允许你在消息传递过程中对消息进行格式转换。Spring Cloud Stream默认提供了多种消息转换器，例如JSON、XML、Avro等。你也可以根据需要自定义消息转换器。

### 为什么需要消息转换器？

在实际应用中，不同的系统可能使用不同的消息格式。例如，一个系统可能使用JSON格式发送消息，而另一个系统可能期望接收XML格式的消息。消息转换器的作用就是在这两个系统之间进行消息格式的转换，以确保消息能够被正确解析和处理。

## 使用默认的消息转换器

Spring Cloud Stream默认提供了多种消息转换器，其中最常用的是JSON消息转换器。以下是一个简单的示例，展示了如何使用默认的JSON消息转换器。

### 示例：使用JSON消息转换器

假设我们有一个简单的Java对象 `User`：

```java
public class User {
    private String name;
    private int age;

    // 省略构造函数、getter和setter
}
```

在Spring Cloud Stream中，你可以通过以下方式发送和接收 `User` 对象：

```java
@EnableBinding(Processor.class)
public class UserProcessor {

    @StreamListener(Processor.INPUT)
    public void handleUser(User user) {
        System.out.println("Received user: " + user.getName() + ", age: " + user.getAge());
    }

    @Bean
    public MessageChannel output() {
        return new DirectChannel();
    }
}
```

在这个示例中，Spring Cloud Stream会自动将接收到的JSON消息转换为 `User` 对象，并将 `User` 对象转换为JSON消息发送出去。

## 自定义消息转换器

如果你需要处理默认消息转换器不支持的消息格式，你可以自定义消息转换器。以下是一个自定义消息转换器的示例。

### 示例：自定义XML消息转换器

假设我们需要处理XML格式的消息，我们可以创建一个自定义的XML消息转换器：

```java
public class XmlMessageConverter extends AbstractMessageConverter {

    public XmlMessageConverter() {
        super(new MimeType("application", "xml"));
    }

    @Override
    protected boolean supports(Class<?> clazz) {
        return User.class.isAssignableFrom(clazz);
    }

    @Override
    protected Object convertFromInternal(Message<?> message, Class<?> targetClass, Object conversionHint) {
        try {
            JAXBContext context = JAXBContext.newInstance(User.class);
            Unmarshaller unmarshaller = context.createUnmarshaller();
            return unmarshaller.unmarshal(new StringReader((String) message.getPayload()));
        } catch (Exception e) {
            throw new MessageConversionException("Failed to convert message to XML", e);
        }
    }

    @Override
    protected Object convertToInternal(Object payload, MessageHeaders headers, Object conversionHint) {
        try {
            JAXBContext context = JAXBContext.newInstance(User.class);
            Marshaller marshaller = context.createMarshaller();
            StringWriter writer = new StringWriter();
            marshaller.marshal(payload, writer);
            return writer.toString();
        } catch (Exception e) {
            throw new MessageConversionException("Failed to convert XML to message", e);
        }
    }
}
```

然后，你需要在Spring Cloud Stream中注册这个自定义的消息转换器：

```java
@Bean
public XmlMessageConverter xmlMessageConverter() {
    return new XmlMessageConverter();
}
```

## 实际应用场景

消息转换器在实际应用中有很多场景。例如：

1. **跨系统通信**：不同系统可能使用不同的消息格式，消息转换器可以确保消息在不同系统之间正确传递。
2. **数据格式升级**：当系统升级时，可能需要将旧的消息格式转换为新的格式，消息转换器可以帮助你实现这一点。
3. **协议适配**：在某些情况下，你可能需要将消息从一种协议转换为另一种协议，消息转换器可以帮助你实现这种适配。

## 总结

消息转换器是Spring Cloud Stream中一个非常重要的组件，它允许你在消息传递过程中对消息进行格式转换。通过使用默认的消息转换器或自定义消息转换器，你可以轻松地处理不同格式的消息，确保系统之间的通信顺畅。

## 附加资源

- [Spring Cloud Stream官方文档](https://spring.io/projects/spring-cloud-stream)
- [Spring Cloud Stream消息转换器指南](https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_message_converters)

## 练习

1. 尝试创建一个自定义的消息转换器，将消息从JSON格式转换为CSV格式。
2. 在Spring Cloud Stream中配置多个消息转换器，并测试它们的优先级。
