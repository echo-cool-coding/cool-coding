---
title: Sentinel API 使用
description: 了解如何使用 Sentinel API 实现流量控制，保护您的应用程序免受突发流量的影响。
---

# Sentinel API 使用

Sentinel 是阿里巴巴开源的一款轻量级流量控制组件，广泛应用于微服务架构中，用于保护系统免受突发流量的冲击。通过 Sentinel API，开发者可以灵活地定义流量控制规则，并在应用程序中实现精细化的流量管理。

本文将逐步介绍如何使用 Sentinel API 实现流量控制，并通过实际案例展示其应用场景。

---

## 什么是 Sentinel API？

Sentinel API 是 Sentinel 提供的一组编程接口，允许开发者在代码中直接定义和执行流量控制规则。通过 Sentinel API，您可以：

- 定义资源（Resource）：需要保护的代码块或服务。
- 设置流量控制规则（Flow Rule）：限制资源的访问频率。
- 处理流量控制异常（BlockException）：当流量超过限制时，执行降级或熔断逻辑。

---

## 基本用法

### 1. 引入 Sentinel 依赖

首先，在您的项目中引入 Sentinel 的依赖。以 Maven 项目为例：

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-core</artifactId>
    <version>1.8.6</version>
</dependency>
```

### 2. 定义资源

在 Sentinel 中，资源是需要保护的代码块或服务。您可以使用 `SphU.entry()` 方法定义资源：

```java
import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.slots.block.BlockException;

public class SentinelExample {
    public static void main(String[] args) {
        try (Entry entry = SphU.entry("myResource")) {
            // 被保护的代码逻辑
            System.out.println("Resource accessed successfully");
        } catch (BlockException e) {
            // 处理流量控制异常
            System.out.println("Resource access blocked");
        }
    }
}
```

### 3. 设置流量控制规则

通过 `FlowRuleManager.loadRules()` 方法，您可以定义流量控制规则。例如，限制 `myResource` 的 QPS（每秒查询率）为 10：

```java
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

import java.util.ArrayList;
import java.util.List;

public class FlowRuleExample {
    public static void main(String[] args) {
        List<FlowRule> rules = new ArrayList<>();
        FlowRule rule = new FlowRule();
        rule.setResource("myResource");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(10); // 限制 QPS 为 10
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
    }
}
```

### 4. 处理流量控制异常

当流量超过限制时，Sentinel 会抛出 `BlockException`。您可以在 `catch` 块中处理该异常，例如返回降级结果或记录日志：

```java
try (Entry entry = SphU.entry("myResource")) {
    // 被保护的代码逻辑
} catch (BlockException e) {
    // 返回降级结果
    System.out.println("Service is busy, please try again later");
}
```

---

## 实际案例

### 案例：保护 API 接口

假设您有一个用户查询接口 `/user/{id}`，为了保护该接口不被突发流量打垮，您可以使用 Sentinel 实现流量控制。

1. 定义资源：

```java
@GetMapping("/user/{id}")
public String getUser(@PathVariable String id) {
    try (Entry entry = SphU.entry("getUserResource")) {
        // 查询用户逻辑
        return userService.getUserById(id);
    } catch (BlockException e) {
        // 返回降级结果
        return "Service is busy, please try again later";
    }
}
```

2. 设置流量控制规则：

```java
FlowRule rule = new FlowRule();
rule.setResource("getUserResource");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(100); // 限制 QPS 为 100
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

通过以上配置，当 `/user/{id}` 接口的 QPS 超过 100 时，Sentinel 会自动拦截请求并返回降级结果。

---

## 总结

Sentinel API 提供了一种简单而强大的方式来实现流量控制。通过定义资源、设置流量控制规则以及处理流量控制异常，您可以有效地保护您的应用程序免受突发流量的影响。

:::tip 提示
- 在实际项目中，建议将流量控制规则配置在动态配置中心（如 Nacos、Zookeeper）中，以便实时调整规则。
- Sentinel 还支持熔断降级、系统自适应保护等高级功能，建议进一步探索。
:::

---

## 附加资源

- [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Sentinel GitHub 仓库](https://github.com/alibaba/Sentinel)

---

## 练习

1. 在您的项目中引入 Sentinel，并为一个简单的接口实现流量控制。
2. 尝试使用动态配置中心（如 Nacos）管理流量控制规则。
3. 探索 Sentinel 的熔断降级功能，并实现一个简单的熔断案例。