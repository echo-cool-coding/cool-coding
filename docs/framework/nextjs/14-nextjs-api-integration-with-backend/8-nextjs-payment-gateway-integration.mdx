---
title: Next.js 支付网关集成
description: "学习如何在 Next.js 中集成支付网关，实现安全的在线支付功能。本文将从基础概念到实际应用逐步讲解，适合初学者。"
---

## 介绍

在现代 Web 应用中，支付功能是不可或缺的一部分。无论是电子商务网站还是订阅服务，支付网关的集成都是实现交易的核心。Next.js 作为一个全栈框架，提供了强大的 API 路由功能，使得与支付网关的集成变得简单而高效。

本文将带你了解如何在 Next.js 中集成支付网关，使用 Stripe 作为示例支付服务提供商。我们将从设置 Stripe 账户开始，逐步实现一个完整的支付流程。

## 什么是支付网关？

支付网关是一种技术，用于在客户和商家之间安全地传输支付信息。它充当了客户、商家和银行之间的桥梁，确保交易的安全性和可靠性。

## 准备工作

在开始之前，你需要完成以下准备工作：

1. **注册 Stripe 账户**：访问 [Stripe 官网](https://stripe.com) 并注册一个账户。
2. **获取 API 密钥**：登录 Stripe 仪表板，获取你的 `Publishable Key` 和 `Secret Key`。
3. **安装 Stripe SDK**：在你的 Next.js 项目中安装 Stripe SDK。

```bash
npm install stripe
```

## 创建支付 API 路由

在 Next.js 中，API 路由位于 `pages/api` 目录下。我们将创建一个新的 API 路由来处理支付请求。

1. **创建支付路由**：在 `pages/api` 目录下创建一个新文件 `create-payment-intent.js`。

```javascript
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

export default async function handler(req, res) {
  if (req.method === 'POST') {
    try {
      const { amount } = req.body;

      const paymentIntent = await stripe.paymentIntents.create({
        amount,
        currency: 'usd',
      });

      res.status(200).json({ clientSecret: paymentIntent.client_secret });
    } catch (err) {
      res.status(500).json({ statusCode: 500, message: err.message });
    }
  } else {
    res.setHeader('Allow', 'POST');
    res.status(405).end('Method Not Allowed');
  }
}
```

2. **环境变量配置**：在 `.env.local` 文件中添加 Stripe 的 `Secret Key`。

```plaintext
STRIPE_SECRET_KEY=your_stripe_secret_key
```

## 前端支付表单

接下来，我们将在前端创建一个简单的支付表单，用于收集用户的支付信息。

1. **安装 Stripe.js**：在前端页面中引入 Stripe.js。

```bash
npm install @stripe/stripe-js
```

2. **创建支付表单**：在 `pages/index.js` 中创建一个支付表单。

```javascript
import { loadStripe } from '@stripe/stripe-js';
import { Elements, CardElement, useStripe, useElements } from '@stripe/react-stripe-js';

const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY);

const CheckoutForm = () => {
  const stripe = useStripe();
  const elements = useElements();

  const handleSubmit = async (event) => {
    event.preventDefault();

    if (!stripe || !elements) {
      return;
    }

    const { error, paymentMethod } = await stripe.createPaymentMethod({
      type: 'card',
      card: elements.getElement(CardElement),
    });

    if (error) {
      console.error(error);
    } else {
      const response = await fetch('/api/create-payment-intent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ amount: 1000 }), // 金额以分为单位
      });

      const { clientSecret } = await response.json();

      const { error: confirmError } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: paymentMethod.id,
      });

      if (confirmError) {
        console.error(confirmError);
      } else {
        alert('Payment successful!');
      }
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <CardElement />
      <button type="submit" disabled={!stripe}>
        Pay
      </button>
    </form>
  );
};

export default function Home() {
  return (
    <Elements stripe={stripePromise}>
      <CheckoutForm />
    </Elements>
  );
}
```

## 实际应用场景

假设你正在开发一个在线商店，用户可以选择商品并完成支付。通过集成 Stripe 支付网关，你可以轻松实现以下功能：

1. **商品选择**：用户选择商品并添加到购物车。
2. **支付流程**：用户点击支付按钮，输入信用卡信息并完成支付。
3. **订单确认**：支付成功后，系统生成订单并发送确认邮件。

## 总结

通过本文，你已经学会了如何在 Next.js 中集成 Stripe 支付网关。我们从设置 Stripe 账户开始，逐步实现了支付 API 路由和前端支付表单。希望这些内容能帮助你在实际项目中轻松实现支付功能。

## 附加资源

- [Stripe 官方文档](https://stripe.com/docs)
- [Next.js API 路由文档](https://nextjs.org/docs/api-routes/introduction)
- [Stripe React 组件库](https://stripe.com/docs/stripe-js/react)

## 练习

1. **扩展支付功能**：尝试在支付成功后，将订单信息保存到数据库中。
2. **多货币支持**：修改代码以支持多种货币支付。
3. **错误处理**：增强前端和后端的错误处理机制，提供更友好的用户提示。

:::tip
在实际开发中，务必确保支付信息的安全性，避免敏感信息泄露。
:::