---
title: Next.js tRPC集成
description: "学习如何在 Next.js 项目中集成 tRPC，实现类型安全的 API 调用。本文将从基础概念到实际应用逐步讲解，适合初学者。"
---

## 介绍

在现代 Web 开发中，前后端分离的架构越来越流行。然而，随着项目的复杂性增加，维护前后端之间的 API 契约变得越来越困难。tRPC 是一个强大的工具，它允许你在 TypeScript 项目中实现类型安全的 API 调用，从而减少错误并提高开发效率。

tRPC 的核心思想是通过共享类型定义，确保前端和后端的 API 调用是类型安全的。这意味着你可以在编译时捕获许多潜在的错误，而不是在运行时才发现问题。

在本文中，我们将学习如何在 Next.js 项目中集成 tRPC，并展示如何利用它来构建类型安全的 API。

## 安装与配置

首先，我们需要在 Next.js 项目中安装 tRPC 相关的依赖。你可以使用以下命令来安装这些依赖：

```bash
npm install @trpc/server @trpc/client @trpc/react-query @trpc/next zod
```

接下来，我们需要配置 tRPC 服务器和客户端。我们将创建一个简单的 tRPC 路由，并在 Next.js 项目中集成它。

### 创建 tRPC 路由

首先，在 `pages/api/trpc/[trpc].ts` 文件中创建 tRPC 路由：

```typescript
import { initTRPC } from '@trpc/server';
import { createNextApiHandler } from '@trpc/server/adapters/next';
import { z } from 'zod';

const t = initTRPC.create();

const appRouter = t.router({
  greeting: t.procedure
    .input(z.object({ name: z.string() }))
    .query(({ input }) => {
      return {
        message: `Hello, ${input.name}!`,
      };
    }),
});

export type AppRouter = typeof appRouter;

export default createNextApiHandler({
  router: appRouter,
  createContext: () => ({}),
});
```

在这个例子中，我们定义了一个简单的 `greeting` 查询，它接受一个 `name` 参数并返回一个问候消息。

### 在 Next.js 中集成 tRPC 客户端

接下来，我们需要在 Next.js 项目中配置 tRPC 客户端。在 `utils/trpc.ts` 文件中添加以下代码：

```typescript
import { createTRPCNext } from '@trpc/next';
import { AppRouter } from '../pages/api/trpc/[trpc]';

export const trpc = createTRPCNext<AppRouter>({
  config() {
    return {
      url: '/api/trpc',
    };
  },
});
```

现在，我们可以在 Next.js 页面中使用 tRPC 客户端来调用 API。

## 使用 tRPC 客户端

在 Next.js 页面中，我们可以使用 `trpc` 客户端来调用我们在 tRPC 路由中定义的 `greeting` 查询。以下是一个简单的示例：

```typescript
import { trpc } from '../utils/trpc';

export default function Home() {
  const greeting = trpc.greeting.useQuery({ name: 'World' });

  if (greeting.isLoading) {
    return <div>Loading...</div>;
  }

  if (greeting.error) {
    return <div>Error: {greeting.error.message}</div>;
  }

  return (
    <div>
      <h1>{greeting.data.message}</h1>
    </div>
  );
}
```

在这个例子中，我们使用 `trpc.greeting.useQuery` 来调用 `greeting` 查询，并在页面上显示返回的消息。

## 实际应用场景

tRPC 非常适合用于需要频繁与后端交互的应用程序。例如，在一个社交媒体应用中，你可能需要频繁地获取用户信息、发布帖子、点赞等操作。使用 tRPC，你可以确保这些操作是类型安全的，并且在编译时就能捕获潜在的错误。

### 示例：用户信息查询

假设我们有一个 `user` 查询，它返回用户的基本信息。我们可以这样定义 tRPC 路由：

```typescript
const appRouter = t.router({
  user: t.procedure
    .input(z.object({ userId: z.string() }))
    .query(async ({ input }) => {
      const user = await getUserById(input.userId);
      return user;
    }),
});
```

在 Next.js 页面中，我们可以这样调用这个查询：

```typescript
const user = trpc.user.useQuery({ userId: '123' });
```

通过这种方式，我们可以确保 `userId` 是一个字符串，并且在编译时就能捕获类型错误。

## 总结

tRPC 是一个强大的工具，它可以帮助你在 Next.js 项目中实现类型安全的 API 调用。通过共享类型定义，你可以在编译时捕获许多潜在的错误，从而提高开发效率并减少运行时错误。

在本文中，我们学习了如何在 Next.js 项目中集成 tRPC，并展示了如何利用它来构建类型安全的 API。我们还通过实际案例展示了 tRPC 的应用场景。

## 附加资源与练习

- [tRPC 官方文档](https://trpc.io/docs)
- [Next.js 官方文档](https://nextjs.org/docs)
- 练习：尝试在你的 Next.js 项目中集成 tRPC，并创建一个新的查询来获取用户列表。

:::tip
如果你在集成过程中遇到问题，可以参考 tRPC 的官方文档或在社区中寻求帮助。
:::