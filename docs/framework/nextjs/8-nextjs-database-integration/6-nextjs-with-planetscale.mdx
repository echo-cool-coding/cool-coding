---
title: Next.js 与PlanetScale
description: "学习如何在Next.js项目中集成PlanetScale数据库，掌握从配置到实际应用的全流程。"
---

## 介绍

在现代Web开发中，数据库集成是一个至关重要的环节。Next.js作为一个强大的React框架，提供了灵活的服务器端渲染（SSR）和静态生成（SSG）功能。而PlanetScale则是一个基于MySQL的分布式数据库服务，提供了无与伦比的扩展性和可靠性。将Next.js与PlanetScale结合，可以构建出高性能、可扩展的Web应用。

本文将逐步引导你如何在Next.js项目中集成PlanetScale数据库，并通过实际案例展示其应用场景。

## 配置PlanetScale数据库

### 1. 创建PlanetScale数据库

首先，你需要在PlanetScale上创建一个数据库。登录PlanetScale控制台，点击“Create Database”按钮，填写数据库名称并选择区域。创建完成后，你将获得一个数据库连接字符串。

### 2. 安装依赖

在Next.js项目中，你需要安装`mysql2`库来连接PlanetScale数据库。运行以下命令：

```bash
npm install mysql2
```

### 3. 配置环境变量

为了安全地存储数据库连接信息，建议使用环境变量。在Next.js项目的根目录下创建`.env.local`文件，并添加以下内容：

```bash
DATABASE_URL=mysql://username:password@host/database_name
```

确保将`username`、`password`、`host`和`database_name`替换为实际的PlanetScale数据库连接信息。

## 连接PlanetScale数据库

### 1. 创建数据库连接

在Next.js项目中，创建一个`lib/db.js`文件，用于管理数据库连接：

```javascript
import mysql from 'mysql2/promise';

const connection = await mysql.createConnection(process.env.DATABASE_URL);

export default connection;
```

### 2. 查询数据

接下来，你可以在API路由或页面中使用这个连接来查询数据。例如，创建一个API路由`pages/api/users.js`：

```javascript
import connection from '../../lib/db';

export default async function handler(req, res) {
  const [rows] = await connection.execute('SELECT * FROM users');
  res.status(200).json(rows);
}
```

### 3. 在页面中使用数据

你可以在页面中使用`getServerSideProps`或`getStaticProps`来获取数据并渲染页面。例如：

```javascript
import connection from '../lib/db';

export async function getServerSideProps() {
  const [rows] = await connection.execute('SELECT * FROM users');
  return {
    props: {
      users: rows,
    },
  };
}

export default function Home({ users }) {
  return (
    <div>
      <h1>Users</h1>
      <ul>
        {users.map(user => (
          <li key={user.id}>{user.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

## 实际案例

假设你正在构建一个博客平台，用户可以在平台上发布文章。你可以使用PlanetScale数据库来存储用户信息和文章内容。以下是一个简单的示例：

### 1. 创建数据库表

在PlanetScale控制台中，创建两个表：`users`和`posts`。

```sql
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE
);

CREATE TABLE posts (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  user_id INT,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 2. 插入数据

在Next.js项目中，你可以通过API路由插入数据。例如，创建一个API路由`pages/api/posts.js`：

```javascript
import connection from '../../lib/db';

export default async function handler(req, res) {
  if (req.method === 'POST') {
    const { title, content, userId } = req.body;
    await connection.execute(
      'INSERT INTO posts (title, content, user_id) VALUES (?, ?, ?)',
      [title, content, userId]
    );
    res.status(201).json({ message: 'Post created' });
  } else {
    res.status(405).json({ message: 'Method not allowed' });
  }
}
```

### 3. 显示数据

在页面中，你可以使用`getServerSideProps`获取所有文章并显示：

```javascript
import connection from '../lib/db';

export async function getServerSideProps() {
  const [rows] = await connection.execute('SELECT * FROM posts');
  return {
    props: {
      posts: rows,
    },
  };
}

export default function Home({ posts }) {
  return (
    <div>
      <h1>Posts</h1>
      <ul>
        {posts.map(post => (
          <li key={post.id}>
            <h2>{post.title}</h2>
            <p>{post.content}</p>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

## 总结

通过本文，你已经学会了如何在Next.js项目中集成PlanetScale数据库。我们从配置数据库、连接数据库到实际应用案例，逐步讲解了整个过程。希望这些内容能帮助你在实际项目中更好地使用Next.js和PlanetScale。

## 附加资源

- [PlanetScale官方文档](https://planetscale.com/docs)
- [Next.js官方文档](https://nextjs.org/docs)
- [MySQL2库文档](https://github.com/sidorares/node-mysql2)

## 练习

1. 尝试在PlanetScale中创建一个新的表，并在Next.js项目中实现CRUD操作。
2. 探索如何在Next.js中使用PlanetScale的分支功能，实现数据库的版本控制。

祝你学习愉快！