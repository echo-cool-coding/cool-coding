---
title: Next.js 自定义服务器
description: 了解如何在 Next.js 中创建自定义服务器，以满足更高级的需求，例如自定义路由、中间件集成或特定服务器配置。
---

## 介绍

Next.js 是一个功能强大的 React 框架，默认情况下，它提供了一个内置的服务器来处理路由、静态资源和服务端渲染（SSR）。然而，在某些情况下，你可能需要自定义服务器来满足特定的需求，例如：

- 集成自定义中间件（如身份验证、日志记录等）。
- 处理复杂的路由逻辑。
- 与现有的 Express、Koa 或其他 Node.js 服务器集成。

在本教程中，我们将逐步讲解如何在 Next.js 中创建自定义服务器，并通过实际案例展示其应用场景。

---

## 为什么需要自定义服务器？

Next.js 的内置服务器已经能够处理大多数常见的用例，但在以下场景中，自定义服务器可能是必要的：

1. **自定义路由**：你需要实现超出 Next.js 默认路由系统的复杂路由逻辑。
2. **中间件集成**：你需要添加自定义中间件，例如身份验证、日志记录或错误处理。
3. **服务器配置**：你需要对服务器进行特定的配置，例如启用 HTTPS 或自定义端口。
4. **与现有服务器集成**：你需要将 Next.js 应用集成到现有的 Express 或 Koa 服务器中。

---

## 创建自定义服务器

### 1. 安装依赖

首先，确保你已经安装了 `next` 和 `express`（或其他 Node.js 服务器框架）：

```bash
npm install next express
```

### 2. 创建自定义服务器文件

在项目根目录下创建一个名为 `server.js` 的文件。这个文件将包含我们的自定义服务器逻辑。

```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
  const server = express();

  // 自定义路由示例
  server.get('/custom-route', (req, res) => {
    return app.render(req, res, '/custom-page', req.query);
  });

  // 默认路由处理
  server.all('*', (req, res) => {
    return handle(req, res);
  });

  // 启动服务器
  server.listen(3000, (err) => {
    if (err) throw err;
    console.log('> Ready on http://localhost:3000');
  });
});
```

### 3. 更新 `package.json`

修改 `package.json` 中的 `scripts` 部分，以使用自定义服务器启动应用：

```json
{
  "scripts": {
    "dev": "node server.js",
    "build": "next build",
    "start": "NODE_ENV=production node server.js"
  }
}
```

### 4. 运行自定义服务器

现在，你可以通过以下命令启动自定义服务器：

```bash
npm run dev
```

访问 `http://localhost:3000/custom-route`，你将看到自定义路由的效果。

---

## 实际案例：集成身份验证中间件

假设你需要在 Next.js 应用中集成一个简单的身份验证中间件。以下是如何实现的示例：

```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

// 模拟身份验证中间件
const authMiddleware = (req, res, next) => {
  const isAuthenticated = req.headers['x-auth-token'] === 'secret';
  if (!isAuthenticated) {
    return res.status(401).json({ message: 'Unauthorized' });
  }
  next();
};

app.prepare().then(() => {
  const server = express();

  // 应用身份验证中间件
  server.use('/protected', authMiddleware);

  // 受保护的路由
  server.get('/protected', (req, res) => {
    return app.render(req, res, '/protected-page', req.query);
  });

  // 默认路由处理
  server.all('*', (req, res) => {
    return handle(req, res);
  });

  server.listen(3000, (err) => {
    if (err) throw err;
    console.log('> Ready on http://localhost:3000');
  });
});
```

在这个例子中，只有带有正确 `x-auth-token` 请求头的请求才能访问 `/protected` 路由。

---

## 总结

通过自定义服务器，你可以扩展 Next.js 的功能，以满足更复杂的需求。无论是自定义路由、集成中间件，还是与现有服务器集成，自定义服务器都为你提供了更大的灵活性。

:::tip
如果你不需要自定义服务器，建议尽量使用 Next.js 的内置服务器，因为它已经优化了性能和开发体验。
:::

---

## 附加资源与练习

### 资源
- [Next.js 官方文档 - 自定义服务器](https://nextjs.org/docs/advanced-features/custom-server)
- [Express.js 官方文档](https://expressjs.com/)

### 练习
1. 尝试将 Koa 服务器与 Next.js 集成。
2. 创建一个自定义路由，根据查询参数动态渲染页面。
3. 添加一个日志记录中间件，记录每个请求的详细信息。

通过实践这些练习，你将更深入地理解自定义服务器的潜力与应用场景。