---
title: Android安全存储
description: 了解Android应用中的数据安全存储方法，包括SharedPreferences、文件存储和加密技术，确保用户数据的安全性。
---

# Android安全存储

在Android应用开发中，数据存储是一个至关重要的环节。无论是用户的个人信息、应用设置，还是敏感数据，都需要以安全的方式存储，以防止数据泄露或被恶意篡改。本文将介绍Android中常见的安全存储方法，并通过实际案例帮助初学者理解如何在实际项目中应用这些技术。

## 1. 什么是Android安全存储？

Android安全存储是指在Android设备上以安全的方式保存数据，确保数据不会被未授权的应用或用户访问。Android提供了多种存储方式，包括SharedPreferences、文件存储、SQLite数据库等。然而，这些默认的存储方式并不总是安全的，因此我们需要采取额外的措施来保护数据。

## 2. SharedPreferences的安全使用

`SharedPreferences` 是Android中用于存储简单键值对数据的常用方式。然而，默认情况下，`SharedPreferences` 存储的数据是未加密的，容易被其他应用或恶意用户访问。

### 2.1 加密SharedPreferences

为了增强安全性，我们可以使用加密的 `SharedPreferences`。Android Jetpack 提供了 `EncryptedSharedPreferences` 类，它可以自动对存储的数据进行加密和解密。

```kotlin
import androidx.security.crypto.EncryptedSharedPreferences
import androidx.security.crypto.MasterKey

val masterKey = MasterKey.Builder(context)
    .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
    .build()

val sharedPreferences = EncryptedSharedPreferences.create(
    context,
    "secure_prefs",
    masterKey,
    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
)

sharedPreferences.edit().putString("user_token", "secure_token_value").apply()
```

### 2.2 读取加密数据

读取加密数据与普通 `SharedPreferences` 类似：

```kotlin
val userToken = sharedPreferences.getString("user_token", null)
```

:::note
使用 `EncryptedSharedPreferences` 时，请确保在 `build.gradle` 中添加了 `androidx.security:security-crypto` 依赖。
:::

## 3. 文件存储的安全性

文件存储是另一种常见的数据存储方式，通常用于存储较大的数据或文件。然而，文件存储同样存在安全隐患，尤其是在外部存储中。

### 3.1 内部存储与外部存储

- **内部存储**：只有应用本身可以访问，数据较为安全。
- **外部存储**：所有应用都可以访问，数据容易被篡改或窃取。

### 3.2 加密文件存储

为了增强文件存储的安全性，我们可以对文件进行加密。以下是一个使用 `AES` 加密算法加密文件的示例：

```kotlin
import javax.crypto.Cipher
import javax.crypto.KeyGenerator
import javax.crypto.SecretKey
import java.io.FileOutputStream
import java.io.FileInputStream

val keyGenerator = KeyGenerator.getInstance("AES")
keyGenerator.init(256)
val secretKey: SecretKey = keyGenerator.generateKey()

val cipher = Cipher.getInstance("AES")
cipher.init(Cipher.ENCRYPT_MODE, secretKey)

val file = File(context.filesDir, "secure_file.txt")
val fileOutputStream = FileOutputStream(file)
val encryptedOutputStream = CipherOutputStream(fileOutputStream, cipher)
encryptedOutputStream.write("secure_data".toByteArray())
encryptedOutputStream.close()
```

### 3.3 解密文件

解密文件的过程与加密类似：

```kotlin
cipher.init(Cipher.DECRYPT_MODE, secretKey)
val fileInputStream = FileInputStream(file)
val decryptedInputStream = CipherInputStream(fileInputStream, cipher)
val decryptedData = decryptedInputStream.readBytes()
```

:::caution
密钥管理是加密存储的关键。请确保密钥的安全存储，避免硬编码在代码中。
:::

## 4. SQLite数据库的安全存储

SQLite 是Android中常用的本地数据库，但默认情况下，数据库文件是未加密的。为了增强安全性，我们可以使用加密的SQLite库，如 `SQLCipher`。

### 4.1 使用SQLCipher加密数据库

```kotlin
import net.sqlcipher.database.SQLiteDatabase
import net.sqlcipher.database.SQLiteOpenHelper

class SecureDatabaseHelper(context: Context) : SQLiteOpenHelper(context, "secure_db.db", null, 1) {
    override fun onCreate(db: SQLiteDatabase) {
        db.execSQL("CREATE TABLE secure_table (id INTEGER PRIMARY KEY, data TEXT)")
    }

    override fun onUpgrade(db: SQLiteDatabase, oldVersion: Int, newVersion: Int) {
        db.execSQL("DROP TABLE IF EXISTS secure_table")
        onCreate(db)
    }
}

val databaseHelper = SecureDatabaseHelper(context)
val database = databaseHelper.writableDatabase("secure_password")
```

### 4.2 查询加密数据库

查询加密数据库与普通SQLite数据库类似：

```kotlin
val cursor = database.rawQuery("SELECT * FROM secure_table", null)
while (cursor.moveToNext()) {
    val data = cursor.getString(cursor.getColumnIndex("data"))
}
```

:::tip
使用 `SQLCipher` 时，请确保在 `build.gradle` 中添加了 `net.zetetic:android-database-sqlcipher` 依赖。
:::

## 5. 实际案例：安全存储用户登录信息

假设我们正在开发一个需要用户登录的应用，我们需要安全地存储用户的登录令牌。

### 5.1 使用EncryptedSharedPreferences存储令牌

```kotlin
val sharedPreferences = EncryptedSharedPreferences.create(
    context,
    "user_prefs",
    masterKey,
    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
)

sharedPreferences.edit().putString("auth_token", "user_auth_token").apply()
```

### 5.2 读取令牌

```kotlin
val authToken = sharedPreferences.getString("auth_token", null)
```

## 6. 总结

在Android应用开发中，安全存储是保护用户数据的关键。通过使用加密的 `SharedPreferences`、加密文件存储和加密数据库，我们可以有效地防止数据泄露和篡改。在实际开发中，开发者应根据具体需求选择合适的存储方式，并确保密钥的安全管理。

## 7. 附加资源与练习

- **练习1**：尝试在您的项目中实现加密的 `SharedPreferences`，并存储一些敏感数据。
- **练习2**：使用 `SQLCipher` 创建一个加密的SQLite数据库，并尝试插入和查询数据。
- **资源**：
  - [Android Developers: Data Storage](https://developer.android.com/guide/topics/data)
  - [SQLCipher Documentation](https://www.zetetic.net/sqlcipher/)

通过本文的学习，您应该已经掌握了Android安全存储的基本概念和实现方法。继续实践和探索，您将能够构建更加安全可靠的Android应用。