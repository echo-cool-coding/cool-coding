---
title: Kotlin委托属性
description: 了解Kotlin中的委托属性，掌握如何通过委托简化代码并提高可维护性。
---

# Kotlin委托属性

Kotlin中的委托属性（Delegated Properties）是一种强大的特性，允许你将属性的获取（get）和设置（set）逻辑委托给另一个对象。通过委托属性，你可以将重复的代码抽象出来，使代码更加简洁和可维护。

## 什么是委托属性？

在Kotlin中，委托属性是一种将属性的访问逻辑委托给另一个对象的方式。这意味着你可以将属性的 `get` 和 `set` 操作交给一个委托对象来处理，而不是直接在属性中定义这些逻辑。

Kotlin标准库提供了几种内置的委托属性，例如 `lazy`、`observable` 和 `vetoable`。你也可以创建自定义的委托属性。

## 内置委托属性

### 1. `lazy` 委托

`lazy` 委托用于延迟初始化属性。属性值只有在第一次访问时才会被计算，之后的值会被缓存起来。

```kotlin
val lazyValue: String by lazy {
    println("Computed!")
    "Hello"
}

fun main() {
    println(lazyValue) // 输出: Comput! Hello
    println(lazyValue) // 输出: Hello (不会再次计算)
}
```

在上面的例子中，`lazyValue` 的值只有在第一次访问时才会被计算，并且之后的值会被缓存。

### 2. `observable` 委托

`observable` 委托允许你在属性值发生变化时执行一些操作。你可以通过提供一个回调函数来监听属性的变化。

```kotlin
import kotlin.properties.Delegates

var observableValue: String by Delegates.observable("Initial Value") { 
    _, old, new ->
    println("Value changed from $old to $new")
}

fun main() {
    observableValue = "New Value" // 输出: Value changed from Initial Value to New Value
}
```

在这个例子中，每当 `observableValue` 的值发生变化时，回调函数都会被调用，并打印出旧值和新值。

### 3. `vetoable` 委托

`vetoable` 委托与 `observable` 类似，但它允许你在属性值发生变化之前进行验证。如果验证失败，属性值将不会被更新。

```kotlin
import kotlin.properties.Delegates

var vetoableValue: Int by Delegates.vetoable(0) { 
    _, old, new ->
    println("Trying to change value from $old to $new")
    new > old // 只有新值大于旧值时，才会更新
}

fun main() {
    vetoableValue = 10 // 输出: Trying to change value from 0 to 10
    println(vetoableValue) // 输出: 10

    vetoableValue = 5 // 输出: Trying to change value from 10 to 5
    println(vetoableValue) // 输出: 10 (值未更新)
}
```

在这个例子中，只有当新值大于旧值时，`vetoableValue` 的值才会被更新。

## 自定义委托属性

除了使用内置的委托属性，你还可以创建自定义的委托属性。要实现自定义委托，你需要创建一个类并实现 `ReadOnlyProperty` 或 `ReadWriteProperty` 接口。

```kotlin
import kotlin.reflect.KProperty

class CustomDelegate {
    operator fun getValue(thisRef: Any?, property: KProperty<*>): String {
        return "CustomDelegate: ${property.name}"
    }

    operator fun setValue(thisRef: Any?, property: KProperty<*>, value: String) {
        println("CustomDelegate: Setting ${property.name} to $value")
    }
}

var customValue: String by CustomDelegate()

fun main() {
    println(customValue) // 输出: CustomDelegate: customValue
    customValue = "New Value" // 输出: CustomDelegate: Setting customValue to New Value
}
```

在这个例子中，`CustomDelegate` 类实现了 `getValue` 和 `setValue` 方法，从而可以作为一个委托属性使用。

## 实际应用场景

### 1. 延迟初始化

`lazy` 委托非常适合用于延迟初始化那些计算成本较高的属性。例如，在Android开发中，你可以使用 `lazy` 来延迟初始化视图组件。

```kotlin
val textView: TextView by lazy {
    findViewById(R.id.textView) as TextView
}
```

### 2. 属性监听

`observable` 委托可以用于监听属性的变化。例如，在MVVM架构中，你可以使用 `observable` 来监听数据模型的变化，并自动更新UI。

```kotlin
var user: User by Delegates.observable(User()) { 
    _, old, new ->
    updateUI(new)
}
```

### 3. 属性验证

`vetoable` 委托可以用于在属性值更新之前进行验证。例如，你可以确保某个属性的值始终在有效范围内。

```kotlin
var age: Int by Delegates.vetoable(0) { 
    _, old, new ->
    new in 0..120 // 年龄必须在0到120之间
}
```

## 总结

Kotlin的委托属性是一种强大的工具，可以帮助你简化代码并提高可维护性。通过使用内置的委托属性（如 `lazy`、`observable` 和 `vetoable`），你可以轻松实现延迟初始化、属性监听和属性验证等功能。此外，你还可以创建自定义的委托属性来满足特定的需求。

## 附加资源与练习

- **官方文档**: [Kotlin Delegated Properties](https://kotlinlang.org/docs/delegated-properties.html)
- **练习**: 尝试创建一个自定义的委托属性，用于记录属性的访问和修改日志。

:::tip
如果你对委托属性有任何疑问，或者想要了解更多高级用法，可以参考Kotlin官方文档或相关教程。
:::