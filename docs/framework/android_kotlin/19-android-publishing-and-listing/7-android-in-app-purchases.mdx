---
title: Android应用内购买
description: 了解如何在Android应用中实现应用内购买功能，包括设置、集成和测试。适合初学者学习如何通过应用内购买为应用创收。
---

# Android应用内购买

应用内购买（In-App Purchases, IAP）是Android应用开发中常见的功能，允许用户直接从应用中购买数字商品或服务。这些商品可以是虚拟货币、解锁高级功能、订阅服务等。通过应用内购买，开发者可以为应用创收，同时为用户提供更好的体验。

## 什么是应用内购买？

应用内购买是指用户在应用内购买数字商品或服务的过程。这些商品通常分为以下几类：

1. **消耗型商品**：用户购买后可以多次使用，例如游戏中的虚拟货币。
2. **非消耗型商品**：用户购买后永久拥有，例如解锁高级功能。
3. **订阅**：用户定期支付费用以获取持续的服务或内容，例如每月订阅的新闻服务。

## 设置Google Play控制台

在实现应用内购买之前，你需要在Google Play控制台中设置商品。以下是步骤：

1. **登录Google Play控制台**：访问[Google Play控制台](https://play.google.com/console/)并登录。
2. **创建应用**：如果你还没有应用，请先创建一个。
3. **添加商品**：在“应用内商品”部分，添加你希望用户购买的商品。每个商品都需要一个唯一的ID、价格和描述。

## 集成Google Play Billing库

要在应用中使用应用内购买功能，你需要集成Google Play Billing库。以下是步骤：

1. **添加依赖**：在`build.gradle`文件中添加以下依赖：
   ```groovy
   implementation "com.android.billingclient:billing:6.0.0"
   ```

2. **初始化BillingClient**：在应用中初始化`BillingClient`实例：
   ```kotlin
   val billingClient = BillingClient.newBuilder(context)
       .setListener { billingResult, purchases ->
           // 处理购买结果
       }
       .enablePendingPurchases()
       .build()
   ```

3. **启动连接**：启动与Google Play的连接：
   ```kotlin
   billingClient.startConnection(object : BillingClientStateListener {
       override fun onBillingSetupFinished(billingResult: BillingResult) {
           if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
               // 连接成功
           }
       }

       override fun onBillingServiceDisconnected() {
           // 连接断开
       }
   })
   ```

## 查询商品信息

在用户购买之前，你需要查询商品信息并展示给用户：

```kotlin
val skuDetailsParams = SkuDetailsParams.newBuilder()
    .setSkusList(listOf("product_id"))
    .setType(BillingClient.SkuType.INAPP)
    .build()

billingClient.querySkuDetailsAsync(skuDetailsParams) { billingResult, skuDetailsList ->
    if (billingResult.responseCode == BillingClient.BillingResponseCode.OK && skuDetailsList != null) {
        // 展示商品信息
    }
}
```

## 发起购买流程

当用户选择购买商品时，你可以发起购买流程：

```kotlin
val billingFlowParams = BillingFlowParams.newBuilder()
    .setSkuDetails(skuDetails)
    .build()

val billingResult = billingClient.launchBillingFlow(activity, billingFlowParams)
if (billingResult.responseCode != BillingClient.BillingResponseCode.OK) {
    // 处理错误
}
```

## 处理购买结果

购买完成后，你需要处理购买结果并更新应用状态：

```kotlin
override fun onPurchasesUpdated(billingResult: BillingResult, purchases: List<Purchase>?) {
    if (billingResult.responseCode == BillingClient.BillingResponseCode.OK && purchases != null) {
        for (purchase in purchases) {
            // 处理购买
        }
    }
}
```

## 实际案例

假设你正在开发一款游戏，用户可以通过应用内购买获取虚拟货币。以下是实现步骤：

1. **设置商品**：在Google Play控制台中设置虚拟货币商品，例如“100金币”。
2. **展示商品**：在游戏商店页面展示“100金币”商品及其价格。
3. **发起购买**：当用户点击购买按钮时，发起购买流程。
4. **处理结果**：购买成功后，为用户账户增加100金币。

## 总结

应用内购买是Android应用开发中的重要功能，能够为应用创收并提升用户体验。通过Google Play Billing库，你可以轻松实现应用内购买功能。本文介绍了从设置商品到处理购买结果的完整流程，适合初学者学习和实践。

## 附加资源

- [Google Play Billing官方文档](https://developer.android.com/google/play/billing)
- [Google Play控制台帮助中心](https://support.google.com/googleplay/android-developer/)

## 练习

1. 在Google Play控制台中创建一个新的应用内商品。
2. 在Android应用中集成Google Play Billing库，并实现查询商品信息的功能。
3. 尝试发起购买流程，并处理购买结果。
