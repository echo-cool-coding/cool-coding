---
title: Android OkHttp库
description: "了解如何使用 OkHttp 库在 Android 应用中进行高效的网络请求。本文将从基础概念到实际应用，逐步讲解 OkHttp 的使用方法。"
---

## 介绍

在现代 Android 开发中，网络请求是不可或缺的一部分。无论是从服务器获取数据，还是将用户数据上传到服务器，网络请求都是实现这些功能的核心。OkHttp 是一个强大的开源库，由 Square 公司开发，旨在简化 Android 应用中的网络请求操作。它提供了高效的 HTTP 客户端，支持同步和异步请求，并且具有丰富的功能，如连接池、GZIP 压缩、缓存等。

本文将带你从零开始学习如何使用 OkHttp 库，并通过实际案例展示其强大的功能。

## 安装 OkHttp

在开始使用 OkHttp 之前，首先需要将其添加到你的 Android 项目中。你可以通过 Gradle 来添加依赖：

```groovy
dependencies {
    implementation 'com.squareup.okhttp3:okhttp:4.9.3'
}
```

确保你的项目已经同步了 Gradle 文件，然后你就可以开始使用 OkHttp 了。

## 基本用法

### 创建 OkHttp 客户端

在使用 OkHttp 进行网络请求之前，首先需要创建一个 `OkHttpClient` 实例。这个实例将用于发送请求和接收响应。

```kotlin
val client = OkHttpClient()
```

### 发送 GET 请求

发送一个简单的 GET 请求是 OkHttp 最基本的用法之一。以下是一个示例，展示了如何发送 GET 请求并处理响应：

```kotlin
val request = Request.Builder()
    .url("https://jsonplaceholder.typicode.com/posts/1")
    .build()

client.newCall(request).enqueue(object : Callback {
    override fun onFailure(call: Call, e: IOException) {
        // 处理请求失败的情况
        e.printStackTrace()
    }

    override fun onResponse(call: Call, response: Response) {
        if (response.isSuccessful) {
            val responseBody = response.body?.string()
            println(responseBody)
        }
    }
})
```

在这个示例中，我们创建了一个 `Request` 对象，指定了请求的 URL。然后，我们使用 `enqueue` 方法异步发送请求，并在回调中处理响应。

:::tip
`enqueue` 方法用于异步请求，它不会阻塞主线程。如果你需要同步请求，可以使用 `execute` 方法。
:::

### 发送 POST 请求

除了 GET 请求，OkHttp 也支持发送 POST 请求。以下是一个发送 POST 请求的示例：

```kotlin
val requestBody = FormBody.Builder()
    .add("title", "My Post")
    .add("body", "This is the content of my post.")
    .add("userId", "1")
    .build()

val request = Request.Builder()
    .url("https://jsonplaceholder.typicode.com/posts")
    .post(requestBody)
    .build()

client.newCall(request).enqueue(object : Callback {
    override fun onFailure(call: Call, e: IOException) {
        e.printStackTrace()
    }

    override fun onResponse(call: Call, response: Response) {
        if (response.isSuccessful) {
            val responseBody = response.body?.string()
            println(responseBody)
        }
    }
})
```

在这个示例中，我们创建了一个 `FormBody` 对象，用于构建 POST 请求的表单数据。然后，我们使用 `post` 方法将请求体附加到请求中。

## 高级功能

### 拦截器

OkHttp 提供了拦截器（Interceptor）功能，允许你在请求和响应的过程中插入自定义逻辑。拦截器可以用于日志记录、重试机制、添加公共请求头等。

以下是一个简单的日志拦截器示例：

```kotlin
val loggingInterceptor = HttpLoggingInterceptor().apply {
    level = HttpLoggingInterceptor.Level.BODY
}

val client = OkHttpClient.Builder()
    .addInterceptor(loggingInterceptor)
    .build()
```

在这个示例中，我们创建了一个 `HttpLoggingInterceptor`，并将其添加到 `OkHttpClient` 中。这个拦截器将记录请求和响应的详细信息。

### 缓存

OkHttp 还支持缓存机制，可以减少重复请求的网络开销。你可以通过配置 `Cache` 对象来启用缓存：

```kotlin
val cacheSize = 10 * 1024 * 1024 // 10 MB
val cache = Cache(File("cacheDir"), cacheSize.toLong())

val client = OkHttpClient.Builder()
    .cache(cache)
    .build()
```

在这个示例中，我们创建了一个大小为 10MB 的缓存，并将其配置到 `OkHttpClient` 中。

## 实际案例

假设你正在开发一个新闻应用，需要从服务器获取新闻列表并显示在应用中。以下是一个使用 OkHttp 获取新闻列表的示例：

```kotlin
val request = Request.Builder()
    .url("https://newsapi.org/v2/top-headlines?country=us&apiKey=YOUR_API_KEY")
    .build()

client.newCall(request).enqueue(object : Callback {
    override fun onFailure(call: Call, e: IOException) {
        // 处理请求失败的情况
        e.printStackTrace()
    }

    override fun onResponse(call: Call, response: Response) {
        if (response.isSuccessful) {
            val responseBody = response.body?.string()
            // 解析 JSON 数据并更新 UI
            println(responseBody)
        }
    }
})
```

在这个示例中，我们使用 OkHttp 从新闻 API 获取头条新闻，并在响应成功后解析 JSON 数据。

## 总结

OkHttp 是一个功能强大且易于使用的 HTTP 客户端库，适用于 Android 应用中的各种网络请求场景。通过本文的学习，你应该已经掌握了 OkHttp 的基本用法，并了解了如何在实际项目中使用它。

## 附加资源

- [OkHttp 官方文档](https://square.github.io/okhttp/)
- [OkHttp GitHub 仓库](https://github.com/square/okhttp)
- [Android 网络编程指南](https://developer.android.com/training/volley)

## 练习

1. 使用 OkHttp 发送一个 GET 请求，获取某个 API 的数据并解析 JSON 响应。
2. 实现一个拦截器，记录每个请求的耗时。
3. 配置 OkHttp 的缓存功能，并测试缓存是否生效。

通过完成这些练习，你将更加熟练地掌握 OkHttp 的使用。