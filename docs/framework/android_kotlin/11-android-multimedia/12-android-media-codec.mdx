---
title: Android媒体编解码
description: 了解Android中的媒体编解码概念，掌握如何使用编解码器处理音频和视频数据，并通过实际案例学习其应用。
---

# Android媒体编解码

在Android开发中，**媒体编解码**是一个重要的概念，它涉及将音频或视频数据从一种格式转换为另一种格式的过程。编解码器（Codec）是用于编码（压缩）和解码（解压缩）媒体数据的工具。通过编解码，我们可以有效地存储、传输和播放媒体文件。

## 什么是媒体编解码？

媒体编解码是指将原始音频或视频数据通过编码器压缩成特定格式（如MP3、AAC、H.264等），或通过解码器将压缩后的数据还原为原始格式的过程。编解码器的主要目的是减少媒体文件的大小，同时尽可能保持高质量。

在Android中，媒体编解码通常通过`MediaCodec`类来实现。`MediaCodec`是Android提供的一个底层API，允许开发者直接访问硬件编解码器。

## MediaCodec的基本使用

### 1. 创建MediaCodec实例

要使用`MediaCodec`，首先需要创建一个实例。可以通过指定编解码器的名称或MIME类型来创建。

```java
MediaCodec codec = MediaCodec.createDecoderByType("video/avc");
```

### 2. 配置MediaCodec

在创建实例后，需要配置编解码器。通常需要设置输入和输出的格式。

```java
MediaFormat format = MediaFormat.createVideoFormat("video/avc", width, height);
codec.configure(format, surface, null, 0);
```

### 3. 启动编解码器

配置完成后，启动编解码器。

```java
codec.start();
```

### 4. 处理输入和输出缓冲区

`MediaCodec`通过输入和输出缓冲区来处理数据。开发者需要从输入缓冲区获取数据并传递给编解码器，然后从输出缓冲区获取解码后的数据。

```java
int inputBufferId = codec.dequeueInputBuffer(timeoutUs);
if (inputBufferId >= 0) {
    ByteBuffer inputBuffer = codec.getInputBuffer(inputBufferId);
    // 填充输入缓冲区
    codec.queueInputBuffer(inputBufferId, offset, size, presentationTimeUs, flags);
}

int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, timeoutUs);
if (outputBufferId >= 0) {
    ByteBuffer outputBuffer = codec.getOutputBuffer(outputBufferId);
    // 处理输出缓冲区
    codec.releaseOutputBuffer(outputBufferId, render);
}
```

### 5. 停止和释放编解码器

使用完编解码器后，需要停止并释放资源。

```java
codec.stop();
codec.release();
```

## 实际案例：视频解码

假设我们有一个H.264编码的视频文件，我们需要将其解码并显示在屏幕上。以下是实现步骤：

1. **创建解码器**：创建一个H.264视频解码器。
2. **配置解码器**：设置视频的宽度、高度和帧率。
3. **启动解码器**：启动解码器并开始处理数据。
4. **解码视频**：从视频文件中读取数据并传递给解码器，然后将解码后的帧显示在屏幕上。

```java
MediaCodec codec = MediaCodec.createDecoderByType("video/avc");
MediaFormat format = MediaFormat.createVideoFormat("video/avc", width, height);
codec.configure(format, surface, null, 0);
codec.start();

// 读取视频文件并解码
while (!endOfStream) {
    int inputBufferId = codec.dequeueInputBuffer(timeoutUs);
    if (inputBufferId >= 0) {
        ByteBuffer inputBuffer = codec.getInputBuffer(inputBufferId);
        int sampleSize = extractor.readSampleData(inputBuffer, 0);
        if (sampleSize < 0) {
            codec.queueInputBuffer(inputBufferId, 0, 0, 0, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
            endOfStream = true;
        } else {
            codec.queueInputBuffer(inputBufferId, 0, sampleSize, extractor.getSampleTime(), 0);
            extractor.advance();
        }
    }

    int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, timeoutUs);
    if (outputBufferId >= 0) {
        codec.releaseOutputBuffer(outputBufferId, true);
    }
}

codec.stop();
codec.release();
```

## 总结

通过本文，我们了解了Android中的媒体编解码概念，并学习了如何使用`MediaCodec`类来处理音频和视频数据。我们还通过一个实际案例演示了如何解码H.264视频文件并显示在屏幕上。

:::tip
如果你想进一步学习，可以尝试以下练习：
1. 实现一个音频解码器，将MP3文件解码并播放。
2. 尝试使用`MediaCodec`进行视频编码，将摄像头捕获的视频编码为H.264格式。
:::

## 附加资源

- [Android官方文档 - MediaCodec](https://developer.android.com/reference/android/media/MediaCodec)
- [Android MediaCodec示例](https://github.com/google/ExoPlayer)