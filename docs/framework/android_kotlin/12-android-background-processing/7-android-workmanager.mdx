---
title: Android WorkManager
description: "了解如何使用 Android WorkManager 在后台执行可靠的任务调度，确保任务在设备重启后仍能继续执行。"
---

# Android WorkManager

## 介绍

在 Android 开发中，后台任务处理是一个常见的需求。无论是定期同步数据、上传文件，还是执行其他耗时操作，开发者都需要确保这些任务能够在后台可靠地执行。Android 提供了多种后台任务处理工具，而 **WorkManager** 是其中最强大和灵活的一个。

WorkManager 是一个用于调度和执行后台任务的库，它能够确保任务在设备重启后仍能继续执行。WorkManager 适用于需要可靠执行的任务，即使应用退出或设备重启，任务也不会丢失。

:::note
WorkManager 是 Android Jetpack 的一部分，专为处理后台任务而设计。它兼容 Android 4.0（API 级别 14）及以上版本。
:::

## WorkManager 的核心概念

### 1. Worker
`Worker` 是 WorkManager 的核心组件之一。它负责执行具体的后台任务。你需要继承 `Worker` 类并重写 `doWork()` 方法，在该方法中编写你的任务逻辑。

```kotlin
class MyWorker(context: Context, params: WorkerParameters) : Worker(context, params) {
    override fun doWork(): Result {
        // 在这里执行后台任务
        return Result.success()
    }
}
```

`doWork()` 方法返回一个 `Result` 对象，表示任务执行的结果。`Result` 可以是以下三种之一：
- `Result.success()`：任务成功完成。
- `Result.failure()`：任务失败。
- `Result.retry()`：任务需要重试。

### 2. WorkRequest
`WorkRequest` 是任务的请求对象，用于定义任务的执行方式和约束条件。WorkManager 提供了两种类型的 `WorkRequest`：
- `OneTimeWorkRequest`：一次性任务。
- `PeriodicWorkRequest`：周期性任务。

```kotlin
val myWorkRequest = OneTimeWorkRequestBuilder<MyWorker>().build()
```

### 3. WorkManager
`WorkManager` 是任务的调度器，负责将 `WorkRequest` 加入队列并执行。

```kotlin
WorkManager.getInstance(context).enqueue(myWorkRequest)
```

## 实际案例：定期同步数据

假设你正在开发一个天气应用，需要每天定期从服务器同步天气数据。你可以使用 `PeriodicWorkRequest` 来实现这一功能。

### 1. 创建 Worker
首先，创建一个 `Worker` 来执行数据同步任务。

```kotlin
class SyncWeatherDataWorker(context: Context, params: WorkerParameters) : Worker(context, params) {
    override fun doWork(): Result {
        // 模拟数据同步
        try {
            // 这里可以调用网络请求 API
            Log.d("SyncWeatherDataWorker", "数据同步成功")
            return Result.success()
        } catch (e: Exception) {
            Log.e("SyncWeatherDataWorker", "数据同步失败", e)
            return Result.failure()
        }
    }
}
```

### 2. 创建 PeriodicWorkRequest
接下来，创建一个 `PeriodicWorkRequest`，设置任务每隔 24 小时执行一次。

```kotlin
val syncWorkRequest = PeriodicWorkRequestBuilder<SyncWeatherDataWorker>(24, TimeUnit.HOURS).build()
```

### 3. 将任务加入队列
最后，使用 `WorkManager` 将任务加入队列。

```kotlin
WorkManager.getInstance(context).enqueue(syncWorkRequest)
```

## 任务约束条件

WorkManager 允许你为任务添加约束条件，例如仅在设备充电时执行任务，或仅在设备连接到 Wi-Fi 时执行任务。

```kotlin
val constraints = Constraints.Builder()
    .setRequiredNetworkType(NetworkType.UNMETERED) // 仅在 Wi-Fi 下执行
    .setRequiresCharging(true) // 仅在充电时执行
    .build()

val constrainedWorkRequest = OneTimeWorkRequestBuilder<MyWorker>()
    .setConstraints(constraints)
    .build()
```

## 任务链

WorkManager 还支持任务链，即多个任务按顺序执行。你可以使用 `beginWith()` 和 `then()` 方法来定义任务链。

```kotlin
val workA = OneTimeWorkRequestBuilder<WorkA>().build()
val workB = OneTimeWorkRequestBuilder<WorkB>().build()

WorkManager.getInstance(context)
    .beginWith(workA)
    .then(workB)
    .enqueue()
```

## 总结

Android WorkManager 是一个强大的后台任务调度工具，适用于需要可靠执行的任务。通过 `Worker`、`WorkRequest` 和 `WorkManager`，你可以轻松地调度和执行后台任务，并确保任务在设备重启后仍能继续执行。

:::tip
如果你需要处理复杂的任务链或需要为任务添加约束条件，WorkManager 是一个理想的选择。
:::

## 附加资源

- [Android WorkManager 官方文档](https://developer.android.com/topic/libraries/architecture/workmanager)
- [WorkManager 示例代码](https://github.com/android/architecture-components-samples/tree/main/WorkManagerSample)

## 练习

1. 创建一个 `Worker`，用于在后台下载文件，并使用 `OneTimeWorkRequest` 调度该任务。
2. 修改上述任务，使其仅在设备连接到 Wi-Fi 时执行。
3. 创建一个任务链，包含两个 `Worker`，分别用于下载文件和上传文件。

通过完成这些练习，你将更好地理解 WorkManager 的使用方法。