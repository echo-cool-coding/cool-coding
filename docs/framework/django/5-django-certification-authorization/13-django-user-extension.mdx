---
title: Django 用户扩展
description: 学习如何在Django中扩展默认的用户模型，以满足自定义需求。本文将从基础概念到实际应用逐步讲解，帮助初学者掌握用户扩展的技巧。
---

## 介绍

在Django中，默认的用户模型（`User`）提供了基本的用户认证功能，例如用户名、密码、电子邮件等。然而，在实际开发中，我们通常需要存储更多的用户信息，例如用户的头像、地址、电话号码等。这时，我们就需要扩展Django的默认用户模型。

Django提供了多种方式来扩展用户模型，本文将介绍两种常见的方法：
1. 使用 `AbstractUser` 扩展用户模型。
2. 使用 `OneToOneField` 创建与用户模型关联的Profile模型。

## 方法一：使用 `AbstractUser` 扩展用户模型

`AbstractUser` 是Django提供的一个抽象基类，它包含了默认用户模型的所有字段和方法。通过继承 `AbstractUser`，我们可以轻松地添加自定义字段。

### 步骤1：创建自定义用户模型

首先，在 `models.py` 中创建一个自定义用户模型：

```python
from django.contrib.auth.models import AbstractUser
from django.db import models

class CustomUser(AbstractUser):
    phone_number = models.CharField(max_length=15, blank=True)
    address = models.CharField(max_length=255, blank=True)
    profile_picture = models.ImageField(upload_to='profile_pics/', blank=True)
```

在这个例子中，我们添加了 `phone_number`、`address` 和 `profile_picture` 三个字段。

### 步骤2：在 `settings.py` 中指定自定义用户模型

接下来，我们需要在 `settings.py` 中告诉Django使用我们的自定义用户模型：

```python
AUTH_USER_MODEL = 'myapp.CustomUser'
```

:::note
确保在创建数据库迁移之前完成此步骤，否则可能会导致迁移错误。
:::

### 步骤3：创建并应用数据库迁移

最后，运行以下命令来创建并应用数据库迁移：

```bash
python manage.py makemigrations
python manage.py migrate
```

现在，Django将使用我们的自定义用户模型，并且可以在管理后台中看到新添加的字段。

## 方法二：使用 `OneToOneField` 创建Profile模型

另一种常见的方法是创建一个与默认用户模型关联的Profile模型。这种方法适用于不想修改默认用户模型的情况。

### 步骤1：创建Profile模型

在 `models.py` 中创建一个Profile模型：

```python
from django.db import models
from django.contrib.auth.models import User

class Profile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    phone_number = models.CharField(max_length=15, blank=True)
    address = models.CharField(max_length=255, blank=True)
    profile_picture = models.ImageField(upload_to='profile_pics/', blank=True)
```

### 步骤2：创建并应用数据库迁移

同样，运行以下命令来创建并应用数据库迁移：

```bash
python manage.py makemigrations
python manage.py migrate
```

### 步骤3：在视图中处理Profile

在视图中，我们可以通过以下方式访问和更新用户的Profile：

```python
from django.shortcuts import render, redirect
from .models import Profile
from .forms import ProfileForm

def profile_view(request):
    profile = Profile.objects.get(user=request.user)
    if request.method == 'POST':
        form = ProfileForm(request.POST, request.FILES, instance=profile)
        if form.is_valid():
            form.save()
            return redirect('profile')
    else:
        form = ProfileForm(instance=profile)
    return render(request, 'profile.html', {'form': form})
```

## 实际应用场景

假设我们正在开发一个电子商务网站，需要存储用户的送货地址和电话号码。我们可以使用上述方法之一来扩展用户模型，并在结账时使用这些信息。

### 示例：结账页面

在结账页面中，我们可以显示用户的默认送货地址和电话号码，并允许用户修改这些信息：

```python
def checkout_view(request):
    profile = Profile.objects.get(user=request.user)
    if request.method == 'POST':
        form = CheckoutForm(request.POST, instance=profile)
        if form.is_valid():
            form.save()
            return redirect('payment')
    else:
        form = CheckoutForm(instance=profile)
    return render(request, 'checkout.html', {'form': form})
```

## 总结

通过本文，我们学习了如何在Django中扩展默认的用户模型。无论是使用 `AbstractUser` 还是 `OneToOneField`，我们都可以轻松地添加自定义字段来满足实际需求。选择哪种方法取决于项目的具体需求和开发者的偏好。

:::tip
在实际开发中，建议在项目初期就决定好用户模型的扩展方式，以避免后期修改带来的复杂性。
:::

## 附加资源与练习

- **练习1**：尝试使用 `AbstractUser` 创建一个自定义用户模型，并添加一个 `date_of_birth` 字段。
- **练习2**：使用 `OneToOneField` 创建一个Profile模型，并在管理后台中注册该模型。
- **阅读**：[Django官方文档 - 自定义用户模型](https://docs.djangoproject.com/en/stable/topics/auth/customizing/#substituting-a-custom-user-model)

通过完成这些练习，你将更深入地理解Django用户扩展的概念，并能够在实际项目中灵活应用。