---
title: Django 点击劫持保护
description: 了解Django中的点击劫持保护机制，学习如何防止恶意网站通过iframe嵌入你的应用并诱导用户点击。
---

## 什么是点击劫持？

点击劫持（Clickjacking）是一种恶意攻击技术，攻击者通过将目标网站嵌入到一个透明的iframe中，并覆盖在另一个看似无害的页面上，诱导用户在不知情的情况下点击目标网站上的按钮或链接。这种攻击可能导致用户执行非预期的操作，例如更改隐私设置、转账或发布内容。

Django提供了内置的点击劫持保护机制，帮助开发者防止这种攻击。

---

## Django 的点击劫持保护机制

Django通过设置HTTP响应头 `X-Frame-Options` 来防止点击劫持攻击。该响应头可以控制浏览器是否允许页面在iframe中加载。Django默认启用了点击劫持保护，并提供了灵活的配置选项。

### 默认行为

在Django中，默认情况下，`X-Frame-Options` 被设置为 `DENY`，这意味着页面不能被嵌入到任何iframe中。例如：

```python
# settings.py
MIDDLEWARE = [
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    # 其他中间件
]
```

当启用 `XFrameOptionsMiddleware` 时，Django会自动为所有响应添加 `X-Frame-Options: DENY` 头。

---

## 配置 `X-Frame-Options`

Django允许你通过以下方式自定义 `X-Frame-Options` 的行为：

### 1. 全局配置

你可以在 `settings.py` 中全局配置 `X-Frame-Options` 的值。例如，允许页面在相同域名下的iframe中加载：

```python
# settings.py
X_FRAME_OPTIONS = 'SAMEORIGIN'
```

### 2. 视图级别配置

如果你希望在某些视图中禁用点击劫持保护，可以使用 `@xframe_options_exempt` 装饰器：

```python
from django.views.decorators.clickjacking import xframe_options_exempt

@xframe_options_exempt
def my_view(request):
    return HttpResponse("This view is exempt from clickjacking protection.")
```

### 3. 自定义中间件行为

你还可以通过继承 `XFrameOptionsMiddleware` 并重写 `get_xframe_options_value` 方法来实现更复杂的逻辑：

```python
from django.middleware.clickjacking import XFrameOptionsMiddleware

class CustomXFrameOptionsMiddleware(XFrameOptionsMiddleware):
    def get_xframe_options_value(self, request, response):
        if request.path.startswith('/public/'):
            return 'ALLOW-FROM https://trusted-site.com'
        return super().get_xframe_options_value(request, response)
```

---

## 实际案例

假设你正在开发一个在线银行应用，用户可以通过该应用进行转账操作。为了防止点击劫持攻击，你需要确保转账页面不能被嵌入到任何iframe中。

### 场景描述

- 攻击者创建了一个恶意网站，并将你的转账页面嵌入到一个透明的iframe中。
- 用户在恶意网站上看到一个诱人的按钮，点击后实际上触发了转账操作。

### 解决方案

通过启用Django的点击劫持保护，你可以确保转账页面不能被嵌入到iframe中：

```python
# settings.py
MIDDLEWARE = [
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    # 其他中间件
]

X_FRAME_OPTIONS = 'DENY'
```

这样，即使用户访问了恶意网站，转账页面也不会被加载到iframe中，从而避免了点击劫持攻击。

---

## 总结

点击劫持是一种常见的Web安全威胁，但Django提供了简单而强大的保护机制。通过配置 `X-Frame-Options` 头，你可以有效防止页面被嵌入到iframe中，从而保护用户免受点击劫持攻击。

:::tip
如果你需要允许某些页面在特定域名下的iframe中加载，可以使用 `ALLOW-FROM` 或 `SAMEORIGIN` 选项。但请确保这些域名是可信的。
:::

---

## 附加资源

- [Django官方文档：点击劫持保护](https://docs.djangoproject.com/en/stable/ref/clickjacking/)
- [OWASP点击劫持防御指南](https://owasp.org/www-community/attacks/Clickjacking)
- [MDN：X-Frame-Options](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options)

---

## 练习

1. 在你的Django项目中启用点击劫持保护，并测试页面是否可以被嵌入到iframe中。
2. 尝试在某个视图中禁用点击劫持保护，并观察浏览器的行为。
3. 研究 `ALLOW-FROM` 选项的使用场景，并在你的项目中实现一个允许特定域名嵌入的页面。