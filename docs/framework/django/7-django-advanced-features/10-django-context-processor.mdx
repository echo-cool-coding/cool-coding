---
title: Django 上下文处理器
description: 了解Django上下文处理器的工作原理及其在模板中共享数据的实际应用。
---

## 介绍

在Django中，上下文处理器（Context Processors）是一种强大的工具，用于在模板渲染时自动向模板上下文添加数据。无论你是需要在多个视图中共享数据，还是希望全局访问某些变量，上下文处理器都能帮助你简化代码并提高开发效率。

### 什么是上下文处理器？

上下文处理器是一个Python函数，它接收一个`HttpRequest`对象作为参数，并返回一个包含键值对的字典。这个字典会被合并到模板上下文中，使得在模板中可以直接访问这些数据。

:::note
上下文处理器的主要作用是避免在每个视图中重复添加相同的数据到模板上下文。
:::

## 如何创建自定义上下文处理器

### 1. 编写上下文处理器函数

首先，我们需要创建一个上下文处理器函数。这个函数必须接收一个`HttpRequest`对象作为参数，并返回一个字典。

```python
# myapp/context_processors.py

def site_name(request):
    return {
        'site_name': 'My Awesome Site'
    }
```

在这个例子中，我们创建了一个简单的上下文处理器，它将`site_name`变量添加到模板上下文中。

### 2. 注册上下文处理器

接下来，我们需要在Django的设置文件中注册这个上下文处理器。打开`settings.py`文件，找到`TEMPLATES`配置项，并在`context_processors`列表中添加我们刚刚创建的上下文处理器。

```python
# settings.py

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                # 默认的上下文处理器
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                
                # 自定义的上下文处理器
                'myapp.context_processors.site_name',
            ],
        },
    },
]
```

### 3. 在模板中使用上下文变量

现在，我们可以在任何模板中使用`site_name`变量了。

```html
<!-- base.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ site_name }}</title>
</head>
<body>
    <h1>Welcome to {{ site_name }}</h1>
</body>
</html>
```

在这个例子中，`site_name`变量会被自动注入到模板上下文中，因此我们可以在模板中直接使用它。

## 实际应用场景

### 场景1：全局站点配置

假设你有一个站点配置模型，存储了站点的名称、描述、联系方式等信息。你希望在每个页面中都能访问这些信息，而不需要在每个视图中手动添加。

```python
# myapp/context_processors.py

from .models import SiteConfig

def site_config(request):
    config = SiteConfig.objects.first()
    return {
        'site_name': config.site_name,
        'site_description': config.site_description,
        'contact_email': config.contact_email,
    }
```

在模板中，你可以这样使用：

```html
<!-- base.html -->

<footer>
    <p>{{ site_name }} - {{ site_description }}</p>
    <p>Contact us: {{ contact_email }}</p>
</footer>
```

### 场景2：用户信息

如果你希望在每个页面中都能访问当前用户的信息，可以使用Django内置的`auth`上下文处理器。它会自动将`user`变量添加到模板上下文中。

```html
<!-- base.html -->

{% if user.is_authenticated %}
    <p>Welcome, {{ user.username }}!</p>
{% else %}
    <p>Please <a href="{% url 'login' %}">login</a>.</p>
{% endif %}
```

## 总结

Django上下文处理器是一个非常强大的工具，可以帮助你在模板中全局共享数据，而无需在每个视图中重复添加。通过自定义上下文处理器，你可以轻松地将站点配置、用户信息等数据注入到模板上下文中，从而提高代码的可维护性和开发效率。

### 附加资源

- [Django官方文档 - 上下文处理器](https://docs.djangoproject.com/en/stable/ref/templates/api/#writing-your-own-context-processors)
- [Django模板系统指南](https://docs.djangoproject.com/en/stable/topics/templates/)

### 练习

1. 创建一个自定义上下文处理器，将当前日期添加到模板上下文中，并在模板中显示它。
2. 修改现有的上下文处理器，使其根据用户的登录状态返回不同的数据。

:::tip
在开发过程中，尽量使用上下文处理器来减少代码重复，并保持视图的简洁性。
:::