---
title: Django 中间件高级用法
description: 了解Django中间件的高级用法，掌握如何通过中间件实现请求处理、响应处理、异常处理等功能，并通过实际案例加深理解。
---

## 介绍

Django中间件是一个轻量级的插件系统，用于在请求和响应的处理过程中插入自定义逻辑。中间件可以用于处理请求、修改响应、处理异常等。通过中间件，开发者可以在不修改视图函数的情况下，对请求和响应进行全局处理。

在本文中，我们将深入探讨Django中间件的高级用法，包括如何编写自定义中间件、如何处理请求和响应、如何处理异常，以及如何在实际项目中使用中间件。

## 中间件的基本结构

Django中间件是一个Python类，通常包含以下方法：

- `__init__(self, get_response)`: 初始化方法，`get_response`是一个可调用对象，用于获取视图函数的响应。
- `__call__(self, request)`: 处理请求的方法，`request`是HttpRequest对象。
- `process_view(self, request, view_func, view_args, view_kwargs)`: 在调用视图函数之前执行。
- `process_exception(self, request, exception)`: 在视图函数抛出异常时执行。
- `process_template_response(self, request, response)`: 在视图函数返回TemplateResponse时执行。

以下是一个简单的中间件示例：

```python
class SimpleMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # 在视图函数调用之前执行的代码
        print("Before view")
        response = self.get_response(request)
        # 在视图函数调用之后执行的代码
        print("After view")
        return response
```

## 自定义中间件

### 1. 处理请求和响应

中间件最常见的用途是处理请求和响应。例如，我们可以编写一个中间件来记录每个请求的处理时间：

```python
import time

class TimingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        start_time = time.time()
        response = self.get_response(request)
        end_time = time.time()
        print(f"Request took {end_time - start_time} seconds")
        return response
```

### 2. 处理异常

中间件还可以用于处理视图函数抛出的异常。例如，我们可以编写一个中间件来捕获所有异常并返回一个自定义的错误页面：

```python
from django.http import HttpResponseServerError

class ExceptionHandlingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            response = self.get_response(request)
        except Exception as e:
            print(f"Exception caught: {e}")
            response = HttpResponseServerError("An error occurred.")
        return response
```

### 3. 处理模板响应

如果视图函数返回的是`TemplateResponse`，我们可以使用`process_template_response`方法来修改响应内容。例如，我们可以添加一个自定义的上下文变量：

```python
from django.template.response import TemplateResponse

class TemplateResponseMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)
        if isinstance(response, TemplateResponse):
            response.context_data['custom_variable'] = 'Hello from middleware!'
        return response
```

## 实际案例

### 案例1：用户认证中间件

假设我们有一个需要用户认证的网站，我们可以编写一个中间件来检查用户是否已登录。如果用户未登录，则重定向到登录页面：

```python
from django.shortcuts import redirect

class AuthenticationMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        if not request.user.is_authenticated and request.path != '/login/':
            return redirect('/login/')
        return self.get_response(request)
```

### 案例2：请求日志中间件

我们可以编写一个中间件来记录每个请求的详细信息，包括请求方法、路径、用户代理等：

```python
class RequestLoggingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        print(f"Request Method: {request.method}")
        print(f"Request Path: {request.path}")
        print(f"User Agent: {request.META.get('HTTP_USER_AGENT')}")
        response = self.get_response(request)
        return response
```

## 总结

Django中间件是一个强大的工具，可以帮助我们在请求和响应的处理过程中插入自定义逻辑。通过编写自定义中间件，我们可以实现请求处理、响应处理、异常处理等功能，从而在不修改视图函数的情况下，对请求和响应进行全局处理。

在实际项目中，中间件可以用于用户认证、请求日志记录、性能监控等场景。通过本文的学习，你应该已经掌握了Django中间件的高级用法，并能够编写自己的中间件来处理各种需求。

## 附加资源

- [Django官方文档 - 中间件](https://docs.djangoproject.com/en/stable/topics/http/middleware/)
- [Django中间件实战](https://realpython.com/custom-django-middleware/)
- [Django中间件源码解析](https://www.cnblogs.com/wupeiqi/articles/5237704.html)

## 练习

1. 编写一个中间件，记录每个请求的IP地址。
2. 编写一个中间件，在响应头中添加一个自定义的`X-Custom-Header`。
3. 编写一个中间件，捕获所有异常并发送邮件通知管理员。
