---
title: 统计信息收集
description: 了解数据库中的统计信息收集，以及它如何帮助优化查询性能。本文适合初学者，涵盖基本概念、实际案例和代码示例。
---

# 统计信息收集

在数据库管理系统中，**统计信息收集**是一个关键的过程，它帮助数据库优化器做出更明智的查询执行计划决策。通过收集表和索引的统计信息，数据库可以更好地估计查询的成本，从而选择最优的执行路径。

## 什么是统计信息？

统计信息是数据库中关于表和索引的数据分布情况的元数据。这些信息包括：

- **表的行数**：表中总共有多少行数据。
- **列的唯一值数量**：某一列中有多少个不同的值。
- **列的最小值和最大值**：某一列中的最小值和最大值。
- **数据分布直方图**：显示数据在某一列中的分布情况。

这些信息帮助数据库优化器估计查询的选择性（即查询返回的行数占总行数的比例），从而决定使用哪个索引或执行哪种连接策略。

## 为什么统计信息重要？

如果没有准确的统计信息，数据库优化器可能会选择低效的执行计划，导致查询性能下降。例如，优化器可能会错误地估计某个查询返回的行数，从而选择全表扫描而不是使用索引。

:::tip
统计信息的准确性直接影响查询性能。定期更新统计信息是数据库维护的重要部分。
:::

## 如何收集统计信息？

大多数现代数据库管理系统（如 MySQL、PostgreSQL、Oracle 等）都提供了自动和手动收集统计信息的机制。

### 自动收集统计信息

许多数据库系统会在后台自动收集统计信息。例如，当表中的数据发生显著变化时（如插入、更新或删除大量数据），数据库会自动触发统计信息的更新。

### 手动收集统计信息

在某些情况下，你可能需要手动收集统计信息，特别是在数据发生大规模变化后，或者你怀疑统计信息已经过时。

#### MySQL 示例

在 MySQL 中，你可以使用 `ANALYZE TABLE` 命令来手动收集统计信息：

```sql
ANALYZE TABLE your_table_name;
```

执行此命令后，MySQL 会更新 `your_table_name` 表的统计信息。

#### PostgreSQL 示例

在 PostgreSQL 中，你可以使用 `ANALYZE` 命令来手动收集统计信息：

```sql
ANALYZE your_table_name;
```

PostgreSQL 会更新 `your_table_name` 表的统计信息，并存储在系统目录中。

## 统计信息的实际应用

让我们通过一个实际案例来理解统计信息如何影响查询性能。

### 案例：查询优化

假设我们有一个 `orders` 表，其中包含以下列：

- `order_id`：订单的唯一标识符。
- `customer_id`：客户的唯一标识符。
- `order_date`：订单的日期。

我们想要查询某个客户的所有订单：

```sql
SELECT * FROM orders WHERE customer_id = 123;
```

如果 `customer_id` 列上有索引，并且统计信息显示 `customer_id` 列的唯一值数量很高（即每个客户只有少量订单），那么数据库优化器可能会选择使用索引来快速定位相关行。

然而，如果统计信息显示 `customer_id` 列的唯一值数量很低（即大多数订单都属于少数客户），优化器可能会选择全表扫描，因为使用索引可能不会带来显著的性能提升。

:::caution
如果统计信息不准确，优化器可能会做出错误的决策，导致查询性能下降。
:::

## 总结

统计信息收集是数据库查询优化的重要组成部分。通过收集和更新统计信息，数据库优化器可以更准确地估计查询成本，从而选择最优的执行计划。定期检查和更新统计信息是确保数据库性能的关键步骤。

## 附加资源

- [MySQL 官方文档：ANALYZE TABLE](https://dev.mysql.com/doc/refman/8.0/en/analyze-table.html)
- [PostgreSQL 官方文档：ANALYZE](https://www.postgresql.org/docs/current/sql-analyze.html)
- [Oracle 官方文档：统计信息收集](https://docs.oracle.com/en/database/oracle/oracle-database/19/tgsql/optimizer-statistics.html)

## 练习

1. 在你的数据库中创建一个表，并插入一些数据。然后使用 `ANALYZE TABLE` 或 `ANALYZE` 命令收集统计信息。
2. 查询系统表（如 `information_schema` 或 `pg_statistic`）查看统计信息。
3. 尝试在没有统计信息的情况下运行查询，然后更新统计信息并再次运行查询，观察性能差异。

通过这些练习，你将更好地理解统计信息如何影响查询性能。