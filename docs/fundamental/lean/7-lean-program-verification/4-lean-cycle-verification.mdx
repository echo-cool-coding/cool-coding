---
title: Lean 循环验证
description: 了解如何在Lean中使用循环验证技术，确保程序的正确性和可靠性。本文适合初学者，包含代码示例和实际案例。
---

## 介绍

在编程中，循环是控制程序流程的重要结构。然而，循环的正确性往往难以保证，尤其是在复杂的程序中。Lean作为一种交互式定理证明器，提供了强大的工具来验证循环的正确性。本文将介绍如何在Lean中验证循环，确保程序的行为符合预期。

## 循环验证的基本概念

循环验证的核心思想是通过**循环不变量**（Loop Invariant）来证明循环的正确性。循环不变量是在循环的每次迭代中都保持为真的条件。通过证明循环不变量在循环开始、每次迭代以及循环结束时都成立，我们可以确保循环的正确性。

### 循环不变量的定义

循环不变量是一个逻辑表达式，它在循环的以下三个时刻都成立：

1. **循环开始前**：在进入循环之前，循环不变量必须成立。
2. **每次迭代后**：在循环体的每次迭代结束后，循环不变量仍然成立。
3. **循环结束后**：在循环结束时，循环不变量仍然成立，并且循环的终止条件也成立。

## 代码示例

让我们通过一个简单的例子来说明如何在Lean中验证循环。假设我们要验证一个计算阶乘的循环。

```lean
def factorial (n : Nat) : Nat :=
  let rec loop (i : Nat) (acc : Nat) : Nat :=
    if i = 0 then
      acc
    else
      loop (i - 1) (acc * i)
  loop n 1
```

在这个例子中，`loop`函数是一个递归函数，用于计算阶乘。我们需要验证这个循环的正确性。

### 循环不变量的定义

对于这个循环，我们可以定义循环不变量为：

- **循环不变量**：`acc = factorial (n - i)`

这个不变量表示在每次迭代中，`acc`的值等于`n - i`的阶乘。

### 验证循环不变量

我们需要证明这个循环不变量在循环开始、每次迭代以及循环结束时都成立。

1. **循环开始前**：在进入循环之前，`i = n`且`acc = 1`，因此`acc = factorial (n - n) = factorial 0 = 1`，循环不变量成立。
2. **每次迭代后**：假设在迭代`i`时，循环不变量成立，即`acc = factorial (n - i)`。在迭代`i - 1`时，`acc`更新为`acc * i`，因此`acc = factorial (n - i) * i = factorial (n - (i - 1))`，循环不变量仍然成立。
3. **循环结束后**：当`i = 0`时，循环结束，此时`acc = factorial n`，循环不变量成立。

## 实际案例

让我们通过一个更复杂的例子来展示循环验证的实际应用。假设我们要验证一个计算斐波那契数列的循环。

```lean
def fibonacci (n : Nat) : Nat :=
  let rec loop (i : Nat) (a : Nat) (b : Nat) : Nat :=
    if i = 0 then
      a
    else
      loop (i - 1) b (a + b)
  loop n 0 1
```

在这个例子中，`loop`函数用于计算斐波那契数列的第`n`项。我们需要验证这个循环的正确性。

### 循环不变量的定义

对于这个循环，我们可以定义循环不变量为：

- **循环不变量**：`a = fibonacci (n - i)` 且 `b = fibonacci (n - i + 1)`

这个不变量表示在每次迭代中，`a`和`b`的值分别等于斐波那契数列的第`n - i`项和第`n - i + 1`项。

### 验证循环不变量

我们需要证明这个循环不变量在循环开始、每次迭代以及循环结束时都成立。

1. **循环开始前**：在进入循环之前，`i = n`且`a = 0`，`b = 1`，因此`a = fibonacci (n - n) = fibonacci 0 = 0`，`b = fibonacci (n - n + 1) = fibonacci 1 = 1`，循环不变量成立。
2. **每次迭代后**：假设在迭代`i`时，循环不变量成立，即`a = fibonacci (n - i)`且`b = fibonacci (n - i + 1)`。在迭代`i - 1`时，`a`更新为`b`，`b`更新为`a + b`，因此`a = fibonacci (n - i + 1)`，`b = fibonacci (n - i) + fibonacci (n - i + 1) = fibonacci (n - (i - 1) + 1)`，循环不变量仍然成立。
3. **循环结束后**：当`i = 0`时，循环结束，此时`a = fibonacci n`，循环不变量成立。

## 总结

通过定义和验证循环不变量，我们可以在Lean中确保循环的正确性。循环不变量是验证循环的强大工具，它帮助我们理解循环的行为，并确保程序在每次迭代中都符合预期。

## 附加资源与练习

- **练习1**：尝试在Lean中验证一个计算最大公约数（GCD）的循环。
- **练习2**：定义一个循环不变量来验证一个计算数组求和的循环。

:::tip
在验证循环时，始终确保循环不变量在循环开始、每次迭代以及循环结束时都成立。这是确保循环正确性的关键。
:::

:::caution
如果循环不变量在某个时刻不成立，那么循环的正确性将无法保证。因此，仔细定义和验证循环不变量是非常重要的。
:::