---
title: MongoDB聚合操作
description: 了解MongoDB中的聚合操作，掌握如何使用聚合管道对数据进行复杂的查询和转换。
---

# MongoDB聚合操作

MongoDB的聚合操作是一种强大的工具，允许你对集合中的文档进行复杂的查询和转换。通过聚合操作，你可以对数据进行分组、过滤、排序、计算等操作，从而生成符合需求的结果集。本文将逐步介绍MongoDB的聚合操作，并通过实际案例帮助你理解其应用场景。

## 什么是聚合操作？

聚合操作是MongoDB中用于处理数据的一种方式，它通过一系列的**阶段（stages）**对数据进行处理。每个阶段都会对输入文档进行某种操作，并将结果传递给下一个阶段。最终，聚合操作会输出一个结果集。

聚合操作的核心是**聚合管道（Aggregation Pipeline）**，它由多个阶段组成，每个阶段都是一个操作符，例如 `$match`、`$group`、`$sort` 等。这些操作符可以组合使用，以实现复杂的数据处理需求。

## 聚合管道的基本结构

一个典型的聚合管道由多个阶段组成，每个阶段都会对数据进行某种操作。以下是一个简单的聚合管道示例：

```javascript
db.collection.aggregate([
  { $match: { status: "A" } }, // 阶段1：过滤文档
  { $group: { _id: "$cust_id", total: { $sum: "$amount" } } }, // 阶段2：按cust_id分组并计算总和
  { $sort: { total: -1 } } // 阶段3：按total字段降序排序
])
```

在这个例子中，聚合管道由三个阶段组成：

1. `$match`：过滤出 `status` 字段值为 `"A"` 的文档。
2. `$group`：按 `cust_id` 字段分组，并计算每个组的 `amount` 字段的总和。
3. `$sort`：按 `total` 字段降序排序。

## 常用聚合操作符

以下是一些常用的聚合操作符及其功能：

- `$match`：过滤文档，类似于查询中的 `find`。
- `$group`：按指定字段分组，并计算聚合值（如总和、平均值等）。
- `$sort`：对文档进行排序。
- `$project`：选择或重命名字段，类似于查询中的 `projection`。
- `$limit`：限制输出文档的数量。
- `$skip`：跳过指定数量的文档。
- `$unwind`：将数组字段拆分为多个文档。
- `$lookup`：执行左连接操作，从另一个集合中获取相关文档。

## 实际案例：计算每个用户的订单总金额

假设我们有一个 `orders` 集合，其中包含以下文档：

```json
[
  { "cust_id": "A123", "amount": 50, "status": "A" },
  { "cust_id": "A123", "amount": 100, "status": "A" },
  { "cust_id": "B456", "amount": 75, "status": "B" },
  { "cust_id": "B456", "amount": 200, "status": "A" }
]
```

我们的目标是计算每个用户的订单总金额，并且只考虑 `status` 为 `"A"` 的订单。以下是实现这一目标的聚合管道：

```javascript
db.orders.aggregate([
  { $match: { status: "A" } }, // 过滤status为A的订单
  { $group: { _id: "$cust_id", total: { $sum: "$amount" } } }, // 按cust_id分组并计算总金额
  { $sort: { total: -1 } } // 按总金额降序排序
])
```

执行上述聚合操作后，输出结果如下：

```json
[
  { "_id": "B456", "total": 200 },
  { "_id": "A123", "total": 150 }
]
```

:::tip
在这个例子中，我们首先使用 `$match` 过滤出 `status` 为 `"A"` 的订单，然后使用 `$group` 按 `cust_id` 分组并计算总金额，最后使用 `$sort` 对结果进行排序。
:::

## 使用 `$lookup` 进行集合连接

MongoDB的 `$lookup` 操作符允许你在聚合管道中执行类似SQL中的左连接操作。假设我们有两个集合：`orders` 和 `customers`，我们想要将订单与客户信息关联起来。

`orders` 集合：

```json
[
  { "order_id": 1, "cust_id": "A123", "amount": 50 },
  { "order_id": 2, "cust_id": "B456", "amount": 100 }
]
```

`customers` 集合：

```json
[
  { "cust_id": "A123", "name": "Alice" },
  { "cust_id": "B456", "name": "Bob" }
]
```

我们可以使用 `$lookup` 将订单与客户信息关联起来：

```javascript
db.orders.aggregate([
  {
    $lookup: {
      from: "customers", // 要连接的集合
      localField: "cust_id", // 本地集合中的字段
      foreignField: "cust_id", // 外部集合中的字段
      as: "customer_info" // 输出字段名
    }
  }
])
```

执行上述聚合操作后，输出结果如下：

```json
[
  {
    "order_id": 1,
    "cust_id": "A123",
    "amount": 50,
    "customer_info": [{ "cust_id": "A123", "name": "Alice" }]
  },
  {
    "order_id": 2,
    "cust_id": "B456",
    "amount": 100,
    "customer_info": [{ "cust_id": "B456", "name": "Bob" }]
  }
]
```

:::note
`$lookup` 操作符会将匹配的文档作为一个数组存储在指定的字段中（在这个例子中是 `customer_info`）。如果不需要数组形式，可以使用 `$unwind` 将其展开。
:::

## 总结

MongoDB的聚合操作提供了强大的数据处理能力，允许你通过组合不同的阶段来实现复杂的数据查询和转换。通过本文的介绍，你应该已经掌握了聚合管道的基本结构、常用操作符以及如何在实际场景中应用这些操作符。

## 附加资源与练习

- **官方文档**：阅读 [MongoDB官方文档](https://docs.mongodb.com/manual/aggregation/) 以了解更多高级聚合操作。
- **练习**：尝试在一个包含多个集合的数据库中设计一个聚合管道，计算每个产品的销售总额，并将结果按销售额排序。

:::caution
在实际使用聚合操作时，请注意性能问题。复杂的聚合管道可能会对数据库性能产生影响，尤其是在处理大量数据时。
:::