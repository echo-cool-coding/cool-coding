---
title: 内存泄漏排查
description: 了解什么是内存泄漏，如何识别和排查 JVM 中的内存泄漏问题，并通过实际案例掌握相关工具和技术。
---

## 什么是内存泄漏？

内存泄漏（Memory Leak）是指程序在运行过程中，由于某些原因未能释放不再使用的内存，导致内存占用不断增加，最终可能耗尽系统内存，引发程序崩溃或性能下降。在 JVM 中，内存泄漏通常表现为堆内存（Heap Memory）的持续增长，即使垃圾回收器（Garbage Collector, GC）频繁运行也无法回收这些内存。

:::note
内存泄漏与内存溢出（Out of Memory, OOM）不同。内存溢出是指程序申请的内存超过了 JVM 的最大内存限制，而内存泄漏是指内存被无效占用，无法释放。
:::

## 如何识别内存泄漏？

在 JVM 中，内存泄漏的常见表现包括：

1. **堆内存持续增长**：即使程序处于空闲状态，堆内存占用仍然不断增加。
2. **频繁的 Full GC**：垃圾回收器频繁触发 Full GC，但回收效果不明显。
3. **OOM 错误**：程序最终抛出 `OutOfMemoryError`，导致崩溃。

### 使用工具监控内存

JVM 提供了多种工具来监控内存使用情况，例如：

- **jstat**：查看堆内存和垃圾回收的统计信息。
- **jmap**：生成堆内存快照（Heap Dump）。
- **VisualVM**：图形化工具，用于监控和分析 JVM 运行状态。

以下是一个使用 `jstat` 监控堆内存的示例：

```bash
jstat -gc <pid> 1000 10
```

该命令会每隔 1 秒输出一次垃圾回收和堆内存的统计信息，共输出 10 次。

## 排查内存泄漏的步骤

### 1. 生成堆内存快照

当怀疑存在内存泄漏时，首先需要生成堆内存快照（Heap Dump）。可以使用以下命令生成快照：

```bash
jmap -dump:format=b,file=heapdump.hprof <pid>
```

生成的 `heapdump.hprof` 文件可以使用工具（如 **Eclipse MAT** 或 **VisualVM**）进行分析。

### 2. 分析堆内存快照

打开堆内存快照后，重点关注以下内容：

- **大对象**：查找占用内存最多的对象。
- **对象引用链**：分析这些对象的引用链，找出哪些对象仍然持有对它们的引用。
- **重复对象**：检查是否存在大量重复的对象，这可能是内存泄漏的迹象。

### 3. 修复内存泄漏

根据分析结果，修复代码中导致内存泄漏的部分。常见的内存泄漏原因包括：

- **未关闭的资源**：如数据库连接、文件流等。
- **静态集合类**：静态集合类会一直持有对象的引用，导致对象无法被回收。
- **监听器未移除**：未正确移除事件监听器，导致对象无法被回收。

以下是一个典型的内存泄漏示例：

```java
public class MemoryLeakExample {
    private static List<Object> list = new ArrayList<>();

    public void addObject(Object obj) {
        list.add(obj);
    }
}
```

在这个例子中，`list` 是一个静态集合类，它会一直持有所有添加的对象，导致这些对象无法被垃圾回收。

## 实际案例

### 案例：未关闭的数据库连接

假设我们有一个 Web 应用程序，每次处理请求时都会创建一个数据库连接，但未正确关闭连接。随着时间的推移，这些未关闭的连接会占用大量内存，最终导致内存泄漏。

```java
public void handleRequest() {
    Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/mydb", "user", "password");
    // 执行数据库操作
    // 忘记关闭连接
}
```

修复方法是在使用完连接后，确保关闭它：

```java
public void handleRequest() {
    Connection conn = null;
    try {
        conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/mydb", "user", "password");
        // 执行数据库操作
    } finally {
        if (conn != null) {
            conn.close();
        }
    }
}
```

## 总结

内存泄漏是 JVM 应用程序中常见的问题，可能导致程序性能下降甚至崩溃。通过监控内存使用情况、生成和分析堆内存快照，可以有效地识别和修复内存泄漏问题。在实际开发中，养成良好的编程习惯，如及时关闭资源、避免滥用静态集合类等，可以有效预防内存泄漏的发生。

## 附加资源

- [Eclipse MAT 官方文档](https://www.eclipse.org/mat/)
- [VisualVM 官方文档](https://visualvm.github.io/)
- [Java 内存管理指南](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/)

## 练习

1. 编写一个简单的 Java 程序，模拟内存泄漏，并使用 `jmap` 生成堆内存快照。
2. 使用 Eclipse MAT 或 VisualVM 分析生成的堆内存快照，找出内存泄漏的原因。
3. 修复程序中的内存泄漏问题，并验证修复效果。