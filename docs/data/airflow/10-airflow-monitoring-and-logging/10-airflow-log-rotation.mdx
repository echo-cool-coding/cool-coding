---
title: Airflow 日志轮转
description: 了解如何在Apache Airflow中配置和管理日志轮转，以确保日志文件不会无限增长并占用过多磁盘空间。
---

# Airflow 日志轮转

在Apache Airflow中，日志是调试和监控任务执行情况的重要工具。然而，随着时间的推移，日志文件可能会变得非常大，占用大量磁盘空间。为了避免这种情况，Airflow提供了日志轮转（Log Rotation）功能，允许你自动管理日志文件的大小和数量。

## 什么是日志轮转？

日志轮转是一种管理日志文件的机制，它通过定期创建新的日志文件并删除旧的日志文件，来防止单个日志文件变得过大。通常，日志轮转会基于文件大小或时间间隔来触发。

在Airflow中，日志轮转可以通过配置日志处理器（Log Handler）来实现。默认情况下，Airflow使用Python的`logging`模块来处理日志，并支持多种日志处理器，如`RotatingFileHandler`和`TimedRotatingFileHandler`。

## 配置日志轮转

### 1. 使用 `RotatingFileHandler`

`RotatingFileHandler` 是基于文件大小的日志轮转处理器。当日志文件达到指定的大小时，它会创建一个新的日志文件，并将旧的日志文件重命名。

以下是如何在Airflow中配置 `RotatingFileHandler` 的示例：

```python
# airflow.cfg
[logging]
# 设置日志文件的最大大小（以字节为单位）
max_bytes = 10485760  # 10 MB
# 设置保留的日志文件数量
backup_count = 5
# 设置日志处理器的类
logging_handler_class = logging.handlers.RotatingFileHandler
```

在这个配置中，当日志文件达到10MB时，Airflow会创建一个新的日志文件，并保留最多5个旧的日志文件。

### 2. 使用 `TimedRotatingFileHandler`

`TimedRotatingFileHandler` 是基于时间的日志轮转处理器。它可以根据指定的时间间隔（如每天、每小时等）来创建新的日志文件。

以下是如何在Airflow中配置 `TimedRotatingFileHandler` 的示例：

```python
# airflow.cfg
[logging]
# 设置日志轮转的时间间隔
when = midnight  # 每天午夜轮转
# 设置保留的日志文件数量
backup_count = 7
# 设置日志处理器的类
logging_handler_class = logging.handlers.TimedRotatingFileHandler
```

在这个配置中，Airflow会在每天午夜创建一个新的日志文件，并保留最近7天的日志文件。

## 实际案例

假设你正在运行一个每天执行一次的Airflow DAG，并且你希望保留最近7天的日志文件。你可以使用 `TimedRotatingFileHandler` 来实现这一点。

```python
# airflow.cfg
[logging]
when = midnight
backup_count = 7
logging_handler_class = logging.handlers.TimedRotatingFileHandler
```

这样，Airflow会在每天午夜创建一个新的日志文件，并自动删除7天前的日志文件，确保日志文件不会无限增长。

## 总结

日志轮转是管理Airflow日志文件的重要机制，它可以防止日志文件占用过多磁盘空间。通过配置 `RotatingFileHandler` 或 `TimedRotatingFileHandler`，你可以根据文件大小或时间间隔来自动轮转日志文件。

## 附加资源

- [Python `logging` 模块文档](https://docs.python.org/3/library/logging.html)
- [Apache Airflow 官方文档](https://airflow.apache.org/docs/)

## 练习

1. 在你的Airflow环境中配置 `RotatingFileHandler`，并设置日志文件的最大大小为5MB，保留3个旧的日志文件。
2. 尝试使用 `TimedRotatingFileHandler`，并配置日志轮转的时间间隔为每小时一次，保留24个旧的日志文件。

通过完成这些练习，你将更好地理解如何在Airflow中管理日志文件。