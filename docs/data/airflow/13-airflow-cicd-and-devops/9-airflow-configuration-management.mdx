---
title: Airflow 配置管理
description: 了解如何在Apache Airflow中管理配置，包括环境变量、配置文件、以及如何通过CI/CD和DevOps实践实现配置的自动化管理。
---

# Airflow 配置管理

Apache Airflow 是一个强大的工作流调度和编排工具，广泛应用于数据工程和DevOps领域。配置管理是Airflow部署和维护中的关键部分，它决定了Airflow的行为、性能以及与外部系统的集成方式。本文将详细介绍如何在Airflow中进行配置管理，并通过实际案例展示其应用。

## 什么是Airflow配置管理？

Airflow配置管理是指通过配置文件、环境变量等方式，管理和控制Airflow的行为。这些配置包括数据库连接、执行器类型、日志设置、DAG存储位置等。良好的配置管理可以确保Airflow在不同环境（如开发、测试、生产）中的一致性，并简化部署和维护过程。

## Airflow 配置文件

Airflow的主要配置文件是 `airflow.cfg`，它位于Airflow的根目录下。这个文件包含了Airflow的所有核心配置项。以下是一个典型的 `airflow.cfg` 文件的部分内容：

```ini
[core]
# The folder where your airflow pipelines live, most likely a
# subfolder in a code repository
dags_folder = /path/to/your/dags

# The executor class that airflow should use. Choices include
# SequentialExecutor, LocalExecutor, CeleryExecutor, KubernetesExecutor
executor = LocalExecutor

# The sql_alchemy_conn setting defines how to connect to the database
sql_alchemy_conn = sqlite:////path/to/airflow.db

[webserver]
# The base url of your website as airflow cannot guess what domain or
# cname or ip it is being accessed from
base_url = http://localhost:8080
```

:::note
`airflow.cfg` 文件中的配置项可以通过环境变量进行覆盖。例如，`AIRFLOW__CORE__SQL_ALCHEMY_CONN` 环境变量可以覆盖 `sql_alchemy_conn` 配置项。
:::

## 环境变量配置

Airflow支持通过环境变量来覆盖 `airflow.cfg` 中的配置项。环境变量的命名规则是将配置项中的 `.` 替换为 `__`，并将整个字符串转换为大写。例如，`sql_alchemy_conn` 配置项可以通过 `AIRFLOW__CORE__SQL_ALCHEMY_CONN` 环境变量来设置。

```bash
export AIRFLOW__CORE__SQL_ALCHEMY_CONN="postgresql+psycopg2://user:password@localhost/airflow"
```

:::tip
使用环境变量可以方便地在不同的部署环境中切换配置，特别是在使用容器化部署时。
:::

## 配置管理的实际应用

### 场景：多环境配置管理

假设你有一个Airflow项目，需要在开发、测试和生产环境中部署。每个环境的数据库连接、DAG存储位置等配置可能不同。你可以通过以下方式管理这些配置：

1. **开发环境**：使用本地SQLite数据库和本地DAG文件夹。
2. **测试环境**：使用PostgreSQL数据库和共享存储中的DAG文件夹。
3. **生产环境**：使用高可用的PostgreSQL集群和分布式存储中的DAG文件夹。

你可以为每个环境创建不同的 `airflow.cfg` 文件，并通过环境变量指定使用哪个配置文件：

```bash
# 开发环境
export AIRFLOW_CONFIG=/path/to/airflow_dev.cfg

# 测试环境
export AIRFLOW_CONFIG=/path/to/airflow_test.cfg

# 生产环境
export AIRFLOW_CONFIG=/path/to/airflow_prod.cfg
```

### 场景：CI/CD中的配置管理

在CI/CD管道中，你可以通过环境变量动态设置Airflow的配置。例如，在Jenkins或GitLab CI中，你可以在构建步骤中设置环境变量：

```yaml
# GitLab CI 示例
stages:
  - deploy

deploy_to_production:
  stage: deploy
  script:
    - export AIRFLOW__CORE__SQL_ALCHEMY_CONN="postgresql+psycopg2://user:password@prod-db/airflow"
    - airflow db upgrade
    - airflow webserver
```

## 总结

Airflow配置管理是确保Airflow在不同环境中一致运行的关键。通过 `airflow.cfg` 文件和环境变量，你可以灵活地管理Airflow的配置。在多环境和CI/CD场景中，合理的配置管理可以大大简化部署和维护过程。

## 附加资源与练习

- **官方文档**：阅读 [Airflow官方文档](https://airflow.apache.org/docs/) 中关于配置管理的部分，了解更多细节。
- **练习**：尝试在你的本地环境中设置不同的 `airflow.cfg` 文件，并通过环境变量切换配置。
- **进阶**：探索如何在Kubernetes中使用ConfigMap和Secret来管理Airflow的配置。

:::caution
在修改配置文件或环境变量后，确保重新启动Airflow服务以使更改生效。
:::