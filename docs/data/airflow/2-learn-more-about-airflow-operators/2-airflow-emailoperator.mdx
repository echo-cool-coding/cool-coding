---
title: Airflow EmailOperator 详解
description: 了解如何使用 Airflow 的 EmailOperator 发送电子邮件，并掌握其在实际工作流中的应用。
---

# Airflow EmailOperator 详解

在 Apache Airflow 中，`EmailOperator` 是一个非常有用的操作符，它允许你在工作流中发送电子邮件。无论是用于通知任务的成功或失败，还是发送报告或日志文件，`EmailOperator` 都能帮助你轻松实现这些功能。

## 什么是 EmailOperator？

`EmailOperator` 是 Airflow 提供的一个操作符，用于在 DAG（有向无环图）中发送电子邮件。它依赖于 Airflow 的电子邮件配置，可以通过 SMTP 服务器发送邮件。你可以指定收件人、主题、正文内容，甚至可以附加文件。

## 如何使用 EmailOperator

要使用 `EmailOperator`，首先需要确保 Airflow 的电子邮件配置已经正确设置。你可以在 `airflow.cfg` 文件中配置 SMTP 服务器、端口、用户名和密码等信息。

### 基本用法

以下是一个简单的 `EmailOperator` 示例，展示了如何发送一封包含简单文本内容的电子邮件：

```python
from airflow import DAG
from airflow.operators.email_operator import EmailOperator
from airflow.utils.dates import days_ago

default_args = {
    'owner': 'airflow',
    'start_date': days_ago(1),
}

with DAG('email_example_dag', default_args=default_args, schedule_interval=None) as dag:
    send_email = EmailOperator(
        task_id='send_email',
        to='recipient@example.com',
        subject='Airflow EmailOperator Example',
        html_content='<p>This is a test email sent from Airflow.</p>',
    )
```

在这个示例中，我们创建了一个名为 `email_example_dag` 的 DAG，并定义了一个 `EmailOperator` 任务。该任务会向 `recipient@example.com` 发送一封电子邮件，主题为 "Airflow EmailOperator Example"，内容为一段简单的 HTML 文本。

### 发送带附件的电子邮件

`EmailOperator` 还支持发送带附件的电子邮件。你可以通过 `files` 参数指定要附加的文件路径。以下是一个示例：

```python
send_email_with_attachment = EmailOperator(
    task_id='send_email_with_attachment',
    to='recipient@example.com',
    subject='Airflow EmailOperator with Attachment',
    html_content='<p>Please find the attached file.</p>',
    files=['/path/to/your/file.txt'],
)
```

在这个示例中，`EmailOperator` 会发送一封带有附件的电子邮件，附件为 `/path/to/your/file.txt`。

## 实际应用场景

### 任务失败通知

在实际工作中，你可能希望在某个任务失败时收到通知。你可以使用 `EmailOperator` 来实现这一功能。以下是一个示例：

```python
from airflow.operators.python_operator import PythonOperator
from airflow.utils.email import send_email

def task_that_might_fail():
    raise Exception('This task failed!')

with DAG('failure_notification_dag', default_args=default_args, schedule_interval=None) as dag:
    task = PythonOperator(
        task_id='task_that_might_fail',
        python_callable=task_that_might_fail,
        on_failure_callback=lambda context: send_email(
            to='admin@example.com',
            subject='Task Failed',
            html_content=f'Task {context["task"].task_id} failed.',
        ),
    )
```

在这个示例中，如果 `task_that_might_fail` 任务失败，`on_failure_callback` 会触发 `send_email` 函数，向管理员发送一封通知邮件。

### 定期报告

你还可以使用 `EmailOperator` 定期发送报告。例如，每天发送一份包含前一天数据的报告：

```python
with DAG('daily_report_dag', default_args=default_args, schedule_interval='@daily') as dag:
    generate_report = PythonOperator(
        task_id='generate_report',
        python_callable=generate_report_function,
    )

    send_report = EmailOperator(
        task_id='send_report',
        to='report_recipient@example.com',
        subject='Daily Report',
        html_content='<p>Please find the daily report attached.</p>',
        files=['/path/to/daily_report.csv'],
    )

    generate_report >> send_report
```

在这个示例中，`generate_report` 任务生成报告文件，然后 `send_report` 任务将报告文件作为附件发送给指定的收件人。

## 总结

`EmailOperator` 是 Airflow 中一个非常实用的操作符，能够帮助你在工作流中轻松发送电子邮件。无论是用于任务失败通知、定期报告，还是其他需要发送邮件的场景，`EmailOperator` 都能满足你的需求。

## 附加资源与练习

- **练习 1**: 创建一个 DAG，使用 `EmailOperator` 在任务成功时发送一封通知邮件。
- **练习 2**: 修改上面的示例，使其在任务失败时发送包含错误日志的附件。

通过以上练习，你将更深入地理解 `EmailOperator` 的使用方法，并能够在实际项目中灵活应用。