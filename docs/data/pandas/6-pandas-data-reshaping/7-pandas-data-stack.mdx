---
title: Pandas 数据堆叠
description: 了解如何使用Pandas进行数据堆叠，将宽格式数据转换为长格式数据，以便更好地进行分析和可视化。
---

# Pandas 数据堆叠

在数据分析和处理中，我们经常会遇到需要将数据从宽格式（wide format）转换为长格式（long format）的情况。Pandas库提供了强大的工具来实现这一转换，其中最常用的方法之一就是**数据堆叠（stacking）**。本文将详细介绍Pandas中的数据堆叠操作，并通过示例代码和实际案例帮助你掌握这一技能。

## 什么是数据堆叠？

数据堆叠是一种将数据从宽格式转换为长格式的操作。宽格式数据通常是指每一列代表一个变量，而每一行代表一个观测值。长格式数据则是将多个变量堆叠到一个列中，同时保留其他列作为标识符。

例如，假设我们有一个宽格式的数据表，其中每一列代表一个年份的销售额：

| 城市   | 2020年销售额 | 2021年销售额 | 2022年销售额 |
|--------|--------------|--------------|--------------|
| 北京   | 1000         | 1200         | 1500         |
| 上海   | 800          | 900          | 1100         |

通过数据堆叠，我们可以将其转换为长格式：

| 城市   | 年份       | 销售额 |
|--------|------------|--------|
| 北京   | 2020年销售额 | 1000   |
| 北京   | 2021年销售额 | 1200   |
| 北京   | 2022年销售额 | 1500   |
| 上海   | 2020年销售额 | 800    |
| 上海   | 2021年销售额 | 900    |
| 上海   | 2022年销售额 | 1100   |

这种转换使得数据更适合进行某些类型的分析和可视化。

## 使用Pandas进行数据堆叠

Pandas提供了`stack()`方法来实现数据堆叠。让我们通过一个具体的例子来演示如何使用`stack()`方法。

### 示例1：基本数据堆叠

假设我们有以下数据：

```python
import pandas as pd

# 创建DataFrame
data = {
    '城市': ['北京', '上海'],
    '2020年销售额': [1000, 800],
    '2021年销售额': [1200, 900],
    '2022年销售额': [1500, 1100]
}

df = pd.DataFrame(data)
print(df)
```

输出：

```
   城市  2020年销售额  2021年销售额  2022年销售额
0  北京        1000        1200        1500
1  上海         800         900        1100
```

现在，我们使用`stack()`方法将数据堆叠：

```python
# 设置索引为“城市”
df.set_index('城市', inplace=True)

# 使用stack()方法进行堆叠
stacked_df = df.stack()
print(stacked_df)
```

输出：

```
城市        
北京  2020年销售额    1000
     2021年销售额    1200
     2022年销售额    1500
上海  2020年销售额     800
     2021年销售额     900
     2022年销售额    1100
dtype: int64
```

可以看到，数据已经从宽格式转换为长格式。每一行现在包含城市、年份和销售额三个信息。

### 示例2：重置索引

默认情况下，`stack()`方法会返回一个多级索引的Series。如果我们希望将其转换为DataFrame，并重置索引，可以使用`reset_index()`方法：

```python
# 重置索引并转换为DataFrame
stacked_df = df.stack().reset_index()
stacked_df.columns = ['城市', '年份', '销售额']
print(stacked_df)
```

输出：

```
   城市          年份  销售额
0  北京  2020年销售额  1000
1  北京  2021年销售额  1200
2  北京  2022年销售额  1500
3  上海  2020年销售额   800
4  上海  2021年销售额   900
5  上海  2022年销售额  1100
```

现在，数据已经转换为一个标准的DataFrame，便于进一步处理和分析。

## 实际应用场景

数据堆叠在实际数据分析中有广泛的应用。以下是一些常见的应用场景：

1. **时间序列分析**：在时间序列数据中，通常需要将多个时间点的数据堆叠到一个列中，以便进行时间序列分析。
2. **数据可视化**：某些可视化工具（如Seaborn）更适合处理长格式数据。通过数据堆叠，可以更方便地绘制图表。
3. **数据透视表**：在创建数据透视表时，长格式数据通常更容易操作。

### 案例：时间序列数据堆叠

假设我们有一个包含多个城市在不同年份的销售额数据，我们希望分析每个城市的销售额随时间的变化趋势。通过数据堆叠，我们可以将年份列转换为一个单独的列，从而更容易进行分析和可视化。

```python
import seaborn as sns
import matplotlib.pyplot as plt

# 绘制堆叠后的数据
sns.lineplot(data=stacked_df, x='年份', y='销售额', hue='城市')
plt.title('城市销售额随时间变化趋势')
plt.show()
```

通过这种方式，我们可以轻松地比较不同城市的销售额随时间的变化趋势。

## 总结

数据堆叠是Pandas中一个非常有用的功能，它可以帮助我们将宽格式数据转换为长格式数据，从而更适合进行某些类型的分析和可视化。通过本文的介绍和示例，你应该已经掌握了如何使用`stack()`方法进行数据堆叠，并了解了其在实际应用中的价值。

:::tip 提示
如果你对Pandas的其他数据重塑功能感兴趣，可以继续学习`melt()`、`pivot()`等方法，它们也是处理数据格式转换的强大工具。
:::

## 附加资源与练习

- **练习1**：尝试使用`stack()`方法处理你自己的数据集，并将其转换为长格式。
- **练习2**：使用堆叠后的数据绘制不同类型的图表（如柱状图、折线图等），并分析结果。

通过不断练习，你将更加熟练地掌握Pandas中的数据堆叠操作，并能够灵活应用于实际项目中。