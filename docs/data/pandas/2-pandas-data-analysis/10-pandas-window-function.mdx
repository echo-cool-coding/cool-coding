---
title: Pandas 窗口函数
description: 了解Pandas中的窗口函数，掌握如何通过滑动窗口对数据进行滚动计算和分析。
---

# Pandas 窗口函数

在数据分析中，窗口函数是一种强大的工具，它允许我们对数据集中的某个“窗口”内的数据进行计算。Pandas提供了多种窗口函数，帮助我们实现滚动计算、扩展计算等操作。本文将详细介绍Pandas窗口函数的概念、用法以及实际应用场景。

## 什么是窗口函数？

窗口函数是一种在数据集的某个“窗口”内执行计算的方法。这个窗口可以是固定大小的（如过去5天的数据），也可以是动态变化的（如从开始到当前行的所有数据）。窗口函数常用于时间序列分析、移动平均计算、累积统计等场景。

Pandas提供了多种窗口函数，主要包括：
- **滚动窗口（Rolling Window）**：对固定大小的窗口进行计算。
- **扩展窗口（Expanding Window）**：从数据集的开始到当前行的所有数据进行计算。
- **指数加权窗口（Exponentially Weighted Window）**：对窗口内的数据进行加权计算，权重随时间衰减。

## 滚动窗口（Rolling Window）

滚动窗口是Pandas中最常用的窗口函数之一。它允许我们对固定大小的窗口内的数据进行计算。例如，计算过去7天的移动平均。

### 基本用法

```python
import pandas as pd

# 创建一个示例时间序列
data = pd.Series([1, 2, 3, 4, 5, 6, 7, 8, 9, 10])

# 计算3天的滚动平均
rolling_mean = data.rolling(window=3).mean()

print(rolling_mean)
```

**输出：**
```
0    NaN
1    NaN
2    2.0
3    3.0
4    4.0
5    5.0
6    6.0
7    7.0
8    8.0
9    9.0
dtype: float64
```

:::note
注意：在滚动窗口的计算中，前`window-1`个值通常是`NaN`，因为窗口大小不足以进行计算。
:::

### 实际应用：计算股票价格的移动平均

假设我们有一组股票价格数据，我们可以使用滚动窗口来计算其移动平均线，以平滑价格波动。

```python
import pandas as pd

# 假设这是某股票的价格数据
stock_prices = pd.Series([100, 102, 101, 105, 107, 110, 108, 109, 111, 112])

# 计算5天的移动平均
moving_avg = stock_prices.rolling(window=5).mean()

print(moving_avg)
```

**输出：**
```
0     NaN
1     NaN
2     NaN
3     NaN
4    103.0
5    105.0
6    106.2
7    107.8
8    109.0
9    110.2
dtype: float64
```

## 扩展窗口（Expanding Window）

扩展窗口与滚动窗口不同，它从数据集的开始到当前行的所有数据进行计算。扩展窗口常用于计算累积统计量，如累积和、累积平均等。

### 基本用法

```python
import pandas as pd

# 创建一个示例时间序列
data = pd.Series([1, 2, 3, 4, 5, 6, 7, 8, 9, 10])

# 计算累积平均
expanding_mean = data.expanding().mean()

print(expanding_mean)
```

**输出：**
```
0    1.0
1    1.5
2    2.0
3    2.5
4    3.0
5    3.5
6    4.0
7    4.5
8    5.0
9    5.5
dtype: float64
```

### 实际应用：计算累积收益

假设我们有一组投资回报数据，我们可以使用扩展窗口来计算累积收益。

```python
import pandas as pd

# 假设这是某投资的每日回报率
returns = pd.Series([0.01, 0.02, -0.01, 0.03, 0.02, 0.01, -0.02, 0.01, 0.03, 0.02])

# 计算累积收益
cumulative_returns = (1 + returns).expanding().prod() - 1

print(cumulative_returns)
```

**输出：**
```
0    0.010000
1    0.030200
2    0.019898
3    0.050496
4    0.071506
5    0.082221
6    0.060576
7    0.071182
8    0.103317
9    0.125384
dtype: float64
```

## 指数加权窗口（Exponentially Weighted Window）

指数加权窗口是一种特殊的窗口函数，它对窗口内的数据进行加权计算，权重随时间衰减。这种方法常用于平滑时间序列数据，减少噪声的影响。

### 基本用法

```python
import pandas as pd

# 创建一个示例时间序列
data = pd.Series([1, 2, 3, 4, 5, 6, 7, 8, 9, 10])

# 计算指数加权平均
ewm_mean = data.ewm(span=3).mean()

print(ewm_mean)
```

**输出：**
```
0    1.000000
1    1.666667
2    2.428571
3    3.266667
4    4.161290
5    5.095238
6    6.055556
7    7.032258
8    8.015873
9    9.006410
dtype: float64
```

### 实际应用：平滑传感器数据

假设我们有一组传感器采集的数据，数据中存在噪声。我们可以使用指数加权窗口来平滑数据，减少噪声的影响。

```python
import pandas as pd

# 假设这是传感器采集的数据
sensor_data = pd.Series([10.1, 10.2, 10.5, 10.3, 10.7, 10.6, 10.8, 10.9, 11.0, 11.2])

# 使用指数加权窗口平滑数据
smoothed_data = sensor_data.ewm(span=3).mean()

print(smoothed_data)
```

**输出：**
```
0    10.100000
1    10.166667
2    10.357143
3    10.326667
4    10.538710
5    10.566667
6    10.694444
7    10.806452
8    10.904762
9    11.058065
dtype: float64
```

## 总结

Pandas窗口函数是数据分析中非常强大的工具，能够帮助我们进行滚动计算、累积统计以及数据平滑等操作。通过本文的学习，你应该已经掌握了如何使用滚动窗口、扩展窗口和指数加权窗口来处理数据。

### 附加资源与练习

- **练习1**：使用滚动窗口计算某股票价格的20天移动平均线。
- **练习2**：使用扩展窗口计算某投资组合的累积收益。
- **练习3**：使用指数加权窗口平滑一组温度传感器数据，并观察平滑效果。

:::tip
如果你想进一步深入学习Pandas窗口函数，可以参考Pandas官方文档中的[窗口函数部分](https://pandas.pydata.org/pandas-docs/stable/user_guide/window.html)。
:::