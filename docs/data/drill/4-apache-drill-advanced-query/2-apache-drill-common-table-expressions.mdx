---
title: Apache Drill 公共表表达式
description: 了解 Apache Drill 中的公共表表达式（CTE），掌握如何使用 CTE 简化复杂查询并提高代码可读性。
---

## 什么是公共表表达式（CTE）？

公共表表达式（Common Table Expression，简称 CTE）是 SQL 中的一种临时命名结果集，可以在查询中多次引用。CTE 通常用于简化复杂查询，使其更具可读性和可维护性。在 Apache Drill 中，CTE 的使用方式与其他 SQL 数据库类似。

CTE 通过 `WITH` 关键字定义，后面跟随一个或多个子查询。每个子查询都可以被赋予一个名称，并在主查询中引用。CTE 的作用范围仅限于定义它的查询。

## 基本语法

CTE 的基本语法如下：

```sql
WITH cte_name AS (
    SELECT column1, column2
    FROM table_name
    WHERE condition
)
SELECT *
FROM cte_name;
```

在上面的语法中：
- `cte_name` 是 CTE 的名称。
- `SELECT column1, column2 FROM table_name WHERE condition` 是 CTE 的定义。
- 主查询通过 `SELECT * FROM cte_name` 引用 CTE。

## 示例：使用 CTE 简化查询

假设我们有一个名为 `sales` 的表，包含以下数据：

| id  | product | quantity | price |
|-----|---------|----------|-------|
| 1   | A       | 10       | 100   |
| 2   | B       | 5        | 200   |
| 3   | A       | 8        | 100   |
| 4   | C       | 12       | 150   |

我们希望计算每个产品的总销售额，并筛选出销售额大于 1000 的产品。可以使用 CTE 来简化查询：

```sql
WITH product_sales AS (
    SELECT product, SUM(quantity * price) AS total_sales
    FROM sales
    GROUP BY product
)
SELECT product, total_sales
FROM product_sales
WHERE total_sales > 1000;
```

### 输出结果

| product | total_sales |
|---------|-------------|
| A       | 1800        |
| C       | 1800        |

在这个例子中，`product_sales` 是一个 CTE，它计算了每个产品的总销售额。主查询从 `product_sales` 中筛选出销售额大于 1000 的产品。

## 实际应用场景

### 场景 1：递归查询

CTE 的一个强大功能是支持递归查询。递归 CTE 可以用于处理层次结构数据，例如组织结构或文件系统。

假设我们有一个 `employees` 表，包含以下数据：

| id  | name  | manager_id |
|-----|-------|------------|
| 1   | Alice | NULL       |
| 2   | Bob   | 1          |
| 3   | Carol | 1          |
| 4   | Dave  | 2          |
| 5   | Eve   | 2          |

我们希望查询出 Alice 的所有下属（包括间接下属）。可以使用递归 CTE 来实现：

```sql
WITH RECURSIVE subordinates AS (
    SELECT id, name, manager_id
    FROM employees
    WHERE name = 'Alice'
    UNION ALL
    SELECT e.id, e.name, e.manager_id
    FROM employees e
    INNER JOIN subordinates s ON e.manager_id = s.id
)
SELECT name
FROM subordinates;
```

### 输出结果

| name  |
|-------|
| Alice |
| Bob   |
| Carol |
| Dave  |
| Eve   |

在这个例子中，递归 CTE `subordinates` 首先选择 Alice 作为起点，然后递归地选择所有直接或间接向 Alice 汇报的员工。

### 场景 2：分步计算

CTE 还可以用于分步计算。例如，假设我们有一个 `orders` 表和一个 `order_items` 表，我们希望计算每个订单的总金额，并筛选出总金额大于 500 的订单。

```sql
WITH order_totals AS (
    SELECT o.order_id, SUM(i.quantity * i.price) AS total_amount
    FROM orders o
    JOIN order_items i ON o.order_id = i.order_id
    GROUP BY o.order_id
)
SELECT order_id, total_amount
FROM order_totals
WHERE total_amount > 500;
```

在这个例子中，`order_totals` CTE 计算了每个订单的总金额，主查询则筛选出总金额大于 500 的订单。

## 总结

公共表表达式（CTE）是 Apache Drill 中一个非常有用的工具，可以帮助你简化复杂查询、提高代码的可读性和可维护性。通过使用 CTE，你可以将查询分解为多个逻辑部分，使每个部分更易于理解和调试。

:::tip
在使用 CTE 时，尽量保持每个 CTE 的逻辑简单明了，避免嵌套过多，以免影响查询性能。
:::

## 附加资源与练习

1. **练习 1**：在 `sales` 表中，使用 CTE 计算每个产品的平均销售额，并筛选出平均销售额大于 100 的产品。
2. **练习 2**：在 `employees` 表中，使用递归 CTE 查询出 Bob 的所有下属（包括间接下属）。
3. **参考文档**：查阅 [Apache Drill 官方文档](https://drill.apache.org/docs/) 了解更多关于 CTE 的高级用法和优化技巧。

通过不断练习和探索，你将能够熟练使用 CTE 来处理各种复杂的查询场景。