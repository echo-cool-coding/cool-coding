---
title: Apache Drill 嵌套数据
description: "了解 Apache Drill 如何处理嵌套数据结构，包括 JSON、Parquet 等格式中的嵌套字段。本文将通过示例和实际案例帮助初学者掌握嵌套数据的概念和应用。"
---

# Apache Drill 嵌套数据

Apache Drill 是一个支持复杂数据查询的分布式 SQL 引擎，特别擅长处理嵌套数据结构。嵌套数据是指数据中包含其他数据结构，例如 JSON 中的对象或数组，或者 Parquet 文件中的嵌套列。本文将详细介绍 Apache Drill 如何处理嵌套数据，并通过示例帮助您理解其工作原理。

## 什么是嵌套数据？

嵌套数据是指在一个数据结构中包含另一个数据结构。例如，在 JSON 文件中，一个字段的值可能是一个对象或数组：

```json
{
  "name": "John",
  "age": 30,
  "address": {
    "street": "123 Main St",
    "city": "New York"
  },
  "hobbies": ["reading", "traveling", "coding"]
}
```

在这个例子中，`address` 是一个嵌套对象，而 `hobbies` 是一个嵌套数组。Apache Drill 可以轻松查询这些嵌套字段，就像查询普通字段一样。

## 查询嵌套数据

Apache Drill 使用点符号（`.`）来访问嵌套字段。例如，要查询上面的 JSON 数据中的 `city` 字段，可以使用以下 SQL 查询：

```sql
SELECT address.city FROM my_table;
```

### 示例：查询嵌套对象

假设我们有一个名为 `users` 的表，其中包含以下 JSON 数据：

```json
{
  "id": 1,
  "name": "Alice",
  "contact": {
    "email": "alice@example.com",
    "phone": "123-456-7890"
  }
}
```

我们可以使用以下查询来获取用户的电子邮件地址：

```sql
SELECT contact.email FROM users;
```

输出结果将是：

```
+-------------------+
|       email       |
+-------------------+
| alice@example.com |
+-------------------+
```

### 示例：查询嵌套数组

如果数据中包含嵌套数组，例如：

```json
{
  "id": 2,
  "name": "Bob",
  "skills": ["Java", "Python", "SQL"]
}
```

我们可以使用 `FLATTEN` 函数将数组展开为多行：

```sql
SELECT name, FLATTEN(skills) AS skill FROM users;
```

输出结果将是：

```
+-------+--------+
| name  | skill  |
+-------+--------+
| Bob   | Java   |
| Bob   | Python |
| Bob   | SQL    |
+-------+--------+
```

## 实际应用场景

### 场景 1：分析日志数据

假设您有一个包含嵌套 JSON 的日志文件，记录了用户的访问信息：

```json
{
  "timestamp": "2023-10-01T12:00:00Z",
  "user": {
    "id": 101,
    "name": "Charlie"
  },
  "actions": [
    {"type": "click", "target": "button"},
    {"type": "scroll", "target": "page"}
  ]
}
```

您可以使用 Apache Drill 查询用户的点击操作：

```sql
SELECT user.name, actions.type 
FROM logs 
WHERE actions.type = 'click';
```

### 场景 2：处理 Parquet 文件中的嵌套数据

Apache Drill 也支持查询 Parquet 文件中的嵌套数据。假设您有一个 Parquet 文件，其中包含以下结构：

```plaintext
id: int
name: string
address: struct<street: string, city: string>
```

您可以使用以下查询来获取所有用户的居住城市：

```sql
SELECT address.city FROM parquet_files;
```

## 总结

Apache Drill 的强大之处在于它能够轻松处理嵌套数据结构，无论是 JSON、Parquet 还是其他格式。通过点符号和 `FLATTEN` 函数，您可以像查询普通字段一样查询嵌套数据。本文通过示例和实际场景展示了如何在实际中使用这些功能。

## 附加资源

- [Apache Drill 官方文档](https://drill.apache.org/docs/)
- [JSONPath 语法指南](https://goessner.net/articles/JsonPath/)
- [Parquet 文件格式介绍](https://parquet.apache.org/documentation/latest/)

## 练习

1. 创建一个包含嵌套 JSON 数据的表，并尝试查询其中的嵌套字段。
2. 使用 `FLATTEN` 函数展开一个嵌套数组，并计算数组中元素的数量。
3. 下载一个包含嵌套数据的 Parquet 文件，并使用 Apache Drill 查询其中的嵌套字段。

:::tip
如果您在练习中遇到问题，可以参考 Apache Drill 的官方文档或社区论坛获取帮助。
:::