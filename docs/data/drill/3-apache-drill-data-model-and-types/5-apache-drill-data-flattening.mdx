---
title: Apache Drill 数据扁平化
description: 了解 Apache Drill 中的数据扁平化概念，掌握如何将嵌套数据结构转换为扁平化表格形式，以便于分析和查询。
---

# Apache Drill 数据扁平化

在数据分析和处理中，嵌套数据结构（如 JSON 或 Parquet 文件中的嵌套字段）非常常见。然而，许多工具和查询语言更适合处理扁平化的表格数据。Apache Drill 提供了一种强大的功能，称为**数据扁平化**，可以将嵌套数据转换为扁平化的表格形式，从而简化查询和分析。

## 什么是数据扁平化？

数据扁平化是指将嵌套的、层次化的数据结构转换为扁平的、表格形式的过程。例如，假设我们有一个包含嵌套数组和对象的 JSON 文件，通过扁平化，我们可以将这些嵌套结构展开为多行或多列，使其更适合 SQL 查询。

### 为什么需要数据扁平化？

- **简化查询**：扁平化后的数据结构更易于使用 SQL 查询。
- **提高兼容性**：许多工具和库更适合处理表格数据。
- **增强可读性**：扁平化后的数据更直观，便于分析和理解。

## 数据扁平化的基本概念

在 Apache Drill 中，数据扁平化主要通过 `FLATTEN` 函数实现。`FLATTEN` 函数用于将嵌套数组展开为多行，每行包含数组中的一个元素。

### 语法

```sql
FLATTEN(array_column)
```

- `array_column`：需要展开的嵌套数组列。

### 示例

假设我们有以下 JSON 数据：

```json
{
  "id": 1,
  "name": "John",
  "skills": ["Java", "Python", "SQL"]
}
```

我们希望将 `skills` 数组展开为多行，每行包含一个技能。可以使用以下查询：

```sql
SELECT id, name, FLATTEN(skills) AS skill
FROM employees;
```

**输出结果：**

| id  | name | skill  |
|-----|------|--------|
| 1   | John | Java   |
| 1   | John | Python |
| 1   | John | SQL    |

:::note
`FLATTEN` 函数会将嵌套数组中的每个元素展开为一行，同时保留其他列的值。
:::

## 实际应用场景

### 场景 1：处理嵌套 JSON 数据

假设我们有一个包含订单信息的 JSON 文件，每个订单包含多个商品：

```json
{
  "order_id": 101,
  "customer": "Alice",
  "items": [
    {"product": "Laptop", "price": 1200},
    {"product": "Mouse", "price": 25}
  ]
}
```

我们希望将每个商品展开为一行，以便分析每个订单的商品详情。可以使用以下查询：

```sql
SELECT order_id, customer, FLATTEN(items) AS item
FROM orders;
```

**输出结果：**

| order_id | customer | item                     |
|----------|----------|--------------------------|
| 101      | Alice    | `{"product": "Laptop", "price": 1200}` |
| 101      | Alice    | `{"product": "Mouse", "price": 25}`    |

### 场景 2：处理嵌套数组中的对象

假设我们有一个包含学生信息的 JSON 文件，每个学生有多个课程成绩：

```json
{
  "student_id": 1,
  "name": "Bob",
  "grades": [
    {"course": "Math", "score": 90},
    {"course": "Science", "score": 85}
  ]
}
```

我们希望将每个课程成绩展开为一行，以便分析每个学生的成绩。可以使用以下查询：

```sql
SELECT student_id, name, FLATTEN(grades) AS grade
FROM students;
```

**输出结果：**

| student_id | name | grade                     |
|------------|------|---------------------------|
| 1          | Bob  | `{"course": "Math", "score": 90}`    |
| 1          | Bob  | `{"course": "Science", "score": 85}` |

## 总结

Apache Drill 的 `FLATTEN` 函数是处理嵌套数据的强大工具，能够将复杂的嵌套结构转换为扁平化的表格形式，从而简化查询和分析。通过本文的学习，你应该已经掌握了如何使用 `FLATTEN` 函数来处理嵌套数组和对象。

## 附加资源

- [Apache Drill 官方文档](https://drill.apache.org/docs/)
- [SQL 嵌套数据处理指南](https://www.sqlshack.com/working-with-nested-data-in-sql/)

## 练习

1. 尝试使用 `FLATTEN` 函数处理一个包含多层嵌套数组的 JSON 文件，并观察输出结果。
2. 编写一个查询，将嵌套对象中的多个字段展开为单独的列。

:::tip
在练习中，可以尝试结合 `FLATTEN` 和其他 SQL 函数（如 `JSON_VALUE`）来处理更复杂的嵌套数据结构。
:::