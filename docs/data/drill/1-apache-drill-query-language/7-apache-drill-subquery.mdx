---
title: Apache Drill 子查询
description: 了解如何在 Apache Drill 中使用子查询，掌握嵌套查询的基本语法和实际应用场景。
---

# Apache Drill 子查询

在 Apache Drill 中，子查询（Subquery）是一种强大的工具，允许你在一个查询中嵌套另一个查询。子查询可以用于过滤数据、计算聚合值或作为复杂查询的一部分。本文将详细介绍 Apache Drill 中子查询的概念、语法和实际应用。

## 什么是子查询？

子查询是一个嵌套在主查询中的查询。它可以返回一个值、一组值或一个表，这些结果可以被主查询使用。子查询通常用于以下场景：

- 过滤数据（例如，使用 `WHERE` 子句中的子查询）。
- 计算聚合值（例如，使用 `SELECT` 子句中的子查询）。
- 作为表表达式（例如，在 `FROM` 子句中使用子查询）。

## 子查询的基本语法

子查询的基本语法如下：

```sql
SELECT column1, column2
FROM table1
WHERE column1 IN (SELECT column1 FROM table2 WHERE condition);
```

在这个例子中，`(SELECT column1 FROM table2 WHERE condition)` 是一个子查询，它返回一组值，主查询使用这些值来过滤 `table1` 中的数据。

## 子查询的类型

Apache Drill 支持多种类型的子查询，包括：

1. **标量子查询**：返回单个值的子查询。
2. **行子查询**：返回单行数据的子查询。
3. **表子查询**：返回多行多列数据的子查询。

### 标量子查询

标量子查询返回一个单一的值，通常用于 `SELECT`、`WHERE` 或 `HAVING` 子句中。

```sql
SELECT name, (SELECT AVG(salary) FROM employees) AS avg_salary
FROM employees;
```

在这个例子中，子查询 `(SELECT AVG(salary) FROM employees)` 返回所有员工的平均工资，并将其作为 `avg_salary` 列显示在结果中。

### 行子查询

行子查询返回一行数据，通常用于 `WHERE` 子句中。

```sql
SELECT name, salary
FROM employees
WHERE (salary, department) = (SELECT MAX(salary), department FROM employees GROUP BY department);
```

在这个例子中，子查询 `(SELECT MAX(salary), department FROM employees GROUP BY department)` 返回每个部门的最高工资和部门名称，主查询使用这些数据来过滤出每个部门中工资最高的员工。

### 表子查询

表子查询返回一个表，通常用于 `FROM` 子句中。

```sql
SELECT e.name, d.department_name
FROM (SELECT name, department_id FROM employees) AS e
JOIN (SELECT department_id, department_name FROM departments) AS d
ON e.department_id = d.department_id;
```

在这个例子中，子查询 `(SELECT name, department_id FROM employees)` 和 `(SELECT department_id, department_name FROM departments)` 分别返回员工表和部门表的一部分数据，主查询通过 `JOIN` 操作将这些数据连接起来。

## 实际应用场景

### 场景 1：过滤数据

假设你有一个 `orders` 表和一个 `customers` 表，你想找出所有在某个特定日期之后下单的客户。

```sql
SELECT customer_name
FROM customers
WHERE customer_id IN (SELECT customer_id FROM orders WHERE order_date > '2023-01-01');
```

在这个例子中，子查询 `(SELECT customer_id FROM orders WHERE order_date > '2023-01-01')` 返回所有在 2023 年 1 月 1 日之后下单的客户 ID，主查询使用这些 ID 来过滤出相应的客户名称。

### 场景 2：计算聚合值

假设你想找出每个部门的平均工资，并将其与每个员工的工资进行比较。

```sql
SELECT name, salary, (SELECT AVG(salary) FROM employees WHERE department = e.department) AS avg_salary
FROM employees e;
```

在这个例子中，子查询 `(SELECT AVG(salary) FROM employees WHERE department = e.department)` 返回每个部门的平均工资，主查询将其与每个员工的工资一起显示。

## 总结

子查询是 Apache Drill 中一个非常强大的工具，可以帮助你在一个查询中嵌套另一个查询，从而实现更复杂的数据操作。通过本文的介绍，你应该已经掌握了子查询的基本概念、语法和实际应用场景。

:::tip
练习是掌握子查询的最佳方式。尝试在你的数据集中使用子查询来解决实际问题，这将帮助你更好地理解和应用这一概念。
:::

## 附加资源

- [Apache Drill 官方文档](https://drill.apache.org/docs/)
- [SQL 子查询教程](https://www.w3schools.com/sql/sql_subqueries.asp)

通过不断练习和探索，你将能够熟练地在 Apache Drill 中使用子查询来处理各种复杂的数据分析任务。