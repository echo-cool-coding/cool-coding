---
title: R包持续集成
description: 了解如何在R包开发中使用持续集成（CI）工具，确保代码质量和自动化测试。
---

# R包持续集成

## 介绍

持续集成（Continuous Integration，简称CI）是一种软件开发实践，开发人员频繁地将代码更改集成到共享的主干（通常是版本控制系统如Git）中。每次集成都会触发自动构建和测试，以确保代码的质量和稳定性。对于R包开发来说，持续集成可以帮助开发者快速发现和修复问题，确保R包在不同环境中的兼容性。

在本教程中，我们将介绍如何在R包开发中使用持续集成工具，如GitHub Actions和Travis CI，来自动化测试和构建过程。

## 为什么需要持续集成？

在R包开发中，持续集成可以带来以下好处：

1. **自动化测试**：每次提交代码后，自动运行测试套件，确保新代码不会破坏现有功能。
2. **跨平台兼容性**：在不同的操作系统（如Windows、macOS、Linux）上测试R包，确保其在不同环境中的兼容性。
3. **快速反馈**：开发者可以快速获得测试结果，及时修复问题。
4. **代码质量**：通过自动化代码检查和测试，提高代码质量。

## 设置持续集成

### 1. 使用GitHub Actions

GitHub Actions是GitHub提供的一个持续集成和持续交付（CI/CD）平台。它允许你在GitHub仓库中自动化工作流程。

#### 步骤1：创建 `.github/workflows` 目录

在你的R包项目的根目录下，创建一个名为 `.github/workflows` 的目录。这个目录将存放GitHub Actions的工作流配置文件。

```bash
mkdir -p .github/workflows
```

#### 步骤2：创建 `R-CMD-check.yaml` 文件

在 `.github/workflows` 目录下创建一个名为 `R-CMD-check.yaml` 的文件，内容如下：

```yaml
name: R-CMD-check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    strategy:
      matrix:
        config:
          - {os: windows-latest, r: 'release'}
          - {os: macOS-latest, r: 'release'}
          - {os: ubuntu-latest, r: 'release'}

    steps:
      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-r@v1
        with:
          r-version: ${{ matrix.config.r }}

      - uses: r-lib/actions/setup-r-dependencies@v1
        with:
          packages: any::rcmdcheck

      - name: Check
        run: Rscript -e 'rcmdcheck::rcmdcheck(args = "--no-manual", error_on = "warning")'
```

这个工作流文件定义了在每次推送到 `main` 分支或创建拉取请求时，自动在Windows、macOS和Ubuntu上运行R CMD检查。

#### 步骤3：提交并推送更改

将更改提交到Git仓库并推送到GitHub：

```bash
git add .github/workflows/R-CMD-check.yaml
git commit -m "Add GitHub Actions workflow for R CMD check"
git push origin main
```

### 2. 使用Travis CI

Travis CI是另一个流行的持续集成工具，支持多种编程语言，包括R。

#### 步骤1：创建 `.travis.yml` 文件

在你的R包项目的根目录下，创建一个名为 `.travis.yml` 的文件，内容如下：

```yaml
language: r
r:
  - release
  - devel

os:
  - linux
  - osx

cache: packages

script: Rscript -e 'rcmdcheck::rcmdcheck(args = "--no-manual", error_on = "warning")'
```

这个配置文件定义了在Linux和macOS上运行R CMD检查，并使用R的稳定版和开发版进行测试。

#### 步骤2：启用Travis CI

1. 登录 [Travis CI](https://travis-ci.com/) 并启用你的GitHub仓库。
2. 将 `.travis.yml` 文件提交并推送到GitHub：

```bash
git add .travis.yml
git commit -m "Add Travis CI configuration"
git push origin main
```

## 实际案例

假设你正在开发一个名为 `mypackage` 的R包，并且你已经设置了GitHub Actions和Travis CI。每次你推送代码到GitHub时，GitHub Actions和Travis CI都会自动运行R CMD检查，确保你的代码在不同平台上都能正常工作。

例如，你添加了一个新的函数 `my_function`，并编写了相应的测试用例。当你推送代码后，GitHub Actions和Travis CI会自动运行测试，并生成测试报告。如果测试失败，你会收到通知，并可以根据报告中的信息修复问题。

## 总结

持续集成是R包开发中的一个重要实践，它可以帮助你自动化测试和构建过程，确保代码的质量和稳定性。通过使用GitHub Actions和Travis CI，你可以轻松地在不同平台上测试你的R包，并获得快速的反馈。

## 附加资源

- [GitHub Actions 官方文档](https://docs.github.com/en/actions)
- [Travis CI 官方文档](https://docs.travis-ci.com/)
- [R CMD check 文档](https://r-pkgs.org/check.html)

## 练习

1. 在你的R包项目中设置GitHub Actions，并运行R CMD检查。
2. 尝试在Travis CI中配置你的R包项目，并观察测试结果。
3. 添加一个新的函数到你的R包中，并编写相应的测试用例。观察持续集成工具如何自动运行测试并生成报告。

通过完成这些练习，你将更好地理解持续集成在R包开发中的应用。