---
title: CentOS Pacemaker 配置
description: 学习如何在 CentOS 上配置 Pacemaker，以实现高可用性集群。本文将从基础概念入手，逐步讲解配置步骤，并提供实际案例和代码示例。
---

# CentOS Pacemaker 配置

## 介绍

Pacemaker 是一个开源的高可用性集群资源管理器，常用于确保关键服务在集群中的高可用性。它能够监控集群中的资源状态，并在节点故障时自动将资源迁移到其他健康节点。本文将指导你如何在 CentOS 上配置 Pacemaker，以实现高可用性集群。

## 前置条件

在开始之前，请确保你已经具备以下条件：

- 至少两台运行 CentOS 的服务器。
- 所有节点之间可以通过 SSH 互相访问。
- 所有节点的时间同步（可以使用 NTP 服务）。
- 确保防火墙允许集群通信所需的端口。

## 安装 Pacemaker 和相关工具

首先，在所有节点上安装 Pacemaker 和相关工具：

```bash
sudo yum install -y pacemaker pcs corosync fence-agents-all
```

安装完成后，启动并启用 `pcsd` 服务：

```bash
sudo systemctl start pcsd
sudo systemctl enable pcsd
```

## 配置 Corosync

Corosync 是 Pacemaker 的底层通信层，负责节点之间的通信。我们需要在所有节点上配置 Corosync。

1. 生成 Corosync 的认证密钥：

   ```bash
   sudo pcs cluster auth <node1> <node2> -u hacluster -p <password>
   ```

2. 创建并启动集群：

   ```bash
   sudo pcs cluster setup --name mycluster <node1> <node2>
   sudo pcs cluster start --all
   ```

3. 启用集群自启动：

   ```bash
   sudo pcs cluster enable --all
   ```

## 配置 Pacemaker 资源

接下来，我们将配置 Pacemaker 资源。假设我们要配置一个高可用的 Apache HTTP 服务器。

1. 在所有节点上安装 Apache：

   ```bash
   sudo yum install -y httpd
   ```

2. 创建一个虚拟 IP 资源：

   ```bash
   sudo pcs resource create VirtualIP ocf:heartbeat:IPaddr2 ip=192.168.1.100 cidr_netmask=24 op monitor interval=30s
   ```

3. 创建一个 Apache 服务资源：

   ```bash
   sudo pcs resource create WebServer ocf:heartbeat:apache configfile=/etc/httpd/conf/httpd.conf op monitor interval=30s
   ```

4. 将资源绑定到同一个节点：

   ```bash
   sudo pcs constraint colocation add WebServer with VirtualIP INFINITY
   ```

5. 设置资源启动顺序：

   ```bash
   sudo pcs constraint order VirtualIP then WebServer
   ```

## 测试高可用性

现在，我们已经配置好了高可用的 Apache 服务。让我们测试一下集群的高可用性。

1. 在当前运行 Apache 的节点上停止 Apache 服务：

   ```bash
   sudo systemctl stop httpd
   ```

2. 观察 Pacemaker 是否将 Apache 服务迁移到另一个节点：

   ```bash
   sudo pcs status
   ```

你应该会看到 Apache 服务已经迁移到了另一个节点，并且虚拟 IP 也随之迁移。

## 实际案例

假设你有一个电子商务网站，需要确保网站在任何节点故障时都能继续运行。通过配置 Pacemaker，你可以将网站的前端服务器和后端数据库配置为高可用资源，确保即使某个节点发生故障，网站仍然可以正常访问。

## 总结

通过本文，你已经学会了如何在 CentOS 上配置 Pacemaker，以实现高可用性集群。我们介绍了 Pacemaker 的基本概念、安装步骤、资源配置以及如何测试高可用性。希望这些内容能帮助你构建一个稳定可靠的高可用性集群。

## 附加资源

- [Pacemaker 官方文档](https://clusterlabs.org/pacemaker/doc/)
- [Corosync 官方文档](https://corosync.github.io/corosync/)
- [高可用性集群设计指南](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/high_availability_add-on_reference/)

## 练习

1. 尝试配置一个高可用的 MySQL 数据库集群。
2. 模拟节点故障，观察 Pacemaker 如何自动迁移资源。
3. 研究如何配置更复杂的资源约束，例如资源的位置偏好。

:::