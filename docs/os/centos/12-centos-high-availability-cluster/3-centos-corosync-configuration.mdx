---
title: CentOS Corosync配置
description: 学习如何在CentOS中配置Corosync，以实现高可用集群的基础通信层。
---

# CentOS Corosync配置

## 介绍

Corosync是一个开源的集群引擎，用于在集群节点之间提供可靠的通信。它是高可用性（HA）集群的核心组件之一，通常与Pacemaker一起使用，以管理集群资源。Corosync通过心跳机制确保集群中的节点能够相互通信，并在节点故障时触发故障转移。

在本教程中，我们将逐步讲解如何在CentOS中配置Corosync，并展示如何将其应用于实际的高可用集群场景。

## 前提条件

在开始之前，请确保您已经具备以下条件：

- 两台或多台运行CentOS的服务器。
- 所有服务器之间的网络连接正常。
- 所有服务器的时间同步（可以使用NTP服务）。
- 具有root权限的用户。

## 安装Corosync

首先，我们需要在所有集群节点上安装Corosync。可以通过以下命令安装：

```bash
sudo yum install corosync
```

安装完成后，Corosync服务将自动启动。您可以使用以下命令检查其状态：

```bash
sudo systemctl status corosync
```

## 配置Corosync

Corosync的配置文件位于 `/etc/corosync/corosync.conf`。我们需要编辑此文件以配置集群节点和通信设置。

### 1. 配置集群节点

打开配置文件并添加以下内容：

```bash
sudo vi /etc/corosync/corosync.conf
```

在文件中，找到或添加以下部分：

```plaintext
totem {
    version: 2
    secauth: on
    cluster_name: mycluster
    transport: udpu
    interface {
        ringnumber: 0
        bindnetaddr: 192.168.1.0
        mcastport: 5405
        ttl: 1
    }
}

nodelist {
    node {
        ring0_addr: 192.168.1.101
        nodeid: 1
    }
    node {
        ring0_addr: 192.168.1.102
        nodeid: 2
    }
}

quorum {
    provider: corosync_votequorum
    two_node: 1
}

logging {
    to_logfile: yes
    logfile: /var/log/corosync/corosync.log
    to_syslog: yes
}
```

:::note
- `bindnetaddr` 应设置为集群网络的子网地址。
- `ring0_addr` 是每个节点的IP地址。
- `nodeid` 是每个节点的唯一标识符。
:::

### 2. 启动Corosync服务

配置完成后，启动Corosync服务：

```bash
sudo systemctl start corosync
sudo systemctl enable corosync
```

### 3. 验证集群状态

使用以下命令验证集群状态：

```bash
sudo corosync-cmapctl | grep members
```

输出应显示所有集群节点的信息，例如：

```plaintext
runtime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.1.101)
runtime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.1.102)
```

## 实际应用场景

假设我们有一个Web服务器集群，我们希望在其中实现高可用性。通过配置Corosync和Pacemaker，我们可以确保即使一个节点发生故障，Web服务仍然可以继续运行。

### 1. 配置Pacemaker

安装Pacemaker：

```bash
sudo yum install pacemaker pcs
```

启动并启用Pacemaker服务：

```bash
sudo systemctl start pcsd
sudo systemctl enable pcsd
```

### 2. 配置集群资源

使用Pacemaker配置Web服务器资源：

```bash
sudo pcs resource create WebServer ocf:heartbeat:apache \
    configfile=/etc/httpd/conf/httpd.conf \
    op monitor interval=30s
```

### 3. 测试故障转移

手动停止一个节点上的Corosync服务，观察Pacemaker是否将Web服务迁移到另一个节点。

```bash
sudo systemctl stop corosync
```

## 总结

通过本教程，您已经学会了如何在CentOS中配置Corosync，并将其应用于高可用集群中。Corosync作为集群通信的核心组件，确保了节点之间的可靠通信，而Pacemaker则负责管理集群资源。

## 附加资源

- [Corosync官方文档](https://corosync.github.io/corosync/)
- [Pacemaker官方文档](https://clusterlabs.org/pacemaker/doc/)

## 练习

1. 尝试在三节点集群中配置Corosync，并验证集群状态。
2. 配置一个高可用的NFS服务器，使用Corosync和Pacemaker管理NFS资源。
3. 模拟节点故障，观察集群如何自动恢复。

通过完成这些练习，您将更深入地理解Corosync在高可用集群中的作用。