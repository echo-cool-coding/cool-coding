---
title: CentOS Ansible剧本
description: 学习如何使用 Ansible 剧本在 CentOS 系统中实现自动化运维。本文将从基础概念入手，逐步讲解如何编写和运行 Ansible 剧本，并通过实际案例展示其应用场景。
---

## 介绍

Ansible 是一种强大的自动化工具，广泛用于配置管理、应用部署和任务自动化。它使用 YAML 格式的剧本（Playbook）来描述任务，并通过 SSH 协议在目标主机上执行这些任务。Ansible 剧本是 Ansible 的核心组件之一，它允许你定义一系列任务，并以声明式的方式管理系统的状态。

在 CentOS 系统中，Ansible 剧本可以帮助你自动化常见的运维任务，例如安装软件包、配置服务、管理用户和权限等。本文将带你从零开始学习如何编写和运行 Ansible 剧本。

## 安装 Ansible

在开始编写 Ansible 剧本之前，首先需要在 CentOS 系统上安装 Ansible。你可以通过以下命令安装 Ansible：

```bash
sudo yum install epel-release -y
sudo yum install ansible -y
```

安装完成后，可以通过以下命令验证 Ansible 是否安装成功：

```bash
ansible --version
```

如果安装成功，你将看到 Ansible 的版本信息。

## 编写第一个 Ansible 剧本

Ansible 剧本是一个 YAML 文件，通常以 `.yml` 或 `.yaml` 为扩展名。下面是一个简单的 Ansible 剧本示例，用于在目标主机上安装 `httpd` 服务并启动它：

```yaml
---
- name: 安装并启动 httpd 服务
  hosts: all
  become: yes
  tasks:
    - name: 安装 httpd 包
      yum:
        name: httpd
        state: present

    - name: 启动 httpd 服务
      service:
        name: httpd
        state: started
```

### 解释

- `name`: 剧本的描述性名称。
- `hosts`: 指定目标主机或主机组。`all` 表示所有主机。
- `become`: 表示是否以超级用户权限运行任务。`yes` 表示使用 `sudo`。
- `tasks`: 定义要执行的任务列表。
  - `yum`: 使用 `yum` 模块安装软件包。
  - `service`: 使用 `service` 模块管理服务。

### 运行剧本

保存上述内容为 `install_httpd.yml` 文件，然后使用以下命令运行剧本：

```bash
ansible-playbook -i inventory install_httpd.yml
```

其中，`inventory` 是包含目标主机信息的清单文件。如果目标主机是本地主机，可以使用 `localhost` 作为清单。

## 实际案例：自动化部署 Web 应用

假设你需要在多台 CentOS 服务器上部署一个简单的 Web 应用。以下是一个更复杂的 Ansible 剧本示例，用于自动化部署：

```yaml
---
- name: 部署 Web 应用
  hosts: webservers
  become: yes
  tasks:
    - name: 安装必要的软件包
      yum:
        name:
          - httpd
          - git
          - python3
        state: present

    - name: 克隆 Web 应用代码
      git:
        repo: https://github.com/example/webapp.git
        dest: /var/www/html/webapp
        version: main

    - name: 配置 httpd 服务
      template:
        src: templates/httpd.conf.j2
        dest: /etc/httpd/conf/httpd.conf
      notify: 重启 httpd 服务

    - name: 确保 httpd 服务已启动
      service:
        name: httpd
        state: started

  handlers:
    - name: 重启 httpd 服务
      service:
        name: httpd
        state: restarted
```

### 解释

- `git`: 使用 `git` 模块从远程仓库克隆代码。
- `template`: 使用 `template` 模块生成配置文件。`templates/httpd.conf.j2` 是一个 Jinja2 模板文件。
- `handlers`: 定义在任务完成后执行的操作。例如，当配置文件更改时，重启 `httpd` 服务。

### 运行剧本

保存上述内容为 `deploy_webapp.yml` 文件，然后使用以下命令运行剧本：

```bash
ansible-playbook -i inventory deploy_webapp.yml
```

## 总结

通过本文，你已经学习了如何编写和运行 Ansible 剧本，并了解了如何在实际场景中应用 Ansible 进行自动化运维。Ansible 剧本的强大之处在于其简洁性和可扩展性，能够帮助你高效地管理多台服务器。

## 附加资源

- [Ansible 官方文档](https://docs.ansible.com/ansible/latest/index.html)
- [Ansible Playbook 最佳实践](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [YAML 语法指南](https://yaml.org/spec/)

## 练习

1. 编写一个 Ansible 剧本，用于在 CentOS 系统上安装并配置 `nginx` 服务。
2. 修改上述 Web 应用部署剧本，使其支持部署到不同的环境（如开发、测试、生产）。
3. 尝试使用 Ansible 的 `roles` 功能，将任务模块化并复用。

:::tip
在编写 Ansible 剧本时，建议使用 `ansible-lint` 工具来检查剧本的语法和最佳实践。
:::