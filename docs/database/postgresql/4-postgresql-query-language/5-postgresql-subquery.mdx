---
title: PostgreSQL 子查询
description: 了解如何在 PostgreSQL 中使用子查询，掌握嵌套查询的技巧，并通过实际案例提升查询能力。
---

# PostgreSQL 子查询

在 PostgreSQL 中，子查询（Subquery）是指嵌套在其他查询中的查询。子查询可以出现在 `SELECT`、`INSERT`、`UPDATE`、`DELETE` 语句中，也可以出现在 `WHERE` 或 `HAVING` 子句中。子查询的结果可以作为外层查询的条件或数据源，帮助我们实现更复杂的查询逻辑。

## 什么是子查询？

子查询是一个完整的查询语句，嵌套在另一个查询中。它可以返回单个值、一行数据或多行数据，具体取决于子查询的类型和用途。子查询通常用于以下场景：

- 在 `WHERE` 子句中作为条件。
- 在 `SELECT` 子句中作为计算字段。
- 在 `FROM` 子句中作为临时表。

子查询的执行顺序是从内到外，即先执行子查询，然后将结果传递给外层查询。

## 子查询的类型

根据返回结果的不同，子查询可以分为以下几类：

1. **标量子查询（Scalar Subquery）**：返回单个值的子查询，通常用于 `SELECT` 或 `WHERE` 子句中。
2. **行子查询（Row Subquery）**：返回一行数据的子查询。
3. **表子查询（Table Subquery）**：返回多行多列数据的子查询，通常用于 `FROM` 子句中。

## 标量子查询示例

标量子查询是最常见的子查询类型，它返回单个值。以下是一个简单的示例，查询员工表中工资最高的员工姓名：

```sql
SELECT name
FROM employees
WHERE salary = (SELECT MAX(salary) FROM employees);
```

在这个例子中，子查询 `(SELECT MAX(salary) FROM employees)` 返回员工表中的最高工资，然后外层查询根据这个值找到对应的员工姓名。

## 行子查询示例

行子查询返回一行数据，通常用于 `WHERE` 子句中与行进行比较。以下是一个示例，查询与某个员工具有相同职位和部门的其他员工：

```sql
SELECT name
FROM employees
WHERE (job_title, department) = (
    SELECT job_title, department
    FROM employees
    WHERE name = 'John Doe'
);
```

在这个例子中，子查询返回 `John Doe` 的职位和部门，外层查询根据这些信息找到具有相同职位和部门的其他员工。

## 表子查询示例

表子查询返回多行多列数据，通常用于 `FROM` 子句中作为临时表。以下是一个示例，查询每个部门的平均工资：

```sql
SELECT department, AVG(salary) AS avg_salary
FROM (
    SELECT department, salary
    FROM employees
) AS dept_salaries
GROUP BY department;
```

在这个例子中，子查询 `(SELECT department, salary FROM employees)` 返回所有员工的部门和工资数据，外层查询根据部门分组并计算平均工资。

## 实际应用场景

### 场景 1：查找没有订单的客户

假设我们有两个表：`customers` 和 `orders`。我们想要查找没有下过订单的客户。可以使用以下查询：

```sql
SELECT name
FROM customers
WHERE id NOT IN (
    SELECT customer_id
    FROM orders
);
```

在这个例子中，子查询返回所有下过订单的客户 ID，外层查询通过 `NOT IN` 找到没有下过订单的客户。

### 场景 2：查找工资高于部门平均工资的员工

假设我们有一个 `employees` 表，我们想要查找工资高于其所在部门平均工资的员工。可以使用以下查询：

```sql
SELECT name, salary, department
FROM employees e
WHERE salary > (
    SELECT AVG(salary)
    FROM employees
    WHERE department = e.department
);
```

在这个例子中，子查询计算每个部门的平均工资，外层查询根据这个值找到工资高于部门平均工资的员工。

## 总结

子查询是 PostgreSQL 中非常强大的工具，可以帮助我们实现复杂的查询逻辑。通过标量子查询、行子查询和表子查询，我们可以灵活地处理各种数据查询需求。在实际应用中，子查询常用于过滤数据、计算字段和生成临时表。

:::tip
在使用子查询时，务必注意性能问题。复杂的子查询可能会导致查询性能下降，尤其是在处理大数据集时。可以通过优化查询逻辑或使用索引来提高性能。
:::

## 附加资源与练习

- **练习 1**：编写一个查询，查找销售额最高的产品。
- **练习 2**：编写一个查询，查找每个部门的最高工资员工。
- **练习 3**：编写一个查询，查找没有购买过任何产品的客户。

通过以上练习，您可以进一步巩固对 PostgreSQL 子查询的理解和应用能力。祝您学习愉快！