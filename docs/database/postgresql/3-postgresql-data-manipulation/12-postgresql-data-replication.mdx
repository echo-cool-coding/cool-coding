---
title: PostgreSQL 数据复制
description: 了解PostgreSQL中的数据复制概念及其实现方式，掌握如何通过复制提高数据库的可用性和性能。
---

# PostgreSQL 数据复制

PostgreSQL数据复制是一种将数据从一个数据库服务器复制到另一个或多个数据库服务器的技术。通过数据复制，可以实现高可用性、负载均衡和灾难恢复等功能。对于初学者来说，理解数据复制的基本概念及其实现方式是掌握PostgreSQL的重要一步。

## 什么是数据复制？

数据复制是指将一个数据库中的数据同步到另一个数据库的过程。在PostgreSQL中，数据复制通常用于以下场景：

- **高可用性**：在主服务器出现故障时，备用服务器可以接管服务，确保系统持续运行。
- **负载均衡**：通过将读操作分发到多个服务器，减轻主服务器的负载。
- **灾难恢复**：在发生灾难性事件时，备用服务器可以快速恢复数据。

PostgreSQL支持多种复制方式，包括**流复制**、**逻辑复制**和**物理复制**。接下来，我们将逐步介绍这些复制方式。

## 流复制（Streaming Replication）

流复制是PostgreSQL中最常用的复制方式。它通过将主服务器的WAL（Write-Ahead Logging）日志实时传输到备用服务器来实现数据同步。

### 配置流复制

1. **在主服务器上配置**：
   在主服务器的`postgresql.conf`文件中，启用WAL日志归档并设置复制用户：

   ```plaintext
   wal_level = replica
   max_wal_senders = 5
   ```

   在`pg_hba.conf`文件中，允许备用服务器连接：

   ```plaintext
   host replication replicator 192.168.1.2/32 md5
   ```

2. **在备用服务器上配置**：
   使用`pg_basebackup`工具从主服务器获取基础备份：

   ```bash
   pg_basebackup -h 192.168.1.1 -U replicator -D /var/lib/pgsql/12/data -P -R
   ```

   在备用服务器的`postgresql.conf`文件中，设置`hot_standby`为`on`：

   ```plaintext
   hot_standby = on
   ```

3. **启动备用服务器**：
   启动备用服务器后，它将自动从主服务器接收WAL日志并应用。

### 流复制的实际应用

假设你有一个电子商务网站，主服务器负责处理订单和支付，而备用服务器用于生成报告和分析数据。通过流复制，备用服务器可以实时同步主服务器的数据，确保报告和分析的准确性。

## 逻辑复制（Logical Replication）

逻辑复制允许你在表级别进行数据复制。与流复制不同，逻辑复制是基于逻辑更改（如INSERT、UPDATE、DELETE）而不是物理WAL日志。

### 配置逻辑复制

1. **在主服务器上创建发布**：
   使用`CREATE PUBLICATION`命令创建一个发布：

   ```sql
   CREATE PUBLICATION my_publication FOR TABLE orders, customers;
   ```

2. **在备用服务器上创建订阅**：
   使用`CREATE SUBSCRIPTION`命令创建一个订阅：

   ```sql
   CREATE SUBSCRIPTION my_subscription
   CONNECTION 'host=192.168.1.1 dbname=mydb user=replicator password=secret'
   PUBLICATION my_publication;
   ```

### 逻辑复制的实际应用

假设你有一个多租户系统，每个租户的数据存储在不同的表中。通过逻辑复制，你可以选择性地复制特定租户的数据到备用服务器，而不需要复制整个数据库。

## 物理复制（Physical Replication）

物理复制是基于文件系统的复制方式，通常用于创建完全一致的备用服务器。物理复制适用于需要完全一致性的场景，如灾难恢复。

### 配置物理复制

1. **在主服务器上配置**：
   与流复制类似，启用WAL日志归档并设置复制用户。

2. **在备用服务器上配置**：
   使用`pg_basebackup`工具获取基础备份，并配置`recovery.conf`文件：

   ```plaintext
   standby_mode = 'on'
   primary_conninfo = 'host=192.168.1.1 user=replicator password=secret'
   ```

3. **启动备用服务器**：
   启动备用服务器后，它将自动从主服务器接收WAL日志并应用。

### 物理复制的实际应用

假设你有一个金融系统，需要确保数据的一致性和完整性。通过物理复制，你可以创建一个完全一致的备用服务器，用于灾难恢复。

## 总结

PostgreSQL数据复制是提高数据库可用性、性能和灾难恢复能力的关键技术。通过流复制、逻辑复制和物理复制，你可以根据不同的需求选择合适的复制方式。

:::tip
在实际应用中，建议根据业务需求选择合适的复制方式。例如，流复制适用于高可用性场景，逻辑复制适用于选择性复制场景，而物理复制适用于灾难恢复场景。
:::

## 附加资源

- [PostgreSQL官方文档 - 复制](https://www.postgresql.org/docs/current/replication.html)
- [PostgreSQL流复制配置指南](https://www.postgresql.org/docs/current/warm-standby.html)
- [PostgreSQL逻辑复制配置指南](https://www.postgresql.org/docs/current/logical-replication.html)

## 练习

1. 配置一个简单的流复制环境，确保主服务器和备用服务器之间的数据同步。
2. 尝试使用逻辑复制，选择性地复制特定表的数据到备用服务器。
3. 研究物理复制的配置，并模拟一个灾难恢复场景。

通过以上练习，你将更深入地理解PostgreSQL数据复制的概念及其应用。