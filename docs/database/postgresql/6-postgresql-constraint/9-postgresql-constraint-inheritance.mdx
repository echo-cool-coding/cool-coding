---
title: PostgreSQL 约束继承
description: 了解PostgreSQL中的约束继承机制，掌握如何在表继承中管理约束，并通过实际案例加深理解。
---

# PostgreSQL 约束继承

在PostgreSQL中，表继承是一种强大的功能，允许你创建一个表（子表）继承另一个表（父表）的结构和数据。然而，继承不仅仅是复制表结构，它还涉及到约束的继承。本文将详细介绍PostgreSQL中的约束继承机制，并通过实际案例帮助你理解其应用。

## 什么是约束继承？

在PostgreSQL中，当你创建一个子表并继承一个父表时，子表会自动继承父表的所有列定义。然而，约束（如主键、唯一约束、外键等）并不会自动继承。这意味着，如果你在父表上定义了约束，子表不会自动拥有这些约束，除非你显式地在子表上定义它们。

:::note
约束继承是PostgreSQL表继承机制的一部分，但它并不像列继承那样自动完成。你需要手动管理子表的约束。
:::

## 约束继承的工作原理

### 1. 列继承

当你创建一个子表并继承父表时，子表会自动继承父表的所有列。例如：

```sql
CREATE TABLE parent (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

CREATE TABLE child () INHERITS (parent);
```

在这个例子中，`child`表继承了`parent`表的所有列，即`id`和`name`。

### 2. 约束继承

尽管子表继承了父表的列，但它不会自动继承父表的约束。例如，`parent`表有一个主键约束`PRIMARY KEY (id)`，但`child`表不会自动拥有这个约束。你需要在子表上显式地定义约束：

```sql
CREATE TABLE child (
    PRIMARY KEY (id)
) INHERITS (parent);
```

### 3. 约束的独立性

子表和父表的约束是独立的。即使你在子表上定义了与父表相同的约束，它们也是独立的约束。这意味着，子表和父表可以有不同的约束行为。

## 实际案例

假设我们有一个`vehicles`表作为父表，`cars`和`trucks`表作为子表。我们希望`vehicles`表有一个唯一约束`vin`（车辆识别码），并且这个约束在子表中也适用。

```sql
CREATE TABLE vehicles (
    vin TEXT PRIMARY KEY,
    make TEXT NOT NULL,
    model TEXT NOT NULL
);

CREATE TABLE cars (
    num_doors INT
) INHERITS (vehicles);

CREATE TABLE trucks (
    payload_capacity INT
) INHERITS (vehicles);
```

在这个例子中，`vehicles`表有一个主键约束`PRIMARY KEY (vin)`。然而，`cars`和`trucks`表不会自动继承这个约束。我们需要在子表上显式地定义约束：

```sql
ALTER TABLE cars ADD PRIMARY KEY (vin);
ALTER TABLE trucks ADD PRIMARY KEY (vin);
```

现在，`cars`和`trucks`表都有了与`vehicles`表相同的主键约束。

## 约束继承的注意事项

1. **约束的独立性**：子表和父表的约束是独立的，即使它们看起来相同。
2. **约束的重复定义**：在子表上定义与父表相同的约束时，需要确保约束的定义一致。
3. **性能影响**：在大型继承层次结构中，约束的管理可能会影响性能，因此需要谨慎设计。

## 总结

PostgreSQL中的约束继承是一个需要手动管理的过程。虽然子表会自动继承父表的列，但约束需要显式地在子表上定义。通过理解约束继承的工作原理，并在实际应用中合理使用，你可以更好地设计和管理数据库表结构。

## 附加资源

- [PostgreSQL官方文档 - 表继承](https://www.postgresql.org/docs/current/ddl-inherit.html)
- [PostgreSQL官方文档 - 约束](https://www.postgresql.org/docs/current/ddl-constraints.html)

## 练习

1. 创建一个父表`employees`，包含`id`（主键）和`name`列。然后创建一个子表`managers`，继承`employees`表，并在`managers`表上显式地定义主键约束。
2. 在`employees`表上添加一个唯一约束`email`，并在`managers`表上显式地定义相同的约束。
3. 尝试在`managers`表上插入一条与`employees`表中`email`重复的记录，观察约束的行为。

通过完成这些练习，你将更深入地理解PostgreSQL中的约束继承机制。