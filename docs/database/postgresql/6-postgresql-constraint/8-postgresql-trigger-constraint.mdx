---
title: PostgreSQL 触发器约束
description: 了解 PostgreSQL 触发器约束的概念、用法及其在实际场景中的应用。本文适合初学者，包含代码示例和实际案例。
---

# PostgreSQL 触发器约束

PostgreSQL 触发器约束是一种强大的数据库工具，允许你在特定事件（如插入、更新或删除）发生时自动执行自定义逻辑。触发器可以用于强制执行复杂的业务规则、维护数据完整性或记录数据更改历史。

## 什么是触发器？

触发器是绑定到数据库表的特殊函数，当表上发生特定事件时自动执行。触发器通常用于以下场景：

- 数据验证：在插入或更新数据之前检查数据的有效性。
- 数据审计：记录数据更改的历史。
- 自动计算：在数据更改时自动更新相关字段。

### 触发器的类型

PostgreSQL 支持两种主要类型的触发器：

1. **行级触发器**：针对每一行数据触发，适用于需要对每一行进行操作的场景。
2. **语句级触发器**：针对整个 SQL 语句触发，适用于需要对整个操作进行处理的场景。

## 创建触发器

要创建触发器，首先需要定义一个触发器函数，然后将该函数绑定到表上的特定事件。

### 1. 定义触发器函数

触发器函数是一个 PL/pgSQL 函数，它定义了触发器执行时的逻辑。以下是一个简单的触发器函数示例：

```sql
CREATE OR REPLACE FUNCTION check_salary() 
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.salary < 0 THEN
        RAISE EXCEPTION 'Salary cannot be negative';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

在这个示例中，`check_salary` 函数检查新插入或更新的 `salary` 字段是否为负数。如果是负数，则抛出一个异常。

### 2. 创建触发器

接下来，将触发器函数绑定到表上的特定事件。以下是一个创建触发器的示例：

```sql
CREATE TRIGGER enforce_salary_constraint
BEFORE INSERT OR UPDATE ON employees
FOR EACH ROW EXECUTE FUNCTION check_salary();
```

在这个示例中，`enforce_salary_constraint` 触发器在 `employees` 表上的每次插入或更新操作之前执行 `check_salary` 函数。

## 实际案例

假设你有一个 `orders` 表，其中包含订单信息。你希望在插入新订单时自动计算订单的总金额，并将其存储在 `total_amount` 字段中。

### 1. 定义触发器函数

```sql
CREATE OR REPLACE FUNCTION calculate_total_amount() 
RETURNS TRIGGER AS $$
BEGIN
    NEW.total_amount = NEW.quantity * NEW.unit_price;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 2. 创建触发器

```sql
CREATE TRIGGER update_total_amount
BEFORE INSERT ON orders
FOR EACH ROW EXECUTE FUNCTION calculate_total_amount();
```

在这个案例中，每次插入新订单时，触发器会自动计算 `total_amount` 并将其存储在数据库中。

## 总结

PostgreSQL 触发器约束是一种强大的工具，可以帮助你自动执行复杂的业务逻辑，确保数据的一致性和完整性。通过定义触发器函数并将其绑定到表上的特定事件，你可以轻松实现数据验证、审计和自动计算等功能。

:::tip
在实际使用触发器时，务必注意触发器的性能影响。过多的触发器可能会导致数据库操作变慢，因此应谨慎使用。
:::

## 附加资源

- [PostgreSQL 官方文档 - 触发器](https://www.postgresql.org/docs/current/triggers.html)
- [PL/pgSQL 语言指南](https://www.postgresql.org/docs/current/plpgsql.html)

## 练习

1. 创建一个触发器，确保 `products` 表中的 `stock_quantity` 字段永远不会为负数。
2. 创建一个触发器，在 `customers` 表中插入新记录时自动生成一个唯一的客户编号。

通过完成这些练习，你将更好地理解 PostgreSQL 触发器约束的用法和应用场景。