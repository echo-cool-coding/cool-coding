---
title: PostgreSQL PL/Java
description: 了解如何在 PostgreSQL 中使用 PL/Java 编写存储过程和函数，扩展数据库功能。
---

# PostgreSQL PL/Java

PostgreSQL 是一个功能强大的开源关系型数据库管理系统，支持多种编程语言扩展。PL/Java 是 PostgreSQL 的一种扩展，允许开发者使用 Java 编写存储过程、触发器和函数。通过 PL/Java，您可以将 Java 的强大功能与 PostgreSQL 的数据库管理能力结合起来，实现更复杂的业务逻辑。

## 什么是 PL/Java？

PL/Java 是 PostgreSQL 的一个扩展模块，它允许您在数据库中直接运行 Java 代码。通过 PL/Java，您可以使用 Java 编写存储过程、触发器和函数，从而扩展 PostgreSQL 的功能。PL/Java 提供了一个桥梁，将 Java 的面向对象编程能力与 PostgreSQL 的数据库管理能力结合起来。

## 安装 PL/Java

在开始使用 PL/Java 之前，您需要确保 PostgreSQL 已经安装并运行。接下来，您需要安装 PL/Java 扩展模块。

1. **下载 PL/Java**：您可以从 [PL/Java 官方网站](https://github.com/tada/pljava) 下载最新版本的 PL/Java。
2. **编译和安装**：按照官方文档的说明编译并安装 PL/Java。
3. **启用 PL/Java**：在 PostgreSQL 中，使用以下命令启用 PL/Java 扩展：

   ```sql
   CREATE EXTENSION pljava;
   ```

## 编写第一个 PL/Java 函数

让我们从一个简单的例子开始，编写一个返回字符串的 PL/Java 函数。

1. **创建 Java 类**：首先，创建一个简单的 Java 类，例如 `HelloWorld.java`：

   ```java
   public class HelloWorld {
       public static String sayHello() {
           return "Hello, PL/Java!";
       }
   }
   ```

2. **编译 Java 类**：将 Java 类编译为 `.class` 文件：

   ```bash
   javac HelloWorld.java
   ```

3. **将 Java 类加载到 PostgreSQL**：使用 `sqlj.install_jar` 函数将编译后的 `.class` 文件加载到 PostgreSQL 中：

   ```sql
   SELECT sqlj.install_jar('file:///path/to/HelloWorld.jar', 'hello_world_jar', true);
   ```

4. **创建 PL/Java 函数**：在 PostgreSQL 中创建一个 PL/Java 函数，调用 Java 类中的方法：

   ```sql
   CREATE FUNCTION say_hello() RETURNS text AS 'HelloWorld.sayHello' LANGUAGE java;
   ```

5. **调用函数**：现在，您可以在 PostgreSQL 中调用这个函数：

   ```sql
   SELECT say_hello();
   ```

   输出结果将是：

   ```
   Hello, PL/Java!
   ```

## 实际应用场景

PL/Java 可以用于许多实际场景，例如：

- **复杂业务逻辑**：当 SQL 无法满足复杂的业务逻辑时，可以使用 Java 编写存储过程。
- **外部 API 调用**：通过 Java 调用外部 REST API 或 Web 服务，并将结果存储在数据库中。
- **数据处理**：使用 Java 进行复杂的数据处理和分析，然后将结果返回给数据库。

### 示例：调用外部 API

假设您需要从外部 API 获取天气数据并存储在数据库中。您可以使用 PL/Java 编写一个函数来完成这个任务。

1. **创建 Java 类**：

   ```java
   import java.net.HttpURLConnection;
   import java.net.URL;
   import java.io.BufferedReader;
   import java.io.InputStreamReader;

   public class WeatherAPI {
       public static String getWeather(String city) throws Exception {
           URL url = new URL("http://api.weatherapi.com/v1/current.json?key=YOUR_API_KEY&q=" + city);
           HttpURLConnection conn = (HttpURLConnection) url.openConnection();
           conn.setRequestMethod("GET");
           BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
           String inputLine;
           StringBuilder content = new StringBuilder();
           while ((inputLine = in.readLine()) != null) {
               content.append(inputLine);
           }
           in.close();
           conn.disconnect();
           return content.toString();
       }
   }
   ```

2. **编译并加载 Java 类**：按照前面的步骤编译并加载 Java 类。

3. **创建 PL/Java 函数**：

   ```sql
   CREATE FUNCTION get_weather(city text) RETURNS text AS 'WeatherAPI.getWeather' LANGUAGE java;
   ```

4. **调用函数**：

   ```sql
   SELECT get_weather('New York');
   ```

   这将返回纽约的当前天气数据。

## 总结

PL/Java 是一个强大的工具，允许您在 PostgreSQL 中使用 Java 编写存储过程、触发器和函数。通过 PL/Java，您可以扩展 PostgreSQL 的功能，实现更复杂的业务逻辑和数据处理任务。本文介绍了如何安装 PL/Java、编写简单的 PL/Java 函数，并通过实际案例展示了 PL/Java 的应用场景。

## 附加资源

- [PL/Java 官方文档](https://github.com/tada/pljava)
- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [Java 编程入门](https://docs.oracle.com/javase/tutorial/)

## 练习

1. 编写一个 PL/Java 函数，接受两个整数参数并返回它们的和。
2. 使用 PL/Java 调用一个外部 API，并将返回的 JSON 数据解析后存储在 PostgreSQL 表中。

:::tip
在编写 PL/Java 函数时，确保您的 Java 代码经过充分测试，以避免在数据库中运行时出现意外错误。
:::