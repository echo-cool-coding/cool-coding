---
title: PostgreSQL 存储过程
description: 了解如何在 PostgreSQL 中使用存储过程，掌握其基本语法、实际应用场景以及如何通过存储过程优化数据库操作。
---

## 什么是 PostgreSQL 存储过程？

PostgreSQL 存储过程是一组预编译的 SQL 语句，存储在数据库中，可以通过调用来执行。它们通常用于封装复杂的业务逻辑，简化数据库操作，并提高代码的可重用性和性能。存储过程可以接受输入参数，返回结果，并且可以在事务中执行。

:::note
存储过程与函数类似，但存储过程不返回值（除非使用 `OUT` 参数），而函数必须返回值。
:::

## 存储过程的基本语法

在 PostgreSQL 中，存储过程使用 `CREATE PROCEDURE` 语句定义。以下是一个简单的存储过程示例：

```sql
CREATE OR REPLACE PROCEDURE add_employee(
    emp_name VARCHAR,
    emp_salary NUMERIC
)
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO employees (name, salary) VALUES (emp_name, emp_salary);
END;
$$;
```

### 解释：
- `CREATE OR REPLACE PROCEDURE`：创建或替换存储过程。
- `add_employee`：存储过程的名称。
- `emp_name` 和 `emp_salary`：输入参数。
- `LANGUAGE plpgsql`：指定存储过程使用的语言为 PL/pgSQL。
- `AS $$ ... $$`：存储过程的主体，包含要执行的 SQL 语句。

### 调用存储过程

要调用存储过程，可以使用 `CALL` 语句：

```sql
CALL add_employee('John Doe', 50000);
```

### 输出：
执行上述语句后，`employees` 表中将插入一条新记录，包含 `name` 为 `'John Doe'` 和 `salary` 为 `50000` 的数据。

## 存储过程的实际应用场景

### 1. 批量数据处理

存储过程非常适合处理批量数据操作。例如，假设你需要为所有员工的薪水增加 10%，可以使用以下存储过程：

```sql
CREATE OR REPLACE PROCEDURE increase_salaries()
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE employees SET salary = salary * 1.10;
END;
$$;
```

调用该存储过程：

```sql
CALL increase_salaries();
```

### 2. 事务管理

存储过程可以在事务中执行，确保数据的一致性。例如，以下存储过程在插入新员工的同时记录操作日志：

```sql
CREATE OR REPLACE PROCEDURE add_employee_with_log(
    emp_name VARCHAR,
    emp_salary NUMERIC
)
LANGUAGE plpgsql
AS $$
BEGIN
    BEGIN
        INSERT INTO employees (name, salary) VALUES (emp_name, emp_salary);
        INSERT INTO logs (action, timestamp) VALUES ('Employee added', NOW());
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE EXCEPTION 'Failed to add employee: %', SQLERRM;
    END;
END;
$$;
```

调用该存储过程：

```sql
CALL add_employee_with_log('Jane Smith', 60000);
```

:::caution
在存储过程中使用事务时，务必处理异常情况，以避免数据不一致。
:::

## 存储过程的优势

1. **性能优化**：存储过程在数据库服务器上执行，减少了网络传输的开销。
2. **代码重用**：存储过程可以在多个应用程序中重复使用，减少代码冗余。
3. **安全性**：通过存储过程，可以限制对底层数据的直接访问，提高数据安全性。
4. **事务管理**：存储过程可以封装复杂的事务逻辑，确保数据的一致性。

## 总结

PostgreSQL 存储过程是强大的工具，能够帮助开发者封装复杂的业务逻辑，优化数据库操作，并提高应用程序的性能和安全性。通过本文的学习，你应该已经掌握了存储过程的基本语法、实际应用场景以及如何调用存储过程。

## 附加资源与练习

### 附加资源：
- [PostgreSQL 官方文档 - 存储过程](https://www.postgresql.org/docs/current/sql-createprocedure.html)
- [PL/pgSQL 语言指南](https://www.postgresql.org/docs/current/plpgsql.html)

### 练习：
1. 创建一个存储过程，用于删除指定 ID 的员工记录，并记录删除操作到日志表中。
2. 修改 `increase_salaries` 存储过程，使其仅对薪水低于某个阈值的员工进行加薪。

通过实践这些练习，你将更深入地理解 PostgreSQL 存储过程的使用方法。