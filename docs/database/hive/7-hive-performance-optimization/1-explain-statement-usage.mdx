---
title: EXPLAIN语句使用
description: 了解如何使用Hive中的EXPLAIN语句来分析查询计划，优化查询性能。
---

# EXPLAIN语句使用

在Hive中，`EXPLAIN`语句是一个强大的工具，用于分析查询的执行计划。通过`EXPLAIN`，你可以深入了解Hive是如何执行你的查询的，从而帮助你优化查询性能。本文将详细介绍`EXPLAIN`语句的使用方法，并通过实际案例展示其应用场景。

## 什么是EXPLAIN语句？

`EXPLAIN`语句用于显示Hive查询的执行计划。执行计划是Hive在执行查询时所采取的一系列步骤的详细描述。通过查看执行计划，你可以了解查询的各个阶段，识别潜在的性能瓶颈，并采取相应的优化措施。

## 如何使用EXPLAIN语句？

使用`EXPLAIN`语句非常简单。只需在查询前加上`EXPLAIN`关键字即可。例如：

```sql
EXPLAIN
SELECT * FROM employees WHERE department = 'Engineering';
```

执行上述语句后，Hive将返回查询的执行计划。执行计划通常包括以下几个部分：

1. **抽象语法树（AST）**：显示查询的语法结构。
2. **逻辑计划（Logical Plan）**：显示查询的逻辑执行步骤。
3. **物理计划（Physical Plan）**：显示查询的物理执行步骤。
4. **优化后的计划（Optimized Plan）**：显示经过优化后的执行计划。

### 示例输出

```plaintext
STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-0 depends on stages: Stage-1

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: employees
            filterExpr: (department = 'Engineering') (type: boolean)
            Statistics: Num rows: 1000 Data size: 100000 Basic stats: COMPLETE Column stats: NONE
            Select Operator
              expressions: id (type: int), name (type: string), department (type: string)
              outputColumnNames: _col0, _col1, _col2
              Statistics: Num rows: 1000 Data size: 100000 Basic stats: COMPLETE Column stats: NONE
              File Output Operator
                compressed: false
                Statistics: Num rows: 1000 Data size: 100000 Basic stats: COMPLETE Column stats: NONE
                table:
                    input format: org.apache.hadoop.mapred.TextInputFormat
                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink
```

## 逐步讲解执行计划

### 1. 抽象语法树（AST）

抽象语法树是查询的语法结构表示。它显示了查询的各个组成部分，如`SELECT`、`FROM`、`WHERE`等。

### 2. 逻辑计划（Logical Plan）

逻辑计划显示了查询的逻辑执行步骤。它描述了Hive如何将查询分解为一系列逻辑操作，如`TableScan`、`Filter`、`Select`等。

### 3. 物理计划（Physical Plan）

物理计划显示了查询的物理执行步骤。它描述了Hive如何将逻辑操作转换为物理操作，如`MapReduce`任务。

### 4. 优化后的计划（Optimized Plan）

优化后的计划显示了经过优化后的执行计划。Hive会对查询进行一系列优化，如谓词下推、列裁剪等，以提高查询性能。

## 实际案例

假设我们有一个包含100万条记录的`employees`表，我们想要查询所有在`Engineering`部门的员工。我们可以使用`EXPLAIN`语句来分析查询的执行计划：

```sql
EXPLAIN
SELECT * FROM employees WHERE department = 'Engineering';
```

通过分析执行计划，我们发现查询使用了全表扫描（`TableScan`），这在大数据量下可能会导致性能问题。为了优化查询，我们可以为`department`列创建索引：

```sql
CREATE INDEX department_index ON TABLE employees (department) AS 'COMPACT' WITH DEFERRED REBUILD;
ALTER INDEX department_index ON employees REBUILD;
```

再次使用`EXPLAIN`语句分析查询，我们发现查询现在使用了索引扫描（`IndexScan`），从而大大提高了查询性能。

## 总结

`EXPLAIN`语句是Hive中一个非常有用的工具，用于分析查询的执行计划。通过理解执行计划，你可以识别查询中的性能瓶颈，并采取相应的优化措施。希望本文能帮助你更好地理解和使用`EXPLAIN`语句。

## 附加资源

- [Hive官方文档](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Explain)
- [Hive性能优化指南](https://cwiki.apache.org/confluence/display/Hive/Performance+Optimization)

## 练习

1. 使用`EXPLAIN`语句分析一个简单的查询，并尝试理解其执行计划。
2. 尝试为查询中的某个列创建索引，并使用`EXPLAIN`语句比较优化前后的执行计划。
