---
title: CLUSTER BY 用法
description: 了解 HiveQL 中的 CLUSTER BY 子句，掌握其语法、用途以及在实际查询中的应用场景。
---

## 介绍

在 HiveQL 中，`CLUSTER BY` 是一种用于对数据进行排序和分区的子句。它结合了 `DISTRIBUTE BY` 和 `SORT BY` 的功能，能够在对数据进行分区的同时，确保每个分区内的数据是有序的。这对于优化查询性能和减少数据倾斜非常有用。

`CLUSTER BY` 通常用于处理大规模数据集，尤其是在需要对数据进行分组和排序的场景中。通过使用 `CLUSTER BY`，你可以确保数据在分布式环境中被均匀分布，并且每个分区内的数据是有序的。

## 语法

`CLUSTER BY` 的基本语法如下：

```sql
SELECT column1, column2, ...
FROM table_name
CLUSTER BY column_name;
```

- `column_name`：指定用于分区和排序的列。

## 工作原理

`CLUSTER BY` 的工作原理可以分为两个步骤：

1. **分区（Distribute）**：根据指定的列对数据进行分区。Hive 会使用哈希函数将数据分配到不同的分区中。
2. **排序（Sort）**：在每个分区内，数据会根据指定的列进行排序。

:::note
`CLUSTER BY` 只能指定一个列。如果你需要根据多个列进行分区和排序，可以使用 `DISTRIBUTE BY` 和 `SORT BY` 的组合。
:::

## 代码示例

假设我们有一个名为 `sales` 的表，其中包含以下数据：

| id  | product | sales_amount | region |
|-----|---------|--------------|--------|
| 1   | A       | 100          | North  |
| 2   | B       | 200          | South  |
| 3   | A       | 150          | North  |
| 4   | C       | 300          | East   |
| 5   | B       | 250          | South  |
| 6   | C       | 400          | East   |

我们可以使用 `CLUSTER BY` 对 `region` 列进行分区和排序：

```sql
SELECT id, product, sales_amount, region
FROM sales
CLUSTER BY region;
```

执行上述查询后，数据将根据 `region` 列进行分区，并且每个分区内的数据将根据 `region` 列进行排序。输出结果可能如下：

| id  | product | sales_amount | region |
|-----|---------|--------------|--------|
| 4   | C       | 300          | East   |
| 6   | C       | 400          | East   |
| 1   | A       | 100          | North  |
| 3   | A       | 150          | North  |
| 2   | B       | 200          | South  |
| 5   | B       | 250          | South  |

:::tip
在实际应用中，`CLUSTER BY` 通常用于优化查询性能，尤其是在需要对数据进行分组和排序的场景中。
:::

## 实际应用场景

### 场景 1：数据分区与排序

假设你有一个包含数百万条记录的日志表，你需要根据 `user_id` 对数据进行分区，并且每个分区内的数据需要根据 `timestamp` 进行排序。使用 `CLUSTER BY` 可以轻松实现这一需求：

```sql
SELECT user_id, timestamp, log_message
FROM logs
CLUSTER BY user_id;
```

### 场景 2：减少数据倾斜

在大规模数据处理中，数据倾斜是一个常见问题。通过使用 `CLUSTER BY`，你可以确保数据在分布式环境中被均匀分布，从而减少数据倾斜的可能性。

```sql
SELECT category, SUM(sales_amount) AS total_sales
FROM sales
CLUSTER BY category;
```

## 总结

`CLUSTER BY` 是 HiveQL 中一个强大的工具，它结合了 `DISTRIBUTE BY` 和 `SORT BY` 的功能，能够在对数据进行分区的同时，确保每个分区内的数据是有序的。通过使用 `CLUSTER BY`，你可以优化查询性能，减少数据倾斜，并简化数据处理流程。

## 附加资源与练习

- **练习 1**：在一个包含 `employee_id`、`department` 和 `salary` 的表中，使用 `CLUSTER BY` 对 `department` 列进行分区和排序。
- **练习 2**：尝试在一个大规模数据集中使用 `CLUSTER BY`，并观察其对查询性能的影响。

:::caution
在使用 `CLUSTER BY` 时，请确保选择的列具有足够的区分度，以避免数据倾斜问题。
:::