---
title: MySQL 函数递归
description: 了解MySQL中的递归函数，掌握如何通过递归解决复杂问题，并通过实际案例加深理解。
---

# MySQL 函数递归

在编程中，**递归**是一种函数调用自身的技术。它通常用于解决可以分解为更小、相似子问题的问题。MySQL也支持递归函数，尤其是在处理层次结构数据（如树形结构）时非常有用。

## 什么是递归函数？

递归函数是一种在定义中调用自身的函数。它通常包含两个部分：
1. **基线条件（Base Case）**：这是递归停止的条件。如果没有基线条件，递归将无限进行，导致栈溢出。
2. **递归条件（Recursive Case）**：这是函数调用自身的部分，通常会将问题分解为更小的子问题。

在MySQL中，递归通常通过**存储过程**或**递归公用表表达式（CTE）**来实现。本文将重点介绍如何使用递归CTE来实现递归功能。

## 递归CTE的基本语法

递归CTE（Common Table Expression）是MySQL 8.0引入的功能，允许你在查询中定义临时结果集，并在其中使用递归。以下是递归CTE的基本语法：

```sql
WITH RECURSIVE cte_name AS (
    -- 初始查询（非递归部分）
    SELECT ...
    UNION ALL
    -- 递归查询
    SELECT ...
    FROM cte_name
    WHERE ...
)
SELECT * FROM cte_name;
```

- `WITH RECURSIVE`：声明一个递归CTE。
- `cte_name`：CTE的名称。
- 初始查询：这是递归的起点，通常返回一组初始数据。
- 递归查询：这是递归部分，它会不断调用自身，直到满足停止条件。

## 递归CTE的示例

### 示例1：计算阶乘

阶乘是一个经典的递归问题。我们可以使用递归CTE来计算一个数的阶乘。

```sql
WITH RECURSIVE factorial AS (
    -- 初始查询
    SELECT 1 AS n, 1 AS result
    UNION ALL
    -- 递归查询
    SELECT n + 1, result * (n + 1)
    FROM factorial
    WHERE n < 5
)
SELECT * FROM factorial;
```

**输出：**

| n  | result |
|----|--------|
| 1  | 1      |
| 2  | 2      |
| 3  | 6      |
| 4  | 24     |
| 5  | 120    |

在这个例子中，我们计算了5的阶乘。初始查询返回`n=1`和`result=1`，然后递归查询不断将`n`增加1，并将`result`乘以新的`n`，直到`n`达到5。

### 示例2：遍历树形结构

假设我们有一个表示员工和经理关系的表`employees`，结构如下：

```sql
CREATE TABLE employees (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    manager_id INT
);
```

表中数据如下：

| id | name   | manager_id |
|----|--------|------------|
| 1  | Alice  | NULL       |
| 2  | Bob    | 1          |
| 3  | Charlie| 2          |
| 4  | David  | 2          |
| 5  | Eve    | 1          |

我们可以使用递归CTE来查找某个员工的所有下属：

```sql
WITH RECURSIVE subordinates AS (
    -- 初始查询：找到直接下属
    SELECT id, name, manager_id
    FROM employees
    WHERE manager_id = 1
    UNION ALL
    -- 递归查询：找到下属的下属
    SELECT e.id, e.name, e.manager_id
    FROM employees e
    INNER JOIN subordinates s ON e.manager_id = s.id
)
SELECT * FROM subordinates;
```

**输出：**

| id | name    | manager_id |
|----|---------|------------|
| 2  | Bob     | 1          |
| 5  | Eve     | 1          |
| 3  | Charlie | 2          |
| 4  | David   | 2          |

在这个例子中，我们找到了`Alice`（`id=1`）的所有直接和间接下属。

## 实际应用场景

递归在以下场景中非常有用：
1. **层次结构数据**：如组织结构、文件系统、分类目录等。
2. **数学计算**：如阶乘、斐波那契数列等。
3. **图遍历**：如查找图中的路径或环。

## 总结

递归是一种强大的技术，可以帮助我们解决许多复杂的问题。在MySQL中，递归CTE是实现递归功能的主要工具。通过本文的学习，你应该已经掌握了如何使用递归CTE来解决实际问题。

:::tip
在使用递归时，务必注意基线条件，否则可能会导致无限递归和性能问题。
:::

## 附加资源与练习

1. **练习1**：编写一个递归CTE，计算斐波那契数列的前10个数。
2. **练习2**：假设你有一个表示文件系统的表，使用递归CTE查找某个文件夹下的所有文件和子文件夹。

希望本文对你理解MySQL中的递归函数有所帮助！继续练习，你将能够更熟练地运用递归解决实际问题。