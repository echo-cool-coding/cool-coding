---
title: MySQL 存储过程游标
description: 了解MySQL存储过程中的游标概念，学习如何使用游标逐行处理查询结果，并通过实际案例掌握其应用场景。
---

# MySQL 存储过程游标

## 介绍

在MySQL存储过程中，**游标（Cursor）** 是一种用于逐行处理查询结果的数据库对象。它允许你在存储过程中遍历查询结果集，并对每一行数据进行操作。游标特别适用于需要对查询结果进行复杂逻辑处理的场景。

:::note
游标通常用于处理需要逐行操作的查询结果，例如逐行更新、逐行插入或逐行删除数据。
:::

## 游标的基本概念

游标的工作流程可以分为以下几个步骤：

1. **声明游标**：定义一个游标，并将其与一个查询语句关联。
2. **打开游标**：执行查询语句，并将结果集加载到游标中。
3. **获取数据**：从游标中逐行获取数据。
4. **处理数据**：对获取到的每一行数据进行处理。
5. **关闭游标**：释放游标占用的资源。

## 游标的使用步骤

### 1. 声明游标

在存储过程中，使用 `DECLARE` 语句声明游标。游标必须与一个 `SELECT` 查询语句关联。

```sql
DECLARE cursor_name CURSOR FOR SELECT_statement;
```

例如：

```sql
DECLARE employee_cursor CURSOR FOR 
SELECT employee_id, first_name, last_name FROM employees;
```

### 2. 打开游标

使用 `OPEN` 语句打开游标，此时查询语句会被执行，结果集会被加载到游标中。

```sql
OPEN cursor_name;
```

例如：

```sql
OPEN employee_cursor;
```

### 3. 获取数据

使用 `FETCH` 语句从游标中逐行获取数据。通常，`FETCH` 语句会与循环结合使用，以便遍历整个结果集。

```sql
FETCH cursor_name INTO variable_list;
```

例如：

```sql
FETCH employee_cursor INTO emp_id, first_name, last_name;
```

### 4. 处理数据

在获取到数据后，可以对每一行数据进行处理。例如，可以将数据插入到另一个表中，或者根据条件进行更新。

```sql
-- 示例：将员工信息插入到另一个表中
INSERT INTO employee_backup (employee_id, first_name, last_name)
VALUES (emp_id, first_name, last_name);
```

### 5. 关闭游标

在处理完所有数据后，使用 `CLOSE` 语句关闭游标，释放资源。

```sql
CLOSE cursor_name;
```

例如：

```sql
CLOSE employee_cursor;
```

## 实际案例

假设我们有一个 `employees` 表，其中包含员工的 `employee_id`、`first_name` 和 `last_name`。我们需要将每个员工的信息插入到另一个表 `employee_backup` 中。

```sql
DELIMITER //

CREATE PROCEDURE backup_employees()
BEGIN
    DECLARE emp_id INT;
    DECLARE first_name VARCHAR(50);
    DECLARE last_name VARCHAR(50);
    DECLARE done INT DEFAULT FALSE;

    -- 声明游标
    DECLARE employee_cursor CURSOR FOR 
    SELECT employee_id, first_name, last_name FROM employees;

    -- 声明一个处理程序，用于检测游标是否已经遍历完所有行
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    -- 打开游标
    OPEN employee_cursor;

    -- 循环遍历游标
    read_loop: LOOP
        -- 获取数据
        FETCH employee_cursor INTO emp_id, first_name, last_name;

        -- 如果游标已经遍历完所有行，则退出循环
        IF done THEN
            LEAVE read_loop;
        END IF;

        -- 处理数据：将员工信息插入到备份表中
        INSERT INTO employee_backup (employee_id, first_name, last_name)
        VALUES (emp_id, first_name, last_name);
    END LOOP;

    -- 关闭游标
    CLOSE employee_cursor;
END //

DELIMITER ;
```

### 执行存储过程

```sql
CALL backup_employees();
```

### 结果

执行上述存储过程后，`employee_backup` 表中将包含与 `employees` 表相同的员工信息。

## 总结

游标是MySQL存储过程中一个强大的工具，它允许你逐行处理查询结果集。通过声明、打开、获取、处理和关闭游标，你可以对查询结果进行复杂的逻辑操作。游标特别适用于需要对每一行数据进行单独处理的场景。

:::tip
在使用游标时，务必注意资源的释放，及时关闭游标以避免内存泄漏。
:::

## 附加资源

- [MySQL官方文档：游标](https://dev.mysql.com/doc/refman/8.0/en/cursors.html)
- [MySQL存储过程教程](https://www.mysqltutorial.org/mysql-stored-procedure-tutorial.aspx)

## 练习

1. 创建一个存储过程，使用游标遍历 `orders` 表，并将每个订单的总金额累加到一个变量中。
2. 修改上述案例，使得在插入 `employee_backup` 表时，只插入 `first_name` 和 `last_name` 长度大于5的员工信息。

通过完成这些练习，你将更深入地理解游标的使用方法及其在实际开发中的应用。