---
title: MySQL 存储过程流程控制
description: 了解如何在MySQL存储过程中使用流程控制语句，包括条件判断、循环和异常处理，掌握编写高效存储过程的关键技巧。
---

# MySQL 存储过程流程控制

在MySQL存储过程中，流程控制是编写复杂逻辑的核心部分。通过流程控制语句，我们可以实现条件判断、循环执行以及异常处理等功能。本文将详细介绍MySQL存储过程中常用的流程控制语句，并通过实际案例帮助你理解其应用场景。

## 什么是流程控制？

流程控制是指通过特定的语句来控制程序的执行顺序。在MySQL存储过程中，流程控制语句允许我们根据条件执行不同的代码块，或者重复执行某些代码块。常见的流程控制语句包括：

- **条件判断**：`IF`、`CASE`
- **循环**：`LOOP`、`WHILE`、`REPEAT`
- **异常处理**：`DECLARE HANDLER`

接下来，我们将逐一介绍这些语句的用法。

---

## 条件判断

### IF 语句

`IF` 语句用于根据条件执行不同的代码块。它的基本语法如下：

```sql
IF condition THEN
    statements;
ELSEIF condition THEN
    statements;
ELSE
    statements;
END IF;
```

#### 示例

假设我们有一个存储过程，根据用户的年龄判断其是否为成年人：

```sql
DELIMITER //

CREATE PROCEDURE CheckAdult(IN age INT)
BEGIN
    IF age >= 18 THEN
        SELECT 'Adult' AS Result;
    ELSE
        SELECT 'Minor' AS Result;
    END IF;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL CheckAdult(20); -- 输出: Adult
CALL CheckAdult(15); -- 输出: Minor
```

### CASE 语句

`CASE` 语句类似于 `IF`，但更适合处理多条件分支。它的语法如下：

```sql
CASE
    WHEN condition THEN statements;
    WHEN condition THEN statements;
    ELSE statements;
END CASE;
```

#### 示例

根据用户的分数判断其等级：

```sql
DELIMITER //

CREATE PROCEDURE CheckGrade(IN score INT)
BEGIN
    CASE
        WHEN score >= 90 THEN SELECT 'A' AS Grade;
        WHEN score >= 80 THEN SELECT 'B' AS Grade;
        WHEN score >= 70 THEN SELECT 'C' AS Grade;
        ELSE SELECT 'F' AS Grade;
    END CASE;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL CheckGrade(95); -- 输出: A
CALL CheckGrade(75); -- 输出: C
```

---

## 循环

### LOOP 语句

`LOOP` 语句用于重复执行一段代码，直到满足退出条件。它的语法如下：

```sql
[label:] LOOP
    statements;
    IF condition THEN LEAVE label;
    END IF;
END LOOP;
```

#### 示例

计算1到10的和：

```sql
DELIMITER //

CREATE PROCEDURE SumNumbers()
BEGIN
    DECLARE total INT DEFAULT 0;
    DECLARE counter INT DEFAULT 1;

    myloop: LOOP
        SET total = total + counter;
        SET counter = counter + 1;
        IF counter > 10 THEN
            LEAVE myloop;
        END IF;
    END LOOP;

    SELECT total AS Result;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL SumNumbers(); -- 输出: 55
```

### WHILE 语句

`WHILE` 语句在条件为真时重复执行代码块。它的语法如下：

```sql
WHILE condition DO
    statements;
END WHILE;
```

#### 示例

计算1到10的和：

```sql
DELIMITER //

CREATE PROCEDURE SumNumbersWhile()
BEGIN
    DECLARE total INT DEFAULT 0;
    DECLARE counter INT DEFAULT 1;

    WHILE counter <= 10 DO
        SET total = total + counter;
        SET counter = counter + 1;
    END WHILE;

    SELECT total AS Result;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL SumNumbersWhile(); -- 输出: 55
```

### REPEAT 语句

`REPEAT` 语句与 `WHILE` 类似，但它会先执行代码块，再检查条件。它的语法如下：

```sql
REPEAT
    statements;
UNTIL condition
END REPEAT;
```

#### 示例

计算1到10的和：

```sql
DELIMITER //

CREATE PROCEDURE SumNumbersRepeat()
BEGIN
    DECLARE total INT DEFAULT 0;
    DECLARE counter INT DEFAULT 1;

    REPEAT
        SET total = total + counter;
        SET counter = counter + 1;
    UNTIL counter > 10
    END REPEAT;

    SELECT total AS Result;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL SumNumbersRepeat(); -- 输出: 55
```

---

## 异常处理

在存储过程中，可能会遇到错误或异常情况。MySQL提供了 `DECLARE HANDLER` 语句来处理这些异常。

### DECLARE HANDLER 语句

`DECLARE HANDLER` 用于定义异常处理程序。它的语法如下：

```sql
DECLARE handler_action HANDLER FOR condition_value statement;
```

- `handler_action`：可以是 `CONTINUE` 或 `EXIT`。
- `condition_value`：可以是错误代码或条件名称。
- `statement`：发生异常时执行的语句。

#### 示例

处理除零错误：

```sql
DELIMITER //

CREATE PROCEDURE SafeDivide(IN a INT, IN b INT)
BEGIN
    DECLARE result FLOAT;
    DECLARE CONTINUE HANDLER FOR SQLSTATE '22012'
    BEGIN
        SET result = NULL;
    END;

    SET result = a / b;
    SELECT result AS Result;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL SafeDivide(10, 2); -- 输出: 5
CALL SafeDivide(10, 0); -- 输出: NULL
```

---

## 实际案例

假设我们有一个订单表 `orders`，需要编写一个存储过程，根据订单金额判断是否为高价值订单，并记录日志。

```sql
DELIMITER //

CREATE PROCEDURE ProcessOrder(IN order_id INT)
BEGIN
    DECLARE order_amount DECIMAL(10, 2);
    DECLARE order_status VARCHAR(50);

    -- 获取订单金额
    SELECT amount INTO order_amount FROM orders WHERE id = order_id;

    -- 判断是否为高价值订单
    IF order_amount > 1000 THEN
        SET order_status = 'High Value';
    ELSE
        SET order_status = 'Normal';
    END IF;

    -- 记录日志
    INSERT INTO order_logs(order_id, status) VALUES (order_id, order_status);

    -- 返回结果
    SELECT order_status AS Result;
END //

DELIMITER ;
```

调用该存储过程：

```sql
CALL ProcessOrder(1); -- 根据订单金额输出 High Value 或 Normal
```

---

## 总结

MySQL存储过程的流程控制语句为我们提供了强大的工具，用于编写复杂的逻辑。通过条件判断、循环和异常处理，我们可以实现高效且健壮的存储过程。希望本文的内容能帮助你更好地理解和应用这些概念。

---

## 附加资源与练习

1. **练习**：编写一个存储过程，计算斐波那契数列的前N项。
2. **练习**：修改 `ProcessOrder` 存储过程，增加对订单状态的更多判断逻辑。
3. **参考**：[MySQL官方文档 - 流程控制](https://dev.mysql.com/doc/refman/8.0/en/flow-control-statements.html)

:::tip
在实际开发中，合理使用流程控制语句可以显著提高代码的可读性和可维护性。建议多练习并尝试将这些技巧应用到实际项目中。
:::