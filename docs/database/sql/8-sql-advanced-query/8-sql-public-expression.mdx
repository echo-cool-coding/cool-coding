---
title: SQL 公共表表达式
description: 了解SQL中的公共表表达式（CTE），掌握如何使用CTE简化复杂查询并提高代码可读性。
---

# SQL 公共表表达式

SQL公共表表达式（Common Table Expression，简称CTE）是一种临时命名的结果集，可以在SQL查询中多次引用。CTE通常用于简化复杂查询，提高代码的可读性和可维护性。本文将详细介绍CTE的概念、语法及其实际应用。

## 什么是公共表表达式？

公共表表达式（CTE）是一个临时的结果集，它只在查询执行期间存在。CTE可以被视为一个临时的视图，可以在同一个查询中多次引用。CTE的主要优点包括：

- **提高代码可读性**：将复杂的查询分解为多个简单的部分。
- **避免重复代码**：可以在同一个查询中多次引用CTE，而不需要重复编写相同的子查询。
- **支持递归查询**：CTE可以用于实现递归查询，这在处理层次结构数据时非常有用。

## CTE的基本语法

CTE的基本语法如下：

```sql
WITH cte_name AS (
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
)
SELECT *
FROM cte_name;
```

- `WITH` 关键字用于定义CTE。
- `cte_name` 是CTE的名称。
- `AS` 关键字后面是CTE的定义，通常是一个SELECT语句。
- 在CTE定义之后，可以在主查询中引用CTE。

### 示例：简单的CTE

假设我们有一个 `employees` 表，包含员工的姓名、部门和薪水信息。我们想要查询薪水高于平均薪水的员工。

```sql
WITH avg_salary AS (
    SELECT AVG(salary) AS avg_sal
    FROM employees
)
SELECT name, department, salary
FROM employees, avg_salary
WHERE salary > avg_salary.avg_sal;
```

在这个例子中，`avg_salary` 是一个CTE，它计算了所有员工的平均薪水。然后，主查询从 `employees` 表和 `avg_salary` CTE中选择薪水高于平均薪水的员工。

## 递归CTE

CTE的一个重要特性是支持递归查询。递归CTE通常用于处理层次结构数据，例如组织结构、文件系统等。

### 示例：递归CTE

假设我们有一个 `employees` 表，其中包含员工的ID、姓名和经理ID。我们想要查询某个员工的所有下属。

```sql
WITH RECURSIVE subordinates AS (
    SELECT id, name, manager_id
    FROM employees
    WHERE id = 1  -- 假设我们要查询ID为1的员工的所有下属
    UNION ALL
    SELECT e.id, e.name, e.manager_id
    FROM employees e
    INNER JOIN subordinates s ON e.manager_id = s.id
)
SELECT *
FROM subordinates;
```

在这个例子中，`subordinates` 是一个递归CTE。它首先选择ID为1的员工，然后递归地选择所有直接或间接向该员工汇报的下属。

## 实际应用场景

### 场景1：数据分层查询

在处理层次结构数据时，递归CTE非常有用。例如，查询组织结构中某个部门的所有员工，或者查询文件系统中某个目录下的所有文件。

### 场景2：复杂查询的简化

当查询涉及多个子查询或复杂的逻辑时，使用CTE可以将查询分解为多个简单的部分，从而提高代码的可读性和可维护性。

## 总结

SQL公共表表达式（CTE）是一种强大的工具，可以帮助我们简化复杂查询、提高代码的可读性和可维护性。通过使用CTE，我们可以将复杂的查询分解为多个简单的部分，并在同一个查询中多次引用这些部分。此外，递归CTE还可以用于处理层次结构数据。

## 附加资源与练习

- **练习1**：尝试在 `employees` 表中使用CTE查询每个部门的平均薪水，并显示薪水高于部门平均薪水的员工。
- **练习2**：使用递归CTE查询某个员工的所有上级经理。

通过练习这些例子，你将更好地理解CTE的概念和应用场景。继续探索SQL的高级功能，你将能够编写更高效、更易维护的查询。