---
title: SQL 递归查询
description: 学习如何使用SQL递归查询处理层次结构数据，掌握递归查询的基本语法和实际应用场景。
---

# SQL 递归查询

在SQL中，递归查询是一种强大的工具，用于处理具有层次结构或树形结构的数据。递归查询允许你在一个表中反复查询，直到满足特定条件为止。这种查询方式非常适合处理组织结构、文件系统、评论线程等具有父子关系的数据。

## 什么是递归查询？

递归查询是一种特殊的SQL查询，它通过反复调用自身来处理层次结构数据。递归查询通常用于处理以下场景：

- 组织结构：查询某个员工的所有下属。
- 文件系统：查询某个文件夹的所有子文件夹和文件。
- 评论线程：查询某个评论的所有回复。

递归查询的核心思想是通过一个初始查询（称为“锚点查询”）和一个递归查询（称为“递归部分”）来逐步构建结果集。

## 递归查询的基本语法

在SQL中，递归查询通常使用`WITH RECURSIVE`关键字来定义。以下是递归查询的基本语法：

```sql
WITH RECURSIVE 递归查询名称 AS (
    -- 锚点查询
    SELECT ...
    FROM ...
    WHERE ...

    UNION ALL

    -- 递归部分
    SELECT ...
    FROM 递归查询名称
    JOIN ...
    WHERE ...
)
SELECT * FROM 递归查询名称;
```

### 语法解释

- **锚点查询**：这是递归查询的起点，通常用于选择初始行。
- **递归部分**：这是递归查询的核心部分，它会反复执行，直到没有新的行被添加到结果集中。
- **UNION ALL**：用于将锚点查询和递归部分的结果合并。

## 递归查询的示例

假设我们有一个表示组织结构的表`employees`，其中包含员工的ID、姓名和经理ID（即该员工的上级）。我们的目标是查询某个员工的所有下属。

### 表结构

```sql
CREATE TABLE employees (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    manager_id INT
);
```

### 示例数据

```sql
INSERT INTO employees (id, name, manager_id) VALUES
(1, 'Alice', NULL),
(2, 'Bob', 1),
(3, 'Charlie', 1),
(4, 'David', 2),
(5, 'Eve', 2),
(6, 'Frank', 3);
```

### 递归查询示例

假设我们想要查询`Alice`的所有下属，可以使用以下递归查询：

```sql
WITH RECURSIVE subordinates AS (
    -- 锚点查询：选择Alice
    SELECT id, name, manager_id
    FROM employees
    WHERE name = 'Alice'

    UNION ALL

    -- 递归部分：选择Alice的所有下属
    SELECT e.id, e.name, e.manager_id
    FROM employees e
    INNER JOIN subordinates s ON e.manager_id = s.id
)
SELECT * FROM subordinates;
```

### 查询结果

| id  | name    | manager_id |
|-----|---------|------------|
| 1   | Alice   | NULL       |
| 2   | Bob     | 1          |
| 3   | Charlie | 1          |
| 4   | David   | 2          |
| 5   | Eve     | 2          |
| 6   | Frank   | 3          |

:::note
在这个例子中，递归查询首先选择`Alice`作为起点，然后通过递归部分逐步选择`Alice`的所有下属，直到没有新的下属被找到。
:::

## 实际应用场景

### 1. 组织结构查询

递归查询非常适合用于查询组织结构中的上下级关系。例如，你可以使用递归查询来查找某个部门的所有员工，或者某个员工的所有下属。

### 2. 文件系统查询

在文件系统中，文件夹和文件通常具有层次结构。你可以使用递归查询来查找某个文件夹下的所有子文件夹和文件。

### 3. 评论线程查询

在评论系统中，评论和回复通常形成树形结构。你可以使用递归查询来查找某个评论的所有回复。

## 总结

递归查询是SQL中处理层次结构数据的强大工具。通过`WITH RECURSIVE`关键字，你可以轻松地查询具有父子关系的数据。递归查询的核心思想是通过锚点查询和递归部分逐步构建结果集，直到满足特定条件为止。

## 附加资源与练习

- **练习1**：尝试修改上面的示例，查询`Bob`的所有下属。
- **练习2**：创建一个表示文件系统的表，并使用递归查询查找某个文件夹下的所有文件和子文件夹。
- **进一步学习**：了解更多关于SQL递归查询的高级用法，例如如何处理循环引用和限制递归深度。

:::tip
递归查询虽然强大，但在处理大数据集时可能会影响性能。因此，在使用递归查询时，务必注意优化查询性能。
:::