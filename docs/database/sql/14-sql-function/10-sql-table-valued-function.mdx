---
title: SQL 表值函数
description: 了解SQL表值函数的概念、语法及其在实际场景中的应用。本文适合初学者，包含代码示例和实际案例。
---

# SQL 表值函数

SQL表值函数（Table-Valued Function，简称TVF）是一种特殊的SQL函数，它返回一个表作为结果集。与标量函数（返回单个值）不同，表值函数可以返回多行多列的数据，这使得它在处理复杂查询时非常有用。

## 什么是表值函数？

表值函数是一种用户定义的函数，它返回一个表。这个表可以像普通表一样在查询中使用。表值函数通常用于封装复杂的逻辑，以便在多个查询中重复使用。

表值函数分为两种类型：
1. **内联表值函数（Inline Table-Valued Function）**：返回一个单一SELECT语句的结果集。
2. **多语句表值函数（Multi-Statement Table-Valued Function）**：允许在函数体内使用多个SQL语句来构建结果集。

## 内联表值函数

内联表值函数是最简单的表值函数类型。它只包含一个SELECT语句，并且返回该语句的结果集。

### 语法

```sql
CREATE FUNCTION function_name (@parameter1 data_type, @parameter2 data_type, ...)
RETURNS TABLE
AS
RETURN (
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
);
```

### 示例

假设我们有一个名为 `Employees` 的表，包含以下数据：

```sql
CREATE TABLE Employees (
    EmployeeID INT,
    FirstName NVARCHAR(50),
    LastName NVARCHAR(50),
    Department NVARCHAR(50)
);

INSERT INTO Employees (EmployeeID, FirstName, LastName, Department)
VALUES 
(1, 'John', 'Doe', 'HR'),
(2, 'Jane', 'Smith', 'IT'),
(3, 'Alice', 'Johnson', 'HR'),
(4, 'Bob', 'Brown', 'IT');
```

我们可以创建一个内联表值函数来返回某个部门的所有员工：

```sql
CREATE FUNCTION GetEmployeesByDepartment (@Department NVARCHAR(50))
RETURNS TABLE
AS
RETURN (
    SELECT EmployeeID, FirstName, LastName
    FROM Employees
    WHERE Department = @Department
);
```

### 使用表值函数

我们可以像使用普通表一样使用表值函数：

```sql
SELECT * FROM GetEmployeesByDepartment('HR');
```

**输出：**

| EmployeeID | FirstName | LastName |
|------------|-----------|----------|
| 1          | John      | Doe      |
| 3          | Alice     | Johnson  |

## 多语句表值函数

多语句表值函数允许在函数体内使用多个SQL语句来构建结果集。它比内联表值函数更灵活，但也更复杂。

### 语法

```sql
CREATE FUNCTION function_name (@parameter1 data_type, @parameter2 data_type, ...)
RETURNS @return_table TABLE (
    column1 data_type,
    column2 data_type,
    ...
)
AS
BEGIN
    -- SQL statements
    INSERT INTO @return_table (column1, column2, ...)
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition;

    RETURN;
END;
```

### 示例

假设我们想要创建一个函数，返回某个部门的所有员工，并且为每个员工添加一个 `FullName` 列：

```sql
CREATE FUNCTION GetEmployeesWithFullNameByDepartment (@Department NVARCHAR(50))
RETURNS @return_table TABLE (
    EmployeeID INT,
    FullName NVARCHAR(100),
    Department NVARCHAR(50)
)
AS
BEGIN
    INSERT INTO @return_table (EmployeeID, FullName, Department)
    SELECT EmployeeID, FirstName + ' ' + LastName AS FullName, Department
    FROM Employees
    WHERE Department = @Department;

    RETURN;
END;
```

### 使用表值函数

```sql
SELECT * FROM GetEmployeesWithFullNameByDepartment('IT');
```

**输出：**

| EmployeeID | FullName     | Department |
|------------|--------------|------------|
| 2          | Jane Smith   | IT         |
| 4          | Bob Brown    | IT         |

## 实际应用场景

表值函数在实际应用中非常有用，尤其是在需要封装复杂逻辑或重复使用某些查询时。以下是一些常见的应用场景：

1. **数据过滤**：通过表值函数可以轻松过滤出符合特定条件的数据。
2. **数据转换**：可以在表值函数中对数据进行转换或计算，例如拼接字符串、计算字段等。
3. **模块化查询**：将复杂的查询逻辑封装在表值函数中，使主查询更加简洁易读。

## 总结

SQL表值函数是一种强大的工具，它允许你返回一个表作为结果集。通过使用表值函数，你可以封装复杂的查询逻辑，使代码更加模块化和可重用。无论是内联表值函数还是多语句表值函数，它们都在处理复杂数据时提供了极大的灵活性。

## 附加资源

- [SQL Server官方文档 - 表值函数](https://docs.microsoft.com/en-us/sql/relational-databases/user-defined-functions/create-user-defined-functions-database-engine?view=sql-server-ver15)
- [SQL表值函数 vs 标量函数](https://www.sqlshack.com/table-valued-functions-vs-scalar-functions-in-sql-server/)

## 练习

1. 创建一个内联表值函数，返回所有工资高于某个值的员工。
2. 创建一个多语句表值函数，返回每个部门的员工数量。
3. 尝试在表值函数中使用JOIN操作，返回某个部门的所有员工及其经理的信息。

通过练习这些任务，你将更好地理解表值函数的使用方法和应用场景。