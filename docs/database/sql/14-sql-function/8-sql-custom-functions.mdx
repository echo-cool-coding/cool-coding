---
title: SQL 自定义函数
description: 了解如何在SQL中创建和使用自定义函数，以简化复杂查询并提高代码的可重用性。
---

# SQL 自定义函数

SQL自定义函数是用户定义的函数，允许你在SQL查询中封装复杂的逻辑，以便在多个地方重复使用。它们可以简化查询，提高代码的可读性和可维护性。本文将逐步介绍如何创建和使用SQL自定义函数，并通过实际案例展示其应用场景。

## 什么是SQL自定义函数？

SQL自定义函数是用户根据特定需求编写的函数，可以在SQL查询中调用。它们类似于编程语言中的函数，接受输入参数并返回一个值。SQL自定义函数可以分为两类：

1. **标量函数**：返回单个值。
2. **表值函数**：返回一个表。

本文将重点介绍标量函数，因为它们更常见且易于理解。

## 创建SQL自定义函数

在SQL中，创建自定义函数的语法如下：

```sql
CREATE FUNCTION function_name (parameter1 data_type, parameter2 data_type, ...)
RETURNS return_data_type
AS
BEGIN
    -- 函数逻辑
    RETURN value;
END;
```

### 示例：创建一个简单的标量函数

假设我们有一个需求：计算两个数的平均值。我们可以创建一个自定义函数来实现这一功能。

```sql
CREATE FUNCTION dbo.CalculateAverage (@num1 INT, @num2 INT)
RETURNS FLOAT
AS
BEGIN
    DECLARE @average FLOAT;
    SET @average = (@num1 + @num2) / 2.0;
    RETURN @average;
END;
```

### 调用自定义函数

创建函数后，可以在SQL查询中调用它：

```sql
SELECT dbo.CalculateAverage(10, 20) AS AverageValue;
```

**输出：**

```
AverageValue
------------
15.0
```

## 实际应用场景

### 场景1：计算订单总价

假设我们有一个订单表 `Orders`，其中包含 `Quantity` 和 `Price` 列。我们可以创建一个自定义函数来计算每个订单的总价。

```sql
CREATE FUNCTION dbo.CalculateTotalPrice (@quantity INT, @price DECIMAL(10, 2))
RETURNS DECIMAL(10, 2)
AS
BEGIN
    RETURN @quantity * @price;
END;
```

然后，我们可以在查询中使用这个函数：

```sql
SELECT OrderID, Quantity, Price, dbo.CalculateTotalPrice(Quantity, Price) AS TotalPrice
FROM Orders;
```

**输出：**

```
OrderID | Quantity | Price | TotalPrice
--------|----------|-------|------------
1       | 5        | 10.00 | 50.00
2       | 3        | 15.00 | 45.00
```

### 场景2：格式化日期

假设我们需要将日期格式化为 `YYYY-MM-DD` 的格式。我们可以创建一个自定义函数来实现这一功能。

```sql
CREATE FUNCTION dbo.FormatDate (@date DATE)
RETURNS VARCHAR(10)
AS
BEGIN
    RETURN CONVERT(VARCHAR(10), @date, 120);
END;
```

然后，我们可以在查询中使用这个函数：

```sql
SELECT OrderID, OrderDate, dbo.FormatDate(OrderDate) AS FormattedDate
FROM Orders;
```

**输出：**

```
OrderID | OrderDate  | FormattedDate
--------|------------|---------------
1       | 2023-10-01 | 2023-10-01
2       | 2023-10-02 | 2023-10-02
```

## 总结

SQL自定义函数是强大的工具，可以帮助你封装复杂的逻辑，提高代码的可重用性和可读性。通过创建自定义函数，你可以简化查询，减少重复代码，并提高开发效率。

:::tip
在实际开发中，尽量将常用的逻辑封装成自定义函数，以便在多个查询中重复使用。
:::

## 附加资源

- [SQL Server 官方文档](https://docs.microsoft.com/en-us/sql/t-sql/statements/create-function-transact-sql?view=sql-server-ver15)
- [MySQL 自定义函数指南](https://dev.mysql.com/doc/refman/8.0/en/create-function.html)

## 练习

1. 创建一个自定义函数，计算一个数的平方。
2. 创建一个自定义函数，将字符串转换为大写。
3. 创建一个自定义函数，计算两个日期之间的天数差。

通过完成这些练习，你将更好地理解SQL自定义函数的使用方法。