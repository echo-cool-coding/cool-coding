---
title: SQL 临时表
description: 了解SQL临时表的概念、用途以及如何在数据库中使用它们。本文包含代码示例、实际案例和总结，适合初学者学习。
---

# SQL 临时表

在SQL中，临时表是一种特殊类型的表，它仅在当前会话或事务中存在，并在会话结束或事务完成后自动删除。临时表非常适合用于存储中间结果或临时数据，尤其是在处理复杂查询或需要多次引用相同数据时。

## 什么是临时表？

临时表与普通表类似，但它们的作用范围仅限于创建它们的会话或事务。临时表的数据不会永久存储在数据库中，因此它们不会占用数据库的存储空间。临时表通常用于以下场景：

- 存储中间结果，以便在复杂查询中多次引用。
- 在事务中临时存储数据，以便在事务完成后自动清理。
- 在存储过程或函数中使用，以避免污染全局表空间。

## 创建临时表

在SQL中，创建临时表的语法与创建普通表非常相似，只是在表名前加上 `TEMPORARY` 关键字。以下是一个创建临时表的示例：

```sql
CREATE TEMPORARY TABLE temp_orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE,
    total_amount DECIMAL(10, 2)
);
```

在这个示例中，我们创建了一个名为 `temp_orders` 的临时表，用于存储订单信息。该表包含 `order_id`、`customer_id`、`order_date` 和 `total_amount` 四个字段。

## 插入数据到临时表

创建临时表后，您可以像操作普通表一样向其中插入数据。以下是一个插入数据的示例：

```sql
INSERT INTO temp_orders (order_id, customer_id, order_date, total_amount)
VALUES (1, 101, '2023-10-01', 99.99),
       (2, 102, '2023-10-02', 149.99);
```

插入数据后，您可以使用 `SELECT` 语句查询临时表中的数据：

```sql
SELECT * FROM temp_orders;
```

输出结果如下：

| order_id | customer_id | order_date | total_amount |
|----------|-------------|------------|--------------|
| 1        | 101         | 2023-10-01 | 99.99        |
| 2        | 102         | 2023-10-02 | 149.99       |

## 临时表的生命周期

临时表的生命周期取决于其创建方式：

- **会话级临时表**：在会话结束时自动删除。
- **事务级临时表**：在事务结束时自动删除。

以下是一个创建事务级临时表的示例：

```sql
CREATE TEMPORARY TABLE temp_cart (
    cart_id INT PRIMARY KEY,
    product_id INT,
    quantity INT
) ON COMMIT DELETE ROWS;
```

在这个示例中，`temp_cart` 表将在事务提交时自动删除所有行。

## 实际案例

假设您正在开发一个电子商务网站，需要计算每个客户的总订单金额。您可以使用临时表来存储中间结果，然后在最终查询中引用这些结果。

```sql
-- 创建临时表存储每个客户的总订单金额
CREATE TEMPORARY TABLE temp_customer_totals AS
SELECT customer_id, SUM(total_amount) AS total_spent
FROM orders
GROUP BY customer_id;

-- 查询临时表中的数据
SELECT * FROM temp_customer_totals;
```

在这个案例中，临时表 `temp_customer_totals` 存储了每个客户的总订单金额，您可以在后续查询中使用这些数据。

## 总结

临时表是SQL中非常有用的工具，特别适合用于存储中间结果或临时数据。它们不会永久占用数据库存储空间，并且在会话或事务结束后自动删除。通过使用临时表，您可以简化复杂查询并提高数据库操作的效率。

:::tip
在使用临时表时，请确保它们的作用范围仅限于当前会话或事务，以避免数据冲突或意外删除。
:::

## 附加资源

- [SQL临时表官方文档](https://www.sql.org/docs/temp-tables.html)
- [SQL临时表使用指南](https://www.sql-tutorial.com/temp-tables)

## 练习

1. 创建一个临时表 `temp_employees`，包含 `employee_id`、`name` 和 `salary` 字段，并插入一些示例数据。
2. 编写一个查询，计算每个部门的平均工资，并将结果存储在临时表 `temp_avg_salary` 中。
3. 尝试创建一个事务级临时表，并在事务提交后验证数据是否被删除。

通过这些练习，您将更好地理解临时表的使用场景和操作方法。