---
title: Elasticsearch Script处理器
description: 了解如何使用Elasticsearch的Script处理器在Ingest Pipeline中动态处理文档数据。本文适合初学者，包含代码示例和实际案例。
---

# Elasticsearch Script处理器

Elasticsearch的**Script处理器**是Ingest Pipeline中的一个强大工具，允许你在数据被索引之前动态地处理和转换文档。通过编写脚本，你可以执行复杂的逻辑操作，例如字段值的计算、条件判断、字符串操作等。本文将详细介绍Script处理器的基本概念、使用方法以及实际应用场景。

## 什么是Script处理器？

Script处理器是Elasticsearch Ingest Pipeline中的一个处理器，它允许你使用Painless脚本语言（Elasticsearch的默认脚本语言）对文档进行动态处理。Painless是一种安全、高效的脚本语言，专为Elasticsearch设计，支持简单的表达式和复杂的逻辑。

Script处理器的主要用途包括：
- 动态计算字段值
- 根据条件修改或删除字段
- 执行复杂的字符串操作
- 处理数组或嵌套字段

## 基本语法

Script处理器的基本语法如下：

```json
{
  "script": {
    "lang": "painless",
    "source": "脚本内容"
  }
}
```

- `lang`：指定脚本语言，通常为`painless`。
- `source`：包含实际脚本逻辑的字符串。

### 示例：简单字段操作

假设我们有一个文档，包含`price`和`quantity`字段，我们希望计算`total_price`字段的值。可以使用以下Script处理器：

```json
{
  "script": {
    "lang": "painless",
    "source": "ctx.total_price = ctx.price * ctx.quantity"
  }
}
```

**输入文档：**
```json
{
  "price": 10,
  "quantity": 5
}
```

**输出文档：**
```json
{
  "price": 10,
  "quantity": 5,
  "total_price": 50
}
```

:::tip
`ctx`是Elasticsearch中的上下文对象，表示当前正在处理的文档。你可以通过`ctx.field_name`访问或修改文档中的字段。
:::

## 实际应用场景

### 场景1：动态生成字段

假设你有一个包含用户信息的文档，其中包含`first_name`和`last_name`字段。你可以使用Script处理器动态生成`full_name`字段：

```json
{
  "script": {
    "lang": "painless",
    "source": "ctx.full_name = ctx.first_name + ' ' + ctx.last_name"
  }
}
```

**输入文档：**
```json
{
  "first_name": "John",
  "last_name": "Doe"
}
```

**输出文档：**
```json
{
  "first_name": "John",
  "last_name": "Doe",
  "full_name": "John Doe"
}
```

### 场景2：条件判断

假设你有一个包含`age`字段的文档，你希望根据年龄将用户分类为`adult`或`minor`：

```json
{
  "script": {
    "lang": "painless",
    "source": """
      if (ctx.age >= 18) {
        ctx.category = 'adult';
      } else {
        ctx.category = 'minor';
      }
    """
  }
}
```

**输入文档：**
```json
{
  "age": 20
}
```

**输出文档：**
```json
{
  "age": 20,
  "category": "adult"
}
```

:::caution
在编写条件判断时，确保逻辑清晰，避免复杂的嵌套条件，以提高脚本的可读性和性能。
:::

### 场景3：处理数组字段

假设你有一个包含`tags`数组字段的文档，你希望将所有标签转换为大写：

```json
{
  "script": {
    "lang": "painless",
    "source": """
      for (int i = 0; i < ctx.tags.length; i++) {
        ctx.tags[i] = ctx.tags[i].toUpperCase();
      }
    """
  }
}
```

**输入文档：**
```json
{
  "tags": ["elasticsearch", "script", "pipeline"]
}
```

**输出文档：**
```json
{
  "tags": ["ELASTICSEARCH", "SCRIPT", "PIPELINE"]
}
```

## 总结

Elasticsearch的Script处理器为数据处理提供了极大的灵活性。通过编写Painless脚本，你可以实现复杂的逻辑操作，动态生成字段，处理条件判断以及操作数组等。本文介绍了Script处理器的基本语法和实际应用场景，帮助你快速上手。

:::note
如果你想深入学习Painless脚本语言，可以参考[Elasticsearch官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-painless.html)。
:::

### 附加练习

1. 尝试编写一个Script处理器，将文档中的`date`字段转换为`YYYY-MM-DD`格式。
2. 编写一个脚本，根据`score`字段的值将文档分类为`high`、`medium`或`low`。
3. 使用Script处理器处理嵌套字段，例如将`user.address.city`字段的值转换为大写。

通过这些练习，你将更好地掌握Script处理器的使用技巧。