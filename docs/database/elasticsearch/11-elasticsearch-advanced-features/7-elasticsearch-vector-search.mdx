---
title: Elasticsearch 向量搜索
description: 了解Elasticsearch中的向量搜索功能，掌握如何使用向量进行高效的相似性搜索。
---

# Elasticsearch 向量搜索

Elasticsearch 是一个强大的分布式搜索引擎，广泛用于全文搜索、结构化搜索和数据分析。随着机器学习和人工智能的发展，向量搜索成为了 Elasticsearch 的一个重要功能。向量搜索允许我们通过向量（即一组数值）来表示数据，并通过计算向量之间的相似性来进行搜索。这种技术特别适用于处理非结构化数据，如图像、音频和文本。

## 什么是向量搜索？

向量搜索是一种基于向量相似性的搜索方法。在向量搜索中，数据被表示为向量（通常是高维空间中的点），搜索的目标是找到与查询向量最相似的向量。相似性通常通过计算向量之间的距离（如欧几里得距离或余弦相似度）来衡量。

### 为什么使用向量搜索？

- **处理非结构化数据**：向量搜索可以有效地处理图像、音频、文本等非结构化数据。
- **高效相似性搜索**：通过向量化表示，可以快速找到与查询数据相似的结果。
- **支持机器学习模型**：许多机器学习模型（如深度学习模型）的输出是向量，向量搜索可以直接利用这些向量进行搜索。

## Elasticsearch 中的向量搜索

Elasticsearch 从 7.0 版本开始支持向量搜索。通过使用 `dense_vector` 数据类型，Elasticsearch 可以存储和搜索向量数据。

### 1. 定义向量字段

首先，我们需要在 Elasticsearch 中定义一个 `dense_vector` 字段来存储向量数据。以下是一个示例映射：

```json
PUT /my_index
{
  "mappings": {
    "properties": {
      "my_vector": {
        "type": "dense_vector",
        "dims": 128
      },
      "text": {
        "type": "text"
      }
    }
  }
}
```

在这个示例中，`my_vector` 字段是一个 128 维的向量字段，`text` 字段是一个普通的文本字段。

### 2. 插入向量数据

接下来，我们可以向索引中插入一些包含向量数据的文档：

```json
POST /my_index/_doc/1
{
  "my_vector": [0.1, 0.2, 0.3, ..., 0.128],
  "text": "This is a sample document with a vector."
}

POST /my_index/_doc/2
{
  "my_vector": [0.4, 0.5, 0.6, ..., 0.128],
  "text": "Another document with a different vector."
}
```

### 3. 执行向量搜索

现在，我们可以使用 `script_score` 查询来执行向量搜索。以下是一个示例查询，它使用余弦相似度来计算向量之间的相似性：

```json
POST /my_index/_search
{
  "query": {
    "script_score": {
      "query": {
        "match_all": {}
      },
      "script": {
        "source": "cosineSimilarity(params.query_vector, 'my_vector') + 1.0",
        "params": {
          "query_vector": [0.1, 0.2, 0.3, ..., 0.128]
        }
      }
    }
  }
}
```

在这个查询中，`params.query_vector` 是查询向量，`cosineSimilarity` 函数用于计算查询向量与文档向量之间的余弦相似度。

### 4. 处理搜索结果

执行上述查询后，Elasticsearch 会返回与查询向量最相似的文档。搜索结果将根据相似度得分进行排序。

```json
{
  "took": 10,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 2,
      "relation": "eq"
    },
    "max_score": 1.8,
    "hits": [
      {
        "_index": "my_index",
        "_type": "_doc",
        "_id": "1",
        "_score": 1.8,
        "_source": {
          "my_vector": [0.1, 0.2, 0.3, ..., 0.128],
          "text": "This is a sample document with a vector."
        }
      },
      {
        "_index": "my_index",
        "_type": "_doc",
        "_id": "2",
        "_score": 1.5,
        "_source": {
          "my_vector": [0.4, 0.5, 0.6, ..., 0.128],
          "text": "Another document with a different vector."
        }
      }
    ]
  }
}
```

在这个结果中，文档 1 的相似度得分更高，因此它排在前面。

## 实际应用场景

### 1. 图像搜索

假设你有一个包含数百万张图片的数据库，每张图片都被转换为一个向量。你可以使用向量搜索来找到与查询图片最相似的图片。

### 2. 推荐系统

在推荐系统中，用户和物品可以被表示为向量。通过计算用户向量与物品向量之间的相似度，可以为用户推荐最相关的物品。

### 3. 自然语言处理

在自然语言处理中，文本可以被转换为向量（如通过 Word2Vec 或 BERT 模型）。通过向量搜索，可以找到与查询文本语义上最相似的文档。

## 总结

Elasticsearch 的向量搜索功能为处理非结构化数据提供了强大的工具。通过将数据表示为向量，并使用向量相似性进行搜索，我们可以实现高效的相似性搜索。无论是图像搜索、推荐系统还是自然语言处理，向量搜索都能发挥重要作用。

## 附加资源

- [Elasticsearch 官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/vector-search.html)
- [余弦相似度](https://en.wikipedia.org/wiki/Cosine_similarity)
- [Word2Vec](https://en.wikipedia.org/wiki/Word2vec)

## 练习

1. 创建一个包含 `dense_vector` 字段的 Elasticsearch 索引，并插入一些向量数据。
2. 使用 `script_score` 查询执行向量搜索，并分析搜索结果。
3. 尝试使用不同的相似度度量（如欧几里得距离）进行向量搜索。

:::tip
在实际应用中，向量搜索的性能可能会受到向量维度和数据量的影响。建议在高维向量搜索时使用专门的向量数据库（如 Faiss）来优化性能。
:::