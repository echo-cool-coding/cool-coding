---
title: Elasticsearch 复合查询构建
description: 学习如何使用 Elasticsearch 的复合查询 DSL 构建复杂的查询，结合多种查询条件以满足实际需求。
---

# Elasticsearch 复合查询构建

Elasticsearch 是一个强大的分布式搜索引擎，支持复杂的查询操作。在实际应用中，单一的查询条件往往无法满足需求，这时就需要使用**复合查询**。复合查询允许我们将多个查询条件组合在一起，以实现更精确的搜索。

本文将详细介绍 Elasticsearch 中的复合查询构建方法，包括 `bool` 查询、`constant_score` 查询等，并通过实际案例展示如何应用这些查询。

---

## 什么是复合查询？

复合查询是指将多个查询条件组合在一起，形成一个更复杂的查询逻辑。Elasticsearch 提供了多种复合查询类型，其中最常用的是 `bool` 查询。通过复合查询，我们可以实现以下功能：

- 组合多个查询条件（如 `must`、`should`、`must_not`、`filter`）。
- 控制查询条件的权重和优先级。
- 实现复杂的逻辑关系（如 AND、OR、NOT）。

---

## 复合查询的核心：`bool` 查询

`bool` 查询是 Elasticsearch 中最常用的复合查询类型。它允许我们通过以下子句组合多个查询条件：

- `must`：所有条件必须匹配（类似于 AND）。
- `should`：至少一个条件必须匹配（类似于 OR）。
- `must_not`：所有条件必须不匹配（类似于 NOT）。
- `filter`：类似于 `must`，但不参与评分，通常用于过滤。

### 示例：`bool` 查询的基本用法

以下是一个简单的 `bool` 查询示例，查找标题包含 "Elasticsearch" 且作者为 "John Doe" 的文档：

```json
{
  "query": {
    "bool": {
      "must": [
        { "match": { "title": "Elasticsearch" } },
        { "match": { "author": "John Doe" } }
      ]
    }
  }
}
```

**输入**：上述查询。<br />
**输出**：返回所有标题包含 "Elasticsearch" 且作者为 "John Doe" 的文档。

---

## 其他复合查询类型

除了 `bool` 查询，Elasticsearch 还提供了其他复合查询类型，例如：

### 1. `constant_score` 查询

`constant_score` 查询将内部的查询结果包装为一个固定分数。它通常与 `filter` 子句一起使用，适用于不需要评分的场景。

```json
{
  "query": {
    "constant_score": {
      "filter": {
        "term": { "status": "published" }
      },
      "boost": 1.2
    }
  }
}
```

**输入**：上述查询。<br />
**输出**：返回所有状态为 "published" 的文档，并为它们分配一个固定分数 1.2。

### 2. `dis_max` 查询

`dis_max` 查询用于在多个查询条件中选择最佳匹配的文档。它适用于需要从多个字段中查找最佳结果的场景。

```json
{
  "query": {
    "dis_max": {
      "queries": [
        { "match": { "title": "Elasticsearch" } },
        { "match": { "description": "Elasticsearch" } }
      ],
      "tie_breaker": 0.7
    }
  }
}
```

**输入**：上述查询。<br />
**输出**：返回在 `title` 或 `description` 字段中匹配 "Elasticsearch" 的文档，并为次优匹配分配 0.7 的权重。

---

## 实际案例：电商商品搜索

假设我们正在为一个电商网站构建搜索功能，用户可以通过以下条件筛选商品：

1. 商品名称包含 "手机"。
2. 价格在 1000 到 5000 之间。
3. 品牌为 "Apple" 或 "Samsung"。
4. 排除已下架的商品。

我们可以使用 `bool` 查询来实现这一需求：

```json
{
  "query": {
    "bool": {
      "must": [
        { "match": { "name": "手机" } },
        { "range": { "price": { "gte": 1000, "lte": 5000 } } }
      ],
      "should": [
        { "term": { "brand": "Apple" } },
        { "term": { "brand": "Samsung" } }
      ],
      "minimum_should_match": 1,
      "must_not": [
        { "term": { "status": "下架" } }
      ]
    }
  }
}
```

**输入**：上述查询。<br />
**输出**：返回所有符合条件的商品。

---

## 总结

Elasticsearch 的复合查询功能非常强大，能够满足各种复杂的搜索需求。通过 `bool` 查询、`constant_score` 查询和 `dis_max` 查询等，我们可以灵活地组合多个查询条件，实现精确的搜索逻辑。

:::tip 提示
在实际使用中，建议根据具体需求选择合适的复合查询类型，并合理使用 `filter` 子句以提高查询性能。
:::

---

## 附加资源与练习

1. **官方文档**：[Elasticsearch Query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)
2. **练习**：尝试构建一个复合查询，查找标题包含 "编程" 且发布日期在 2023 年之后的文档，同时排除作者为 "Unknown" 的文档。

通过不断练习和实践，你将能够熟练掌握 Elasticsearch 的复合查询构建技巧！