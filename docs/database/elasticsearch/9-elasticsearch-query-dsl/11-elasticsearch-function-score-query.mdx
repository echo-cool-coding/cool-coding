---
title: Elasticsearch Function Score查询
description: 了解如何使用Elasticsearch的Function Score查询来自定义文档的相关性评分，并通过实际案例掌握其应用场景。
---

# Elasticsearch Function Score查询

Elasticsearch的Function Score查询是一种强大的工具，允许你自定义文档的相关性评分。通过Function Score查询，你可以根据特定的需求调整文档的评分，从而影响搜索结果的排序。本文将详细介绍Function Score查询的工作原理、语法以及实际应用场景。

## 什么是Function Score查询？

在Elasticsearch中，默认的评分机制（如TF-IDF或BM25）会根据查询与文档的匹配程度为每个文档分配一个评分。然而，在某些情况下，你可能希望根据其他因素（如文档的发布时间、地理位置、用户偏好等）来调整评分。这时，Function Score查询就派上了用场。

Function Score查询允许你在原始评分的基础上，应用一个或多个函数来调整最终的评分。这些函数可以是简单的数学运算，也可以是复杂的自定义逻辑。

## Function Score查询的基本语法

Function Score查询的基本语法如下：

```json
{
  "query": {
    "function_score": {
      "query": { ... },  // 原始查询
      "functions": [     // 评分函数列表
        {
          "filter": { ... },  // 可选的过滤器
          "weight": 2         // 权重
        },
        {
          "field_value_factor": {  // 字段值因子
            "field": "popularity",
            "factor": 1.2,
            "modifier": "sqrt"
          }
        }
      ],
      "score_mode": "sum",  // 评分模式
      "boost_mode": "multiply"  // 提升模式
    }
  }
}
```

### 参数解释

- **query**: 原始查询，用于匹配文档。
- **functions**: 一个或多个评分函数，用于调整文档的评分。
- **filter**: 可选的过滤器，用于限制函数应用的文档范围。
- **weight**: 权重，用于调整评分的倍数。
- **field_value_factor**: 字段值因子，用于根据字段值调整评分。
- **score_mode**: 评分模式，决定多个函数的评分如何组合。可选值包括 `sum`、`avg`、`max`、`min`、`multiply` 等。
- **boost_mode**: 提升模式，决定函数评分如何与原始评分结合。可选值包括 `multiply`、`replace`、`sum`、`avg`、`max`、`min` 等。

## 实际案例

### 案例1：根据发布时间调整评分

假设你有一个新闻网站，希望最新发布的新闻在搜索结果中排名更高。你可以使用 `field_value_factor` 函数来根据发布时间调整评分。

```json
{
  "query": {
    "function_score": {
      "query": {
        "match": {
          "title": "breaking news"
        }
      },
      "functions": [
        {
          "field_value_factor": {
            "field": "publish_date",
            "factor": 1.2,
            "modifier": "log1p"
          }
        }
      ],
      "boost_mode": "multiply"
    }
  }
}
```

在这个例子中，`publish_date` 字段的值越大（即发布时间越近），文档的评分越高。

### 案例2：根据地理位置调整评分

假设你有一个餐厅搜索应用，希望根据用户的地理位置调整餐厅的评分。你可以使用 `gauss` 函数来实现这一点。

```json
{
  "query": {
    "function_score": {
      "query": {
        "match": {
          "name": "pizza"
        }
      },
      "functions": [
        {
          "gauss": {
            "location": {
              "origin": "40.7128,-74.0060",
              "scale": "10km"
            }
          }
        }
      ],
      "score_mode": "sum",
      "boost_mode": "multiply"
    }
  }
}
```

在这个例子中，`location` 字段的值越接近 `origin`（即用户的位置），文档的评分越高。

## 总结

Elasticsearch的Function Score查询提供了一种灵活的方式来调整文档的评分，从而影响搜索结果的排序。通过结合不同的评分函数和模式，你可以实现各种复杂的评分逻辑，满足不同的业务需求。

## 附加资源

- [Elasticsearch官方文档 - Function Score查询](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html)
- [Elasticsearch实战 - 自定义评分](https://www.elastic.co/blog/custom-scoring-in-elasticsearch)

## 练习

1. 尝试在你的Elasticsearch索引中实现一个Function Score查询，根据文档的某个字段值调整评分。
2. 结合多个评分函数，实现一个复杂的评分逻辑，并观察搜索结果的变化。

通过本文的学习，你应该已经掌握了Elasticsearch Function Score查询的基本概念和应用方法。继续实践和探索，你将能够更好地利用这一强大的功能来优化你的搜索体验。