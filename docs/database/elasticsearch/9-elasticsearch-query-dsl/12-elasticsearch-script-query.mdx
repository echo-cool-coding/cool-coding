---
title: Elasticsearch 脚本查询
description: 了解如何使用Elasticsearch脚本查询（Script Query）来执行复杂的查询操作。本文适合初学者，包含详细的解释、代码示例和实际应用场景。
---

# Elasticsearch 脚本查询

Elasticsearch 是一个强大的分布式搜索引擎，支持多种查询方式。其中，**脚本查询（Script Query）** 是一种灵活且强大的工具，允许你在查询中使用自定义脚本来实现复杂的逻辑。本文将详细介绍脚本查询的概念、语法以及实际应用场景。

## 什么是脚本查询？

脚本查询允许你在查询中使用脚本来动态计算字段值或执行复杂的条件判断。这些脚本可以用多种语言编写，但最常见的是使用 **Painless**，这是 Elasticsearch 默认的脚本语言，专为 Elasticsearch 设计，具有安全性和高效性。

脚本查询通常用于以下场景：
- 动态计算字段值。
- 根据复杂的条件过滤文档。
- 在查询中执行数学运算或字符串操作。

## 脚本查询的基本语法

脚本查询的基本语法如下：

```json
{
  "query": {
    "script": {
      "script": {
        "source": "脚本内容",
        "params": {
          "参数名": "参数值"
        }
      }
    }
  }
}
```

- `source`：脚本的内容，通常是一段 Painless 代码。
- `params`：传递给脚本的参数，可以在脚本中使用这些参数。

### 示例：简单的脚本查询

假设我们有一个索引 `products`，其中包含商品的名称和价格。我们想要查询价格大于 100 的商品。可以使用以下脚本查询：

```json
{
  "query": {
    "script": {
      "script": {
        "source": "doc['price'].value > params.min_price",
        "params": {
          "min_price": 100
        }
      }
    }
  }
}
```

在这个例子中，`doc['price'].value` 表示文档中的 `price` 字段的值，`params.min_price` 是传递给脚本的参数。

### 输出示例

假设索引中有以下文档：

```json
[
  {"name": "Product A", "price": 150},
  {"name": "Product B", "price": 80},
  {"name": "Product C", "price": 200}
]
```

执行上述查询后，返回的结果将是：

```json
[
  {"name": "Product A", "price": 150},
  {"name": "Product C", "price": 200}
]
```

## 实际应用场景

### 场景 1：动态评分

假设我们想要根据商品的评分和价格动态调整搜索结果的排序。我们可以使用脚本查询来实现：

```json
{
  "query": {
    "script_score": {
      "query": {
        "match_all": {}
      },
      "script": {
        "source": "doc['rating'].value * params.price_weight + doc['price'].value * params.rating_weight",
        "params": {
          "price_weight": 0.7,
          "rating_weight": 0.3
        }
      }
    }
  }
}
```

在这个例子中，我们使用 `script_score` 查询来动态计算每个文档的评分，评分由商品的评分和价格共同决定。

### 场景 2：复杂条件过滤

假设我们想要查询价格在某个范围内且名称包含特定关键字的商品。可以使用以下脚本查询：

```json
{
  "query": {
    "bool": {
      "must": [
        {
          "script": {
            "script": {
              "source": "doc['price'].value >= params.min_price && doc['price'].value <= params.max_price",
              "params": {
                "min_price": 100,
                "max_price": 200
              }
            }
          }
        },
        {
          "match": {
            "name": "Product"
          }
        }
      ]
    }
  }
}
```

在这个例子中，我们使用 `bool` 查询将脚本查询和 `match` 查询结合起来，实现了复杂的条件过滤。

## 总结

脚本查询是 Elasticsearch 中一个非常强大的工具，允许你在查询中执行复杂的逻辑。通过使用 Painless 脚本语言，你可以动态计算字段值、执行条件判断以及实现复杂的评分逻辑。

### 附加资源

- [Elasticsearch 官方文档：脚本查询](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-query.html)
- [Painless 脚本语言指南](https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-guide.html)

### 练习

1. 尝试编写一个脚本查询，查询价格大于 50 且评分大于 4 的商品。
2. 修改动态评分的例子，使得价格和评分的权重可以动态调整。

通过本文的学习，你应该已经掌握了 Elasticsearch 脚本查询的基本概念和使用方法。继续练习和探索，你将能够更熟练地使用这一强大的工具。