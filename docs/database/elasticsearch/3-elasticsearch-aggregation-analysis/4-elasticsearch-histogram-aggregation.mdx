---
title: Elasticsearch 直方图聚合
description: 了解如何使用Elasticsearch的直方图聚合功能，对数值数据进行分组和分析。本文适合初学者，包含代码示例和实际案例。
---

# Elasticsearch 直方图聚合

Elasticsearch 是一个强大的分布式搜索和分析引擎，支持多种聚合操作。直方图聚合（Histogram Aggregation）是其中一种常用的聚合方式，用于对数值数据进行分组，生成直方图。直方图聚合可以帮助我们快速了解数据的分布情况，例如价格区间、时间间隔等。

## 什么是直方图聚合？

直方图聚合是一种基于数值字段的聚合方式，它将数值数据按照指定的间隔（interval）进行分组。每个分组称为一个“桶”（bucket），每个桶包含一定范围内的数据。例如，如果我们有一个价格字段，可以使用直方图聚合将价格分成多个区间，如 0-100、100-200 等。

直方图聚合非常适合用于分析数值数据的分布情况，例如统计某个价格区间的商品数量，或者分析某个时间段内的用户活动。

## 直方图聚合的基本语法

直方图聚合的基本语法如下：

```json
{
  "aggs": {
    "histogram_agg": {
      "histogram": {
        "field": "price",
        "interval": 100
      }
    }
  }
}
```

- `field`：指定要进行聚合的数值字段。
- `interval`：指定每个桶的间隔大小。例如，`interval: 100` 表示每个桶的宽度为 100。

### 示例：按价格区间聚合

假设我们有一个商品索引，其中包含价格字段 `price`。我们希望将商品按价格区间进行分组，每个区间的宽度为 100。

```json
{
  "size": 0,
  "aggs": {
    "price_histogram": {
      "histogram": {
        "field": "price",
        "interval": 100
      }
    }
  }
}
```

**输入数据示例：**

```json
[
  { "price": 50 },
  { "price": 120 },
  { "price": 250 },
  { "price": 300 },
  { "price": 450 }
]
```

**输出结果：**

```json
{
  "aggregations": {
    "price_histogram": {
      "buckets": [
        { "key": 0, "doc_count": 1 },
        { "key": 100, "doc_count": 1 },
        { "key": 200, "doc_count": 1 },
        { "key": 300, "doc_count": 1 },
        { "key": 400, "doc_count": 1 }
      ]
    }
  }
}
```

在这个例子中，Elasticsearch 将价格字段按 100 的间隔进行分组，生成了 5 个桶。每个桶的 `key` 表示区间的起始值，`doc_count` 表示该区间内的文档数量。

## 直方图聚合的高级用法

### 1. 指定最小值和最大值

默认情况下，直方图聚合会从数据的最小值开始生成桶。我们可以通过 `min_doc_count` 和 `extended_bounds` 参数来控制桶的生成范围。

```json
{
  "size": 0,
  "aggs": {
    "price_histogram": {
      "histogram": {
        "field": "price",
        "interval": 100,
        "min_doc_count": 0,
        "extended_bounds": {
          "min": 0,
          "max": 500
        }
      }
    }
  }
}
```

在这个例子中，我们指定了 `min_doc_count: 0`，即使某个区间内没有文档，也会生成对应的桶。`extended_bounds` 参数用于指定生成桶的范围，即使数据中没有对应的值。

### 2. 嵌套聚合

直方图聚合可以与其他聚合结合使用，例如计算每个价格区间的平均价格。

```json
{
  "size": 0,
  "aggs": {
    "price_histogram": {
      "histogram": {
        "field": "price",
        "interval": 100
      },
      "aggs": {
        "avg_price": {
          "avg": {
            "field": "price"
          }
        }
      }
    }
  }
}
```

**输出结果：**

```json
{
  "aggregations": {
    "price_histogram": {
      "buckets": [
        {
          "key": 0,
          "doc_count": 1,
          "avg_price": { "value": 50 }
        },
        {
          "key": 100,
          "doc_count": 1,
          "avg_price": { "value": 120 }
        },
        {
          "key": 200,
          "doc_count": 1,
          "avg_price": { "value": 250 }
        },
        {
          "key": 300,
          "doc_count": 1,
          "avg_price": { "value": 300 }
        },
        {
          "key": 400,
          "doc_count": 1,
          "avg_price": { "value": 450 }
        }
      ]
    }
  }
}
```

在这个例子中，我们为每个价格区间计算了平均价格。

## 实际应用场景

### 1. 电商价格分布分析

假设我们有一个电商平台，希望分析商品价格的分布情况。我们可以使用直方图聚合将商品价格分成多个区间，并统计每个区间内的商品数量。

```json
{
  "size": 0,
  "aggs": {
    "price_distribution": {
      "histogram": {
        "field": "price",
        "interval": 50
      }
    }
  }
}
```

### 2. 用户活动时间分析

假设我们有一个用户活动日志，记录了用户的活动时间（以小时为单位）。我们可以使用直方图聚合分析用户在一天中的活动分布。

```json
{
  "size": 0,
  "aggs": {
    "activity_distribution": {
      "histogram": {
        "field": "hour",
        "interval": 1
      }
    }
  }
}
```

## 总结

直方图聚合是 Elasticsearch 中一种强大的工具，用于对数值数据进行分组和分析。通过指定间隔，我们可以轻松生成直方图，了解数据的分布情况。直方图聚合还可以与其他聚合结合使用，进一步分析数据。

:::tip
如果你对直方图聚合感兴趣，可以尝试在自己的数据集上进行实验，探索不同的间隔和嵌套聚合的效果。
:::

## 附加资源

- [Elasticsearch 官方文档 - 直方图聚合](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-histogram-aggregation.html)
- 练习：尝试使用直方图聚合分析你的数据集，生成价格、时间或其他数值字段的分布图。