---
title: Elasticsearch 管道聚合
description: 了解Elasticsearch中的管道聚合，掌握如何使用它们对聚合结果进行进一步处理和分析。
---

# Elasticsearch 管道聚合

Elasticsearch 是一个强大的分布式搜索和分析引擎，广泛用于处理大规模数据集。在 Elasticsearch 中，聚合（Aggregation）是一种强大的工具，用于对数据进行分组、统计和分析。而**管道聚合（Pipeline Aggregation）**则是一种特殊的聚合类型，它允许你对其他聚合的结果进行进一步处理。

## 什么是管道聚合？

管道聚合是一种特殊的聚合类型，它不直接对文档进行操作，而是对其他聚合的结果进行处理。换句话说，管道聚合的输入是其他聚合的输出。这使得你可以在聚合的基础上进行更复杂的计算和分析。

管道聚合通常用于以下场景：
- 计算聚合结果的差值、比率或百分比。
- 对聚合结果进行排序或过滤。
- 对多个聚合结果进行组合或比较。

## 管道聚合的类型

Elasticsearch 提供了多种类型的管道聚合，主要包括以下几类：

1. **父级管道聚合（Parent Pipeline Aggregations）**：这类聚合基于父聚合的结果进行计算。例如，`avg_bucket` 可以计算某个桶的平均值。
2. **兄弟管道聚合（Sibling Pipeline Aggregations）**：这类聚合基于兄弟聚合的结果进行计算。例如，`max_bucket` 可以找到某个桶的最大值。
3. **指标管道聚合（Metric Pipeline Aggregations）**：这类聚合基于指标聚合的结果进行计算。例如，`cumulative_sum` 可以计算累积和。

## 管道聚合的基本语法

管道聚合的语法与其他聚合类似，但需要在 `aggs` 块中指定 `buckets_path` 参数，该参数用于指定输入聚合的路径。以下是一个简单的示例：

```json
{
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "avg_monthly_sales": {
      "avg_bucket": {
        "buckets_path": "sales_per_month>total_sales"
      }
    }
  }
}
```

在这个示例中，`sales_per_month` 是一个基于日期的直方图聚合，它计算了每个月的销售总额。然后，`avg_monthly_sales` 是一个管道聚合，它计算了每个月销售额的平均值。

## 实际案例：计算每月销售额的累积和

假设我们有一个电商平台的销售数据，我们希望计算每个月的销售额，并进一步计算累积销售额。以下是实现这一需求的 Elasticsearch 查询：

```json
{
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "cumulative_sales": {
          "cumulative_sum": {
            "buckets_path": "total_sales"
          }
        }
      }
    }
  }
}
```

在这个查询中：
- `sales_per_month` 是一个基于日期的直方图聚合，它按月份对销售数据进行分组。
- `total_sales` 是一个指标聚合，它计算了每个月的销售总额。
- `cumulative_sales` 是一个管道聚合，它计算了每个月销售额的累积和。

### 输出示例

假设输入数据如下：

| 日期       | 销售额 |
|------------|--------|
| 2023-01-01 | 100    |
| 2023-02-01 | 200    |
| 2023-03-01 | 150    |

输出结果可能如下：

```json
{
  "aggregations": {
    "sales_per_month": {
      "buckets": [
        {
          "key_as_string": "2023-01-01",
          "key": 1672531200000,
          "doc_count": 1,
          "total_sales": {
            "value": 100
          },
          "cumulative_sales": {
            "value": 100
          }
        },
        {
          "key_as_string": "2023-02-01",
          "key": 1675209600000,
          "doc_count": 1,
          "total_sales": {
            "value": 200
          },
          "cumulative_sales": {
            "value": 300
          }
        },
        {
          "key_as_string": "2023-03-01",
          "key": 1677628800000,
          "doc_count": 1,
          "total_sales": {
            "value": 150
          },
          "cumulative_sales": {
            "value": 450
          }
        }
      ]
    }
  }
}
```

在这个输出中，`cumulative_sales` 字段显示了每个月销售额的累积和。

## 总结

管道聚合是 Elasticsearch 中一个非常强大的工具，它允许你对其他聚合的结果进行进一步处理。通过使用管道聚合，你可以实现更复杂的数据分析和计算任务，例如计算累积和、差值、比率等。

:::tip
如果你对管道聚合感兴趣，可以尝试以下练习：
1. 使用 `derivative` 管道聚合计算每月销售额的变化率。
2. 使用 `bucket_script` 管道聚合计算两个聚合结果的比率。
:::

## 附加资源

- [Elasticsearch 官方文档：管道聚合](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline.html)
- [Elasticsearch 聚合指南](https://www.elastic.co/guide/en/elasticsearch/guide/current/aggregations.html)

通过学习和实践，你将能够更好地掌握 Elasticsearch 的管道聚合功能，并将其应用于实际的数据分析任务中。