---
title: Elasticsearch 嵌套聚合
description: 了解Elasticsearch中的嵌套聚合，掌握如何对嵌套文档进行复杂的聚合分析。
---

# Elasticsearch 嵌套聚合

Elasticsearch 是一个强大的分布式搜索引擎，支持对复杂数据结构进行高效的搜索和分析。在实际应用中，我们经常会遇到嵌套文档（nested documents）的情况。嵌套文档是指在一个文档中嵌入另一个文档，这些嵌入的文档可以独立地进行查询和聚合。为了对嵌套文档进行聚合分析，Elasticsearch 提供了**嵌套聚合（Nested Aggregation）**功能。

本文将详细介绍嵌套聚合的概念、使用方法以及实际应用场景，帮助你更好地理解和掌握这一功能。

---

## 什么是嵌套聚合？

在 Elasticsearch 中，嵌套聚合是一种特殊的聚合类型，用于对嵌套文档进行聚合分析。嵌套文档通常是通过 `nested` 数据类型定义的，它们存储在父文档中，但在逻辑上是独立的。嵌套聚合允许我们对这些嵌套文档进行分组、统计等操作，而不会影响父文档的其他字段。

:::note
嵌套聚合的核心思想是：**将嵌套文档视为独立的实体**，并在聚合过程中单独处理它们。
:::

---

## 嵌套聚合的基本语法

嵌套聚合的语法结构如下：

```json
{
  "aggs": {
    "nested_agg_name": {
      "nested": {
        "path": "nested_field_path"
      },
      "aggs": {
        "sub_agg_name": {
          "agg_type": { ... }
        }
      }
    }
  }
}
```

- `nested_agg_name`：嵌套聚合的名称。
- `path`：指定嵌套字段的路径。
- `sub_agg_name`：子聚合的名称。
- `agg_type`：子聚合的类型（如 `terms`、`avg` 等）。

---

## 示例：嵌套聚合的实际应用

假设我们有一个电商平台的商品索引，每个商品包含多个评论（嵌套文档）。我们希望统计每个商品的评论数量，并计算每个商品的平均评分。

### 数据示例

```json
{
  "product_name": "Laptop",
  "reviews": [
    {
      "user": "Alice",
      "rating": 5
    },
    {
      "user": "Bob",
      "rating": 4
    }
  ]
}
```

### 查询示例

以下查询使用嵌套聚合统计每个商品的评论数量，并计算平均评分：

```json
{
  "size": 0,
  "aggs": {
    "products": {
      "terms": {
        "field": "product_name.keyword"
      },
      "aggs": {
        "reviews": {
          "nested": {
            "path": "reviews"
          },
          "aggs": {
            "review_count": {
              "value_count": {
                "field": "reviews.rating"
              }
            },
            "avg_rating": {
              "avg": {
                "field": "reviews.rating"
              }
            }
          }
        }
      }
    }
  }
}
```

### 查询结果

```json
{
  "aggregations": {
    "products": {
      "buckets": [
        {
          "key": "Laptop",
          "doc_count": 1,
          "reviews": {
            "review_count": {
              "value": 2
            },
            "avg_rating": {
              "value": 4.5
            }
          }
        }
      ]
    }
  }
}
```

从结果中可以看到，商品 "Laptop" 有 2 条评论，平均评分为 4.5。

---

## 嵌套聚合的进阶用法

### 1. 多层嵌套聚合

如果嵌套文档中还有嵌套文档，可以使用多层嵌套聚合。例如，假设每个评论还包含多个回复：

```json
{
  "product_name": "Laptop",
  "reviews": [
    {
      "user": "Alice",
      "rating": 5,
      "replies": [
        {
          "user": "Admin",
          "message": "Thank you!"
        }
      ]
    }
  ]
}
```

可以使用以下查询统计每个评论的回复数量：

```json
{
  "aggs": {
    "reviews": {
      "nested": {
        "path": "reviews"
      },
      "aggs": {
        "replies": {
          "nested": {
            "path": "reviews.replies"
          },
          "aggs": {
            "reply_count": {
              "value_count": {
                "field": "reviews.replies.message.keyword"
              }
            }
          }
        }
      }
    }
  }
}
```

### 2. 反向嵌套聚合

反向嵌套聚合（Reverse Nested Aggregation）允许我们从嵌套文档返回到父文档进行聚合。例如，统计每个用户的评论数量：

```json
{
  "aggs": {
    "reviews": {
      "nested": {
        "path": "reviews"
      },
      "aggs": {
        "users": {
          "terms": {
            "field": "reviews.user.keyword"
          },
          "aggs": {
            "back_to_parent": {
              "reverse_nested": {},
              "aggs": {
                "product_count": {
                  "value_count": {
                    "field": "product_name.keyword"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

---

## 实际应用场景

1. **电商平台**：统计每个商品的评论数量和平均评分。
2. **社交网络**：分析每个用户的帖子数量及其点赞数。
3. **日志分析**：统计每个服务的错误日志数量及其分布。

---

## 总结

嵌套聚合是 Elasticsearch 中处理嵌套文档的强大工具。通过嵌套聚合，我们可以对复杂的嵌套数据结构进行灵活的聚合分析。本文介绍了嵌套聚合的基本语法、实际应用场景以及进阶用法，希望对你有所帮助。

---

## 附加资源与练习

1. **练习**：尝试在自己的 Elasticsearch 索引中实现嵌套聚合，并分析结果。
2. **官方文档**：[Elasticsearch Nested Aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-nested-aggregation.html)
3. **进一步学习**：了解 Elasticsearch 的其他聚合类型，如 `terms`、`date_histogram` 等。

Happy Coding! 🚀