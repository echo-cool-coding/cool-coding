---
title: Elasticsearch 范围聚合
description: 了解 Elasticsearch 中的范围聚合（Range Aggregation），掌握如何使用它对数据进行分组统计，并通过实际案例加深理解。
---

## 什么是范围聚合？

范围聚合（Range Aggregation）是 Elasticsearch 中一种常用的聚合方式，用于将数值类型的字段按照指定的范围进行分组统计。通过范围聚合，你可以轻松地对数据进行分段分析，例如统计某个价格区间内的商品数量，或者某个时间段内的用户访问量。

范围聚合的核心思想是：**将数据划分为多个区间（范围），然后对每个区间内的数据进行统计**。每个区间可以自定义起始值和结束值，Elasticsearch 会计算每个区间内的文档数量或其他聚合指标。

## 范围聚合的基本语法

在 Elasticsearch 中，范围聚合的语法如下：

```json
{
  "aggs": {
    "aggregation_name": {
      "range": {
        "field": "field_name",
        "ranges": [
          { "to": 50 },
          { "from": 50, "to": 100 },
          { "from": 100 }
        ]
      }
    }
  }
}
```

- `aggregation_name`：聚合的名称，可以自定义。
- `field`：需要进行范围聚合的字段名称。
- `ranges`：定义范围的数组，每个范围可以包含 `from` 和 `to` 属性，分别表示区间的起始值和结束值。`to` 是开区间，`from` 是闭区间。

:::tip
- 如果省略 `from`，则表示从负无穷开始。
- 如果省略 `to`，则表示到正无穷结束。
:::

## 示例：统计商品价格区间

假设我们有一个商品索引 `products`，其中包含商品的名称和价格。我们希望统计价格在以下区间的商品数量：

1. 0 - 50 元
2. 50 - 100 元
3. 100 元以上

以下是实现这一需求的 Elasticsearch 查询：

```json
{
  "size": 0,
  "aggs": {
    "price_ranges": {
      "range": {
        "field": "price",
        "ranges": [
          { "to": 50 },
          { "from": 50, "to": 100 },
          { "from": 100 }
        ]
      }
    }
  }
}
```

### 查询结果

执行上述查询后，Elasticsearch 会返回如下结果：

```json
{
  "aggregations": {
    "price_ranges": {
      "buckets": [
        {
          "key": "*-50.0",
          "to": 50,
          "doc_count": 120
        },
        {
          "key": "50.0-100.0",
          "from": 50,
          "to": 100,
          "doc_count": 80
        },
        {
          "key": "100.0-*",
          "from": 100,
          "doc_count": 50
        }
      ]
    }
  }
}
```

- `key`：表示区间的范围描述。
- `from` 和 `to`：表示区间的起始值和结束值。
- `doc_count`：表示该区间内的文档数量。

:::note
- `*-50.0` 表示从负无穷到 50 元的区间。
- `100.0-*` 表示从 100 元到正无穷的区间。
:::

## 实际应用场景

### 场景 1：统计用户年龄分布

假设我们有一个用户索引 `users`，其中包含用户的年龄信息。我们希望统计以下年龄段的用户数量：

1. 0 - 18 岁
2. 18 - 30 岁
3. 30 - 50 岁
4. 50 岁以上

查询如下：

```json
{
  "size": 0,
  "aggs": {
    "age_ranges": {
      "range": {
        "field": "age",
        "ranges": [
          { "to": 18 },
          { "from": 18, "to": 30 },
          { "from": 30, "to": 50 },
          { "from": 50 }
        ]
      }
    }
  }
}
```

### 场景 2：统计订单金额区间

假设我们有一个订单索引 `orders`，其中包含订单的金额信息。我们希望统计以下金额区间的订单数量：

1. 0 - 100 元
2. 100 - 500 元
3. 500 - 1000 元
4. 1000 元以上

查询如下：

```json
{
  "size": 0,
  "aggs": {
    "amount_ranges": {
      "range": {
        "field": "amount",
        "ranges": [
          { "to": 100 },
          { "from": 100, "to": 500 },
          { "from": 500, "to": 1000 },
          { "from": 1000 }
        ]
      }
    }
  }
}
```

## 总结

范围聚合是 Elasticsearch 中非常实用的功能，能够帮助我们对数值型字段进行分段统计。通过定义不同的区间，我们可以轻松地分析数据的分布情况，例如价格区间、年龄分布、订单金额等。

在实际应用中，范围聚合可以与其他聚合（如子聚合）结合使用，进一步丰富数据分析的维度。例如，在统计价格区间的同时，还可以计算每个区间的平均价格或总销售额。

## 附加资源与练习

1. **练习**：尝试在自己的 Elasticsearch 索引中创建一个范围聚合查询，统计某个数值字段的分布情况。
2. **深入学习**：了解 Elasticsearch 中的其他聚合类型，如 `terms` 聚合、`date_histogram` 聚合等。
3. **参考文档**：查阅 [Elasticsearch 官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-range-aggregation.html) 以获取更多关于范围聚合的详细信息。

通过不断实践和探索，你将能够熟练运用范围聚合来解决实际的数据分析问题！