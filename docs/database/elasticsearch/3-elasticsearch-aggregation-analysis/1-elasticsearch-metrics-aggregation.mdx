---
title: Elasticsearch 指标聚合
description: 了解 Elasticsearch 中的指标聚合，掌握如何使用聚合函数对数据进行统计分析。
---

# Elasticsearch 指标聚合

Elasticsearch 是一个强大的分布式搜索和分析引擎，广泛用于日志分析、全文搜索和实时数据分析。在 Elasticsearch 中，**聚合（Aggregation）** 是一种强大的功能，允许你对数据进行分组、统计和分析。其中，**指标聚合（Metric Aggregation）** 是最常用的聚合类型之一，用于计算数值型字段的统计值，如平均值、总和、最大值、最小值等。

本文将详细介绍 Elasticsearch 中的指标聚合，并通过实际案例帮助你理解其应用场景。

## 什么是指标聚合？

指标聚合是一种用于计算数值型字段的统计值的聚合类型。它不会对数据进行分组，而是直接对字段的值进行计算。常见的指标聚合包括：

- **平均值（Avg）**：计算字段的平均值。
- **总和（Sum）**：计算字段的总和。
- **最大值（Max）**：计算字段的最大值。
- **最小值（Min）**：计算字段的最小值。
- **统计（Stats）**：一次性计算字段的平均值、总和、最大值、最小值和文档数。
- **扩展统计（Extended Stats）**：在统计的基础上，增加方差、标准差等高级统计指标。

## 基本语法

Elasticsearch 的聚合查询通常嵌套在 `aggs` 或 `aggregations` 关键字下。以下是一个简单的指标聚合语法示例：

```json
{
  "aggs": {
    "聚合名称": {
      "聚合类型": {
        "field": "字段名"
      }
    }
  }
}
```

- `聚合名称`：自定义的聚合名称，用于标识聚合结果。
- `聚合类型`：如 `avg`、`sum`、`max` 等。
- `字段名`：需要进行聚合计算的字段。

## 实际案例

假设我们有一个存储销售数据的索引 `sales`，其中包含以下字段：

- `product`：产品名称
- `price`：产品价格
- `quantity`：销售数量

我们希望计算所有销售记录的总销售额（`price * quantity` 的总和）。

### 1. 计算总销售额

```json
{
  "size": 0,
  "aggs": {
    "total_sales": {
      "sum": {
        "script": {
          "source": "doc['price'].value * doc['quantity'].value"
        }
      }
    }
  }
}
```

- `size: 0`：表示不返回具体的文档，只返回聚合结果。
- `script`：使用脚本计算 `price * quantity` 的总和。

**输出结果：**

```json
{
  "aggregations": {
    "total_sales": {
      "value": 15000
    }
  }
}
```

### 2. 计算平均价格

```json
{
  "size": 0,
  "aggs": {
    "avg_price": {
      "avg": {
        "field": "price"
      }
    }
  }
}
```

**输出结果：**

```json
{
  "aggregations": {
    "avg_price": {
      "value": 50.5
    }
  }
}
```

### 3. 使用统计聚合

统计聚合可以一次性计算多个指标：

```json
{
  "size": 0,
  "aggs": {
    "price_stats": {
      "stats": {
        "field": "price"
      }
    }
  }
}
```

**输出结果：**

```json
{
  "aggregations": {
    "price_stats": {
      "count": 100,
      "min": 10,
      "max": 100,
      "avg": 50.5,
      "sum": 5050
    }
  }
}
```

## 实际应用场景

### 场景 1：电商平台销售分析

在电商平台中，可以使用指标聚合计算以下数据：

- 每日总销售额
- 每个产品的平均价格
- 最高和最低订单金额

### 场景 2：日志分析

在日志分析中，可以使用指标聚合计算以下数据：

- 平均响应时间
- 最大错误数
- 请求总数的统计

## 总结

Elasticsearch 的指标聚合功能非常强大，能够帮助你快速计算数值型字段的统计值。通过本文的学习，你应该已经掌握了如何使用 `avg`、`sum`、`max`、`min` 和 `stats` 等常见的指标聚合类型。

:::tip 提示
在实际使用中，可以结合 `script` 字段进行更复杂的计算，例如加权平均或条件统计。
:::

## 附加资源与练习

1. **练习**：尝试在 Elasticsearch 中创建一个索引，插入一些模拟数据，并使用指标聚合计算字段的平均值、总和和最大值。
2. **深入学习**：阅读 Elasticsearch 官方文档中关于 [聚合](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html) 的更多内容，了解其他类型的聚合（如桶聚合、管道聚合）。

通过不断实践和探索，你将能够更好地掌握 Elasticsearch 的聚合功能，并将其应用于实际的数据分析任务中。