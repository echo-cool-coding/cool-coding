---
title: Elasticsearch 多字段类型
description: 了解如何在 Elasticsearch 中使用多字段类型来优化索引设计，满足不同的搜索和分析需求。
---

# Elasticsearch 多字段类型

在 Elasticsearch 中，**多字段类型（Multi-fields）** 是一种强大的功能，允许你为同一个字段定义多种数据类型。这意味着你可以为同一个字段同时支持全文搜索、精确匹配、聚合分析等多种操作。通过合理使用多字段类型，你可以显著提升搜索性能和灵活性。

## 为什么需要多字段类型？

在实际应用中，一个字段可能需要在不同的场景下以不同的方式被处理。例如：

- **全文搜索**：需要对文本进行分词处理，以便支持模糊搜索。
- **精确匹配**：需要对文本进行精确匹配，例如过滤或排序。
- **聚合分析**：需要对字段进行数值或日期类型的聚合操作。

如果没有多字段类型，你可能需要为每个场景单独定义一个字段，这会导致索引设计复杂且冗余。多字段类型允许你在一个字段中定义多种数据类型，从而简化索引设计并提高效率。

## 多字段类型的基本用法

在 Elasticsearch 中，你可以通过在映射（mapping）中定义 `fields` 属性来为一个字段指定多字段类型。以下是一个简单的示例：

```json
PUT /my_index
{
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword"
          },
          "english": {
            "type": "text",
            "analyzer": "english"
          }
        }
      }
    }
  }
}
```

在这个示例中，`title` 字段被定义为一个 `text` 类型，用于全文搜索。同时，它还包含两个子字段：

- `title.keyword`：一个 `keyword` 类型的子字段，用于精确匹配和排序。
- `title.english`：一个 `text` 类型的子字段，使用 `english` 分析器进行分词，适用于英文文本的搜索。

### 插入数据

让我们插入一些数据来测试这个映射：

```json
POST /my_index/_doc/1
{
  "title": "Elasticsearch is a powerful search engine"
}
```

### 查询数据

现在，我们可以使用不同的子字段进行查询：

1. **全文搜索**（使用 `title` 字段）：

```json
GET /my_index/_search
{
  "query": {
    "match": {
      "title": "powerful"
    }
  }
}
```

2. **精确匹配**（使用 `title.keyword` 字段）：

```json
GET /my_index/_search
{
  "query": {
    "term": {
      "title.keyword": "Elasticsearch is a powerful search engine"
    }
  }
}
```

3. **英文分词搜索**（使用 `title.english` 字段）：

```json
GET /my_index/_search
{
  "query": {
    "match": {
      "title.english": "powerful"
    }
  }
}
```

:::note
注意：`title.keyword` 字段是大小写敏感的，因此精确匹配时需要确保输入的值与存储的值完全一致。
:::

## 实际应用场景

### 场景 1：支持多种语言的搜索

假设你正在构建一个多语言支持的电商平台，商品名称需要支持中文和英文的搜索。你可以为 `product_name` 字段定义多字段类型：

```json
PUT /products
{
  "mappings": {
    "properties": {
      "product_name": {
        "type": "text",
        "fields": {
          "chinese": {
            "type": "text",
            "analyzer": "ik_smart"
          },
          "english": {
            "type": "text",
            "analyzer": "english"
          }
        }
      }
    }
  }
}
```

这样，你可以根据用户的语言偏好选择不同的子字段进行搜索。

### 场景 2：支持数值和文本类型的聚合

假设你有一个 `price` 字段，既需要支持数值类型的聚合，又需要支持文本类型的搜索。你可以这样定义：

```json
PUT /products
{
  "mappings": {
    "properties": {
      "price": {
        "type": "text",
        "fields": {
          "numeric": {
            "type": "float"
          }
        }
      }
    }
  }
}
```

这样，你可以使用 `price.numeric` 进行数值聚合，同时保留 `price` 字段的文本搜索功能。

## 总结

Elasticsearch 的多字段类型功能为索引设计提供了极大的灵活性。通过为一个字段定义多种数据类型，你可以同时满足全文搜索、精确匹配、聚合分析等多种需求，而无需为每个场景单独定义字段。合理使用多字段类型可以显著提升搜索性能和索引设计的简洁性。

## 附加资源与练习

- **练习 1**：尝试为一个 `description` 字段定义多字段类型，使其同时支持全文搜索和精确匹配。
- **练习 2**：为一个 `date` 字段定义多字段类型，使其同时支持日期范围和文本搜索。

:::tip
提示：Elasticsearch 官方文档中关于 [Multi-fields](https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html) 的部分提供了更多详细信息和示例。
:::