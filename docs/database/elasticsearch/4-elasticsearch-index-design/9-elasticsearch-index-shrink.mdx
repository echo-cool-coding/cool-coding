---
title: Elasticsearch 索引收缩
description: 了解 Elasticsearch 索引收缩的概念、使用场景以及如何通过收缩操作优化索引性能。
---

# Elasticsearch 索引收缩

## 介绍

Elasticsearch 是一个强大的分布式搜索引擎，广泛用于全文搜索、日志分析和实时数据分析。随着数据量的增长，索引的大小和分片数量可能会变得难以管理。**索引收缩（Index Shrink）** 是 Elasticsearch 提供的一种优化技术，允许你将一个索引的分片数量减少，同时保留数据。这对于优化存储和查询性能非常有用。

索引收缩的主要目的是将一个较大的索引收缩为一个较小的索引，减少分片数量，从而降低集群的资源消耗。收缩后的索引仍然可以正常使用，但分片数量更少，管理起来更加高效。

:::note
索引收缩操作是不可逆的。收缩后的索引将替换原始索引，因此在进行收缩操作之前，请确保备份数据。
:::

## 索引收缩的工作原理

索引收缩的过程可以分为以下几个步骤：

1. **创建目标索引**：收缩操作会创建一个新的索引，并将原始索引的数据复制到新索引中。
2. **减少分片数量**：新索引的分片数量会减少，通常为原始索引分片数量的一半或更少。
3. **删除原始索引**：收缩完成后，原始索引会被删除，新索引将取代它。

:::tip
索引收缩的前提条件是原始索引必须是只读的（read-only），并且所有分片必须位于同一个节点上。
:::

## 索引收缩的使用场景

索引收缩适用于以下场景：

- **减少分片数量**：当索引的分片数量过多时，收缩操作可以减少分片数量，从而降低集群的资源消耗。
- **优化存储**：收缩后的索引占用更少的存储空间，适合存储冷数据或归档数据。
- **提高查询性能**：减少分片数量可以降低查询时的开销，从而提高查询性能。

## 索引收缩的步骤

### 1. 将索引设置为只读

在进行索引收缩之前，必须将原始索引设置为只读模式。你可以通过以下命令实现：

```json
PUT /my_index/_settings
{
  "settings": {
    "index.blocks.write": true
  }
}
```

### 2. 确保所有分片位于同一个节点

索引收缩要求所有分片必须位于同一个节点上。你可以通过以下命令将索引的分片分配到一个节点：

```json
PUT /my_index/_settings
{
  "settings": {
    "index.routing.allocation.require._name": "node_name"
  }
}
```

### 3. 执行索引收缩

使用 `_shrink` API 执行索引收缩操作。以下是一个示例：

```json
POST /my_index/_shrink/my_shrunk_index
{
  "settings": {
    "index.number_of_replicas": 1,
    "index.number_of_shards": 2,
    "index.codec": "best_compression"
  },
  "aliases": {
    "my_search_alias": {}
  }
}
```

在这个示例中，`my_index` 是原始索引，`my_shrunk_index` 是收缩后的新索引。`index.number_of_shards` 指定了新索引的分片数量。

### 4. 验证收缩结果

收缩操作完成后，你可以通过以下命令验证新索引的状态：

```json
GET /my_shrunk_index/_settings
```

## 实际案例

假设你有一个日志索引 `logs-2023`，它包含 10 个分片和 2 个副本。随着时间的推移，日志数据不再频繁更新，但你仍然需要保留这些数据以供查询。此时，你可以使用索引收缩来优化存储和查询性能。

1. 将 `logs-2023` 设置为只读模式。
2. 将所有分片分配到一个节点。
3. 执行索引收缩，将分片数量减少到 5 个。
4. 收缩完成后，删除原始索引 `logs-2023`，并使用新索引 `logs-2023-shrunk` 进行查询。

## 总结

索引收缩是 Elasticsearch 中一种强大的优化技术，适用于减少分片数量、优化存储和提高查询性能的场景。通过将索引设置为只读、分配分片到同一个节点，并使用 `_shrink` API，你可以轻松地收缩索引。

:::caution
索引收缩操作是不可逆的，请确保在执行收缩操作之前备份数据。
:::

## 附加资源

- [Elasticsearch 官方文档 - 索引收缩](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-shrink-index.html)
- 练习：尝试在你的 Elasticsearch 集群中创建一个测试索引，并执行索引收缩操作，观察收缩前后的索引状态。