---
title: Elasticsearch 地理位置查询
description: 了解如何在Elasticsearch中使用地理位置查询，通过实际案例和代码示例掌握地理空间数据的搜索和分析。
---

# Elasticsearch 地理位置查询

Elasticsearch 是一个强大的分布式搜索引擎，支持多种数据类型和查询方式。其中，地理位置查询（Geo Queries）是 Elasticsearch 的一个重要功能，允许用户基于地理空间数据进行搜索和分析。无论是查找附近的商店、计算两点之间的距离，还是分析地理围栏内的数据，地理位置查询都能派上用场。

本文将带你逐步了解 Elasticsearch 中的地理位置查询，并通过实际案例展示其应用场景。

## 1. 地理位置数据类型

在 Elasticsearch 中，地理位置数据通常以 `geo_point` 或 `geo_shape` 类型存储。`geo_point` 用于表示一个具体的点（如经纬度），而 `geo_shape` 用于表示更复杂的地理形状（如多边形、线等）。

### 1.1 `geo_point` 数据类型

`geo_point` 是 Elasticsearch 中最常用的地理位置数据类型，用于存储经纬度坐标。以下是一个定义 `geo_point` 字段的示例：

```json
PUT /locations
{
  "mappings": {
    "properties": {
      "location": {
        "type": "geo_point"
      }
    }
  }
}
```

在这个示例中，我们创建了一个名为 `locations` 的索引，并定义了一个 `location` 字段，其类型为 `geo_point`。

### 1.2 `geo_shape` 数据类型

`geo_shape` 用于存储更复杂的地理形状，如多边形、线等。以下是一个定义 `geo_shape` 字段的示例：

```json
PUT /regions
{
  "mappings": {
    "properties": {
      "region": {
        "type": "geo_shape"
      }
    }
  }
}
```

在这个示例中，我们创建了一个名为 `regions` 的索引，并定义了一个 `region` 字段，其类型为 `geo_shape`。

## 2. 地理位置查询类型

Elasticsearch 提供了多种地理位置查询类型，以下是几种常见的查询方式：

### 2.1 `geo_distance` 查询

`geo_distance` 查询用于查找距离某个点一定范围内的文档。例如，查找距离某个坐标 10 公里内的所有商店。

```json
GET /locations/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all": {}
      },
      "filter": {
        "geo_distance": {
          "distance": "10km",
          "location": {
            "lat": 40.7128,
            "lon": -74.0060
          }
        }
      }
    }
  }
}
```

在这个示例中，我们查找距离纽约市（经纬度为 `40.7128, -74.0060`）10 公里内的所有文档。

### 2.2 `geo_bounding_box` 查询

`geo_bounding_box` 查询用于查找位于某个矩形区域内的文档。例如，查找位于某个矩形区域内的所有用户。

```json
GET /locations/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all": {}
      },
      "filter": {
        "geo_bounding_box": {
          "location": {
            "top_left": {
              "lat": 40.73,
              "lon": -74.1
            },
            "bottom_right": {
              "lat": 40.01,
              "lon": -73.99
            }
          }
        }
      }
    }
  }
}
```

在这个示例中，我们查找位于纽约市某个矩形区域内的所有文档。

### 2.3 `geo_polygon` 查询

`geo_polygon` 查询用于查找位于某个多边形区域内的文档。例如，查找位于某个城市区域内的所有商店。

```json
GET /locations/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all": {}
      },
      "filter": {
        "geo_polygon": {
          "location": {
            "points": [
              { "lat": 40.73, "lon": -74.1 },
              { "lat": 40.01, "lon": -73.99 },
              { "lat": 40.5, "lon": -73.5 }
            ]
          }
        }
      }
    }
  }
}
```

在这个示例中，我们查找位于由三个点定义的多边形区域内的所有文档。

## 3. 实际应用场景

### 3.1 查找附近的商店

假设你正在开发一个应用程序，用户可以通过输入自己的位置来查找附近的商店。你可以使用 `geo_distance` 查询来实现这一功能。

```json
GET /stores/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all": {}
      },
      "filter": {
        "geo_distance": {
          "distance": "5km",
          "location": {
            "lat": 40.7128,
            "lon": -74.0060
          }
        }
      }
    }
  }
}
```

在这个示例中，我们查找距离用户位置（纽约市）5 公里内的所有商店。

### 3.2 分析地理围栏内的用户

假设你正在分析某个地理围栏内的用户行为。你可以使用 `geo_polygon` 查询来查找位于该区域内的用户。

```json
GET /users/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all": {}
      },
      "filter": {
        "geo_polygon": {
          "location": {
            "points": [
              { "lat": 40.73, "lon": -74.1 },
              { "lat": 40.01, "lon": -73.99 },
              { "lat": 40.5, "lon": -73.5 }
            ]
          }
        }
      }
    }
  }
}
```

在这个示例中，我们查找位于由三个点定义的多边形区域内的所有用户。

## 4. 总结

Elasticsearch 的地理位置查询功能非常强大，能够满足各种地理空间数据的搜索和分析需求。通过本文的介绍，你应该已经掌握了如何使用 `geo_point` 和 `geo_shape` 数据类型，以及如何执行 `geo_distance`、`geo_bounding_box` 和 `geo_polygon` 查询。

## 5. 附加资源与练习

- **官方文档**：阅读 [Elasticsearch 官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html) 以了解更多关于地理位置查询的详细信息。
- **练习**：尝试在你的 Elasticsearch 实例中创建一个包含 `geo_point` 字段的索引，并执行一些地理位置查询。

:::tip
如果你在练习中遇到问题，可以参考本文中的代码示例，或者查阅官方文档以获取更多帮助。
:::