---
title: Elasticsearch 父子关系查询
description: 了解如何在Elasticsearch中使用父子关系查询，掌握其基本概念、应用场景及实现方法。
---

# Elasticsearch 父子关系查询

Elasticsearch 是一个强大的分布式搜索引擎，支持复杂的数据结构和查询。其中，**父子关系查询**是一种用于处理具有层次结构数据的查询方式。通过父子关系，您可以在索引中建立文档之间的关联，从而实现更灵活的查询和分析。

## 什么是父子关系？

在 Elasticsearch 中，父子关系是一种文档之间的关联方式。一个文档可以作为另一个文档的“父文档”，而另一个文档则作为“子文档”。这种关系允许您在查询时基于父子关系进行过滤、聚合等操作。

:::note
父子关系与嵌套文档不同。嵌套文档是将子文档嵌入到父文档中，而父子关系则是通过独立的文档建立关联。
:::

### 父子关系的优势
- **灵活性**：父子关系允许您动态地添加或删除子文档，而无需修改父文档。
- **独立性**：父文档和子文档是独立的文档，可以单独更新或删除。
- **高效查询**：通过父子关系，您可以高效地查询具有特定关系的文档。

## 如何定义父子关系？

在 Elasticsearch 中，定义父子关系需要在索引映射（mapping）中明确指定。以下是一个示例：

```json
PUT /my_index
{
  "mappings": {
    "properties": {
      "parent_id": {
        "type": "join",
        "relations": {
          "parent": "child"
        }
      }
    }
  }
}
```

在这个示例中：
- `parent_id` 是一个字段，类型为 `join`，用于定义父子关系。
- `relations` 中指定了 `parent` 和 `child` 的关系，表示一个父文档可以有多个子文档。

## 插入父文档和子文档

### 插入父文档
```json
PUT /my_index/_doc/1
{
  "name": "Parent Document",
  "parent_id": {
    "name": "parent"
  }
}
```

### 插入子文档
```json
PUT /my_index/_doc/2?routing=1
{
  "name": "Child Document",
  "parent_id": {
    "name": "child",
    "parent": "1"
  }
}
```

:::caution
插入子文档时，必须指定 `routing` 参数，其值必须与父文档的 ID 相同。这是因为 Elasticsearch 需要确保父子文档存储在同一个分片中。
:::

## 父子关系查询

### 查询所有子文档
您可以使用 `has_child` 查询来查找具有特定子文档的父文档。例如，查找所有具有子文档的父文档：

```json
GET /my_index/_search
{
  "query": {
    "has_child": {
      "type": "child",
      "query": {
        "match_all": {}
      }
    }
  }
}
```

### 查询所有父文档
您可以使用 `has_parent` 查询来查找具有特定父文档的子文档。例如，查找所有父文档为 `Parent Document` 的子文档：

```json
GET /my_index/_search
{
  "query": {
    "has_parent": {
      "parent_type": "parent",
      "query": {
        "match": {
          "name": "Parent Document"
        }
      }
    }
  }
}
```

## 实际应用场景

### 场景：博客与评论
假设您正在构建一个博客系统，其中每篇博客文章是一个父文档，而评论是子文档。通过父子关系，您可以轻松地查询某篇博客的所有评论，或者查询包含特定关键词的评论的博客文章。

#### 示例：查询某篇博客的所有评论
```json
GET /blogs/_search
{
  "query": {
    "has_parent": {
      "parent_type": "blog",
      "query": {
        "match": {
          "title": "Elasticsearch 入门"
        }
      }
    }
  }
}
```

#### 示例：查询包含特定关键词的评论的博客文章
```json
GET /blogs/_search
{
  "query": {
    "has_child": {
      "type": "comment",
      "query": {
        "match": {
          "content": "初学者"
        }
      }
    }
  }
}
```

## 总结

Elasticsearch 的父子关系查询为处理层次结构数据提供了强大的工具。通过定义父子关系，您可以灵活地查询和分析具有关联关系的文档。无论是博客与评论，还是产品与订单，父子关系都能帮助您实现高效的查询。

:::tip
如果您想进一步学习，可以尝试以下练习：
1. 创建一个包含父子关系的索引，并插入一些父文档和子文档。
2. 使用 `has_child` 和 `has_parent` 查询进行实验，观察查询结果。
3. 尝试在父子关系中添加更多层级（例如，祖父-父-子），并设计相应的查询。
:::

希望这篇内容能帮助您更好地理解 Elasticsearch 中的父子关系查询！如果您有任何问题，欢迎在评论区留言讨论。