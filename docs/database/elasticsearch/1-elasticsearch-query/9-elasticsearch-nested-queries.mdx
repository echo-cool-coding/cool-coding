---
title: Elasticsearch 嵌套查询
description: 了解如何在Elasticsearch中使用嵌套查询来处理复杂的数据结构，适合初学者。
---

# Elasticsearch 嵌套查询

Elasticsearch是一个强大的搜索引擎，能够处理各种复杂的数据结构。在实际应用中，我们经常会遇到嵌套对象（nested objects）的情况。嵌套对象是指在一个文档中嵌入另一个文档，这些嵌入的文档可以有自己的字段和结构。为了有效地查询这些嵌套对象，Elasticsearch提供了**嵌套查询（Nested Query）**。

## 什么是嵌套查询？

嵌套查询是Elasticsearch中用于查询嵌套对象的一种特殊查询。嵌套对象在Elasticsearch中被存储为独立的文档，但在逻辑上它们属于父文档的一部分。嵌套查询允许我们在这些嵌套对象上执行复杂的查询操作。

### 嵌套对象的结构

假设我们有一个索引，存储了用户的信息，每个用户可能有多个地址。在这种情况下，地址可以被建模为嵌套对象。以下是一个示例文档结构：

```json
{
  "user": "John Doe",
  "addresses": [
    {
      "city": "New York",
      "zipcode": "10001"
    },
    {
      "city": "San Francisco",
      "zipcode": "94105"
    }
  ]
}
```

在这个例子中，`addresses` 是一个嵌套对象数组，每个地址都有自己的 `city` 和 `zipcode` 字段。

## 如何使用嵌套查询？

要查询嵌套对象，我们需要使用 `nested` 查询。`nested` 查询允许我们在嵌套对象上执行查询，并返回匹配的父文档。

### 基本语法

```json
{
  "query": {
    "nested": {
      "path": "addresses",
      "query": {
        "bool": {
          "must": [
            { "match": { "addresses.city": "New York" } },
            { "match": { "addresses.zipcode": "10001" } }
          ]
        }
      }
    }
  }
}
```

在这个查询中：
- `path` 指定了嵌套对象的路径，这里是 `addresses`。
- `query` 是在嵌套对象上执行的查询条件。

### 示例查询

假设我们想要查找所有居住在纽约且邮政编码为 `10001` 的用户，可以使用以下查询：

```json
{
  "query": {
    "nested": {
      "path": "addresses",
      "query": {
        "bool": {
          "must": [
            { "match": { "addresses.city": "New York" } },
            { "match": { "addresses.zipcode": "10001" } }
          ]
        }
      }
    }
  }
}
```

### 查询结果

如果匹配成功，Elasticsearch将返回包含该嵌套对象的父文档。例如：

```json
{
  "user": "John Doe",
  "addresses": [
    {
      "city": "New York",
      "zipcode": "10001"
    },
    {
      "city": "San Francisco",
      "zipcode": "94105"
    }
  ]
}
```

## 实际应用场景

嵌套查询在实际应用中有很多用途，特别是在处理复杂的数据结构时。以下是一些常见的应用场景：

1. **用户档案管理**：用户可能有多个地址、电话号码或电子邮件地址，这些信息可以存储为嵌套对象，并使用嵌套查询进行检索。
2. **电子商务**：商品可能有多个属性，如颜色、尺寸等，这些属性可以存储为嵌套对象，并使用嵌套查询来筛选商品。
3. **日志分析**：日志数据可能包含多个事件，每个事件都有自己的属性，嵌套查询可以帮助我们分析这些事件。

## 总结

嵌套查询是Elasticsearch中处理嵌套对象的重要工具。通过使用嵌套查询，我们可以在复杂的嵌套数据结构中执行精确的查询操作。希望本文能帮助你理解嵌套查询的基本概念，并在实际应用中灵活使用。

## 附加资源

- [Elasticsearch官方文档 - Nested Query](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-nested-query.html)
- [Elasticsearch Nested Objects](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)

## 练习

1. 创建一个包含嵌套对象的索引，并插入一些示例数据。
2. 尝试使用嵌套查询来检索特定的嵌套对象。
3. 修改查询条件，观察返回结果的变化。

通过实践，你将更好地掌握嵌套查询的使用方法。