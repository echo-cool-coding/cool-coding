---
title: Elasticsearch 嵌套对象
description: 了解Elasticsearch中的嵌套对象，掌握如何建模和查询复杂数据结构。
---

# Elasticsearch 嵌套对象

在Elasticsearch中，嵌套对象（Nested Objects）是一种用于处理复杂数据结构的方式。它允许你将一个对象数组存储为文档的一部分，并且能够独立地查询这些嵌套对象。这对于处理一对多关系的数据非常有用。

## 什么是嵌套对象？

在Elasticsearch中，文档通常是一个扁平的键值对结构。然而，有时我们需要存储更复杂的数据结构，例如一个对象数组。默认情况下，Elasticsearch会将数组中的对象“扁平化”，这意味着数组中的每个字段都会被合并到一个字段中，这可能会导致数据丢失或查询不准确。

嵌套对象通过将数组中的每个对象存储为独立的文档来解决这个问题。这样，每个嵌套对象都可以被独立地索引和查询。

## 如何定义嵌套对象？

要定义嵌套对象，你需要在映射（mapping）中使用 `nested` 类型。以下是一个简单的例子：

```json
PUT /my_index
{
  "mappings": {
    "properties": {
      "user": {
        "type": "nested" 
      }
    }
  }
}
```

在这个例子中，`user` 字段被定义为嵌套类型。这意味着 `user` 字段可以包含一个对象数组，每个对象都可以被独立地索引和查询。

## 插入嵌套对象数据

让我们插入一些数据到索引中：

```json
PUT /my_index/_doc/1
{
  "user": [
    {
      "name": "Alice",
      "age": 25
    },
    {
      "name": "Bob",
      "age": 30
    }
  ]
}
```

在这个例子中，我们插入了一个包含两个用户的文档。每个用户都是一个嵌套对象。

## 查询嵌套对象

要查询嵌套对象，你需要使用 `nested` 查询。以下是一个查询示例，查找年龄为25岁的用户：

```json
GET /my_index/_search
{
  "query": {
    "nested": {
      "path": "user",
      "query": {
        "bool": {
          "must": [
            { "match": { "user.name": "Alice" } },
            { "match": { "user.age": 25 } }
          ]
        }
      }
    }
  }
}
```

在这个查询中，我们指定了 `path` 为 `user`，这意味着我们要查询的是 `user` 嵌套对象。然后我们使用 `bool` 查询来匹配 `name` 为 "Alice" 且 `age` 为 25 的用户。

## 实际应用场景

嵌套对象在实际应用中有很多用途。例如，假设你正在构建一个电商网站，每个商品可能有多个评论。你可以将评论存储为嵌套对象，这样你就可以独立地查询每个评论，而不影响其他评论。

```json
PUT /products
{
  "mappings": {
    "properties": {
      "reviews": {
        "type": "nested"
      }
    }
  }
}

PUT /products/_doc/1
{
  "name": "Laptop",
  "reviews": [
    {
      "user": "Alice",
      "rating": 5,
      "comment": "Great product!"
    },
    {
      "user": "Bob",
      "rating": 3,
      "comment": "Could be better."
    }
  ]
}
```

在这个例子中，`reviews` 字段是一个嵌套对象数组，每个评论都可以被独立地查询。

## 总结

嵌套对象是Elasticsearch中处理复杂数据结构的有力工具。通过将对象数组存储为嵌套对象，你可以独立地索引和查询每个对象，而不会丢失数据或导致查询不准确。

:::tip
在使用嵌套对象时，请注意性能问题。嵌套对象会增加索引的大小，并且在查询时可能会增加计算开销。因此，在设计数据模型时要谨慎使用嵌套对象。
:::

## 附加资源

- [Elasticsearch官方文档 - Nested Objects](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)
- [Elasticsearch Nested Query](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-nested-query.html)

## 练习

1. 创建一个包含嵌套对象的索引，并插入一些数据。
2. 编写一个查询，查找嵌套对象中满足特定条件的文档。
3. 尝试在嵌套对象中使用多个条件进行查询，并观察结果。

通过完成这些练习，你将更好地理解Elasticsearch中的嵌套对象及其应用。