---
title: Elasticsearch 父子文档
description: 了解 Elasticsearch 中的父子文档关系，掌握如何通过父子文档实现复杂数据建模。
---

## 介绍

在 Elasticsearch 中，父子文档（Parent-Child Documents）是一种用于建模一对多关系的机制。通过父子文档，您可以将一个文档（父文档）与多个其他文档（子文档）关联起来。这种关系特别适用于需要表示层次结构或复杂关系的场景，例如博客文章与评论、订单与订单项等。

与嵌套文档（Nested Documents）不同，父子文档允许子文档独立于父文档进行索引和查询。这种独立性使得父子文档在处理大规模数据时更加灵活和高效。

## 父子文档的基本概念

### 1. 父子关系的定义
在 Elasticsearch 中，父子关系是通过在映射（Mapping）中定义的。您需要为父文档和子文档分别创建索引，并在子文档的映射中指定父文档的类型。

例如，假设我们有一个博客系统，其中博客文章是父文档，评论是子文档。我们可以这样定义映射：

```json
PUT /blog
{
  "mappings": {
    "properties": {
      "post_id": { "type": "keyword" },
      "content": { "type": "text" },
      "comments": {
        "type": "join",
        "relations": {
          "post": "comment"
        }
      }
    }
  }
}
```

在这个映射中，`post` 是父文档类型，`comment` 是子文档类型。

### 2. 索引父文档和子文档
父文档和子文档需要分别索引。父文档的索引方式与普通文档相同，而子文档在索引时需要指定其父文档的 ID。

例如，索引一篇博客文章（父文档）：

```json
PUT /blog/_doc/1
{
  "post_id": "1",
  "content": "This is a blog post about Elasticsearch.",
  "comments": {
    "name": "post"
  }
}
```

然后，索引一条评论（子文档）：

```json
PUT /blog/_doc/2?routing=1
{
  "comment_id": "2",
  "content": "Great post!",
  "comments": {
    "name": "comment",
    "parent": "1"
  }
}
```

注意，子文档在索引时需要指定 `routing` 参数，以确保它与父文档存储在同一个分片中。

### 3. 查询父子文档
Elasticsearch 提供了多种查询方式来检索父子文档。例如，您可以使用 `has_child` 查询来查找包含特定子文档的父文档，或者使用 `has_parent` 查询来查找属于特定父文档的子文档。

例如，查找所有包含评论的博客文章：

```json
GET /blog/_search
{
  "query": {
    "has_child": {
      "type": "comment",
      "query": {
        "match_all": {}
      }
    }
  }
}
```

或者，查找属于特定博客文章的所有评论：

```json
GET /blog/_search
{
  "query": {
    "has_parent": {
      "parent_type": "post",
      "query": {
        "match": {
          "post_id": "1"
        }
      }
    }
  }
}
```

## 实际应用场景

### 案例：电商订单系统
假设我们有一个电商系统，其中订单是父文档，订单项是子文档。每个订单可以包含多个订单项。通过父子文档，我们可以轻松地查询某个订单的所有订单项，或者查找包含特定商品的订单。

例如，索引一个订单（父文档）：

```json
PUT /orders/_doc/101
{
  "order_id": "101",
  "customer_name": "John Doe",
  "items": {
    "name": "order"
  }
}
```

然后，索引一个订单项（子文档）：

```json
PUT /orders/_doc/102?routing=101
{
  "item_id": "102",
  "product_name": "Elasticsearch Guide",
  "quantity": 1,
  "items": {
    "name": "item",
    "parent": "101"
  }
}
```

通过这种方式，我们可以轻松地查询某个订单的所有订单项，或者查找包含特定商品的订单。

## 总结

Elasticsearch 的父子文档机制为处理复杂的数据关系提供了强大的工具。通过父子文档，您可以轻松地建模一对多关系，并高效地进行查询和分析。无论是博客系统、电商订单系统，还是其他需要表示层次结构的场景，父子文档都能为您提供灵活的解决方案。

## 附加资源与练习

- **官方文档**：阅读 [Elasticsearch 官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/parent-join.html) 中关于父子文档的更多细节。
- **练习**：尝试在自己的 Elasticsearch 集群中创建一个父子文档的索引，并编写查询来检索父文档和子文档。
- **深入理解**：比较父子文档与嵌套文档的优缺点，思考在什么场景下使用哪种机制更为合适。

通过不断实践和探索，您将能够更好地掌握 Elasticsearch 的父子文档机制，并在实际项目中灵活运用。