---
title: Elasticsearch 升级策略
description: 了解如何规划和执行Elasticsearch的升级策略，确保数据安全和系统稳定性。
---

# Elasticsearch 升级策略

Elasticsearch 是一个强大的分布式搜索和分析引擎，广泛应用于日志分析、全文搜索和实时数据分析等领域。随着 Elasticsearch 的不断发展，新版本带来了性能优化、新功能和安全性改进。因此，定期升级 Elasticsearch 是确保系统高效运行的关键。本文将详细介绍 Elasticsearch 的升级策略，帮助初学者掌握升级的步骤和注意事项。

## 1. 升级前的准备工作

在升级 Elasticsearch 之前，必须做好充分的准备工作，以确保升级过程顺利且不会影响现有系统的正常运行。

### 1.1 检查当前版本

首先，确认当前 Elasticsearch 的版本。可以通过以下命令查看：

```bash
curl -X GET "localhost:9200"
```

输出示例：

```json
{
  "name" : "node-1",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "abc123",
  "version" : {
    "number" : "7.10.0",
    "build_flavor" : "default",
    "build_type" : "tar",
    "build_hash" : "abc123",
    "build_date" : "2020-11-05T10:36:47.659Z",
    "build_snapshot" : false,
    "lucene_version" : "8.7.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

### 1.2 阅读升级文档

Elasticsearch 的每个版本都有相应的升级文档，详细说明了从旧版本升级到新版本的步骤和注意事项。务必仔细阅读这些文档，了解是否有任何破坏性变更或需要特别注意的地方。

### 1.3 备份数据

在升级之前，务必备份所有数据。可以使用 Elasticsearch 的快照功能来创建数据备份：

```bash
PUT /_snapshot/my_backup/snapshot_1
{
  "indices": "*",
  "ignore_unavailable": true,
  "include_global_state": false
}
```

### 1.4 测试升级

在生产环境升级之前，建议在测试环境中进行升级测试，以确保升级过程不会导致数据丢失或系统崩溃。

## 2. 升级策略

Elasticsearch 的升级策略主要分为两种：滚动升级和全集群重启升级。

### 2.1 滚动升级

滚动升级适用于 Elasticsearch 集群中的节点数量较多的情况。通过逐个升级节点，可以确保集群在升级过程中仍然可用。

#### 2.1.1 滚动升级步骤

1. **禁用分片分配**：在升级过程中，为了防止分片在节点之间频繁迁移，可以禁用分片分配：

   ```bash
   PUT /_cluster/settings
   {
     "persistent": {
       "cluster.routing.allocation.enable": "none"
     }
   }
   ```

2. **停止一个节点**：停止集群中的一个节点。

3. **升级节点**：下载并安装新版本的 Elasticsearch，然后启动该节点。

4. **重新启用分片分配**：在节点启动并加入集群后，重新启用分片分配：

   ```bash
   PUT /_cluster/settings
   {
     "persistent": {
       "cluster.routing.allocation.enable": "all"
     }
   }
   ```

5. **重复步骤 2-4**：逐个升级集群中的其他节点。

### 2.2 全集群重启升级

全集群重启升级适用于 Elasticsearch 集群中的节点数量较少的情况。在这种策略下，所有节点都需要停止并升级，然后重新启动。

#### 2.2.1 全集群重启升级步骤

1. **停止所有节点**：停止集群中的所有节点。

2. **升级所有节点**：下载并安装新版本的 Elasticsearch。

3. **启动所有节点**：启动所有节点，确保它们重新加入集群。

## 3. 升级后的验证

升级完成后，必须进行验证，以确保集群正常运行且数据完整。

### 3.1 检查集群状态

使用以下命令检查集群状态：

```bash
GET /_cluster/health
```

输出示例：

```json
{
  "cluster_name" : "elasticsearch",
  "status" : "green",
  "timed_out" : false,
  "number_of_nodes" : 3,
  "number_of_data_nodes" : 3,
  "active_primary_shards" : 10,
  "active_shards" : 20,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 0,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 100.0
}
```

### 3.2 检查索引状态

确保所有索引都处于正常状态：

```bash
GET /_cat/indices?v
```

### 3.3 测试搜索功能

执行一些搜索查询，确保搜索功能正常：

```bash
GET /my_index/_search
{
  "query": {
    "match_all": {}
  }
}
```

## 4. 实际案例

假设我们有一个包含 5 个节点的 Elasticsearch 集群，当前版本为 7.10.0，计划升级到 8.0.0。我们可以采用滚动升级策略，逐个升级节点，确保集群在升级过程中仍然可用。

### 4.1 升级步骤

1. **禁用分片分配**：

   ```bash
   PUT /_cluster/settings
   {
     "persistent": {
       "cluster.routing.allocation.enable": "none"
     }
   }
   ```

2. **停止并升级第一个节点**：

   ```bash
   # 停止节点
   systemctl stop elasticsearch

   # 升级 Elasticsearch
   wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.0.0-linux-x86_64.tar.gz
   tar -xzf elasticsearch-8.0.0-linux-x86_64.tar.gz
   ```

3. **启动升级后的节点**：

   ```bash
   ./elasticsearch-8.0.0/bin/elasticsearch
   ```

4. **重新启用分片分配**：

   ```bash
   PUT /_cluster/settings
   {
     "persistent": {
       "cluster.routing.allocation.enable": "all"
     }
   }
   ```

5. **重复步骤 2-4**，逐个升级其他节点。

## 5. 总结

Elasticsearch 的升级是确保系统高效运行和安全性的重要步骤。通过合理的升级策略和充分的准备工作，可以最大限度地减少升级过程中对系统的影响。无论是滚动升级还是全集群重启升级，都需要仔细规划和执行。

:::tip
在升级过程中，务必遵循 Elasticsearch 官方文档的建议，并在生产环境升级之前进行充分的测试。
:::

## 6. 附加资源

- [Elasticsearch 官方升级指南](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-upgrade.html)
- [Elasticsearch 快照和恢复](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots.html)
- [Elasticsearch 集群健康 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html)

## 7. 练习

1. 在测试环境中部署一个 Elasticsearch 集群，并尝试从 7.x 版本升级到 8.x 版本。
2. 使用快照功能备份集群数据，并在升级后恢复数据。
3. 尝试使用滚动升级策略升级一个包含多个节点的 Elasticsearch 集群。

通过以上练习，您将更好地掌握 Elasticsearch 的升级策略和操作步骤。