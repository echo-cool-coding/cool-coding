---
title: Kubernetes 端口映射
description: 了解Kubernetes中的端口映射概念，掌握如何通过端口映射将服务暴露给外部网络，并学习实际应用场景。
---

# Kubernetes 端口映射

在Kubernetes中，端口映射是一个关键概念，它允许你将容器内部的端口映射到外部网络，从而使服务能够被外部访问。本文将详细介绍Kubernetes中的端口映射，并通过实际案例帮助你理解其工作原理。

## 什么是端口映射？

端口映射是指将容器内部的端口与外部网络的端口进行关联的过程。在Kubernetes中，容器通常运行在Pod中，而Pod的IP地址是集群内部的，外部网络无法直接访问。通过端口映射，你可以将Pod中的服务暴露给外部网络，使得外部客户端能够访问这些服务。

## Kubernetes 中的端口映射

在Kubernetes中，端口映射通常通过Service资源来实现。Service是Kubernetes中的一种抽象，它定义了一组Pod的访问策略。通过Service，你可以将Pod的端口映射到集群的IP地址和端口上，从而使得外部网络能够访问这些Pod。

### Service的类型

Kubernetes中的Service有以下几种类型：

1. **ClusterIP**：默认类型，Service通过集群内部的IP地址暴露服务，只能在集群内部访问。
2. **NodePort**：在集群的每个节点上开放一个端口，外部网络可以通过节点的IP地址和该端口访问服务。
3. **LoadBalancer**：通过云服务提供商的负载均衡器暴露服务，外部网络可以通过负载均衡器的IP地址访问服务。
4. **ExternalName**：通过返回CNAME记录将服务映射到外部域名。

### 端口映射的配置

在Kubernetes中，端口映射的配置通常在Service的YAML文件中定义。以下是一个简单的Service配置示例：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: NodePort
```

在这个示例中，Service将Pod的`8080`端口映射到集群的`80`端口，并通过`NodePort`类型暴露给外部网络。

### 实际案例

假设你有一个运行在Pod中的Web应用，该应用监听`8080`端口。你希望通过Kubernetes将该应用暴露给外部网络，使得外部客户端可以通过`http://<node-ip>:30000`访问该应用。

1. 首先，创建一个Pod的YAML文件：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-web-app
  labels:
    app: my-app
spec:
  containers:
    - name: web-container
      image: my-web-app-image
      ports:
        - containerPort: 8080
```

2. 然后，创建一个Service的YAML文件：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: NodePort
```

3. 应用这些配置文件：

```bash
kubectl apply -f pod.yaml
kubectl apply -f service.yaml
```

4. 最后，你可以通过`http://<node-ip>:30000`访问该Web应用。

:::note
`NodePort`类型的Service会在集群的每个节点上开放一个端口（默认范围是30000-32767），外部网络可以通过该端口访问服务。
:::

## 总结

Kubernetes中的端口映射是通过Service资源实现的，它允许你将容器内部的端口映射到外部网络，从而使得外部客户端能够访问这些服务。通过`NodePort`、`LoadBalancer`等类型的Service，你可以灵活地将服务暴露给外部网络。

## 附加资源

- [Kubernetes官方文档 - Service](https://kubernetes.io/docs/concepts/services-networking/service/)
- [Kubernetes官方文档 - Port Forwarding](https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/)

## 练习

1. 创建一个简单的Web应用Pod，并将其通过`NodePort`类型的Service暴露给外部网络。
2. 尝试使用`LoadBalancer`类型的Service将应用暴露给外部网络，并观察其与`NodePort`的区别。
3. 通过`kubectl port-forward`命令将Pod的端口映射到本地端口，并通过本地浏览器访问该应用。

通过以上练习，你将更深入地理解Kubernetes中的端口映射概念及其实际应用。