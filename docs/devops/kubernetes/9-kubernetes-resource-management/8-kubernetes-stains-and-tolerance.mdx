---
title: Kubernetes 污点与容忍
description: "了解Kubernetes中的污点（Taints）与容忍（Tolerations）机制，掌握如何通过它们控制Pod调度，确保集群资源的高效利用。"
---

## 什么是Kubernetes污点与容忍？

在Kubernetes中，**污点（Taints）**和**容忍（Tolerations）**是用于控制Pod调度的机制。污点允许节点拒绝运行某些Pod，而容忍则允许Pod“容忍”这些污点，从而在特定节点上运行。这种机制通常用于确保某些节点只运行特定的工作负载，或者防止某些Pod被调度到不合适的节点上。

### 污点（Taints）

污点是节点上的一个属性，它告诉调度器：“除非Pod明确声明可以容忍这个污点，否则不要将Pod调度到这个节点上。”污点由三个部分组成：
- **Key**: 污点的标识符。
- **Value**: 污点的值（可选）。
- **Effect**: 污点的效果，可以是以下三种之一：
  - `NoSchedule`: 禁止调度Pod到该节点。
  - `PreferNoSchedule`: 尽量避免调度Pod到该节点，但不是绝对禁止。
  - `NoExecute`: 不仅禁止调度，还会驱逐已经运行在该节点上的Pod（如果它们不容忍该污点）。

### 容忍（Tolerations）

容忍是Pod的一个属性，它告诉调度器：“我可以容忍某些污点，因此可以调度到带有这些污点的节点上。”容忍的定义与污点类似，包含`key`、`value`和`effect`字段。

---

## 污点与容忍的工作原理

### 1. 添加污点到节点

假设我们有一个节点`node-1`，我们希望它只运行带有特定标签的Pod。我们可以通过以下命令为该节点添加污点：

```bash
kubectl taint nodes node-1 key=value:NoSchedule
```

这表示任何不容忍`key=value:NoSchedule`的Pod都不会被调度到`node-1`上。

### 2. 定义Pod的容忍

为了让Pod能够调度到带有污点的节点上，我们需要在Pod的配置中定义容忍。例如：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: nginx
    image: nginx
  tolerations:
  - key: "key"
    operator: "Equal"
    value: "value"
    effect: "NoSchedule"
```

这个Pod定义了一个容忍，允许它调度到带有`key=value:NoSchedule`污点的节点上。

---

## 实际应用场景

### 场景1：专用节点

假设我们有一个GPU节点`gpu-node`，我们希望它只运行需要GPU的Pod。我们可以为该节点添加污点：

```bash
kubectl taint nodes gpu-node gpu=true:NoSchedule
```

然后，只有那些定义了相应容忍的Pod才能调度到这个节点上：

```yaml
tolerations:
- key: "gpu"
  operator: "Equal"
  value: "true"
  effect: "NoSchedule"
```

### 场景2：节点维护

在节点维护期间，我们可以为节点添加`NoExecute`污点，以驱逐所有不容忍该污点的Pod：

```bash
kubectl taint nodes node-1 maintenance=true:NoExecute
```

只有那些定义了以下容忍的Pod才能继续运行：

```yaml
tolerations:
- key: "maintenance"
  operator: "Equal"
  value: "true"
  effect: "NoExecute"
```

---

## 总结

污点与容忍是Kubernetes中强大的调度控制机制，允许管理员精确控制Pod在集群中的分布。通过合理使用污点和容忍，可以确保关键工作负载运行在合适的节点上，同时避免资源浪费。

:::tip
**小提示**：污点和容忍通常与节点亲和性（Node Affinity）结合使用，以实现更复杂的调度策略。
:::

---

## 附加资源与练习

### 练习
1. 创建一个带有污点的节点，并尝试调度一个不容忍该污点的Pod，观察调度结果。
2. 修改Pod的定义，添加容忍，再次尝试调度，观察结果。

### 进一步学习
- [Kubernetes官方文档 - 污点与容忍](https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/)
- [Kubernetes调度策略详解](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/)
