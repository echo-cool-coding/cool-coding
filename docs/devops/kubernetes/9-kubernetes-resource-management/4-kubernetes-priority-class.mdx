---
title: Kubernetes 优先级类
description: 了解Kubernetes中的优先级类（PriorityClass），如何定义和使用它们来管理Pod的调度优先级。
---

# Kubernetes 优先级类

在Kubernetes中，**优先级类（PriorityClass）** 是一种用于定义Pod调度优先级的方式。通过优先级类，Kubernetes可以更好地管理集群资源，确保高优先级的Pod能够在资源紧张时优先被调度和执行。本文将详细介绍优先级类的概念、使用方法以及实际应用场景。

## 什么是优先级类？

优先级类是一个Kubernetes资源对象，用于定义Pod的优先级。每个优先级类都有一个整数值（`value`），表示其优先级的高低。数值越大，优先级越高。Kubernetes调度器会根据Pod的优先级来决定哪些Pod应该优先调度到节点上。

优先级类的主要作用是：
- **资源争用时的优先级控制**：当集群资源不足时，高优先级的Pod会被优先调度，而低优先级的Pod可能会被延迟调度或驱逐。
- **系统Pod的优先级保障**：Kubernetes系统组件（如kube-scheduler、kube-controller-manager等）通常使用高优先级类，以确保它们始终能够运行。

:::note
优先级类仅影响Pod的调度顺序，不会直接分配更多的资源（如CPU或内存）给高优先级的Pod。
:::

## 定义优先级类

优先级类通过YAML文件定义。以下是一个优先级类的示例：

```yaml
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000
globalDefault: false
description: "This priority class should be used for high priority pods."
```

- **`value`**：表示优先级类的数值。数值越大，优先级越高。
- **`globalDefault`**：如果设置为`true`，则该优先级类将成为所有未指定优先级类的Pod的默认优先级类。一个集群中只能有一个优先级类的`globalDefault`为`true`。
- **`description`**：对该优先级类的描述。

:::caution
如果多个优先级类的`globalDefault`设置为`true`，Kubernetes会拒绝创建这些优先级类。确保只有一个优先级类是全局默认的。
:::

## 使用优先级类

在Pod的定义中，可以通过`priorityClassName`字段指定优先级类。以下是一个使用优先级类的Pod示例：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: high-priority-pod
spec:
  containers:
  - name: nginx
    image: nginx
  priorityClassName: high-priority
```

在这个示例中，Pod `high-priority-pod` 使用了名为 `high-priority` 的优先级类。Kubernetes调度器会根据该优先级类的值来决定Pod的调度顺序。

## 优先级类的实际应用场景

### 1. 系统关键Pod的优先级保障

Kubernetes系统组件（如kube-apiserver、kube-scheduler等）通常需要高优先级，以确保它们在任何情况下都能正常运行。可以通过为这些Pod分配高优先级类来实现。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-scheduler
  namespace: kube-system
spec:
  containers:
  - name: kube-scheduler
    image: k8s.gcr.io/kube-scheduler:v1.22.0
  priorityClassName: system-cluster-critical
```

### 2. 业务关键应用的优先级控制

在业务场景中，某些应用可能比其他应用更为关键。例如，支付系统的Pod可能比日志收集系统的Pod更为重要。可以通过为支付系统的Pod分配高优先级类来确保其优先调度。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: payment-service
spec:
  containers:
  - name: payment
    image: payment-service:latest
  priorityClassName: high-priority
```

## 优先级类与Pod抢占

当集群资源不足时，Kubernetes可能会触发**Pod抢占（Preemption）**。高优先级的Pod可以抢占低优先级Pod的资源，以确保其能够被调度。抢占行为由Kubernetes调度器自动处理，但可以通过配置优先级类来控制抢占的粒度。

:::warning
Pod抢占可能会导致低优先级Pod被驱逐或终止，因此在使用高优先级类时需要谨慎。
:::

## 总结

Kubernetes优先级类是一种强大的工具，用于管理Pod的调度优先级。通过合理使用优先级类，可以确保关键应用和系统组件在资源紧张时优先运行。本文介绍了优先级类的定义、使用方法以及实际应用场景，希望能够帮助你更好地理解和使用这一功能。

## 附加资源与练习

- **Kubernetes官方文档**：[PriorityClass](https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/)
- **练习**：尝试在你的Kubernetes集群中创建两个优先级类，并分别分配给不同的Pod，观察调度器的行为。

:::tip
在实际生产环境中，建议为系统关键Pod和业务关键应用分配高优先级类，以确保它们的稳定运行。
:::