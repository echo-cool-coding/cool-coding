---
title: Kubernetes Kustomize
description: 了解如何使用 Kubernetes Kustomize 工具来管理和定制 Kubernetes 资源配置文件。
---

# Kubernetes Kustomize

Kubernetes Kustomize 是一个用于定制 Kubernetes 资源配置文件的工具。它允许你通过声明式的方式管理和生成 Kubernetes 资源，而无需直接修改原始的 YAML 文件。Kustomize 的核心思想是通过“叠加”（overlays）和“基础”（bases）来管理不同环境或场景下的资源配置。

## 什么是 Kustomize？

Kustomize 是一个命令行工具，也是 `kubectl` 的一部分（从 `kubectl` 1.14 版本开始集成）。它通过一个名为 `kustomization.yaml` 的文件来定义如何定制 Kubernetes 资源。Kustomize 的主要优势在于它允许你保持原始的 YAML 文件不变，同时通过叠加的方式生成适合不同环境的配置。

## Kustomize 的核心概念

### 1. 基础（Base）
基础是一个包含 Kubernetes 资源配置文件的目录。这些文件通常是通用的配置，适用于所有环境。例如，你可能有一个基础目录，其中包含部署、服务和配置映射的定义。

```yaml
# base/kustomization.yaml
resources:
  - deployment.yaml
  - service.yaml
```

### 2. 叠加（Overlay）
叠加是一个目录，它基于基础配置进行定制。叠加目录中的 `kustomization.yaml` 文件定义了如何修改基础配置。例如，你可以为开发环境和生产环境创建不同的叠加目录。

```yaml
# overlays/dev/kustomization.yaml
bases:
  - ../../base
patchesStrategicMerge:
  - deployment-patch.yaml
```

### 3. 补丁（Patch）
补丁是用于修改基础配置的 YAML 文件。Kustomize 支持多种补丁方式，包括 `patchesStrategicMerge` 和 `json6902` 补丁。

```yaml
# overlays/dev/deployment-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
```

## 实际案例

假设我们有一个简单的 Kubernetes 应用，包含一个部署和一个服务。我们将使用 Kustomize 来管理这个应用的配置。

### 基础配置

首先，我们创建一个基础目录 `base`，其中包含部署和服务的定义。

```yaml
# base/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 1
  template:
    spec:
      containers:
        - name: my-app
          image: my-app:1.0.0
```

```yaml
# base/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-app
spec:
  ports:
    - port: 80
      targetPort: 8080
```

```yaml
# base/kustomization.yaml
resources:
  - deployment.yaml
  - service.yaml
```

### 开发环境叠加

接下来，我们为开发环境创建一个叠加目录 `overlays/dev`。在这个目录中，我们将修改部署的副本数为 3。

```yaml
# overlays/dev/deployment-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
```

```yaml
# overlays/dev/kustomization.yaml
bases:
  - ../../base
patchesStrategicMerge:
  - deployment-patch.yaml
```

### 生成配置

使用 Kustomize 生成开发环境的配置：

```bash
kustomize build overlays/dev
```

输出将是开发环境的 Kubernetes 资源配置，其中部署的副本数已被修改为 3。

## 总结

Kubernetes Kustomize 是一个强大的工具，可以帮助你管理和定制 Kubernetes 资源配置。通过使用基础和叠加的概念，你可以轻松地为不同环境生成不同的配置，而无需直接修改原始的 YAML 文件。

## 附加资源

- [Kustomize 官方文档](https://kubectl.docs.kubernetes.io/references/kustomize/)
- [Kubernetes 官方文档](https://kubernetes.io/docs/home/)

## 练习

1. 创建一个基础配置，包含一个部署和一个服务。
2. 为生产环境创建一个叠加目录，修改部署的副本数为 5。
3. 使用 Kustomize 生成生产环境的配置，并验证输出。
