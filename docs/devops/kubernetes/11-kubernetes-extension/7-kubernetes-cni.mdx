---
title: Kubernetes CNI
description: 了解 Kubernetes CNI（容器网络接口）的基本概念、工作原理及其在 Kubernetes 集群中的应用。
---

# Kubernetes CNI

## 介绍

Kubernetes CNI（Container Network Interface，容器网络接口）是 Kubernetes 中用于管理容器网络的标准接口。它定义了容器运行时与网络插件之间的交互方式，使得 Kubernetes 能够灵活地支持多种网络解决方案。CNI 的主要职责是为 Pod 分配 IP 地址、配置网络接口以及管理网络连接。

在 Kubernetes 中，每个 Pod 都有自己的 IP 地址，这些 IP 地址由 CNI 插件分配和管理。CNI 插件可以是开源的（如 Calico、Flannel、Weave 等），也可以是商业的。通过 CNI，Kubernetes 能够实现跨节点的 Pod 通信、网络策略管理以及负载均衡等功能。

## CNI 的工作原理

CNI 的核心是一个简单的 JSON 配置文件，它定义了网络插件的名称、类型以及所需的参数。当 Kubernetes 创建一个 Pod 时，它会调用 CNI 插件来为 Pod 配置网络。CNI 插件会执行以下操作：

1. **分配 IP 地址**：为 Pod 分配一个唯一的 IP 地址。
2. **配置网络接口**：将 Pod 的网络接口连接到宿主机的网络。
3. **设置路由**：确保 Pod 能够与其他 Pod 或外部网络通信。

:::note
CNI 插件是独立于 Kubernetes 的，这意味着你可以选择不同的网络插件来满足特定的需求。
:::

## CNI 配置文件示例

以下是一个简单的 CNI 配置文件示例：

```json
{
  "cniVersion": "0.4.0",
  "name": "mynet",
  "type": "bridge",
  "bridge": "cni0",
  "isGateway": true,
  "ipMasq": true,
  "ipam": {
    "type": "host-local",
    "subnet": "10.244.0.0/16",
    "routes": [
      { "dst": "0.0.0.0/0" }
    ]
  }
}
```

在这个配置文件中：
- `type` 指定了使用的网络插件类型（如 `bridge`）。
- `bridge` 指定了网络桥接接口的名称。
- `ipam` 指定了 IP 地址管理的方式（如 `host-local`）。

## CNI 插件的实际应用

### 案例 1：使用 Flannel 插件

Flannel 是一个流行的 CNI 插件，它为 Kubernetes 集群提供了一个简单的网络层。Flannel 使用 `host-gw` 或 `VXLAN` 模式来实现跨节点的 Pod 通信。

以下是如何在 Kubernetes 集群中部署 Flannel 的步骤：

1. 下载 Flannel 的 YAML 配置文件：

   ```bash
   kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
   ```

2. 等待 Flannel 部署完成：

   ```bash
   kubectl get pods -n kube-system
   ```

3. 验证网络是否正常工作：

   ```bash
   kubectl get nodes -o wide
   ```

### 案例 2：使用 Calico 插件

Calico 是另一个强大的 CNI 插件，它不仅提供了网络连接功能，还支持网络策略（Network Policies），允许你定义精细的访问控制规则。

以下是如何在 Kubernetes 集群中部署 Calico 的步骤：

1. 下载 Calico 的 YAML 配置文件：

   ```bash
   kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
   ```

2. 等待 Calico 部署完成：

   ```bash
   kubectl get pods -n kube-system
   ```

3. 验证网络策略是否生效：

   ```bash
   kubectl get networkpolicies --all-namespaces
   ```

## CNI 的网络拓扑

为了更好地理解 CNI 的工作原理，我们可以通过 Mermaid 图表来展示 Kubernetes 集群中的网络拓扑。

```mermaid
graph TD
    subgraph Node1
        Pod1 -->|CNI Plugin| Bridge1
        Bridge1 -->|Host Network| Node1
    end
    subgraph Node2
        Pod2 -->|CNI Plugin| Bridge2
        Bridge2 -->|Host Network| Node2
    end
    Node1 -->|Overlay Network| Node2
```

在这个图表中：
- `Pod1` 和 `Pod2` 分别位于不同的节点上。
- `CNI Plugin` 负责为 Pod 配置网络接口。
- `Overlay Network` 负责跨节点的 Pod 通信。

## 总结

Kubernetes CNI 是 Kubernetes 网络管理的核心组件，它通过标准化的接口使得 Kubernetes 能够支持多种网络插件。通过 CNI，Kubernetes 能够实现 Pod 之间的通信、网络策略管理以及负载均衡等功能。选择合适的 CNI 插件对于构建高效、安全的 Kubernetes 集群至关重要。

## 附加资源与练习

- **官方文档**：[Kubernetes CNI](https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/)
- **练习**：尝试在不同的 Kubernetes 集群中部署不同的 CNI 插件（如 Flannel 和 Calico），并观察它们的行为差异。
- **进一步学习**：深入研究 CNI 插件的源码，了解其内部实现机制。

:::tip
如果你对 Kubernetes 网络有更深入的需求，建议学习 Kubernetes 的网络策略（Network Policies）和服务网格（Service Mesh）相关内容。
:::