---
title: Kubernetes 节点维护
description: 了解如何在Kubernetes集群中执行节点维护，确保高可用性和应用程序的持续运行。本文适合初学者，涵盖节点维护的基本概念、操作步骤和实际案例。
---

## 介绍

在Kubernetes集群中，节点（Node）是承载工作负载的物理或虚拟机器。为了确保集群的高可用性和稳定性，节点维护是必不可少的操作。节点维护可能涉及硬件升级、操作系统更新、资源扩展等任务。本文将详细介绍如何在Kubernetes中安全地执行节点维护，确保应用程序不受影响。

## 节点维护的基本概念

节点维护的核心目标是在不影响集群整体运行的情况下，对单个节点进行维护操作。Kubernetes提供了多种机制来实现这一点，包括**节点排空（Drain）**、**节点标记为不可调度（Cordon）**和**节点重新调度（Uncordon）**。

### 节点排空（Drain）

节点排空是指将节点上的所有Pod安全地迁移到其他节点上，以便对该节点进行维护。排空操作会确保Pod的优雅终止，并重新调度它们到其他可用节点。

### 节点标记为不可调度（Cordon）

标记节点为不可调度意味着Kubernetes调度器将不再将新的Pod调度到该节点上。这通常用于准备节点维护，防止新的工作负载被分配到即将维护的节点。

### 节点重新调度（Uncordon）

维护完成后，节点需要重新标记为可调度状态，以便Kubernetes调度器可以将新的Pod调度到该节点上。

## 节点维护的操作步骤

### 1. 标记节点为不可调度

首先，使用以下命令将节点标记为不可调度：

```bash
kubectl cordon <node-name>
```

例如：

```bash
kubectl cordon node-1
```

此命令将阻止新的Pod被调度到`node-1`上。

### 2. 排空节点

接下来，使用以下命令排空节点上的所有Pod：

```bash
kubectl drain <node-name> --ignore-daemonsets --delete-local-data
```

例如：

```bash
kubectl drain node-1 --ignore-daemonsets --delete-local-data
```

:::note
`--ignore-daemonsets`选项用于忽略DaemonSet管理的Pod，因为这些Pod通常需要在每个节点上运行。`--delete-local-data`选项用于删除使用本地存储的Pod。
:::

### 3. 执行维护操作

在节点排空后，您可以安全地执行维护操作，例如升级操作系统、更换硬件或调整资源配置。

### 4. 重新标记节点为可调度

维护完成后，使用以下命令将节点重新标记为可调度：

```bash
kubectl uncordon <node-name>
```

例如：

```bash
kubectl uncordon node-1
```

此命令将允许Kubernetes调度器将新的Pod调度到`node-1`上。

## 实际案例

假设您有一个三节点的Kubernetes集群，其中`node-1`需要升级操作系统。以下是操作步骤：

1. **标记`node-1`为不可调度**：

   ```bash
   kubectl cordon node-1
   ```

2. **排空`node-1`上的所有Pod**：

   ```bash
   kubectl drain node-1 --ignore-daemonsets --delete-local-data
   ```

3. **升级`node-1`的操作系统**。

4. **重新标记`node-1`为可调度**：

   ```bash
   kubectl uncordon node-1
   ```

通过以上步骤，您可以确保在升级过程中，集群中的应用程序不会受到影响。

## 总结

节点维护是Kubernetes集群管理中的重要操作，确保集群的高可用性和稳定性。通过使用`kubectl cordon`、`kubectl drain`和`kubectl uncordon`命令，您可以安全地执行节点维护操作，避免对应用程序造成影响。

## 附加资源

- [Kubernetes官方文档 - 节点维护](https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/)
- [Kubernetes节点管理最佳实践](https://kubernetes.io/docs/concepts/architecture/nodes/)

## 练习

1. 在一个测试集群中，尝试对一个节点执行排空操作，并观察Pod的重新调度过程。
2. 模拟一个节点维护场景，使用`kubectl cordon`和`kubectl uncordon`命令，确保新的Pod不会被调度到维护中的节点上。
