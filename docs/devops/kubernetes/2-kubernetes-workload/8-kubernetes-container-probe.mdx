---
title: Kubernetes 容器探针
description: 了解Kubernetes中的容器探针，包括其类型、工作原理以及如何在实际场景中使用它们来确保应用程序的健康和可用性。
---

# Kubernetes 容器探针

Kubernetes容器探针是一种用于监控容器健康状况的机制。它们帮助Kubernetes确定容器是否准备好接收流量（就绪探针）、是否正在运行（存活探针）以及是否应该重启（启动探针）。通过使用探针，Kubernetes可以自动处理容器的故障，确保应用程序的高可用性。

## 探针的类型

Kubernetes支持三种类型的探针：

1. **存活探针（Liveness Probe）**：用于检测容器是否仍在运行。如果探针失败，Kubernetes会杀死容器并重新启动它。
2. **就绪探针（Readiness Probe）**：用于检测容器是否准备好接收流量。如果探针失败，Kubernetes会从服务的负载均衡器中移除该容器。
3. **启动探针（Startup Probe）**：用于检测容器是否已经启动完成。如果探针失败，Kubernetes会延迟其他探针的执行，直到启动探针成功。

## 探针的工作原理

探针通过定期执行以下操作来检查容器的健康状况：

- **HTTP GET请求**：向容器内的指定端点发送HTTP GET请求，并根据响应状态码判断探针是否成功。
- **TCP Socket连接**：尝试与容器内的指定端口建立TCP连接，如果连接成功，则探针成功。
- **Exec命令**：在容器内执行指定的命令，如果命令返回状态码为0，则探针成功。

## 配置探针

以下是一个配置存活探针和就绪探针的示例：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: my-container
    image: my-image
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 3
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10
```

在这个示例中，存活探针每10秒检查一次`/healthz`端点，而就绪探针每10秒检查一次`/ready`端点。`initialDelaySeconds`参数用于指定探针在容器启动后延迟多少秒开始执行。

## 实际应用场景

### 场景1：确保应用程序健康

假设你有一个Web应用程序，它在启动时需要加载大量数据。你可以使用启动探针来确保应用程序在完全启动之前不会接收流量。一旦启动探针成功，Kubernetes会开始执行存活探针和就绪探针。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-app
spec:
  containers:
  - name: web-container
    image: web-image
    startupProbe:
      httpGet:
        path: /startup
        port: 8080
      failureThreshold: 30
      periodSeconds: 10
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      periodSeconds: 10
```

在这个示例中，启动探针会尝试30次，每次间隔10秒，直到`/startup`端点返回成功状态码。

### 场景2：处理长时间运行的任务

如果你的容器需要执行长时间运行的任务，你可以使用存活探针来确保任务仍在进行中。如果任务失败，Kubernetes会重启容器。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: long-running-task
spec:
  containers:
  - name: task-container
    image: task-image
    livenessProbe:
      exec:
        command:
        - /bin/sh
        - -c
        - ps aux | grep my-task
      initialDelaySeconds: 60
      periodSeconds: 30
```

在这个示例中，存活探针会每30秒检查一次`my-task`进程是否仍在运行。

## 总结

Kubernetes容器探针是确保应用程序健康和可用性的重要工具。通过合理配置存活探针、就绪探针和启动探针，你可以让Kubernetes自动处理容器的故障，确保应用程序的高可用性。

:::tip
在实际使用中，建议根据应用程序的具体需求调整探针的配置参数，如`initialDelaySeconds`、`periodSeconds`和`failureThreshold`，以确保探针能够准确反映容器的健康状况。
:::

## 附加资源

- [Kubernetes官方文档 - 容器探针](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes)
- [Kubernetes探针配置指南](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/)

## 练习

1. 创建一个Pod，配置存活探针和就绪探针，并观察Kubernetes如何处理探针失败的情况。
2. 修改探针的配置参数，如`initialDelaySeconds`和`periodSeconds`，观察这些参数对探针行为的影响。