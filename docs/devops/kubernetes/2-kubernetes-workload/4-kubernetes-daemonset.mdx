---
title: Kubernetes DaemonSet
description: 了解 Kubernetes DaemonSet 的概念、用途以及如何在实际场景中使用它来管理集群中的节点级工作负载。
---

# Kubernetes DaemonSet

## 介绍

在 Kubernetes 中，**DaemonSet** 是一种控制器，用于确保集群中的每个节点（或符合特定条件的节点）都运行一个特定的 Pod 副本。与 Deployment 或 ReplicaSet 不同，DaemonSet 不是根据副本数量来调度 Pod，而是根据节点的数量来调度。这使得 DaemonSet 非常适合运行节点级别的守护进程，例如日志收集器、监控代理或网络插件。

:::note
DaemonSet 确保每个节点上都有一个 Pod 实例运行。如果新节点加入集群，DaemonSet 会自动在该节点上创建 Pod；如果节点被移除，DaemonSet 也会删除该节点上的 Pod。
:::

## DaemonSet 的工作原理

DaemonSet 的核心功能是确保每个节点上都有一个 Pod 实例运行。它的工作原理如下：

1. **节点匹配**：DaemonSet 使用节点选择器（`nodeSelector`）或节点亲和性（`nodeAffinity`）来确定哪些节点应该运行 Pod。
2. **Pod 创建**：DaemonSet 控制器会为每个匹配的节点创建一个 Pod。
3. **节点变化**：当新节点加入集群时，DaemonSet 会自动在该节点上创建 Pod；当节点被移除时，DaemonSet 会删除该节点上的 Pod。

## 创建 DaemonSet

以下是一个简单的 DaemonSet 示例，它会在每个节点上运行一个 Nginx Pod：

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nginx-daemonset
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

在这个示例中：

- `selector.matchLabels` 用于选择 DaemonSet 管理的 Pod。
- `template` 定义了 Pod 的模板，包括容器镜像、端口等。

:::tip
你可以使用 `kubectl apply -f daemonset.yaml` 命令将上述 YAML 文件应用到 Kubernetes 集群中。
:::

## 实际应用场景

DaemonSet 在许多场景中都非常有用，以下是一些常见的应用场景：

1. **日志收集**：在每个节点上运行一个日志收集器（如 Fluentd 或 Filebeat），用于收集节点和容器的日志。
2. **监控代理**：在每个节点上运行一个监控代理（如 Prometheus Node Exporter），用于收集节点的监控数据。
3. **网络插件**：在每个节点上运行网络插件（如 Calico 或 Weave），用于管理容器的网络配置。

## 示例：日志收集器

假设你需要在每个节点上运行一个 Fluentd 日志收集器，以下是一个 DaemonSet 的示例：

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-logging
spec:
  selector:
    matchLabels:
      name: fluentd-logging
  template:
    metadata:
      labels:
        name: fluentd-logging
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd:latest
        volumeMounts:
        - name: varlog
          mountPath: /var/log
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
```

在这个示例中，Fluentd 容器会挂载节点的 `/var/log` 目录，以便收集节点上的日志。

## 总结

DaemonSet 是 Kubernetes 中用于管理节点级别工作负载的强大工具。它确保每个节点上都有一个特定的 Pod 实例运行，非常适合用于日志收集、监控代理和网络插件等场景。

:::caution
在使用 DaemonSet 时，请确保你的 Pod 不会占用过多的节点资源，以免影响其他工作负载的运行。
:::

## 附加资源

- [Kubernetes 官方文档：DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/)
- [Kubernetes DaemonSet 实战](https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/)

## 练习

1. 创建一个 DaemonSet，在每个节点上运行一个 Redis 容器。
2. 修改现有的 DaemonSet，使其只在带有 `gpu=true` 标签的节点上运行 Pod。

通过完成这些练习，你将更好地理解 DaemonSet 的工作原理和应用场景。