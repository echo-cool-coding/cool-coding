---
title: Kubernetes CronJob
description: 了解 Kubernetes CronJob 的基本概念、使用方法以及实际应用场景，帮助初学者掌握定时任务的创建和管理。
---

# Kubernetes CronJob

Kubernetes CronJob 是一种用于在 Kubernetes 集群中定期运行任务的资源对象。它类似于 Linux 系统中的 `cron` 工具，允许你按照预定的时间表执行任务。CronJob 非常适合用于执行定期备份、发送报告、清理数据等周期性任务。

## 什么是 Kubernetes CronJob？

CronJob 是 Kubernetes 中的一种工作负载类型，它允许你定义一个任务（Job），并按照 Cron 格式的时间表来调度这个任务的执行。CronJob 会创建一个或多个 Job 对象来执行任务，并且可以根据需要保留历史记录。

### Cron 格式

CronJob 使用标准的 Cron 格式来定义时间表。Cron 格式由五个字段组成，分别表示分钟、小时、日期、月份和星期。例如：

```
# ┌───────────── 分钟 (0 - 59)
# │ ┌───────────── 小时 (0 - 23)
# │ │ ┌───────────── 日期 (1 - 31)
# │ │ │ ┌───────────── 月份 (1 - 12)
# │ │ │ │ ┌───────────── 星期 (0 - 6) (星期日到星期六)
# │ │ │ │ │
# │ │ │ │ │
# * * * * *
```

例如，`0 * * * *` 表示每小时的第 0 分钟执行任务。

## 创建 CronJob

下面是一个简单的 CronJob 示例，它每分钟运行一次，输出当前时间：

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo "Hello from Kubernetes CronJob"
          restartPolicy: OnFailure
```

在这个示例中：

- `schedule` 字段定义了任务的执行时间表，`*/1 * * * *` 表示每分钟执行一次。
- `jobTemplate` 定义了任务的模板，其中包含一个容器，该容器使用 `busybox` 镜像，并执行一个简单的命令来输出当前时间和一条消息。

### 应用 CronJob

使用 `kubectl apply` 命令将 CronJob 应用到 Kubernetes 集群中：

```bash
kubectl apply -f cronjob.yaml
```

### 查看 CronJob 状态

你可以使用以下命令查看 CronJob 的状态：

```bash
kubectl get cronjob hello
```

输出将显示 CronJob 的名称、调度时间、最后执行时间等信息。

## 实际应用场景

### 定期备份

假设你有一个数据库，需要每天凌晨 2 点进行备份。你可以创建一个 CronJob 来执行备份任务：

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-backup
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: my-backup-tool
            args:
            - /bin/sh
            - -c
            - /backup.sh
          restartPolicy: OnFailure
```

### 清理旧数据

你可能需要定期清理旧的日志文件或临时数据。例如，每周日凌晨 3 点清理 `/tmp` 目录：

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup
spec:
  schedule: "0 3 * * 0"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cleanup
            image: busybox
            args:
            - /bin/sh
            - -c
            - rm -rf /tmp/*
          restartPolicy: OnFailure
```

## 总结

Kubernetes CronJob 是一种强大的工具，可以帮助你自动化周期性任务。通过定义 Cron 格式的时间表和任务模板，你可以轻松地创建和管理定时任务。无论是定期备份、发送报告还是清理数据，CronJob 都能为你提供灵活的解决方案。

## 附加资源

- [Kubernetes 官方文档 - CronJob](https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/)
- [Cron 格式详解](https://en.wikipedia.org/wiki/Cron)

## 练习

1. 创建一个 CronJob，使其每天中午 12 点执行一次，输出 "Good afternoon!"。
2. 修改现有的 CronJob，使其每 5 分钟执行一次，并保留最近 3 次执行的历史记录。

:::tip
在创建 CronJob 时，确保你的 Kubernetes 集群版本支持 `batch/v1` API 版本。
:::