---
title: Kubernetes 配置注入
description: 了解如何在Kubernetes中通过环境变量、ConfigMap和Secret实现配置注入，并掌握其实际应用场景。
---

# Kubernetes 配置注入

在Kubernetes中，配置注入是一种将外部配置数据（如环境变量、配置文件或敏感信息）动态注入到应用程序中的方法。通过配置注入，您可以将应用程序的配置与代码分离，从而实现更灵活、可维护的部署。

## 什么是配置注入？

配置注入是指将应用程序运行所需的配置信息（如数据库连接字符串、API密钥或环境变量）从外部源注入到应用程序中。在Kubernetes中，常见的配置注入方式包括：

- **环境变量**：通过环境变量将配置传递给容器。
- **ConfigMap**：将配置文件或键值对注入到容器中。
- **Secret**：将敏感信息（如密码或密钥）安全地注入到容器中。

配置注入的核心思想是**解耦**：将应用程序的配置与代码分离，使得配置可以在不修改代码的情况下进行更改。

---

## 环境变量注入

环境变量是最简单的配置注入方式。Kubernetes允许您在Pod定义中直接指定环境变量，这些变量将在容器启动时传递给应用程序。

### 示例：通过环境变量注入配置

以下是一个Pod定义示例，展示了如何通过环境变量注入配置：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: my-container
    image: my-app-image
    env:
    - name: DATABASE_HOST
      value: "db.example.com"
    - name: DATABASE_PORT
      value: "5432"
```

在这个示例中，`DATABASE_HOST` 和 `DATABASE_PORT` 是两个环境变量，它们将在容器启动时注入到应用程序中。

:::tip
环境变量适合注入简单的配置值，但对于复杂的配置或敏感信息，建议使用ConfigMap或Secret。
:::

---

## ConfigMap注入

ConfigMap是Kubernetes中用于存储非敏感配置数据的资源对象。它可以将配置文件或键值对注入到容器中。

### 示例：通过ConfigMap注入配置

1. **创建ConfigMap**：

   首先，创建一个ConfigMap来存储配置数据：

   ```yaml
   apiVersion: v1
   kind: ConfigMap
   metadata:
     name: my-config
   data:
     app.properties: |
       database.host=db.example.com
       database.port=5432
   ```

2. **将ConfigMap注入到Pod中**：

   然后，在Pod定义中引用ConfigMap：

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     name: my-app
   spec:
     containers:
     - name: my-container
       image: my-app-image
       envFrom:
       - configMapRef:
           name: my-config
   ```

   在这个示例中，ConfigMap中的所有键值对将被注入为环境变量。

:::note
您还可以将ConfigMap挂载为文件，以便应用程序直接读取配置文件。
:::

---

## Secret注入

Secret是Kubernetes中用于存储敏感信息（如密码、API密钥或TLS证书）的资源对象。与ConfigMap类似，Secret也可以通过环境变量或文件挂载的方式注入到容器中。

### 示例：通过Secret注入敏感信息

1. **创建Secret**：

   首先，创建一个Secret来存储敏感信息：

   ```yaml
   apiVersion: v1
   kind: Secret
   metadata:
     name: my-secret
   type: Opaque
   data:
     username: YWRtaW4=  # base64编码的"admin"
     password: cGFzc3dvcmQ=  # base64编码的"password"
   ```

2. **将Secret注入到Pod中**：

   然后，在Pod定义中引用Secret：

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     name: my-app
   spec:
     containers:
     - name: my-container
       image: my-app-image
       env:
       - name: DB_USERNAME
         valueFrom:
           secretKeyRef:
             name: my-secret
             key: username
       - name: DB_PASSWORD
         valueFrom:
           secretKeyRef:
             name: my-secret
             key: password
   ```

   在这个示例中，Secret中的`username`和`password`将被注入为环境变量。

:::caution
Secret中的数据默认以base64编码存储，但请注意，base64编码并不是加密。为了更高的安全性，建议启用Kubernetes的Secret加密功能。
:::

---

## 实际应用场景

### 场景1：多环境配置管理

在开发、测试和生产环境中，应用程序的配置可能不同。通过ConfigMap和Secret，您可以为每个环境创建不同的配置，并在部署时动态注入。

### 场景2：敏感信息管理

对于数据库密码、API密钥等敏感信息，使用Secret可以确保这些信息不会以明文形式出现在Pod定义或代码中。

---

## 总结

Kubernetes配置注入是一种强大的工具，可以帮助您将应用程序的配置与代码分离，从而实现更灵活、可维护的部署。通过环境变量、ConfigMap和Secret，您可以轻松地将配置注入到容器中，并适应不同的应用场景。

---

## 附加资源与练习

- **练习1**：创建一个ConfigMap，并将其挂载为文件到Pod中。
- **练习2**：使用Secret存储TLS证书，并将其挂载到Pod中。
- **官方文档**：
  - [Kubernetes ConfigMap](https://kubernetes.io/docs/concepts/configuration/configmap/)
  - [Kubernetes Secret](https://kubernetes.io/docs/concepts/configuration/secret/)