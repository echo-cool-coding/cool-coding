---
title: Docker Compose 健康检查
description: 了解如何在 Docker Compose 中使用健康检查来监控容器的状态，确保服务正常运行。
---

# Docker Compose 健康检查

在 Docker Compose 中，健康检查（Health Check）是一种用于监控容器状态的机制。它可以帮助你确保容器中的服务正常运行，并在服务出现问题时采取相应的措施。健康检查通常用于检测应用程序是否已启动并准备好接收请求，或者是否仍在正常运行。

## 什么是健康检查？

健康检查是 Docker 提供的一种机制，允许你定义一组命令或 HTTP 请求，用于定期检查容器的健康状态。Docker 会根据这些检查的结果，将容器的状态标记为 `healthy`（健康）或 `unhealthy`（不健康）。这对于确保服务的可用性和稳定性非常重要。

## 如何在 Docker Compose 中定义健康检查？

在 Docker Compose 文件中，你可以通过 `healthcheck` 字段为服务定义健康检查。以下是一个简单的示例：

```yaml
version: '3.8'

services:
  web:
    image: nginx
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
```

在这个示例中，我们为 `web` 服务定义了一个健康检查。让我们逐步解释每个字段的含义：

- `test`: 定义健康检查的命令。在这个例子中，我们使用 `curl` 命令检查 `http://localhost` 是否可访问。如果 `curl` 返回非零状态码，健康检查将失败。
- `interval`: 定义健康检查的执行间隔。在这个例子中，每 30 秒执行一次健康检查。
- `timeout`: 定义健康检查的超时时间。如果健康检查在 10 秒内没有完成，它将被视为失败。
- `retries`: 定义健康检查失败后的重试次数。在这个例子中，如果健康检查连续失败 3 次，容器将被标记为 `unhealthy`。
- `start_period`: 定义容器启动后的等待时间。在这个例子中，容器启动后 10 秒内不会执行健康检查。

## 健康检查的实际应用场景

健康检查在以下场景中非常有用：

1. **服务依赖管理**：在微服务架构中，一个服务可能依赖于其他服务。通过健康检查，你可以确保依赖的服务已经启动并准备好接收请求，然后再启动依赖它们的服务。

2. **自动恢复**：如果某个容器的健康检查失败，Docker 可以自动重启该容器，以尝试恢复服务的正常运行。

3. **负载均衡**：在负载均衡器中，健康检查可以用于检测后端服务是否健康。如果某个后端服务不健康，负载均衡器可以将其从服务池中移除，直到它恢复健康状态。

## 实际案例

假设你有一个由多个服务组成的应用程序，其中一个服务是数据库（`db`），另一个服务是 Web 应用（`web`）。Web 应用依赖于数据库服务。你可以使用健康检查来确保数据库服务已经启动并准备好接收连接，然后再启动 Web 应用。

```yaml
version: '3.8'

services:
  db:
    image: postgres
    environment:
      POSTGRES_PASSWORD: example
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    image: my-web-app
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8080:8080"
```

在这个例子中，`db` 服务的健康检查使用 `pg_isready` 命令来检查 PostgreSQL 数据库是否已准备好接收连接。`web` 服务依赖于 `db` 服务，并且只有在 `db` 服务健康时才会启动。

## 总结

Docker Compose 的健康检查功能是一个强大的工具，可以帮助你确保容器中的服务正常运行。通过定义适当的健康检查，你可以提高应用程序的可靠性和稳定性。在实际应用中，健康检查可以用于服务依赖管理、自动恢复和负载均衡等场景。

## 附加资源

- [Docker 官方文档 - 健康检查](https://docs.docker.com/engine/reference/builder/#healthcheck)
- [Docker Compose 官方文档](https://docs.docker.com/compose/compose-file/)

## 练习

1. 在你的 Docker Compose 文件中为某个服务添加健康检查，并观察容器的状态变化。
2. 尝试使用不同的健康检查命令，例如 HTTP 请求或自定义脚本，并测试其效果。
