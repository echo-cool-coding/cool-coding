---
title: Docker RUN 指令
description: 了解 Docker RUN 指令的基本用法、实际应用场景以及如何通过 RUN 指令在 Docker 镜像中执行命令。
---

# Docker RUN 指令

Docker 是一个强大的容器化平台，允许开发者将应用程序及其依赖项打包到一个轻量级、可移植的容器中。在 Dockerfile 中，`RUN` 指令是构建镜像时最常用的指令之一。它用于在镜像构建过程中执行命令，并将结果保存到镜像中。

## 什么是 RUN 指令？

`RUN` 指令用于在 Docker 镜像的构建过程中执行命令。这些命令可以是安装软件包、创建文件、配置环境等操作。`RUN` 指令会在当前镜像层中执行命令，并将结果提交到新的镜像层中。

`RUN` 指令有两种形式：

1. **Shell 形式**：`RUN <command>`，默认在 `/bin/sh -c` 下执行命令。
2. **Exec 形式**：`RUN ["executable", "param1", "param2"]`，直接调用可执行文件，不通过 shell。

### 示例：Shell 形式

```dockerfile
RUN apt-get update && apt-get install -y curl
```

在这个示例中，`RUN` 指令首先更新包管理器，然后安装 `curl` 工具。这两个命令通过 `&&` 连接，确保它们在同一层中执行。

### 示例：Exec 形式

```dockerfile
RUN ["apt-get", "update"]
RUN ["apt-get", "install", "-y", "curl"]
```

在这个示例中，`RUN` 指令以 Exec 形式执行，直接调用 `apt-get` 命令。每个 `RUN` 指令都会创建一个新的镜像层。

## RUN 指令的实际应用

### 1. 安装软件包

在构建镜像时，通常需要安装一些软件包。例如，构建一个基于 Ubuntu 的镜像并安装 Python：

```dockerfile
FROM ubuntu:20.04
RUN apt-get update && apt-get install -y python3
```

### 2. 创建文件和目录

`RUN` 指令还可以用于创建文件和目录。例如，创建一个简单的文本文件：

```dockerfile
RUN mkdir /app && echo "Hello, Docker!" > /app/greeting.txt
```

### 3. 配置环境

在构建镜像时，可能需要配置环境变量或设置路径。例如，设置 Python 环境变量：

```dockerfile
ENV PYTHONPATH=/app
RUN echo 'export PYTHONPATH=$PYTHONPATH:/app' >> ~/.bashrc
```

## RUN 指令的最佳实践

1. **合并命令**：尽量将多个命令合并到一个 `RUN` 指令中，以减少镜像层数。例如：

   ```dockerfile
   RUN apt-get update && apt-get install -y \
       curl \
       git \
       python3
   ```

2. **清理缓存**：在安装软件包后，清理不必要的缓存文件以减小镜像大小。例如：

   ```dockerfile
   RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
   ```

3. **使用 Exec 形式**：当需要精确控制命令的执行环境时，使用 Exec 形式可以避免 shell 的干扰。

## 实际案例：构建一个 Node.js 应用镜像

假设我们有一个简单的 Node.js 应用，以下是其 Dockerfile：

```dockerfile
FROM node:14
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
CMD ["node", "index.js"]
```

在这个 Dockerfile 中，`RUN npm install` 用于安装 Node.js 应用的依赖项。这个命令会在构建镜像时执行，并将结果保存到镜像中。

## 总结

`RUN` 指令是 Dockerfile 中非常重要的指令之一，用于在镜像构建过程中执行命令。通过合理使用 `RUN` 指令，可以有效地构建出功能完善、体积较小的 Docker 镜像。

:::tip 提示
- 尽量合并多个命令到一个 `RUN` 指令中，以减少镜像层数。
- 在安装软件包后，记得清理缓存文件以减小镜像大小。
:::

## 附加资源

- [Docker 官方文档](https://docs.docker.com/)
- [Dockerfile 最佳实践](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)

## 练习

1. 编写一个 Dockerfile，使用 `RUN` 指令安装 `nginx` 并创建一个简单的 HTML 文件。
2. 尝试将多个 `RUN` 指令合并为一个，观察镜像大小的变化。
