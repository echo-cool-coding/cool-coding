---
title: Docker 多阶段构建
description: 了解如何使用Docker多阶段构建来优化镜像大小并提高构建效率，适合初学者学习。
---

# Docker 多阶段构建

Docker多阶段构建（Multi-stage Build）是一种优化Docker镜像构建过程的技术。它允许你在一个Dockerfile中使用多个构建阶段，每个阶段可以独立运行，并且最终只保留所需的文件和依赖项。这种方法可以显著减少最终镜像的大小，同时提高构建效率。

## 为什么需要多阶段构建？

在传统的Docker构建过程中，所有的构建步骤都在一个镜像中完成。这意味着最终镜像中会包含所有的构建工具和中间文件，即使它们在运行时并不需要。这会导致镜像体积过大，增加了存储和传输的成本。

多阶段构建通过将构建过程分成多个阶段，每个阶段只保留必要的文件，从而解决了这个问题。最终镜像只包含运行应用程序所需的文件和依赖项，大大减少了镜像的大小。

## 多阶段构建的基本结构

一个典型的多阶段构建Dockerfile包含多个`FROM`指令，每个`FROM`指令代表一个新的构建阶段。你可以在每个阶段中使用不同的基础镜像，并且可以通过`COPY --from`指令将文件从一个阶段复制到另一个阶段。

以下是一个简单的多阶段构建示例：

```dockerfile
# 第一阶段：构建应用程序
FROM node:14 AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 第二阶段：运行应用程序
FROM node:14-alpine
WORKDIR /app
COPY --from=build /app/dist ./dist
COPY package*.json ./
RUN npm install --production
CMD ["node", "dist/index.js"]
```

在这个示例中，第一阶段使用`node:14`镜像来构建应用程序，第二阶段使用`node:14-alpine`镜像来运行应用程序。最终镜像只包含运行应用程序所需的文件和依赖项，而不包含构建工具和中间文件。

## 多阶段构建的实际应用

### 案例1：构建和运行一个Node.js应用

假设你有一个Node.js应用，你希望在构建时使用完整的Node.js镜像，但在运行时使用更小的Alpine镜像。以下是一个多阶段构建的Dockerfile示例：

```dockerfile
# 第一阶段：构建应用程序
FROM node:14 AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 第二阶段：运行应用程序
FROM node:14-alpine
WORKDIR /app
COPY --from=build /app/dist ./dist
COPY package*.json ./
RUN npm install --production
CMD ["node", "dist/index.js"]
```

在这个案例中，第一阶段使用`node:14`镜像来安装依赖项并构建应用程序，第二阶段使用`node:14-alpine`镜像来运行应用程序。最终镜像只包含运行应用程序所需的文件和依赖项，而不包含构建工具和中间文件。

### 案例2：构建和运行一个Go应用

假设你有一个Go应用，你希望在构建时使用完整的Go镜像，但在运行时使用更小的Alpine镜像。以下是一个多阶段构建的Dockerfile示例：

```dockerfile
# 第一阶段：构建应用程序
FROM golang:1.16 AS build
WORKDIR /app
COPY . .
RUN go build -o myapp

# 第二阶段：运行应用程序
FROM alpine:latest
WORKDIR /app
COPY --from=build /app/myapp .
CMD ["./myapp"]
```

在这个案例中，第一阶段使用`golang:1.16`镜像来构建Go应用，第二阶段使用`alpine:latest`镜像来运行Go应用。最终镜像只包含运行应用程序所需的文件和依赖项，而不包含构建工具和中间文件。

## 总结

Docker多阶段构建是一种强大的技术，可以帮助你优化Docker镜像的大小和构建效率。通过将构建过程分成多个阶段，你可以确保最终镜像只包含运行应用程序所需的文件和依赖项，而不包含不必要的构建工具和中间文件。

:::tip
在实际应用中，多阶段构建特别适合那些需要在构建时使用大量工具和依赖项，但在运行时只需要少量依赖项的应用场景。
:::

## 附加资源

- [Docker官方文档：多阶段构建](https://docs.docker.com/develop/develop-images/multistage-build/)
- [Dockerfile最佳实践](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)

## 练习

1. 尝试为你的项目编写一个多阶段构建的Dockerfile。
2. 比较使用多阶段构建前后的镜像大小，看看优化效果如何。
3. 探索如何在多阶段构建中使用不同的基础镜像来进一步优化镜像大小。
