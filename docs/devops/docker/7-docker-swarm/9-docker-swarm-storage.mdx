---
title: Docker Swarm 存储
description: 了解 Docker Swarm 中的存储管理，包括卷、绑定挂载和存储驱动程序的配置与使用。
---

## 介绍

Docker Swarm 是 Docker 的原生集群管理工具，允许用户将多个 Docker 主机组合成一个虚拟的 Docker 引擎。在 Swarm 模式下，存储管理是一个关键问题，因为容器可能会在集群中的任何节点上运行。为了确保数据的持久性和一致性，Docker Swarm 提供了多种存储选项，包括卷（Volumes）、绑定挂载（Bind Mounts）和存储驱动程序（Storage Drivers）。

本文将详细介绍如何在 Docker Swarm 中管理存储，并通过实际案例展示这些概念的应用。

## Docker Swarm 存储选项

### 1. 卷（Volumes）

卷是 Docker 推荐的持久化数据的方式。卷独立于容器的生命周期，即使容器被删除，卷中的数据仍然存在。在 Swarm 模式下，卷可以在集群中的多个节点之间共享。

#### 创建和使用卷

要创建一个卷，可以使用以下命令：

```bash
docker volume create my_volume
```

在服务中使用卷时，可以在 `docker-compose.yml` 文件中定义：

```yaml
version: '3.8'
services:
  web:
    image: nginx
    volumes:
      - my_volume:/usr/share/nginx/html
volumes:
  my_volume:
```

在这个例子中，`my_volume` 卷被挂载到 Nginx 容器的 `/usr/share/nginx/html` 目录。

### 2. 绑定挂载（Bind Mounts）

绑定挂载允许将主机文件系统中的目录或文件挂载到容器中。与卷不同，绑定挂载依赖于主机的文件系统结构。

#### 使用绑定挂载

在 `docker-compose.yml` 文件中，可以这样定义绑定挂载：

```yaml
version: '3.8'
services:
  web:
    image: nginx
    volumes:
      - /host/path:/container/path
```

在这个例子中，主机的 `/host/path` 目录被挂载到容器的 `/container/path` 目录。

:::caution
绑定挂载依赖于主机的文件系统，因此在 Swarm 模式下使用时需要确保所有节点上的路径一致。
:::

### 3. 存储驱动程序（Storage Drivers）

存储驱动程序负责管理 Docker 容器和镜像的存储。Docker 支持多种存储驱动程序，如 `overlay2`、`aufs`、`btrfs` 等。在 Swarm 模式下，选择合适的存储驱动程序对于性能和稳定性至关重要。

#### 配置存储驱动程序

在 Docker 配置文件（通常是 `/etc/docker/daemon.json`）中，可以指定存储驱动程序：

```json
{
  "storage-driver": "overlay2"
}
```

:::tip
`overlay2` 是大多数 Linux 发行版的默认存储驱动程序，通常是最佳选择。
:::

## 实际案例：在 Swarm 模式下使用卷

假设我们有一个简单的 Web 应用程序，需要在 Swarm 集群中运行，并且需要持久化存储用户上传的文件。

### 步骤 1：创建卷

首先，在 Swarm 集群中创建一个卷：

```bash
docker volume create app_data
```

### 步骤 2：定义服务

在 `docker-compose.yml` 文件中定义服务并使用卷：

```yaml
version: '3.8'
services:
  web:
    image: my_web_app
    volumes:
      - app_data:/app/uploads
    deploy:
      replicas: 3
volumes:
  app_data:
```

### 步骤 3：部署服务

使用以下命令部署服务：

```bash
docker stack deploy -c docker-compose.yml my_app
```

在这个例子中，`app_data` 卷被挂载到每个 Web 服务实例的 `/app/uploads` 目录，确保用户上传的文件在集群中的所有节点上保持一致。

## 总结

在 Docker Swarm 中管理存储是确保应用程序数据持久性和一致性的关键。通过使用卷、绑定挂载和存储驱动程序，可以有效地管理集群中的存储资源。本文介绍了这些概念的基本用法，并通过实际案例展示了如何在 Swarm 模式下使用卷。

## 附加资源

- [Docker 官方文档：卷](https://docs.docker.com/storage/volumes/)
- [Docker 官方文档：绑定挂载](https://docs.docker.com/storage/bind-mounts/)
- [Docker 官方文档：存储驱动程序](https://docs.docker.com/storage/storagedriver/)

## 练习

1. 在本地 Docker Swarm 集群中创建一个卷，并将其挂载到一个 Nginx 容器中。
2. 修改 `docker-compose.yml` 文件，使用绑定挂载将主机目录挂载到容器中。
3. 尝试更改存储驱动程序为 `aufs`，并观察对性能的影响。

通过完成这些练习，您将更好地理解 Docker Swarm 中的存储管理。