---
title: Jenkins CSRF 保护
description: 了解 Jenkins 中的 CSRF 保护机制，学习如何配置和管理 CSRF 防护，以确保 Jenkins 实例的安全性。
---

# Jenkins CSRF 保护

## 介绍

跨站请求伪造（CSRF）是一种常见的网络攻击方式，攻击者通过伪造用户的请求，利用用户的身份执行未经授权的操作。Jenkins 作为一款广泛使用的持续集成工具，提供了内置的 CSRF 保护机制，以防止此类攻击。

本文将详细介绍 Jenkins 中的 CSRF 保护机制，包括如何启用和配置 CSRF 防护，以及如何在实际应用中使用这些功能来保护 Jenkins 实例。

## 什么是 CSRF？

CSRF（Cross-Site Request Forgery）攻击是一种利用用户已登录的身份，在用户不知情的情况下发送恶意请求的攻击方式。攻击者通常会诱导用户点击一个链接或访问一个恶意网站，从而触发对目标站点的请求。

例如，假设用户已经登录了 Jenkins，攻击者可以通过伪造一个请求来触发 Jenkins 的构建操作，从而导致未经授权的构建任务被执行。

## Jenkins 中的 CSRF 保护机制

Jenkins 通过使用 CSRF 令牌（Token）来防止 CSRF 攻击。每个表单提交或 AJAX 请求都需要包含一个有效的 CSRF 令牌，Jenkins 会验证该令牌以确保请求的合法性。

### 启用 CSRF 保护

默认情况下，Jenkins 的 CSRF 保护是启用的。如果你需要手动启用或检查 CSRF 保护的状态，可以按照以下步骤操作：

1. 登录 Jenkins 管理界面。
2. 导航到 **系统管理** > **全局安全配置**。
3. 在 **CSRF Protection** 部分，确保 **Prevent Cross Site Request Forgery exploits** 选项已勾选。

:::tip
如果你使用的是 Jenkins 2.0 及以上版本，CSRF 保护默认是启用的。如果你使用的是旧版本，建议升级到最新版本以获取最新的安全功能。
:::

### 配置 CSRF 令牌

Jenkins 允许你自定义 CSRF 令牌的名称和值。你可以在 **系统管理** > **全局安全配置** 中找到 **CSRF Protection** 部分，并配置以下选项：

- **Crumb Issuer**：选择用于生成 CSRF 令牌的算法。默认情况下，Jenkins 使用 `DefaultCrumbIssuer`。
- **Crumb Field Name**：定义 CSRF 令牌在请求中的字段名称。默认值为 `Jenkins-Crumb`。
- **Crumb Value**：定义 CSRF 令牌的值。默认情况下，Jenkins 会自动生成一个随机的令牌值。

### 示例：使用 CSRF 令牌进行 API 请求

当你通过 Jenkins API 进行请求时，必须包含有效的 CSRF 令牌。以下是一个使用 `curl` 命令触发 Jenkins 构建的示例：

```bash
CRUMB=$(curl -u "username:password" "http://jenkins.example.com/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)")
curl -u "username:password" -X POST "http://jenkins.example.com/job/my-job/build" \
  -H "$CRUMB"
```

在这个示例中，我们首先通过 `curl` 命令获取 CSRF 令牌，然后在触发构建的请求中包含该令牌。

:::note
确保在请求中正确传递 CSRF 令牌，否则 Jenkins 将拒绝该请求并返回 `403 Forbidden` 错误。
:::

## 实际应用场景

### 场景 1：自动化脚本中的 CSRF 保护

假设你有一个自动化脚本，用于定期触发 Jenkins 上的构建任务。为了确保脚本的安全性，你需要在每次请求中包含有效的 CSRF 令牌。

```bash
#!/bin/bash

JENKINS_URL="http://jenkins.example.com"
JOB_NAME="my-job"
USERNAME="username"
PASSWORD="password"

# 获取 CSRF 令牌
CRUMB=$(curl -u "$USERNAME:$PASSWORD" "$JENKINS_URL/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)")

# 触发构建
curl -u "$USERNAME:$PASSWORD" -X POST "$JENKINS_URL/job/$JOB_NAME/build" \
  -H "$CRUMB"
```

### 场景 2：Jenkins 插件开发中的 CSRF 保护

如果你正在开发 Jenkins 插件，确保在插件中正确处理 CSRF 令牌。Jenkins 提供了 `Stapler` 框架来自动处理 CSRF 保护，但你仍然需要在插件代码中显式地处理 CSRF 令牌。

```java
public void doBuild(@QueryParameter String token) {
    // 验证 CSRF 令牌
    if (!Stapler.getCurrentRequest().validateCrumb(token)) {
        throw new AccessDeniedException("Invalid CSRF token");
    }

    // 执行构建操作
    // ...
}
```

## 总结

Jenkins 的 CSRF 保护机制是确保 Jenkins 实例安全的重要措施。通过启用和正确配置 CSRF 保护，你可以有效防止 CSRF 攻击，保护 Jenkins 上的构建任务和配置不被恶意篡改。

在实际应用中，无论是通过 API 请求还是插件开发，都需要正确处理 CSRF 令牌。希望本文能帮助你更好地理解和使用 Jenkins 的 CSRF 保护功能。

## 附加资源

- [Jenkins 官方文档 - CSRF Protection](https://www.jenkins.io/doc/book/security/csrf-protection/)
- [OWASP CSRF 防护指南](https://owasp.org/www-community/attacks/csrf)
- [Jenkins API 文档](https://www.jenkins.io/doc/book/using/remote-access-api/)

## 练习

1. 尝试在 Jenkins 中禁用 CSRF 保护，观察 API 请求的行为变化。
2. 编写一个自动化脚本，使用 CSRF 令牌触发 Jenkins 上的构建任务。
3. 在 Jenkins 插件开发中，尝试实现自定义的 CSRF 令牌验证逻辑。