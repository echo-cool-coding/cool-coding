---
title: Jenkins 条件执行
description: 了解如何在Jenkins流水线中使用条件执行来控制任务的运行逻辑。本文适合初学者，包含代码示例和实际案例。
---

# Jenkins 条件执行

在Jenkins流水线中，条件执行是一种强大的功能，允许你根据特定条件决定是否执行某些任务或步骤。通过条件执行，你可以更灵活地控制流水线的行为，避免不必要的任务运行，从而提高效率。

## 什么是条件执行？

条件执行是指在流水线中根据某些条件来决定是否执行特定的步骤或任务。这些条件可以是环境变量、参数值、构建状态等。通过条件执行，你可以实现更复杂的逻辑控制，例如跳过某些步骤、仅在特定条件下运行任务等。

## 基本语法

在Jenkins流水线中，条件执行通常使用 `when` 指令来实现。`when` 指令允许你指定一个条件表达式，只有当该表达式为 `true` 时，相关的步骤才会被执行。

以下是一个简单的示例：

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building the application...'
            }
        }
        stage('Test') {
            when {
                expression { params.RUN_TESTS == 'true' }
            }
            steps {
                echo 'Running tests...'
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying the application...'
            }
        }
    }
}
```

在这个示例中，`Test` 阶段只有在 `RUN_TESTS` 参数为 `true` 时才会执行。如果 `RUN_TESTS` 为 `false`，则 `Test` 阶段会被跳过。

## 条件表达式的类型

Jenkins 提供了多种条件表达式，以下是一些常用的类型：

1. **`expression`**: 使用 Groovy 表达式来定义条件。
2. **`branch`**: 仅在特定分支上执行。
3. **`environment`**: 根据环境变量的值来决定是否执行。
4. **`not`**: 对条件取反。
5. **`allOf`**: 所有条件都必须为 `true`。
6. **`anyOf`**: 任意一个条件为 `true` 即可。

### 示例：使用 `branch` 条件

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building the application...'
            }
        }
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying to production...'
            }
        }
    }
}
```

在这个示例中，`Deploy` 阶段只有在 `main` 分支上才会执行。

### 示例：使用 `allOf` 和 `anyOf`

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building the application...'
            }
        }
        stage('Test') {
            when {
                allOf {
                    branch 'feature/*'
                    expression { params.RUN_TESTS == 'true' }
                }
            }
            steps {
                echo 'Running tests...'
            }
        }
        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'release/*'
                }
            }
            steps {
                echo 'Deploying the application...'
            }
        }
    }
}
```

在这个示例中，`Test` 阶段只有在 `feature/*` 分支且 `RUN_TESTS` 参数为 `true` 时才会执行。而 `Deploy` 阶段则在 `main` 分支或 `release/*` 分支上执行。

## 实际案例

假设你正在开发一个 Web 应用程序，并且希望在每次提交到 `main` 分支时自动部署到生产环境，而在提交到 `feature/*` 分支时只运行测试。你可以使用以下流水线配置：

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building the application...'
            }
        }
        stage('Test') {
            when {
                branch 'feature/*'
            }
            steps {
                echo 'Running tests...'
            }
        }
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying to production...'
            }
        }
    }
}
```

在这个案例中，`Test` 阶段仅在 `feature/*` 分支上运行，而 `Deploy` 阶段仅在 `main` 分支上运行。

## 总结

Jenkins 的条件执行为流水线提供了强大的灵活性，允许你根据不同的条件来控制任务的执行。通过使用 `when` 指令和多种条件表达式，你可以轻松实现复杂的逻辑控制。

:::tip
在实际使用中，建议结合环境变量、参数和分支信息来设计条件执行逻辑，以确保流水线的行为符合预期。
:::

## 附加资源

- [Jenkins 官方文档](https://www.jenkins.io/doc/)
- [Jenkins Pipeline 语法参考](https://www.jenkins.io/doc/book/pipeline/syntax/)

## 练习

1. 修改上述示例，使得 `Deploy` 阶段仅在 `main` 分支且 `DEPLOY_ENV` 环境变量为 `production` 时执行。
2. 创建一个新的流水线，使得 `Test` 阶段在 `feature/*` 分支或 `bugfix/*` 分支上运行。

通过练习，你将更好地掌握 Jenkins 条件执行的使用方法。