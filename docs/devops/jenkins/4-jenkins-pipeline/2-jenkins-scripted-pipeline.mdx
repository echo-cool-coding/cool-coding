---
title: Jenkins 脚本式流水线
description: 了解Jenkins脚本式流水线的基础知识，掌握如何编写和管理脚本式流水线，并通过实际案例加深理解。
---

# Jenkins 脚本式流水线

Jenkins是一个广泛使用的持续集成和持续交付（CI/CD）工具，而流水线（Pipeline）是Jenkins的核心功能之一。流水线允许你将构建、测试和部署过程自动化，并定义为一个可重复执行的流程。Jenkins流水线分为两种类型：**声明式流水线**和**脚本式流水线**。本文将重点介绍**脚本式流水线**。

## 什么是脚本式流水线？

脚本式流水线（Scripted Pipeline）是Jenkins流水线的一种类型，它基于Groovy脚本语言。与声明式流水线不同，脚本式流水线提供了更大的灵活性和控制能力，允许你编写复杂的逻辑和条件语句。它适合那些需要高度定制化流程的场景。

脚本式流水线的核心是一个Groovy脚本，它定义了构建过程的各个阶段（Stage）和步骤（Step）。每个阶段可以包含多个步骤，步骤是实际执行的任务，例如拉取代码、运行测试或部署应用。

## 脚本式流水线的基本结构

一个典型的脚本式流水线脚本包含以下几个部分：

1. **节点（Node）**：定义流水线运行的Jenkins代理（Agent）。
2. **阶段（Stage）**：将流水线划分为多个逻辑阶段，例如构建、测试和部署。
3. **步骤（Step）**：在每个阶段中执行的具体任务。

以下是一个简单的脚本式流水线示例：

```groovy
node {
    stage('Checkout') {
        // 从Git仓库拉取代码
        checkout scm
    }
    stage('Build') {
        // 构建项目
        sh 'mvn clean package'
    }
    stage('Test') {
        // 运行测试
        sh 'mvn test'
    }
    stage('Deploy') {
        // 部署应用
        sh 'mvn deploy'
    }
}
```

### 代码解释

- `node`：指定流水线在哪个Jenkins代理上运行。如果不指定，Jenkins会选择一个可用的代理。
- `stage`：定义一个阶段，例如`Checkout`、`Build`、`Test`和`Deploy`。
- `checkout scm`：从源代码管理（SCM）系统中拉取代码。
- `sh`：在代理上执行Shell命令。

## 脚本式流水线的优势

1. **灵活性**：脚本式流水线允许你编写复杂的逻辑，例如条件判断、循环和异常处理。
2. **可重用性**：你可以将常用的逻辑封装为函数，并在多个流水线中重用。
3. **强大的控制能力**：脚本式流水线提供了对构建过程的完全控制，适合需要高度定制化的场景。

## 实际案例：自动化构建和部署Java应用

假设你有一个Java项目，使用Maven进行构建和测试。以下是一个更复杂的脚本式流水线示例，展示了如何自动化构建、测试和部署过程：

```groovy
node {
    stage('Checkout') {
        checkout scm
    }
    stage('Build') {
        try {
            sh 'mvn clean package'
        } catch (Exception e) {
            echo 'Build failed: ' + e.toString()
            currentBuild.result = 'FAILURE'
            throw e
        }
    }
    stage('Test') {
        parallel(
            'Unit Tests': {
                sh 'mvn test'
            },
            'Integration Tests': {
                sh 'mvn verify -Pintegration-tests'
            }
        )
    }
    stage('Deploy') {
        if (env.BRANCH_NAME == 'main') {
            sh 'mvn deploy'
        } else {
            echo 'Skipping deployment for branch: ' + env.BRANCH_NAME
        }
    }
}
```

### 代码解释

- `try-catch`：捕获构建过程中的异常，并标记构建结果为失败。
- `parallel`：并行运行单元测试和集成测试，以加快构建速度。
- `env.BRANCH_NAME`：检查当前分支是否为`main`，只有`main`分支才会触发部署。

## 总结

脚本式流水线为Jenkins用户提供了强大的灵活性和控制能力，适合需要复杂逻辑和高度定制化的场景。通过本文的介绍和示例，你应该已经掌握了脚本式流水线的基本概念和编写方法。

:::tip
如果你刚开始学习Jenkins流水线，建议先从声明式流水线入手，因为它更简单易用。当你需要更复杂的逻辑时，再尝试脚本式流水线。
:::

## 附加资源

- [Jenkins官方文档](https://www.jenkins.io/doc/book/pipeline/)
- [Groovy脚本语言基础](https://groovy-lang.org/documentation.html)
- [Jenkins流水线最佳实践](https://www.jenkins.io/doc/book/pipeline/best-practices/)

## 练习

1. 创建一个简单的脚本式流水线，包含`Checkout`、`Build`和`Test`阶段。
2. 尝试在流水线中添加并行任务，例如同时运行单元测试和集成测试。
3. 使用`try-catch`块捕获构建过程中的异常，并标记构建结果为失败。

通过实践，你将更好地掌握脚本式流水线的编写和管理技巧。祝你学习愉快！