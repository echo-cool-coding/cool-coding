---
title: Jenkins 共享库
description: 了解如何在Jenkins流水线中使用共享库，以提高代码复用性和维护性。本文将从基础概念讲起，逐步深入，并提供实际案例和代码示例。
---

## 什么是Jenkins共享库？

Jenkins共享库（Shared Libraries）是一种将通用代码逻辑抽象出来并集中管理的机制。它允许你在多个Jenkins流水线中复用相同的代码，从而减少重复代码，提高维护性和可读性。

共享库通常包含一些常用的函数、类或流水线步骤，这些内容可以被多个Jenkins任务调用。通过使用共享库，你可以将复杂的逻辑封装在库中，使流水线脚本更加简洁和易于管理。

## 为什么需要共享库？

在大型项目中，可能会有多个Jenkins流水线任务需要执行相似的操作。如果每个任务都单独编写这些逻辑，会导致代码重复和维护困难。通过使用共享库，你可以：

- **减少代码重复**：将通用逻辑集中管理，避免重复编写相同的代码。
- **提高可维护性**：只需在共享库中修改一次，所有使用该库的流水线都会自动更新。
- **增强可读性**：流水线脚本更加简洁，专注于业务逻辑，而不是底层实现。

## 如何创建和使用共享库？

### 1. 创建共享库

共享库通常是一个Git仓库，包含以下结构：

```
my-shared-library/
├── src/
│   └── org/
│       └── example/
│           └── Utils.groovy
├── vars/
│   └── myCustomStep.groovy
└── resources/
    └── myResource.txt
```

- `src/`：包含Groovy类，通常用于封装复杂的逻辑。
- `vars/`：包含全局变量和自定义步骤，可以直接在流水线中调用。
- `resources/`：包含静态资源文件，如配置文件、模板等。

### 2. 配置Jenkins使用共享库

在Jenkins中，进入 **Manage Jenkins > Configure System**，找到 **Global Pipeline Libraries** 部分，添加一个新的共享库：

- **Name**：共享库的名称（例如 `my-shared-library`）。
- **Default version**：指定默认使用的分支或标签（例如 `main`）。
- **Retrieval method**：选择 `Modern SCM`，并配置Git仓库的URL。

### 3. 在流水线中使用共享库

在Jenkinsfile中，你可以通过 `@Library` 注解来加载共享库：

```groovy
@Library('my-shared-library') _

pipeline {
    agent any
    stages {
        stage('Example') {
            steps {
                script {
                    // 调用共享库中的自定义步骤
                    myCustomStep()
                }
            }
        }
    }
}
```

### 4. 编写共享库代码

在 `vars/myCustomStep.groovy` 中定义一个自定义步骤：

```groovy
def call() {
    echo 'This is a custom step from the shared library!'
}
```

在 `src/org/example/Utils.groovy` 中定义一个工具类：

```groovy
package org.example

class Utils {
    static void printMessage(String message) {
        echo "Message from Utils: ${message}"
    }
}
```

在流水线中调用工具类：

```groovy
@Library('my-shared-library') _

pipeline {
    agent any
    stages {
        stage('Example') {
            steps {
                script {
                    def utils = new org.example.Utils()
                    utils.printMessage('Hello, Jenkins!')
                }
            }
        }
    }
}
```

## 实际案例

假设你有一个项目，需要在多个流水线中执行相同的构建和部署步骤。你可以将这些步骤封装在共享库中：

```groovy
// vars/buildAndDeploy.groovy
def call(String environment) {
    echo "Building application for ${environment}..."
    sh 'mvn clean package'
    echo "Deploying to ${environment}..."
    sh "scp target/my-app.jar user@${environment}-server:/opt/my-app/"
}
```

在流水线中调用：

```groovy
@Library('my-shared-library') _

pipeline {
    agent any
    stages {
        stage('Build and Deploy') {
            steps {
                script {
                    buildAndDeploy('production')
                }
            }
        }
    }
}
```

## 总结

Jenkins共享库是一个强大的工具，可以帮助你提高流水线的复用性和可维护性。通过将通用逻辑封装在共享库中，你可以减少代码重复，简化流水线脚本，并提高团队协作效率。

## 附加资源

- [Jenkins官方文档：共享库](https://www.jenkins.io/doc/book/pipeline/shared-libraries/)
- [Groovy编程语言官方文档](https://groovy-lang.org/documentation.html)

## 练习

1. 创建一个共享库，包含一个自定义步骤 `greet`，该步骤接受一个参数 `name` 并打印 `Hello, ${name}!`。
2. 在流水线中使用该共享库，并调用 `greet` 步骤。
3. 扩展共享库，添加一个工具类 `MathUtils`，包含一个静态方法 `add`，用于计算两个数的和，并在流水线中调用该方法。

通过完成这些练习，你将更深入地理解Jenkins共享库的使用方法。