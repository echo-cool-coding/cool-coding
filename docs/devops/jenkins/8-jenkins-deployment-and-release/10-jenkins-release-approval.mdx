---
title: Jenkins 发布审批
description: 了解如何在Jenkins中实现发布审批流程，确保代码部署的安全性和可控性。
---

# Jenkins 发布审批

在持续集成和持续交付（CI/CD）流程中，发布审批是一个关键步骤。它确保在代码部署到生产环境之前，经过必要的审查和批准。Jenkins作为一款流行的自动化工具，提供了灵活的插件和配置选项，支持实现发布审批流程。本文将详细介绍如何在Jenkins中设置和使用发布审批功能。

## 什么是发布审批？

发布审批是指在代码部署到生产环境之前，需要经过人工或自动化的审批流程。这一步骤通常用于确保代码的质量、安全性和合规性。通过发布审批，团队可以避免未经测试或未经授权的代码进入生产环境，从而减少潜在的风险。

## 为什么需要发布审批？

1. **安全性**：确保只有经过审查的代码才能部署到生产环境。
2. **合规性**：满足公司或行业的合规要求。
3. **质量控制**：通过审批流程，确保代码质量达到标准。
4. **责任明确**：审批流程可以明确责任，确保每个部署都有明确的负责人。

## 如何在Jenkins中实现发布审批？

Jenkins提供了多种方式来实现发布审批，以下是几种常见的方法：

### 1. 使用 `Promoted Builds` 插件

`Promoted Builds` 插件允许你在构建完成后，手动或自动地提升构建状态。通过配置提升条件，你可以实现发布审批流程。

#### 安装插件

首先，确保你已经安装了 `Promoted Builds` 插件。如果没有安装，可以通过以下步骤进行安装：

1. 进入 Jenkins 管理界面。
2. 选择 `Manage Plugins`。
3. 在 `Available` 选项卡中搜索 `Promoted Builds`。
4. 点击 `Install without restart`。

#### 配置提升条件

1. 在 Jenkins 项目中，点击 `Configure`。
2. 找到 `Promote builds when...` 部分。
3. 添加一个新的提升条件，例如 `Manual Promotion`。
4. 配置提升条件，例如需要特定用户的批准。

#### 示例配置

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing...'
            }
        }
        stage('Promote') {
            steps {
                script {
                    def userInput = input(
                        id: 'userInput', message: 'Approve deployment?', parameters: [
                        [$class: 'BooleanParameterDefinition', defaultValue: false, description: 'Approve deployment?', name: 'approve']
                    ])
                    if (userInput) {
                        echo 'Deployment approved.'
                    } else {
                        error 'Deployment not approved.'
                    }
                }
            }
        }
    }
}
```

### 2. 使用 `Pipeline Input Step`

Jenkins Pipeline 提供了 `input` 步骤，可以在流水线中暂停并等待用户输入。通过这种方式，你可以实现发布审批。

#### 示例配置

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing...'
            }
        }
        stage('Deploy') {
            steps {
                script {
                    def userInput = input(
                        id: 'userInput', message: 'Approve deployment?', parameters: [
                        [$class: 'BooleanParameterDefinition', defaultValue: false, description: 'Approve deployment?', name: 'approve']
                    ])
                    if (userInput) {
                        echo 'Deployment approved.'
                    } else {
                        error 'Deployment not approved.'
                    }
                }
            }
        }
    }
}
```

### 3. 使用 `Role Strategy` 插件

`Role Strategy` 插件允许你为不同的用户或用户组分配不同的权限。通过配置权限，你可以限制谁可以批准发布。

#### 安装插件

1. 进入 Jenkins 管理界面。
2. 选择 `Manage Plugins`。
3. 在 `Available` 选项卡中搜索 `Role Strategy`。
4. 点击 `Install without restart`。

#### 配置角色和权限

1. 进入 Jenkins 管理界面。
2. 选择 `Manage and Assign Roles`。
3. 在 `Manage Roles` 中，添加一个新的角色，例如 `Approver`。
4. 为该角色分配必要的权限，例如 `Promote builds`。
5. 在 `Assign Roles` 中，将用户或用户组分配给 `Approver` 角色。

## 实际案例

假设你正在开发一个电子商务网站，每次发布新功能时，都需要经过产品经理的审批。你可以使用 Jenkins Pipeline 的 `input` 步骤来实现这一流程。

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing...'
            }
        }
        stage('Deploy') {
            steps {
                script {
                    def userInput = input(
                        id: 'userInput', message: 'Approve deployment?', parameters: [
                        [$class: 'BooleanParameterDefinition', defaultValue: false, description: 'Approve deployment?', name: 'approve']
                    ])
                    if (userInput) {
                        echo 'Deployment approved.'
                    } else {
                        error 'Deployment not approved.'
                    }
                }
            }
        }
    }
}
```

在这个案例中，当流水线运行到 `Deploy` 阶段时，会暂停并等待产品经理的审批。如果产品经理批准，流水线将继续执行部署；否则，流水线将终止。

## 总结

发布审批是确保代码部署安全性和可控性的重要步骤。Jenkins 提供了多种方式来实现发布审批，包括使用 `Promoted Builds` 插件、`Pipeline Input Step` 和 `Role Strategy` 插件。通过合理配置这些工具，你可以轻松地在 Jenkins 中实现发布审批流程。

## 附加资源

- [Jenkins Pipeline Documentation](https://www.jenkins.io/doc/book/pipeline/)
- [Promoted Builds Plugin Documentation](https://plugins.jenkins.io/promoted-builds/)
- [Role Strategy Plugin Documentation](https://plugins.jenkins.io/role-strategy/)

## 练习

1. 在你的 Jenkins 项目中，尝试使用 `Promoted Builds` 插件实现发布审批。
2. 使用 Jenkins Pipeline 的 `input` 步骤，创建一个需要人工审批的部署流程。
3. 配置 `Role Strategy` 插件，限制只有特定用户组可以批准发布。

通过完成这些练习，你将更好地理解如何在 Jenkins 中实现发布审批流程。