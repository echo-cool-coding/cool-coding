---
title: Jenkins 数据清理
description: 了解如何有效地清理Jenkins中的数据，以优化性能并释放存储空间。本文适合初学者，涵盖基本概念、实际案例和代码示例。
---

# Jenkins 数据清理

Jenkins是一个广泛使用的持续集成和持续交付（CI/CD）工具，随着项目的增多和构建次数的增加，Jenkins服务器上会积累大量的数据。这些数据包括构建日志、工件、插件缓存等。如果不定期清理，可能会导致存储空间不足、性能下降等问题。本文将介绍如何有效地清理Jenkins中的数据，以保持系统的健康运行。

## 为什么需要清理Jenkins数据？

Jenkins在运行过程中会生成大量的数据，主要包括：

- **构建日志**：每次构建都会生成详细的日志文件。
- **工件**：构建过程中生成的二进制文件、测试报告等。
- **插件缓存**：插件下载的依赖文件和缓存数据。
- **工作空间**：每个作业的工作目录，包含源代码、临时文件等。

随着时间的推移，这些数据会占用大量的磁盘空间，影响Jenkins的性能。因此，定期清理这些数据是非常必要的。

## 如何清理Jenkins数据

### 1. 清理构建历史

Jenkins允许你配置每个作业的构建历史保留策略。你可以设置保留最近的N次构建，或者根据时间范围删除旧的构建。

#### 配置构建历史保留策略

1. 进入Jenkins作业的配置页面。
2. 在“构建历史”部分，找到“丢弃旧的构建”选项。
3. 勾选“丢弃旧的构建”，并设置保留策略。例如：
   - 保留最近的10次构建。
   - 保留最近7天的构建。

```groovy
pipeline {
    agent any
    options {
        buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '7'))
    }
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
            }
        }
    }
}
```

### 2. 清理工件

工件是构建过程中生成的文件，通常存储在`$JENKINS_HOME/jobs/<job_name>/builds/<build_number>/archive/`目录下。你可以手动删除这些文件，或者使用插件来自动清理。

#### 使用`Discard Old Builds`插件

1. 安装`Discard Old Builds`插件。
2. 在作业配置页面，找到“丢弃旧的构建”选项。
3. 勾选“丢弃旧的构建”，并设置保留策略。

```groovy
pipeline {
    agent any
    options {
        buildDiscarder(logRotator(artifactDaysToKeepStr: '7', artifactNumToKeepStr: '5'))
    }
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
            }
        }
    }
}
```

### 3. 清理工作空间

工作空间是每个作业的工作目录，包含源代码、临时文件等。你可以定期清理工作空间，以释放磁盘空间。

#### 使用`Workspace Cleanup`插件

1. 安装`Workspace Cleanup`插件。
2. 在作业配置页面，找到“构建环境”部分。
3. 勾选“在构建完成后清理工作空间”。

```groovy
pipeline {
    agent any
    post {
        always {
            cleanWs()
        }
    }
    stages {
        stage('Build') {
            steps {
                echo 'Building...'
            }
        }
    }
}
```

### 4. 清理插件缓存

Jenkins插件会下载依赖文件和缓存数据，这些文件通常存储在`$JENKINS_HOME/plugins/`目录下。你可以手动删除这些文件，或者使用插件来自动清理。

#### 使用`Plugin Cache Cleaner`插件

1. 安装`Plugin Cache Cleaner`插件。
2. 在Jenkins管理页面，找到“插件管理”部分。
3. 点击“清理插件缓存”按钮。

```groovy
pipeline {
    agent any
    stages {
        stage('Clean Plugin Cache') {
            steps {
                script {
                    def pluginCacheDir = new File("${JENKINS_HOME}/plugins")
                    pluginCacheDir.eachFile { file ->
                        if (file.isDirectory() && file.name.endsWith('.jpi')) {
                            file.deleteDir()
                        }
                    }
                }
            }
        }
    }
}
```

## 实际案例

假设你有一个Jenkins作业，每天运行多次，生成了大量的构建日志和工件。随着时间的推移，这些数据占用了大量的磁盘空间，导致Jenkins性能下降。你可以通过以下步骤清理这些数据：

1. **配置构建历史保留策略**：保留最近的10次构建，删除旧的构建。
2. **清理工件**：保留最近7天的工件，删除旧的工件。
3. **清理工作空间**：在每次构建完成后清理工作空间。
4. **清理插件缓存**：定期清理插件缓存。

通过以上步骤，你可以有效地清理Jenkins中的数据，释放磁盘空间，提高系统性能。

## 总结

Jenkins数据清理是保持系统健康运行的重要步骤。通过定期清理构建历史、工件、工作空间和插件缓存，你可以释放磁盘空间，优化系统性能。本文介绍了如何配置构建历史保留策略、清理工件、工作空间和插件缓存，并提供了实际案例和代码示例。

## 附加资源

- [Jenkins官方文档](https://www.jenkins.io/doc/)
- [Discard Old Builds插件文档](https://plugins.jenkins.io/discard-old-build/)
- [Workspace Cleanup插件文档](https://plugins.jenkins.io/ws-cleanup/)
- [Plugin Cache Cleaner插件文档](https://plugins.jenkins.io/plugin-cache-cleaner/)

## 练习

1. 配置一个Jenkins作业，保留最近的5次构建，删除旧的构建。
2. 使用`Workspace Cleanup`插件，在每次构建完成后清理工作空间。
3. 手动清理`$JENKINS_HOME/plugins/`目录下的插件缓存文件。

通过完成这些练习，你将更好地理解Jenkins数据清理的概念和实际操作。