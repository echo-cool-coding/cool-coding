---
title: Redis TopK 数据结构
description: 了解 Redis 中的 TopK 数据结构，掌握其工作原理、使用场景以及如何通过代码实现。
---

## 介绍

Redis 是一个高性能的键值存储系统，支持多种数据结构。除了常见的数据类型（如字符串、列表、哈希等），Redis 还提供了一些高级数据结构，其中之一就是 **TopK 数据结构**。TopK 数据结构用于高效地维护一个数据流中的前 K 个最大或最小的元素。

在实际应用中，TopK 数据结构常用于统计热门商品、热门搜索词、高频访问 IP 等场景。通过 Redis 的 TopK 数据结构，你可以轻松地实现这些功能，而无需手动编写复杂的算法。

## TopK 数据结构的工作原理

Redis 的 TopK 数据结构基于 **Count-Min Sketch** 和 **Heap** 算法。它通过以下步骤来维护前 K 个元素：

1. **数据流处理**：TopK 数据结构会持续接收数据流中的元素。
2. **频率统计**：使用 Count-Min Sketch 算法统计每个元素的出现频率。
3. **堆维护**：使用堆（Heap）来维护前 K 个频率最高的元素。

通过这种方式，TopK 数据结构能够在有限的内存空间中高效地维护前 K 个元素。

## 使用 Redis TopK 数据结构

Redis 提供了 `TOPK` 命令来操作 TopK 数据结构。以下是一些常用的命令：

- `TOPK.RESERVE key k width depth`：创建一个 TopK 数据结构，`k` 表示要维护的前 K 个元素，`width` 和 `depth` 是 Count-Min Sketch 的参数。
- `TOPK.ADD key item [item ...]`：向 TopK 数据结构中添加元素。
- `TOPK.LIST key`：获取 TopK 数据结构中的前 K 个元素。
- `TOPK.QUERY key item [item ...]`：查询某个元素是否在前 K 个元素中。

### 示例代码

以下是一个使用 Redis TopK 数据结构的示例：

```bash
# 创建一个 TopK 数据结构，维护前 3 个元素
TOPK.RESERVE topk_items 3 1000 10

# 向 TopK 数据结构中添加元素
TOPK.ADD topk_items apple banana orange apple banana apple

# 获取前 3 个元素
TOPK.LIST topk_items
```

**输出：**
```bash
1) "apple"
2) "banana"
3) "orange"
```

在这个示例中，我们创建了一个 TopK 数据结构，并添加了一些水果名称。最终，`TOPK.LIST` 命令返回了前 3 个出现频率最高的水果。

## 实际应用场景

### 1. 热门商品统计

假设你有一个电商网站，想要统计当前最热门的商品。你可以使用 Redis 的 TopK 数据结构来实时维护前 K 个热门商品。

```bash
# 创建一个 TopK 数据结构，维护前 5 个热门商品
TOPK.RESERVE top_products 5 1000 10

# 模拟用户购买商品
TOPK.ADD top_products product1 product2 product3 product1 product4 product5 product1

# 获取前 5 个热门商品
TOPK.LIST top_products
```

**输出：**
```bash
1) "product1"
2) "product2"
3) "product3"
4) "product4"
5) "product5"
```

### 2. 高频访问 IP 统计

假设你有一个 Web 服务器，想要统计访问频率最高的 IP 地址。你可以使用 Redis 的 TopK 数据结构来实现这一功能。

```bash
# 创建一个 TopK 数据结构，维护前 10 个高频访问 IP
TOPK.RESERVE top_ips 10 1000 10

# 模拟用户访问
TOPK.ADD top_ips 192.168.1.1 192.168.1.2 192.168.1.1 192.168.1.3 192.168.1.1

# 获取前 10 个高频访问 IP
TOPK.LIST top_ips
```

**输出：**
```bash
1) "192.168.1.1"
2) "192.168.1.2"
3) "192.168.1.3"
```

## 总结

Redis 的 TopK 数据结构是一个强大的工具，能够帮助你高效地维护数据流中的前 K 个元素。通过 Count-Min Sketch 和 Heap 算法的结合，TopK 数据结构在内存使用和性能之间取得了良好的平衡。

在实际应用中，TopK 数据结构可以用于统计热门商品、高频访问 IP 等场景。通过 Redis 提供的 `TOPK` 命令，你可以轻松地实现这些功能。

## 附加资源

- [Redis 官方文档](https://redis.io/documentation)
- [Count-Min Sketch 算法详解](https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch)
- [Heap 数据结构详解](https://en.wikipedia.org/wiki/Heap_(data_structure))

## 练习

1. 使用 Redis 的 TopK 数据结构统计你所在城市的天气数据中的前 5 个最常见的天气类型。
2. 尝试使用 TopK 数据结构统计一个博客网站中最受欢迎的 10 篇文章。

通过完成这些练习，你将更好地理解 Redis TopK 数据结构的应用场景和使用方法。