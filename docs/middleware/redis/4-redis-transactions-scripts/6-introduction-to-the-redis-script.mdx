---
title: Redis 脚本介绍
description: 了解Redis脚本的基本概念、语法及其在实际场景中的应用，帮助初学者掌握如何使用Lua脚本扩展Redis的功能。
---

# Redis 脚本介绍

Redis是一个高性能的键值存储系统，广泛应用于缓存、消息队列等场景。除了基本的键值操作外，Redis还支持通过Lua脚本执行复杂的操作。本文将详细介绍Redis脚本的概念、语法以及实际应用场景。

## 什么是Redis脚本？

Redis脚本是一种使用Lua语言编写的脚本，可以在Redis服务器上执行。通过脚本，你可以将多个Redis命令组合在一起，实现原子性操作。Redis脚本的主要优势在于：

1. **原子性**：脚本中的所有命令会作为一个整体执行，不会被其他客户端请求打断。
2. **性能**：脚本在服务器端执行，减少了网络往返的开销。
3. **灵活性**：Lua语言提供了丰富的功能，可以编写复杂的逻辑。

## Lua脚本基础

Lua是一种轻量级的脚本语言，语法简单且易于学习。以下是一个简单的Lua脚本示例：

```lua
-- 这是一个简单的Lua脚本
local key = KEYS[1]
local value = ARGV[1]
return redis.call('SET', key, value)
```

在这个脚本中，`KEYS`和`ARGV`是Redis传递给脚本的参数数组。`redis.call`用于执行Redis命令。

## 如何在Redis中执行脚本

Redis提供了`EVAL`和`EVALSHA`命令来执行Lua脚本。

### 使用`EVAL`命令

`EVAL`命令允许你直接执行Lua脚本。以下是一个示例：

```bash
EVAL "return redis.call('SET', KEYS[1], ARGV[1])" 1 mykey myvalue
```

- 第一个参数是Lua脚本。
- 第二个参数是键的数量（这里是1）。
- 第三个参数是键名（`mykey`）。
- 第四个参数是值（`myvalue`）。

执行后，Redis会将`mykey`设置为`myvalue`。

### 使用`EVALSHA`命令

`EVALSHA`命令与`EVAL`类似，但它使用脚本的SHA1哈希值来执行脚本。首先，你需要使用`SCRIPT LOAD`命令将脚本加载到Redis中：

```bash
SCRIPT LOAD "return redis.call('SET', KEYS[1], ARGV[1])"
```

Redis会返回一个SHA1哈希值，例如`c686f316aaf1eb281dab9467e5a3507b8e8f8f8f`。然后，你可以使用`EVALSHA`命令执行脚本：

```bash
EVALSHA c686f316aaf1eb281dab9467e5a3507b8e8f8f8f 1 mykey myvalue
```

这种方式可以减少网络传输的数据量，提高性能。

## 实际应用场景

### 1. 原子性操作

假设你需要实现一个简单的计数器，要求每次递增操作都是原子的。你可以使用Lua脚本来实现：

```lua
local key = KEYS[1]
local increment = tonumber(ARGV[1])
return redis.call('INCRBY', key, increment)
```

执行脚本：

```bash
EVAL "local key = KEYS[1]; local increment = tonumber(ARGV[1]); return redis.call('INCRBY', key, increment)" 1 counter 5
```

### 2. 复杂条件判断

假设你需要根据某个条件来决定是否执行某个操作。例如，只有当某个键的值大于10时，才将其设置为0：

```lua
local key = KEYS[1]
local value = tonumber(redis.call('GET', key))
if value > 10 then
    return redis.call('SET', key, 0)
else
    return value
end
```

执行脚本：

```bash
EVAL "local key = KEYS[1]; local value = tonumber(redis.call('GET', key)); if value > 10 then return redis.call('SET', key, 0) else return value end" 1 mykey
```

## 总结

Redis脚本通过Lua语言提供了强大的功能，允许你在Redis中执行复杂的原子性操作。通过`EVAL`和`EVALSHA`命令，你可以轻松地在Redis中执行脚本。本文介绍了Redis脚本的基本概念、语法以及实际应用场景，希望对你有所帮助。

## 附加资源

- [Redis官方文档 - Lua脚本](https://redis.io/docs/manual/programmability/eval-intro/)
- [Lua编程语言教程](https://www.lua.org/pil/contents.html)

## 练习

1. 编写一个Lua脚本，实现一个简单的分布式锁。
2. 使用`EVALSHA`命令执行一个Lua脚本，并观察其与`EVAL`命令的区别。
