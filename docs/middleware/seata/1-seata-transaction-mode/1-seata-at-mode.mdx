---
title: Seata AT模式
description: 了解Seata AT模式的工作原理、实现方式及其在分布式事务中的应用场景。
---

# Seata AT模式

## 介绍

Seata（Simple Extensible Autonomous Transaction Architecture）是一个开源的分布式事务解决方案，旨在简化分布式事务的管理。Seata提供了多种事务模式，其中**AT模式（Automatic Transaction Mode）**是最常用的一种。AT模式通过自动补偿机制，实现了分布式事务的最终一致性，适合大多数业务场景。

AT模式的核心思想是：在业务方法执行时，自动记录事务的**前置镜像（Before Image）**和**后置镜像（After Image）**，并在事务提交或回滚时，根据这些镜像数据自动完成补偿操作。

## AT模式的工作原理

AT模式的工作流程可以分为以下几个步骤：

1. **事务开始**：全局事务开始时，Seata会生成一个全局事务ID（XID），并将其传播到所有参与事务的服务中。
2. **执行业务SQL**：在每个参与事务的服务中，执行业务SQL时，Seata会拦截SQL并记录前置镜像和后置镜像。
3. **提交本地事务**：每个服务提交本地事务时，Seata会将事务日志（包括前置镜像和后置镜像）保存到事务日志表中。
4. **全局提交或回滚**：如果所有本地事务都成功提交，Seata会通知所有服务提交全局事务；如果有任何一个本地事务失败，Seata会根据事务日志中的镜像数据自动执行补偿操作。

### 代码示例

以下是一个简单的Seata AT模式示例：

```java
@GlobalTransactional
public void purchase(String userId, String commodityCode, int orderCount) {
    // 扣减库存
    storageService.deduct(commodityCode, orderCount);
    // 创建订单
    orderService.create(userId, commodityCode, orderCount);
}
```

在这个示例中，`purchase`方法是一个全局事务方法，`@GlobalTransactional`注解表示该方法是一个全局事务。`storageService.deduct`和`orderService.create`是两个本地事务，Seata会自动管理这两个事务的提交和回滚。

## 实际应用场景

假设我们有一个电商系统，用户下单时需要同时扣减库存和创建订单。这两个操作分别由库存服务和订单服务完成，且需要保证数据的一致性。使用Seata AT模式，可以轻松实现这一需求。

### 场景描述

1. **用户下单**：用户提交订单时，系统需要同时扣减库存和创建订单。
2. **库存服务**：库存服务负责扣减库存。
3. **订单服务**：订单服务负责创建订单。

### 解决方案

使用Seata AT模式，可以在用户下单时自动管理库存服务和订单服务的事务。如果库存扣减成功但订单创建失败，Seata会自动回滚库存扣减操作，保证数据的一致性。

## 总结

Seata AT模式通过自动记录事务的前置镜像和后置镜像，实现了分布式事务的最终一致性。它简化了分布式事务的管理，适合大多数业务场景。通过本文的介绍和示例，你应该对Seata AT模式有了初步的了解。

## 附加资源

- [Seata官方文档](https://seata.io/zh-cn/docs/overview/what-is-seata.html)
- [分布式事务解决方案对比](https://dzone.com/articles/distributed-transaction-solutions-comparison)

## 练习

1. 尝试在自己的项目中集成Seata AT模式，并实现一个简单的分布式事务。
2. 阅读Seata的源码，了解AT模式的具体实现细节。
