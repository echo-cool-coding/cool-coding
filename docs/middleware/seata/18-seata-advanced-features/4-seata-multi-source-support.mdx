---
title: Seata 多数据源支持
description: 了解如何在Seata中配置和使用多数据源，以实现分布式事务的跨数据源一致性。
---

# Seata 多数据源支持

## 介绍

在分布式系统中，事务管理是一个复杂的问题，尤其是在涉及多个数据源的情况下。Seata（Simple Extensible Autonomous Transaction Architecture）是一个开源的分布式事务解决方案，它提供了对多数据源的支持，使得开发者可以在多个数据库之间实现事务的一致性。

本文将详细介绍如何在Seata中配置和使用多数据源，并通过实际案例展示其应用场景。

## 多数据源配置

### 1. 配置数据源

首先，我们需要在项目中配置多个数据源。假设我们有两个数据源：`dataSource1` 和 `dataSource2`。

```java
@Configuration
public class DataSourceConfig {

    @Bean(name = "dataSource1")
    @ConfigurationProperties(prefix = "spring.datasource.ds1")
    public DataSource dataSource1() {
        return DataSourceBuilder.create().build();
    }

    @Bean(name = "dataSource2")
    @ConfigurationProperties(prefix = "spring.datasource.ds2")
    public DataSource dataSource2() {
        return DataSourceBuilder.create().build();
    }
}
```

### 2. 配置Seata代理数据源

接下来，我们需要将这两个数据源配置为Seata的代理数据源。

```java
@Configuration
public class SeataDataSourceConfig {

    @Bean
    public DataSourceProxy dataSourceProxy1(@Qualifier("dataSource1") DataSource dataSource) {
        return new DataSourceProxy(dataSource);
    }

    @Bean
    public DataSourceProxy dataSourceProxy2(@Qualifier("dataSource2") DataSource dataSource) {
        return new DataSourceProxy(dataSource);
    }
}
```

### 3. 配置事务管理器

最后，我们需要配置一个事务管理器来管理这两个数据源的事务。

```java
@Configuration
public class TransactionManagerConfig {

    @Bean
    public PlatformTransactionManager transactionManager(
            @Qualifier("dataSourceProxy1") DataSourceProxy dataSourceProxy1,
            @Qualifier("dataSourceProxy2") DataSourceProxy dataSourceProxy2) {
        return new DataSourceTransactionManager(dataSourceProxy1);
    }
}
```

## 实际案例

假设我们有一个电商系统，订单服务和库存服务分别使用不同的数据库。当用户下单时，我们需要在订单数据库中创建订单，并在库存数据库中减少库存。这两个操作需要在同一个事务中完成。

```java
@Service
public class OrderService {

    @Autowired
    private OrderMapper orderMapper;

    @Autowired
    private InventoryMapper inventoryMapper;

    @GlobalTransactional
    public void placeOrder(Order order) {
        // 创建订单
        orderMapper.insert(order);

        // 减少库存
        inventoryMapper.decreaseStock(order.getProductId(), order.getQuantity());
    }
}
```

在这个例子中，`placeOrder` 方法使用了 `@GlobalTransactional` 注解，确保订单创建和库存减少操作在同一个全局事务中执行。

## 总结

通过Seata的多数据源支持，我们可以在分布式系统中轻松实现跨数据源的事务一致性。本文介绍了如何配置多数据源，并通过实际案例展示了其应用场景。

## 附加资源

- [Seata官方文档](https://seata.io/zh-cn/docs/)
- [Spring Boot多数据源配置](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-configure-multiple-datasources)

## 练习

1. 尝试在你的项目中配置两个数据源，并使用Seata实现跨数据源的事务一致性。
2. 修改上述案例，添加一个新的服务（如支付服务），并确保所有操作在同一个全局事务中执行。
