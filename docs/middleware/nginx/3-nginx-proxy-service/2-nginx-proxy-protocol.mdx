---
title: Nginx 代理协议
description: 了解Nginx代理协议的基本概念、工作原理以及如何在实际场景中使用它。
---

# Nginx 代理协议

## 介绍

Nginx是一个高性能的HTTP服务器和反向代理服务器。它不仅可以作为Web服务器直接处理HTTP请求，还可以作为代理服务器，将客户端的请求转发到后端服务器。Nginx代理协议（Proxy Protocol）是一种扩展协议，允许Nginx在代理请求时，将客户端的原始IP地址和其他信息传递给后端服务器。

在传统的HTTP代理中，后端服务器只能看到代理服务器的IP地址，而无法获取客户端的真实IP地址。Nginx代理协议通过扩展TCP协议，将客户端的原始信息嵌入到代理请求中，从而解决了这个问题。

## 工作原理

Nginx代理协议的工作原理如下：

1. **客户端**向**Nginx代理服务器**发送请求。
2. **Nginx代理服务器**接收到请求后，将客户端的原始IP地址和其他信息嵌入到代理请求中。
3. **Nginx代理服务器**将带有代理协议头的请求转发给**后端服务器**。
4. **后端服务器**解析代理协议头，获取客户端的原始IP地址和其他信息。

## 配置Nginx代理协议

要在Nginx中启用代理协议，需要在Nginx配置文件中进行相应的设置。以下是一个简单的配置示例：

```nginx
server {
    listen 80 proxy_protocol;
    server_name example.com;

    location / {
        proxy_pass http://backend_server;
        proxy_set_header X-Real-IP $proxy_protocol_addr;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    }
}
```

在这个配置中：

- `listen 80 proxy_protocol;` 表示Nginx监听80端口，并启用代理协议。
- `proxy_pass http://backend_server;` 表示将请求转发到后端服务器。
- `proxy_set_header X-Real-IP $proxy_protocol_addr;` 和 `proxy_set_header X-Forwarded-For $proxy_protocol_addr;` 用于将客户端的原始IP地址传递给后端服务器。

## 实际案例

假设你有一个Web应用，部署在多个后端服务器上，并使用Nginx作为反向代理。为了记录客户端的真实IP地址，你需要在Nginx中启用代理协议。

### 场景描述

- **客户端**：用户通过浏览器访问你的网站。
- **Nginx代理服务器**：接收客户端的请求，并将请求转发到后端服务器。
- **后端服务器**：处理请求并记录客户端的真实IP地址。

### 配置步骤

1. **在Nginx中启用代理协议**：

    ```nginx
    server {
        listen 80 proxy_protocol;
        server_name example.com;

        location / {
            proxy_pass http://backend_server;
            proxy_set_header X-Real-IP $proxy_protocol_addr;
            proxy_set_header X-Forwarded-For $proxy_protocol_addr;
        }
    }
    ```

2. **在后端服务器中解析代理协议头**：

    后端服务器需要支持代理协议，并能够解析代理协议头。例如，如果你使用的是Node.js，可以使用`proxy-protocol`库来解析代理协议头。

    ```javascript
    const http = require('http');
    const ProxyProtocol = require('proxy-protocol');

    const server = http.createServer((req, res) => {
        const pp = new ProxyProtocol();
        pp.parse(req, (err, info) => {
            if (err) {
                console.error(err);
                res.statusCode = 500;
                res.end();
                return;
            }

            console.log('Client IP:', info.src.address);
            res.end('Hello, World!');
        });
    });

    server.listen(8080, () => {
        console.log('Server listening on port 8080');
    });
    ```

## 总结

Nginx代理协议是一种强大的工具，允许你在代理请求时将客户端的原始IP地址和其他信息传递给后端服务器。这对于需要记录客户端真实IP地址的应用场景非常有用。通过启用代理协议，你可以确保后端服务器能够获取到客户端的真实信息，从而更好地处理请求。

## 附加资源

- [Nginx官方文档](https://nginx.org/en/docs/)
- [Proxy Protocol RFC](https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt)
- [Node.js Proxy Protocol库](https://www.npmjs.com/package/proxy-protocol)

## 练习

1. 在你的Nginx服务器上启用代理协议，并配置后端服务器解析代理协议头。
2. 尝试使用不同的后端服务器（如Node.js、Python等）来解析代理协议头，并记录客户端的真实IP地址。
3. 研究Nginx代理协议的其他应用场景，并尝试在实际项目中应用它。
