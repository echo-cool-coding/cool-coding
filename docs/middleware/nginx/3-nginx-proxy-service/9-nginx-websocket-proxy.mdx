---
title: Nginx WebSocket代理
description: "学习如何使用Nginx配置WebSocket代理，实现高效的实时通信。本文适合初学者，包含详细的步骤和实际案例。"
---

## 介绍

WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议，常用于实时应用程序，如聊天应用、在线游戏和实时数据更新。Nginx 是一个高性能的 HTTP 服务器和反向代理服务器，支持 WebSocket 代理功能。通过 Nginx 代理 WebSocket 连接，可以有效地管理流量、提高安全性并实现负载均衡。

本文将逐步讲解如何在 Nginx 中配置 WebSocket 代理，并提供实际案例帮助理解。

## WebSocket 代理的基本配置

要在 Nginx 中代理 WebSocket 连接，需要在配置文件中添加一些特定的指令。以下是一个基本的 WebSocket 代理配置示例：

```nginx
server {
    listen 80;
    server_name example.com;

    location /ws/ {
        proxy_pass http://backend_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

### 配置解析

- **proxy_pass**: 指定后端 WebSocket 服务器的地址。
- **proxy_http_version 1.1**: 使用 HTTP/1.1 协议，因为 WebSocket 需要 HTTP/1.1 支持。
- **proxy_set_header Upgrade $http_upgrade**: 将客户端的 `Upgrade` 头传递给后端服务器。
- **proxy_set_header Connection "Upgrade"**: 将客户端的 `Connection` 头设置为 `Upgrade`，以启用 WebSocket 协议。
- **proxy_set_header Host $host**: 将客户端的 `Host` 头传递给后端服务器。

## 实际案例：实时聊天应用

假设我们有一个实时聊天应用，前端通过 WebSocket 连接到后端服务器。我们可以使用 Nginx 作为反向代理，将 WebSocket 请求转发到后端服务器。

### 后端服务器配置

假设后端服务器运行在 `localhost:8080`，处理 WebSocket 请求的路径为 `/ws`。

### Nginx 配置

```nginx
server {
    listen 80;
    server_name chat.example.com;

    location /ws {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

### 前端代码示例

```javascript
const socket = new WebSocket('ws://chat.example.com/ws');

socket.onopen = function(event) {
    console.log('WebSocket connection established.');
};

socket.onmessage = function(event) {
    console.log('Message from server:', event.data);
};

socket.onclose = function(event) {
    console.log('WebSocket connection closed.');
};
```

### 运行效果

1. 用户访问 `chat.example.com`，前端通过 WebSocket 连接到 `ws://chat.example.com/ws`。
2. Nginx 将 WebSocket 请求代理到 `localhost:8080`。
3. 后端服务器处理 WebSocket 请求，并与客户端进行实时通信。

## 高级配置：负载均衡

在高流量的实时应用中，可能需要使用多个后端服务器来处理 WebSocket 连接。Nginx 可以通过负载均衡来分发 WebSocket 请求。

### 负载均衡配置

```nginx
upstream websocket_backend {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}

server {
    listen 80;
    server_name chat.example.com;

    location /ws {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

### 配置解析

- **upstream**: 定义一组后端服务器，Nginx 会根据负载均衡策略将请求分发到这些服务器。
- **proxy_pass**: 将请求代理到 `upstream` 定义的后端服务器组。

## 总结

通过 Nginx 代理 WebSocket 连接，可以有效地管理实时应用的流量，提高系统的可扩展性和安全性。本文介绍了基本的 WebSocket 代理配置，并通过实际案例展示了如何在实时聊天应用中使用 Nginx 代理 WebSocket 连接。此外，还介绍了如何使用 Nginx 实现 WebSocket 负载均衡。

## 附加资源

- [Nginx 官方文档](https://nginx.org/en/docs/)
- [WebSocket 协议规范](https://tools.ietf.org/html/rfc6455)
- [Nginx 负载均衡配置指南](https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/)

## 练习

1. 尝试在自己的服务器上配置 Nginx 代理 WebSocket 连接。
2. 使用多个后端服务器配置 Nginx 负载均衡，并测试 WebSocket 连接的负载均衡效果。
3. 探索 Nginx 的其他高级功能，如 SSL 终止和缓存，并将其应用到 WebSocket 代理配置中。