---
title: Nginx 模块编译
description: 学习如何编译自定义Nginx模块，从环境准备到模块加载的全过程。
---

# Nginx 模块编译

Nginx 是一个高性能的 HTTP 和反向代理服务器，它的模块化架构允许开发者通过编写自定义模块来扩展其功能。本文将详细介绍如何编译自定义 Nginx 模块，适合初学者学习。

## 介绍

Nginx 的模块化设计使得它非常灵活，开发者可以通过编写和编译自定义模块来满足特定的需求。编译 Nginx 模块需要一些基本的开发环境和工具，包括 C 编译器、Nginx 源代码以及相关的开发库。

## 环境准备

在开始编译 Nginx 模块之前，确保你的系统已经安装了以下工具：

- **GCC**：GNU 编译器集合，用于编译 C 代码。
- **Make**：用于自动化编译过程。
- **Nginx 源代码**：从 [Nginx 官方网站](https://nginx.org/en/download.html) 下载最新版本的源代码。

```bash
sudo apt-get install build-essential
wget https://nginx.org/download/nginx-1.21.6.tar.gz
tar -zxvf nginx-1.21.6.tar.gz
cd nginx-1.21.6
```

## 编写自定义模块

假设我们要编写一个简单的模块 `ngx_http_hello_module`，该模块会在访问特定 URL 时返回 "Hello, World!"。

### 模块代码

创建一个新的 C 文件 `ngx_http_hello_module.c`，并编写以下代码：

```c
#include <ngx_config.h>
#include <ngx_core.h>
#include <ngx_http.h>

static ngx_int_t ngx_http_hello_handler(ngx_http_request_t *r);

static ngx_command_t ngx_http_hello_commands[] = {
    { ngx_string("hello"),
      NGX_HTTP_LOC_CONF|NGX_CONF_NOARGS,
      ngx_http_hello_handler,
      0,
      0,
      NULL },
    ngx_null_command
};

static ngx_http_module_t ngx_http_hello_module_ctx = {
    NULL,                          /* preconfiguration */
    NULL,                          /* postconfiguration */
    NULL,                          /* create main configuration */
    NULL,                          /* init main configuration */
    NULL,                          /* create server configuration */
    NULL,                          /* merge server configuration */
    NULL,                          /* create location configuration */
    NULL                           /* merge location configuration */
};

ngx_module_t ngx_http_hello_module = {
    NGX_MODULE_V1,
    &ngx_http_hello_module_ctx,    /* module context */
    ngx_http_hello_commands,       /* module directives */
    NGX_HTTP_MODULE,               /* module type */
    NULL,                          /* init master */
    NULL,                          /* init module */
    NULL,                          /* init process */
    NULL,                          /* init thread */
    NULL,                          /* exit thread */
    NULL,                          /* exit process */
    NULL,                          /* exit master */
    NGX_MODULE_V1_PADDING
};

static ngx_int_t ngx_http_hello_handler(ngx_http_request_t *r) {
    ngx_str_t response = ngx_string("Hello, World!");
    r->headers_out.status = NGX_HTTP_OK;
    r->headers_out.content_length_n = response.len;
    ngx_http_send_header(r);
    ngx_http_output_filter(r, &response);
    return NGX_OK;
}
```

### 编译模块

在 Nginx 源代码目录下，使用以下命令编译模块：

```bash
./configure --add-module=/path/to/your/module
make
sudo make install
```

### 配置 Nginx

在 Nginx 配置文件中添加以下内容以启用新模块：

```nginx
location /hello {
    hello;
}
```

### 测试模块

重启 Nginx 并访问 `http://your-server/hello`，你应该会看到 "Hello, World!" 的响应。

## 实际案例

假设你正在开发一个需要自定义日志格式的 Web 应用，你可以通过编写一个 Nginx 模块来实现这一点。该模块可以捕获特定的请求信息并将其记录到自定义日志文件中。

## 总结

通过本文，你已经学习了如何编译自定义 Nginx 模块。从环境准备到模块编写和编译，再到最终的配置和测试，整个过程虽然复杂，但非常强大。通过自定义模块，你可以极大地扩展 Nginx 的功能，满足各种特定需求。

## 附加资源

- [Nginx 官方文档](https://nginx.org/en/docs/)
- [Nginx 模块开发指南](https://www.nginx.com/resources/wiki/extending/)
- [Nginx 源代码](https://github.com/nginx/nginx)

## 练习

1. 尝试编写一个 Nginx 模块，使其在访问 `/time` 时返回当前服务器时间。
2. 修改现有的 `ngx_http_hello_module`，使其能够接受参数并返回不同的问候语。

:::tip
在编写和编译 Nginx 模块时，确保你熟悉 C 语言和 Nginx 的内部结构，这将帮助你更好地理解和调试代码。
:::