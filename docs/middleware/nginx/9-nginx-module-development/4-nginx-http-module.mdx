---
title: Nginx HTTP模块
description: "了解Nginx HTTP模块的基本概念、开发方法以及实际应用场景。本文适合初学者，内容涵盖模块开发的核心知识点，并提供代码示例和实际案例。"
---

## 介绍

Nginx 是一个高性能的 HTTP 服务器和反向代理服务器，广泛用于处理高并发请求。Nginx 的模块化架构是其强大功能的核心，允许开发者通过编写自定义模块来扩展其功能。本文将重点介绍 Nginx 的 HTTP 模块开发，帮助初学者理解如何通过编写 HTTP 模块来定制 Nginx 的行为。

### 什么是 Nginx HTTP 模块？

Nginx HTTP 模块是 Nginx 中用于处理 HTTP 请求的组件。每个 HTTP 模块负责特定的功能，例如处理静态文件、反向代理、负载均衡等。通过编写自定义 HTTP 模块，开发者可以扩展 Nginx 的功能，满足特定的业务需求。

## Nginx HTTP 模块的基本结构

一个典型的 Nginx HTTP 模块由以下几个部分组成：

1. **模块定义**：定义模块的名称、版本、配置指令等。
2. **配置结构**：定义模块的配置数据结构。
3. **指令处理**：处理配置文件中的指令。
4. **请求处理**：处理 HTTP 请求并生成响应。

### 模块定义

每个 Nginx 模块都需要定义一个 `ngx_module_t` 结构体，用于描述模块的基本信息。以下是一个简单的模块定义示例：

```c
#include <ngx_config.h>
#include <ngx_core.h>
#include <ngx_http.h>

static ngx_int_t ngx_http_hello_world_handler(ngx_http_request_t *r);

static ngx_http_module_t ngx_http_hello_world_module_ctx = {
    NULL,                          /* preconfiguration */
    NULL,                          /* postconfiguration */
    NULL,                          /* create main configuration */
    NULL,                          /* init main configuration */
    NULL,                          /* create server configuration */
    NULL,                          /* merge server configuration */
    NULL,                          /* create location configuration */
    NULL                           /* merge location configuration */
};

ngx_module_t ngx_http_hello_world_module = {
    NGX_MODULE_V1,
    &ngx_http_hello_world_module_ctx, /* module context */
    NULL,                          /* module directives */
    NGX_HTTP_MODULE,               /* module type */
    NULL,                          /* init master */
    NULL,                          /* init module */
    NULL,                          /* init process */
    NULL,                          /* init thread */
    NULL,                          /* exit thread */
    NULL,                          /* exit process */
    NULL,                          /* exit master */
    NGX_MODULE_V1_PADDING
};
```

### 配置结构

模块的配置结构用于存储模块的配置数据。以下是一个简单的配置结构示例：

```c
typedef struct {
    ngx_str_t greeting;
} ngx_http_hello_world_loc_conf_t;
```

### 指令处理

Nginx 通过指令来配置模块的行为。以下是一个简单的指令处理示例：

```c
static ngx_command_t ngx_http_hello_world_commands[] = {
    {
        ngx_string("hello_world"),
        NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
        ngx_conf_set_str_slot,
        NGX_HTTP_LOC_CONF_OFFSET,
        offsetof(ngx_http_hello_world_loc_conf_t, greeting),
        NULL
    },
    ngx_null_command
};
```

### 请求处理

请求处理是模块的核心部分，负责处理 HTTP 请求并生成响应。以下是一个简单的请求处理函数示例：

```c
static ngx_int_t ngx_http_hello_world_handler(ngx_http_request_t *r) {
    ngx_http_hello_world_loc_conf_t *conf;
    conf = ngx_http_get_module_loc_conf(r, ngx_http_hello_world_module);

    ngx_str_t response = ngx_string("Hello, World!");
    if (conf->greeting.len > 0) {
        response = conf->greeting;
    }

    r->headers_out.status = NGX_HTTP_OK;
    r->headers_out.content_length_n = response.len;
    ngx_http_send_header(r);

    ngx_buf_t *b;
    b = ngx_create_temp_buf(r->pool, response.len);
    ngx_memcpy(b->pos, response.data, response.len);
    b->last = b->pos + response.len;
    b->last_buf = 1;

    ngx_chain_t out;
    out.buf = b;
    out.next = NULL;

    return ngx_http_output_filter(r, &out);
}
```

## 实际案例

假设我们需要开发一个简单的 Nginx HTTP 模块，该模块在接收到请求时返回一个自定义的问候语。我们可以按照以下步骤来实现：

1. **定义模块**：定义模块的基本信息和配置结构。
2. **处理指令**：处理配置文件中的 `hello_world` 指令。
3. **处理请求**：在接收到请求时，返回配置的问候语。

### 配置文件示例

```nginx
location /hello {
    hello_world "Hello, Nginx Module!";
}
```

### 运行结果

当访问 `/hello` 路径时，Nginx 将返回 "Hello, Nginx Module!"。

## 总结

通过本文，我们了解了 Nginx HTTP 模块的基本结构和开发流程。我们学习了如何定义模块、处理配置指令以及处理 HTTP 请求。通过实际案例，我们展示了如何开发一个简单的 Nginx HTTP 模块。

### 附加资源

- [Nginx 官方文档](https://nginx.org/en/docs/)
- [Nginx 模块开发指南](https://www.nginx.com/resources/wiki/extending/)

### 练习

1. 尝试修改示例代码，使其返回当前时间。
2. 开发一个新的 Nginx HTTP 模块，实现简单的 URL 重写功能。

:::tip
在开发 Nginx 模块时，建议使用调试工具（如 GDB）来调试代码，以确保模块的正确性。
:::