---
title: Nginx 日志轮转
description: 了解Nginx日志轮转的概念、实现方法及其在实际中的应用场景，帮助初学者掌握日志管理的核心技能。
---

# Nginx 日志轮转

## 介绍

Nginx是一个高性能的Web服务器和反向代理服务器，广泛用于处理高并发请求。随着访问量的增加，Nginx生成的日志文件会变得越来越大，这不仅占用磁盘空间，还会影响日志分析效率。为了解决这个问题，我们需要对Nginx日志进行**轮转**。

**日志轮转**是指将当前的日志文件归档，并创建一个新的日志文件继续记录日志。通过日志轮转，我们可以有效管理日志文件的大小，避免单个日志文件过大，同时方便日志的备份和分析。

## 为什么需要日志轮转？

1. **磁盘空间管理**：日志文件会不断增长，占用大量磁盘空间。轮转可以将旧日志归档或删除，释放空间。
2. **日志分析**：较小的日志文件更容易被分析工具处理。
3. **故障排查**：按时间或大小分割日志文件，可以更快定位问题。

## 实现Nginx日志轮转

Nginx本身不提供日志轮转功能，但可以通过以下两种方式实现：

1. **使用Linux的`logrotate`工具**：这是最常用的方法。
2. **手动编写脚本**：适合需要自定义轮转逻辑的场景。

### 方法1：使用`logrotate`

`logrotate`是Linux系统中用于管理日志文件的工具，支持按时间或大小轮转日志。以下是配置Nginx日志轮转的步骤：

#### 1. 安装`logrotate`

大多数Linux发行版默认已安装`logrotate`。如果没有，可以通过以下命令安装：

```bash
sudo apt-get install logrotate  # Ubuntu/Debian
sudo yum install logrotate      # CentOS/RHEL
```

#### 2. 创建Nginx日志轮转配置文件

在`/etc/logrotate.d/`目录下创建一个新的配置文件，例如`nginx`：

```bash
sudo nano /etc/logrotate.d/nginx
```

添加以下内容：

```bash
/var/log/nginx/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        /usr/sbin/nginx -s reload
    endscript
}
```

#### 3. 配置说明

- `daily`：每天轮转一次日志。
- `missingok`：如果日志文件不存在，忽略错误。
- `rotate 14`：保留14个归档日志文件。
- `compress`：压缩旧日志文件以节省空间。
- `delaycompress`：延迟压缩，直到下一次轮转。
- `notifempty`：如果日志文件为空，不进行轮转。
- `create 0640 www-data adm`：创建新日志文件时设置权限和所有者。
- `sharedscripts`：在所有日志文件轮转后执行一次脚本。
- `postrotate`：轮转后执行命令，重新加载Nginx以使用新日志文件。

#### 4. 测试配置

使用以下命令测试配置是否正确：

```bash
sudo logrotate -d /etc/logrotate.d/nginx
```

如果配置正确，日志文件将按预期轮转。

### 方法2：手动编写脚本

如果需要更灵活的轮转逻辑，可以编写自定义脚本。以下是一个简单的Bash脚本示例：

```bash
#!/bin/bash

LOG_DIR="/var/log/nginx"
DATE=$(date +%Y%m%d)

# 归档当前日志
mv $LOG_DIR/access.log $LOG_DIR/access_$DATE.log
mv $LOG_DIR/error.log $LOG_DIR/error_$DATE.log

# 重新加载Nginx以使用新日志文件
nginx -s reload

# 压缩旧日志
gzip $LOG_DIR/access_$DATE.log
gzip $LOG_DIR/error_$DATE.log
```

将此脚本保存为`rotate_nginx_logs.sh`，并通过`cron`定期执行。

## 实际应用场景

### 场景1：高流量网站

对于高流量网站，日志文件增长迅速。通过`logrotate`每天轮转日志并保留14天的归档文件，可以有效管理磁盘空间，同时保留足够的日志用于分析。

### 场景2：合规性要求

某些行业对日志保留有严格要求。通过配置`logrotate`，可以确保日志按需保留并定期归档，满足合规性要求。

## 总结

Nginx日志轮转是管理日志文件的重要技术，能够有效控制日志文件的大小和数量，提升系统性能和日志分析效率。通过`logrotate`工具或自定义脚本，可以轻松实现日志轮转。

:::tip
建议初学者从`logrotate`开始学习，这是最常用且易于配置的方法。
:::

## 附加资源

1. [logrotate官方文档](https://linux.die.net/man/8/logrotate)
2. [Nginx日志配置指南](https://nginx.org/en/docs/http/ngx_http_log_module.html)
3. [Bash脚本编写教程](https://ryanstutorials.net/bash-scripting-tutorial/)

## 练习

1. 在你的服务器上配置`logrotate`，轮转Nginx日志并测试其效果。
2. 编写一个Bash脚本，实现按文件大小轮转Nginx日志。