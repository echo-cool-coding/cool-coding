---
title: Nginx 变量
description: 了解Nginx变量的基本概念、使用方法以及实际应用场景，帮助初学者掌握Nginx配置中的变量功能。
---

## 介绍

Nginx是一个高性能的HTTP和反向代理服务器，广泛用于Web服务器、负载均衡和缓存等场景。Nginx的强大之处在于其灵活的配置能力，而**变量**是Nginx配置中非常重要的一部分。通过使用变量，你可以动态地处理请求、修改响应内容、实现复杂的逻辑控制等。

本文将详细介绍Nginx变量的基本概念、使用方法以及实际应用场景，帮助你更好地理解和运用Nginx变量。

## 什么是Nginx变量？

Nginx变量是Nginx配置中用于存储和传递数据的占位符。它们可以存储请求头、响应头、URI、查询参数等信息，并在配置文件中动态使用。Nginx变量通常以`$`符号开头，例如`$host`、`$uri`等。

Nginx变量分为**内置变量**和**自定义变量**两种：

- **内置变量**：Nginx预定义了一些变量，可以直接在配置中使用。例如，`$host`表示请求的主机名，`$uri`表示请求的URI。
- **自定义变量**：你可以通过`set`指令定义自己的变量，并在配置中使用。

## 内置变量

Nginx提供了许多内置变量，以下是一些常用的内置变量及其含义：

| 变量名       | 描述                                                                 |
|--------------|----------------------------------------------------------------------|
| `$host`      | 请求的主机名（不包含端口号）。                                       |
| `$uri`       | 请求的URI（不包含查询参数）。                                        |
| `$args`      | 请求的查询参数（即`?`后面的部分）。                                  |
| `$request_method` | 请求的HTTP方法（如GET、POST等）。                                |
| `$remote_addr` | 客户端的IP地址。                                                   |
| `$server_name` | 服务器名称（即`server`块中定义的名称）。                           |
| `$http_<header>` | 请求头中的某个字段，例如`$http_user_agent`表示`User-Agent`头。 |

### 示例：使用内置变量

以下是一个简单的Nginx配置示例，展示了如何使用内置变量：

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        return 200 "Host: $host\nURI: $uri\nArgs: $args\n";
    }
}
```

当访问`http://example.com/path?query=123`时，Nginx会返回以下响应：

```
Host: example.com
URI: /path
Args: query=123
```

## 自定义变量

除了使用内置变量，你还可以通过`set`指令定义自己的变量。自定义变量的值可以是字符串、数字或其他变量的组合。

### 示例：定义和使用自定义变量

以下示例展示了如何定义和使用自定义变量：

```nginx
server {
    listen 80;
    server_name example.com;

    set $my_var "Hello, World!";

    location / {
        return 200 "$my_var\n";
    }
}
```

当访问`http://example.com/`时，Nginx会返回以下响应：

```
Hello, World!
```

## 变量的实际应用场景

### 1. 动态重定向

你可以使用变量来实现动态重定向。例如，根据请求的URI将用户重定向到不同的页面：

```nginx
server {
    listen 80;
    server_name example.com;

    location /old-path {
        return 301 $scheme://$host/new-path;
    }
}
```

当用户访问`http://example.com/old-path`时，Nginx会将用户重定向到`http://example.com/new-path`。

### 2. 条件判断

你可以使用变量结合`if`指令来实现条件判断。例如，根据请求的`User-Agent`头返回不同的内容：

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        if ($http_user_agent ~* "Mobile") {
            return 200 "Mobile User\n";
        }
        return 200 "Desktop User\n";
    }
}
```

当用户使用移动设备访问时，Nginx会返回`Mobile User`，否则返回`Desktop User`。

### 3. 日志记录

你可以使用变量在日志中记录更多信息。例如，记录请求的`User-Agent`和`Referer`头：

```nginx
http {
    log_format custom '$remote_addr - $http_user_agent - $http_referer';
    access_log /var/log/nginx/access.log custom;
}
```

这样，Nginx会在日志中记录客户端的IP地址、`User-Agent`和`Referer`信息。

## 总结

Nginx变量是Nginx配置中非常强大的工具，能够帮助你实现动态的请求处理、条件判断、日志记录等功能。通过本文的学习，你应该已经掌握了Nginx变量的基本概念、使用方法以及实际应用场景。

:::tip 提示
如果你想进一步深入学习Nginx变量，可以参考Nginx官方文档中的[变量模块](http://nginx.org/en/docs/varindex.html)。
:::

## 附加资源

- [Nginx官方文档](http://nginx.org/en/docs/)
- [Nginx变量模块](http://nginx.org/en/docs/varindex.html)
- [Nginx配置指南](https://www.nginx.com/resources/wiki/start/topics/examples/full/)

## 练习

1. 编写一个Nginx配置，使用内置变量`$uri`和`$args`返回请求的URI和查询参数。
2. 使用自定义变量实现一个简单的条件判断，根据请求的`User-Agent`头返回不同的响应内容。
3. 修改Nginx的日志格式，记录请求的`User-Agent`和`Referer`头。

通过完成这些练习，你将更好地掌握Nginx变量的使用方法。