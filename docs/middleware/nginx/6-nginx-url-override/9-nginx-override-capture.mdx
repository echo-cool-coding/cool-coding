---
title: Nginx 重写捕获
description: 学习如何在Nginx中使用重写捕获功能，掌握URL重写的高级技巧，提升网站的路由灵活性。
---

# Nginx 重写捕获

Nginx是一个高性能的Web服务器和反向代理服务器，广泛用于处理HTTP请求。在Nginx中，URL重写是一个强大的功能，允许你修改请求的URL路径，从而实现更灵活的路由和资源管理。本文将重点介绍Nginx中的**重写捕获**功能，帮助你理解如何通过捕获URL中的特定部分来实现更复杂的重写规则。

## 什么是Nginx重写捕获？

Nginx的重写捕获功能允许你在重写规则中捕获URL中的特定部分，并将其用于后续的重写或代理操作。通过使用正则表达式，你可以从URL中提取出特定的片段，并将这些片段作为变量在重写规则中使用。

### 基本语法

Nginx的重写捕获功能通常与`rewrite`指令结合使用。`rewrite`指令的基本语法如下：

```nginx
rewrite regex replacement [flag];
```

- `regex`：用于匹配URL的正则表达式。
- `replacement`：重写后的URL。
- `flag`：可选参数，用于指定重写的行为（如`last`、`break`等）。

在正则表达式中，你可以使用括号`()`来捕获URL中的特定部分。捕获的内容可以通过`$1`、`$2`等变量在`replacement`中使用。

## 示例：捕获URL中的数字

假设你有一个URL路径为`/user/123/profile`，你希望捕获其中的用户ID（即`123`），并将其用于重写规则。

### 输入URL
```
/user/123/profile
```

### Nginx 配置

```nginx
server {
    listen 80;
    server_name example.com;

    location /user/ {
        rewrite ^/user/(\d+)/profile$ /profile?id=$1 last;
    }
}
```

### 解释
- `^/user/(\d+)/profile$`：这是一个正则表达式，匹配以`/user/`开头，后跟一个或多个数字（`\d+`），并以`/profile`结尾的URL。
- `(\d+)`：捕获URL中的数字部分，并将其存储在`$1`变量中。
- `/profile?id=$1`：将捕获的数字作为查询参数`id`的值，重写URL为`/profile?id=123`。

### 输出URL
```
/profile?id=123
```

## 实际应用场景

### 场景1：动态路由

假设你有一个博客系统，URL结构为`/post/123`，其中`123`是文章的ID。你希望将URL重写为`/index.php?post_id=123`，以便在PHP脚本中处理。

#### Nginx 配置

```nginx
server {
    listen 80;
    server_name blog.example.com;

    location /post/ {
        rewrite ^/post/(\d+)$ /index.php?post_id=$1 last;
    }
}
```

#### 解释
- `^/post/(\d+)$`：匹配以`/post/`开头，后跟一个或多个数字的URL。
- `(\d+)`：捕获文章ID，存储在`$1`中。
- `/index.php?post_id=$1`：将捕获的ID作为查询参数`post_id`的值，重写URL。

### 场景2：多级捕获

假设你有一个电商网站，URL结构为`/category/123/product/456`，其中`123`是分类ID，`456`是产品ID。你希望将URL重写为`/index.php?category_id=123&product_id=456`。

#### Nginx 配置

```nginx
server {
    listen 80;
    server_name shop.example.com;

    location /category/ {
        rewrite ^/category/(\d+)/product/(\d+)$ /index.php?category_id=$1&product_id=$2 last;
    }
}
```

#### 解释
- `^/category/(\d+)/product/(\d+)$`：匹配以`/category/`开头，后跟分类ID，然后是`/product/`，最后是产品ID的URL。
- `(\d+)`：分别捕获分类ID和产品ID，存储在`$1`和`$2`中。
- `/index.php?category_id=$1&product_id=$2`：将捕获的分类ID和产品ID作为查询参数，重写URL。

## 总结

Nginx的重写捕获功能是一个非常强大的工具，允许你通过正则表达式从URL中提取特定部分，并将其用于重写规则。通过掌握这一功能，你可以实现更灵活的路由和资源管理，提升网站的性能和用户体验。

### 附加资源
- [Nginx官方文档](https://nginx.org/en/docs/)
- [Nginx Rewrite模块文档](https://nginx.org/en/docs/http/ngx_http_rewrite_module.html)

### 练习
1. 尝试编写一个Nginx配置，将URL `/article/2023/09/123` 重写为 `/index.php?year=2023&month=09&id=123`。
2. 思考如何在Nginx中使用重写捕获功能来处理多语言站点的URL重写。

:::tip
在实际使用中，建议在修改Nginx配置后，使用`nginx -t`命令测试配置文件的正确性，避免因配置错误导致服务不可用。
:::