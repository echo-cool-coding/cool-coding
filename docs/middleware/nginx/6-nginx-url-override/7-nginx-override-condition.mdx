---
title: Nginx 重写条件
description: 了解如何在Nginx中使用重写条件来动态修改URL，并掌握其实际应用场景。
---

# Nginx 重写条件

Nginx是一个强大的Web服务器和反向代理服务器，广泛用于处理HTTP请求。URL重写是Nginx中一个重要的功能，它允许你根据特定条件动态修改请求的URL。本文将详细介绍Nginx中的重写条件，并通过实际案例帮助你理解其应用。

## 什么是Nginx重写条件？

Nginx的重写条件（Rewrite Conditions）允许你在重写URL之前检查某些条件。这些条件可以是请求的URI、请求方法、HTTP头等。如果条件满足，Nginx将执行重写规则，否则将跳过该规则。

### 基本语法

Nginx的重写条件通常与 `if` 指令一起使用。`if` 指令的语法如下：

```nginx
if (condition) {
    rewrite regex replacement [flag];
}
```

- `condition`：条件表达式，可以是变量、字符串比较、正则表达式等。
- `regex`：用于匹配请求URI的正则表达式。
- `replacement`：替换字符串，用于生成新的URI。
- `flag`：可选标志，用于控制重写行为。

## 重写条件的常见用法

### 1. 基于请求URI的重写

假设你希望将所有以 `/old/` 开头的请求重定向到 `/new/`，可以使用以下配置：

```nginx
location / {
    if ($uri ~* "^/old/(.*)") {
        rewrite ^/old/(.*)$ /new/$1 permanent;
    }
}
```

- `$uri`：当前请求的URI。
- `~*`：不区分大小写的正则表达式匹配。
- `permanent`：返回301永久重定向状态码。

**输入：** `http://example.com/old/page`  
**输出：** `http://example.com/new/page`

### 2. 基于请求方法的重写

如果你只想对 `POST` 请求进行重写，可以使用以下配置：

```nginx
location / {
    if ($request_method = POST) {
        rewrite ^/post/(.*)$ /new-post/$1 last;
    }
}
```

- `$request_method`：当前请求的HTTP方法。
- `last`：停止处理当前的重写规则，并继续匹配其他规则。

**输入：** `POST http://example.com/post/data`  
**输出：** `POST http://example.com/new-post/data`

### 3. 基于HTTP头的重写

假设你希望根据 `User-Agent` 头重写URL，可以使用以下配置：

```nginx
location / {
    if ($http_user_agent ~* "Mobile") {
        rewrite ^/(.*)$ /mobile/$1 break;
    }
}
```

- `$http_user_agent`：请求的 `User-Agent` 头。
- `break`：停止处理当前的重写规则，并继续处理请求。

**输入：** `http://example.com/page`（来自移动设备）  
**输出：** `http://example.com/mobile/page`

## 实际案例

### 案例1：重定向旧URL到新URL

假设你的网站进行了重构，旧的URL结构需要重定向到新的URL结构。你可以使用以下配置：

```nginx
location / {
    if ($uri ~* "^/old-blog/(.*)") {
        rewrite ^/old-blog/(.*)$ /new-blog/$1 permanent;
    }
}
```

**输入：** `http://example.com/old-blog/post-123`  
**输出：** `http://example.com/new-blog/post-123`

### 案例2：根据设备类型重定向

假设你希望根据用户设备类型（桌面或移动）重定向到不同的页面，可以使用以下配置：

```nginx
location / {
    if ($http_user_agent ~* "Mobile") {
        rewrite ^/(.*)$ /mobile/$1 break;
    }
    if ($http_user_agent ~* "Desktop") {
        rewrite ^/(.*)$ /desktop/$1 break;
    }
}
```

**输入：** `http://example.com/page`（来自移动设备）  
**输出：** `http://example.com/mobile/page`

## 总结

Nginx的重写条件是一个非常强大的工具，允许你根据各种条件动态修改URL。通过合理使用重写条件，你可以实现URL重定向、设备类型检测、请求方法过滤等功能。希望本文能帮助你理解并掌握Nginx重写条件的使用。

## 附加资源

- [Nginx官方文档](https://nginx.org/en/docs/)
- [Nginx Rewrite Module文档](https://nginx.org/en/docs/http/ngx_http_rewrite_module.html)

## 练习

1. 尝试配置Nginx，将所有以 `/api/` 开头的请求重定向到 `/v2/api/`。
2. 编写一个Nginx配置，根据 `Referer` 头重定向请求到不同的页面。

:::tip
在修改Nginx配置后，记得使用 `nginx -t` 测试配置文件的正确性，并使用 `nginx -s reload` 重新加载配置。
:::