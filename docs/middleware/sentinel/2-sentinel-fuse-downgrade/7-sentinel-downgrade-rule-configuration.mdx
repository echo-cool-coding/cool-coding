---
title: Sentinel 降级规则配置
description: 了解如何在Sentinel中配置降级规则，以保护系统在高并发或异常情况下保持稳定。
---

# Sentinel 降级规则配置

Sentinel是阿里巴巴开源的一款轻量级流量控制组件，主要用于微服务架构中的流量控制、熔断降级和系统保护。降级规则是Sentinel的核心功能之一，它可以在系统资源紧张或服务异常时，自动降低某些非核心功能的优先级，从而保证核心功能的正常运行。

## 什么是降级规则？

降级规则是Sentinel中用于在系统资源紧张或服务异常时，自动降低某些非核心功能的优先级的一种机制。通过配置降级规则，可以在系统负载过高或服务响应时间过长时，自动触发降级策略，避免系统崩溃。

## 降级规则的核心概念

在Sentinel中，降级规则主要基于以下几个核心概念：

1. **资源（Resource）**：需要保护的资源，通常是一个方法或接口。
2. **降级策略（Degrade Strategy）**：当资源达到某种条件时，触发的降级策略。常见的降级策略包括：慢调用比例、异常比例、异常数等。
3. **降级阈值（Degrade Threshold）**：触发降级策略的阈值，例如慢调用比例超过50%时触发降级。
4. **恢复时间（Recovery Time）**：降级后，系统恢复正常的时间。

## 配置降级规则

在Sentinel中，可以通过代码或配置文件来配置降级规则。以下是一个通过代码配置降级规则的示例：

```java
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;
import com.alibaba.csp.sentinel.slots.block.degrade.circuitbreaker.CircuitBreakerStrategy;

public class DegradeRuleConfig {
    public static void initDegradeRule() {
        DegradeRule rule = new DegradeRule("myResource")
            .setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType()) // 降级策略：慢调用比例
            .setCount(500) // 慢调用响应时间阈值，单位：毫秒
            .setTimeWindow(10) // 降级后的恢复时间，单位：秒
            .setStatIntervalMs(1000) // 统计时间窗口，单位：毫秒
            .setMinRequestAmount(5) // 最小请求数，低于此值不触发降级
            .setSlowRatioThreshold(0.5); // 慢调用比例阈值

        DegradeRuleManager.loadRules(Collections.singletonList(rule));
    }
}
```

### 代码解释

1. **setGrade**：设置降级策略，这里使用的是慢调用比例策略。
2. **setCount**：设置慢调用响应时间的阈值，单位为毫秒。
3. **setTimeWindow**：设置降级后的恢复时间，单位为秒。
4. **setStatIntervalMs**：设置统计时间窗口，单位为毫秒。
5. **setMinRequestAmount**：设置最小请求数，低于此值不触发降级。
6. **setSlowRatioThreshold**：设置慢调用比例阈值，超过此值触发降级。

## 实际应用场景

假设我们有一个电商系统，其中有一个商品详情页的接口 `getProductDetail`。在高并发情况下，该接口的响应时间可能会变长，导致用户体验下降。为了确保系统的稳定性，我们可以为该接口配置降级规则：

```java
DegradeRule rule = new DegradeRule("getProductDetail")
    .setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType())
    .setCount(1000) // 响应时间超过1秒视为慢调用
    .setTimeWindow(10) // 降级后10秒恢复
    .setStatIntervalMs(1000)
    .setMinRequestAmount(10)
    .setSlowRatioThreshold(0.5); // 慢调用比例超过50%时触发降级
```

当 `getProductDetail` 接口的慢调用比例超过50%时，Sentinel会自动触发降级，降低该接口的优先级，从而保护系统的核心功能。

## 总结

通过配置Sentinel的降级规则，我们可以在系统资源紧张或服务异常时，自动降低某些非核心功能的优先级，从而保证系统的稳定性。降级规则的核心在于选择合适的降级策略和阈值，并根据实际业务场景进行调整。

## 附加资源与练习

- **官方文档**：[Sentinel官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- **练习**：尝试在你的项目中配置一个降级规则，并模拟高并发场景，观察降级规则的效果。

:::tip
在实际生产环境中，建议结合监控系统（如Prometheus、Grafana）来实时观察降级规则的触发情况，并根据实际情况调整降级策略和阈值。
:::