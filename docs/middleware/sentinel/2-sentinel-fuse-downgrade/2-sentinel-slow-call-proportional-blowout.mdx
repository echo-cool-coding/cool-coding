---
title: Sentinel 慢调用比例熔断
description: 了解Sentinel中的慢调用比例熔断机制，掌握如何通过配置慢调用比例来保护系统免受慢调用的影响。
---

# Sentinel 慢调用比例熔断

## 介绍

在分布式系统中，慢调用（Slow Call）是指那些响应时间超过预期阈值的请求。慢调用可能会导致系统资源被长时间占用，进而影响系统的整体性能。Sentinel 提供了一种基于慢调用比例的熔断机制，当慢调用的比例超过设定的阈值时，Sentinel 会自动触发熔断，从而保护系统免受慢调用的影响。

## 什么是慢调用比例熔断？

慢调用比例熔断是 Sentinel 中的一种熔断策略，它通过监控请求的响应时间来判断是否存在慢调用。当慢调用的比例超过设定的阈值时，Sentinel 会触发熔断，暂时停止对该资源的访问，从而避免系统资源被进一步占用。

### 关键概念

- **慢调用比例（Slow Call Ratio）**：慢调用比例是指在一定时间窗口内，慢调用请求占总请求的比例。
- **熔断阈值（Circuit Breaker Threshold）**：当慢调用比例超过该阈值时，Sentinel 会触发熔断。
- **熔断时间窗口（Circuit Breaker Time Window）**：熔断触发后，系统会在该时间窗口内停止对该资源的访问。

## 配置慢调用比例熔断

在 Sentinel 中，可以通过以下配置来启用慢调用比例熔断：

```java
// 配置慢调用比例熔断规则
DegradeRule rule = new DegradeRule("resourceName")
    .setGrade(RuleConstant.DEGRADE_GRADE_RT) // 设置熔断策略为慢调用比例
    .setCount(500) // 设置慢调用阈值为500ms
    .setTimeWindow(10) // 设置熔断时间窗口为10秒
    .setSlowRatioThreshold(0.5) // 设置慢调用比例阈值为50%
    .setMinRequestAmount(5); // 设置最小请求数为5

DegradeRuleManager.loadRules(Collections.singletonList(rule));
```

### 参数解释

- `setGrade(RuleConstant.DEGRADE_GRADE_RT)`：设置熔断策略为慢调用比例。
- `setCount(500)`：设置慢调用阈值为500ms，即响应时间超过500ms的请求被视为慢调用。
- `setTimeWindow(10)`：设置熔断时间窗口为10秒，即熔断触发后，系统会在10秒内停止对该资源的访问。
- `setSlowRatioThreshold(0.5)`：设置慢调用比例阈值为50%，即当慢调用比例超过50%时，触发熔断。
- `setMinRequestAmount(5)`：设置最小请求数为5，即只有在请求数达到5时，才会计算慢调用比例。

## 实际案例

假设我们有一个电商系统，其中有一个商品详情页的接口 `getProductDetail`。在高并发场景下，该接口可能会出现慢调用，导致系统性能下降。我们可以通过配置慢调用比例熔断来保护系统。

### 场景描述

- 接口 `getProductDetail` 的响应时间通常为200ms。
- 在高并发场景下，部分请求的响应时间可能超过500ms。
- 我们希望当慢调用比例超过50%时，触发熔断，停止对该接口的访问。

### 配置示例

```java
DegradeRule rule = new DegradeRule("getProductDetail")
    .setGrade(RuleConstant.DEGRADE_GRADE_RT)
    .setCount(500)
    .setTimeWindow(10)
    .setSlowRatioThreshold(0.5)
    .setMinRequestAmount(5);

DegradeRuleManager.loadRules(Collections.singletonList(rule));
```

### 运行结果

- 当 `getProductDetail` 接口的慢调用比例超过50%时，Sentinel 会触发熔断，停止对该接口的访问。
- 在熔断时间窗口（10秒）内，所有对该接口的请求都会被拒绝。
- 10秒后，Sentinel 会重新评估慢调用比例，如果比例恢复正常，则恢复对该接口的访问。

## 总结

Sentinel 的慢调用比例熔断机制是一种有效的系统保护策略，它通过监控请求的响应时间来判断是否存在慢调用，并在慢调用比例超过阈值时触发熔断。通过合理配置慢调用比例熔断规则，可以有效保护系统免受慢调用的影响，提升系统的稳定性和可靠性。

## 附加资源

- [Sentinel 官方文档](https://sentinelguard.io/)
- [Sentinel GitHub 仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 尝试在你的项目中配置慢调用比例熔断规则，并观察熔断触发的情况。
2. 调整慢调用比例阈值和熔断时间窗口，观察系统的响应变化。
3. 结合实际业务场景，思考如何优化慢调用比例熔断的配置。

:::tip
在实际生产环境中，建议结合监控系统实时观察慢调用比例的变化，并根据实际情况调整熔断规则。
:::