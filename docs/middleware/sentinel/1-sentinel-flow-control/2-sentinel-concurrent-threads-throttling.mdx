---
title: Sentinel 并发线程数限流
description: 了解Sentinel如何通过并发线程数限流来保护系统资源，避免因高并发导致的系统崩溃。
---

# Sentinel 并发线程数限流

在高并发场景下，系统资源可能会被大量请求耗尽，导致服务不可用。Sentinel 提供了一种强大的限流机制——**并发线程数限流**，用于控制同时处理请求的线程数量，从而保护系统资源。

## 什么是并发线程数限流？

并发线程数限流是一种通过限制同时处理请求的线程数量来保护系统资源的机制。当并发线程数超过设定的阈值时，Sentinel 会拒绝新的请求，直到有线程释放资源。

### 为什么需要并发线程数限流？

- **防止资源耗尽**：过多的并发请求可能导致 CPU、内存等资源耗尽，进而导致系统崩溃。
- **提高系统稳定性**：通过限制并发线程数，可以确保系统在高负载下仍能稳定运行。
- **避免雪崩效应**：当某个服务出现问题时，限流可以防止问题扩散到整个系统。

## 如何使用Sentinel实现并发线程数限流？

Sentinel 提供了简单易用的 API 来实现并发线程数限流。以下是一个基本的示例：

```java
import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

public class ConcurrentThreadLimitExample {

    public static void initFlowRules() {
        FlowRule rule = new FlowRule();
        rule.setResource("testResource");
        rule.setGrade(RuleConstant.FLOW_GRADE_THREAD);
        rule.setCount(10); // 设置最大并发线程数为10
        FlowRuleManager.loadRules(Collections.singletonList(rule));
    }

    public static void main(String[] args) {
        initFlowRules();

        for (int i = 0; i < 20; i++) {
            new Thread(() -> {
                try (Entry entry = SphU.entry("testResource")) {
                    // 模拟业务逻辑
                    Thread.sleep(100);
                    System.out.println("请求处理成功");
                } catch (BlockException e) {
                    System.out.println("请求被限流");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
```

### 代码解释

1. **初始化限流规则**：通过 `FlowRule` 设置资源名、限流类型（`FLOW_GRADE_THREAD`）和最大并发线程数（`count`）。
2. **模拟并发请求**：创建多个线程模拟并发请求，每个线程尝试获取资源。
3. **处理限流**：当并发线程数超过阈值时，`SphU.entry` 会抛出 `BlockException`，表示请求被限流。

### 输出示例

```
请求处理成功
请求处理成功
请求被限流
请求被限流
...
```

## 实际应用场景

### 场景1：API网关限流

在微服务架构中，API 网关通常会接收到大量的请求。通过并发线程数限流，可以防止某个服务的请求过多，导致网关资源耗尽。

### 场景2：数据库连接池管理

数据库连接池的并发连接数是有限的。通过 Sentinel 的并发线程数限流，可以确保数据库连接不会被过多的请求耗尽，从而避免数据库服务不可用。

## 总结

Sentinel 的并发线程数限流是一种有效的资源保护机制，适用于高并发场景下的系统保护。通过限制并发线程数，可以防止资源耗尽，提高系统的稳定性和可靠性。

:::tip 提示
在实际应用中，建议根据系统的实际负载情况动态调整限流阈值，以达到最佳的保护效果。
:::

## 附加资源

- [Sentinel 官方文档](https://sentinelguard.io/)
- [Sentinel GitHub 仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 修改上述代码，将最大并发线程数设置为5，观察输出结果。
2. 尝试在微服务项目中集成 Sentinel，并配置并发线程数限流规则。
