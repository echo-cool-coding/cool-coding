---
title: Sentinel Apollo规则存储
description: 了解如何使用Apollo作为Sentinel的规则存储，实现动态规则管理和配置。
---

# Sentinel Apollo规则存储

## 介绍

Sentinel 是阿里巴巴开源的一款轻量级流量控制框架，广泛应用于微服务架构中。它通过定义规则（如流量控制、熔断降级等）来保护系统的稳定性。Sentinel 支持多种规则存储方式，其中 **Apollo** 是一个强大的配置中心，能够实现规则的动态管理和实时更新。

本文将详细介绍如何将 Apollo 作为 Sentinel 的规则存储，并通过实际案例展示其应用场景。

---

## 什么是Apollo？

Apollo 是携程开源的一款分布式配置中心，支持配置的集中管理、实时推送和历史版本管理。它非常适合用于微服务架构中的动态配置管理。

将 Apollo 与 Sentinel 结合使用，可以实现 Sentinel 规则的动态更新，而无需重启应用。

---

## 如何配置Sentinel使用Apollo存储规则

### 1. 引入依赖

首先，在项目的 `pom.xml` 文件中添加 Sentinel 和 Apollo 的依赖：

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-apollo</artifactId>
    <version>1.8.4</version>
</dependency>
<dependency>
    <groupId>com.ctrip.framework.apollo</groupId>
    <artifactId>apollo-client</artifactId>
    <version>1.9.0</version>
</dependency>
```

### 2. 配置Apollo

在 `application.properties` 或 `application.yml` 中配置 Apollo 的基本信息：

```properties
# Apollo配置
app.id=your-app-id
apollo.meta=http://your-apollo-config-server
apollo.bootstrap.enabled=true
apollo.bootstrap.namespaces=application,Sentinel
```

### 3. 配置Sentinel数据源

在代码中配置 Sentinel 的数据源为 Apollo：

```java
import com.alibaba.csp.sentinel.datasource.apollo.ApolloDataSource;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;

public class SentinelApolloConfig {

    public static void init() {
        // 定义Apollo数据源
        ApolloDataSource<String> flowRuleDataSource = new ApolloDataSource<>(
            "Sentinel", // Apollo命名空间
            "flowRules", // Apollo配置项
            "", // 默认值
            source -> JSON.parseObject(source, new TypeReference<List<FlowRule>>() {})
        );

        // 注册数据源
        FlowRuleManager.register2Property(flowRuleDataSource.getProperty());
    }
}
```

### 4. 启动应用

在应用启动时调用 `init()` 方法，初始化 Sentinel 的 Apollo 数据源：

```java
public class Application {
    public static void main(String[] args) {
        SentinelApolloConfig.init();
        // 启动应用
    }
}
```

---

## 实际案例

### 场景描述

假设我们有一个电商系统，需要对商品详情页的访问流量进行控制。当流量超过阈值时，触发限流规则，保护后端服务。

### 配置规则

在 Apollo 的 `Sentinel` 命名空间中，添加以下规则：

```json
[
    {
        "resource": "productDetail",
        "limitApp": "default",
        "grade": 1,
        "count": 100,
        "strategy": 0,
        "controlBehavior": 0,
        "clusterMode": false
    }
]
```

### 规则生效

当 Apollo 中的规则更新时，Sentinel 会自动加载新的规则并生效。例如，将 `count` 从 100 修改为 50，Sentinel 会立即应用新的限流阈值。

---

## 总结

通过将 Apollo 作为 Sentinel 的规则存储，我们可以实现规则的动态管理和实时更新，极大地提高了系统的灵活性和可维护性。对于初学者来说，掌握这一技术将为构建高可用、高性能的微服务系统打下坚实的基础。

---

## 附加资源

- [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Apollo 官方文档](https://www.apolloconfig.com/#/zh/README)

## 练习

1. 尝试在本地搭建 Apollo 配置中心，并配置 Sentinel 使用 Apollo 存储规则。
2. 修改 Apollo 中的规则，观察 Sentinel 的行为变化。
3. 扩展规则类型，尝试配置熔断降级规则。

:::tip
如果你在配置过程中遇到问题，可以参考官方文档或社区论坛，获取更多帮助。
:::