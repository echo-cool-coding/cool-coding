---
title: Sentinel API 使用示例
description: 本文将通过详细的代码示例和实际案例，帮助初学者理解如何使用 Sentinel 的主要 API 进行流量控制、熔断降级等操作。
---

# Sentinel API 使用示例

Sentinel 是阿里巴巴开源的一款轻量级流量控制组件，主要用于微服务架构中的流量控制、熔断降级、系统负载保护等场景。本文将介绍 Sentinel 的主要 API，并通过代码示例展示如何使用这些 API 来实现流量控制。

## 1. 什么是 Sentinel API？

Sentinel 提供了一系列的 API，允许开发者通过编程的方式定义资源、设置规则以及监控流量。通过这些 API，开发者可以灵活地控制系统的流量，防止系统因流量过大而崩溃。

## 2. 主要 API 介绍

### 2.1 定义资源

在 Sentinel 中，资源是流量控制的基本单位。你可以通过 `SphU.entry()` 方法来定义一个资源。

```java
try (Entry entry = SphU.entry("resourceName")) {
    // 被保护的逻辑
    System.out.println("执行资源逻辑");
} catch (BlockException e) {
    // 处理被限流或降级的逻辑
    System.out.println("资源被限流或降级");
}
```

在上面的代码中，`resourceName` 是资源的名称。`SphU.entry()` 方法会尝试进入资源，如果资源被限流或降级，则会抛出 `BlockException` 异常。

### 2.2 设置流量控制规则

Sentinel 允许你通过 `FlowRuleManager.loadRules()` 方法来设置流量控制规则。

```java
FlowRule rule = new FlowRule();
rule.setResource("resourceName");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(10); // 每秒最多允许 10 个请求

List<FlowRule> rules = new ArrayList<>();
rules.add(rule);

FlowRuleManager.loadRules(rules);
```

在上面的代码中，我们定义了一个流量控制规则，限制 `resourceName` 资源的 QPS（每秒请求数）为 10。

### 2.3 监控流量

Sentinel 提供了 `StatisticSlot` 来监控资源的流量。你可以通过 `ClusterNode` 来获取资源的实时流量数据。

```java
ClusterNode clusterNode = ClusterBuilderSlot.getClusterNode("resourceName");
System.out.println("当前 QPS: " + clusterNode.passQps());
```

## 3. 实际案例

### 3.1 限流案例

假设我们有一个电商系统，其中有一个商品详情页的接口 `getProductDetail`，我们希望限制该接口的 QPS 为 100，以防止系统过载。

```java
// 定义资源
try (Entry entry = SphU.entry("getProductDetail")) {
    // 执行业务逻辑
    ProductDetail detail = productService.getProductDetail(productId);
    return detail;
} catch (BlockException e) {
    // 处理限流逻辑
    return new ProductDetail("系统繁忙，请稍后再试");
}

// 设置限流规则
FlowRule rule = new FlowRule();
rule.setResource("getProductDetail");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(100);

List<FlowRule> rules = new ArrayList<>();
rules.add(rule);

FlowRuleManager.loadRules(rules);
```

### 3.2 熔断降级案例

假设我们有一个支付接口 `pay`，我们希望在该接口的响应时间超过 1 秒时进行熔断降级。

```java
DegradeRule degradeRule = new DegradeRule();
degradeRule.setResource("pay");
degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
degradeRule.setCount(1000); // 响应时间超过 1000ms 时触发熔断
degradeRule.setTimeWindow(10); // 熔断持续 10 秒

List<DegradeRule> degradeRules = new ArrayList<>();
degradeRules.add(degradeRule);

DegradeRuleManager.loadRules(degradeRules);
```

## 4. 总结

通过本文的介绍，你应该已经了解了如何使用 Sentinel 的主要 API 来进行流量控制和熔断降级。Sentinel 提供了丰富的 API 和灵活的配置，能够帮助你在微服务架构中有效地保护系统。

## 5. 附加资源与练习

- **官方文档**: [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- **练习**: 尝试在你的项目中集成 Sentinel，并为某个关键接口设置流量控制规则。

:::tip
如果你在使用 Sentinel 的过程中遇到问题，可以参考官方文档或社区论坛，获取更多帮助。
:::