---
title: Sentinel 微服务集群案例
description: 本文将通过一个实际案例，详细介绍如何在微服务集群中使用Sentinel进行流量控制、熔断降级和系统保护，帮助初学者掌握Sentinel的核心功能。
---

# Sentinel 微服务集群案例

## 介绍

Sentinel是阿里巴巴开源的一款轻量级流量控制组件，广泛应用于微服务架构中，用于实现流量控制、熔断降级和系统保护等功能。在微服务集群中，服务之间的调用关系复杂，流量波动较大，因此需要一种高效的方式来保护系统的稳定性。Sentinel通过实时监控和动态规则配置，能够有效应对这些挑战。

本文将结合实际案例，逐步讲解如何在微服务集群中使用Sentinel，并通过代码示例展示其核心功能。

## 案例背景

假设我们有一个简单的微服务集群，包含以下服务：

1. **用户服务（User Service）**：提供用户信息的查询和更新功能。
2. **订单服务（Order Service）**：处理用户的订单请求。
3. **支付服务（Payment Service）**：处理支付请求。

这些服务之间相互调用，形成一个复杂的调用链。在高并发场景下，如果某个服务出现故障或响应变慢，可能会导致整个系统的雪崩效应。Sentinel可以帮助我们避免这种情况。

## 安装与配置

首先，我们需要在每个微服务中引入Sentinel的依赖。以Maven项目为例，添加以下依赖：

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

接下来，在`application.yml`中配置Sentinel Dashboard的地址：

```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080
```

## 流量控制

### 场景描述

假设我们的用户服务在高并发场景下，每秒最多只能处理100个请求。如果请求量超过这个阈值，我们希望拒绝多余的请求，避免服务过载。

### 实现步骤

1. 在用户服务中定义一个接口：

```java
@RestController
public class UserController {

    @GetMapping("/user/{id}")
    public String getUser(@PathVariable String id) {
        // 模拟查询用户信息
        return "User Info: " + id;
    }
}
```

2. 在Sentinel Dashboard中为该接口配置流量控制规则，设置QPS阈值为100。

3. 当请求量超过100 QPS时，Sentinel会自动拒绝多余的请求，并返回`Blocked by Sentinel`的提示。

### 代码示例

```java
@SentinelResource(value = "getUser", blockHandler = "handleBlock")
@GetMapping("/user/{id}")
public String getUser(@PathVariable String id) {
    return "User Info: " + id;
}

public String handleBlock(String id, BlockException ex) {
    return "Blocked by Sentinel";
}
```

## 熔断降级

### 场景描述

假设订单服务依赖于支付服务，如果支付服务响应时间过长或出现故障，我们希望订单服务能够快速失败，避免资源浪费。

### 实现步骤

1. 在订单服务中调用支付服务：

```java
@RestController
public class OrderController {

    @Autowired
    private PaymentService paymentService;

    @GetMapping("/order/{id}")
    public String createOrder(@PathVariable String id) {
        String paymentResult = paymentService.processPayment(id);
        return "Order created with payment: " + paymentResult;
    }
}
```

2. 在Sentinel Dashboard中为支付服务配置熔断规则，设置响应时间超过500ms时触发熔断。

3. 当支付服务响应时间超过500ms时，Sentinel会自动熔断，订单服务将直接返回降级结果。

### 代码示例

```java
@SentinelResource(value = "processPayment", fallback = "fallbackPayment")
public String processPayment(String id) {
    // 模拟支付处理
    return "Payment processed for order: " + id;
}

public String fallbackPayment(String id, Throwable ex) {
    return "Payment service is unavailable, please try again later.";
}
```

## 系统保护

### 场景描述

在高并发场景下，系统的CPU、内存等资源可能会被耗尽，导致系统崩溃。Sentinel提供了系统保护功能，可以根据系统的实时负载动态调整流量。

### 实现步骤

1. 在Sentinel Dashboard中配置系统保护规则，设置CPU使用率超过80%时触发保护。

2. 当系统CPU使用率超过80%时，Sentinel会自动限制流量，确保系统不会崩溃。

### 代码示例

```java
// 无需额外代码，系统保护规则在Dashboard中配置即可
```

## 总结

通过以上案例，我们展示了如何在微服务集群中使用Sentinel进行流量控制、熔断降级和系统保护。Sentinel通过实时监控和动态规则配置，能够有效应对高并发场景下的系统稳定性问题。

:::tip
在实际项目中，建议结合Sentinel Dashboard进行实时监控和规则调整，以确保系统的最佳性能。
:::

## 附加资源

- [Sentinel官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Spring Cloud Alibaba Sentinel](https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel)

## 练习

1. 尝试在自己的微服务项目中集成Sentinel，并配置流量控制规则。
2. 模拟高并发场景，观察Sentinel的流量控制效果。
3. 配置熔断降级规则，测试服务故障时的降级处理。

通过以上练习，你将更深入地理解Sentinel在微服务集群中的应用。