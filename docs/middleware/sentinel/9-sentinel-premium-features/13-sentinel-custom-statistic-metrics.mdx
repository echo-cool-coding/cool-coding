---
title: Sentinel 自定义统计指标
description: 了解如何在Sentinel中自定义统计指标，以更好地监控和管理系统的流量和资源使用情况。
---

# Sentinel 自定义统计指标

Sentinel是阿里巴巴开源的一款流量控制组件，广泛应用于微服务架构中，用于保护系统的稳定性和可靠性。Sentinel提供了丰富的内置统计指标，但在某些场景下，内置指标可能无法完全满足需求。这时，我们可以通过自定义统计指标来扩展Sentinel的功能。

## 什么是自定义统计指标？

自定义统计指标是指用户根据自身业务需求，定义并收集特定的系统或业务指标。这些指标可以用于更精细化的流量控制、资源管理以及系统监控。通过自定义统计指标，用户可以更好地理解系统的运行状态，并在出现问题时快速定位和解决。

## 如何自定义统计指标？

在Sentinel中，自定义统计指标通常通过实现`Metric`接口来完成。`Metric`接口定义了如何收集和存储指标数据。Sentinel提供了多种内置的`Metric`实现，如`ArrayMetric`、`SlidingWindowMetric`等，用户也可以根据需要实现自己的`Metric`。

### 实现自定义Metric

以下是一个简单的自定义`Metric`实现示例：

```java
public class CustomMetric implements Metric {
    private final AtomicLong totalRequests = new AtomicLong(0);

    @Override
    public void addSuccess(int count) {
        totalRequests.addAndGet(count);
    }

    @Override
    public void addException(int count) {
        // 自定义异常处理逻辑
    }

    @Override
    public long success() {
        return totalRequests.get();
    }

    @Override
    public long exception() {
        return 0; // 自定义异常计数
    }

    @Override
    public long rt() {
        return 0; // 自定义响应时间
    }

    @Override
    public long minRt() {
        return 0; // 自定义最小响应时间
    }

    @Override
    public long maxRt() {
        return 0; // 自定义最大响应时间
    }
}
```

在这个示例中，我们实现了一个简单的`CustomMetric`，它只统计了成功的请求数量。你可以根据需要扩展这个类，添加更多的统计逻辑。

### 使用自定义Metric

定义好`Metric`后，我们可以将其应用到Sentinel的规则中。例如，我们可以创建一个自定义的`FlowRule`，并使用`CustomMetric`来统计流量：

```java
FlowRule rule = new FlowRule();
rule.setResource("customResource");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(10); // 设置QPS阈值为10
rule.setMetric(new CustomMetric()); // 使用自定义Metric

FlowRuleManager.loadRules(Collections.singletonList(rule));
```

在这个示例中，我们创建了一个`FlowRule`，并将其与`CustomMetric`关联。当流量超过设定的QPS阈值时，Sentinel会根据`CustomMetric`的统计数据进行流量控制。

## 实际应用场景

自定义统计指标在实际应用中有广泛的用途。以下是一些常见的应用场景：

1. **业务指标监控**：例如，统计某个API的调用次数、成功率、响应时间等，以便更好地了解业务运行状况。
2. **资源使用监控**：例如，统计某个服务的CPU使用率、内存使用率等，以便及时发现资源瓶颈。
3. **异常监控**：例如，统计某个服务的异常次数、异常类型等，以便快速定位和解决问题。

## 总结

自定义统计指标是Sentinel中一个非常强大的功能，它允许用户根据自身需求定义和收集特定的系统或业务指标。通过自定义统计指标，用户可以更好地监控和管理系统的流量和资源使用情况，从而提高系统的稳定性和可靠性。

## 附加资源

- [Sentinel官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Sentinel GitHub仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 尝试实现一个自定义的`Metric`，统计某个API的响应时间，并将其应用到Sentinel的规则中。
2. 思考并设计一个自定义统计指标，用于监控某个服务的资源使用情况。
