---
title: Sentinel 关联流控
description: 了解Sentinel中的关联流控功能，掌握如何通过关联资源实现更精细的流量控制策略。
---

# Sentinel 关联流控

Sentinel是阿里巴巴开源的一款轻量级流量控制组件，广泛应用于分布式系统中。关联流控（Associated Flow Control）是Sentinel提供的一种高级流量控制功能，它允许你根据某个资源的流量情况来控制另一个资源的流量。这种机制非常适合处理资源之间存在依赖关系的场景。

## 什么是关联流控？

关联流控的核心思想是：当一个资源的流量达到某个阈值时，触发对另一个资源的流量控制。例如，假设你有两个资源A和B，当资源A的QPS（每秒查询率）超过100时，限制资源B的流量。这种机制可以帮助你在复杂的系统中实现更精细的流量控制策略。

## 关联流控的工作原理

Sentinel通过`FlowRule`来定义流控规则。在关联流控中，你需要指定两个资源：**关联资源**和**被控资源**。当关联资源的流量达到设定的阈值时，Sentinel会对被控资源进行流量控制。

### 关键概念

- **关联资源（Associated Resource）**：触发流控的资源。
- **被控资源（Controlled Resource）**：被限制流量的资源。
- **阈值（Threshold）**：关联资源的流量达到该值时，触发对被控资源的流控。

## 代码示例

以下是一个简单的Java代码示例，展示如何使用Sentinel的关联流控功能。

```java
import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

import java.util.ArrayList;
import java.util.List;

public class AssociatedFlowControlDemo {

    public static void main(String[] args) {
        // 定义关联流控规则
        initFlowRules();

        // 模拟资源A的流量
        for (int i = 0; i < 150; i++) {
            try (Entry entry = SphU.entry("ResourceA")) {
                System.out.println("ResourceA accessed");
            } catch (BlockException e) {
                System.out.println("ResourceA blocked");
            }
        }

        // 模拟资源B的流量
        for (int i = 0; i < 50; i++) {
            try (Entry entry = SphU.entry("ResourceB")) {
                System.out.println("ResourceB accessed");
            } catch (BlockException e) {
                System.out.println("ResourceB blocked");
            }
        }
    }

    private static void initFlowRules() {
        List<FlowRule> rules = new ArrayList<>();

        // 定义资源A的流控规则
        FlowRule ruleA = new FlowRule();
        ruleA.setResource("ResourceA");
        ruleA.setGrade(RuleConstant.FLOW_GRADE_QPS);
        ruleA.setCount(100); // 设置QPS阈值为100
        rules.add(ruleA);

        // 定义资源B的关联流控规则
        FlowRule ruleB = new FlowRule();
        ruleB.setResource("ResourceB");
        ruleB.setGrade(RuleConstant.FLOW_GRADE_QPS);
        ruleB.setCount(50); // 设置QPS阈值为50
        ruleB.setRefResource("ResourceA"); // 关联资源A
        rules.add(ruleB);

        FlowRuleManager.loadRules(rules);
    }
}
```

### 输入与输出

- **输入**：资源A的QPS超过100。
- **输出**：资源B的流量被限制，QPS不超过50。

## 实际应用场景

### 场景1：数据库读写分离

假设你的系统中有两个数据库资源：**读数据库**和**写数据库**。当写数据库的流量过高时，可能会导致读数据库的性能下降。通过关联流控，你可以在写数据库的流量达到某个阈值时，限制读数据库的流量，从而保证系统的整体稳定性。

### 场景2：微服务调用链

在微服务架构中，服务A调用服务B，服务B又调用服务C。如果服务A的流量突然激增，可能会导致服务B和服务C的负载过高。通过关联流控，你可以在服务A的流量达到某个阈值时，限制服务B的流量，从而避免服务C的崩溃。

## 总结

Sentinel的关联流控功能为复杂的分布式系统提供了更精细的流量控制手段。通过关联资源，你可以根据一个资源的流量情况来控制另一个资源的流量，从而避免系统过载。在实际应用中，关联流控可以用于数据库读写分离、微服务调用链等场景，帮助你在高并发环境下保持系统的稳定性。

## 附加资源与练习

- **练习1**：尝试在本地环境中运行上述代码示例，并观察资源A和资源B的流量控制效果。
- **练习2**：设计一个微服务调用链的场景，使用关联流控来保护下游服务。

:::tip
如果你对Sentinel的其他高级功能感兴趣，可以继续学习**热点参数限流**和**系统自适应保护**等主题。
:::