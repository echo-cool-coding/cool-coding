---
title: Sentinel 系统防护案例
description: 本文将通过实际案例，详细介绍Sentinel系统的自适应保护机制，帮助初学者理解其工作原理和应用场景。
---

## 介绍

Sentinel是阿里巴巴开源的一款轻量级流量控制组件，广泛应用于微服务架构中，用于保护系统免受突发流量的冲击。Sentinel的自适应保护机制能够根据系统的实时状态动态调整流量控制策略，确保系统在高并发场景下的稳定性。

本文将结合实际案例，逐步讲解Sentinel的自适应保护机制，并通过代码示例展示其在实际应用中的效果。

## Sentinel 自适应保护机制

Sentinel的自适应保护机制主要包括以下几个核心概念：

1. **流量控制（Flow Control）**：通过设置QPS（每秒查询率）或线程数等指标，限制系统的流量。
2. **熔断降级（Circuit Breaking）**：当系统出现异常时，自动熔断服务，避免雪崩效应。
3. **系统自适应保护（System Adaptive Protection）**：根据系统的实时负载情况，动态调整流量控制策略。

### 流量控制

流量控制是Sentinel的核心功能之一。通过设置QPS或线程数，Sentinel可以限制系统的流量，防止系统过载。

```java
// 示例：设置QPS为10
FlowRule rule = new FlowRule();
rule.setResource("myResource");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(10);
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

在上述代码中，我们为资源`myResource`设置了QPS为10，即每秒最多允许10个请求通过。

### 熔断降级

熔断降级是Sentinel的另一个重要功能。当系统出现异常时，Sentinel会自动熔断服务，避免雪崩效应。

```java
// 示例：设置熔断规则
DegradeRule degradeRule = new DegradeRule();
degradeRule.setResource("myResource");
degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT);
degradeRule.setCount(5); // 当异常数达到5时，触发熔断
degradeRule.setTimeWindow(10); // 熔断持续10秒
DegradeRuleManager.loadRules(Collections.singletonList(degradeRule));
```

在上述代码中，我们为资源`myResource`设置了熔断规则，当异常数达到5时，触发熔断，持续10秒。

### 系统自适应保护

系统自适应保护是Sentinel的高级功能，能够根据系统的实时负载情况，动态调整流量控制策略。

```java
// 示例：启用系统自适应保护
SystemRule systemRule = new SystemRule();
systemRule.setHighestSystemLoad(2.0); // 当系统负载超过2.0时，触发保护
SystemRuleManager.loadRules(Collections.singletonList(systemRule));
```

在上述代码中，我们设置了系统负载阈值为2.0，当系统负载超过2.0时，Sentinel会自动触发保护机制，限制流量。

## 实际案例

### 案例背景

假设我们有一个电商系统，在双十一大促期间，系统面临巨大的流量压力。为了确保系统的稳定性，我们需要使用Sentinel的自适应保护机制来保护系统。

### 案例实现

1. **设置流量控制规则**：我们为商品详情页设置了QPS为1000，即每秒最多允许1000个请求通过。

```java
FlowRule rule = new FlowRule();
rule.setResource("productDetail");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(1000);
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

2. **设置熔断规则**：我们为商品详情页设置了熔断规则，当异常数达到50时，触发熔断，持续30秒。

```java
DegradeRule degradeRule = new DegradeRule();
degradeRule.setResource("productDetail");
degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT);
degradeRule.setCount(50);
degradeRule.setTimeWindow(30);
DegradeRuleManager.loadRules(Collections.singletonList(degradeRule));
```

3. **启用系统自适应保护**：我们设置了系统负载阈值为4.0，当系统负载超过4.0时，触发保护机制，限制流量。

```java
SystemRule systemRule = new SystemRule();
systemRule.setHighestSystemLoad(4.0);
SystemRuleManager.loadRules(Collections.singletonList(systemRule));
```

### 案例效果

在大促期间，系统流量激增，但由于我们设置了流量控制规则和熔断规则，系统能够稳定运行。当系统负载超过4.0时，Sentinel会自动触发保护机制，限制流量，确保系统不会崩溃。

## 总结

Sentinel的自适应保护机制能够有效保护系统免受突发流量的冲击，确保系统在高并发场景下的稳定性。通过流量控制、熔断降级和系统自适应保护，Sentinel能够动态调整流量控制策略，适应系统的实时状态。

在实际应用中，我们可以根据系统的具体需求，灵活配置Sentinel的规则，确保系统的稳定性和可靠性。

## 附加资源

- [Sentinel官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Sentinel GitHub仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 尝试在自己的项目中集成Sentinel，并设置流量控制规则。
2. 模拟高并发场景，观察Sentinel的保护效果。
3. 调整熔断规则，观察系统的响应情况。

:::tip
在实际应用中，建议根据系统的具体需求，灵活配置Sentinel的规则，确保系统的稳定性和可靠性。
:::