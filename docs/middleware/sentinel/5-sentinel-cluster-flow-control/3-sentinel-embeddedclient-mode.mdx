---
title: Sentinel EmbeddedClient 模式
description: 了解 Sentinel 的 EmbeddedClient 模式，掌握如何在应用程序中嵌入 Sentinel 客户端以实现细粒度的流量控制。
---

# Sentinel EmbeddedClient 模式

Sentinel 是阿里巴巴开源的一款轻量级流量控制组件，广泛应用于微服务架构中，用于实现限流、熔断、系统负载保护等功能。Sentinel 提供了多种集成模式，其中 **EmbeddedClient 模式** 是一种将 Sentinel 客户端直接嵌入到应用程序中的方式，适用于需要细粒度控制的场景。

## 什么是 EmbeddedClient 模式？

EmbeddedClient 模式是指将 Sentinel 的核心功能直接嵌入到应用程序中，而不是通过远程服务或代理进行流量控制。这种模式允许开发者在应用程序内部直接调用 Sentinel 的 API，实现更灵活的流量控制策略。

与传统的代理模式相比，EmbeddedClient 模式具有以下优势：
- **低延迟**：由于控制逻辑在本地执行，避免了网络通信的开销。
- **高灵活性**：开发者可以根据业务需求自定义流量控制规则。
- **易于集成**：无需额外的中间件或代理服务，直接嵌入到应用程序中。

## 如何使用 EmbeddedClient 模式？

### 1. 引入 Sentinel 依赖

首先，需要在项目中引入 Sentinel 的核心依赖。以 Maven 项目为例，添加以下依赖：

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-core</artifactId>
    <version>1.8.6</version>
</dependency>
```

### 2. 初始化 Sentinel

在应用程序启动时，初始化 Sentinel 的上下文。通常可以在 `main` 方法或 Spring Boot 的 `@PostConstruct` 方法中进行初始化。

```java
import com.alibaba.csp.sentinel.init.InitExecutor;

public class Application {
    public static void main(String[] args) {
        // 初始化 Sentinel
        InitExecutor.doInit();
        // 启动应用程序
        // ...
    }
}
```

### 3. 定义资源与规则

在 EmbeddedClient 模式下，开发者需要手动定义资源和流量控制规则。以下是一个简单的示例：

```java
import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

import java.util.Collections;

public class SentinelExample {
    public static void main(String[] args) {
        // 定义资源名称
        String resourceName = "myResource";

        // 定义流量控制规则
        FlowRule rule = new FlowRule();
        rule.setResource(resourceName);
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(10); // 每秒最多允许 10 个请求

        // 加载规则
        FlowRuleManager.loadRules(Collections.singletonList(rule));

        // 模拟请求
        for (int i = 0; i < 15; i++) {
            try (Entry entry = SphU.entry(resourceName)) {
                // 业务逻辑
                System.out.println("请求通过: " + i);
            } catch (BlockException e) {
                // 请求被限流
                System.out.println("请求被限流: " + i);
            }
        }
    }
}
```

### 4. 运行结果

运行上述代码后，输出如下：

```
请求通过: 0
请求通过: 1
...
请求通过: 9
请求被限流: 10
请求被限流: 11
...
```

可以看到，前 10 个请求正常通过，之后的请求被限流。

## 实际应用场景

EmbeddedClient 模式适用于以下场景：
- **高并发系统**：需要快速响应流量变化，避免因网络延迟导致的控制失效。
- **自定义规则**：业务逻辑复杂，需要根据特定条件动态调整流量控制规则。
- **资源隔离**：需要对不同资源进行独立的流量控制，避免资源之间的相互影响。

例如，在一个电商系统中，可以对商品详情页、购物车、订单提交等关键资源分别设置流量控制规则，确保在高并发情况下系统的稳定性。

## 总结

Sentinel 的 EmbeddedClient 模式为开发者提供了一种灵活、高效的流量控制方式。通过将 Sentinel 客户端直接嵌入到应用程序中，开发者可以实现细粒度的流量控制，提升系统的稳定性和可靠性。

### 附加资源
- [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Sentinel GitHub 仓库](https://github.com/alibaba/Sentinel)

### 练习
1. 尝试在 Spring Boot 项目中集成 Sentinel EmbeddedClient 模式。
2. 为不同的 API 接口设置不同的流量控制规则，并测试其效果。
3. 探索 Sentinel 的其他功能，如熔断降级、系统负载保护等。

:::tip
在实际生产环境中，建议结合监控系统（如 Prometheus）对 Sentinel 的流量控制效果进行实时监控和调整。
:::