---
title: Sentinel 集群规则配置
description: 了解如何在Sentinel中配置集群规则，以实现分布式系统的流量控制。
---

# Sentinel 集群规则配置

Sentinel是阿里巴巴开源的一款流量控制组件，广泛应用于分布式系统中。它不仅可以对单机进行流量控制，还支持集群模式下的流量控制。本文将详细介绍如何配置Sentinel的集群规则，帮助初学者掌握这一重要概念。

## 什么是Sentinel集群流控？

Sentinel集群流控是指在分布式系统中，多个节点共享流量控制规则，以实现全局的流量控制。与单机流控不同，集群流控需要协调多个节点的流量数据，确保整个系统的流量在可控范围内。

## 集群流控的基本概念

在Sentinel中，集群流控的核心概念包括：

- **Token Server**：负责管理集群中的令牌（Token），决定是否允许请求通过。
- **Token Client**：向Token Server请求令牌，根据返回结果决定是否继续处理请求。

## 配置集群规则

### 1. 启动Token Server

首先，我们需要启动一个Token Server。可以通过以下代码启动一个简单的Token Server：

```java
public class ClusterTokenServer {
    public static void main(String[] args) {
        ClusterServerConfigManager.loadServerNamespaceSet(Collections.singleton("AppName"));
        ClusterServerConfigManager.registerServerTransport(new DefaultClusterTransport());
        ClusterServerConfigManager.registerServerStateListener(new DefaultClusterServerStateListener());
        ClusterServerConfigManager.start();
    }
}
```

### 2. 配置Token Client

接下来，我们需要在客户端配置Token Client。以下是一个简单的配置示例：

```java
public class ClusterTokenClient {
    public static void main(String[] args) {
        ClusterClientConfigManager.loadClientNamespaceSet(Collections.singleton("AppName"));
        ClusterClientConfigManager.registerClientTransport(new DefaultClusterTransport());
        ClusterClientConfigManager.start();
    }
}
```

### 3. 定义集群规则

在Sentinel中，可以通过以下方式定义集群规则：

```java
FlowRule rule = new FlowRule();
rule.setResource("cluster-resource");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(100);
rule.setClusterMode(true);
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

### 4. 验证规则

为了验证集群规则是否生效，可以编写一个简单的测试用例：

```java
public class ClusterFlowTest {
    public static void main(String[] args) {
        for (int i = 0; i < 200; i++) {
            Entry entry = null;
            try {
                entry = SphU.entry("cluster-resource");
                // 处理请求
            } catch (BlockException e) {
                // 请求被拒绝
            } finally {
                if (entry != null) {
                    entry.exit();
                }
            }
        }
    }
}
```

## 实际应用场景

假设我们有一个电商系统，在高并发情况下，需要对某个关键接口进行流量控制。通过Sentinel集群流控，我们可以确保整个系统的流量在可控范围内，避免因流量过大导致系统崩溃。

## 总结

通过本文，我们了解了Sentinel集群流控的基本概念，并学习了如何配置集群规则。Sentinel的集群流控功能在分布式系统中非常重要，能够有效防止系统过载。

## 附加资源

- [Sentinel官方文档](https://sentinelguard.io/)
- [Sentinel GitHub仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 尝试在本地环境中启动一个Token Server和Token Client，并配置集群规则。
2. 编写一个简单的测试用例，验证集群规则是否生效。

:::tip
在实际生产环境中，建议使用高可用的Token Server，并确保Token Client与Token Server之间的通信稳定。
:::