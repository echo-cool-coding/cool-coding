---
title: Sentinel 与业务系统集成
description: 了解如何将Sentinel与业务系统集成，以实现流量控制、熔断降级等能力，提升系统的稳定性和可靠性。
---

## 介绍

Sentinel 是阿里巴巴开源的一款轻量级流量控制组件，主要用于实现流量控制、熔断降级、系统负载保护等功能。在实际业务场景中，Sentinel 可以与业务系统无缝集成，帮助开发者更好地管理系统的流量和资源，从而提升系统的稳定性和可靠性。

本文将详细介绍如何将 Sentinel 集成到业务系统中，并通过实际案例展示其应用场景。

## Sentinel 的核心概念

在开始集成之前，我们需要了解 Sentinel 的几个核心概念：

- **资源（Resource）**：Sentinel 中的资源可以是任何需要保护的代码块，例如一个方法、一个接口或一个服务。
- **规则（Rule）**：规则定义了资源的保护策略，例如流量控制规则、熔断规则等。
- **流量控制（Flow Control）**：通过限制资源的访问速率，防止系统被过多的请求压垮。
- **熔断降级（Circuit Breaking）**：当资源出现异常时，Sentinel 会自动熔断该资源，避免系统雪崩。

## Sentinel 与业务系统集成步骤

### 1. 引入 Sentinel 依赖

首先，我们需要在业务系统中引入 Sentinel 的依赖。以 Maven 项目为例，可以在 `pom.xml` 中添加以下依赖：

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-core</artifactId>
    <version>1.8.6</version>
</dependency>
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-annotation-aspectj</artifactId>
    <version>1.8.6</version>
</dependency>
```

### 2. 定义资源

在业务系统中，我们可以通过注解或代码的方式定义资源。以下是一个使用注解定义资源的示例：

```java
import com.alibaba.csp.sentinel.annotation.SentinelResource;

@Service
public class OrderService {

    @SentinelResource(value = "createOrder", blockHandler = "handleBlock")
    public String createOrder(String orderId) {
        // 业务逻辑
        return "Order created: " + orderId;
    }

    public String handleBlock(String orderId, BlockException ex) {
        // 处理流量控制或熔断降级
        return "Order creation blocked: " + orderId;
    }
}
```

在上面的代码中，`createOrder` 方法被定义为一个资源，`handleBlock` 方法用于处理流量控制或熔断降级时的逻辑。

### 3. 配置规则

接下来，我们需要为资源配置规则。以下是一个配置流量控制规则的示例：

```java
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

public class SentinelConfig {

    public static void initFlowRules() {
        FlowRule rule = new FlowRule();
        rule.setResource("createOrder");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(10); // 每秒最多允许 10 个请求
        FlowRuleManager.loadRules(Collections.singletonList(rule));
    }
}
```

在 `initFlowRules` 方法中，我们为 `createOrder` 资源配置了一个流量控制规则，限制每秒最多允许 10 个请求。

### 4. 启动 Sentinel

最后，我们需要在业务系统中启动 Sentinel。可以在应用的启动类中添加以下代码：

```java
import com.alibaba.csp.sentinel.init.InitExecutor;

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        InitExecutor.doInit(); // 初始化 Sentinel
        SpringApplication.run(Application.class, args);
    }
}
```

## 实际案例

假设我们有一个电商系统，其中有一个创建订单的接口。在高并发场景下，为了防止系统被过多的请求压垮，我们可以使用 Sentinel 对该接口进行流量控制。

### 场景描述

- **接口**：`POST /orders`
- **流量控制**：限制每秒最多允许 10 个请求
- **熔断降级**：当接口的异常率超过 50% 时，自动熔断该接口

### 实现步骤

1. 在 `OrderService` 中定义 `createOrder` 资源。
2. 配置流量控制规则，限制每秒最多允许 10 个请求。
3. 配置熔断降级规则，当异常率超过 50% 时，自动熔断该接口。

### 代码示例

```java
import com.alibaba.csp.sentinel.annotation.SentinelResource;
import com.alibaba.csp.sentinel.slots.block.BlockException;

@Service
public class OrderService {

    @SentinelResource(value = "createOrder", blockHandler = "handleBlock", fallback = "handleFallback")
    public String createOrder(String orderId) {
        // 模拟业务逻辑
        if (Math.random() > 0.5) {
            throw new RuntimeException("Order creation failed");
        }
        return "Order created: " + orderId;
    }

    public String handleBlock(String orderId, BlockException ex) {
        return "Order creation blocked: " + orderId;
    }

    public String handleFallback(String orderId, Throwable ex) {
        return "Order creation failed: " + orderId;
    }
}
```

### 规则配置

```java
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

public class SentinelConfig {

    public static void initRules() {
        // 流量控制规则
        FlowRule flowRule = new FlowRule();
        flowRule.setResource("createOrder");
        flowRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        flowRule.setCount(10);
        FlowRuleManager.loadRules(Collections.singletonList(flowRule));

        // 熔断降级规则
        DegradeRule degradeRule = new DegradeRule();
        degradeRule.setResource("createOrder");
        degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);
        degradeRule.setCount(0.5); // 异常率超过 50% 时熔断
        degradeRule.setTimeWindow(10); // 熔断时间窗口为 10 秒
        DegradeRuleManager.loadRules(Collections.singletonList(degradeRule));
    }
}
```

## 总结

通过本文的介绍，我们了解了如何将 Sentinel 与业务系统集成，以实现流量控制、熔断降级等功能。Sentinel 提供了丰富的 API 和注解，使得集成过程变得非常简单。在实际业务场景中，合理使用 Sentinel 可以显著提升系统的稳定性和可靠性。

## 附加资源

- [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Sentinel GitHub 仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 尝试在你的业务系统中集成 Sentinel，并配置一个流量控制规则。
2. 模拟高并发场景，观察 Sentinel 的流量控制效果。
3. 配置一个熔断降级规则，并测试其在不同异常率下的表现。
