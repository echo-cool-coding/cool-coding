---
title: Sentinel 自定义统计策略
description: 了解如何在Sentinel中实现自定义统计策略，以满足特定场景下的流量控制和监控需求。
---

# Sentinel 自定义统计策略

Sentinel是阿里巴巴开源的一款轻量级流量控制框架，广泛应用于微服务架构中。它通过定义规则（如流量控制、熔断降级等）来保护系统的稳定性。Sentinel默认提供了多种统计策略，但在某些场景下，默认策略可能无法满足需求。这时，我们可以通过自定义统计策略来实现更精细化的控制。

本文将详细介绍如何在Sentinel中实现自定义统计策略，并通过实际案例展示其应用场景。

## 什么是自定义统计策略？

Sentinel的统计策略用于计算资源的实时指标（如QPS、响应时间等），并根据这些指标决定是否触发流量控制或熔断降级。默认情况下，Sentinel提供了基于滑动窗口的统计策略，适用于大多数场景。然而，在某些特殊场景下，我们可能需要自定义统计策略，例如：

- 需要根据特定的业务指标（如用户等级、请求来源等）进行统计。
- 需要实现更复杂的统计逻辑，如加权平均、指数平滑等。

自定义统计策略允许我们根据业务需求，灵活地定义统计逻辑，并将其集成到Sentinel的规则管理中。

## 如何实现自定义统计策略？

### 1. 实现 `StatisticSlot` 接口

Sentinel的统计逻辑主要通过 `StatisticSlot` 实现。要自定义统计策略，我们需要实现 `StatisticSlot` 接口，并在其中定义自己的统计逻辑。

```java
public class CustomStatisticSlot implements StatisticSlot {
    @Override
    public void entry(Context context, ResourceWrapper resourceWrapper, Entry entry, int count, Object... args) throws BlockException {
        // 自定义统计逻辑
        // 例如：根据请求来源进行统计
        String source = context.getOrigin();
        if ("highPriority".equals(source)) {
            // 高优先级请求的特殊处理
        } else {
            // 普通请求的处理
        }

        // 调用默认的统计逻辑
        entry.pass(count, args);
    }

    @Override
    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {
        // 自定义退出逻辑
        entry.exit(count, args);
    }
}
```

### 2. 注册自定义统计策略

实现自定义统计策略后，我们需要将其注册到Sentinel的规则管理中。可以通过以下方式实现：

```java
StatisticSlotManager.registerStatisticSlot(new CustomStatisticSlot());
```

### 3. 配置规则

最后，我们需要在Sentinel的规则配置中启用自定义统计策略。可以通过以下方式配置：

```java
FlowRule rule = new FlowRule();
rule.setResource("myResource");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(100);
rule.setStatisticSlot("customStatisticSlot"); // 使用自定义统计策略
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

## 实际案例：根据用户等级进行流量控制

假设我们有一个电商系统，用户分为普通用户和VIP用户。我们希望VIP用户的请求不受流量限制，而普通用户的请求需要受到限制。可以通过自定义统计策略实现这一需求。

### 实现步骤

1. **定义用户等级**：在请求上下文中添加用户等级信息。
2. **自定义统计策略**：在 `CustomStatisticSlot` 中根据用户等级进行统计。
3. **配置规则**：在Sentinel中配置流量控制规则，并启用自定义统计策略。

```java
public class CustomStatisticSlot implements StatisticSlot {
    @Override
    public void entry(Context context, ResourceWrapper resourceWrapper, Entry entry, int count, Object... args) throws BlockException {
        String userLevel = context.getOrigin();
        if ("VIP".equals(userLevel)) {
            // VIP用户不受限
            entry.pass(count, args);
        } else {
            // 普通用户受限
            if (currentQPS > 100) {
                throw new FlowException("普通用户请求过多");
            }
            entry.pass(count, args);
        }
    }

    @Override
    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {
        entry.exit(count, args);
    }
}
```

### 配置规则

```java
FlowRule rule = new FlowRule();
rule.setResource("orderResource");
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setCount(100);
rule.setStatisticSlot("customStatisticSlot"); // 使用自定义统计策略
FlowRuleManager.loadRules(Collections.singletonList(rule));
```

## 总结

通过自定义统计策略，我们可以根据业务需求灵活地定义Sentinel的统计逻辑，从而实现更精细化的流量控制和监控。本文介绍了如何实现自定义统计策略，并通过实际案例展示了其应用场景。

:::tip 提示
在实际应用中，建议先使用Sentinel的默认统计策略，只有在默认策略无法满足需求时，才考虑自定义统计策略。
:::

## 附加资源

- [Sentinel官方文档](https://sentinelguard.io/)
- [Sentinel GitHub仓库](https://github.com/alibaba/Sentinel)

## 练习

1. 尝试实现一个自定义统计策略，根据请求的响应时间进行流量控制。
2. 在Sentinel中配置规则，并测试自定义统计策略的效果。
