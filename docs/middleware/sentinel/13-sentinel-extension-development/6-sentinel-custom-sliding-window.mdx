---
title: Sentinel 自定义滑动窗口
description: 了解如何在Sentinel中自定义滑动窗口，掌握其工作原理及实际应用场景。
---

# Sentinel 自定义滑动窗口

Sentinel是阿里巴巴开源的一款流量控制组件，广泛应用于微服务架构中。滑动窗口是Sentinel实现流量统计和限流的核心机制之一。本文将详细介绍如何自定义滑动窗口，并通过实际案例帮助初学者理解其工作原理和应用场景。

## 什么是滑动窗口？

滑动窗口是一种用于统计时间窗口内数据的技术。它将时间划分为多个小窗口（称为“桶”），每个桶记录一段时间内的数据。随着时间的推移，窗口会滑动，丢弃旧的数据并添加新的数据。这种机制使得滑动窗口能够实时反映系统的流量情况。

在Sentinel中，滑动窗口用于统计请求量、异常数等指标，从而为限流、熔断等策略提供数据支持。

## 自定义滑动窗口的基本概念

在Sentinel中，滑动窗口的核心是`Window`和`Bucket`。每个`Window`由多个`Bucket`组成，每个`Bucket`记录一段时间内的数据。通过自定义滑动窗口，我们可以根据业务需求调整窗口的大小、桶的数量等参数。

### 关键参数

- **窗口大小（Window Length）**：滑动窗口的总时间长度，例如1秒、10秒等。
- **桶数量（Bucket Count）**：窗口内包含的桶数量。桶数量越多，统计的粒度越细。
- **桶大小（Bucket Length）**：每个桶的时间长度，通常为窗口大小除以桶数量。

## 自定义滑动窗口的实现

下面我们通过一个简单的代码示例，展示如何在Sentinel中自定义滑动窗口。

### 1. 创建自定义滑动窗口

首先，我们需要创建一个自定义的滑动窗口类，继承自`LeapArray`。`LeapArray`是Sentinel中滑动窗口的核心实现类。

```java
import com.alibaba.csp.sentinel.slots.statistic.base.LeapArray;
import com.alibaba.csp.sentinel.slots.statistic.base.WindowWrap;
import com.alibaba.csp.sentinel.slots.statistic.data.MetricBucket;

public class CustomLeapArray extends LeapArray<MetricBucket> {

    public CustomLeapArray(int windowLength, int bucketCount) {
        super(windowLength, bucketCount);
    }

    @Override
    public MetricBucket newEmptyBucket(long timeMillis) {
        return new MetricBucket();
    }

    @Override
    protected WindowWrap<MetricBucket> resetWindowTo(WindowWrap<MetricBucket> windowWrap, long startTime) {
        windowWrap.resetTo(startTime);
        windowWrap.value().reset();
        return windowWrap;
    }
}
```

### 2. 使用自定义滑动窗口

接下来，我们可以在Sentinel的规则中使用自定义的滑动窗口。

```java
import com.alibaba.csp.sentinel.slots.statistic.Metric;
import com.alibaba.csp.sentinel.slots.statistic.base.WindowWrap;

public class CustomMetric extends Metric {

    public CustomMetric(int windowLength, int bucketCount) {
        super(new CustomLeapArray(windowLength, bucketCount));
    }

    @Override
    public long success() {
        // 自定义成功请求的统计逻辑
        return super.success();
    }

    @Override
    public long exception() {
        // 自定义异常请求的统计逻辑
        return super.exception();
    }
}
```

### 3. 测试自定义滑动窗口

最后，我们可以编写一个简单的测试用例，验证自定义滑动窗口的效果。

```java
public class CustomMetricTest {

    public static void main(String[] args) throws InterruptedException {
        CustomMetric metric = new CustomMetric(1000, 10);

        for (int i = 0; i < 100; i++) {
            metric.addSuccess(1);
            Thread.sleep(100);
        }

        System.out.println("Success count: " + metric.success());
    }
}
```

运行上述代码，可以看到输出结果反映了在1秒窗口内成功请求的数量。

## 实际应用场景

自定义滑动窗口在实际应用中有广泛的用途，例如：

1. **精细化流量控制**：通过调整窗口大小和桶数量，可以实现更精细的流量控制策略。
2. **异常检测**：通过自定义滑动窗口，可以实时统计异常请求的数量，从而触发熔断机制。
3. **动态调整**：根据系统负载动态调整滑动窗口的参数，以适应不同的流量模式。

## 总结

通过本文的学习，我们了解了Sentinel中滑动窗口的基本概念，并掌握了如何自定义滑动窗口。滑动窗口是Sentinel实现流量控制的核心机制之一，通过自定义滑动窗口，我们可以根据业务需求灵活调整统计策略。

## 附加资源与练习

- **练习**：尝试修改滑动窗口的大小和桶数量，观察统计结果的变化。
- **深入阅读**：阅读Sentinel官方文档，了解更多关于滑动窗口的实现细节。
- **扩展练习**：结合Sentinel的其他功能（如熔断、降级），实现一个完整的流量控制方案。

:::tip
在实际项目中，建议根据业务需求合理设置滑动窗口的参数，以达到最佳的流量控制效果。
:::