---
title: Sentinel 与WebFlux集成
description: 了解如何将Sentinel与Spring WebFlux集成，以实现响应式编程中的流量控制、熔断和降级功能。
---

# Sentinel 与WebFlux集成

在现代微服务架构中，响应式编程（Reactive Programming）变得越来越流行。Spring WebFlux 是 Spring 框架提供的响应式编程模型，而 [Sentinel](https://sentinelguard.io/) 是阿里巴巴开源的流量控制、熔断和降级框架。将 Sentinel 与 WebFlux 集成，可以帮助我们在响应式应用中实现高效的流量管理和系统保护。

本文将逐步介绍如何将 Sentinel 集成到 Spring WebFlux 中，并通过实际案例展示其应用场景。

## 什么是 Sentinel 和 WebFlux？

### Sentinel
Sentinel 是一个面向分布式服务架构的轻量级流量控制框架，主要用于流量控制、熔断降级、系统负载保护等场景。它支持多种规则配置，如 QPS 限流、线程数限流、熔断降级等。

### WebFlux
WebFlux 是 Spring 5 引入的响应式编程框架，基于 Reactor 库实现。它支持非阻塞的异步编程模型，适用于高并发、低延迟的场景。

## 为什么需要将 Sentinel 与 WebFlux 集成？

在响应式编程中，传统的阻塞式流量控制工具（如 Hystrix）可能无法很好地适应非阻塞的编程模型。Sentinel 提供了对响应式编程的支持，能够与 WebFlux 无缝集成，确保在高并发场景下系统的稳定性和可靠性。

## 集成步骤

### 1. 添加依赖
首先，在 `pom.xml` 中添加 Sentinel 和 WebFlux 的依赖：

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-core</artifactId>
    <version>1.8.6</version>
</dependency>
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-spring-webflux-adapter</artifactId>
    <version>1.8.6</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

### 2. 配置 Sentinel
在 `application.properties` 中配置 Sentinel 的基本参数：

```properties
# 启用 Sentinel
spring.cloud.sentinel.enabled=true
# Sentinel 控制台地址（可选）
spring.cloud.sentinel.transport.dashboard=localhost:8080
```

### 3. 定义资源规则
Sentinel 通过定义资源规则来实现流量控制。以下是一个简单的示例，定义一个名为 `myResource` 的资源，并设置 QPS 限流规则：

```java
import com.alibaba.csp.sentinel.annotation.SentinelResource;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

@RestController
public class MyController {

    @GetMapping("/hello")
    @SentinelResource(value = "myResource", blockHandler = "handleBlock")
    public Mono<String> hello() {
        return Mono.just("Hello, WebFlux!");
    }

    public Mono<String> handleBlock(BlockException ex) {
        return Mono.just("Blocked by Sentinel");
    }
}
```

### 4. 配置限流规则
在 Sentinel 控制台或代码中配置限流规则。以下是通过代码配置的示例：

```java
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;
import org.springframework.context.annotation.Configuration;

import javax.annotation.PostConstruct;
import java.util.ArrayList;
import java.util.List;

@Configuration
public class SentinelConfig {

    @PostConstruct
    public void initRules() {
        List<FlowRule> rules = new ArrayList<>();
        FlowRule rule = new FlowRule();
        rule.setResource("myResource");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(10); // 每秒最多允许 10 个请求
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
    }
}
```

### 5. 测试限流
启动应用并访问 `/hello` 接口。当 QPS 超过 10 时，Sentinel 将触发限流，返回 `Blocked by Sentinel`。

## 实际应用场景

### 场景 1：API 限流
在高并发的 API 服务中，可以通过 Sentinel 对关键 API 进行限流，防止系统过载。例如，对 `/user/info` 接口设置 QPS 限流，确保每个用户每秒只能访问一次。

### 场景 2：熔断降级
当某个依赖服务不可用时，Sentinel 可以自动熔断该服务的调用，并返回降级结果。例如，当调用外部支付服务失败时，返回默认的支付结果，避免影响用户体验。

## 总结

通过将 Sentinel 与 WebFlux 集成，我们可以在响应式编程中实现高效的流量控制和系统保护。本文介绍了集成的基本步骤，并通过实际案例展示了其应用场景。希望本文能帮助你更好地理解和使用 Sentinel 与 WebFlux。

## 附加资源与练习

- [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/introduction.html)
- [Spring WebFlux 官方文档](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html)

:::tip 练习
1. 尝试在本地搭建一个 Spring WebFlux 项目，并集成 Sentinel。
2. 配置不同的限流规则（如线程数限流、熔断降级），并测试其效果。
3. 探索 Sentinel 的其他功能，如热点参数限流、系统自适应保护等。
:::