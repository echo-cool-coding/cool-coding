---
title: Sentinel 与Servlet集成
description: 了解如何将Sentinel与Servlet集成，以实现流量控制、熔断降级等微服务治理功能。本文适合初学者，包含代码示例和实际应用场景。
---

# Sentinel 与Servlet集成

在现代微服务架构中，流量控制和熔断降级是确保系统稳定性和高可用性的关键功能。Sentinel 是阿里巴巴开源的一款轻量级流量控制框架，能够帮助开发者实现这些功能。本文将介绍如何将 Sentinel 与 Servlet 集成，以便在基于 Servlet 的 Web 应用中实现流量控制。

## 什么是 Sentinel？

Sentinel 是一个面向分布式服务架构的流量控制组件，主要用于流量控制、熔断降级、系统负载保护等场景。它支持多种框架的集成，包括 Spring Cloud、Dubbo 和 Servlet 等。

## 为什么需要与 Servlet 集成？

Servlet 是 Java Web 应用的基础组件，许多 Web 框架（如 Spring MVC）都是基于 Servlet 构建的。通过将 Sentinel 与 Servlet 集成，我们可以在 Web 层实现流量控制，从而保护后端服务不被过载。

## 集成步骤

### 1. 添加依赖

首先，我们需要在项目中添加 Sentinel 的依赖。如果你使用的是 Maven，可以在 `pom.xml` 中添加以下依赖：

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-core</artifactId>
    <version>1.8.6</version>
</dependency>
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-web-servlet</artifactId>
    <version>1.8.6</version>
</dependency>
```

### 2. 配置 Sentinel Filter

Sentinel 提供了一个 `CommonFilter`，用于拦截 Servlet 请求并进行流量控制。我们需要在 `web.xml` 中配置这个过滤器：

```xml
<filter>
    <filter-name>SentinelFilter</filter-name>
    <filter-class>com.alibaba.csp.sentinel.adapter.servlet.CommonFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>SentinelFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

### 3. 定义流量控制规则

接下来，我们需要定义流量控制规则。Sentinel 提供了多种规则类型，包括流量控制规则、熔断规则等。以下是一个简单的流量控制规则示例：

```java
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

public class SentinelConfig {
    public static void initFlowRules() {
        FlowRule rule = new FlowRule();
        rule.setResource("GET:/hello");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(10); // 每秒最多允许 10 个请求
        FlowRuleManager.loadRules(Collections.singletonList(rule));
    }
}
```

在应用启动时调用 `SentinelConfig.initFlowRules()` 方法即可加载规则。

### 4. 处理被限流的请求

当请求被限流时，Sentinel 会抛出 `BlockException` 异常。我们可以通过自定义异常处理逻辑来返回友好的错误信息。以下是一个简单的异常处理示例：

```java
import com.alibaba.csp.sentinel.slots.block.BlockException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class SentinelExceptionHandler {
    public static void handleBlockException(HttpServletRequest request, HttpServletResponse response, BlockException ex) throws IOException {
        response.setStatus(429); // 429 Too Many Requests
        response.getWriter().write("Too many requests, please try again later.");
    }
}
```

### 5. 测试集成效果

启动应用后，访问 `/hello` 路径，如果请求频率超过设定的阈值（每秒 10 次），Sentinel 将会触发限流，并返回 `429` 状态码。

## 实际应用场景

假设我们有一个电商网站，其中有一个商品详情页面。在高并发场景下，商品详情页的访问量可能会激增，导致后端服务压力过大。通过将 Sentinel 与 Servlet 集成，我们可以对商品详情页的访问进行流量控制，从而保护后端服务不被过载。

## 总结

通过本文的介绍，我们了解了如何将 Sentinel 与 Servlet 集成，以实现流量控制功能。Sentinel 提供了简单易用的 API 和丰富的规则配置，能够帮助我们在 Web 层实现高效的流量控制。

## 附加资源

- [Sentinel 官方文档](https://sentinelguard.io/)
- [Servlet 官方文档](https://javaee.github.io/servlet-spec/)

## 练习

1. 尝试在现有的 Servlet 项目中集成 Sentinel，并配置不同的流量控制规则。
2. 模拟高并发场景，观察 Sentinel 的限流效果。
3. 自定义限流后的返回信息，使其更符合业务需求。
