---
title: 51单片机SD卡接口
description: 了解如何在51单片机中实现SD卡接口，掌握SD卡的基本读写操作，并通过实际案例展示其应用场景。
---

# 51单片机SD卡接口

## 介绍

SD卡（Secure Digital Card）是一种常见的存储设备，广泛应用于嵌入式系统中。51单片机作为一种经典的微控制器，可以通过SPI（Serial Peripheral Interface）协议与SD卡进行通信。本文将详细介绍如何在51单片机中实现SD卡接口，并通过代码示例和实际案例帮助初学者掌握这一技术。

## SD卡接口基础

### SPI协议简介

SPI是一种同步串行通信协议，通常用于微控制器与外围设备之间的通信。SPI协议使用四根线进行通信：

- **SCK（Serial Clock）**：时钟信号，由主设备（51单片机）产生。
- **MOSI（Master Out Slave In）**：主设备发送数据，从设备接收数据。
- **MISO（Master In Slave Out）**：从设备发送数据，主设备接收数据。
- **SS（Slave Select）**：从设备选择信号，低电平有效。

### SD卡的SPI模式

SD卡支持SPI模式，可以通过SPI协议与51单片机进行通信。在SPI模式下，SD卡的引脚功能如下：

- **DI（Data In）**：对应MOSI，用于接收数据。
- **DO（Data Out）**：对应MISO，用于发送数据。
- **SCLK（Serial Clock）**：对应SCK，用于同步数据传输。
- **CS（Chip Select）**：对应SS，用于选择SD卡。

## 51单片机与SD卡的连接

### 硬件连接

在51单片机与SD卡之间建立SPI连接时，需要将相应的引脚连接起来。以下是典型的连接方式：

- **51单片机的P1.0** -> **SD卡的CS**
- **51单片机的P1.1** -> **SD卡的DI（MOSI）**
- **51单片机的P1.2** -> **SD卡的DO（MISO）**
- **51单片机的P1.3** -> **SD卡的SCLK**

### 初始化SD卡

在使用SD卡之前，需要对其进行初始化。初始化过程包括发送CMD0命令使SD卡进入SPI模式，以及发送CMD8命令检查SD卡的版本。

```c
#include <reg51.h>

#define SD_CS P1_0
#define SD_MOSI P1_1
#define SD_MISO P1_2
#define SD_SCLK P1_3

void SPI_Init() {
    SD_CS = 1;  // 初始化时CS为高电平
    SD_SCLK = 0;  // 初始化时钟为低电平
}

unsigned char SPI_Transfer(unsigned char data) {
    unsigned char i;
    for (i = 0; i < 8; i++) {
        SD_MOSI = (data & 0x80) ? 1 : 0;  // 发送最高位
        data <<= 1;
        SD_SCLK = 1;  // 上升沿发送数据
        SD_SCLK = 0;
        data |= SD_MISO;  // 接收数据
    }
    return data;
}

void SD_Init() {
    SPI_Init();
    SD_CS = 0;  // 选择SD卡
    SPI_Transfer(0x40);  // 发送CMD0
    SD_CS = 1;  // 释放SD卡
}
```

## SD卡读写操作

### 读取数据块

要从SD卡中读取数据块，可以使用CMD17命令。以下是一个简单的读取数据块的示例：

```c
unsigned char SD_ReadBlock(unsigned long blockAddr, unsigned char *buffer) {
    SD_CS = 0;
    SPI_Transfer(0x51);  // 发送CMD17
    SPI_Transfer((blockAddr >> 24) & 0xFF);
    SPI_Transfer((blockAddr >> 16) & 0xFF);
    SPI_Transfer((blockAddr >> 8) & 0xFF);
    SPI_Transfer(blockAddr & 0xFF);
    SPI_Transfer(0xFF);  // CRC校验

    while (SPI_Transfer(0xFF) != 0xFE);  // 等待数据开始标志

    for (int i = 0; i < 512; i++) {
        buffer[i] = SPI_Transfer(0xFF);  // 读取512字节数据
    }

    SD_CS = 1;
    return 1;  // 读取成功
}
```

### 写入数据块

要向SD卡中写入数据块，可以使用CMD24命令。以下是一个简单的写入数据块的示例：

```c
unsigned char SD_WriteBlock(unsigned long blockAddr, unsigned char *buffer) {
    SD_CS = 0;
    SPI_Transfer(0x58);  // 发送CMD24
    SPI_Transfer((blockAddr >> 24) & 0xFF);
    SPI_Transfer((blockAddr >> 16) & 0xFF);
    SPI_Transfer((blockAddr >> 8) & 0xFF);
    SPI_Transfer(blockAddr & 0xFF);
    SPI_Transfer(0xFF);  // CRC校验

    SPI_Transfer(0xFE);  // 数据开始标志

    for (int i = 0; i < 512; i++) {
        SPI_Transfer(buffer[i]);  // 写入512字节数据
    }

    SD_CS = 1;
    return 1;  // 写入成功
}
```

## 实际应用案例

### 数据记录器

假设我们需要设计一个简单的数据记录器，将传感器数据存储在SD卡中。以下是一个简单的实现：

```c
void DataLogger() {
    unsigned char buffer[512];
    unsigned long blockAddr = 0;

    while (1) {
        // 读取传感器数据并存储在buffer中
        // ...

        SD_WriteBlock(blockAddr, buffer);  // 将数据写入SD卡
        blockAddr++;  // 移动到下一个数据块
    }
}
```

## 总结

通过本文，我们学习了如何在51单片机中实现SD卡接口，掌握了SD卡的基本读写操作，并通过实际案例展示了其应用场景。希望这些内容能够帮助初学者更好地理解和应用SD卡接口技术。

## 附加资源与练习

- **练习1**：尝试修改代码，使其能够读取SD卡的容量信息。
- **练习2**：设计一个简单的文件系统，将数据以文件的形式存储在SD卡中。
- **附加资源**：参考SD卡规范文档，了解更多关于SD卡的详细信息。

:::tip
在实际项目中，建议使用现成的SD卡库来简化开发过程，并确保代码的稳定性和可维护性。
:::