---
title: STM32 FreeRTOS任务
description: 了解如何在STM32微控制器上使用FreeRTOS创建和管理任务。本文将从基础概念入手，逐步讲解任务的创建、调度和实际应用。
---

## 介绍

FreeRTOS 是一个流行的实时操作系统（RTOS），广泛应用于嵌入式系统中。STM32 微控制器与 FreeRTOS 的结合，使得开发者能够轻松实现多任务处理、任务调度和资源管理。本文将详细介绍如何在 STM32 上使用 FreeRTOS 创建和管理任务。

### 什么是任务？

在 FreeRTOS 中，**任务**是一个独立的执行单元，类似于传统操作系统中的线程。每个任务都有自己的堆栈空间，并且可以独立运行。FreeRTOS 调度器负责管理这些任务的执行顺序，确保它们按照优先级和时间片进行调度。

## 创建任务

在 FreeRTOS 中，任务是通过 `xTaskCreate` 函数创建的。以下是一个简单的任务创建示例：

```c
#include "FreeRTOS.h"
#include "task.h"

void vTaskFunction(void *pvParameters)
{
    for (;;)
    {
        // 任务代码
        vTaskDelay(pdMS_TO_TICKS(1000)); // 延时1秒
    }
}

int main(void)
{
    xTaskCreate(vTaskFunction, "Task1", configMINIMAL_STACK_SIZE, NULL, 1, NULL);
    vTaskStartScheduler(); // 启动调度器

    for (;;)
    {
        // 主循环
    }
}
```

### 代码解释

- `vTaskFunction` 是任务的入口函数，任务将在这个函数中无限循环执行。
- `xTaskCreate` 用于创建任务，参数依次为任务函数、任务名称、堆栈大小、任务参数、优先级和任务句柄。
- `vTaskDelay` 用于延时，`pdMS_TO_TICKS(1000)` 表示延时 1000 毫秒（1 秒）。
- `vTaskStartScheduler` 启动 FreeRTOS 调度器，开始执行任务。

## 任务调度

FreeRTOS 使用优先级调度算法。每个任务都有一个优先级，优先级高的任务会优先执行。如果有多个任务具有相同的优先级，FreeRTOS 会使用时间片轮转调度算法，确保每个任务都能公平地获得 CPU 时间。

### 优先级示例

```c
xTaskCreate(vTaskFunction, "Task1", configMINIMAL_STACK_SIZE, NULL, 2, NULL);
xTaskCreate(vTaskFunction, "Task2", configMINIMAL_STACK_SIZE, NULL, 1, NULL);
```

在这个示例中，`Task1` 的优先级为 2，`Task2` 的优先级为 1。因此，`Task1` 会优先于 `Task2` 执行。

## 任务通信

在实际应用中，任务之间通常需要通信。FreeRTOS 提供了多种通信机制，如队列、信号量和事件组。

### 队列示例

```c
QueueHandle_t xQueue = xQueueCreate(10, sizeof(int)); // 创建队列

void vSenderTask(void *pvParameters)
{
    int iValueToSend = 0;
    for (;;)
    {
        xQueueSend(xQueue, &iValueToSend, portMAX_DELAY); // 发送数据
        iValueToSend++;
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}

void vReceiverTask(void *pvParameters)
{
    int iReceivedValue;
    for (;;)
    {
        if (xQueueReceive(xQueue, &iReceivedValue, portMAX_DELAY) == pdPASS)
        {
            // 处理接收到的数据
        }
    }
}
```

在这个示例中，`vSenderTask` 每隔 1 秒向队列发送一个整数，`vReceiverTask` 从队列中接收并处理数据。

## 实际应用案例

假设我们正在开发一个智能家居系统，需要同时控制多个设备（如灯光、温度传感器和门锁）。我们可以为每个设备创建一个任务：

```c
xTaskCreate(vLightControlTask, "LightControl", configMINIMAL_STACK_SIZE, NULL, 1, NULL);
xTaskCreate(vTemperatureSensorTask, "TempSensor", configMINIMAL_STACK_SIZE, NULL, 1, NULL);
xTaskCreate(vDoorLockTask, "DoorLock", configMINIMAL_STACK_SIZE, NULL, 1, NULL);
```

每个任务独立运行，通过 FreeRTOS 的调度器进行管理，确保系统的高效运行。

## 总结

本文介绍了如何在 STM32 上使用 FreeRTOS 创建和管理任务。我们从任务的基本概念入手，逐步讲解了任务的创建、调度和通信。通过实际应用案例，展示了 FreeRTOS 在嵌入式系统中的强大功能。

:::tip
建议初学者在掌握基本任务管理后，进一步学习 FreeRTOS 的其他功能，如信号量、互斥量和事件组，以构建更复杂的嵌入式系统。
:::

## 附加资源

- [FreeRTOS 官方文档](https://www.freertos.org/Documentation/RTOS_book.html)
- [STM32CubeMX 配置 FreeRTOS 教程](https://www.st.com/resource/en/user_manual/dm00104712-stm32cubemx-for-stm32-configuration-and-initialization-c-code-generation-stmicroelectronics.pdf)

## 练习

1. 创建一个任务，每隔 500 毫秒打印一次 "Hello, FreeRTOS!"。
2. 创建两个任务，一个任务每隔 1 秒发送一个整数到队列，另一个任务从队列中接收并打印该整数。
3. 尝试调整任务的优先级，观察任务调度的变化。

通过以上练习，您将更好地理解 FreeRTOS 任务的管理和调度机制。