---
title: STM32 FreeRTOS调度
description: 了解如何在STM32微控制器上使用FreeRTOS进行任务调度。本文将从基础概念入手，逐步讲解FreeRTOS的任务调度机制，并提供实际代码示例和应用场景。
---

# STM32 FreeRTOS调度

## 介绍

FreeRTOS 是一个广泛使用的实时操作系统（RTOS），专为嵌入式系统设计。它提供了任务调度、内存管理、任务间通信等功能，特别适合资源受限的微控制器，如STM32系列。本文将重点介绍FreeRTOS的任务调度机制，帮助初学者理解如何在STM32上使用FreeRTOS进行任务管理。

## 什么是任务调度？

任务调度是操作系统的核心功能之一，它决定了哪个任务在何时运行。FreeRTOS使用优先级调度算法，即高优先级的任务会抢占低优先级的任务。此外，FreeRTOS还支持时间片轮转调度，允许相同优先级的任务轮流执行。

## FreeRTOS任务调度机制

### 任务优先级

在FreeRTOS中，每个任务都有一个优先级，优先级范围从0（最低）到`configMAX_PRIORITIES-1`（最高）。调度器总是选择优先级最高的就绪任务来运行。如果有多个任务具有相同的优先级，调度器会使用时间片轮转调度。

### 任务状态

FreeRTOS中的任务可以处于以下几种状态之一：

- **运行态（Running）**：任务正在执行。
- **就绪态（Ready）**：任务已准备好运行，但当前未被调度。
- **阻塞态（Blocked）**：任务正在等待某个事件（如信号量、队列等）。
- **挂起态（Suspended）**：任务被显式挂起，不会被调度。

### 调度器

FreeRTOS的调度器负责管理任务的状态转换和任务切换。调度器可以在以下情况下触发任务切换：

- 任务主动放弃CPU（如调用`vTaskDelay()`）。
- 任务被更高优先级的任务抢占。
- 任务从阻塞态变为就绪态。

## 代码示例

以下是一个简单的FreeRTOS任务创建和调度的示例代码：

```c
#include "FreeRTOS.h"
#include "task.h"

void vTask1(void *pvParameters) {
    while (1) {
        // 任务1的代码
        vTaskDelay(1000 / portTICK_PERIOD_MS);  // 延迟1秒
    }
}

void vTask2(void *pvParameters) {
    while (1) {
        // 任务2的代码
        vTaskDelay(500 / portTICK_PERIOD_MS);  // 延迟0.5秒
    }
}

int main(void) {
    // 创建任务1
    xTaskCreate(vTask1, "Task 1", configMINIMAL_STACK_SIZE, NULL, 1, NULL);

    // 创建任务2
    xTaskCreate(vTask2, "Task 2", configMINIMAL_STACK_SIZE, NULL, 2, NULL);

    // 启动调度器
    vTaskStartScheduler();

    // 调度器启动后，程序不会执行到这里
    while (1);
}
```

在这个示例中，`vTask1`和`vTask2`是两个任务，分别以1秒和0.5秒的间隔运行。`vTask2`的优先级高于`vTask1`，因此`vTask2`会抢占`vTask1`。

## 实际应用场景

### 多任务并发处理

在嵌入式系统中，通常需要同时处理多个任务。例如，一个智能家居设备可能需要同时处理传感器数据采集、网络通信和用户界面更新。使用FreeRTOS的任务调度功能，可以轻松实现这些任务的并发执行。

### 实时控制

在实时控制系统中，任务的响应时间至关重要。FreeRTOS的优先级调度机制可以确保高优先级的任务（如电机控制）能够及时响应，而低优先级的任务（如日志记录）则可以在系统空闲时执行。

## 总结

FreeRTOS的任务调度机制为STM32微控制器提供了强大的多任务处理能力。通过合理设置任务优先级和使用调度器，开发者可以轻松实现复杂的嵌入式应用。本文介绍了FreeRTOS的任务调度基础，并提供了代码示例和实际应用场景，帮助初学者快速上手。

## 附加资源

- [FreeRTOS官方文档](https://www.freertos.org/Documentation/RTOS_book.html)
- [STM32CubeMX FreeRTOS配置指南](https://www.st.com/resource/en/user_manual/dm00105259.pdf)
- [FreeRTOS任务调度器源码分析](https://www.freertos.org/implementation/a00005.html)

## 练习

1. 修改上述代码示例，使`vTask1`和`vTask2`具有相同的优先级，观察任务调度的变化。
2. 创建一个新的任务`vTask3`，优先级为3，并在其中实现LED闪烁功能。
3. 使用FreeRTOS的信号量或队列功能，实现两个任务之间的通信。

通过以上练习，您将更深入地理解FreeRTOS的任务调度机制。