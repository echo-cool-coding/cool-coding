---
title: STM32 CAN 基础
description: 了解 STM32 微控制器中的 CAN（控制器局域网）通信协议的基础知识，包括工作原理、配置方法和实际应用。
---

## 介绍

CAN（Controller Area Network，控制器局域网）是一种广泛应用于汽车、工业自动化和嵌入式系统中的串行通信协议。它以其高可靠性、实时性和抗干扰能力而闻名。STM32 微控制器集成了强大的 CAN 外设，使其成为实现 CAN 通信的理想选择。

本文将带您了解 STM32 CAN 的基础知识，包括其工作原理、配置方法以及实际应用场景。

## CAN 通信的基本概念

### 什么是 CAN？

CAN 是一种多主机的串行通信协议，允许多个设备在同一总线上进行通信。它使用差分信号传输数据，具有较高的抗干扰能力。CAN 协议的主要特点包括：

- **多主机架构**：任何设备都可以主动发送数据。
- **消息优先级**：通过标识符（ID）确定消息的优先级。
- **错误检测与处理**：内置错误检测机制，确保通信的可靠性。

### CAN 帧结构

CAN 通信的基本单位是帧（Frame）。一个 CAN 帧由以下部分组成：

1. **标识符（ID）**：用于标识消息的优先级和内容。
2. **控制字段**：包含数据长度代码（DLC）等信息。
3. **数据字段**：实际传输的数据，最多 8 字节。
4. **CRC 字段**：用于错误检测的循环冗余校验码。
5. **ACK 字段**：确认接收的应答位。

```mermaid
graph LR
    A[标识符 ID] --> B[控制字段]
    B --> C[数据字段]
    C --> D[CRC 字段]
    D --> E[ACK 字段]
```

## STM32 CAN 外设的配置

### 硬件连接

在使用 STM32 的 CAN 外设之前，需要正确连接硬件。CAN 总线通常由两根线组成：CAN_H 和 CAN_L。STM32 的 CAN 外设通过 CAN_TX 和 CAN_RX 引脚与外部 CAN 收发器连接。

### 软件配置

STM32 的 CAN 外设可以通过 HAL 库或 LL 库进行配置。以下是一个使用 HAL 库初始化 CAN 外设的示例代码：

```c
#include "stm32f4xx_hal.h"

CAN_HandleTypeDef hcan;

void CAN_Init(void) {
    hcan.Instance = CAN1;
    hcan.Init.Prescaler = 16;
    hcan.Init.Mode = CAN_MODE_NORMAL;
    hcan.Init.SyncJumpWidth = CAN_SJW_1TQ;
    hcan.Init.TimeSeg1 = CAN_BS1_4TQ;
    hcan.Init.TimeSeg2 = CAN_BS2_3TQ;
    hcan.Init.TimeTriggeredMode = DISABLE;
    hcan.Init.AutoBusOff = DISABLE;
    hcan.Init.AutoWakeUp = DISABLE;
    hcan.Init.AutoRetransmission = ENABLE;
    hcan.Init.ReceiveFifoLocked = DISABLE;
    hcan.Init.TransmitFifoPriority = DISABLE;

    if (HAL_CAN_Init(&hcan) != HAL_OK) {
        // 初始化错误处理
    }
}
```

:::note
**注意**：在实际应用中，您需要根据具体的硬件和通信需求调整初始化参数。
:::

### 发送和接收数据

配置完成后，您可以使用以下代码发送和接收 CAN 消息：

```c
CAN_TxHeaderTypeDef TxHeader;
uint8_t TxData[8];
uint32_t TxMailbox;

TxHeader.StdId = 0x123;
TxHeader.ExtId = 0x00;
TxHeader.RTR = CAN_RTR_DATA;
TxHeader.IDE = CAN_ID_STD;
TxHeader.DLC = 2;
TxHeader.TransmitGlobalTime = DISABLE;

TxData[0] = 0xAA;
TxData[1] = 0x55;

if (HAL_CAN_AddTxMessage(&hcan, &TxHeader, TxData, &TxMailbox) != HAL_OK) {
    // 发送错误处理
}

CAN_RxHeaderTypeDef RxHeader;
uint8_t RxData[8];

if (HAL_CAN_GetRxMessage(&hcan, CAN_RX_FIFO0, &RxHeader, RxData) == HAL_OK) {
    // 处理接收到的数据
}
```

## 实际应用案例

### 汽车电子系统

CAN 协议广泛应用于汽车电子系统中，例如发动机控制单元（ECU）、车身控制模块（BCM）等。通过 CAN 总线，这些模块可以实时交换数据，实现车辆的高效控制。

### 工业自动化

在工业自动化领域，CAN 总线用于连接各种传感器、执行器和控制器。例如，在机器人控制系统中，CAN 总线可以用于传输关节位置、速度等信息。

## 总结

本文介绍了 STM32 CAN 通信的基础知识，包括其工作原理、配置方法以及实际应用场景。通过学习这些内容，您应该能够在 STM32 微控制器上实现基本的 CAN 通信。

:::tip
**提示**：为了进一步巩固您的知识，建议您尝试在 STM32 开发板上实现一个简单的 CAN 通信项目，例如在两个开发板之间传输数据。
:::

## 附加资源

- [STM32 CAN 外设参考手册](https://www.st.com)
- [CAN 协议详解](https://en.wikipedia.org/wiki/CAN_bus)
- [STM32 HAL 库文档](https://www.st.com)

通过阅读这些资源，您可以更深入地了解 STM32 CAN 通信的高级特性和应用。