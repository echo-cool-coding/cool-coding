---
title: STM32 SPI 配置
description: 本教程将详细介绍如何在 STM32 微控制器上配置 SPI（串行外设接口），包括基本概念、配置步骤、代码示例以及实际应用场景。
---

## 介绍

SPI（Serial Peripheral Interface，串行外设接口）是一种高速、全双工的同步通信协议，广泛用于微控制器与外部设备（如传感器、存储器、显示器等）之间的通信。STM32 微控制器内置了多个 SPI 外设，支持多种配置选项，使其能够适应不同的应用需求。

在本教程中，我们将逐步讲解如何在 STM32 上配置 SPI，并通过代码示例展示其使用方法。

## SPI 的基本概念

SPI 通信通常涉及以下四个信号线：

1. **SCK（Serial Clock）**：时钟信号，由主设备生成，用于同步数据传输。
2. **MOSI（Master Out Slave In）**：主设备发送数据，从设备接收数据的信号线。
3. **MISO（Master In Slave Out）**：从设备发送数据，主设备接收数据的信号线。
4. **NSS（Slave Select）**：从设备选择信号，用于选择特定的从设备进行通信。

SPI 通信是全双工的，这意味着主设备和从设备可以同时发送和接收数据。

## STM32 SPI 配置步骤

### 1. 启用 SPI 外设时钟

在 STM32 中，首先需要启用 SPI 外设的时钟。假设我们使用的是 SPI1，可以通过以下代码启用时钟：

```c
RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1, ENABLE);
```

### 2. 配置 GPIO 引脚

SPI 通信需要使用特定的 GPIO 引脚。以 SPI1 为例，通常使用以下引脚：

- SCK: PA5
- MOSI: PA7
- MISO: PA6
- NSS: PA4

可以通过以下代码配置这些引脚为 SPI 功能：

```c
GPIO_InitTypeDef GPIO_InitStruct;
GPIO_InitStruct.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_6 | GPIO_Pin_7;
GPIO_InitStruct.GPIO_Mode = GPIO_Mode_AF_PP;
GPIO_InitStruct.GPIO_Speed = GPIO_Speed_50MHz;
GPIO_Init(GPIOA, &GPIO_InitStruct);
```

### 3. 配置 SPI 外设

接下来，我们需要配置 SPI 外设的工作模式、数据帧格式、时钟极性等参数。以下是一个典型的 SPI 配置示例：

```c
SPI_InitTypeDef SPI_InitStruct;
SPI_InitStruct.SPI_Direction = SPI_Direction_2Lines_FullDuplex;
SPI_InitStruct.SPI_Mode = SPI_Mode_Master;
SPI_InitStruct.SPI_DataSize = SPI_DataSize_8b;
SPI_InitStruct.SPI_CPOL = SPI_CPOL_Low;
SPI_InitStruct.SPI_CPHA = SPI_CPHA_1Edge;
SPI_InitStruct.SPI_NSS = SPI_NSS_Soft;
SPI_InitStruct.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_256;
SPI_InitStruct.SPI_FirstBit = SPI_FirstBit_MSB;
SPI_InitStruct.SPI_CRCPolynomial = 7;
SPI_Init(SPI1, &SPI_InitStruct);
```

### 4. 启用 SPI 外设

配置完成后，启用 SPI 外设：

```c
SPI_Cmd(SPI1, ENABLE);
```

### 5. 发送和接收数据

SPI 通信的核心是数据的发送和接收。以下是一个简单的数据发送和接收示例：

```c
uint8_t SPI_SendData(uint8_t data) {
    while (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE) == RESET);
    SPI_I2S_SendData(SPI1, data);

    while (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_RXNE) == RESET);
    return SPI_I2S_ReceiveData(SPI1);
}
```

## 实际应用案例

### 案例：与 SPI Flash 存储器通信

假设我们有一个 SPI Flash 存储器（如 W25Q128），我们可以使用 SPI 接口与其进行通信。以下是一个读取 Flash 存储器 ID 的示例：

```c
uint8_t ReadFlashID(void) {
    uint8_t cmd = 0x9F; // 读取 ID 的命令
    uint8_t id[3];

    SPI_SendData(cmd);
    id[0] = SPI_SendData(0x00);
    id[1] = SPI_SendData(0x00);
    id[2] = SPI_SendData(0x00);

    return id[0]; // 返回制造商 ID
}
```

## 总结

在本教程中，我们详细介绍了如何在 STM32 微控制器上配置 SPI 外设，并通过代码示例展示了其使用方法。SPI 是一种强大的通信协议，适用于多种应用场景，如与传感器、存储器等外部设备的通信。

## 附加资源与练习

- **练习 1**：尝试修改 SPI 的时钟极性（CPOL）和时钟相位（CPHA），观察通信是否仍然正常。
- **练习 2**：编写代码实现 SPI Flash 存储器的数据写入和读取功能。
- **参考文档**：STM32 参考手册中的 SPI 章节，了解更多高级配置选项。

:::tip
在实际项目中，建议使用 STM32 HAL 库或 LL 库来简化 SPI 配置和操作。
:::