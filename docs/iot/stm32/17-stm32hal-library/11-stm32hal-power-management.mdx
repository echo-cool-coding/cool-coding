---
title: STM32 HAL 电源管理
description: 了解如何使用 STM32HAL 库进行电源管理，优化嵌入式系统的功耗，延长电池寿命。
---

# STM32 HAL 电源管理

在嵌入式系统中，电源管理是一个至关重要的主题。通过有效的电源管理，可以显著降低系统的功耗，延长电池寿命，并提高系统的可靠性。STM32HAL 库为开发者提供了一系列功能强大的 API，用于管理 STM32 微控制器的电源模式。本文将详细介绍如何使用 STM32HAL 库进行电源管理，并通过实际案例展示其应用。

## 1. 电源管理简介

STM32 微控制器支持多种电源模式，每种模式都有不同的功耗和唤醒时间。通过合理选择电源模式，可以在满足系统需求的同时，最大限度地降低功耗。常见的电源模式包括：

- **运行模式（Run Mode）**：CPU 和所有外设都处于活动状态，功耗最高。
- **低功耗运行模式（Low Power Run Mode）**：CPU 以较低频率运行，外设部分关闭，功耗较低。
- **睡眠模式（Sleep Mode）**：CPU 停止运行，但外设和内存保持活动状态，功耗进一步降低。
- **停止模式（Stop Mode）**：CPU 和大部分外设停止运行，仅保留部分寄存器和 SRAM 内容，功耗极低。
- **待机模式（Standby Mode）**：CPU 和所有外设停止运行，仅保留备份域和 RTC，功耗最低。

## 2. 使用 STM32HAL 库进行电源管理

STM32HAL 库提供了一系列函数，用于配置和切换电源模式。以下是一些常用的函数：

- `HAL_PWR_EnterSLEEPMode(uint32_t Regulator, uint8_t SLEEPEntry)`：进入睡眠模式。
- `HAL_PWR_EnterSTOPMode(uint32_t Regulator, uint8_t STOPEntry)`：进入停止模式。
- `HAL_PWR_EnterSTANDBYMode(void)`：进入待机模式。

### 2.1 进入睡眠模式

睡眠模式是最简单的低功耗模式之一。以下代码展示了如何进入睡眠模式：

```c
#include "stm32f4xx_hal.h"

void enter_sleep_mode(void) {
    // 配置唤醒源
    HAL_PWR_EnableWakeUpPin(PWR_WAKEUP_PIN1);

    // 进入睡眠模式
    HAL_PWR_EnterSLEEPMode(PWR_MAINREGULATOR_ON, PWR_SLEEPENTRY_WFI);
}
```

:::note
在睡眠模式下，CPU 停止运行，但外设和内存保持活动状态。可以通过外部中断或唤醒引脚唤醒系统。
:::

### 2.2 进入停止模式

停止模式比睡眠模式更省电，但唤醒时间更长。以下代码展示了如何进入停止模式：

```c
#include "stm32f4xx_hal.h"

void enter_stop_mode(void) {
    // 配置唤醒源
    HAL_PWR_EnableWakeUpPin(PWR_WAKEUP_PIN1);

    // 进入停止模式
    HAL_PWR_EnterSTOPMode(PWR_MAINREGULATOR_ON, PWR_STOPENTRY_WFI);
}
```

:::caution
在停止模式下，大部分外设和时钟都会关闭，唤醒后需要重新初始化系统时钟和外设。
:::

### 2.3 进入待机模式

待机模式是功耗最低的模式，但唤醒后系统会重新启动。以下代码展示了如何进入待机模式：

```c
#include "stm32f4xx_hal.h"

void enter_standby_mode(void) {
    // 配置唤醒源
    HAL_PWR_EnableWakeUpPin(PWR_WAKEUP_PIN1);

    // 进入待机模式
    HAL_PWR_EnterSTANDBYMode();
}
```

:::warning
在待机模式下，系统会完全关闭，唤醒后系统会重新启动，所有未保存的数据都会丢失。
:::

## 3. 实际应用案例

### 3.1 电池供电的温度监测系统

假设我们有一个电池供电的温度监测系统，需要每隔 10 分钟采集一次温度数据。为了延长电池寿命，可以在采集数据后进入停止模式，并通过 RTC 定时器唤醒系统。

```c
#include "stm32f4xx_hal.h"

void system_init(void) {
    // 初始化系统时钟和外设
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_RTC_Init();
}

void enter_stop_mode_with_rtc(void) {
    // 配置 RTC 唤醒时间
    HAL_RTCEx_SetWakeUpTimer_IT(&hrtc, 600, RTC_WAKEUPCLOCK_RTCCLK_DIV16);

    // 进入停止模式
    HAL_PWR_EnterSTOPMode(PWR_MAINREGULATOR_ON, PWR_STOPENTRY_WFI);
}

void main(void) {
    system_init();

    while (1) {
        // 采集温度数据
        float temperature = read_temperature();

        // 进入停止模式，等待 RTC 唤醒
        enter_stop_mode_with_rtc();
    }
}
```

:::tip
在实际应用中，可以根据系统需求选择合适的电源模式，并通过定时器或外部事件唤醒系统。
:::

## 4. 总结

通过合理使用 STM32HAL 库的电源管理功能，可以显著降低嵌入式系统的功耗，延长电池寿命。本文介绍了 STM32 微控制器的常见电源模式，并通过代码示例展示了如何使用 STM32HAL 库进入这些模式。在实际应用中，可以根据系统需求选择合适的电源模式，并通过定时器或外部事件唤醒系统。

## 5. 附加资源与练习

- **练习 1**：修改上述代码，使系统在采集温度数据后进入待机模式，并通过外部按键唤醒。
- **练习 2**：研究 STM32 微控制器的其他低功耗特性，如动态电压调节（DVS）和时钟门控（Clock Gating）。
- **资源**：参考 STM32 官方文档，了解更多关于电源管理的详细信息。

通过不断实践和探索，你将能够更好地掌握 STM32HAL 库的电源管理功能，为你的嵌入式系统设计出更高效的电源管理方案。