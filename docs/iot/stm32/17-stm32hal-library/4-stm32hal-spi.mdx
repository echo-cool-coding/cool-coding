---
title: STM32 HAL SPI
description: 学习如何使用 STM32HAL 库配置和使用 SPI 通信协议。本文将从基础概念讲起，逐步深入，并提供代码示例和实际应用场景。
---

# STM32 HAL SPI

SPI（Serial Peripheral Interface，串行外设接口）是一种高速、全双工的同步通信协议，广泛应用于微控制器与外部设备（如传感器、存储器、显示器等）之间的通信。STM32 微控制器通过 HAL 库提供了简单易用的 SPI 接口配置和通信功能。本文将详细介绍如何使用 STM32HAL 库实现 SPI 通信。

## 什么是 SPI？

SPI 是一种主从架构的通信协议，通常由一个主设备（Master）和一个或多个从设备（Slave）组成。SPI 通信使用四根信号线：

- **SCK（Serial Clock）**：时钟信号，由主设备生成，用于同步数据传输。
- **MOSI（Master Out Slave In）**：主设备发送数据，从设备接收数据的信号线。
- **MISO（Master In Slave Out）**：从设备发送数据，主设备接收数据的信号线。
- **NSS（Slave Select）**：从设备选择信号，用于选择特定的从设备进行通信。

SPI 通信是全双工的，意味着主设备和从设备可以同时发送和接收数据。

## STM32 HAL 库中的 SPI 配置

在 STM32HAL 库中，SPI 的配置和使用非常简单。以下是一个基本的 SPI 配置示例：

```c
#include "stm32f4xx_hal.h"

SPI_HandleTypeDef hspi;

void SPI_Init(void) {
    hspi.Instance = SPI1;
    hspi.Init.Mode = SPI_MODE_MASTER;
    hspi.Init.Direction = SPI_DIRECTION_2LINES;
    hspi.Init.DataSize = SPI_DATASIZE_8BIT;
    hspi.Init.CLKPolarity = SPI_POLARITY_LOW;
    hspi.Init.CLKPhase = SPI_PHASE_1EDGE;
    hspi.Init.NSS = SPI_NSS_SOFT;
    hspi.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_256;
    hspi.Init.FirstBit = SPI_FIRSTBIT_MSB;
    hspi.Init.TIMode = SPI_TIMODE_DISABLE;
    hspi.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
    hspi.Init.CRCPolynomial = 10;
    if (HAL_SPI_Init(&hspi) != HAL_OK) {
        // 初始化错误处理
    }
}
```

:::note
**注意**：在实际应用中，SPI 的配置参数（如时钟极性、相位、波特率等）需要根据具体的外设要求进行调整。
:::

## SPI 数据传输

配置好 SPI 后，可以使用 `HAL_SPI_Transmit` 和 `HAL_SPI_Receive` 函数进行数据传输。以下是一个简单的数据传输示例：

```c
uint8_t txData[] = {0x01, 0x02, 0x03};
uint8_t rxData[3];

HAL_SPI_Transmit(&hspi, txData, 3, 1000); // 发送数据
HAL_SPI_Receive(&hspi, rxData, 3, 1000);  // 接收数据
```

:::tip
**提示**：`HAL_SPI_TransmitReceive` 函数可以同时发送和接收数据，适用于全双工通信场景。
:::

## 实际应用案例

假设我们需要通过 SPI 与一个温度传感器通信，读取当前的温度值。以下是一个简单的实现：

```c
uint8_t txData[] = {0xAA}; // 读取温度的命令
uint8_t rxData[2];         // 存储温度数据的缓冲区

HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_RESET); // 选择从设备
HAL_SPI_TransmitReceive(&hspi, txData, rxData, 2, 1000); // 发送命令并接收数据
HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_SET);   // 取消选择从设备

int16_t temperature = (rxData[0] << 8) | rxData[1]; // 将接收到的数据转换为温度值
```

:::caution
**注意**：在实际应用中，SPI 通信的时序和协议可能因设备而异，请务必参考设备的数据手册。
:::

## 总结

SPI 是一种高效、灵活的通信协议，适用于多种外设的通信需求。通过 STM32HAL 库，我们可以轻松配置和使用 SPI 接口。本文介绍了 SPI 的基本概念、配置方法以及数据传输的实现，并通过一个实际案例展示了 SPI 的应用。

## 附加资源与练习

- **练习 1**：尝试修改 SPI 的波特率，观察通信速度的变化。
- **练习 2**：使用 SPI 与一个 SPI 接口的 LCD 显示屏通信，尝试显示一些简单的图形或文字。
- **资源**：参考 STM32 官方文档和 HAL 库手册，了解更多关于 SPI 的高级功能和配置选项。

通过不断实践和探索，你将能够熟练掌握 STM32HAL 库中的 SPI 通信，并将其应用于各种实际项目中。