---
title: STM32 HAL DMA
description: 了解如何使用 STM32HAL 库中的 DMA（直接内存访问）功能，优化数据传输并提高系统性能。
---

# STM32 HAL DMA

## 介绍

DMA（Direct Memory Access，直接内存访问）是一种硬件功能，允许外设与内存之间直接传输数据，而无需 CPU 的干预。在 STM32 微控制器中，DMA 可以显著提高数据传输效率，尤其是在处理大量数据时，例如音频流、图像处理或通信协议（如 UART、SPI、I2C）的数据传输。

使用 STM32HAL 库，您可以轻松配置和使用 DMA，从而减少 CPU 的负载并提高系统性能。

## DMA 的工作原理

DMA 控制器是 STM32 微控制器中的一个独立模块，它可以在外设和内存之间传输数据。DMA 的主要优点包括：

- **减少 CPU 负载**：CPU 不需要参与数据传输，可以专注于其他任务。
- **提高数据传输速度**：DMA 可以以更高的速度传输数据，尤其是在大数据量传输时。
- **支持多种传输模式**：DMA 支持内存到外设、外设到内存以及内存到内存的传输。

### DMA 传输模式

1. **内存到外设**：将数据从内存传输到外设（例如 UART 发送缓冲区）。
2. **外设到内存**：将数据从外设传输到内存（例如 UART 接收缓冲区）。
3. **内存到内存**：在两个内存区域之间传输数据。

## 配置 DMA 的步骤

以下是使用 STM32HAL 库配置 DMA 的基本步骤：

1. **初始化 DMA 通道**：选择 DMA 通道并配置其参数。
2. **配置外设以使用 DMA**：将外设（如 UART、SPI）配置为使用 DMA 进行数据传输。
3. **启动 DMA 传输**：启动 DMA 传输并等待传输完成或使用中断处理传输完成事件。

### 代码示例：使用 DMA 进行 UART 数据传输

以下是一个使用 DMA 进行 UART 数据传输的示例代码：

```c
#include "stm32f4xx_hal.h"

UART_HandleTypeDef huart2;
DMA_HandleTypeDef hdma_usart2_tx;

void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_USART2_UART_Init(void);

int main(void) {
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_DMA_Init();
    MX_USART2_UART_Init();

    char message[] = "Hello, DMA!";
    HAL_UART_Transmit_DMA(&huart2, (uint8_t*)message, sizeof(message));

    while (1) {
        // 主循环
    }
}

void SystemClock_Config(void) {
    // 系统时钟配置
}

static void MX_GPIO_Init(void) {
    // GPIO 初始化
}

static void MX_DMA_Init(void) {
    __HAL_RCC_DMA1_CLK_ENABLE();
    hdma_usart2_tx.Instance = DMA1_Stream6;
    hdma_usart2_tx.Init.Channel = DMA_CHANNEL_4;
    hdma_usart2_tx.Init.Direction = DMA_MEMORY_TO_PERIPH;
    hdma_usart2_tx.Init.PeriphInc = DMA_PINC_DISABLE;
    hdma_usart2_tx.Init.MemInc = DMA_MINC_ENABLE;
    hdma_usart2_tx.Init.PeriphDataAlignment = DMA_PDATAALIGN_BYTE;
    hdma_usart2_tx.Init.MemDataAlignment = DMA_MDATAALIGN_BYTE;
    hdma_usart2_tx.Init.Mode = DMA_NORMAL;
    hdma_usart2_tx.Init.Priority = DMA_PRIORITY_HIGH;
    hdma_usart2_tx.Init.FIFOMode = DMA_FIFOMODE_DISABLE;
    HAL_DMA_Init(&hdma_usart2_tx);

    __HAL_LINKDMA(&huart2, hdmatx, hdma_usart2_tx);
}

static void MX_USART2_UART_Init(void) {
    huart2.Instance = USART2;
    huart2.Init.BaudRate = 115200;
    huart2.Init.WordLength = UART_WORDLENGTH_8B;
    huart2.Init.StopBits = UART_STOPBITS_1;
    huart2.Init.Parity = UART_PARITY_NONE;
    huart2.Init.Mode = UART_MODE_TX_RX;
    huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
    huart2.Init.OverSampling = UART_OVERSAMPLING_16;
    HAL_UART_Init(&huart2);
}
```

:::note
在上面的代码中，我们使用 DMA 将字符串 `"Hello, DMA!"` 通过 UART 发送出去。DMA 配置为从内存传输数据到 UART 外设。
:::

## 实际应用场景

### 1. 音频流处理

在音频处理应用中，DMA 可以用于将音频数据从内存传输到 DAC（数字模拟转换器）或从 ADC（模拟数字转换器）传输到内存。这样可以确保音频数据的实时传输，而不会因为 CPU 的负载而导致音频中断。

### 2. 图像处理

在图像处理应用中，DMA 可以用于将图像数据从摄像头传感器传输到内存，或者将处理后的图像数据从内存传输到显示设备。这样可以显著提高图像传输的速度和效率。

### 3. 通信协议

在 UART、SPI、I2C 等通信协议中，DMA 可以用于高效地传输数据。例如，在 UART 通信中，DMA 可以自动将接收到的数据存储到内存中，而无需 CPU 的干预。

## 总结

DMA 是 STM32 微控制器中一个强大的功能，可以显著提高数据传输效率并减少 CPU 的负载。通过 STM32HAL 库，您可以轻松配置和使用 DMA 来处理各种数据传输任务。

:::tip
为了进一步掌握 DMA 的使用，建议您尝试以下练习：
1. 使用 DMA 实现内存到内存的数据传输。
2. 配置 DMA 以处理 SPI 或 I2C 通信中的数据。
3. 使用 DMA 中断来处理数据传输完成事件。
:::

## 附加资源

- [STM32 HAL 库文档](https://www.st.com/resource/en/user_manual/dm00105879.pdf)
- [STM32 DMA 控制器参考手册](https://www.st.com/resource/en/reference_manual/dm00031020.pdf)

通过学习和实践，您将能够充分利用 STM32 的 DMA 功能，优化您的嵌入式应用程序。