---
title: STM32 HAL I2C
description: 学习如何使用 STM32 HAL 库实现 I2C 通信。本文将从基础概念讲起，逐步深入，并提供代码示例和实际应用场景。
---

# STM32 HAL I2C

## 介绍

I2C（Inter-Integrated Circuit）是一种常用的串行通信协议，广泛应用于微控制器与外围设备之间的通信。STM32 HAL 库提供了简单易用的 API 来实现 I2C 通信，使得开发者能够快速上手并集成到项目中。

在本教程中，我们将学习如何使用 STM32 HAL 库进行 I2C 通信。我们将从基础概念讲起，逐步深入，并提供代码示例和实际应用场景。

## I2C 基础

I2C 是一种双线制通信协议，使用两条线进行通信：
- **SDA（Serial Data Line）**：数据线，用于传输数据。
- **SCL（Serial Clock Line）**：时钟线，用于同步数据传输。

I2C 通信是主从模式的，主设备（通常是微控制器）负责发起通信并控制时钟信号，而从设备（如传感器、EEPROM 等）则响应主设备的请求。

## STM32 HAL 库中的 I2C

STM32 HAL 库提供了一组函数来简化 I2C 通信的实现。以下是常用的 HAL I2C 函数：
- `HAL_I2C_Init()`：初始化 I2C 外设。
- `HAL_I2C_Master_Transmit()`：主设备发送数据。
- `HAL_I2C_Master_Receive()`：主设备接收数据。
- `HAL_I2C_Slave_Transmit()`：从设备发送数据。
- `HAL_I2C_Slave_Receive()`：从设备接收数据。

## 代码示例

以下是一个简单的代码示例，展示了如何使用 STM32 HAL 库进行 I2C 通信。假设我们有一个 I2C 设备，地址为 `0x50`，我们需要向其写入一个字节的数据，然后读取一个字节的数据。

```c
#include "stm32f4xx_hal.h"

I2C_HandleTypeDef hi2c1;

void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_I2C1_Init(void);

int main(void)
{
  HAL_Init();
  SystemClock_Config();
  MX_GPIO_Init();
  MX_I2C1_Init();

  uint8_t data_to_send = 0x55;
  uint8_t data_received = 0;

  // 向地址为 0x50 的设备发送一个字节的数据
  HAL_I2C_Master_Transmit(&hi2c1, 0x50, &data_to_send, 1, HAL_MAX_DELAY);

  // 从地址为 0x50 的设备接收一个字节的数据
  HAL_I2C_Master_Receive(&hi2c1, 0x50, &data_received, 1, HAL_MAX_DELAY);

  while (1)
  {
    // 主循环
  }
}

static void MX_I2C1_Init(void)
{
  hi2c1.Instance = I2C1;
  hi2c1.Init.ClockSpeed = 100000;
  hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2;
  hi2c1.Init.OwnAddress1 = 0;
  hi2c1.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
  hi2c1.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
  hi2c1.Init.OwnAddress2 = 0;
  hi2c1.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
  hi2c1.Init.NoStretchMode = I2C_NOSTRETCH_DISABLE;
  HAL_I2C_Init(&hi2c1);
}

static void MX_GPIO_Init(void)
{
  __HAL_RCC_GPIOB_CLK_ENABLE();
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  GPIO_InitStruct.Pin = GPIO_PIN_6 | GPIO_PIN_7;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_OD;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF4_I2C1;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);
}

void SystemClock_Config(void)
{
  // 系统时钟配置代码
}
```

:::note
在实际项目中，您需要根据具体的硬件配置调整 `MX_I2C1_Init()` 和 `MX_GPIO_Init()` 函数中的参数。
:::

## 实际应用场景

### 读取温度传感器数据

假设我们有一个 I2C 温度传感器，地址为 `0x48`。我们可以使用以下代码读取传感器的温度数据：

```c
uint8_t temp_data[2];
HAL_I2C_Master_Receive(&hi2c1, 0x48, temp_data, 2, HAL_MAX_DELAY);
int16_t temperature = (temp_data[0] << 8) | temp_data[1];
```

### 写入 EEPROM 数据

假设我们有一个 I2C EEPROM，地址为 `0xA0`。我们可以使用以下代码向 EEPROM 写入数据：

```c
uint8_t data_to_write[] = {0x00, 0x01, 0x02}; // 地址和数据
HAL_I2C_Master_Transmit(&hi2c1, 0xA0, data_to_write, 3, HAL_MAX_DELAY);
```

## 总结

通过本教程，我们学习了如何使用 STM32 HAL 库进行 I2C 通信。我们从基础概念讲起，逐步深入，并提供了代码示例和实际应用场景。希望这些内容能帮助您更好地理解和应用 I2C 通信。

## 附加资源

- [STM32 HAL 库文档](https://www.st.com/resource/en/user_manual/dm00105879.pdf)
- [I2C 协议详解](https://www.i2c-bus.org/)

## 练习

1. 修改代码示例，使其能够读取多个字节的数据。
2. 尝试使用不同的 I2C 设备（如加速度计、光传感器等）进行通信。
3. 研究如何在 I2C 通信中处理错误和超时情况。
