---
title: STM32 HAL 中断
description: 本教程将详细介绍 STM32HAL 库中的中断机制，帮助初学者理解并掌握如何在 STM32 微控制器中使用 HAL 库处理中断。
---

## 介绍

在嵌入式系统中，中断是一种非常重要的机制，它允许微控制器在执行主程序的同时，对外部事件（如按键按下、定时器溢出等）做出快速响应。STM32HAL 库提供了一套简单易用的 API 来处理中断，使得开发者能够轻松地配置和管理中断。

### 什么是中断？

中断是微控制器的一种机制，当某个特定事件发生时，微控制器会暂停当前的任务，转而去执行与该事件相关的代码（称为中断服务例程，ISR），执行完毕后再返回到原来的任务继续执行。

## STM32 HAL 中断的基本概念

在 STM32 中，中断可以分为以下几类：

1. **外部中断（EXTI）**：由外部引脚触发的中断，如按键按下。
2. **定时器中断**：由定时器溢出或比较匹配触发的中断。
3. **串口中断**：由串口接收或发送数据触发的中断。
4. **DMA 中断**：由 DMA 传输完成触发的中断。

### 中断优先级

STM32 中的中断具有优先级，优先级高的中断可以打断优先级低的中断。优先级可以通过 NVIC（Nested Vectored Interrupt Controller）进行配置。

## 配置和使用 STM32HAL 中断

### 1. 配置外部中断（EXTI）

以下是一个配置外部中断的示例，假设我们使用 GPIO 引脚 PA0 作为外部中断源。

```c
// 初始化 GPIO 引脚
GPIO_InitTypeDef GPIO_InitStruct = {0};
GPIO_InitStruct.Pin = GPIO_PIN_0;
GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING; // 上升沿触发中断
GPIO_InitStruct.Pull = GPIO_NOPULL;
HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

// 配置 NVIC
HAL_NVIC_SetPriority(EXTI0_IRQn, 0, 0);
HAL_NVIC_EnableIRQ(EXTI0_IRQn);
```

### 2. 编写中断服务例程（ISR）

在 STM32HAL 库中，中断服务例程通常以 `HAL_GPIO_EXTI_Callback` 的形式出现。以下是一个简单的 ISR 示例：

```c
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
    if (GPIO_Pin == GPIO_PIN_0) {
        // 处理 PA0 引脚的中断
        HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_7); // 切换 LED 状态
    }
}
```

### 3. 启用全局中断

在配置完中断后，需要启用全局中断：

```c
__enable_irq();
```

## 实际应用案例

### 案例：按键控制 LED

假设我们有一个按键连接到 PA0 引脚，LED 连接到 PB7 引脚。当按键按下时，LED 状态切换。

```c
// 初始化 GPIO 引脚
GPIO_InitTypeDef GPIO_InitStruct = {0};
GPIO_InitStruct.Pin = GPIO_PIN_0;
GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING; // 上升沿触发中断
GPIO_InitStruct.Pull = GPIO_NOPULL;
HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

// 配置 NVIC
HAL_NVIC_SetPriority(EXTI0_IRQn, 0, 0);
HAL_NVIC_EnableIRQ(EXTI0_IRQn);

// 中断服务例程
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
    if (GPIO_Pin == GPIO_PIN_0) {
        HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_7); // 切换 LED 状态
    }
}

// 启用全局中断
__enable_irq();
```

## 总结

通过本教程，我们学习了如何在 STM32HAL 库中配置和使用中断。中断是嵌入式系统中非常重要的机制，能够帮助微控制器快速响应外部事件。我们通过一个简单的按键控制 LED 的案例，展示了中断的实际应用。

:::tip
在实际开发中，建议在中断服务例程中尽量减少耗时操作，以确保系统的实时性。
:::

## 附加资源与练习

1. **练习**：尝试配置一个定时器中断，每隔 1 秒切换一次 LED 状态。
2. **资源**：阅读 STM32 参考手册中的 NVIC 和 EXTI 章节，深入了解中断的配置和优先级管理。
3. **扩展**：探索如何使用 DMA 中断来处理大量数据的传输。

通过不断练习和探索，你将能够熟练掌握 STM32HAL 库中的中断机制，并能够在实际项目中灵活运用。