---
title: STM32 定时器同步
description: 了解如何使用STM32定时器的同步功能，实现多个定时器的协同工作。本文将从基础概念讲起，逐步深入，并提供代码示例和实际应用场景。
---

## 介绍

在STM32微控制器中，定时器（Timer）是非常重要的外设之一，用于生成精确的时间延迟、测量时间间隔、产生PWM信号等。在某些应用中，可能需要多个定时器协同工作，例如同步启动、同步停止或同步计数。STM32提供了定时器同步功能，允许开发者通过硬件或软件方式实现多个定时器的同步操作。

本文将详细介绍STM32定时器的同步机制，并通过代码示例和实际案例帮助初学者理解这一概念。

## 定时器同步的基本概念

STM32的定时器同步功能允许一个定时器（主定时器）控制另一个或多个定时器（从定时器）的行为。这种控制可以通过以下几种方式实现：

1. **启动同步**：主定时器启动时，从定时器也同时启动。
2. **停止同步**：主定时器停止时，从定时器也同时停止。
3. **计数同步**：主定时器的计数器值更新时，从定时器的计数器也同步更新。

这些同步操作可以通过配置定时器的控制寄存器来实现。

## 定时器同步的配置步骤

### 1. 选择主定时器和从定时器

首先，需要确定哪个定时器作为主定时器，哪个作为从定时器。主定时器将控制从定时器的行为。

### 2. 配置主定时器

主定时器需要配置为输出触发信号。触发信号可以是更新事件（UEV）、比较匹配事件等。

```c
TIM_TypeDef *TIM_Master = TIM2;
TIM_Master->CR2 |= TIM_CR2_MMS_1; // 选择更新事件作为触发输出
```

### 3. 配置从定时器

从定时器需要配置为接收主定时器的触发信号，并根据触发信号执行相应的同步操作。

```c
TIM_TypeDef *TIM_Slave = TIM3;
TIM_Slave->SMCR |= TIM_SMCR_SMS_2; // 选择从模式为触发模式
TIM_Slave->SMCR |= TIM_SMCR_TS_2; // 选择触发源为ITR1（TIM2的触发信号）
```

### 4. 启动定时器

配置完成后，启动主定时器，从定时器将根据配置的同步模式自动启动。

```c
TIM_Master->CR1 |= TIM_CR1_CEN; // 启动主定时器
TIM_Slave->CR1 |= TIM_CR1_CEN; // 启动从定时器
```

## 实际案例：PWM信号同步

假设我们需要生成两个同步的PWM信号，一个由TIM2生成，另一个由TIM3生成。我们可以使用定时器同步功能来实现这一需求。

### 代码示例

```c
// 配置TIM2为主定时器
TIM_TypeDef *TIM_Master = TIM2;
TIM_Master->PSC = 8399; // 预分频器
TIM_Master->ARR = 999; // 自动重装载值
TIM_Master->CCR1 = 500; // 占空比50%
TIM_Master->CCMR1 |= TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC1M_2; // PWM模式1
TIM_Master->CCER |= TIM_CCER_CC1E; // 使能通道1
TIM_Master->CR2 |= TIM_CR2_MMS_1; // 选择更新事件作为触发输出

// 配置TIM3为从定时器
TIM_TypeDef *TIM_Slave = TIM3;
TIM_Slave->PSC = 8399; // 预分频器
TIM_Slave->ARR = 999; // 自动重装载值
TIM_Slave->CCR1 = 500; // 占空比50%
TIM_Slave->CCMR1 |= TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC1M_2; // PWM模式1
TIM_Slave->CCER |= TIM_CCER_CC1E; // 使能通道1
TIM_Slave->SMCR |= TIM_SMCR_SMS_2; // 选择从模式为触发模式
TIM_Slave->SMCR |= TIM_SMCR_TS_2; // 选择触发源为ITR1（TIM2的触发信号）

// 启动定时器
TIM_Master->CR1 |= TIM_CR1_CEN;
TIM_Slave->CR1 |= TIM_CR1_CEN;
```

### 输出结果

通过上述配置，TIM2和TIM3将生成同步的PWM信号，占空比均为50%，频率相同。

## 总结

STM32的定时器同步功能为开发者提供了强大的工具，能够实现多个定时器的协同工作。通过合理配置主定时器和从定时器，可以实现启动、停止、计数等同步操作。本文通过PWM信号同步的实际案例，展示了定时器同步的应用场景。

## 附加资源与练习

- **练习1**：尝试配置两个定时器，使其在启动时同步，但在停止时不同步。
- **练习2**：使用定时器同步功能实现三个定时器的同步计数。
- **参考文档**：STM32参考手册中的定时器章节，详细了解定时器的同步机制。

:::tip
在实际项目中，定时器同步功能可以用于电机控制、多通道数据采集等场景。掌握这一功能将大大提升你的嵌入式开发能力。
:::