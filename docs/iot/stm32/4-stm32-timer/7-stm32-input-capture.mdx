---
title: STM32 输入捕获
description: 了解STM32定时器的输入捕获功能，掌握如何测量外部信号的频率和占空比。
---

# STM32 输入捕获

## 介绍

在嵌入式系统中，定时器（Timer）是一个非常重要的外设，它可以用于生成精确的时间延迟、测量时间间隔以及捕获外部信号的时间信息。STM32微控制器中的定时器模块提供了**输入捕获**功能，允许我们测量外部信号的频率、占空比或脉冲宽度。

输入捕获的基本原理是：当外部信号的电平发生变化时（例如上升沿或下降沿），定时器会记录当前的计数值。通过比较两次捕获的计数值，我们可以计算出信号的周期或脉冲宽度。

## 输入捕获的工作原理

STM32的输入捕获功能通常与定时器的**捕获/比较通道**相关联。以下是输入捕获的基本工作流程：

1. **配置定时器**：设置定时器的时钟源、预分频器和自动重装载值。
2. **配置输入捕获通道**：选择捕获信号的边沿（上升沿、下降沿或两者）。
3. **捕获事件**：当检测到指定的边沿时，定时器会记录当前的计数值，并触发中断或DMA请求。
4. **计算信号参数**：通过比较两次捕获的计数值，可以计算出信号的周期、频率或占空比。

## 代码示例

以下是一个简单的代码示例，展示了如何使用STM32的输入捕获功能来测量外部信号的频率。

```c
#include "stm32f4xx.h"

void TIM2_IRQHandler(void) {
    if (TIM2->SR & TIM_SR_CC1IF) {  // 检查捕获/比较1中断标志
        static uint32_t previous_capture = 0;
        uint32_t current_capture = TIM2->CCR1;  // 读取捕获值
        uint32_t period = current_capture - previous_capture;
        previous_capture = current_capture;

        // 计算频率（假设定时器时钟为84MHz，预分频为84-1）
        uint32_t frequency = 84000000 / (period * 84);
        // 在这里处理频率值，例如打印到串口
    }
    TIM2->SR &= ~TIM_SR_CC1IF;  // 清除中断标志
}

void TIM2_InputCapture_Init(void) {
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;  // 使能TIM2时钟
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN; // 使能GPIOA时钟

    GPIOA->MODER &= ~(3 << (1 * 2));     // 配置PA1为复用功能
    GPIOA->MODER |= (2 << (1 * 2));
    GPIOA->AFR[0] &= ~(0xF << (1 * 4));  // 选择AF1（TIM2_CH1）
    GPIOA->AFR[0] |= (1 << (1 * 4));

    TIM2->PSC = 84 - 1;                  // 预分频器
    TIM2->ARR = 0xFFFFFFFF;              // 自动重装载值
    TIM2->CCMR1 |= TIM_CCMR1_CC1S_0;     // 配置CC1为输入捕获模式
    TIM2->CCER |= TIM_CCER_CC1E;         // 使能捕获
    TIM2->DIER |= TIM_DIER_CC1IE;        // 使能捕获/比较1中断
    TIM2->CR1 |= TIM_CR1_CEN;            // 启动定时器

    NVIC_EnableIRQ(TIM2_IRQn);           // 使能TIM2中断
}
```

:::note
**注意**：上述代码假设定时器时钟为84MHz，并且预分频器设置为84-1，因此定时器的计数频率为1MHz。捕获值的单位为微秒。
:::

## 实际应用场景

输入捕获功能在许多实际应用中都非常有用，例如：

- **测量电机转速**：通过捕获编码器输出的脉冲信号，可以计算出电机的转速。
- **测量PWM信号的占空比**：通过捕获PWM信号的上升沿和下降沿，可以计算出占空比。
- **测量超声波传感器的距离**：通过捕获超声波回波信号的时间间隔，可以计算出距离。

## 总结

STM32的输入捕获功能是一个强大的工具，可以帮助我们精确测量外部信号的时间参数。通过合理配置定时器和捕获通道，我们可以轻松实现频率、周期和占空比的测量。

## 附加资源与练习

- **练习1**：修改上述代码，使其能够测量PWM信号的占空比。
- **练习2**：尝试使用DMA来代替中断处理捕获事件，以减少CPU的负载。
- **参考文档**：STM32参考手册中的定时器章节，详细了解定时器的各种功能。

:::tip
**提示**：在实际项目中，建议使用STM32CubeMX来生成初始化代码，以减少手动配置的工作量。
:::