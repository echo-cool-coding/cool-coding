---
title: STM32 基本定时器
description: 本文详细介绍了STM32微控制器中的基本定时器，包括其工作原理、配置方法以及实际应用案例。适合初学者学习STM32定时器的基础知识。
---

## 介绍

STM32微控制器中的定时器是其外设的重要组成部分，用于生成精确的时间延迟、测量时间间隔、控制PWM信号等。基本定时器是STM32定时器家族中最简单的一种，通常用于简单的计时任务。本文将详细介绍STM32基本定时器的工作原理、配置方法以及实际应用。

## 基本定时器的工作原理

STM32的基本定时器通常由以下几个部分组成：

1. **计数器（Counter）**：一个16位的向上计数器，用于计数时钟脉冲。
2. **预分频器（Prescaler）**：用于将输入时钟频率分频，从而降低计数器的计数速度。
3. **自动重装载寄存器（Auto-reload Register）**：用于设置计数器的上限值，当计数器达到该值时，会自动重置并触发中断或事件。

基本定时器的工作流程如下：

1. 定时器从0开始计数，每接收到一个时钟脉冲，计数器加1。
2. 当计数器达到自动重装载寄存器中设置的值时，计数器重置为0，并触发中断或事件。
3. 通过调整预分频器和自动重装载寄存器的值，可以控制定时器的计数周期和触发频率。

## 配置基本定时器

以下是一个简单的STM32基本定时器的配置示例，使用HAL库进行配置：

```c
#include "stm32f1xx_hal.h"

TIM_HandleTypeDef htim6;

void SystemClock_Config(void);
static void MX_TIM6_Init(void);

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    MX_TIM6_Init();

    HAL_TIM_Base_Start_IT(&htim6);

    while (1)
    {
        // 主循环
    }
}

void SystemClock_Config(void)
{
    // 系统时钟配置
}

static void MX_TIM6_Init(void)
{
    TIM_MasterConfigTypeDef sMasterConfig = {0};

    htim6.Instance = TIM6;
    htim6.Init.Prescaler = 8399; // 预分频器设置为8399，将84MHz时钟分频为10kHz
    htim6.Init.CounterMode = TIM_COUNTERMODE_UP;
    htim6.Init.Period = 9999; // 自动重装载寄存器设置为9999，定时器每1秒触发一次
    htim6.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
    if (HAL_TIM_Base_Init(&htim6) != HAL_OK)
    {
        // 初始化错误处理
    }

    sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
    sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
    if (HAL_TIMEx_MasterConfigSynchronization(&htim6, &sMasterConfig) != HAL_OK)
    {
        // 同步配置错误处理
    }
}

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
    if (htim->Instance == TIM6)
    {
        // 定时器6中断处理
    }
}
```

### 代码解释

- `htim6.Instance = TIM6;`：选择定时器6作为基本定时器。
- `htim6.Init.Prescaler = 8399;`：将84MHz的时钟分频为10kHz。
- `htim6.Init.Period = 9999;`：设置自动重装载寄存器为9999，定时器每1秒触发一次。
- `HAL_TIM_Base_Start_IT(&htim6);`：启动定时器并启用中断。

## 实际应用案例

### 案例1：LED闪烁

假设我们需要使用基本定时器来控制LED的闪烁，每隔1秒切换一次LED的状态。我们可以利用定时器的中断功能来实现这一功能。

```c
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
    if (htim->Instance == TIM6)
    {
        HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5); // 切换PA5引脚的状态
    }
}
```

### 案例2：精确延时

在某些应用中，我们需要精确的延时功能。可以使用基本定时器来实现精确的延时函数。

```c
void delay_ms(uint32_t ms)
{
    __HAL_TIM_SET_COUNTER(&htim6, 0); // 重置计数器
    while (__HAL_TIM_GET_COUNTER(&htim6) < ms * 10); // 等待指定的毫秒数
}
```

## 总结

STM32的基本定时器是微控制器中非常实用的外设，适用于各种简单的计时任务。通过合理配置预分频器和自动重装载寄存器，可以实现精确的定时功能。本文介绍了基本定时器的工作原理、配置方法以及实际应用案例，希望能够帮助初学者更好地理解和应用STM32的基本定时器。

## 附加资源与练习

- **练习1**：尝试修改代码，使LED的闪烁频率变为0.5秒一次。
- **练习2**：使用基本定时器实现一个精确的微秒级延时函数。
- **参考文档**：STM32参考手册中的定时器章节，了解更多高级定时器的功能。

:::tip
建议初学者在掌握基本定时器后，进一步学习STM32的高级定时器功能，如PWM输出、输入捕获等。
:::