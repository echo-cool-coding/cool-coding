---
title: STM32 单脉冲模式
description: 了解STM32定时器的单脉冲模式，掌握其工作原理、配置方法以及实际应用场景。
---

# STM32 单脉冲模式

## 介绍

STM32微控制器的定时器模块功能强大，支持多种工作模式。其中，**单脉冲模式（One Pulse Mode, OPM）**是一种特殊的定时器模式，允许定时器在接收到触发信号后生成一个精确的脉冲信号。这个脉冲的宽度和延迟时间可以通过配置定时器的参数来控制。

单脉冲模式常用于需要精确控制脉冲宽度和延迟时间的场景，例如电机控制、PWM信号生成、精确计时等。

## 单脉冲模式的工作原理

在单脉冲模式下，定时器会在接收到触发信号后启动，并在达到预设的计数值时停止。整个过程只生成一个脉冲信号。单脉冲模式的核心是通过配置定时器的计数器和比较寄存器来实现。

### 关键配置参数

1. **计数器模式**：通常选择向上计数模式。
2. **自动重装载寄存器（ARR）**：用于设置脉冲的宽度。
3. **比较寄存器（CCR）**：用于设置脉冲的延迟时间。
4. **触发源**：可以是外部信号、软件触发或其他定时器事件。

## 配置步骤

以下是配置STM32定时器单脉冲模式的基本步骤：

1. **使能定时器时钟**：首先需要使能定时器的时钟。
2. **配置定时器模式**：将定时器设置为单脉冲模式。
3. **设置ARR和CCR**：根据需求设置自动重装载寄存器和比较寄存器。
4. **配置触发源**：选择触发源并配置相关寄存器。
5. **启动定时器**：启动定时器并等待触发信号。

### 代码示例

以下是一个使用STM32 HAL库配置单脉冲模式的示例代码：

```c
#include "stm32f4xx_hal.h"

TIM_HandleTypeDef htim2;

void TIM2_Init(void) {
    TIM_OnePulse_InitTypeDef sConfig = {0};

    htim2.Instance = TIM2;
    htim2.Init.Prescaler = 8399; // 84MHz / 8400 = 10kHz
    htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
    htim2.Init.Period = 9999; // 10kHz / 10000 = 1Hz
    htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
    htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
    HAL_TIM_OnePulse_Init(&htim2, TIM_OPMODE_SINGLE);

    sConfig.OCMode = TIM_OCMODE_PWM1;
    sConfig.Pulse = 5000; // 50% duty cycle
    sConfig.OCPolarity = TIM_OCPOLARITY_HIGH;
    sConfig.OCFastMode = TIM_OCFAST_DISABLE;
    HAL_TIM_OnePulse_ConfigChannel(&htim2, &sConfig, TIM_CHANNEL_1, TIM_CHANNEL_2);

    HAL_TIM_Base_Start(&htim2);
}

int main(void) {
    HAL_Init();
    TIM2_Init();

    while (1) {
        // 等待触发信号
    }
}
```

### 输入和输出

- **输入**：触发信号（可以是外部信号或软件触发）。
- **输出**：一个精确的脉冲信号，其宽度和延迟时间由ARR和CCR决定。

## 实际应用场景

### 电机控制

在电机控制中，单脉冲模式可以用于生成精确的PWM信号，控制电机的转速和方向。例如，可以通过单脉冲模式生成一个特定宽度的脉冲信号来控制步进电机的步进角度。

### 精确计时

在需要精确计时的场景中，单脉冲模式可以用于生成一个精确的计时信号。例如，在测量传感器响应时间时，可以使用单脉冲模式生成一个精确的触发信号。

## 总结

STM32的单脉冲模式是一种非常有用的定时器模式，适用于需要精确控制脉冲宽度和延迟时间的场景。通过合理配置定时器的参数，可以生成精确的脉冲信号，满足各种应用需求。

## 附加资源

- [STM32定时器参考手册](https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf)
- [STM32 HAL库文档](https://www.st.com/en/embedded-software/stm32cubef4.html)

## 练习

1. 修改代码示例中的ARR和CCR值，观察脉冲信号的变化。
2. 尝试使用外部触发信号来启动单脉冲模式，并测量输出脉冲的宽度和延迟时间。
3. 设计一个简单的电机控制应用，使用单脉冲模式生成PWM信号控制电机的转速。
