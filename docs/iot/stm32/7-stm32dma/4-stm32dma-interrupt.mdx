---
title: STM32 DMA中断
description: 本文详细介绍了STM32微控制器中的DMA中断机制，包括其工作原理、配置方法以及实际应用示例。适合初学者学习如何通过DMA中断优化数据传输。
---

# STM32 DMA中断

## 介绍

DMA（Direct Memory Access，直接内存访问）是STM32微控制器中用于高效数据传输的重要功能。它允许外设与内存之间直接传输数据，而无需CPU的干预。DMA中断则是在DMA传输完成或发生错误时触发的中断信号，用于通知CPU处理相关事件。

在本文中，我们将深入探讨STM32DMA中断的工作原理、配置方法以及实际应用场景。

## DMA中断的工作原理

DMA中断通常用于以下两种情况：

1. **传输完成中断**：当DMA传输完成时，触发中断以通知CPU。
2. **传输错误中断**：当DMA传输过程中发生错误时，触发中断以通知CPU。

通过配置DMA中断，开发者可以在数据传输完成后立即执行相关操作，而不需要轮询DMA状态寄存器。

## 配置DMA中断

### 1. 启用DMA中断

在STM32中，DMA中断的启用通常涉及以下几个步骤：

1. 配置DMA通道。
2. 启用DMA传输完成中断或传输错误中断。
3. 配置NVIC（Nested Vectored Interrupt Controller）以启用DMA中断。

以下是一个简单的代码示例，展示了如何配置DMA中断：

```c
#include "stm32f4xx.h"

void DMA2_Stream0_IRQHandler(void) {
    if (DMA_GetITStatus(DMA2_Stream0, DMA_IT_TCIF0)) {
        // 处理传输完成中断
        DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_TCIF0);
    }
    if (DMA_GetITStatus(DMA2_Stream0, DMA_IT_TEIF0)) {
        // 处理传输错误中断
        DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_TEIF0);
    }
}

void configureDMA(void) {
    // 配置DMA2 Stream0
    DMA_InitTypeDef DMA_InitStruct;
    DMA_InitStruct.DMA_Channel = DMA_Channel_0;
    DMA_InitStruct.DMA_PeripheralBaseAddr = (uint32_t)&ADC1->DR;
    DMA_InitStruct.DMA_Memory0BaseAddr = (uint32_t)&adc_buffer;
    DMA_InitStruct.DMA_DIR = DMA_DIR_PeripheralToMemory;
    DMA_InitStruct.DMA_BufferSize = 100;
    DMA_InitStruct.DMA_PeripheralInc = DMA_PeripheralInc_Disable;
    DMA_InitStruct.DMA_MemoryInc = DMA_MemoryInc_Enable;
    DMA_InitStruct.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;
    DMA_InitStruct.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;
    DMA_InitStruct.DMA_Mode = DMA_Mode_Circular;
    DMA_InitStruct.DMA_Priority = DMA_Priority_High;
    DMA_InitStruct.DMA_FIFOMode = DMA_FIFOMode_Disable;
    DMA_InitStruct.DMA_FIFOThreshold = DMA_FIFOThreshold_HalfFull;
    DMA_InitStruct.DMA_MemoryBurst = DMA_MemoryBurst_Single;
    DMA_InitStruct.DMA_PeripheralBurst = DMA_PeripheralBurst_Single;
    DMA_Init(DMA2_Stream0, &DMA_InitStruct);

    // 启用传输完成中断
    DMA_ITConfig(DMA2_Stream0, DMA_IT_TC, ENABLE);

    // 配置NVIC
    NVIC_InitTypeDef NVIC_InitStruct;
    NVIC_InitStruct.NVIC_IRQChannel = DMA2_Stream0_IRQn;
    NVIC_InitStruct.NVIC_IRQChannelPreemptionPriority = 0;
    NVIC_InitStruct.NVIC_IRQChannelSubPriority = 0;
    NVIC_InitStruct.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStruct);

    // 启用DMA
    DMA_Cmd(DMA2_Stream0, ENABLE);
}
```

### 2. 中断服务例程（ISR）

在DMA中断服务例程中，开发者需要检查中断标志位，并根据标志位执行相应的操作。例如，在传输完成中断中，可以处理接收到的数据；在传输错误中断中，可以记录错误信息或重新启动传输。

## 实际应用案例

### 案例：ADC数据采集

假设我们需要使用DMA从ADC（模数转换器）采集数据，并在采集完成后通过中断处理数据。以下是一个简单的应用场景：

1. 配置ADC和DMA，使ADC的转换结果通过DMA传输到内存中。
2. 启用DMA传输完成中断。
3. 在中断服务例程中处理采集到的数据。

```c
uint16_t adc_buffer[100];

void DMA2_Stream0_IRQHandler(void) {
    if (DMA_GetITStatus(DMA2_Stream0, DMA_IT_TCIF0)) {
        // 处理采集到的数据
        for (int i = 0; i < 100; i++) {
            process_data(adc_buffer[i]);
        }
        DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_TCIF0);
    }
}

void configureADC(void) {
    // 配置ADC
    ADC_InitTypeDef ADC_InitStruct;
    ADC_InitStruct.ADC_Resolution = ADC_Resolution_12b;
    ADC_InitStruct.ADC_ScanConvMode = ENABLE;
    ADC_InitStruct.ADC_ContinuousConvMode = ENABLE;
    ADC_InitStruct.ADC_ExternalTrigConvEdge = ADC_ExternalTrigConvEdge_None;
    ADC_InitStruct.ADC_DataAlign = ADC_DataAlign_Right;
    ADC_InitStruct.ADC_NbrOfConversion = 1;
    ADC_Init(ADC1, &ADC_InitStruct);

    // 配置DMA
    configureDMA();

    // 启动ADC
    ADC_Cmd(ADC1, ENABLE);
    ADC_SoftwareStartConv(ADC1);
}
```

在这个案例中，DMA中断确保了ADC数据采集的高效性和实时性。

## 总结

DMA中断是STM32微控制器中优化数据传输的重要工具。通过合理配置DMA中断，开发者可以在数据传输完成后立即执行相关操作，从而提高系统的响应速度和效率。

:::tip
在实际开发中，建议仔细阅读STM32参考手册中关于DMA和中断的章节，以确保正确配置和使用DMA中断。
:::

## 附加资源

- [STM32参考手册](https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf)
- [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html)：用于生成初始化代码的工具。

## 练习

1. 修改上述代码，使其在传输错误中断中记录错误信息并重新启动DMA传输。
2. 尝试使用DMA中断实现UART数据的接收和发送。

通过以上内容，您应该对STM32DMA中断有了初步的了解。继续实践和探索，您将能够更深入地掌握这一强大的功能。