---
title: STM32 系统保护
description: 了解STM32微控制器的系统保护机制，包括看门狗、电源管理和复位功能，确保系统稳定运行。
---

# STM32 系统保护

STM32微控制器广泛应用于嵌入式系统中，其强大的功能和灵活性使其成为许多项目的首选。然而，在实际应用中，系统可能会遇到各种异常情况，如程序跑飞、电源波动或外部干扰等。为了确保系统的稳定性和可靠性，STM32提供了多种系统保护机制。本文将详细介绍这些机制，并通过实际案例帮助初学者理解其应用。

## 1. 系统保护概述

系统保护是嵌入式系统中至关重要的一部分，它确保系统在异常情况下能够恢复正常运行或安全关闭。STM32的系统保护机制主要包括以下几个方面：

- **看门狗定时器（Watchdog Timer）**：用于检测程序是否正常运行，防止程序跑飞。
- **电源管理（Power Management）**：通过低功耗模式和省电机制，延长电池寿命并防止电源异常。
- **复位功能（Reset Functionality）**：在系统出现严重错误时，通过复位使系统恢复到初始状态。

## 2. 看门狗定时器

看门狗定时器是一种硬件定时器，用于监控程序的运行状态。如果程序在一定时间内没有“喂狗”（即重置看门狗定时器），看门狗将触发系统复位，防止程序陷入死循环或跑飞。

### 2.1 独立看门狗（IWDG）

独立看门狗（IWDG）由独立的时钟源驱动，即使主时钟失效，它仍能正常工作。以下是一个简单的IWDG配置示例：

```c
#include "stm32f4xx.h"

void IWDG_Init(void) {
    // 使能IWDG时钟
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_IWDG, ENABLE);

    // 设置IWDG预分频器
    IWDG_SetPrescaler(IWDG_Prescaler_32);

    // 设置IWDG重装载值
    IWDG_SetReload(0xFFF);

    // 启动IWDG
    IWDG_Enable();

    // 喂狗
    IWDG_ReloadCounter();
}

int main(void) {
    IWDG_Init();

    while (1) {
        // 主循环中定期喂狗
        IWDG_ReloadCounter();
    }
}
```

:::tip
在实际应用中，确保在主循环中定期“喂狗”，以避免不必要的系统复位。
:::

### 2.2 窗口看门狗（WWDG）

窗口看门狗（WWDG）与IWDG类似，但它允许在一个时间窗口内“喂狗”。如果在这个窗口之外“喂狗”，系统将触发复位。WWDG适用于需要更精确时间控制的场景。

## 3. 电源管理

STM32提供了多种低功耗模式，以降低系统功耗并延长电池寿命。常见的低功耗模式包括：

- **睡眠模式（Sleep Mode）**：CPU停止运行，但外设和时钟仍保持活动。
- **停止模式（Stop Mode）**：CPU和大部分外设停止运行，仅保留部分寄存器和SRAM内容。
- **待机模式（Standby Mode）**：系统进入最低功耗状态，仅保留备份寄存器和SRAM内容。

以下是一个进入停止模式的示例：

```c
#include "stm32f4xx.h"

void Enter_Stop_Mode(void) {
    // 配置PWR_CR寄存器，进入停止模式
    PWR_EnterSTOPMode(PWR_Regulator_LowPower, PWR_STOPEntry_WFI);
}

int main(void) {
    // 配置系统时钟和外设
    SystemInit();

    // 进入停止模式
    Enter_Stop_Mode();

    // 从停止模式唤醒后继续执行
    while (1) {
        // 主循环
    }
}
```

:::caution
在进入低功耗模式前，确保所有外设和时钟配置正确，以避免系统无法正常唤醒。
:::

## 4. 复位功能

STM32提供了多种复位源，包括上电复位、外部复位、看门狗复位等。通过复位功能，系统可以在出现严重错误时恢复到初始状态，确保系统的可靠性。

### 4.1 复位源

以下是一些常见的复位源：

- **上电复位（Power-on Reset）**：系统上电时自动复位。
- **外部复位（External Reset）**：通过外部引脚触发复位。
- **看门狗复位（Watchdog Reset）**：看门狗定时器超时触发复位。

### 4.2 复位状态寄存器

STM32提供了复位状态寄存器（RCC_CSR），用于记录上次复位的来源。以下是一个读取复位状态的示例：

```c
#include "stm32f4xx.h"

void Check_Reset_Source(void) {
    if (RCC_GetFlagStatus(RCC_FLAG_PORRST) {
        // 上电复位
    } else if (RCC_GetFlagStatus(RCC_FLAG_PINRST)) {
        // 外部复位
    } else if (RCC_GetFlagStatus(RCC_FLAG_IWDGRST)) {
        // 独立看门狗复位
    }
}

int main(void) {
    // 检查复位源
    Check_Reset_Source();

    while (1) {
        // 主循环
    }
}
```

## 5. 实际案例

### 5.1 工业控制系统中的看门狗应用

在工业控制系统中，系统可能会受到电磁干扰或电源波动的影响，导致程序跑飞。通过配置独立看门狗，系统可以在程序异常时自动复位，确保设备的稳定运行。

### 5.2 电池供电设备的低功耗管理

在电池供电的设备中，电源管理至关重要。通过使用STM32的低功耗模式，设备可以在空闲时进入睡眠或停止模式，从而延长电池寿命。

## 6. 总结

STM32的系统保护机制为嵌入式系统提供了强大的稳定性和可靠性保障。通过合理配置看门狗定时器、电源管理和复位功能，可以有效应对各种异常情况，确保系统安全运行。

## 7. 附加资源与练习

- **练习1**：尝试在STM32开发板上配置独立看门狗，并观察程序跑飞时的复位效果。
- **练习2**：设计一个低功耗应用，使用STM32的停止模式，并测量系统的功耗变化。
- **参考文档**：STM32参考手册（RM0090）中的系统保护章节。

:::note
深入学习STM32的系统保护机制，将有助于你在实际项目中设计出更加稳定和可靠的嵌入式系统。
:::