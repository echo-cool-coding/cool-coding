---
title: STM32 文件操作
description: 学习如何在STM32微控制器上进行文件操作，包括文件的创建、读取、写入和删除。本文适合初学者，提供详细的代码示例和实际应用场景。
---

# STM32 文件操作

在嵌入式系统中，文件操作是一个非常重要的功能，尤其是在需要存储和读取大量数据的应用中。STM32微控制器通过其内置的文件系统支持，可以方便地进行文件操作。本文将详细介绍如何在STM32上进行文件操作，包括文件的创建、读取、写入和删除。

## 1. 文件系统简介

文件系统是操作系统用于管理存储设备上文件和目录的一种机制。在STM32中，常用的文件系统有FATFS，它是一个轻量级的FAT文件系统库，适用于嵌入式系统。

### 1.1 FATFS文件系统

FATFS是一个开源的文件系统库，支持FAT12、FAT16和FAT32文件系统。它提供了丰富的API，可以方便地进行文件操作。

## 2. 文件操作基础

在STM32上进行文件操作，通常需要以下几个步骤：

1. 初始化文件系统
2. 打开文件
3. 读取或写入文件
4. 关闭文件
5. 卸载文件系统

### 2.1 初始化文件系统

在使用文件系统之前，需要先初始化文件系统。以下是一个初始化FATFS文件系统的示例代码：

```c
FATFS fs;
FRESULT res;

res = f_mount(&fs, "", 1);  // 挂载文件系统
if (res != FR_OK) {
    // 处理错误
}
```

### 2.2 打开文件

文件打开操作使用 `f_open` 函数。以下是一个打开文件的示例代码：

```c
FIL file;
FRESULT res;

res = f_open(&file, "test.txt", FA_READ | FA_WRITE | FA_OPEN_ALWAYS);
if (res != FR_OK) {
    // 处理错误
}
```

### 2.3 读取文件

文件读取操作使用 `f_read` 函数。以下是一个读取文件的示例代码：

```c
char buffer[100];
UINT bytesRead;

res = f_read(&file, buffer, sizeof(buffer), &bytesRead);
if (res != FR_OK) {
    // 处理错误
}
```

### 2.4 写入文件

文件写入操作使用 `f_write` 函数。以下是一个写入文件的示例代码：

```c
char buffer[] = "Hello, STM32!";
UINT bytesWritten;

res = f_write(&file, buffer, sizeof(buffer) - 1, &bytesWritten);
if (res != FR_OK) {
    // 处理错误
}
```

### 2.5 关闭文件

文件操作完成后，需要关闭文件以释放资源。以下是一个关闭文件的示例代码：

```c
res = f_close(&file);
if (res != FR_OK) {
    // 处理错误
}
```

### 2.6 卸载文件系统

在不再使用文件系统时，可以卸载文件系统。以下是一个卸载文件系统的示例代码：

```c
f_unmount("");
```

## 3. 实际应用场景

### 3.1 数据记录

在物联网设备中，通常需要记录传感器数据。通过文件系统，可以将传感器数据存储在SD卡或内部Flash中，以便后续分析。

```c
FIL file;
FRESULT res;

res = f_open(&file, "sensor_data.txt", FA_WRITE | FA_OPEN_APPEND);
if (res == FR_OK) {
    char data[50];
    sprintf(data, "Temperature: %.2f\n", temperature);
    f_write(&file, data, strlen(data), NULL);
    f_close(&file);
}
```

### 3.2 固件更新

通过文件系统，可以将新的固件文件存储在外部存储设备中，然后在启动时读取并更新固件。

```c
FIL file;
FRESULT res;

res = f_open(&file, "firmware.bin", FA_READ);
if (res == FR_OK) {
    // 读取固件文件并更新
    f_close(&file);
}
```

## 4. 总结

本文介绍了如何在STM32上进行文件操作，包括文件的创建、读取、写入和删除。通过FATFS文件系统库，可以方便地在嵌入式系统中进行文件管理。希望本文能帮助初学者更好地理解和应用STM32文件操作。

## 5. 附加资源与练习

- **练习1**：尝试在STM32上创建一个日志文件，记录系统运行时的状态信息。
- **练习2**：编写一个程序，从SD卡中读取一个配置文件，并根据配置文件的内容设置系统参数。

:::tip
更多关于FATFS文件系统的详细信息，可以参考[FATFS官方网站](http://elm-chan.org/fsw/ff/00index_e.html)。
:::