---
title: STM32 文件读写
description: 学习如何在STM32微控制器上实现文件读写操作，掌握文件系统的基本概念和实际应用。
---

## 介绍

在嵌入式系统中，文件系统是管理存储设备（如SD卡、Flash等）上数据的重要工具。STM32微控制器支持多种文件系统，如FATFS，这使得开发者能够轻松地在STM32上实现文件的读写操作。本文将详细介绍如何在STM32上使用FATFS文件系统进行文件的读写操作，并提供代码示例和实际应用场景。

## 文件系统基础

文件系统是操作系统用于管理存储设备上文件和目录的一种机制。在STM32中，常用的文件系统是FATFS，它是一个轻量级的FAT文件系统模块，适用于嵌入式系统。

### FATFS文件系统

FATFS是一个开源的文件系统模块，支持FAT12、FAT16和FAT32文件系统。它提供了简单的API接口，使得开发者可以轻松地在STM32上实现文件的读写操作。

## STM32 文件读写步骤

在STM32上实现文件读写操作通常包括以下几个步骤：

1. **初始化文件系统**：挂载文件系统，准备进行文件操作。
2. **打开文件**：打开一个文件，准备进行读写操作。
3. **读写文件**：读取或写入文件内容。
4. **关闭文件**：完成文件操作后，关闭文件。
5. **卸载文件系统**：卸载文件系统，释放资源。

### 代码示例

以下是一个简单的STM32文件读写示例，使用FATFS文件系统：

```c
#include "ff.h"
#include "stdio.h"

FATFS fs;  // 文件系统对象
FIL fil;   // 文件对象
FRESULT res;  // 文件操作结果
UINT bw;  // 写入字节数

int main(void) {
    // 初始化文件系统
    res = f_mount(&fs, "", 1);
    if (res != FR_OK) {
        printf("Failed to mount file system\n");
        return -1;
    }

    // 打开文件
    res = f_open(&fil, "test.txt", FA_WRITE | FA_CREATE_ALWAYS);
    if (res != FR_OK) {
        printf("Failed to open file\n");
        return -1;
    }

    // 写入文件
    res = f_write(&fil, "Hello, STM32!", 13, &bw);
    if (res != FR_OK) {
        printf("Failed to write file\n");
        return -1;
    }

    // 关闭文件
    f_close(&fil);

    // 卸载文件系统
    f_mount(NULL, "", 0);

    return 0;
}
```

### 代码解释

1. **初始化文件系统**：使用 `f_mount` 函数挂载文件系统。
2. **打开文件**：使用 `f_open` 函数打开文件，`FA_WRITE | FA_CREATE_ALWAYS` 表示以写入模式打开文件，如果文件不存在则创建。
3. **写入文件**：使用 `f_write` 函数将字符串 "Hello, STM32!" 写入文件。
4. **关闭文件**：使用 `f_close` 函数关闭文件。
5. **卸载文件系统**：使用 `f_mount` 函数卸载文件系统。

## 实际应用场景

### 数据记录

在嵌入式系统中，数据记录是一个常见的应用场景。例如，在环境监测系统中，STM32可以通过文件系统将传感器数据记录到SD卡中，以便后续分析。

```c
// 假设传感器数据已经读取到变量sensor_data中
char buffer[64];
sprintf(buffer, "Temperature: %.2f, Humidity: %.2f\n", sensor_data.temperature, sensor_data.humidity);

// 打开文件
res = f_open(&fil, "sensor_data.txt", FA_WRITE | FA_OPEN_APPEND);
if (res != FR_OK) {
    printf("Failed to open file\n");
    return -1;
}

// 写入数据
res = f_write(&fil, buffer, strlen(buffer), &bw);
if (res != FR_OK) {
    printf("Failed to write file\n");
    return -1;
}

// 关闭文件
f_close(&fil);
```

### 固件更新

STM32可以通过文件系统从SD卡中读取固件文件，并进行固件更新。这种方式可以简化固件更新的流程，特别是在设备部署在现场时。

```c
// 打开固件文件
res = f_open(&fil, "firmware.bin", FA_READ);
if (res != FR_OK) {
    printf("Failed to open firmware file\n");
    return -1;
}

// 读取固件数据
uint8_t firmware_buffer[1024];
res = f_read(&fil, firmware_buffer, sizeof(firmware_buffer), &bw);
if (res != FR_OK) {
    printf("Failed to read firmware file\n");
    return -1;
}

// 关闭文件
f_close(&fil);

// 进行固件更新
update_firmware(firmware_buffer, bw);
```

## 总结

在STM32上实现文件读写操作是嵌入式开发中的一项重要技能。通过使用FATFS文件系统，开发者可以轻松地在STM32上管理文件和目录。本文介绍了文件系统的基本概念、文件读写的步骤，并提供了实际应用场景的代码示例。

## 附加资源与练习

- **FATFS官方文档**：https://elm-chan.org/fsw/ff/00index_e.html
- **STM32 HAL库文档**：https://www.st.com/en/embedded-software/stm32cube-mcu-mpu-packages.html

### 练习

1. 修改代码示例，使其能够读取文件内容并打印到串口。
2. 尝试在STM32上实现一个简单的日志系统，将系统运行状态记录到SD卡中。
3. 研究如何在STM32上实现文件系统的多任务操作，确保文件操作的线程安全性。

:::tip
在开发过程中，务必注意文件系统的资源管理，避免内存泄漏和文件损坏。
:::