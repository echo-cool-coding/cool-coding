---
title: STM32 启动流程
description: 了解STM32微控制器的启动流程，从复位到执行用户代码的详细步骤，适合初学者学习。
---

# STM32 启动流程

STM32微控制器的启动流程是理解其硬件架构和软件开发的基础。本文将详细介绍STM32从复位到执行用户代码的完整过程，帮助初学者掌握这一关键概念。

## 1. 启动流程概述

STM32的启动流程可以分为以下几个主要步骤：

1. **复位**：微控制器上电或复位后，硬件会自动执行一系列初始化操作。
2. **设置堆栈指针**：从特定的内存地址加载初始堆栈指针（SP）。
3. **设置程序计数器**：从特定的内存地址加载初始程序计数器（PC），指向复位处理程序。
4. **执行复位处理程序**：执行复位处理程序，初始化系统时钟、外设等。
5. **跳转到用户代码**：最终跳转到用户的主程序（通常是`main()`函数）。

## 2. 详细步骤

### 2.1 复位

当STM32微控制器上电或复位时，硬件会自动执行以下操作：

- **复位向量表**：STM32的复位向量表位于内存的起始位置（通常是`0x00000000`）。向量表中的第一个条目是初始堆栈指针（SP），第二个条目是复位处理程序的地址。

### 2.2 设置堆栈指针

在复位后，硬件会自动从复位向量表的第一个条目加载初始堆栈指针（SP）。这个值通常是RAM的末尾地址。

```c
uint32_t *pStack = (uint32_t *)0x00000000;
uint32_t stackPointer = *pStack;
```

### 2.3 设置程序计数器

接下来，硬件会从复位向量表的第二个条目加载初始程序计数器（PC），指向复位处理程序的地址。

```c
uint32_t *pResetHandler = (uint32_t *)0x00000004;
uint32_t resetHandler = *pResetHandler;
```

### 2.4 执行复位处理程序

复位处理程序通常由编译器自动生成，负责初始化系统时钟、外设等。以下是一个典型的复位处理程序的伪代码：

```c
void Reset_Handler(void) {
    // 初始化系统时钟
    SystemInit();

    // 初始化数据段
    __main();

    // 跳转到用户代码
    main();
}
```

### 2.5 跳转到用户代码

在复位处理程序执行完毕后，程序会跳转到用户的主程序（通常是`main()`函数）。此时，STM32已经完成了所有必要的初始化，可以开始执行用户代码。

```c
int main(void) {
    // 用户代码
    while (1) {
        // 主循环
    }
}
```

## 3. 实际案例

假设我们有一个简单的LED闪烁程序，以下是其在STM32上的启动流程：

1. **复位**：STM32上电后，硬件自动执行复位操作。
2. **设置堆栈指针**：从`0x00000000`加载初始堆栈指针。
3. **设置程序计数器**：从`0x00000004`加载复位处理程序的地址。
4. **执行复位处理程序**：初始化系统时钟和外设。
5. **跳转到用户代码**：执行`main()`函数，开始LED闪烁。

```c
int main(void) {
    // 初始化GPIO
    GPIO_InitTypeDef GPIO_InitStruct = {0};
    __HAL_RCC_GPIOC_CLK_ENABLE();
    GPIO_InitStruct.Pin = GPIO_PIN_13;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

    // LED闪烁
    while (1) {
        HAL_GPIO_TogglePin(GPIOC, GPIO_PIN_13);
        HAL_Delay(500);
    }
}
```

## 4. 总结

STM32的启动流程是理解其硬件架构和软件开发的关键。通过本文的介绍，初学者可以掌握从复位到执行用户代码的详细步骤，并能够应用到实际项目中。

## 5. 附加资源

- [STM32参考手册](https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf)
- [STM32CubeMX用户手册](https://www.st.com/resource/en/user_manual/dm00104712-stm32cubemx-initialization-code-generator-stmicroelectronics.pdf)

:::tip
建议初学者通过STM32CubeMX工具生成初始化代码，以便更好地理解启动流程。
:::