---
title: STM32 DMA 控制器
description: 了解 STM32 微控制器中的 DMA（直接内存访问）控制器，掌握其工作原理、配置方法以及实际应用场景。
---

# STM32 DMA 控制器

## 介绍

DMA（Direct Memory Access，直接内存访问）是 STM32 微控制器中一个非常重要的功能模块。它允许外设（如 UART、SPI、ADC 等）直接与内存进行数据交换，而无需 CPU 的干预。这种方式可以显著提高数据传输效率，减少 CPU 的负载，从而让 CPU 有更多时间处理其他任务。

在 STM32 中，DMA 控制器负责管理这些数据传输任务。通过合理配置 DMA，你可以实现高效的数据传输，尤其是在需要处理大量数据的应用中，如音频处理、图像采集等。

## DMA 的工作原理

DMA 控制器通过以下步骤完成数据传输：

1. **请求阶段**：外设向 DMA 控制器发出数据传输请求。
2. **响应阶段**：DMA 控制器接收请求，并开始数据传输。
3. **传输阶段**：DMA 控制器直接从源地址读取数据，并将其写入目标地址。
4. **完成阶段**：数据传输完成后，DMA 控制器会通知 CPU 或外设。

:::tip
DMA 传输可以配置为单次传输或循环传输。单次传输完成后，DMA 控制器会停止工作；而循环传输则会不断重复数据传输过程。
:::

## DMA 的配置

在 STM32 中，配置 DMA 控制器通常需要以下步骤：

1. **选择 DMA 通道**：每个外设通常对应一个或多个 DMA 通道。你需要根据外设选择合适的 DMA 通道。
2. **配置源地址和目标地址**：设置数据传输的源地址（如外设数据寄存器）和目标地址（如内存中的数组）。
3. **配置传输方向**：确定数据传输的方向，是从外设到内存，还是从内存到外设。
4. **配置数据大小和传输模式**：设置每次传输的数据大小（如字节、半字或字）以及传输模式（如单次传输或循环传输）。
5. **启用 DMA 中断**（可选）：如果需要，可以启用 DMA 传输完成中断，以便在传输完成后执行特定操作。

以下是一个简单的 DMA 配置示例，假设我们使用 DMA 将数据从内存传输到 UART 外设：

```c
#include "stm32f4xx.h"

void DMA_Config(void) {
    // 启用 DMA2 时钟
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_DMA2, ENABLE);

    // 配置 DMA2 Stream7 通道4（UART1_TX）
    DMA_InitTypeDef DMA_InitStruct;
    DMA_InitStruct.DMA_Channel = DMA_Channel_4;
    DMA_InitStruct.DMA_PeripheralBaseAddr = (uint32_t)&USART1->DR;
    DMA_InitStruct.DMA_Memory0BaseAddr = (uint32_t)buffer;
    DMA_InitStruct.DMA_DIR = DMA_DIR_MemoryToPeripheral;
    DMA_InitStruct.DMA_BufferSize = 100;
    DMA_InitStruct.DMA_PeripheralInc = DMA_PeripheralInc_Disable;
    DMA_InitStruct.DMA_MemoryInc = DMA_MemoryInc_Enable;
    DMA_InitStruct.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte;
    DMA_InitStruct.DMA_MemoryDataSize = DMA_MemoryDataSize_Byte;
    DMA_InitStruct.DMA_Mode = DMA_Mode_Normal;
    DMA_InitStruct.DMA_Priority = DMA_Priority_High;
    DMA_InitStruct.DMA_FIFOMode = DMA_FIFOMode_Disable;
    DMA_InitStruct.DMA_FIFOThreshold = DMA_FIFOThreshold_HalfFull;
    DMA_InitStruct.DMA_MemoryBurst = DMA_MemoryBurst_Single;
    DMA_InitStruct.DMA_PeripheralBurst = DMA_PeripheralBurst_Single;
    DMA_Init(DMA2_Stream7, &DMA_InitStruct);

    // 启用 DMA2 Stream7
    DMA_Cmd(DMA2_Stream7, ENABLE);
}
```

:::note
在上述代码中，`buffer` 是一个存储数据的数组，`USART1->DR` 是 UART1 的数据寄存器地址。
:::

## 实际应用场景

### 1. 音频数据处理

在音频处理应用中，DMA 可以用于将音频数据从 ADC（模数转换器）传输到内存，或者从内存传输到 DAC（数模转换器）。通过使用 DMA，可以确保音频数据的实时性和连续性，而不会因为 CPU 的负载而导致数据丢失。

### 2. 图像采集

在图像采集应用中，DMA 可以用于将图像数据从摄像头传感器传输到内存。由于图像数据量通常较大，使用 DMA 可以显著提高数据传输效率，减少 CPU 的负载。

### 3. 高速通信

在高速通信应用中，如 SPI 或 I2C 通信，DMA 可以用于将数据从外设传输到内存，或者从内存传输到外设。通过使用 DMA，可以确保数据传输的高效性和实时性。

## 总结

DMA 控制器是 STM32 微控制器中一个非常重要的功能模块。通过合理配置 DMA，你可以实现高效的数据传输，减少 CPU 的负载，从而提高系统的整体性能。在实际应用中，DMA 可以用于音频处理、图像采集、高速通信等多种场景。

## 附加资源与练习

- **练习 1**：尝试配置 DMA 将数据从内存传输到 SPI 外设，并观察数据传输的效果。
- **练习 2**：在 DMA 传输完成后，启用中断并执行特定操作，如点亮 LED 灯。
- **参考文档**：STM32 参考手册中的 DMA 章节，了解更多关于 DMA 控制器的详细信息。

通过以上内容，你应该对 STM32 的 DMA 控制器有了初步的了解。继续深入学习并实践，你将能够更好地掌握这一强大的功能模块。