---
title: STM32 启动过程
description: 本文详细介绍了STM32微控制器的启动过程，包括从复位到主程序执行的各个阶段，适合初学者学习。
---

## 介绍

STM32微控制器是嵌入式系统中广泛使用的芯片之一。了解其启动过程对于开发人员至关重要，因为它决定了程序如何从复位状态进入主程序执行阶段。本文将逐步讲解STM32的启动过程，帮助初学者理解其工作原理。

## STM32 启动过程概述

STM32的启动过程可以分为以下几个主要阶段：

1. **复位阶段**：微控制器上电或复位后，首先进入复位阶段。
2. **时钟初始化**：配置系统时钟，确保微控制器以正确的频率运行。
3. **堆栈初始化**：设置堆栈指针，为函数调用和局部变量分配内存。
4. **向量表初始化**：加载中断向量表，确保中断服务程序能够正确执行。
5. **主程序执行**：跳转到主程序入口点，开始执行用户代码。

## 详细步骤

### 1. 复位阶段

当STM32微控制器上电或复位时，它会从特定的内存地址（通常是`0x00000000`）开始执行代码。这个地址通常指向复位向量，即复位处理程序的入口点。

```c
void Reset_Handler(void) {
    // 复位处理程序
}
```

### 2. 时钟初始化

在复位处理程序中，首先需要初始化系统时钟。STM32微控制器通常使用内部或外部振荡器作为时钟源，并通过PLL（锁相环）倍频以获得更高的系统时钟频率。

```c
void SystemInit(void) {
    // 配置时钟源和PLL
    RCC->CR |= RCC_CR_HSEON; // 启用外部高速时钟
    while (!(RCC->CR & RCC_CR_HSERDY)); // 等待外部时钟稳定
    RCC->CFGR |= RCC_CFGR_PLLSRC_HSE; // 选择HSE作为PLL输入
    RCC->CFGR |= RCC_CFGR_PLLMUL9; // 设置PLL倍频系数
    RCC->CR |= RCC_CR_PLLON; // 启用PLL
    while (!(RCC->CR & RCC_CR_PLLRDY)); // 等待PLL锁定
    RCC->CFGR |= RCC_CFGR_SW_PLL; // 选择PLL作为系统时钟源
}
```

### 3. 堆栈初始化

堆栈指针（SP）通常在复位时被初始化为`0x20000000`，这是SRAM的起始地址。堆栈用于存储函数调用的返回地址和局部变量。

```c
__attribute__((section(".stack")))
uint32_t stack_top = 0x20000000;
```

### 4. 向量表初始化

中断向量表是一个包含中断服务程序入口地址的数组。STM32微控制器使用向量表来确定中断发生时应该跳转到哪个中断服务程序。

```c
extern uint32_t __Vectors[];
void Reset_Handler(void) {
    SCB->VTOR = (uint32_t)__Vectors; // 设置向量表地址
}
```

### 5. 主程序执行

在完成上述初始化步骤后，程序会跳转到主程序入口点，通常是`main()`函数。

```c
int main(void) {
    // 用户代码开始执行
    while (1) {
        // 主循环
    }
}
```

## 实际案例

假设我们有一个简单的LED闪烁程序，以下是其启动过程的实际应用：

```c
#include "stm32f4xx.h"

void SystemInit(void) {
    // 时钟初始化
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIODEN; // 启用GPIOD时钟
    GPIOD->MODER |= GPIO_MODER_MODER12_0; // 配置PD12为输出模式
}

int main(void) {
    SystemInit();
    while (1) {
        GPIOD->ODR ^= GPIO_ODR_OD12; // 切换PD12状态
        for (volatile int i = 0; i < 100000; i++); // 简单延时
    }
}
```

在这个例子中，`SystemInit()`函数初始化了系统时钟和GPIO端口，然后在`main()`函数中，程序进入一个无限循环，不断切换LED的状态。

## 总结

STM32的启动过程是一个从复位到主程序执行的复杂过程，涉及时钟初始化、堆栈设置、向量表加载等多个步骤。理解这些步骤对于开发STM32应用程序至关重要。

## 附加资源

- [STM32参考手册](https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf)
- [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html)
- [ARM Cortex-M4编程指南](https://developer.arm.com/documentation/dui0553/a/)

## 练习

1. 修改上述LED闪烁程序，使其使用不同的GPIO端口和引脚。
2. 尝试使用内部时钟源（HSI）代替外部时钟源（HSE），并观察系统行为的变化。
3. 研究如何通过修改向量表来实现自定义的中断服务程序。

:::tip
在调试STM32启动过程时，使用调试器（如ST-Link）可以更直观地观察程序的执行流程和寄存器状态。
:::