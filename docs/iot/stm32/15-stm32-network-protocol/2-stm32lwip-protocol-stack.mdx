---
title: STM32 LwIP协议栈
description: 了解如何在STM32微控制器上使用LwIP协议栈实现网络通信。本文将从基础概念入手，逐步讲解LwIP的配置和使用，并提供实际案例和代码示例。
---

## 介绍

LwIP（Lightweight IP）是一个轻量级的TCP/IP协议栈，专为嵌入式系统设计。它非常适合资源有限的微控制器，如STM32系列。LwIP提供了完整的TCP/IP协议栈功能，包括TCP、UDP、IPv4、IPv6、DHCP、DNS等协议，同时保持了较低的资源占用。

在STM32微控制器上，LwIP通常与硬件抽象层（HAL）和以太网外设一起使用，以实现网络通信。本文将介绍如何在STM32上配置和使用LwIP协议栈，并通过实际案例展示其应用。

## LwIP协议栈的基本概念

LwIP协议栈的核心是一个事件驱动的网络堆栈，它通过回调函数处理网络事件。LwIP的主要组件包括：

- **网络接口层**：负责与硬件交互，如以太网控制器。
- **IP层**：处理IP数据包的发送和接收。
- **传输层**：提供TCP和UDP协议的支持。
- **应用层**：支持HTTP、FTP、DNS等应用协议。

## 配置LwIP协议栈

在STM32上使用LwIP协议栈的第一步是配置硬件和软件环境。以下是配置LwIP的基本步骤：

1. **硬件配置**：确保STM32微控制器具有以太网外设，并正确连接以太网PHY芯片。
2. **软件配置**：使用STM32CubeMX生成初始化代码，并启用LwIP协议栈。

### 使用STM32CubeMX配置LwIP

1. 打开STM32CubeMX并选择目标STM32微控制器。
2. 在“Middleware”选项卡中启用LwIP。
3. 配置以太网外设和PHY芯片的参数。
4. 生成初始化代码并导入到你的开发环境中。

## 编写LwIP应用程序

配置完成后，你可以开始编写LwIP应用程序。以下是一个简单的TCP服务器示例，它监听端口5000并回显接收到的数据。

```c
#include "lwip/opt.h"
#include "lwip/tcp.h"
#include "lwip/init.h"
#include "lwip/netif.h"

static err_t tcp_echo_recv(void *arg, struct tcp_pcb *tpcb, struct pbuf *p, err_t err) {
    if (p != NULL) {
        tcp_recved(tpcb, p->tot_len);
        tcp_write(tpcb, p->payload, p->tot_len, 1);
        pbuf_free(p);
    } else if (err == ERR_OK) {
        tcp_close(tpcb);
    }
    return ERR_OK;
}

static err_t tcp_echo_accept(void *arg, struct tcp_pcb *newpcb, err_t err) {
    tcp_recv(newpcb, tcp_echo_recv);
    return ERR_OK;
}

void tcp_echo_init(void) {
    struct tcp_pcb *pcb = tcp_new();
    tcp_bind(pcb, IP_ADDR_ANY, 5000);
    tcp_listen(pcb);
    tcp_accept(pcb, tcp_echo_accept);
}

int main(void) {
    lwip_init();
    tcp_echo_init();
    while (1) {
        // 主循环
    }
}
```

### 代码解释

- `tcp_echo_recv`：处理接收到的数据，并将其回显给客户端。
- `tcp_echo_accept`：处理新的TCP连接请求。
- `tcp_echo_init`：初始化TCP服务器并开始监听端口5000。

## 实际应用案例

### 案例：远程温度监控系统

假设你正在开发一个远程温度监控系统，该系统通过以太网将温度数据发送到远程服务器。你可以使用LwIP协议栈来实现这一功能。

1. **硬件**：STM32微控制器、以太网PHY芯片、温度传感器。
2. **软件**：使用LwIP协议栈实现TCP客户端，定期将温度数据发送到服务器。

```c
void send_temperature_data(struct tcp_pcb *pcb, float temperature) {
    char buffer[32];
    snprintf(buffer, sizeof(buffer), "Temperature: %.2f C", temperature);
    tcp_write(pcb, buffer, strlen(buffer), 1);
}

void temperature_monitor_task(void) {
    struct tcp_pcb *pcb = tcp_new();
    ip_addr_t server_ip;
    IP4_ADDR(&server_ip, 192, 168, 1, 100); // 服务器IP地址
    tcp_connect(pcb, &server_ip, 5000, NULL);

    while (1) {
        float temperature = read_temperature_sensor();
        send_temperature_data(pcb, temperature);
        vTaskDelay(1000); // 每隔1秒发送一次数据
    }
}
```

## 总结

LwIP协议栈为STM32微控制器提供了强大的网络通信能力。通过本文的介绍，你应该已经了解了如何配置LwIP协议栈，并编写简单的网络应用程序。LwIP的轻量级设计使其非常适合资源有限的嵌入式系统。

## 附加资源与练习

- **练习1**：修改TCP服务器示例，使其支持多个客户端连接。
- **练习2**：实现一个UDP客户端，将传感器数据发送到远程服务器。
- **资源**：阅读LwIP官方文档，了解更多高级功能和配置选项。

:::tip
在实际项目中，建议使用RTOS（如FreeRTOS）来管理多个网络任务，以提高系统的响应性和稳定性。
:::