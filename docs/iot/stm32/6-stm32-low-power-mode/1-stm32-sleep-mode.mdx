---
title: STM32 睡眠模式
description: 了解STM32微控制器的睡眠模式，学习如何通过低功耗模式优化嵌入式应用的能耗。
---

# STM32 睡眠模式

在嵌入式系统中，功耗优化是一个关键的设计目标，尤其是在电池供电的设备中。STM32微控制器提供了多种低功耗模式，其中**睡眠模式**是最简单且常用的一种。本文将详细介绍STM32的睡眠模式，帮助初学者理解其工作原理、实现方法以及实际应用场景。

## 什么是睡眠模式？

睡眠模式是STM32微控制器的一种低功耗模式。在该模式下，CPU停止运行，但外设（如定时器、串口等）仍然可以继续工作。睡眠模式的主要目的是在不需要CPU处理任务时，降低系统的功耗。

:::note
睡眠模式不会关闭系统时钟，因此外设仍然可以正常运行。如果需要进一步降低功耗，可以考虑使用**停止模式**或**待机模式**。
:::

## 如何进入睡眠模式？

STM32微控制器通过调用特定的函数进入睡眠模式。以下是一个简单的代码示例，展示如何进入睡眠模式：

```c
#include "stm32f4xx.h"  // 根据你的STM32系列选择合适的头文件

void enter_sleep_mode(void) {
    // 设置SLEEPDEEP位为0，选择睡眠模式
    SCB->SCR &= ~(1 << 2);

    // 进入睡眠模式
    __WFI();  // 等待中断
}
```

### 代码解释：
1. **SCB->SCR**：系统控制块（System Control Block）中的系统控制寄存器（SCR）。通过清除`SLEEPDEEP`位（第2位），选择睡眠模式。
2. **__WFI()**：这是一个内联汇编指令，表示“等待中断”。执行该指令后，CPU将停止运行，进入睡眠模式，直到有中断发生。

:::tip
在进入睡眠模式之前，确保已经配置好中断源。否则，系统可能会一直处于睡眠状态，无法唤醒。
:::

## 如何唤醒STM32？

STM32可以通过以下方式从睡眠模式中唤醒：
1. **外部中断**：配置GPIO引脚为外部中断源，当引脚状态变化时，触发中断并唤醒CPU。
2. **定时器中断**：使用定时器（如SysTick或通用定时器）在特定时间间隔后唤醒CPU。
3. **其他外设中断**：如串口、I2C、SPI等外设的中断。

以下是一个使用外部中断唤醒STM32的示例：

```c
void EXTI0_IRQHandler(void) {
    if (EXTI->PR & EXTI_PR_PR0) {
        EXTI->PR |= EXTI_PR_PR0;  // 清除中断标志
        // 唤醒后执行的代码
    }
}

void configure_external_interrupt(void) {
    // 配置GPIO引脚为外部中断源
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;  // 使能GPIOA时钟
    GPIOA->MODER &= ~(3 << 0);  // 配置PA0为输入模式
    EXTI->IMR |= EXTI_IMR_MR0;  // 使能EXTI0中断
    EXTI->RTSR |= EXTI_RTSR_TR0;  // 配置上升沿触发
    NVIC_EnableIRQ(EXTI0_IRQn);  // 使能EXTI0中断向量
}
```

### 代码解释：
1. **EXTI0_IRQHandler**：外部中断0的中断服务例程。当中断发生时，清除中断标志并执行唤醒后的代码。
2. **configure_external_interrupt**：配置PA0引脚为外部中断源，并设置上升沿触发。

## 实际应用场景

睡眠模式在以下场景中非常有用：
1. **电池供电设备**：如智能手表、传感器节点等，通过睡眠模式延长电池寿命。
2. **周期性任务**：设备在大部分时间处于空闲状态，只有在特定时间间隔（如每分钟）才需要执行任务。
3. **事件驱动系统**：设备在等待外部事件（如按键按下、传感器数据到达）时进入睡眠模式，以降低功耗。

:::caution
在实际应用中，确保在进入睡眠模式之前保存必要的系统状态，并在唤醒后恢复这些状态。
:::

## 总结

STM32的睡眠模式是一种简单且有效的低功耗解决方案。通过停止CPU的运行，睡眠模式可以显著降低系统的功耗，同时允许外设继续工作。本文介绍了如何进入和退出睡眠模式，并提供了实际应用场景和代码示例。

## 附加资源与练习

1. **练习**：尝试在STM32开发板上实现睡眠模式，并使用外部中断或定时器中断唤醒系统。
2. **进一步学习**：探索STM32的其他低功耗模式，如停止模式和待机模式，了解它们的区别和适用场景。
3. **参考文档**：查阅STM32参考手册，了解更多关于低功耗模式的详细信息。

通过掌握睡眠模式，你将能够设计出更加节能的嵌入式系统，为实际应用提供更长的电池寿命和更高的效率。