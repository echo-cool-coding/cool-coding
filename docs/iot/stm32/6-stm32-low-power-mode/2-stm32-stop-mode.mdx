---
title: STM32 停止模式
description: 了解STM32微控制器的停止模式，掌握如何通过低功耗模式延长电池寿命并优化系统性能。
---

# STM32 停止模式

在嵌入式系统中，功耗管理是一个关键的设计考虑因素，尤其是在电池供电的设备中。STM32微控制器提供了多种低功耗模式，其中**停止模式**（Stop Mode）是一种常用的模式，能够在保持系统状态的同时显著降低功耗。本文将详细介绍STM32的停止模式，包括其工作原理、配置方法以及实际应用场景。

## 什么是停止模式？

停止模式是STM32微控制器的一种低功耗模式。在该模式下，CPU、Flash和SRAM的时钟被关闭，但寄存器和SRAM的内容保持不变。这意味着系统可以在停止模式下保持当前状态，并在需要时快速恢复到正常工作模式。

停止模式的功耗极低，通常只有几微安（µA），因此非常适合需要长时间待机的应用场景，例如传感器节点、远程控制器等。

:::note
停止模式与睡眠模式不同。在睡眠模式下，CPU停止运行，但外设和时钟仍然工作。而在停止模式下，大部分外设和时钟都被关闭，功耗更低。
:::

## 如何进入停止模式？

要进入停止模式，需要配置STM32的低功耗控制寄存器（PWR_CR）并调用相应的函数。以下是一个简单的代码示例，展示如何进入停止模式：

```c
#include "stm32f4xx.h"  // 根据你的STM32系列选择合适的头文件

void enter_stop_mode(void) {
    // 使能PWR时钟
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR, ENABLE);

    // 设置电压调节器为低功耗模式
    PWR_EnterSTOPMode(PWR_Regulator_LowPower, PWR_STOPEntry_WFI);

    // 退出停止模式后，系统时钟需要重新配置
    SystemInit();
}
```

### 代码解释

1. **使能PWR时钟**：首先需要使能电源控制（PWR）外设的时钟。
2. **设置电压调节器**：通过 `PWR_EnterSTOPMode` 函数进入停止模式。`PWR_Regulator_LowPower` 表示将电压调节器设置为低功耗模式，`PWR_STOPEntry_WFI` 表示通过等待中断（WFI）指令进入停止模式。
3. **重新配置系统时钟**：退出停止模式后，系统时钟需要重新初始化。

:::caution
退出停止模式后，系统时钟会被重置为默认值（通常是HSI时钟）。因此，在退出停止模式后，需要重新配置系统时钟以满足应用需求。
:::

## 退出停止模式

停止模式可以通过外部中断、RTC闹钟或其他唤醒事件退出。以下是一个通过外部中断唤醒的示例：

```c
void EXTI0_IRQHandler(void) {
    if (EXTI_GetITStatus(EXTI_Line0) != RESET) {
        // 清除中断标志
        EXTI_ClearITPendingBit(EXTI_Line0);

        // 退出停止模式后，系统时钟需要重新配置
        SystemInit();
    }
}
```

### 代码解释

1. **中断处理函数**：当外部中断触发时，系统会退出停止模式并执行中断处理函数。
2. **清除中断标志**：在中断处理函数中，需要清除中断标志以避免重复触发。
3. **重新配置系统时钟**：退出停止模式后，系统时钟需要重新初始化。

## 实际应用场景

停止模式在以下场景中非常有用：

1. **电池供电设备**：例如无线传感器节点，设备大部分时间处于待机状态，只有在需要采集数据时才唤醒。
2. **远程控制器**：例如遥控器，设备在用户按下按钮时唤醒，完成任务后进入停止模式以节省电量。
3. **智能家居设备**：例如智能灯泡，设备在未接收到指令时进入停止模式，以降低功耗。

:::tip
在设计低功耗应用时，建议使用STM32的功耗计算工具（如STM32CubeMX）来估算不同模式下的功耗，并选择最适合的模式。
:::

## 总结

STM32的停止模式是一种非常有效的低功耗模式，能够在保持系统状态的同时显著降低功耗。通过合理配置停止模式，可以延长电池寿命并优化系统性能。本文介绍了停止模式的基本概念、配置方法以及实际应用场景，希望能帮助你更好地理解和应用这一功能。

## 附加资源

- [STM32参考手册](https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf)：详细介绍了STM32的低功耗模式。
- [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html)：STM32配置工具，支持低功耗模式的设计和仿真。

## 练习

1. 修改上述代码，使用RTC闹钟作为唤醒源。
2. 使用STM32CubeMX生成一个低功耗项目，并测试停止模式下的功耗。
3. 设计一个简单的传感器节点，设备每10分钟唤醒一次采集数据，其余时间处于停止模式。
