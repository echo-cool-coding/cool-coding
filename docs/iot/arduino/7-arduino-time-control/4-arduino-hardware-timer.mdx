---
title: Arduino 硬件定时器
description: "了解Arduino硬件定时器的基本原理、使用方法以及实际应用场景。适合初学者学习如何通过硬件定时器实现精确的时间控制。"
---

## 介绍

在Arduino编程中，时间控制是一个非常重要的概念。Arduino提供了多种方式来实现时间控制，其中硬件定时器是最精确和高效的方式之一。硬件定时器是Arduino微控制器内部的专用硬件模块，可以独立于主程序运行，用于生成精确的时间间隔或触发特定事件。

与软件延时（如 `delay()` 函数）不同，硬件定时器不会阻塞主程序的执行，因此可以在不干扰其他任务的情况下实现精确的时间控制。本文将详细介绍Arduino硬件定时器的基本原理、使用方法以及实际应用场景。

## Arduino 硬件定时器的基础知识

Arduino Uno（基于ATmega328P微控制器）有三个硬件定时器：Timer0、Timer1和Timer2。每个定时器都有一个计数器，可以在特定的时钟频率下递增或递减。当计数器达到特定值时，可以触发中断或执行其他操作。

### 定时器的工作模式

Arduino硬件定时器通常有以下几种工作模式：

1. **普通模式（Normal Mode）**：计数器从0递增到最大值（如255或65535），然后溢出并重新开始。
2. **CTC模式（Clear Timer on Compare Match）**：计数器递增到与比较寄存器匹配的值时，自动清零并触发中断。
3. **PWM模式（Pulse Width Modulation）**：用于生成PWM信号，控制电机速度或LED亮度。

### 定时器的时钟源

定时器的时钟源可以是系统时钟（16MHz）或分频后的时钟。通过设置预分频器（Prescaler），可以降低定时器的计数速度，从而延长定时周期。

常见的预分频器值包括：
- 1（无分频）
- 8
- 64
- 256
- 1024

## 使用硬件定时器

以下是一个简单的示例，展示如何使用Arduino的Timer1实现1秒的定时中断。

### 代码示例

```cpp
#include <avr/io.h>
#include <avr/interrupt.h>

void setup() {
  // 设置Timer1为CTC模式
  TCCR1A = 0; // 清零TCCR1A寄存器
  TCCR1B = 0; // 清零TCCR1B寄存器
  TCNT1 = 0;  // 初始化计数器为0

  // 设置比较寄存器为15624（1秒定时）
  OCR1A = 15624;

  // 开启CTC模式并设置预分频器为1024
  TCCR1B |= (1 << WGM12) | (1 << CS12) | (1 << CS10);

  // 开启Timer1比较匹配中断
  TIMSK1 |= (1 << OCIE1A);

  // 启用全局中断
  sei();
}

void loop() {
  // 主程序可以继续执行其他任务
}

// Timer1比较匹配中断服务程序
ISR(TIMER1_COMPA_vect) {
  // 在这里执行定时任务
  digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN)); // 切换LED状态
}
```

### 代码解释

1. **TCCR1A 和 TCCR1B**：这些寄存器用于配置Timer1的工作模式和时钟源。
2. **OCR1A**：比较寄存器，用于设置定时器的比较值。
3. **TIMSK1**：用于启用定时器中断。
4. **ISR(TIMER1_COMPA_vect)**：这是Timer1比较匹配中断的服务程序，当计数器达到OCR1A的值时，该函数会被调用。

### 输入和输出

- **输入**：无外部输入。
- **输出**：LED每隔1秒切换一次状态。

## 实际应用场景

硬件定时器在许多实际应用中非常有用，例如：

1. **精确的时间测量**：用于测量传感器信号的频率或脉冲宽度。
2. **PWM信号生成**：控制电机速度或LED亮度。
3. **周期性任务调度**：在不阻塞主程序的情况下执行周期性任务。

### 案例：使用硬件定时器测量脉冲宽度

以下是一个使用Timer1测量外部脉冲宽度的示例。

```cpp
#include <avr/io.h>
#include <avr/interrupt.h>

volatile unsigned long pulseWidth = 0;

void setup() {
  Serial.begin(9600);

  // 设置Timer1为普通模式，预分频器为64
  TCCR1A = 0;
  TCCR1B = (1 << CS11) | (1 << CS10);

  // 启用输入捕获中断
  TIMSK1 |= (1 << ICIE1);

  // 启用全局中断
  sei();
}

void loop() {
  Serial.println(pulseWidth);
  delay(1000);
}

// 输入捕获中断服务程序
ISR(TIMER1_CAPT_vect) {
  static unsigned long startTime = 0;
  unsigned long captureTime = ICR1;

  if (TCCR1B & (1 << ICES1)) {
    startTime = captureTime;
  } else {
    pulseWidth = captureTime - startTime;
  }

  // 切换输入捕获边沿
  TCCR1B ^= (1 << ICES1);
}
```

### 代码解释

1. **TCCR1B**：配置Timer1为普通模式，并设置预分频器为64。
2. **TIMSK1**：启用输入捕获中断。
3. **ISR(TIMER1_CAPT_vect)**：输入捕获中断服务程序，用于记录脉冲的起始和结束时间。

### 输入和输出

- **输入**：外部脉冲信号。
- **输出**：通过串口打印脉冲宽度。

## 总结

Arduino硬件定时器是实现精确时间控制的强大工具。通过使用硬件定时器，可以在不阻塞主程序的情况下执行周期性任务、生成PWM信号或测量脉冲宽度。本文介绍了硬件定时器的基本原理、使用方法以及实际应用场景，并提供了代码示例帮助初学者理解。

## 附加资源与练习

1. **练习**：尝试修改代码示例，使用Timer2实现500毫秒的定时中断。
2. **进一步学习**：阅读Arduino官方文档，了解更多关于定时器寄存器和中断的详细信息。
3. **扩展应用**：使用硬件定时器控制步进电机的步进频率，实现精确的电机控制。

:::tip
提示：在使用硬件定时器时，务必注意寄存器的配置和中断服务程序的编写，以确保定时器的正常工作。
:::