---
title: Arduino 定时中断
description: 学习如何使用Arduino的定时中断功能，掌握定时器的基本概念及其在实际项目中的应用。
---

# Arduino 定时中断

在Arduino编程中，定时中断是一种强大的工具，它允许你在特定的时间间隔内自动执行某些任务，而不需要依赖于主循环中的延时函数。这对于需要精确时间控制的应用场景非常有用，例如控制LED闪烁频率、读取传感器数据或生成PWM信号。

## 什么是定时中断？

定时中断是通过硬件定时器触发的，它可以在特定的时间间隔内中断主程序的执行，转而执行一个特定的中断服务程序（ISR）。与使用`delay()`函数不同，定时中断不会阻塞主程序的执行，因此可以更高效地处理多任务。

### 定时器的基本概念

Arduino Uno（基于ATmega328P）有三个定时器：Timer0、Timer1和Timer2。每个定时器都有一个计数器，当计数器达到某个值时，就会触发中断。通过配置定时器的预分频器和比较寄存器，可以控制中断的触发频率。

## 如何使用定时中断

### 1. 配置定时器

首先，我们需要配置定时器的预分频器和比较寄存器。预分频器用于降低定时器的时钟频率，而比较寄存器用于设置计数器的上限值。

```cpp
void setup() {
  // 配置Timer1
  noInterrupts(); // 禁用所有中断
  TCCR1A = 0;     // 清除Timer1控制寄存器A
  TCCR1B = 0;     // 清除Timer1控制寄存器B
  TCNT1 = 0;      // 初始化计数器值为0

  // 设置比较寄存器为31250
  OCR1A = 31250;

  // 开启CTC模式（Clear Timer on Compare match）
  TCCR1B |= (1 << WGM12);

  // 设置预分频器为1024
  TCCR1B |= (1 << CS12) | (1 << CS10);

  // 开启定时器比较中断
  TIMSK1 |= (1 << OCIE1A);

  interrupts(); // 启用所有中断
}
```

### 2. 编写中断服务程序（ISR）

接下来，我们需要编写一个中断服务程序（ISR），当定时器触发中断时，这个程序会被自动调用。

```cpp
ISR(TIMER1_COMPA_vect) {
  // 在这里编写你想要执行的任务
  digitalWrite(13, !digitalRead(13)); // 切换LED状态
}
```

### 3. 主程序

在主程序中，你可以继续执行其他任务，而定时中断会在后台自动触发。

```cpp
void loop() {
  // 主程序中的其他任务
}
```

## 实际应用案例

### 案例：精确控制LED闪烁频率

假设我们需要让一个LED以1Hz的频率闪烁，即每秒钟切换一次状态。我们可以使用定时中断来实现这一功能。

```cpp
void setup() {
  pinMode(13, OUTPUT); // 设置LED引脚为输出模式

  noInterrupts();
  TCCR1A = 0;
  TCCR1B = 0;
  TCNT1 = 0;
  OCR1A = 15624; // 1Hz频率（16MHz / (1024 * 1) - 1）
  TCCR1B |= (1 << WGM12);
  TCCR1B |= (1 << CS12) | (1 << CS10);
  TIMSK1 |= (1 << OCIE1A);
  interrupts();
}

ISR(TIMER1_COMPA_vect) {
  digitalWrite(13, !digitalRead(13)); // 切换LED状态
}

void loop() {
  // 主程序中的其他任务
}
```

在这个例子中，LED将以1Hz的频率闪烁，而主程序可以继续执行其他任务。

## 总结

定时中断是Arduino中一个非常有用的功能，它允许你在不阻塞主程序的情况下精确控制任务的执行时间。通过配置定时器和编写中断服务程序，你可以实现各种需要精确时间控制的应用。

:::tip
**提示**：在使用定时中断时，尽量避免在中断服务程序中执行耗时较长的操作，因为这可能会影响主程序的执行。
:::

## 附加资源与练习

- **练习1**：尝试修改定时器的预分频器和比较寄存器，使LED以不同的频率闪烁。
- **练习2**：使用定时中断控制多个LED，使它们以不同的频率闪烁。
- **资源**：Arduino官方文档中关于定时器的详细说明。

通过不断练习和探索，你将能够更深入地理解Arduino的定时中断功能，并将其应用到更复杂的项目中。