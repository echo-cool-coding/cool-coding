---
title: Arduino 任务调度器
description: 了解如何使用Arduino任务调度器来管理多个任务的执行，提升代码效率和可维护性。
---

# Arduino 任务调度器

在Arduino编程中，任务调度器是一种用于管理多个任务执行的工具。它允许你在单个Arduino设备上同时运行多个任务，而无需使用复杂的多线程或多进程技术。任务调度器通过将任务分解为小的时间片段，并在这些片段之间切换，从而实现“伪并行”执行。

## 什么是任务调度器？

任务调度器是一种软件机制，用于在有限的计算资源上管理多个任务的执行。它通过将任务分解为小的时间片段，并在这些片段之间切换，从而实现“伪并行”执行。任务调度器通常用于嵌入式系统中，如Arduino，因为这些系统通常只有一个处理器核心，无法真正并行执行多个任务。

## 为什么需要任务调度器？

在Arduino项目中，你可能需要同时执行多个任务，例如读取传感器数据、控制电机、更新显示屏等。如果没有任务调度器，你可能需要将所有任务放在一个循环中，这会导致代码复杂且难以维护。任务调度器可以帮助你将任务分解为独立的模块，使代码更清晰、更易于维护。

## 如何使用Arduino任务调度器？

Arduino任务调度器的实现通常基于时间片轮转调度算法。以下是一个简单的任务调度器实现示例：

```cpp
#include <Arduino.h>

#define MAX_TASKS 3
#define TASK_INTERVAL 1000

unsigned long lastRunTime[MAX_TASKS] = {0};

void task1() {
  Serial.println("Task 1 executed");
}

void task2() {
  Serial.println("Task 2 executed");
}

void task3() {
  Serial.println("Task 3 executed");
}

void setup() {
  Serial.begin(9600);
}

void loop() {
  unsigned long currentTime = millis();

  if (currentTime - lastRunTime[0] >= TASK_INTERVAL) {
    task1();
    lastRunTime[0] = currentTime;
  }

  if (currentTime - lastRunTime[1] >= TASK_INTERVAL) {
    task2();
    lastRunTime[1] = currentTime;
  }

  if (currentTime - lastRunTime[2] >= TASK_INTERVAL) {
    task3();
    lastRunTime[2] = currentTime;
  }
}
```

在这个示例中，我们定义了三个任务（`task1`、`task2`、`task3`），每个任务每隔1秒执行一次。`lastRunTime`数组用于记录每个任务上次执行的时间。在`loop`函数中，我们检查当前时间与上次执行时间的差值，如果差值大于等于`TASK_INTERVAL`，则执行相应的任务。

## 实际应用场景

假设你正在开发一个智能家居系统，该系统需要同时执行以下任务：

1. 读取温度传感器数据。
2. 控制LED灯的亮度。
3. 更新LCD显示屏。

使用任务调度器，你可以将每个任务分解为独立的模块，并在`loop`函数中按需执行这些任务。这样，你可以确保每个任务都能按时执行，而不会相互干扰。

```cpp
#include <Arduino.h>

#define MAX_TASKS 3
#define TASK_INTERVAL 1000

unsigned long lastRunTime[MAX_TASKS] = {0};

void readTemperature() {
  // 读取温度传感器数据
  Serial.println("Temperature read");
}

void controlLED() {
  // 控制LED灯的亮度
  Serial.println("LED controlled");
}

void updateLCD() {
  // 更新LCD显示屏
  Serial.println("LCD updated");
}

void setup() {
  Serial.begin(9600);
}

void loop() {
  unsigned long currentTime = millis();

  if (currentTime - lastRunTime[0] >= TASK_INTERVAL) {
    readTemperature();
    lastRunTime[0] = currentTime;
  }

  if (currentTime - lastRunTime[1] >= TASK_INTERVAL) {
    controlLED();
    lastRunTime[1] = currentTime;
  }

  if (currentTime - lastRunTime[2] >= TASK_INTERVAL) {
    updateLCD();
    lastRunTime[2] = currentTime;
  }
}
```

## 总结

Arduino任务调度器是一种强大的工具，可以帮助你管理多个任务的执行，提升代码效率和可维护性。通过将任务分解为独立的模块，并在`loop`函数中按需执行这些任务，你可以确保每个任务都能按时执行，而不会相互干扰。

## 附加资源

- [Arduino官方文档](https://www.arduino.cc/en/Guide/Introduction)
- [Arduino任务调度器库](https://github.com/arkhipenko/TaskScheduler)

## 练习

1. 修改上述代码，使每个任务以不同的时间间隔执行。
2. 添加一个新任务，例如读取湿度传感器数据，并将其集成到任务调度器中。
3. 尝试使用Arduino任务调度器库来实现更复杂的任务调度。

:::tip
在编写任务调度器时，务必确保每个任务的执行时间尽可能短，以避免影响其他任务的执行。
:::