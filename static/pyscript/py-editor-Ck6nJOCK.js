import{T as e,c as t,X as r,d as n,a as o,r as s,o as i,H as a,s as c}from"./core-xkhao-Zt.js";import{notify as l}from"./error-CpWQYgrv.js";let u=0;const d=e=>`${e}-editor-${u++}`,f=new Map,p=new Map,g=new WeakMap,m={worker:{codeBeforeRun:()=>c,onReady:({runAsync:e,io:t},{sync:r})=>{t.stdout=t.buffered(r.write),t.stderr=t.buffered(r.writeErr),r.revoke(),r.runAsync=e}}},v=(e,t)=>{if("boolean"==typeof t)throw`Invalid source: ${e}`;return t},h=(e,t)=>{const r=e.closest(`.${t}-editor-box`);return r?.parentNode?.previousElementSibling};async function y({currentTarget:t}){const{env:o,pySrc:c,outDiv:u}=this,d=!!t;if(d&&(t.classList.add("running"),u.innerHTML=""),!f.has(o)){const c=URL.createObjectURL(new Blob([""])),u={type:this.interpreter,serviceWorker:this.serviceWorker},{config:p}=this;if(p)try{if(u.configURL=s(p),p.endsWith(".toml")){const[{parse:e},t]=await Promise.all([import("./toml-BLBSZ43A.js"),fetch(p).then((e=>e.ok&&e.text()))]);u.config=e(v(p,t))}else if(p.endsWith(".json")){const e=await fetch(p).then((e=>e.ok&&e.json()));u.config=v(p,e)}else u.configURL=s("./config.txt"),u.config=JSON.parse(p);u.version=i(u.config)}catch(e){return void l(e)}else u.config={};const g=r.call(new a(null,m),c,u);if(d)for(const r of e.keys()){const e=h(t,r);if(e){n(e,{xworker:{value:g}});break}}const{sync:y}=g,{promise:b,resolve:w}=Promise.withResolvers();f.set(o,b),y.revoke=()=>{URL.revokeObjectURL(c),w(g)}}return f.get(o).then((e=>{e.onerror=({error:e})=>{d&&u.insertAdjacentHTML("beforeend",`<span style='color:red'>${e.message||e}</span>\n`),console.error(e)};const r=()=>{d&&t.classList.remove("running")},{sync:n}=e;n.write=e=>{d?u.innerText+=`${e}\n`:console.log(e)},n.writeErr=e=>{d?u.insertAdjacentHTML("beforeend",`<span style='color:red'>${e}</span>\n`):(l(e),console.error(e))},n.runAsync(c).then(r,r)}))}const b=(e,t)=>{const r=document.createElement("div");r.className=`${t}-editor-input`,r.setAttribute("aria-label","Python Script Area");const n=((e,t)=>{const r=document.createElement("button");return r.className=`absolute ${t}-editor-run-button`,r.innerHTML='<svg style="height:20px;width:20px;vertical-align:-.125em;transform-origin:center;overflow:visible;color:green" viewBox="0 0 384 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(192 256)" transform-origin="96 0"><g transform="translate(0,0) scale(1,1)"><path d="M361 215C375.3 223.8 384 239.3 384 256C384 272.7 375.3 288.2 361 296.1L73.03 472.1C58.21 482 39.66 482.4 24.52 473.9C9.377 465.4 0 449.4 0 432V80C0 62.64 9.377 46.63 24.52 38.13C39.66 29.64 58.21 29.99 73.03 39.04L361 215z" fill="currentColor" transform="translate(-192 -256)"></path></g></g></svg>',r.setAttribute("aria-label","Python Script Run Button"),r.addEventListener("click",(async n=>{if(r.classList.contains("running")&&confirm("Would you like to kill this execution?")){const e=h(r,t);if(e){const r=g.get(e).state.doc.toString(),n=e.cloneNode(!0);n.type=`${t}-editor`,n.textContent=r,e.xworker.terminate(),e.nextElementSibling.remove(),e.replaceWith(n),g.delete(e)}}else r.blur(),await e.handleEvent(n)})),r})(e,t),o=document.createElement("div");return o.addEventListener("keydown",(e=>{e.stopPropagation()})),r.append(n,o),r},w=(e,t)=>{const r=document.createElement("div");r.className=`${t}-editor-box`;const n=b(e,t),o=(e=>{const t=document.createElement("div");return t.className=`${e}-editor-output`,t.id=`${d(e)}-output`,t})(t);return r.append(n,o),[r,o,n.querySelector("button")]},E=async(e,s,i)=>{const[{basicSetup:a,EditorView:c},{Compartment:u},{python:f},{indentUnit:m},{keymap:h},{defaultKeymap:b,indentWithTab:E}]=await Promise.all([t.core,t.state,t.python,t.language,t.view,t.commands]);let k=e.hasAttribute("setup");const x=e.hasAttribute("config"),$=e.getAttribute("service-worker"),A=`${i}-${e.getAttribute("env")||d(s)}`;if($&&(new r("data:application/javascript,postMessage(0)",{type:"dummy",serviceWorker:$}).onmessage=({target:e})=>e.terminate()),x&&p.has(A))throw new SyntaxError(p.get(A)?`duplicated config for env: ${A}`:`unable to add a config to the env: ${A}`);p.set(A,x);let L=e.textContent;const{src:S}=e;if(S)try{L=v(S,await fetch(S).then((e=>e.ok&&e.text())))}catch(e){return void l(e)}const C={handleEvent:y,serviceWorker:$,interpreter:i,env:A,config:x&&e.getAttribute("config"),get pySrc(){return k?L:D.state.doc.toString()},get outDiv(){return k?null:W}};let T;n(e,{target:{get:()=>T},handleEvent:{get:()=>C.handleEvent,set:e=>{C.handleEvent=e===y?y:async t=>{const{currentTarget:r}=t;n(t,{code:{value:C.pySrc}}),!1!==await e(t)&&await y.call(C,{currentTarget:r})}}},code:{get:()=>C.pySrc,set:e=>{k||D.update([D.state.update({changes:{from:0,to:D.state.doc.length,insert:e}})])}},process:{value(e,t=!1){if(t)return B();const r=k,n=L;k=!0,L=e;const o=()=>{k=r,L=n};return C.handleEvent({currentTarget:null}).then(o,o)}}});const M=()=>{const t=new Event(`${s}-editor`,{bubbles:!0});e.dispatchEvent(t)};if(k)return await C.handleEvent({currentTarget:null}),void M();const R=e.getAttribute("target");if(R){if(T=document.getElementById(R)||document.querySelector(R),!T)throw new Error(`Unknown target ${R}`)}else T=document.createElement(`${s}-editor`),T.style.display="block",e.after(T);T.id||(T.id=d(s)),T.hasAttribute("exec-id")||T.setAttribute("exec-id",0),T.hasAttribute("root")||T.setAttribute("root",T.id);const[j,W,U]=w(C,s);j.dataset.env=e.hasAttribute("env")?A:i;const N=j.querySelector(`.${s}-editor-input > div`).attachShadow({mode:"open"});N.innerHTML="<style> :host { all: initial; }</style>",T.appendChild(j);const P=o(e.textContent).trim(),H=/^([ \t]+)/m.test(P)?RegExp.$1:"    ",B=()=>U.click(),D=new c({extensions:[m.of(H),(new u).of(f()),h.of([...b,{key:"Ctrl-Enter",run:B,preventDefault:!0},{key:"Cmd-Enter",run:B,preventDefault:!0},{key:"Shift-Enter",run:B,preventDefault:!0},E]),a],foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],parent:N,doc:P});g.set(e,D),D.focus(),M()};let k=0,x=Promise.resolve();const $=()=>{k=0,A()},A=()=>{if(!k){k=setTimeout($,250);for(const[t,r]of e){const e=`script[type="${t}-editor"]`;for(const n of document.querySelectorAll(e))n.type+="-active",x=x.then((()=>E(n,t,r)))}return x}};new MutationObserver(A).observe(document,{childList:!0,subtree:!0});var L=A();export{L as default};
//# sourceMappingURL=py-editor-Ck6nJOCK.js.map
